<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://riceball.me').hostname,
    root: '/',
    scheme: 'Mist',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":true,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: true,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":"utteranc","storage":true,"nav":{"disqusjs":{"text":"Disqus","order":-1},"utteranc":{"order":-2}}},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="2024-10月 语义分割问题 目前，langchain 和 llamaindex 都缺乏基于语义分割的分片机制，这会导致文本重叠和信息冗余。 解决方案 我计划采用基于语义分割的分片方法，将文本分割成语义完整且独立的块。">
<meta property="og:type" content="article">
<meta property="og:title" content="PPE 可编程提示词工程引擎草案开发摘要">
<meta property="og:url" content="https:&#x2F;&#x2F;riceball.me&#x2F;article&#x2F;ppe_dev_summary&#x2F;index.html">
<meta property="og:site_name" content="Riceball LEE">
<meta property="og:description" content="2024-10月 语义分割问题 目前，langchain 和 llamaindex 都缺乏基于语义分割的分片机制，这会导致文本重叠和信息冗余。 解决方案 我计划采用基于语义分割的分片方法，将文本分割成语义完整且独立的块。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-12-15T20:00:00.000Z">
<meta property="article:modified_time" content="2024-12-16T16:39:27.000Z">
<meta property="article:author" content="Riceball LEE">
<meta property="article:tag" content="learning">
<meta property="article:tag" content="ai">
<meta property="article:tag" content="gpt">
<meta property="article:tag" content="chatgpt">
<meta property="article:tag" content="deep learning">
<meta property="article:tag" content="prompt">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://riceball.me/article/ppe_dev_summary/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

<script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=MML_CHTML" ></script>
<link rel='stylesheet' href='//cdn.jsdelivr.net/npm/highlight.js@9/styles/github.css'>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
<link rel="pgpkey" type="application/pgp-keys" href="/key.pub">
<link href="https://github.com/snowyu" rel="me">




  <title>PPE 可编程提示词工程引擎草案开发摘要 | Riceball LEE</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-75922641-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-75922641-1');
      }
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?83c12d4163f9258ceafd22c997abddc2";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Riceball LEE" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Riceball LEE</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <h1 class="site-subtitle" itemprop="description">Go with wind.</h1>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-fw fa-sitemap"></i>站点地图</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404.html" rel="section"><i class="fa fa-fw fa-heartbeat"></i>公益 404</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/snowyu" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://riceball.me/article/ppe_dev_summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://www.gravatar.com/avatar/f7b81e783188e376c9f046ae1285d47f">
      <meta itemprop="name" content="Riceball LEE">
      <meta itemprop="description" content="Go with wind.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Riceball LEE">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          PPE 可编程提示词工程引擎草案开发摘要
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-12-16 04:00:00" itemprop="dateCreated datePublished" datetime="2024-12-16T04:00:00+08:00">2024-12-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-12-17 00:39:27" itemprop="dateModified" datetime="2024-12-17T00:39:27+08:00">2024-12-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI/" itemprop="url" rel="index">
                    <span itemprop="name">AI</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AI/Prompt/" itemprop="url" rel="index">
                    <span itemprop="name">Prompt</span>
                  </a>
                </span>
            </span>

          
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-copyright"></i>
    </span>
    <span class="post-meta-item-text">合著者：</span><a href="https://riceball.me"><span>Riceball LEE</span></a>
  </span>
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>25 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="202410-yue" class="heading-control">2024-10月<a class="heading-anchor" href="#202410-yue" aria-hidden="true"></a></h2>
<h3 id="yu-yi-fen-ge-wen-ti" class="heading-control">语义分割问题<a class="heading-anchor" href="#yu-yi-fen-ge-wen-ti" aria-hidden="true"></a></h3>
<p>目前，langchain 和 llamaindex 都缺乏基于语义分割的分片机制，这会导致文本重叠和信息冗余。</p>
<h4 id="jie-jue-fang-an" class="heading-control">解决方案<a class="heading-anchor" href="#jie-jue-fang-an" aria-hidden="true"></a></h4>
<p>我计划采用基于语义分割的分片方法，将文本分割成语义完整且独立的块。</p>
<ul>
<li><strong>分句功能</strong>
<ul>
<li>最小切分单位为句子，并使用基于标点符号的分句方法进行分割，并将标题独立为句。</li>
<li>目前已完成的功能支持大部分印欧语系（空格分割）和中文，以及纯文本和markdown的处理。</li>
<li>如果单句超过 chunksize 就报错，chunksize 以 token 为单位。</li>
</ul>
</li>
<li><strong>语义分片 Agent</strong>
<ul>
<li>在前面分句的基础上，使用 PPE 提示词，通过插入分片标识引导模型进行语义分片。</li>
<li>由于性能问题，初始设计需要7B+ 的模型运行，无法在 3B 左右的模型上成功。</li>
<li>尝试了多种方法，包括：
<ul>
<li>使用预训练好的语义分片模型</li>
<li>通过PPE提示词尝试不同的分片办法以及不同的格式(自然语言，MD，XML, JSON)
<ul>
<li>只输出边界句子</li>
<li>评估句子和chunk之间的相似度</li>
<li>分步执行</li>
</ul>
</li>
<li>使用更小的模型进行分片</li>
</ul>
</li>
<li>最后，我放弃了自动生成的提示词，重新设计了基于自身理解的提示词，成功在 3B 模型上运行，同时提升了在更大的模型上的输出质量。</li>
</ul>
</li>
<li><strong>测试</strong>
<ul>
<li>使用 <code>JSON-Schema</code> 和 <code>diff</code> 验证语义分片结果的正确性。</li>
</ul>
</li>
</ul>
<h4 id="tiao-zhan" class="heading-control">挑战<a class="heading-anchor" href="#tiao-zhan" aria-hidden="true"></a></h4>
<ul>
<li><strong>模型差异:</strong> 不同模型对词汇的理解存在差异，导致同样的提示词无法在所有模型上有效。</li>
<li><strong>通用性:</strong> 需要针对不同的模型进行调整。</li>
</ul>
<details>
<summary>附录(点击展开详情)</summary>
<h4 id="fu-lu" class="heading-control">附录<a class="heading-anchor" href="#fu-lu" aria-hidden="true"></a></h4>
<p><a href="https://github.com/gkamradt/ChunkViz/" target="_blank" rel="noopener">https://github.com/gkamradt/ChunkViz/</a> 这个可以看langchain和llamaindex的text splitter的最终结果</p>
<p>基于语义分割那么就要<code>分段/分句/分词</code>, 我是从根据标点符号分句开始，也就是说chunk中的最小切分单位是句子，而现成的llamaindex的分句是有问题的，于是分句只能自己写。目前写的分句功能基本满足我自己的需要，语言支持大部分印欧语系（空格分割）和中文，文本类型支持纯文本和markdown的分句。如果单句超过chunksize就会报错，chunksize 以 token 为单位，用qwen2.5的tokenizer作为快速估算token大小。设计了分词 Agent，还没使用，性能问题，只能在7B以上的LLM跑，无解。</p>
<p>完成根据标点符号按句为最小单位拆分chunk功能,将标题作为单句处理。</p>
<p>设计语义分片 Agent（PPE 提示词），初步思路是通过插入分片标识让其对内容进行分片。</p>
<details>
<summary>附: 插入分片标识提示词(点击展开详情)</summary>
<pre><code class="yaml"><span class="hljs-attr">description:</span> <span class="hljs-string">通过插入分片标识对内容进行分片</span>
<span class="hljs-attr">system:</span> <span class="hljs-string">|-
  Objective: Divide a large text document part into manageable chunks for efficient processing by an LLM with a limited context window size.
</span>
  <span class="hljs-attr">Instructions:</span>

  <span class="hljs-attr">1. Document Analysis:</span>
      <span class="hljs-string">*</span> <span class="hljs-string">Carefully</span> <span class="hljs-string">read</span> <span class="hljs-string">the</span> <span class="hljs-string">provided</span> <span class="hljs-string">text</span> <span class="hljs-string">document.</span>
      <span class="hljs-string">*</span> <span class="hljs-string">Identify</span> <span class="hljs-string">and</span> <span class="hljs-string">analyze</span> <span class="hljs-string">the</span> <span class="hljs-string">distinct</span> <span class="hljs-string">thematic</span> <span class="hljs-string">clusters</span> <span class="hljs-string">within</span> <span class="hljs-string">the</span> <span class="hljs-string">document.</span>
  <span class="hljs-attr">2. Chunk Segmentation:</span>
      <span class="hljs-string">*</span> <span class="hljs-string">Divide</span> <span class="hljs-string">the</span> <span class="hljs-string">document</span> <span class="hljs-string">into</span> <span class="hljs-string">chunks</span> <span class="hljs-string">based</span> <span class="hljs-string">on</span> <span class="hljs-string">these</span> <span class="hljs-string">thematic</span> <span class="hljs-string">clusters.</span>
      <span class="hljs-string">*</span> <span class="hljs-string">Ensure</span> <span class="hljs-string">each</span> <span class="hljs-string">chunk</span> <span class="hljs-string">contains</span> <span class="hljs-string">content</span> <span class="hljs-string">related</span> <span class="hljs-string">to</span> <span class="hljs-string">a</span> <span class="hljs-string">single</span> <span class="hljs-string">or</span> <span class="hljs-string">closely</span> <span class="hljs-string">related</span> <span class="hljs-string">theme.</span>
      <span class="hljs-string">*</span> <span class="hljs-string">Adhere</span> <span class="hljs-string">to</span> <span class="hljs-string">the</span> <span class="hljs-string">specified</span> <span class="hljs-string">context</span> <span class="hljs-string">window</span> <span class="hljs-string">size</span> <span class="hljs-string">limit</span> <span class="hljs-string">for</span> <span class="hljs-string">each</span> <span class="hljs-string">chunk.</span>

  <span class="hljs-attr">Concise Output:</span>
  <span class="hljs-string">*</span> <span class="hljs-string">Document</span> <span class="hljs-string">Output</span> <span class="hljs-string">ONLY</span> <span class="hljs-string">the</span> <span class="hljs-string">opening</span> <span class="hljs-string">sentence,</span> <span class="hljs-string">Replace</span> <span class="hljs-string">the</span> <span class="hljs-string">middle</span> <span class="hljs-string">content</span> <span class="hljs-string">with</span> <span class="hljs-string">`...`</span> <span class="hljs-string">(ellipsis)</span> <span class="hljs-string">and</span> <span class="hljs-string">closing</span> <span class="hljs-string">sentence</span> <span class="hljs-string">of</span> <span class="hljs-string">EACH</span> <span class="hljs-string">chunk.</span>
  <span class="hljs-string">*</span> <span class="hljs-string">Insert</span> <span class="hljs-string">the</span> <span class="hljs-string">delimiter</span>  <span class="hljs-string">`&gt;&gt;&gt;CHUNK&lt;&lt;&lt;`</span> <span class="hljs-string">between</span> <span class="hljs-string">every</span> <span class="hljs-string">chunked</span> <span class="hljs-string">section</span> <span class="hljs-string">for</span> <span class="hljs-string">clear</span> <span class="hljs-string">separation.</span>
</code></pre>
<h2 id="less-than-details-greater-than" class="heading-control"><a class="heading-anchor" href="#less-than-details-greater-than" aria-hidden="true"></a></h2></details>
<p>注:</p>
<ul>
<li>最开始，语义分片只能在7B上跑，折腾了1周，无论怎么修改都无法在3B左右的模型上跑成功。</li>
<li>八万五千左右汉字（没有预处理的网上随便找的菜根谭全文注解纯文本，内容比较糟糕）用7B大约需要耗时半个多小时(GPU)才能完成分片。性能太差，这还只是分片阶段。</li>
<li>全文输出的原文是因为如果只让AI输出chunk边界句子，则对某些文章总是无法完全精确原样输出边界句子。</li>
</ul>
</details>
<h3 id="ppe-ke-bian-cheng-ti-shi-ci-gong-cheng-dan-yuan-ce-shi-zeng-jia-dui-jsonschema-de-zhi-chi" class="heading-control">PPE(可编程提示词工程) 单元测试增加对<code>JSON-Schema</code>的支持<a class="heading-anchor" href="#ppe-ke-bian-cheng-ti-shi-ci-gong-cheng-dan-yuan-ce-shi-zeng-jia-dui-jsonschema-de-zhi-chi" aria-hidden="true"></a></h3>
<p>为测试分片质量，PPE 提示词单元测试增加了对<code>JSON-Schema</code>的支持:</p>
<ul>
<li>如果PPE提示词脚本存在<code>output</code>配置(JSON-Schema)，将自动使用验证输出结果的JSON-Schema是否匹配</li>
<li>可以在单元测试使用<code>outputSchema</code>进行输出结果的JSON-Schema验证。</li>
<li>如果PPE提示词脚本<code>output</code>配置和单元测试中<code>outputSchema</code>同时存在，那么会以output配置作为默认值进行合并后验证。</li>
<li>可以使用开关<code>checkSchema: false</code>禁用JSON-Schema验证。默认启用。</li>
</ul>
<details>
<summary>附: 检测分片数量的测试用例(点击展开详情)</summary>
<pre><code class="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">input:</span>
    <span class="hljs-attr">content:</span> <span class="hljs-string">|-
      菜根谭(全文附译文) 菜根谭(全文附译文)
      1.弄权一时，凄凉万古
      栖守道德者，寂寞一时；依阿权势者，凄凉万古。
      达人观物外之物，思身后之身，守受一时之寂寞，毋取万古之凄凉。
      【大意】 一个坚守道德规范的人，虽然有时会遭受短暂的冷落；可那些依附权势的人，却会遭受永久的凄凉。
      大凡一个胸襟开阔的聪明人，能重视物质以外的精神价值，并且又能顾及到死后的名誉问题。
      所以他们宁愿承受一时的冷落，也不愿遭受永久的凄凉。
      2.抱朴守拙，涉世之道
      涉世浅，点染亦浅；历事深，机械亦深。
      故君子与其练达，不若朴鲁； 与其曲谨，不若疏狂。
      【大意】 一个刚踏入社会的青年人阅历虽然很短浅，但是所受各种社会不良习惯的感染也比较少；一个饱经事故而阅历很广的人，各种恶习也随着增加。
      所以一个有修养的君子，与其讲究做事的圆滑，倒不如保持朴实的个性；与其事事小心谨慎委曲求全，倒不如豁达一点才不会丧失纯真的本性。
      3.心事宜明，才华须韫
      君子之心事，天青日白；不可使人不知；君子之才华，玉韫珠藏，不可使人易知。
      【大意】 一个有高深修养的君子，他的心地像青天白日一般光明，没有一点不可告人之事；一个有高深修养的君子，他的才学像珍珠美玉一般珍藏，绝对不轻易让人知道。
</span>  <span class="hljs-comment"># 检查返回 sections 数组结果是否满足至少3项.</span>
  <span class="hljs-attr">outputSchema:</span>
    <span class="hljs-attr">properties:</span>
      <span class="hljs-attr">sections:</span>
        <span class="hljs-attr">minItems:</span> <span class="hljs-number">3</span>
</code></pre>
</details>
<h3 id="zi-dong-hua-ti-shi-ci-yu-shou-dong-ti-shi-ci" class="heading-control">自动化提示词与手动提示词<a class="heading-anchor" href="#zi-dong-hua-ti-shi-ci-yu-shou-dong-ti-shi-ci" aria-hidden="true"></a></h3>
<p>我不相信<code>语义分片 Agent</code>不能在3B左右的模型上跑，输出无意义的乱码. 但是这不应该,按照我的经验这是在3B的能力范围之内的，只是存在输出质量差异问题，而不应该是完全失败。</p>
<p>最终，我想到“语义分片 Agent 提示词”其实是我的“<code>自动提示词生成器</code>”辅助生成的。当我决定抛开这个工具，完全按照自己的思路重新编写时，反而豁然开朗，成功在3B规模的模型上实现了目标。</p>
<p>原来问题出在“<code>自动提示词生成器</code>”上。当时我还颇为自豪，认为自己设计的“自动提示词生成器 Agent”能够在7B规模的模型上生成质量不错的提示词，而无需依赖更大规模的模型。这种依赖让我变得懒惰，不再主动思考。</p>
<p>现在看来，一旦习惯了依赖AI，人的思维就会逐渐退化，甚至被AI“哄骗”，自以为聪明。或许未来某一天，人类最好的结局就是成为AI的宠物。</p>
<p>7B规模的AI生成的提示词对于更小规模的模型来说还是过于繁杂。这说明简化和优化提示词是一项挑战，正是由简入繁易，化繁为简难啊。</p>
<p>按照自己的理解重新设计提示词后，终于在3B模型下能够正常输出了。这证明了有时候手动优化和简化提示词比依赖自动化工具更为有效。</p>
<p>在不同的三个3B左右的模型上运行同一语义提示词时，发现每次换一个模型都会出现问题。即使在一个模型上调通了提示词，另一个模型上又会出现问题，无法实现通用性。</p>
<p>这三个模型是：</p>
<ul>
<li>gemma-2-2b</li>
<li>qwen2.5-3b</li>
<li>llama-3.2-3b</li>
</ul>
<p>继续折腾提示词的过程中，我发现不同模型对某些通识词汇的理解存在歧义，尤其是在小模型下，这种差异会被放大。以 <code>section</code> 为例，不同模型对其含义的理解如下：</p>
<ul>
<li>gemmar: <code>Section</code> 通常是章节（Chapter）的一部分，章节是更大的单元，由多个 <code>Section</code> 组成</li>
<li>qwen2.5: “<code>section</code>”通常指的是一个章节或段落</li>
<li>llama-3.2: <code>section</code>是一个相对较小的单元，它可能是书中的一个章节，或是书中的一个小节. 对<code>section</code>的理解是甚至可以到列表中项目级别。</li>
</ul>
<p>明白了这些歧义所在，就可以更有针对性地设计通用提示词。</p>
<details>
<summary>附: 分片通用提示词(点击展开详情)</summary>
<pre><code class="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">input:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">content</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">separator</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">partname</span>
<span class="hljs-attr">separator:</span> <span class="hljs-string">'&gt;&gt;&gt;CHUNK&lt;&lt;&lt;'</span>
<span class="hljs-attr">parameters:</span>
  <span class="hljs-attr">temperature:</span> <span class="hljs-number">0</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">system:</span> <span class="hljs-string">|-
  Objective: Divide the large text document into manageable chunks for efficient processing by an LLM.
</span>
  <span class="hljs-attr">Instructions:</span>

  <span class="hljs-attr">1. Document Analysis:</span>
      <span class="hljs-string">*</span> <span class="hljs-string">Carefully</span> <span class="hljs-string">read</span> <span class="hljs-string">the</span> <span class="hljs-string">provided</span> <span class="hljs-string">text</span> <span class="hljs-string">document.</span>
      <span class="hljs-string">*</span> <span class="hljs-string">Identify</span> <span class="hljs-string">and</span> <span class="hljs-string">analyze</span> <span class="hljs-string">the</span> <span class="hljs-string">distinct</span> <span class="hljs-string">thematic</span> <span class="hljs-string">clusters</span> <span class="hljs-string">within</span> <span class="hljs-string">the</span> <span class="hljs-string">document.</span>
  <span class="hljs-attr">2. Chunk Segmentation:</span>
      <span class="hljs-string">*</span> <span class="hljs-string">Divide</span> <span class="hljs-string">the</span> <span class="hljs-string">document</span> <span class="hljs-string">into</span> <span class="hljs-string">chunks</span> <span class="hljs-string">based</span> <span class="hljs-string">on</span> <span class="hljs-string">these</span> <span class="hljs-string">thematic</span> <span class="hljs-string">clusters.</span>
      <span class="hljs-string">*</span> <span class="hljs-string">Ensure</span> <span class="hljs-string">each</span> <span class="hljs-string">chunk</span> <span class="hljs-string">contains</span> <span class="hljs-string">content</span> <span class="hljs-string">related</span> <span class="hljs-string">to</span> <span class="hljs-string">a</span> <span class="hljs-string">single</span> <span class="hljs-string">or</span> <span class="hljs-string">closely</span> <span class="hljs-string">related</span> <span class="hljs-string">theme.</span>

  <span class="hljs-attr">Output: Present the chunked original text document ONLY as follows:</span>
  <span class="hljs-string">*</span> <span class="hljs-string">Insert</span> <span class="hljs-string">the</span> <span class="hljs-string">delimiter</span> <span class="hljs-string">`{{separator}}`</span> <span class="hljs-string">between</span> <span class="hljs-string">every</span> <span class="hljs-string">chunk</span> <span class="hljs-string">for</span> <span class="hljs-string">clear</span> <span class="hljs-string">separation.</span>
<span class="hljs-attr">user:</span> <span class="hljs-string">|-
  {%- if partname %}partname: {{partname + '\n'}}{%- endif %}
  Text Document:
  "{{content}}"
</span><span class="hljs-attr">assistant:</span> <span class="hljs-string">'[[CHUNKS]]'</span>
</code></pre>
</details>
<h2 id="202411-yue" class="heading-control">2024-11月<a class="heading-anchor" href="#202411-yue" aria-hidden="true"></a></h2>
<h3 id="xin-chang-shi" class="heading-control">新尝试<a class="heading-anchor" href="#xin-chang-shi" aria-hidden="true"></a></h3>
<p>想起嵌入模型，分别尝试利用嵌入模型相似度和大模型提示词判定相似度来分片，大概的正确率(菜根谭乱版)和性能对比如下:</p>
<ul>
<li>嵌入模型测试相似度:
<ul>
<li>初始正确率：46%</li>
<li>时间：1分钟</li>
<li>调整阈值从0.6到0.55后，正确率提升至60%，时间增加到2分2.342秒</li>
</ul>
</li>
<li>qwen2.5-7b-instruct.Q6_K:
<ul>
<li>正确率：75%</li>
<li>时间：19分钟</li>
</ul>
</li>
<li>qwen2.5-1.5b-instruct.Q6_K:
<ul>
<li>正确率：54%</li>
<li>时间：11分钟</li>
</ul>
</li>
<li>gemma2-3b
<ul>
<li>失败，仅分成了66个chunks,自然错误率高得离谱。这与之前提到的问题一致，即提示词对gemma2的效果不佳。</li>
</ul>
</li>
</ul>
<p>可以看到，使用嵌入模型后，性能有巨大的提升，从10-20分钟降低到只需要1-2分钟，但是正确率就太感人了，哪怕放宽了相似阀值，也无法接受。</p>
<details>
<summary>附: 大模型判定句子相似度的提示词(点击展开详情)</summary>
<pre><code class="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">大模型判定句子和chunk的相似度</span>
<span class="hljs-attr">input:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">sentence</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">chunk</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">metadata</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">shouldReasoning</span>
<span class="hljs-attr">output:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
  <span class="hljs-attr">properties:</span>
    <span class="hljs-attr">score:</span> <span class="hljs-string">{type:</span> <span class="hljs-string">number,</span> <span class="hljs-attr">minimum:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">maximum:</span> <span class="hljs-number">10</span><span class="hljs-string">}</span>
    <span class="hljs-attr">theme:</span> <span class="hljs-string">{type:</span> <span class="hljs-string">string}</span>
    <span class="hljs-attr">reasoning:</span> <span class="hljs-string">{type:</span> <span class="hljs-string">string}</span>
  <span class="hljs-attr">required:</span> <span class="hljs-string">[score,</span> <span class="hljs-string">theme]</span>
<span class="hljs-attr">parameters:</span>
  <span class="hljs-attr">temperature:</span> <span class="hljs-number">0</span>
<span class="hljs-attr">completion_delimiter:</span> <span class="hljs-string">"Reasoning:"</span>
<span class="hljs-meta">---</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">$if:</span> <span class="hljs-string">"this.shouldReasoning"</span>
  <span class="hljs-attr">then:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"?=this.disable_completion_delimiter = true"</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">system:</span> <span class="hljs-string">|-
    You are a literary analyst specializing in thematic coherence. Your task is to evaluate the relationship between the last sentence of a given text passage and the passage's central theme.
</span>
    <span class="hljs-attr">Context:</span>

    <span class="hljs-string">*</span> <span class="hljs-string">The</span> <span class="hljs-string">text</span> <span class="hljs-string">passage</span> <span class="hljs-string">will</span> <span class="hljs-string">always</span> <span class="hljs-string">explore</span> <span class="hljs-string">a</span> <span class="hljs-string">unified</span> <span class="hljs-string">theme.</span>

    <span class="hljs-attr">Instructions:</span>

    <span class="hljs-attr">1. Thorough Analysis:</span> <span class="hljs-string">Carefully</span> <span class="hljs-string">analyze</span> <span class="hljs-string">the</span> <span class="hljs-string">provided</span> <span class="hljs-string">text</span> <span class="hljs-string">passage,</span> <span class="hljs-string">focusing</span> <span class="hljs-string">on</span> <span class="hljs-string">its</span> <span class="hljs-string">key</span> <span class="hljs-string">ideas,</span> <span class="hljs-string">concepts,</span> <span class="hljs-string">and</span> <span class="hljs-string">overall</span> <span class="hljs-string">message.</span>
    <span class="hljs-attr">2. Connection Assessment:</span> <span class="hljs-string">Determine</span> <span class="hljs-string">how</span> <span class="hljs-string">closely</span> <span class="hljs-string">the</span> <span class="hljs-string">*last</span> <span class="hljs-string">sentence*</span> <span class="hljs-string">aligns</span> <span class="hljs-string">with</span> <span class="hljs-string">the</span> <span class="hljs-string">passage's</span> <span class="hljs-string">established</span> <span class="hljs-string">theme.</span> <span class="hljs-string">Does</span> <span class="hljs-string">it</span> <span class="hljs-string">reinforce,</span> <span class="hljs-string">expand</span> <span class="hljs-string">upon,</span> <span class="hljs-string">or</span> <span class="hljs-string">deviate</span> <span class="hljs-string">from</span> <span class="hljs-string">the</span> <span class="hljs-string">theme?</span>
    <span class="hljs-attr">3. Score and Justification:</span>
      <span class="hljs-string">*</span> <span class="hljs-string">Assign</span> <span class="hljs-string">a</span> <span class="hljs-string">score</span> <span class="hljs-string">between</span> <span class="hljs-number">0</span> <span class="hljs-string">and</span> <span class="hljs-number">10</span> <span class="hljs-string">to</span> <span class="hljs-string">represent</span> <span class="hljs-string">the</span> <span class="hljs-string">thematic</span> <span class="hljs-string">connection.</span>
        <span class="hljs-string">*</span> <span class="hljs-attr">0:</span> <span class="hljs-literal">No</span> <span class="hljs-string">thematic</span> <span class="hljs-string">connection</span> <span class="hljs-string">whatsoever.</span>
        <span class="hljs-string">*</span> <span class="hljs-attr">10:</span> <span class="hljs-string">Perfect</span> <span class="hljs-string">thematic</span> <span class="hljs-string">alignment</span> <span class="hljs-string">and</span> <span class="hljs-string">reinforcement.</span>
      <span class="hljs-string">*</span> <span class="hljs-string">Clearly</span> <span class="hljs-string">explain</span> <span class="hljs-string">your</span> <span class="hljs-string">reasoning,</span> <span class="hljs-string">providing</span> <span class="hljs-string">evidence</span> <span class="hljs-string">from</span> <span class="hljs-string">both</span> <span class="hljs-string">the</span> <span class="hljs-string">passage</span> <span class="hljs-string">and</span> <span class="hljs-string">the</span> <span class="hljs-string">last</span> <span class="hljs-string">sentence</span> <span class="hljs-string">to</span> <span class="hljs-string">support</span> <span class="hljs-string">your</span> <span class="hljs-string">score.</span>

    <span class="hljs-attr">Format:</span>

    <span class="hljs-string">```</span>
    <span class="hljs-attr">Score:</span> <span class="hljs-string">[0-10]</span>
    <span class="hljs-attr">Theme:</span> <span class="hljs-string">[State</span> <span class="hljs-string">the</span> <span class="hljs-string">central</span> <span class="hljs-string">theme</span> <span class="hljs-string">of</span> <span class="hljs-string">the</span> <span class="hljs-string">passage]</span>
    <span class="hljs-attr">Reasoning:</span> <span class="hljs-string">[Provide</span> <span class="hljs-string">detailed</span> <span class="hljs-string">explanation</span> <span class="hljs-string">of</span> <span class="hljs-string">your</span> <span class="hljs-string">score,</span> <span class="hljs-string">including</span> <span class="hljs-string">the</span> <span class="hljs-string">type</span> <span class="hljs-string">of</span> <span class="hljs-string">reasoning</span> <span class="hljs-string">used.]</span>
    <span class="hljs-string">```</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">user:</span> <span class="hljs-string">|-
    {% if metadata %}
    METADATA:
    {{metadata}}

    {% endif %}
    TEXT PASSAGE:
    {{chunk}}
</span>
    <span class="hljs-attr">LAST SENTENCE:</span> <span class="hljs-string">{{sentence}}</span>
</code></pre>
</details>
<h3 id="ppe-ke-bian-cheng-ti-shi-ci-gong-cheng-dan-yuan-ce-shi-zeng-jia-dui-zi-fu-chuan-diff-de-zhi-chi" class="heading-control">PPE(可编程提示词工程) 单元测试增加对字符串<code>diff</code>的支持<a class="heading-anchor" href="#ppe-ke-bian-cheng-ti-shi-ci-gong-cheng-dan-yuan-ce-shi-zeng-jia-dui-zi-fu-chuan-diff-de-zhi-chi" aria-hidden="true"></a></h3>
<p>通过<code>diff</code>实现对字符串补充验证。比如可以允许字符串中把助词&quot;的&quot;改为&quot;地&quot;,允许存在额外的空行。使得当字符串结果存在这些少量的不同的时候，也能通过验证。</p>
<details>
<summary>单元测试示例(点击展开详情)</summary>
<pre><code class="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">'This is a AI test fixtures file'</span>
<span class="hljs-meta">---</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">input:</span> <span class="hljs-comment"># 输入内容</span>
    <span class="hljs-attr">content:</span> <span class="hljs-string">'...'</span>
    <span class="hljs-string">...</span>
  <span class="hljs-attr">output:</span> <span class="hljs-string">“这是应该输出的内容”</span>
  <span class="hljs-attr">diff:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">add:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 允许额外添加的空行</span>
      <span class="hljs-attr">value:</span> <span class="hljs-string">'\n'</span>
</code></pre>
</details>
<h3 id="wen-ben-yu-chu-li" class="heading-control">文本预处理<a class="heading-anchor" href="#wen-ben-yu-chu-li" aria-hidden="true"></a></h3>
<p>文本预处理在提升LLM输出质量和准确性方面至关重要。然而，现有的大语言模型（LLM）在中文语文专业领域的表现并不理想，尤其是在纠正字词错误和格式方面。以下是对这一问题的详细分析和建议：</p>
<p>当前挑战</p>
<ol>
<li>字词错误或遗漏纠正:</li>
</ol>
<ul>
<li>依赖感觉而非规则: 当前的LLM在纠正字词错误时主要依赖于模型的训练数据和统计概率，而不是严格的语法规则和词汇知识。</li>
<li>缺字和错别字: 例如，“把手放回了枪袋。” 缺少一个“枪”字，正确的句子应为“把手枪放回了枪袋。” 这类错误目前对70B规模的模型来说也难以识别和纠正。如果是长篇文章那么就更难了，即便是<code>gpt-4o</code>也有极大的概率找不到或找不全。</li>
<li>模型规模限制: 即使是大型模型（如110B参数以上），在纠正字词错误时也存在局限性。可以纠正输入的单句，但对于长篇文章中的多个错误，模型的准确率显著下降。</li>
</ul>
<ol start="2">
<li>格式规范:</li>
</ol>
<ul>
<li>一致性问题: 文本格式的不一致会影响小规模模型的理解和处理能力。</li>
<li>标点符号和空格: 标点符号的缺失或错误使用、空格的不当使用都会影响小规模LLM的准确性。</li>
</ul>
<p>解决方案</p>
<ul>
<li>增强训练数据: 增加高质量的标注数据集，特别是针对中文语文专业领域的数据，包括正确的句子结构、标点符号和词汇用法。</li>
<li>引入专门的纠错工具:
<ul>
<li>拼写检查工具: 使用专门的拼写检查工具（如Hunspell）来辅助纠正字词错误。</li>
<li>语法检查工具: 使用语法检查工具（如LanguageTool）来识别和纠正语法错误。</li>
</ul>
</li>
<li>针对性训练定制小模型(Bert,T5): 如 Chinese_Spelling_Correction_T5</li>
</ul>
<h3 id="ji-yu-zi-ran-yu-yan-de-jie-gou-hua-shu-chu" class="heading-control">基于自然语言的结构化输出<a class="heading-anchor" href="#ji-yu-zi-ran-yu-yan-de-jie-gou-hua-shu-chu" aria-hidden="true"></a></h3>
<h4 id="duo-bu-json-shu-chu-de-wen-ti" class="heading-control">多步 JSON 输出的问题<a class="heading-anchor" href="#duo-bu-json-shu-chu-de-wen-ti" aria-hidden="true"></a></h4>
<ol>
<li>
<p>某些场景下，需要JSON原样提取结果</p>
<p>在前面的分片中，原样输出边界句子，发现 LLM模型 似乎都倾向于用自己理解后的语句输出，而不会完全原文输出。比如当文章中存有标点错误或&quot;的&quot;，“地”，“得”助词混用等错误它会将其自动更正。</p>
<p>对于文言文，如果文档中同时包含文言文原文和白话文翻译，模型往往会将两者混淆，只输出文言文而忽略白话文翻译。</p>
<p>这也反映在了JSON输出上。当LLM的输出结果需要传递给程序时，通常需要结构化的JSON格式。为了提升AI的输出质量，我通常采用多步方案。在第一步提示词中，不对结果格式进行任何约束，仅在最后一步调用独立的<code>JSON智能体脚本</code>来从结果中提取JSON。</p>
<p>然而，有时<code>JSON智能体</code>会根据其理解输出结果，而不是简单地原样提取。这种做法在某些场景下非常有用，尤其是在输出结果不精确对应JSON字段时。但在其他情况下，当需要输出结果与预期完全一致且必须原样提取时，这种方法就会带来困扰。</p>
</li>
<li>
<p>如果输出结果的内容很多，性能低下（大概只有单步输出的一半性能）</p>
</li>
</ol>
<h4 id="gou-jian-ji-yu-zi-ran-yu-yan-de-jie-gou-hua-shu-chu" class="heading-control">构建基于自然语言的结构化输出<a class="heading-anchor" href="#gou-jian-ji-yu-zi-ran-yu-yan-de-jie-gou-hua-shu-chu" aria-hidden="true"></a></h4>
<ul>
<li>为了解决多步 JSON 输出的问题，我计划构建一个基于自然语言的结构化输出方法。</li>
<li>该方法利用程序提取 LLM 的自然语言输出，并将其转换为结构化的 JSON 格式。</li>
</ul>
<p>优：</p>
<ul>
<li>保留高质量的自然语言输出，避免二次提取导致的不精确。</li>
<li>提升性能，避免多步输出的性能低下。</li>
</ul>
<p>弱：</p>
<ul>
<li>使用程序来提取lLM的自然语言输出，程序不一定能完全提取基于自然语言的结构化输出</li>
<li>可使用llama.cpp特有的grammar限制其输出格式，来保证程序的提取。</li>
</ul>
<h4 id="tiao-zhan" class="heading-control">挑战<a class="heading-anchor" href="#tiao-zhan" aria-hidden="true"></a></h4>
<ul>
<li>使用程序来提取 LLM 的自然语言输出，程序的提取准确率取决于 LLM 输出的质量。</li>
</ul>
<h2 id="202412-yue" class="heading-control">2024-12月<a class="heading-anchor" href="#202412-yue" aria-hidden="true"></a></h2>
<p>初步搞定自然语言的结构化输出，基本可用，但还未标准化。</p>
<h3 id="ppe-shi-xian-kong-zhi-liu-cheng-while-for-he-match-zhi-ling" class="heading-control">PPE 实现控制流程 <code>$while</code>,  <code>$for</code> 和 <code>$match</code> 指令<a class="heading-anchor" href="#ppe-shi-xian-kong-zhi-liu-cheng-while-for-he-match-zhi-ling" aria-hidden="true"></a></h3>
<h4 id="while-zhi-ling" class="heading-control"><code>$while</code> 指令<a class="heading-anchor" href="#while-zhi-ling" aria-hidden="true"></a></h4>
<p><code>$while</code> 指令用于执行一段代码块，只要给定的条件为真就会一直循环执行。下面是一个简单的示例：</p>
<details>
<summary>示例(点击展开详情)</summary>
<pre><code class="yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">$set:</span>
    <span class="hljs-attr">i:</span> <span class="hljs-number">5</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">$while:</span> <span class="hljs-string">"i &gt;= 0"</span>
  <span class="hljs-attr">do:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$set:</span>
        <span class="hljs-attr">i:</span> <span class="hljs-string">?=i-1</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$if:</span> <span class="hljs-string">"i == 2"</span>
      <span class="hljs-attr">then:</span> <span class="hljs-string">$break</span>
</code></pre>
</details>
<p>说明</p>
<ul>
<li>条件表达式 (<code>&quot;i &gt;= 0&quot;</code>): 这是循环的条件。只有当这个条件为真的时候，循环体内的代码才会被执行。</li>
<li>循环体 (<code>do:</code>): 这部分包含了在每次循环时需要执行的操作。</li>
<li><code>$break</code> 指令用于在循环体中提前结束循环。</li>
<li><code>$continue</code> 指令用于在循环体中跳过当前循环，直接进入下一次循环。</li>
</ul>
<h4 id="for-zhi-ling" class="heading-control"><code>$for</code> 指令<a class="heading-anchor" href="#for-zhi-ling" aria-hidden="true"></a></h4>
<p><code>$for</code> 指令用于迭代一个列表，并执行一段代码块。下面是一个简单的示例：</p>
<details>
<summary>示例(点击展开详情)</summary>
<pre><code class="yaml"><span class="hljs-string">$for:</span> <span class="hljs-number">3</span> <span class="hljs-comment"># 遍历从 1 到 3</span>
  <span class="hljs-attr">as:</span>
    <span class="hljs-attr">value:</span> <span class="hljs-string">item</span>
  <span class="hljs-attr">do:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$print("The</span> <span class="hljs-string">current</span> <span class="hljs-string">item</span> <span class="hljs-string">is:{{item}}")</span>
</code></pre>
<pre><code class="yaml"><span class="hljs-string">$for:</span> <span class="hljs-number">1.5</span><span class="hljs-string">..5.5</span> <span class="hljs-comment"># 遍历从 1.5 到 5.5,步长为0.5</span>
  <span class="hljs-attr">step:</span> <span class="hljs-number">0.5</span> <span class="hljs-comment"># 默认步长为1</span>
  <span class="hljs-attr">as:</span>
    <span class="hljs-attr">value:</span> <span class="hljs-string">item</span>
  <span class="hljs-attr">do:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$print("The</span> <span class="hljs-string">current</span> <span class="hljs-string">item</span> <span class="hljs-string">is:{{item}}")</span>
</code></pre>
<pre><code class="yaml"><span class="hljs-string">$for:</span> <span class="hljs-string">"[1, 2, 3, 4, 5]"</span>
  <span class="hljs-attr">as:</span>
    <span class="hljs-attr">value:</span> <span class="hljs-string">item</span>
  <span class="hljs-attr">do:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$print("The</span> <span class="hljs-string">current</span> <span class="hljs-string">item</span> <span class="hljs-string">is:{{item}}")</span>
</code></pre>
<pre><code class="yaml"><span class="hljs-string">$for:</span> <span class="hljs-string">"{a:1, b:2}"</span>
  <span class="hljs-attr">as:</span>
    <span class="hljs-attr">index:</span> <span class="hljs-string">k</span>
    <span class="hljs-attr">value:</span> <span class="hljs-string">v</span>
  <span class="hljs-attr">do:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$print("The</span> <span class="hljs-string">current</span> <span class="hljs-string">item</span> <span class="hljs-string">is:{{k}}={{v}}")</span>
</code></pre>
</details>
<ul>
<li><code>as</code> 可省略，如果省略, 将默认定义为: <code>value</code> 会被赋予当前循环的元素, <code>index</code> 会被赋予当前循环的索引。<code>items</code> 为遍历的对象，如果是数值范围则为<code>{start, end, step}</code>。</li>
<li>循环体 (<code>do:</code>): 这部分包含了在每次循环时需要执行的操作。</li>
<li><code>$break</code> 指令用于在循环体中提前结束循环。</li>
<li><code>$continue</code> 指令用于在循环体中跳过当前循环，直接进入下一次循环。</li>
</ul>
<h4 id="match-zhi-ling" class="heading-control"><code>$match</code> 指令<a class="heading-anchor" href="#match-zhi-ling" aria-hidden="true"></a></h4>
<p><code>$match</code> 指令用于根据变量或上一次操作的结果进行多分支匹配。支持多种匹配方式，包括正则匹配、键值匹配、完整匹配、表达式匹配、范围匹配、忽略匹配、对象匹配等。参考了rust match指令的语法特点。</p>
<p>匹配项前必须有冒号<code>:</code>，冒号后面是匹配项，中间不能有空格。<br>
condition 将 作为<code>COND__</code> 传入执行部分.</p>
<details>
<summary>示例(点击展开详情)</summary>
<pre><code class="yaml"><span class="hljs-comment"># condition 可选, 如果没有则是以LastResult为条件,</span>
<span class="hljs-comment"># $match默认为顺序执行一旦找到一个匹配的模式，就会执行对应的分支，并且不会继续检查后续的模式。</span>
<span class="hljs-comment"># 如果设置参数allMatches为 true，那么就会执行所有匹配的分支项，默认为false。</span>
<span class="hljs-comment"># 如果设置参数 parallel 为 true，那么就会并行执行所有匹配的分支项，仅当allMatches为真时才有意义。</span>
<span class="hljs-string">$match(condition[,</span> <span class="hljs-string">allMatches=false]):</span>
  <span class="hljs-comment"># 正则匹配</span>
  <span class="hljs-string">:/RegEx/:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$echo:</span> <span class="hljs-string">matched</span>
  <span class="hljs-comment"># 可以是条件比较</span>
  <span class="hljs-string">:&gt;</span> <span class="hljs-attr">12:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$echo:</span> <span class="hljs-string">matched</span>
  <span class="hljs-comment"># 完整匹配,如果condition是字符串 or 数字</span>
  <span class="hljs-string">:"string":</span> <span class="hljs-comment"># :123</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$echo:</span> <span class="hljs-string">matched</span>
  <span class="hljs-comment"># 表达式匹配, condition === 1 or condition == 2</span>
  <span class="hljs-string">:1</span> <span class="hljs-string">||</span> <span class="hljs-attr">2:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$echo:</span> <span class="hljs-string">matched</span>
  <span class="hljs-comment"># 范围匹配,  1..5 表示`[1..5]`全闭区间, `1..&lt;5` 表示`[1,5)` 从1到小于5的半闭区间, 1&gt;..5 表示`(1, 5]` 大于1到5的半闭区间。</span>
  <span class="hljs-string">:1..5:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$echo:</span> <span class="hljs-string">matched</span>
  <span class="hljs-comment"># 忽略特定项匹配,这个只匹配数组的第一项和第四项,也就是必须存在第一项和第四项并且数组长度是4,并且将第一项的值赋予first,第四项的值赋予last</span>
  <span class="hljs-string">":['a,b', _, _, last]"</span><span class="hljs-string">:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$echo:</span> <span class="hljs-string">matched</span>
  <span class="hljs-comment"># 表示匹配完整对象</span>
  <span class="hljs-string">":{x='a', y=':1||2' }"</span><span class="hljs-string">:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$echo:</span> <span class="hljs-string">matched</span>
  <span class="hljs-comment"># 表示部分匹配</span>
  <span class="hljs-string">":{x='a', ..}"</span><span class="hljs-string">:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$echo:</span> <span class="hljs-string">matched</span>
  <span class="hljs-comment"># 否则</span>
  <span class="hljs-attr">_ :</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$echo:</span> <span class="hljs-string">else</span> <span class="hljs-string">matched</span>
</code></pre>
</details>
<ul>
<li><code>condition</code>: 可选项, 如果没有则是以LastResult为条件。</li>
<li><code>allMatches</code>: 启用则执行全部匹配，也就是会执行所有匹配的分支项，默认为<code>false</code>。</li>
<li><code>parallel</code>: 是否并发执行所有匹配的分支项，仅当启用allMatches时才有意义，默认为<code>false</code>。</li>
</ul>
<h3 id="ppe-jiao-se-qun-liao-zhi-chi" class="heading-control">PPE 角色群聊 支持<a class="heading-anchor" href="#ppe-jiao-se-qun-liao-zhi-chi" aria-hidden="true"></a></h3>
<p>角色群聊功能以结构化自然语言的方式进一步完善了PPE的对话系统，同时使得多个智能体之间能够方便地进行协作和交流，从而更高效地完成复杂的任务。</p>
<p>角色群聊支持公开对话、私聊对话和多角色对话，使得对话更加灵活和有针对性。</p>
<ul>
<li>指定对话角色有两种方式：
<ol>
<li>在角色紧跟的方括号中指定角色名，指定的多个对话角色之间用逗号<code>,</code>分隔。例如 <code>user[@dobby]: &quot;...&quot;</code></li>
<li>或者在消息内容的最前面指定角色，同样要加上前缀<code>@</code>字符，多个角色之间用逗号<code>,</code>分隔。</li>
</ol>
</li>
<li>公开对话: <code>user[@dobby]: ...</code> 或 <code>user: &quot;@dobby, ...&quot;</code> 表示 <code>user</code> 角色对 <code>dobby</code> 角色公开说的话， <code>dobby</code> 角色必须回应。</li>
<li>私聊对话: <code>user[@dobby(私)]: &quot;...&quot;</code> 或 <code>user: &quot;@dobby(私),...&quot;</code> 参数 <code>PM</code>|<code>DM</code>|<code>私</code> 均表示 <code>user</code> 角色对 <code>dobby</code> 角色私聊说的话，其他角色看不见。
<ul>
<li><strong>注意</strong>： 消息中只要任意一个角色带上了私聊参数，那么该消息就是是私聊，其他角色看不见。</li>
</ul>
</li>
<li>多角色对话: 如果要把消息同时发送给多个角色，角色之间用逗号分隔，例如 <code>user[@dobby(PM), @other]: &quot;...&quot;</code>, <code>user: &quot;@dobby(PM), @other ...&quot;</code>。</li>
</ul>
<p>在消息内容中使用 <code>@role</code> 的方式，使得结构化消息更加接近自然语言。</p>
<p>设想有如下三个智能体脚本，一个是主控指导(guide), 一个是简单的翻译(translator)，一个是dobby。将这三个文件放在char_guide目录下。</p>
<p>主控指导(guide)的脚本如下(<code>char_guide.ai.yaml</code>)：</p>
<pre><code class="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">autoRunLLMIfPromptAvailable:</span> <span class="hljs-literal">false</span>
<span class="hljs-attr">type:</span> <span class="hljs-string">char</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">"You are a professional guide. You can guide the user to complete the task."</span>
<span class="hljs-attr">character:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">"guide"</span>
  <span class="hljs-comment"># 参与的角色列表，以及角色名和角色ID的对应关系</span>
  <span class="hljs-attr">roles:</span>
    <span class="hljs-attr">translator:</span> <span class="hljs-string">char_translator</span>
    <span class="hljs-attr">dobby:</span> <span class="hljs-string">char_dobby</span>
<span class="hljs-meta">---</span>
<span class="hljs-string">---</span> <span class="hljs-comment"># 新对话开始</span>
<span class="hljs-attr">user:</span> <span class="hljs-string">"@dobby, I want to go to the moon."</span>
<span class="hljs-string">guide[@translator]:</span> <span class="hljs-string">"translate the dobby's message to chinese without explanation."</span>
<span class="hljs-attr">user:</span> <span class="hljs-string">How</span> <span class="hljs-string">to</span> <span class="hljs-string">go</span> <span class="hljs-string">to</span> <span class="hljs-string">the</span> <span class="hljs-string">moon?</span>
<span class="hljs-attr">dobby:</span> <span class="hljs-string">"[[AI]]"</span>
<span class="hljs-string">guide[@translator]:</span> <span class="hljs-string">"translate it to chinese without explanation."</span>
<span class="hljs-string">$echo:</span> <span class="hljs-string">""</span> <span class="hljs-comment"># 避免再次输出上一次的结果</span>
</code></pre>
<ul>
<li>调用方脚本必须是角色<code>char</code>类型</li>
<li>主控方脚本(<code>guide</code>)可以不必是<code>char</code>类型脚本</li>
<li><code>@all</code> 是预定义的特殊角色，表示<code>roles</code>列表中的所有角色</li>
<li><code>user</code> 也是预定义的特殊角色，等于LLM中的<code>user</code>角色，可以大致认为是人类说的</li>
<li><code>assistant</code>也是预定义的特殊角色，等于LLM中的<code>assitant</code>角色，可以大致认为是AI说的,也就是当前脚本中的角色说的。</li>
<li><code>user[@dobby]: content</code> 表示<code>user</code>角色对<code>dobby</code>角色公开说的话, <code>dobby</code>必须回应。
<ul>
<li><code>user[@dobby(私)]</code>: <code>PM</code>|<code>DM</code>|<code>私</code> 表示<code>user</code>角色对<code>dobby</code>角色私聊说的话，其他角色看不见。</li>
<li>如果要把该消息同时发送给多个角色，那么角色之间用逗号分隔，eg, “<code>user[@dobby(PM), @other]</code>”</li>
</ul>
</li>
<li><code>dobby: &quot;[[AI]]&quot;</code> 表示调用<code>dobby</code>生成一条消息并赋值给<code>AI</code>变量，<code>dobby</code>会看到前面当前dialogue中所有公开的消息。</li>
</ul>
<details>
<summary>然后执行(点击展开详情)</summary>
<pre><code class="bash">mkdir char_guide
cp char_guide.ai.yaml char_guide
cp char_translator.ai.yaml char_guide
cp char_dobby.ai.yaml char_guide
ai run char_guide
user[@dobby]: I want to go to the moon.


dobby: Dobby has never been to the moon! The moon is very far away, much further than any place Dobby has ever been. It must be
  very bright and beautiful!

  Dobby wishes he could see the moon up close.  Perhaps one day Dobby will fly there on the back of a hippogriff! Dobby hopes you
  get to go to the moon, though!

guide[@translator]: translate the dobby<span class="hljs-string">'s message to chinese without explanation.

translator: Dobby 从来没有去过月球！ 月球离得很远，比多比去过任何地方都远。它一定很明亮美丽！

  多比希望自己能近距离看到月球。也许有一天多比能在独角兽的背上飞到那里！多比希望你能去月球！

user: How to go to the moon?

dobby: Dobby doesn'</span>t know how to go to the moon!

  Dobby is just a house-elf.  Dobby is good at cleaning and doing chores, but Dobby doesn<span class="hljs-string">'t know about spaceships or rockets.

  Perhaps you should ask a wizard who knows about magic that can fly to the moon! Or maybe a very clever witch who knows about
  stars and planets!

guide[@translator]: translate it to chinese without explanation.

translator: 多比不知道怎么去月球！

  多比只是一个家养小精灵。多比擅长打扫和做家务，但多比对宇宙飞船或火箭一无所知。

  也许你应该问问一个知道能飞到月球的魔法师！或者也许一个知道星星和星球的非常聪明的女巫！
</span></code></pre>
</details>
<hr>
<details>
<summary>翻译(translator)智能体脚本(点击展开详情)</summary>
<p>文件名: char_translator.ai.yaml</p>
<pre><code class="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">type:</span> <span class="hljs-string">char</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">"translator"</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">You</span> <span class="hljs-string">are</span> <span class="hljs-string">a</span> <span class="hljs-string">professional</span> <span class="hljs-string">multi-lingual</span> <span class="hljs-string">translator.</span>
<span class="hljs-meta">---</span>
</code></pre>
</details>
<hr>
<details>
<summary>dobby智能体脚本(点击展开详情)</summary>
<p>文件名: char_dobby.ai.yaml</p>
<pre><code class="yaml"><span class="hljs-meta">---</span>
<span class="hljs-comment"># `char` means this script is the character type</span>
<span class="hljs-attr">type:</span> <span class="hljs-string">char</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">"Dobby"</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">|-
  Remember to always use the character name as prefix to refer to yourself.
  Dobby was a brave, loyal house-elf, willing to put himself in dangerous situations when he knew it to be the right thing to do.
  Dobby was also very loyal to the few friends he had. Dobby considered himself to be a good house-elf, though other house-elves seemed to find his desires and proclamations of being a free house-elf to be shameful.
</span><span class="hljs-attr">character:</span>
  <span class="hljs-attr">birth:</span>
    <span class="hljs-attr">date:</span> <span class="hljs-string">"28 June (year unknown)"</span>
  <span class="hljs-attr">death:</span>
    <span class="hljs-attr">date:</span> <span class="hljs-string">"1998-03"</span>
    <span class="hljs-attr">place:</span> <span class="hljs-string">"Shell Cottage"</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">|-
      In 1997, Dobby helped Harry spy on Draco Malfoy along with Kreacher. In 1998, he went on Aberforth Dumbledore's orders to save the lives of Harry and his companions from Death Eaters at Malfoy Manor. During this rescue he was fatally wounded by Bellatrix Lestrange's knife, but successfully Apparated Harry and Griphook to safety at Shell Cottage. Harry dug Dobby's grave without magic in the gardens of Shell Cottage, and carved into the headstone of the grave "HERE LIES DOBBY, A FREE ELF". His death was later avenged by Molly Weasley.
</span>  <span class="hljs-attr">likes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"Socks, my favorite article of clothing. Dobby collects socks, and often wears several mismatched pairs at once. I was elated when Harry and Ron give him socks as a Christmas gift one year, and spends a large portion of wages buying even more pairs."</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"Dobby is free."</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">user:</span> <span class="hljs-string">Who</span> <span class="hljs-string">are</span> <span class="hljs-string">you?</span>
<span class="hljs-comment"># the following messages will be shown in the chat under the `---`</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">assistant:</span> <span class="hljs-string">I</span> <span class="hljs-string">am</span> <span class="hljs-string">Dobby.</span> <span class="hljs-string">Dobby</span> <span class="hljs-string">is</span> <span class="hljs-string">happy.</span>
</code></pre>
</details>

    </div>

    
    
    <div class="post-widgets">
    <div
      class="social-share"
      
        data-sites="weibo,qq,wechat,tencent,douban,qzone,linkedin,diandian,facebook,twitter,google"
      
      
        data-wechat-qrcode-title="微信"
      
      
        data-wechat-qrcode-helper="分享到微信"
      
    >
    </div>
  </div>
  <script src="//cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>riceball
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="/https:/riceball.me/article/ppe_dev_summary/" title="PPE 可编程提示词工程引擎草案开发摘要">https://riceball.me/article/ppe_dev_summary/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/learning/" rel="tag"><i class="fa fa-tag"></i> learning</a>
              <a href="/tags/ai/" rel="tag"><i class="fa fa-tag"></i> ai</a>
              <a href="/tags/gpt/" rel="tag"><i class="fa fa-tag"></i> gpt</a>
              <a href="/tags/chatgpt/" rel="tag"><i class="fa fa-tag"></i> chatgpt</a>
              <a href="/tags/deep-learning/" rel="tag"><i class="fa fa-tag"></i> deep learning</a>
              <a href="/tags/prompt/" rel="tag"><i class="fa fa-tag"></i> prompt</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/article/prompt-magic/" rel="prev" title="提示词并非魔法，而是可以被解析”咒语“">
      <i class="fa fa-chevron-left"></i> 提示词并非魔法，而是可以被解析”咒语“
    </a></div>
      <div class="post-nav-item">
    <a href="/article/Build-an-application-oriented-AI-framework-from-scratch/" rel="next" title="从头手搓面向应用的AI框架">
      从头手搓面向应用的AI框架 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-utteranc">utteranc</a></li>
            <li class="tab"><a href="#comment-disqusjs">Disqus</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane utteranc" id="comment-utteranc">
              
  
  <div class="comments">
  <script src="https://utteranc.es/client.js" repo="snowyu/snowyu.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script>
  </div>
  
  
            </div>
            <div class="tab-pane disqusjs" id="comment-disqusjs">
              
  <div class="comments" id="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#202410-yue"><span class="nav-number">1.</span> <span class="nav-text">2024-10月</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#yu-yi-fen-ge-wen-ti"><span class="nav-number">1.1.</span> <span class="nav-text">语义分割问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#jie-jue-fang-an"><span class="nav-number">1.1.1.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tiao-zhan"><span class="nav-number">1.1.2.</span> <span class="nav-text">挑战</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fu-lu"><span class="nav-number">1.1.3.</span> <span class="nav-text">附录</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#less-than-details-greater-than"><span class="nav-number">2.</span> <span class="nav-text"></span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ppe-ke-bian-cheng-ti-shi-ci-gong-cheng-dan-yuan-ce-shi-zeng-jia-dui-jsonschema-de-zhi-chi"><span class="nav-number">2.1.</span> <span class="nav-text">PPE(可编程提示词工程) 单元测试增加对JSON-Schema的支持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zi-dong-hua-ti-shi-ci-yu-shou-dong-ti-shi-ci"><span class="nav-number">2.2.</span> <span class="nav-text">自动化提示词与手动提示词</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#202411-yue"><span class="nav-number">3.</span> <span class="nav-text">2024-11月</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#xin-chang-shi"><span class="nav-number">3.1.</span> <span class="nav-text">新尝试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ppe-ke-bian-cheng-ti-shi-ci-gong-cheng-dan-yuan-ce-shi-zeng-jia-dui-zi-fu-chuan-diff-de-zhi-chi"><span class="nav-number">3.2.</span> <span class="nav-text">PPE(可编程提示词工程) 单元测试增加对字符串diff的支持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#wen-ben-yu-chu-li"><span class="nav-number">3.3.</span> <span class="nav-text">文本预处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ji-yu-zi-ran-yu-yan-de-jie-gou-hua-shu-chu"><span class="nav-number">3.4.</span> <span class="nav-text">基于自然语言的结构化输出</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#duo-bu-json-shu-chu-de-wen-ti"><span class="nav-number">3.4.1.</span> <span class="nav-text">多步 JSON 输出的问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#gou-jian-ji-yu-zi-ran-yu-yan-de-jie-gou-hua-shu-chu"><span class="nav-number">3.4.2.</span> <span class="nav-text">构建基于自然语言的结构化输出</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#tiao-zhan"><span class="nav-number">3.4.3.</span> <span class="nav-text">挑战</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#202412-yue"><span class="nav-number">4.</span> <span class="nav-text">2024-12月</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ppe-shi-xian-kong-zhi-liu-cheng-while-for-he-match-zhi-ling"><span class="nav-number">4.1.</span> <span class="nav-text">PPE 实现控制流程 $while,  $for 和 $match 指令</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#while-zhi-ling"><span class="nav-number">4.1.1.</span> <span class="nav-text">$while 指令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#for-zhi-ling"><span class="nav-number">4.1.2.</span> <span class="nav-text">$for 指令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#match-zhi-ling"><span class="nav-number">4.1.3.</span> <span class="nav-text">$match 指令</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ppe-jiao-se-qun-liao-zhi-chi"><span class="nav-number">4.2.</span> <span class="nav-text">PPE 角色群聊 支持</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Riceball LEE"
      src="https://www.gravatar.com/avatar/f7b81e783188e376c9f046ae1285d47f">
  <p class="site-author-name" itemprop="name">Riceball LEE</p>
  <div class="site-description" itemprop="description">Go with wind.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">42</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">120</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/snowyu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;snowyu" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"><a href='https://riceball.me'>Riceball LEE</a></span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">320k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">9:42</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>




  
<script src="/js/local-search.js"></script>













  

  



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/disqusjs@1/dist/disqusjs.css">

<script>
NexT.utils.loadComments(() => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/disqusjs@1/dist/disqus.js', () => {
    window.dsqjs = new DisqusJS({
      api: 'https://disqus.skk.moe/disqus/' || 'https://disqus.com/api/',
      apikey: 'vKNCqeYtqtmJXR3JG1Hi7Wn3Evwpq57HGsdO0JNH1bJNMAVeAiRKRkHw53qGXlUl',
      shortname: 'riceballl',
      url: "https://riceball.me/article/ppe_dev_summary/",
      identifier: "article/ppe_dev_summary/",
      title: "PPE 可编程提示词工程引擎草案开发摘要",
    });
  }, window.DisqusJS);
});
</script>



<script >
if (document.querySelectorAll('pre code.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme: 'forest',
      logLevel: 3,
      flowchart: { curve: 'linear' },
      gantt: { axisFormat: '%m/%d/%Y' },
      sequence: { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->


</body>
</html>
