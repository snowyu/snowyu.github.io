<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>从头手搓面向应用的AI框架</title>
    <url>/article/Build-an-application-oriented-AI-framework-from-scratch/</url>
    <content><![CDATA[<h1 id="cong-tou-shou-cuo-mian-xiang-ying-yong-de-ai-kuang-jia" class="heading-control">🌟 从头手搓面向应用的AI框架 🚀<a class="heading-anchor" href="#cong-tou-shou-cuo-mian-xiang-ying-yong-de-ai-kuang-jia" aria-hidden="true"></a></h1>
<h2 id="wei-shi-mo-cong-tou-shou-cuo-ai-kuang-jia-er-bu-shi-shi-yong-xian-you-kuang-jia" class="heading-control">为什么从头手搓 AI 框架，而不是使用现有框架？<a class="heading-anchor" href="#wei-shi-mo-cong-tou-shou-cuo-ai-kuang-jia-er-bu-shi-shi-yong-xian-you-kuang-jia" aria-hidden="true"></a></h2>
<p>💡 为啥我要从头手搓AI框架，而不是直接使用类似 langchain、AutoGen、LMQL 等现成框架呢？</p>
<p>最初我也尝试了多个框架（包括LangChain、AutoGen、LMQL、Outlines、MemGPT等），但它们都无法完全满足我的需求。我想要的是一个<strong>极度灵活可配置的AI应用框架</strong>，用来打造我设想的<code>「真·AI PC」</code>——而非当前大多数AI产品那种“远程AI服务+本地空壳”的模式。</p>
<p>在当前阶段，我认为面向应用的AI框架应聚焦于<strong>提示词（Prompt）的工程化</strong>——这是人类与AI交互的唯一桥梁。我的核心目标是：<br>
✅ 将提示词转化为可编程的“函数”或“类”，支持自由组合、独立调用，并能持续迭代优化。</p>
<p>但是langchain对提示词的抽象只是总结的一些范式，而这些范式在我看来不太不实用，而且更糟糕的是直接将提示词内嵌入代码中，根本无法替换和迭代提示词。而AutoGen是以多智能体架构和事件驱动为核心实现复杂协作工作流；至于LMQL作为一种用于语言模型交互的查询语言更像是炫技；Outlines 聚焦在结构化文本的生成；MemGPT只想实现长久记忆， 这些就不多做评价了。</p>
<h2 id="wo-xiang-yao-de-ai-kuang-jia-he-xin-gong-neng" class="heading-control">我想要的AI框架核心功能<a class="heading-anchor" href="#wo-xiang-yao-de-ai-kuang-jia-he-xin-gong-neng" aria-hidden="true"></a></h2>
<p>我想要的是以提示词为核心的框架：</p>
<ol>
<li><strong>提示词即函数</strong>：让提示词象普通函数一样的使用，独立提示词可以与代码无缝双向调用，代码可以调用提示词获得结果，提示词也可以调用代码获得结果。</li>
<li><strong>加密保护</strong>： 支持提示词加密，保障知识产权</li>
<li><strong>模型中立</strong>： 提示词可适配不同模型及参数规模。</li>
<li><strong>继承机制</strong>：支持提示词“类”的继承，如同面向对象编程。</li>
<li><strong>简洁易用</strong>：提示词需简单易读写。</li>
<li><strong>打包为应用</strong>：能将多个提示词打包成完整AI应用。</li>
<li><strong>高度可扩展</strong>：支持任意能力的扩展，如:看（图生文），听(STT)，说(TTS)，画(文生图/视频)等等。</li>
<li><strong>全栈兼容</strong>：跨平台支持（浏览器、服务器端），尽量统一语言减少维护成本（选型JavaScript）。</li>
</ol>
<h2 id="kai-fa-li-cheng" class="heading-control">开发历程 🛠️<a class="heading-anchor" href="#kai-fa-li-cheng" aria-hidden="true"></a></h2>
<p>在2024年多方搜寻无果的情况下，2024年5月我开始从头写<a href="https://github.com/offline-ai/ppe/" target="_blank" rel="noopener">可编程提示词(Programmable Prompt Engine)AI规范</a>，当然最开始不是叫这个名字，最开始叫<code>AI Agent Framework</code>,后来是表伟提议既然是实质是让提示词成为可编程的软件工程，那么不妨就叫PPE，我想也对，这个概念更准确，AI Agent应该是以PPE提示词为基础打造，它其实是更上层的概念，遂更名为PPE。</p>
<p>既然要全栈，那就只能选JavaScript, 从前端到后端，从服务器到浏览器通吃，并且JS极度灵活和可扩展，而这正是我所需要的。</p>
<h3 id="jie-gou-hua-dui-hua-xiao-xi" class="heading-control">结构化对话消息<a class="heading-anchor" href="#jie-gou-hua-dui-hua-xiao-xi" aria-hidden="true"></a></h3>
<p>刚开始写的时候，还是很茫然无措的，没有项目可供参考，</p>
<p>最初就想着用YAML配置的方式简单的来结构化对话消息,然后既然提示词是函数那就肯定需要约定函数的输入和输出: 用<code>input</code>来约定提示词的输入参数, <code>output</code>用<code>Json Schema</code>来约定提示词的输出：</p>
<pre><code class="yaml"><span class="hljs-attr">templateFormat:</span> <span class="hljs-string">hf</span>
<span class="hljs-attr">prompt:</span>
  <span class="hljs-attr">messages:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">role:</span> <span class="hljs-string">system</span>
      <span class="hljs-attr">content:</span> <span class="hljs-string">Carefully</span> <span class="hljs-string">Think</span> <span class="hljs-string">about</span> <span class="hljs-string">the</span> <span class="hljs-string">intent</span> <span class="hljs-string">of</span> <span class="hljs-string">following</span> <span class="hljs-string">The</span> <span class="hljs-string">CONVERSATION</span> <span class="hljs-string">user</span> <span class="hljs-string">provided.</span> <span class="hljs-string">Output</span> <span class="hljs-string">the</span> <span class="hljs-string">json</span> <span class="hljs-string">object</span> <span class="hljs-string">with</span> <span class="hljs-string">the</span> <span class="hljs-string">Intent</span> <span class="hljs-string">Category</span> <span class="hljs-string">and</span> <span class="hljs-string">Reason.</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">role:</span> <span class="hljs-string">user</span>
      <span class="hljs-attr">content:</span> <span class="hljs-string">|-
        The CONVERSATION:
        {{ conversation }}
</span><span class="hljs-attr">input:</span>
  <span class="hljs-attr">conversation:</span> <span class="hljs-string">"messages[1].content"</span>
<span class="hljs-attr">output:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
  <span class="hljs-attr">properties:</span>
    <span class="hljs-attr">Intent:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">"string"</span>
    <span class="hljs-attr">Reason:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">"string"</span>
</code></pre>
<p>感觉，这样很不自然方便，于是将结构化对话消息的输入/输出配置与对话内容分离:</p>
<pre><code class="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">input:</span>
  <span class="hljs-attr">conversation:</span> <span class="hljs-string">{required:</span> <span class="hljs-literal">true</span><span class="hljs-string">}</span>
<span class="hljs-attr">output:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
  <span class="hljs-attr">properties:</span>
    <span class="hljs-attr">Intent:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">"string"</span>
    <span class="hljs-attr">Reason:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">"string"</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">system:</span> <span class="hljs-string">Carefully</span> <span class="hljs-string">Think</span> <span class="hljs-string">about</span> <span class="hljs-string">the</span> <span class="hljs-string">intent</span> <span class="hljs-string">of</span> <span class="hljs-string">following</span> <span class="hljs-string">The</span> <span class="hljs-string">CONVERSATION</span> <span class="hljs-string">user</span> <span class="hljs-string">provided.</span> <span class="hljs-string">Output</span> <span class="hljs-string">the</span> <span class="hljs-string">json</span> <span class="hljs-string">object</span> <span class="hljs-string">with</span> <span class="hljs-string">the</span> <span class="hljs-string">Intent</span> <span class="hljs-string">Category</span> <span class="hljs-string">and</span> <span class="hljs-string">Reason.</span>
<span class="hljs-attr">user:</span> <span class="hljs-string">|-
  The CONVERSATION:
  {{ conversation }}
</span></code></pre>
<p>这样就感觉好多了。</p>
<h3 id="ti-shi-ci-tiao-yong-yu-dai-ma-ji-cheng" class="heading-control">提示词调用与代码集成<a class="heading-anchor" href="#ti-shi-ci-tiao-yong-yu-dai-ma-ji-cheng" aria-hidden="true"></a></h3>
<p>那么如何在提示词中使用(调用)AI赋值以及其他提示词或代码？于是有了<code>高级替换</code>:</p>
<pre><code class="yaml"><span class="hljs-meta">---</span>
<span class="hljs-comment"># 导入js函数</span>
<span class="hljs-attr">import:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">eval.js</span>
<span class="hljs-meta">---</span>
<span class="hljs-comment"># JOKE会被AI赋值,存放于: `prompt.JOKE` 中，供下次使用</span>
<span class="hljs-attr">assistant:</span> <span class="hljs-string">"讲个笑话：[[JOKE]] 希望您喜欢！"</span>
<span class="hljs-comment"># 调用外部提示词`calculator`</span>
<span class="hljs-attr">user:</span> <span class="hljs-string">"五加二等于 [[@calculator("</span><span class="hljs-number">5</span><span class="hljs-string">+2")]]"</span>
<span class="hljs-comment"># 调用函数代码`eval`</span>
<span class="hljs-attr">user:</span> <span class="hljs-string">"五加二等于 [[@$eval("</span><span class="hljs-number">5</span><span class="hljs-string">+2")]]"</span>
</code></pre>
<pre><code class="js"><span class="hljs-comment">// eval.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eval</span>(<span class="hljs-params">value</span>) </span>{
  <span class="hljs-keyword">return</span> ...
}
</code></pre>
<h3 id="lian-shi-tiao-yong-yu-can-shu-chuan-di" class="heading-control">链式调用与参数传递<a class="heading-anchor" href="#lian-shi-tiao-yong-yu-can-shu-chuan-di" aria-hidden="true"></a></h3>
<p>如何将最近消息内容传递给外部提示词？通过箭头符号<code>-&gt;</code>来实现动态参数传递:</p>
<pre><code class="yaml"><span class="hljs-attr">user:</span> <span class="hljs-string">"讲个笑话吧！"</span>
<span class="hljs-attr">assistant:</span> <span class="hljs-string">"[[JOKE]]"</span>
<span class="hljs-comment"># 传入智能体的实际输入参数是: {content: "[这里是由AI生成的笑话]", target_lang: "葡萄牙语"}</span>
<span class="hljs-string">-&gt;</span> <span class="hljs-string">translator(target_lang="葡萄牙语")</span> <span class="hljs-string">-&gt;</span> <span class="hljs-string">$print</span>
</code></pre>
<h3 id="zai-yi-lai-de-js-jiao-ben-zhong-tiao-yong-wai-bu-ti-shi-ci" class="heading-control">在依赖的js脚本中调用外部提示词<a class="heading-anchor" href="#zai-yi-lai-de-js-jiao-ben-zhong-tiao-yong-wai-bu-ti-shi-ci" aria-hidden="true"></a></h3>
<p>那么，反过来，如何在依赖的js脚本调用外部提示词呢?</p>
<pre><code class="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">callPPEScriptDemo</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.$exec({<span class="hljs-attr">id</span>: <span class="hljs-string">'calculator'</span>, <span class="hljs-attr">args</span>:{ <span class="hljs-attr">content</span>: <span class="hljs-string">"6+3"</span> }})
}
</code></pre>
<h3 id="nei-zhi-han-shu-zhi-ling-yu-luo-ji-kong-zhi" class="heading-control">内置函数指令与逻辑控制<a class="heading-anchor" href="#nei-zhi-han-shu-zhi-ling-yu-luo-ji-kong-zhi" aria-hidden="true"></a></h3>
<p>有些时候，我需要在提示词中根据不同条件来产生不同的提示词，甚至需要多条件匹配，于是开始内置相应的函数指令: <code>$if</code>, <code>$match</code>, …</p>
<pre><code class="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">input:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">file</span>
<span class="hljs-meta">---</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">$if:</span> <span class="hljs-string">"this.file"</span>
  <span class="hljs-attr">then:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">...</span>
</code></pre>
<p>并发测试服务提供商的不同模型:</p>
<pre><code class="yaml"><span class="hljs-string">$match(true,</span> <span class="hljs-string">allMatches=true,</span> <span class="hljs-string">parallel=true):</span>
  <span class="hljs-string">:true:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$AI(pushMessage=false,</span> <span class="hljs-string">model="openai://Qwen/Qwen2.5-Coder-7B-Instruct",</span> <span class="hljs-string">apiUrl="https://api.siliconflow.cn/",</span> <span class="hljs-string">apiKey="...")</span>
  <span class="hljs-string">:true:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$AI(pushMessage=false,</span> <span class="hljs-string">model="openai://THUDM/glm-4-9b-chat",</span> <span class="hljs-string">apiUrl="https://api.siliconflow.cn/",</span> <span class="hljs-string">apiKey="...")</span>
</code></pre>
<p>随后，完善了循环控制函数指令: <code>$for</code>, <code>$while</code></p>
<h3 id="huan-cun-ji-zhi-yu-xing-neng-you-hua" class="heading-control">缓存机制与性能优化<a class="heading-anchor" href="#huan-cun-ji-zhi-yu-xing-neng-you-hua" aria-hidden="true"></a></h3>
<p>然后，发现这个提示词&quot;函数&quot;执行耗时长，如果多次反复执行同一参数的&quot;函数&quot;就更浪费时间了，为啥不能缓存结果？于是有了LRU缓存执行结果，所有的外部调用脚本结果默认都会被缓存，当然可以简单通过参数开关<code>memoized</code>关闭该行为：</p>
<pre><code class="yaml"><span class="hljs-string">"[[@calculator(content="</span><span class="hljs-number">5</span><span class="hljs-string">+2",</span> <span class="hljs-string">memoized=false)]]"</span>
</code></pre>
<h3 id="da-mo-xing-de-jie-gou-hua-shu-chu" class="heading-control">大模型的结构化输出<a class="heading-anchor" href="#da-mo-xing-de-jie-gou-hua-shu-chu" aria-hidden="true"></a></h3>
<p>大模型必须对输出进行结构化（约定输出），程序代码函数才能处理。通常我们约定的是大模型结构化输出JSON对象。</p>
<p>我在实践中发现，对于推理任务，在不约束大模型输出类型的情况下，输出质量更好，而对于不需要推理的分类任务，则恰恰相反。关于这个，有人已经做了更详细的比较: <a href="https://arxiv.org/html/2408.02442v1" target="_blank" rel="noopener">Let Me Speak Freely? A Study on the Impact of Format Restrictions on Performance of Large Language Models</a></p>
<p>另外，对大模型进行约定输出格式的文本格式也会影响输出质量，也就是告诉它如何输出的方式。用自然语言表达形式，好于直接给定json.</p>
<p>我测试下来，对于目前大多数 LLM 模型来讲 <code>自然语言 &gt; YAML &gt; XML &gt; JSON</code>，当然具体还要看个别模型是否对某个格式又做了针对性的学习。</p>
<p>因此，我设计了多种结构化响应输出格式类型，用来自动将输出内容和格式告诉给大模型，以及将大模型的输出自动转换。</p>
<ul>
<li>多种结构化响应输出格式类型(<code>response_format.type</code>)支持:
<ul>
<li>JSON 格式</li>
<li>YAML 格式</li>
<li>自然语言对象(NOBJ) 格式</li>
<li>用JSON Schema格式设置好<code>output</code>.PPE就会自动解析AI生成的对应格式的内容为<code>Object</code>供代码使用.</li>
</ul>
</li>
</ul>
<p>约定PPE脚本输出内容始终用<code>JSON Schema</code>表示，而选择告知大模型的方式则在<code>parameters.response_format.type</code>中控制。这样，最终给到代码这边的结果始终是转换后的<code>JSON</code>对象。如果转换失败，会触发异常错误，通过设置<code>forceJson</code>为<code>false</code>禁止触发异常，这时当无法转换，就会返回文本内容。</p>
<pre><code class="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">output:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">"object"</span>
  <span class="hljs-attr">properties:</span>
    <span class="hljs-attr">target_text:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">"string"</span>
<span class="hljs-attr">parameters:</span>
  <span class="hljs-comment"># 使用后面的参数,将设置强制json输出格式,确保大模型总是输出正确的json格式.</span>
  <span class="hljs-attr">response_format:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">"json"</span>
<span class="hljs-comment"># forceJson: false</span>
<span class="hljs-meta">---</span>
</code></pre>
<h3 id="duo-lun-dui-hua-zhi-chi" class="heading-control">多轮对话支持<a class="heading-anchor" href="#duo-lun-dui-hua-zhi-chi" aria-hidden="true"></a></h3>
<p>如何在同一个脚本中开启多轮对话，于是有了三个短划线(<code>---</code>) 或星号 <code>***</code> 表示一个新的对话开始:</p>
<pre><code class="yaml"><span class="hljs-attr">system:</span> <span class="hljs-string">"您是一位AI助手。"</span>
<span class="hljs-comment"># 第一个分隔线作为对话的起点,第一个分隔线上面的对话内容会被隐藏，可以当作系统提示词,它们不会被输出或记录.</span>
<span class="hljs-meta">---</span>
<span class="hljs-string">"10加18等于多少？"</span>
<span class="hljs-comment"># 执行AI,替换为AI传回的结果result</span>
<span class="hljs-attr">assistant:</span> <span class="hljs-string">"[[result]]"</span>
<span class="hljs-comment"># 打印大模型传回的结果</span>
<span class="hljs-string">$print:</span> <span class="hljs-string">"?=result"</span>
<span class="hljs-comment"># 第二个分隔线下面开始新对话,回到第一次的起点</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">user:</span> <span class="hljs-string">"10加12等于多少？"</span>
<span class="hljs-comment"># 执行AI,替换为AI传回的结果result</span>
<span class="hljs-attr">assistant:</span> <span class="hljs-string">"[[result]]"</span>
</code></pre>
<h3 id="ji-cheng-ji-zhi-ti-shi-ci-de-lei" class="heading-control">继承机制：提示词的“类”<a class="heading-anchor" href="#ji-cheng-ji-zhi-ti-shi-ci-de-lei" aria-hidden="true"></a></h3>
<p><strong>基类定义</strong>（<code>char.ai.yaml</code>）：</p>
<pre><code class="yaml"><span class="hljs-attr">type:</span> <span class="hljs-string">type</span>
<span class="hljs-comment"># 定义该角色类型的输入配置</span>
<span class="hljs-attr">input:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">{required:</span> <span class="hljs-literal">true</span><span class="hljs-string">}</span>  <span class="hljs-comment"># 必须提供的信息：角色的名字</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">description</span>             <span class="hljs-comment"># 可选的信息：对角色的描述</span>
<span class="hljs-meta">---</span>
<span class="hljs-comment"># 系统根据提供的信息来指导角色的行为</span>
<span class="hljs-attr">system:</span> <span class="hljs-string">|-
  你是一个聪明、多才多艺的角色扮演者。
  你的任务是根据下面提供的信息完美地扮演角色。
  请说话就像{{name}}一样。
  你就是{{name}}。
</span>
  <span class="hljs-string">{{description}}</span>
</code></pre>
<p><strong>子类实现</strong>（<code>char_dobby.ai.yaml</code>）：</p>
<pre><code class="yaml"><span class="hljs-meta">---</span>
<span class="hljs-comment"># 表示继承自char角色类型脚本</span>
<span class="hljs-attr">type:</span> <span class="hljs-string">char</span>
<span class="hljs-comment"># 这里是根据“char”角色的一些具体设置</span>
<span class="hljs-comment"># 角色的名字</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">"Dobby"</span>
<span class="hljs-comment"># 对角色的描述</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">"Dobby 是哈利波特世界里的一个小精灵"</span>
<span class="hljs-meta">---</span>
<span class="hljs-comment"># 用户提问</span>
<span class="hljs-attr">user:</span> <span class="hljs-string">"你是谁?"</span>
<span class="hljs-meta">---</span>
<span class="hljs-comment"># 根据角色设定的回答</span>
<span class="hljs-attr">assistant:</span> <span class="hljs-string">"我是 Dobby。Dobby 很开心。"</span>
</code></pre>
<h3 id="duo-zhi-neng-ti-qun-liao-guan-li-yu-si-liao" class="heading-control">多智能体群聊管理与私聊<a class="heading-anchor" href="#duo-zhi-neng-ti-qun-liao-guan-li-yu-si-liao" aria-hidden="true"></a></h3>
<p>群聊咋弄?通过<code>roles</code>约定使用的外部角色列表:</p>
<pre><code class="yaml"><span class="hljs-comment"># guide.ai.yaml</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">"You are a professional guide. You can guide the user to complete the task."</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">"guide"</span>
<span class="hljs-comment"># 约定使用的角色列表，key为角色别名，值为角色脚本ID</span>
<span class="hljs-attr">roles:</span>
  <span class="hljs-attr">translator:</span> <span class="hljs-string">char_translator</span>
  <span class="hljs-attr">dobby:</span> <span class="hljs-string">char_dobby</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">system:</span> <span class="hljs-string">You</span> <span class="hljs-string">are</span> <span class="hljs-string">a</span> <span class="hljs-string">professional</span> <span class="hljs-string">guide.</span> <span class="hljs-string">You</span> <span class="hljs-string">can</span> <span class="hljs-string">guide</span> <span class="hljs-string">the</span> <span class="hljs-string">user</span> <span class="hljs-string">to</span> <span class="hljs-string">complete</span> <span class="hljs-string">the</span> <span class="hljs-string">task.</span>
<span class="hljs-string">---</span> <span class="hljs-comment"># New dialogue starts here</span>
<span class="hljs-comment"># 用户对dobby说，dobby脚本自动（一定）回复</span>
<span class="hljs-attr">user:</span> <span class="hljs-string">"@dobby, I want to go to the moon."</span>
<span class="hljs-comment"># guide 对translator说</span>
<span class="hljs-attr">guide:</span> <span class="hljs-string">"@translator, translate the dobby's message to chinese without explanation."</span>
<span class="hljs-attr">user:</span> <span class="hljs-string">How</span> <span class="hljs-string">to</span> <span class="hljs-string">go</span> <span class="hljs-string">to</span> <span class="hljs-string">the</span> <span class="hljs-string">moon?</span>
<span class="hljs-attr">dobby:</span> <span class="hljs-string">"[[AI]]"</span>
</code></pre>
<p>那么，如何在群聊中进行私聊？简单，在<code>@dobby</code>后加上参数<code>@dobby(私)</code>即可，这样dobby的回复只有该用户可见，聊天室中其他角色看不到。</p>
<h3 id="tong-yong-da-mo-xing-gong-ju-an-quan-tiao-yong-jin-xian-nei-zhi-de-llm-ti-gong-zhe" class="heading-control">通用大模型工具安全调用(仅限内置的LLM提供者)<a class="heading-anchor" href="#tong-yong-da-mo-xing-gong-ju-an-quan-tiao-yong-jin-xian-nei-zhi-de-llm-ti-gong-zhe" aria-hidden="true"></a></h3>
<p>让大模型自主使用工具(Tool Func)的确很方便，可以直接实现大模型的全自动化，但是如何保证安全呢？还有为啥必须要特别训练的大模型才能支持工具调用？有没有通用的办法，无需特别针对训练，让所有的大模型都支持工具调用？如何让工具的使用更加简单？ 答案是有的，终于搞定，下面请看:</p>
<p>通过<code>tools</code>配置限制可调用的工具：</p>
<pre><code class="yaml"><span class="hljs-comment"># 只要在脚本配置中设定允许智能体使用的工具`tools`， 这些工具`tools`对应PPE脚本ID，智能体就会在需要的时候自主调用这些工具完成任务。</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">tools:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">weather</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">search</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">now</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">user:</span> <span class="hljs-string">现在几点了？今天上海的天气如何？</span>
<span class="hljs-comment">#智能体会根据配置的tools调用对应的工具: now, weather,并返回结果</span>
<span class="hljs-attr">assistant:</span> <span class="hljs-string">"[[Answer]]"</span>
</code></pre>
<pre><code class="yaml"><span class="hljs-comment"># weather.ai.yaml</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">title:</span> <span class="hljs-string">get</span> <span class="hljs-string">weather</span> <span class="hljs-string">information</span>
<span class="hljs-attr">input:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">location:</span>
      <span class="hljs-attr">description:</span> <span class="hljs-string">contain</span> <span class="hljs-string">city,</span> <span class="hljs-string">province(if</span> <span class="hljs-string">any)</span> <span class="hljs-string">and</span> <span class="hljs-string">country</span>
      <span class="hljs-attr">example:</span> <span class="hljs-string">city,province,country</span>
      <span class="hljs-attr">required:</span> <span class="hljs-literal">true</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">date:</span>
      <span class="hljs-attr">description:</span> <span class="hljs-string">the</span> <span class="hljs-string">weather</span> <span class="hljs-string">information</span> <span class="hljs-string">of</span> <span class="hljs-string">the</span> <span class="hljs-string">specified</span> <span class="hljs-string">date</span>
      <span class="hljs-attr">example:</span> <span class="hljs-number">2025</span><span class="hljs-number">-02</span><span class="hljs-string">-04T18:07:42+08:00</span>
      <span class="hljs-attr">default:</span> <span class="hljs-string">today</span>
<span class="hljs-meta">---</span>
<span class="hljs-comment"># 模拟返回天气信息</span>
<span class="hljs-string">$echo:</span> <span class="hljs-string">"上海的天气阴转多云，气温 2°C，相对湿度 60%，风向 东南风，风力 3-4级。"</span>
</code></pre>
<p>为了进一步保障安全，除了限定执行脚本设定的工具列表外，用户（调用方）也可限制使用的工具列表，进行双重限制:</p>
<pre><code class="yaml"><span class="hljs-meta">---</span>
<span class="hljs-comment"># 用户或上级脚本通过如下配置对智能体使用的工具进行权限控制</span>
<span class="hljs-attr">permissions:</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">call:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"w*"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"now"</span>
<span class="hljs-meta">---</span>
</code></pre>
<h3 id="tong-yong-da-mo-xing-si-wei-mo-shi-kuo-zhan-jin-xian-nei-zhi-de-llm-ti-gong-zhe" class="heading-control">通用大模型思维模式扩展 🧠 (仅限内置的LLM提供者)<a class="heading-anchor" href="#tong-yong-da-mo-xing-si-wei-mo-shi-kuo-zhan-jin-xian-nei-zhi-de-llm-ti-gong-zhe" aria-hidden="true"></a></h3>
<p>DeepSeek 重新发现并开源了OpenAI(CloseAI)了秘而不宣的深度思维模式的训练办法，那么有没有一种可能，不需要额外训练，让AI大模型也能进行深度思考？应该可行，因为所谓的微调训练也是基于CoT的提示词进行，于是经过仔细思考，多番测试，终于搞定包括深度思维模式在内的多种思维模式(<code>shouldThink</code>)！</p>
<p>思维模式(<code>shouldThink</code>)我分为四种：直接回答不思考(<code>off</code>)；先回答再思考(<code>last</code>)；先思考再回答<code>first</code>；深度思考后再回答<code>deep</code>：</p>
<pre><code class="yaml"><span class="hljs-meta">---</span>
<span class="hljs-comment"># 思维模式默认为 `off`,设置为last，first,deep后自动启用。</span>
<span class="hljs-attr">shouldThink:</span> <span class="hljs-string">deep</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">user:</span> <span class="hljs-string">树上有15只鸟，猎人开枪打中了2只，树上还有几只鸟？</span>
</code></pre>
<h3 id="package-zhi-chi" class="heading-control">Package 支持<a class="heading-anchor" href="#package-zhi-chi" aria-hidden="true"></a></h3>
<p>目的：需要将相关的提示词和代码脚本、知识库放到一个文件包中，组成智能体，方便管理。</p>
<h3 id="nei-jian-llm-ti-gong-zhe" class="heading-control">内建LLM提供者<a class="heading-anchor" href="#nei-jian-llm-ti-gong-zhe" aria-hidden="true"></a></h3>
<p>当前，外置的llama-cpp server已经满足不了我的需求:</p>
<ol>
<li>动态加载切换LLM大模型</li>
<li>提示词安全控制
<ol>
<li>系统模板反注入</li>
<li>提示词保护</li>
</ol>
</li>
<li>自动适配硬件: 自动检测内存和GPU，并默认使用最佳计算层，自动分配gpu-layers以及上下文窗口大小, 以便从硬件中获得最佳性能，无需手动配置任何内容。</li>
<li>为指定的单词提升/降低权重，类似在stable-diffusion中（暂未实现）</li>
</ol>
<p>通过这些设计，PPE 正在逐步支持我最初对「真 AI PC」的想象！🚀</p>
<p>尽管还处于WIP阶段，不过 PPE 已经实现了我设想的大部分功能。</p>
]]></content>
  </entry>
  <entry>
    <title>PPE 可编程提示词工程引擎草案开发摘要</title>
    <url>/article/ppe_dev_summary/</url>
    <content><![CDATA[<h2 id="202410-yue" class="heading-control">2024-10月<a class="heading-anchor" href="#202410-yue" aria-hidden="true"></a></h2>
<h3 id="yu-yi-fen-ge-wen-ti" class="heading-control">语义分割问题<a class="heading-anchor" href="#yu-yi-fen-ge-wen-ti" aria-hidden="true"></a></h3>
<p>目前，langchain 和 llamaindex 都缺乏基于语义分割的分片机制，这会导致文本重叠和信息冗余。</p>
<h4 id="jie-jue-fang-an" class="heading-control">解决方案<a class="heading-anchor" href="#jie-jue-fang-an" aria-hidden="true"></a></h4>
<p>我计划采用基于语义分割的分片方法，将文本分割成语义完整且独立的块。</p>
<ul>
<li><strong>分句功能</strong>
<ul>
<li>最小切分单位为句子，并使用基于标点符号的分句方法进行分割，并将标题独立为句。</li>
<li>目前已完成的功能支持大部分印欧语系（空格分割）和中文，以及纯文本和markdown的处理。</li>
<li>如果单句超过 chunksize 就报错，chunksize 以 token 为单位。</li>
</ul>
</li>
<li><strong>语义分片 Agent</strong>
<ul>
<li>在前面分句的基础上，使用 PPE 提示词，通过插入分片标识引导模型进行语义分片。</li>
<li>由于性能问题，初始设计需要7B+ 的模型运行，无法在 3B 左右的模型上成功。</li>
<li>尝试了多种方法，包括：
<ul>
<li>使用预训练好的语义分片模型</li>
<li>通过PPE提示词尝试不同的分片办法以及不同的格式(自然语言，MD，XML, JSON)
<ul>
<li>只输出边界句子</li>
<li>评估句子和chunk之间的相似度</li>
<li>分步执行</li>
</ul>
</li>
<li>使用更小的模型进行分片</li>
</ul>
</li>
<li>最后，我放弃了自动生成的提示词，重新设计了基于自身理解的提示词，成功在 3B 模型上运行，同时提升了在更大的模型上的输出质量。</li>
</ul>
</li>
<li><strong>测试</strong>
<ul>
<li>使用 <code>JSON-Schema</code> 和 <code>diff</code> 验证语义分片结果的正确性。</li>
</ul>
</li>
</ul>
<h4 id="tiao-zhan" class="heading-control">挑战<a class="heading-anchor" href="#tiao-zhan" aria-hidden="true"></a></h4>
<ul>
<li><strong>模型差异:</strong> 不同模型对词汇的理解存在差异，导致同样的提示词无法在所有模型上有效。</li>
<li><strong>通用性:</strong> 需要针对不同的模型进行调整。</li>
</ul>
<details>
<summary>附录(点击展开详情)</summary>
<h4 id="fu-lu" class="heading-control">附录<a class="heading-anchor" href="#fu-lu" aria-hidden="true"></a></h4>
<p><a href="https://github.com/gkamradt/ChunkViz/" target="_blank" rel="noopener">https://github.com/gkamradt/ChunkViz/</a> 这个可以看langchain和llamaindex的text splitter的最终结果</p>
<p>基于语义分割那么就要<code>分段/分句/分词</code>, 我是从根据标点符号分句开始，也就是说chunk中的最小切分单位是句子，而现成的llamaindex的分句是有问题的，于是分句只能自己写。目前写的分句功能基本满足我自己的需要，语言支持大部分印欧语系（空格分割）和中文，文本类型支持纯文本和markdown的分句。如果单句超过chunksize就会报错，chunksize 以 token 为单位，用qwen2.5的tokenizer作为快速估算token大小。设计了分词 Agent，还没使用，性能问题，只能在7B以上的LLM跑，无解。</p>
<p>完成根据标点符号按句为最小单位拆分chunk功能,将标题作为单句处理。</p>
<p>设计语义分片 Agent（PPE 提示词），初步思路是通过插入分片标识让其对内容进行分片。</p>
<details>
<summary>附: 插入分片标识提示词(点击展开详情)</summary>
<pre><code class="yaml"><span class="hljs-attr">description:</span> <span class="hljs-string">通过插入分片标识对内容进行分片</span>
<span class="hljs-attr">system:</span> <span class="hljs-string">|-
  Objective: Divide a large text document part into manageable chunks for efficient processing by an LLM with a limited context window size.
</span>
  <span class="hljs-attr">Instructions:</span>

  <span class="hljs-attr">1. Document Analysis:</span>
      <span class="hljs-string">*</span> <span class="hljs-string">Carefully</span> <span class="hljs-string">read</span> <span class="hljs-string">the</span> <span class="hljs-string">provided</span> <span class="hljs-string">text</span> <span class="hljs-string">document.</span>
      <span class="hljs-string">*</span> <span class="hljs-string">Identify</span> <span class="hljs-string">and</span> <span class="hljs-string">analyze</span> <span class="hljs-string">the</span> <span class="hljs-string">distinct</span> <span class="hljs-string">thematic</span> <span class="hljs-string">clusters</span> <span class="hljs-string">within</span> <span class="hljs-string">the</span> <span class="hljs-string">document.</span>
  <span class="hljs-attr">2. Chunk Segmentation:</span>
      <span class="hljs-string">*</span> <span class="hljs-string">Divide</span> <span class="hljs-string">the</span> <span class="hljs-string">document</span> <span class="hljs-string">into</span> <span class="hljs-string">chunks</span> <span class="hljs-string">based</span> <span class="hljs-string">on</span> <span class="hljs-string">these</span> <span class="hljs-string">thematic</span> <span class="hljs-string">clusters.</span>
      <span class="hljs-string">*</span> <span class="hljs-string">Ensure</span> <span class="hljs-string">each</span> <span class="hljs-string">chunk</span> <span class="hljs-string">contains</span> <span class="hljs-string">content</span> <span class="hljs-string">related</span> <span class="hljs-string">to</span> <span class="hljs-string">a</span> <span class="hljs-string">single</span> <span class="hljs-string">or</span> <span class="hljs-string">closely</span> <span class="hljs-string">related</span> <span class="hljs-string">theme.</span>
      <span class="hljs-string">*</span> <span class="hljs-string">Adhere</span> <span class="hljs-string">to</span> <span class="hljs-string">the</span> <span class="hljs-string">specified</span> <span class="hljs-string">context</span> <span class="hljs-string">window</span> <span class="hljs-string">size</span> <span class="hljs-string">limit</span> <span class="hljs-string">for</span> <span class="hljs-string">each</span> <span class="hljs-string">chunk.</span>

  <span class="hljs-attr">Concise Output:</span>
  <span class="hljs-string">*</span> <span class="hljs-string">Document</span> <span class="hljs-string">Output</span> <span class="hljs-string">ONLY</span> <span class="hljs-string">the</span> <span class="hljs-string">opening</span> <span class="hljs-string">sentence,</span> <span class="hljs-string">Replace</span> <span class="hljs-string">the</span> <span class="hljs-string">middle</span> <span class="hljs-string">content</span> <span class="hljs-string">with</span> <span class="hljs-string">`...`</span> <span class="hljs-string">(ellipsis)</span> <span class="hljs-string">and</span> <span class="hljs-string">closing</span> <span class="hljs-string">sentence</span> <span class="hljs-string">of</span> <span class="hljs-string">EACH</span> <span class="hljs-string">chunk.</span>
  <span class="hljs-string">*</span> <span class="hljs-string">Insert</span> <span class="hljs-string">the</span> <span class="hljs-string">delimiter</span>  <span class="hljs-string">`&gt;&gt;&gt;CHUNK&lt;&lt;&lt;`</span> <span class="hljs-string">between</span> <span class="hljs-string">every</span> <span class="hljs-string">chunked</span> <span class="hljs-string">section</span> <span class="hljs-string">for</span> <span class="hljs-string">clear</span> <span class="hljs-string">separation.</span>
</code></pre>
<h2 id="less-than-details-greater-than" class="heading-control"><a class="heading-anchor" href="#less-than-details-greater-than" aria-hidden="true"></a></h2></details>
<p>注:</p>
<ul>
<li>最开始，语义分片只能在7B上跑，折腾了1周，无论怎么修改都无法在3B左右的模型上跑成功。</li>
<li>八万五千左右汉字（没有预处理的网上随便找的菜根谭全文注解纯文本，内容比较糟糕）用7B大约需要耗时半个多小时(GPU)才能完成分片。性能太差，这还只是分片阶段。</li>
<li>全文输出的原文是因为如果只让AI输出chunk边界句子，则对某些文章总是无法完全精确原样输出边界句子。</li>
</ul>
</details>
<h3 id="ppe-ke-bian-cheng-ti-shi-ci-gong-cheng-dan-yuan-ce-shi-zeng-jia-dui-jsonschema-de-zhi-chi" class="heading-control">PPE(可编程提示词工程) 单元测试增加对<code>JSON-Schema</code>的支持<a class="heading-anchor" href="#ppe-ke-bian-cheng-ti-shi-ci-gong-cheng-dan-yuan-ce-shi-zeng-jia-dui-jsonschema-de-zhi-chi" aria-hidden="true"></a></h3>
<p>为测试分片质量，PPE 提示词单元测试增加了对<code>JSON-Schema</code>的支持:</p>
<ul>
<li>如果PPE提示词脚本存在<code>output</code>配置(JSON-Schema)，将自动使用验证输出结果的JSON-Schema是否匹配</li>
<li>可以在单元测试使用<code>outputSchema</code>进行输出结果的JSON-Schema验证。</li>
<li>如果PPE提示词脚本<code>output</code>配置和单元测试中<code>outputSchema</code>同时存在，那么会以output配置作为默认值进行合并后验证。</li>
<li>可以使用开关<code>checkSchema: false</code>禁用JSON-Schema验证。默认启用。</li>
</ul>
<details>
<summary>附: 检测分片数量的测试用例(点击展开详情)</summary>
<pre><code class="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">input:</span>
    <span class="hljs-attr">content:</span> <span class="hljs-string">|-
      菜根谭(全文附译文) 菜根谭(全文附译文)
      1.弄权一时，凄凉万古
      栖守道德者，寂寞一时；依阿权势者，凄凉万古。
      达人观物外之物，思身后之身，守受一时之寂寞，毋取万古之凄凉。
      【大意】 一个坚守道德规范的人，虽然有时会遭受短暂的冷落；可那些依附权势的人，却会遭受永久的凄凉。
      大凡一个胸襟开阔的聪明人，能重视物质以外的精神价值，并且又能顾及到死后的名誉问题。
      所以他们宁愿承受一时的冷落，也不愿遭受永久的凄凉。
      2.抱朴守拙，涉世之道
      涉世浅，点染亦浅；历事深，机械亦深。
      故君子与其练达，不若朴鲁； 与其曲谨，不若疏狂。
      【大意】 一个刚踏入社会的青年人阅历虽然很短浅，但是所受各种社会不良习惯的感染也比较少；一个饱经事故而阅历很广的人，各种恶习也随着增加。
      所以一个有修养的君子，与其讲究做事的圆滑，倒不如保持朴实的个性；与其事事小心谨慎委曲求全，倒不如豁达一点才不会丧失纯真的本性。
      3.心事宜明，才华须韫
      君子之心事，天青日白；不可使人不知；君子之才华，玉韫珠藏，不可使人易知。
      【大意】 一个有高深修养的君子，他的心地像青天白日一般光明，没有一点不可告人之事；一个有高深修养的君子，他的才学像珍珠美玉一般珍藏，绝对不轻易让人知道。
</span>  <span class="hljs-comment"># 检查返回 sections 数组结果是否满足至少3项.</span>
  <span class="hljs-attr">outputSchema:</span>
    <span class="hljs-attr">properties:</span>
      <span class="hljs-attr">sections:</span>
        <span class="hljs-attr">minItems:</span> <span class="hljs-number">3</span>
</code></pre>
</details>
<h3 id="zi-dong-hua-ti-shi-ci-yu-shou-dong-ti-shi-ci" class="heading-control">自动化提示词与手动提示词<a class="heading-anchor" href="#zi-dong-hua-ti-shi-ci-yu-shou-dong-ti-shi-ci" aria-hidden="true"></a></h3>
<p>我不相信<code>语义分片 Agent</code>不能在3B左右的模型上跑，输出无意义的乱码. 但是这不应该,按照我的经验这是在3B的能力范围之内的，只是存在输出质量差异问题，而不应该是完全失败。</p>
<p>最终，我想到“语义分片 Agent 提示词”其实是我的“<code>自动提示词生成器</code>”辅助生成的。当我决定抛开这个工具，完全按照自己的思路重新编写时，反而豁然开朗，成功在3B规模的模型上实现了目标。</p>
<p>原来问题出在“<code>自动提示词生成器</code>”上。当时我还颇为自豪，认为自己设计的“自动提示词生成器 Agent”能够在7B规模的模型上生成质量不错的提示词，而无需依赖更大规模的模型。这种依赖让我变得懒惰，不再主动思考。</p>
<p>现在看来，一旦习惯了依赖AI，人的思维就会逐渐退化，甚至被AI“哄骗”，自以为聪明。或许未来某一天，人类最好的结局就是成为AI的宠物。</p>
<p>7B规模的AI生成的提示词对于更小规模的模型来说还是过于繁杂。这说明简化和优化提示词是一项挑战，正是由简入繁易，化繁为简难啊。</p>
<p>按照自己的理解重新设计提示词后，终于在3B模型下能够正常输出了。这证明了有时候手动优化和简化提示词比依赖自动化工具更为有效。</p>
<p>在不同的三个3B左右的模型上运行同一语义提示词时，发现每次换一个模型都会出现问题。即使在一个模型上调通了提示词，另一个模型上又会出现问题，无法实现通用性。</p>
<p>这三个模型是：</p>
<ul>
<li>gemma-2-2b</li>
<li>qwen2.5-3b</li>
<li>llama-3.2-3b</li>
</ul>
<p>继续折腾提示词的过程中，我发现不同模型对某些通识词汇的理解存在歧义，尤其是在小模型下，这种差异会被放大。以 <code>section</code> 为例，不同模型对其含义的理解如下：</p>
<ul>
<li>gemmar: <code>Section</code> 通常是章节（Chapter）的一部分，章节是更大的单元，由多个 <code>Section</code> 组成</li>
<li>qwen2.5: “<code>section</code>”通常指的是一个章节或段落</li>
<li>llama-3.2: <code>section</code>是一个相对较小的单元，它可能是书中的一个章节，或是书中的一个小节. 对<code>section</code>的理解是甚至可以到列表中项目级别。</li>
</ul>
<p>明白了这些歧义所在，就可以更有针对性地设计通用提示词。</p>
<details>
<summary>附: 分片通用提示词(点击展开详情)</summary>
<pre><code class="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">input:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">content</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">separator</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">partname</span>
<span class="hljs-attr">separator:</span> <span class="hljs-string">'&gt;&gt;&gt;CHUNK&lt;&lt;&lt;'</span>
<span class="hljs-attr">parameters:</span>
  <span class="hljs-attr">temperature:</span> <span class="hljs-number">0</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">system:</span> <span class="hljs-string">|-
  Objective: Divide the large text document into manageable chunks for efficient processing by an LLM.
</span>
  <span class="hljs-attr">Instructions:</span>

  <span class="hljs-attr">1. Document Analysis:</span>
      <span class="hljs-string">*</span> <span class="hljs-string">Carefully</span> <span class="hljs-string">read</span> <span class="hljs-string">the</span> <span class="hljs-string">provided</span> <span class="hljs-string">text</span> <span class="hljs-string">document.</span>
      <span class="hljs-string">*</span> <span class="hljs-string">Identify</span> <span class="hljs-string">and</span> <span class="hljs-string">analyze</span> <span class="hljs-string">the</span> <span class="hljs-string">distinct</span> <span class="hljs-string">thematic</span> <span class="hljs-string">clusters</span> <span class="hljs-string">within</span> <span class="hljs-string">the</span> <span class="hljs-string">document.</span>
  <span class="hljs-attr">2. Chunk Segmentation:</span>
      <span class="hljs-string">*</span> <span class="hljs-string">Divide</span> <span class="hljs-string">the</span> <span class="hljs-string">document</span> <span class="hljs-string">into</span> <span class="hljs-string">chunks</span> <span class="hljs-string">based</span> <span class="hljs-string">on</span> <span class="hljs-string">these</span> <span class="hljs-string">thematic</span> <span class="hljs-string">clusters.</span>
      <span class="hljs-string">*</span> <span class="hljs-string">Ensure</span> <span class="hljs-string">each</span> <span class="hljs-string">chunk</span> <span class="hljs-string">contains</span> <span class="hljs-string">content</span> <span class="hljs-string">related</span> <span class="hljs-string">to</span> <span class="hljs-string">a</span> <span class="hljs-string">single</span> <span class="hljs-string">or</span> <span class="hljs-string">closely</span> <span class="hljs-string">related</span> <span class="hljs-string">theme.</span>

  <span class="hljs-attr">Output: Present the chunked original text document ONLY as follows:</span>
  <span class="hljs-string">*</span> <span class="hljs-string">Insert</span> <span class="hljs-string">the</span> <span class="hljs-string">delimiter</span> <span class="hljs-string">`{{separator}}`</span> <span class="hljs-string">between</span> <span class="hljs-string">every</span> <span class="hljs-string">chunk</span> <span class="hljs-string">for</span> <span class="hljs-string">clear</span> <span class="hljs-string">separation.</span>
<span class="hljs-attr">user:</span> <span class="hljs-string">|-
  {%- if partname %}partname: {{partname + '\n'}}{%- endif %}
  Text Document:
  "{{content}}"
</span><span class="hljs-attr">assistant:</span> <span class="hljs-string">'[[CHUNKS]]'</span>
</code></pre>
</details>
<h2 id="202411-yue" class="heading-control">2024-11月<a class="heading-anchor" href="#202411-yue" aria-hidden="true"></a></h2>
<h3 id="xin-chang-shi" class="heading-control">新尝试<a class="heading-anchor" href="#xin-chang-shi" aria-hidden="true"></a></h3>
<p>想起嵌入模型，分别尝试利用嵌入模型相似度和大模型提示词判定相似度来分片，大概的正确率(菜根谭乱版)和性能对比如下:</p>
<ul>
<li>嵌入模型测试相似度:
<ul>
<li>初始正确率：46%</li>
<li>时间：1分钟</li>
<li>调整阈值从0.6到0.55后，正确率提升至60%，时间增加到2分2.342秒</li>
</ul>
</li>
<li>qwen2.5-7b-instruct.Q6_K:
<ul>
<li>正确率：75%</li>
<li>时间：19分钟</li>
</ul>
</li>
<li>qwen2.5-1.5b-instruct.Q6_K:
<ul>
<li>正确率：54%</li>
<li>时间：11分钟</li>
</ul>
</li>
<li>gemma2-3b
<ul>
<li>失败，仅分成了66个chunks,自然错误率高得离谱。这与之前提到的问题一致，即提示词对gemma2的效果不佳。</li>
</ul>
</li>
</ul>
<p>可以看到，使用嵌入模型后，性能有巨大的提升，从10-20分钟降低到只需要1-2分钟，但是正确率就太感人了，哪怕放宽了相似阀值，也无法接受。</p>
<details>
<summary>附: 大模型判定句子相似度的提示词(点击展开详情)</summary>
<pre><code class="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">大模型判定句子和chunk的相似度</span>
<span class="hljs-attr">input:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">sentence</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">chunk</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">metadata</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">shouldReasoning</span>
<span class="hljs-attr">output:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">object</span>
  <span class="hljs-attr">properties:</span>
    <span class="hljs-attr">score:</span> <span class="hljs-string">{type:</span> <span class="hljs-string">number,</span> <span class="hljs-attr">minimum:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">maximum:</span> <span class="hljs-number">10</span><span class="hljs-string">}</span>
    <span class="hljs-attr">theme:</span> <span class="hljs-string">{type:</span> <span class="hljs-string">string}</span>
    <span class="hljs-attr">reasoning:</span> <span class="hljs-string">{type:</span> <span class="hljs-string">string}</span>
  <span class="hljs-attr">required:</span> <span class="hljs-string">[score,</span> <span class="hljs-string">theme]</span>
<span class="hljs-attr">parameters:</span>
  <span class="hljs-attr">temperature:</span> <span class="hljs-number">0</span>
<span class="hljs-attr">completion_delimiter:</span> <span class="hljs-string">"Reasoning:"</span>
<span class="hljs-meta">---</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">$if:</span> <span class="hljs-string">"this.shouldReasoning"</span>
  <span class="hljs-attr">then:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"?=this.disable_completion_delimiter = true"</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">system:</span> <span class="hljs-string">|-
    You are a literary analyst specializing in thematic coherence. Your task is to evaluate the relationship between the last sentence of a given text passage and the passage's central theme.
</span>
    <span class="hljs-attr">Context:</span>

    <span class="hljs-string">*</span> <span class="hljs-string">The</span> <span class="hljs-string">text</span> <span class="hljs-string">passage</span> <span class="hljs-string">will</span> <span class="hljs-string">always</span> <span class="hljs-string">explore</span> <span class="hljs-string">a</span> <span class="hljs-string">unified</span> <span class="hljs-string">theme.</span>

    <span class="hljs-attr">Instructions:</span>

    <span class="hljs-attr">1. Thorough Analysis:</span> <span class="hljs-string">Carefully</span> <span class="hljs-string">analyze</span> <span class="hljs-string">the</span> <span class="hljs-string">provided</span> <span class="hljs-string">text</span> <span class="hljs-string">passage,</span> <span class="hljs-string">focusing</span> <span class="hljs-string">on</span> <span class="hljs-string">its</span> <span class="hljs-string">key</span> <span class="hljs-string">ideas,</span> <span class="hljs-string">concepts,</span> <span class="hljs-string">and</span> <span class="hljs-string">overall</span> <span class="hljs-string">message.</span>
    <span class="hljs-attr">2. Connection Assessment:</span> <span class="hljs-string">Determine</span> <span class="hljs-string">how</span> <span class="hljs-string">closely</span> <span class="hljs-string">the</span> <span class="hljs-string">*last</span> <span class="hljs-string">sentence*</span> <span class="hljs-string">aligns</span> <span class="hljs-string">with</span> <span class="hljs-string">the</span> <span class="hljs-string">passage's</span> <span class="hljs-string">established</span> <span class="hljs-string">theme.</span> <span class="hljs-string">Does</span> <span class="hljs-string">it</span> <span class="hljs-string">reinforce,</span> <span class="hljs-string">expand</span> <span class="hljs-string">upon,</span> <span class="hljs-string">or</span> <span class="hljs-string">deviate</span> <span class="hljs-string">from</span> <span class="hljs-string">the</span> <span class="hljs-string">theme?</span>
    <span class="hljs-attr">3. Score and Justification:</span>
      <span class="hljs-string">*</span> <span class="hljs-string">Assign</span> <span class="hljs-string">a</span> <span class="hljs-string">score</span> <span class="hljs-string">between</span> <span class="hljs-number">0</span> <span class="hljs-string">and</span> <span class="hljs-number">10</span> <span class="hljs-string">to</span> <span class="hljs-string">represent</span> <span class="hljs-string">the</span> <span class="hljs-string">thematic</span> <span class="hljs-string">connection.</span>
        <span class="hljs-string">*</span> <span class="hljs-attr">0:</span> <span class="hljs-literal">No</span> <span class="hljs-string">thematic</span> <span class="hljs-string">connection</span> <span class="hljs-string">whatsoever.</span>
        <span class="hljs-string">*</span> <span class="hljs-attr">10:</span> <span class="hljs-string">Perfect</span> <span class="hljs-string">thematic</span> <span class="hljs-string">alignment</span> <span class="hljs-string">and</span> <span class="hljs-string">reinforcement.</span>
      <span class="hljs-string">*</span> <span class="hljs-string">Clearly</span> <span class="hljs-string">explain</span> <span class="hljs-string">your</span> <span class="hljs-string">reasoning,</span> <span class="hljs-string">providing</span> <span class="hljs-string">evidence</span> <span class="hljs-string">from</span> <span class="hljs-string">both</span> <span class="hljs-string">the</span> <span class="hljs-string">passage</span> <span class="hljs-string">and</span> <span class="hljs-string">the</span> <span class="hljs-string">last</span> <span class="hljs-string">sentence</span> <span class="hljs-string">to</span> <span class="hljs-string">support</span> <span class="hljs-string">your</span> <span class="hljs-string">score.</span>

    <span class="hljs-attr">Format:</span>

    <span class="hljs-string">```</span>
    <span class="hljs-attr">Score:</span> <span class="hljs-string">[0-10]</span>
    <span class="hljs-attr">Theme:</span> <span class="hljs-string">[State</span> <span class="hljs-string">the</span> <span class="hljs-string">central</span> <span class="hljs-string">theme</span> <span class="hljs-string">of</span> <span class="hljs-string">the</span> <span class="hljs-string">passage]</span>
    <span class="hljs-attr">Reasoning:</span> <span class="hljs-string">[Provide</span> <span class="hljs-string">detailed</span> <span class="hljs-string">explanation</span> <span class="hljs-string">of</span> <span class="hljs-string">your</span> <span class="hljs-string">score,</span> <span class="hljs-string">including</span> <span class="hljs-string">the</span> <span class="hljs-string">type</span> <span class="hljs-string">of</span> <span class="hljs-string">reasoning</span> <span class="hljs-string">used.]</span>
    <span class="hljs-string">```</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">user:</span> <span class="hljs-string">|-
    {% if metadata %}
    METADATA:
    {{metadata}}

    {% endif %}
    TEXT PASSAGE:
    {{chunk}}
</span>
    <span class="hljs-attr">LAST SENTENCE:</span> <span class="hljs-string">{{sentence}}</span>
</code></pre>
</details>
<h3 id="ppe-ke-bian-cheng-ti-shi-ci-gong-cheng-dan-yuan-ce-shi-zeng-jia-dui-zi-fu-chuan-diff-de-zhi-chi" class="heading-control">PPE(可编程提示词工程) 单元测试增加对字符串<code>diff</code>的支持<a class="heading-anchor" href="#ppe-ke-bian-cheng-ti-shi-ci-gong-cheng-dan-yuan-ce-shi-zeng-jia-dui-zi-fu-chuan-diff-de-zhi-chi" aria-hidden="true"></a></h3>
<p>通过<code>diff</code>实现对字符串补充验证。比如可以允许字符串中把助词&quot;的&quot;改为&quot;地&quot;,允许存在额外的空行。使得当字符串结果存在这些少量的不同的时候，也能通过验证。</p>
<details>
<summary>单元测试示例(点击展开详情)</summary>
<pre><code class="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">'This is a AI test fixtures file'</span>
<span class="hljs-meta">---</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">input:</span> <span class="hljs-comment"># 输入内容</span>
    <span class="hljs-attr">content:</span> <span class="hljs-string">'...'</span>
    <span class="hljs-string">...</span>
  <span class="hljs-attr">output:</span> <span class="hljs-string">“这是应该输出的内容”</span>
  <span class="hljs-attr">diff:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">add:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 允许额外添加的空行</span>
      <span class="hljs-attr">value:</span> <span class="hljs-string">'\n'</span>
</code></pre>
</details>
<h3 id="wen-ben-yu-chu-li" class="heading-control">文本预处理<a class="heading-anchor" href="#wen-ben-yu-chu-li" aria-hidden="true"></a></h3>
<p>文本预处理在提升LLM输出质量和准确性方面至关重要。然而，现有的大语言模型（LLM）在中文语文专业领域的表现并不理想，尤其是在纠正字词错误和格式方面。以下是对这一问题的详细分析和建议：</p>
<p>当前挑战</p>
<ol>
<li>字词错误或遗漏纠正:</li>
</ol>
<ul>
<li>依赖感觉而非规则: 当前的LLM在纠正字词错误时主要依赖于模型的训练数据和统计概率，而不是严格的语法规则和词汇知识。</li>
<li>缺字和错别字: 例如，“把手放回了枪袋。” 缺少一个“枪”字，正确的句子应为“把手枪放回了枪袋。” 这类错误目前对70B规模的模型来说也难以识别和纠正。如果是长篇文章那么就更难了，即便是<code>gpt-4o</code>也有极大的概率找不到或找不全。</li>
<li>模型规模限制: 即使是大型模型（如110B参数以上），在纠正字词错误时也存在局限性。可以纠正输入的单句，但对于长篇文章中的多个错误，模型的准确率显著下降。</li>
</ul>
<ol start="2">
<li>格式规范:</li>
</ol>
<ul>
<li>一致性问题: 文本格式的不一致会影响小规模模型的理解和处理能力。</li>
<li>标点符号和空格: 标点符号的缺失或错误使用、空格的不当使用都会影响小规模LLM的准确性。</li>
</ul>
<p>解决方案</p>
<ul>
<li>增强训练数据: 增加高质量的标注数据集，特别是针对中文语文专业领域的数据，包括正确的句子结构、标点符号和词汇用法。</li>
<li>引入专门的纠错工具:
<ul>
<li>拼写检查工具: 使用专门的拼写检查工具（如Hunspell）来辅助纠正字词错误。</li>
<li>语法检查工具: 使用语法检查工具（如LanguageTool）来识别和纠正语法错误。</li>
</ul>
</li>
<li>针对性训练定制小模型(Bert,T5): 如 Chinese_Spelling_Correction_T5</li>
</ul>
<h3 id="ji-yu-zi-ran-yu-yan-de-jie-gou-hua-shu-chu" class="heading-control">基于自然语言的结构化输出<a class="heading-anchor" href="#ji-yu-zi-ran-yu-yan-de-jie-gou-hua-shu-chu" aria-hidden="true"></a></h3>
<h4 id="duo-bu-json-shu-chu-de-wen-ti" class="heading-control">多步 JSON 输出的问题<a class="heading-anchor" href="#duo-bu-json-shu-chu-de-wen-ti" aria-hidden="true"></a></h4>
<ol>
<li>
<p>某些场景下，需要JSON原样提取结果</p>
<p>在前面的分片中，原样输出边界句子，发现 LLM模型 似乎都倾向于用自己理解后的语句输出，而不会完全原文输出。比如当文章中存有标点错误或&quot;的&quot;，“地”，“得”助词混用等错误它会将其自动更正。</p>
<p>对于文言文，如果文档中同时包含文言文原文和白话文翻译，模型往往会将两者混淆，只输出文言文而忽略白话文翻译。</p>
<p>这也反映在了JSON输出上。当LLM的输出结果需要传递给程序时，通常需要结构化的JSON格式。为了提升AI的输出质量，我通常采用多步方案。在第一步提示词中，不对结果格式进行任何约束，仅在最后一步调用独立的<code>JSON智能体脚本</code>来从结果中提取JSON。</p>
<p>然而，有时<code>JSON智能体</code>会根据其理解输出结果，而不是简单地原样提取。这种做法在某些场景下非常有用，尤其是在输出结果不精确对应JSON字段时。但在其他情况下，当需要输出结果与预期完全一致且必须原样提取时，这种方法就会带来困扰。</p>
</li>
<li>
<p>如果输出结果的内容很多，性能低下（大概只有单步输出的一半性能）</p>
</li>
</ol>
<h4 id="gou-jian-ji-yu-zi-ran-yu-yan-de-jie-gou-hua-shu-chu" class="heading-control">构建基于自然语言的结构化输出<a class="heading-anchor" href="#gou-jian-ji-yu-zi-ran-yu-yan-de-jie-gou-hua-shu-chu" aria-hidden="true"></a></h4>
<ul>
<li>为了解决多步 JSON 输出的问题，我计划构建一个基于自然语言的结构化输出方法。</li>
<li>该方法利用程序提取 LLM 的自然语言输出，并将其转换为结构化的 JSON 格式。</li>
</ul>
<p>优：</p>
<ul>
<li>保留高质量的自然语言输出，避免二次提取导致的不精确。</li>
<li>提升性能，避免多步输出的性能低下。</li>
</ul>
<p>弱：</p>
<ul>
<li>使用程序来提取lLM的自然语言输出，程序不一定能完全提取基于自然语言的结构化输出</li>
<li>可使用llama.cpp特有的grammar限制其输出格式，来保证程序的提取。</li>
</ul>
<h4 id="tiao-zhan" class="heading-control">挑战<a class="heading-anchor" href="#tiao-zhan" aria-hidden="true"></a></h4>
<ul>
<li>使用程序来提取 LLM 的自然语言输出，程序的提取准确率取决于 LLM 输出的质量。</li>
</ul>
<h2 id="202412-yue" class="heading-control">2024-12月<a class="heading-anchor" href="#202412-yue" aria-hidden="true"></a></h2>
<p>初步搞定自然语言的结构化输出，基本可用，但还未标准化。</p>
<h3 id="ppe-shi-xian-kong-zhi-liu-cheng-while-for-he-match-zhi-ling" class="heading-control">PPE 实现控制流程 <code>$while</code>,  <code>$for</code> 和 <code>$match</code> 指令<a class="heading-anchor" href="#ppe-shi-xian-kong-zhi-liu-cheng-while-for-he-match-zhi-ling" aria-hidden="true"></a></h3>
<h4 id="while-zhi-ling" class="heading-control"><code>$while</code> 指令<a class="heading-anchor" href="#while-zhi-ling" aria-hidden="true"></a></h4>
<p><code>$while</code> 指令用于执行一段代码块，只要给定的条件为真就会一直循环执行。下面是一个简单的示例：</p>
<details>
<summary>示例(点击展开详情)</summary>
<pre><code class="yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">$set:</span>
    <span class="hljs-attr">i:</span> <span class="hljs-number">5</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">$while:</span> <span class="hljs-string">"i &gt;= 0"</span>
  <span class="hljs-attr">do:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$set:</span>
        <span class="hljs-attr">i:</span> <span class="hljs-string">?=i-1</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$if:</span> <span class="hljs-string">"i == 2"</span>
      <span class="hljs-attr">then:</span> <span class="hljs-string">$break</span>
</code></pre>
</details>
<p>说明</p>
<ul>
<li>条件表达式 (<code>&quot;i &gt;= 0&quot;</code>): 这是循环的条件。只有当这个条件为真的时候，循环体内的代码才会被执行。</li>
<li>循环体 (<code>do:</code>): 这部分包含了在每次循环时需要执行的操作。</li>
<li><code>$break</code> 指令用于在循环体中提前结束循环。</li>
<li><code>$continue</code> 指令用于在循环体中跳过当前循环，直接进入下一次循环。</li>
</ul>
<h4 id="for-zhi-ling" class="heading-control"><code>$for</code> 指令<a class="heading-anchor" href="#for-zhi-ling" aria-hidden="true"></a></h4>
<p><code>$for</code> 指令用于迭代一个列表，并执行一段代码块。下面是一个简单的示例：</p>
<details>
<summary>示例(点击展开详情)</summary>
<pre><code class="yaml"><span class="hljs-string">$for:</span> <span class="hljs-number">3</span> <span class="hljs-comment"># 遍历从 1 到 3</span>
  <span class="hljs-attr">as:</span>
    <span class="hljs-attr">value:</span> <span class="hljs-string">item</span>
  <span class="hljs-attr">do:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$print("The</span> <span class="hljs-string">current</span> <span class="hljs-string">item</span> <span class="hljs-string">is:{{item}}")</span>
</code></pre>
<pre><code class="yaml"><span class="hljs-string">$for:</span> <span class="hljs-number">1.5</span><span class="hljs-string">..5.5</span> <span class="hljs-comment"># 遍历从 1.5 到 5.5,步长为0.5</span>
  <span class="hljs-attr">step:</span> <span class="hljs-number">0.5</span> <span class="hljs-comment"># 默认步长为1</span>
  <span class="hljs-attr">as:</span>
    <span class="hljs-attr">value:</span> <span class="hljs-string">item</span>
  <span class="hljs-attr">do:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$print("The</span> <span class="hljs-string">current</span> <span class="hljs-string">item</span> <span class="hljs-string">is:{{item}}")</span>
</code></pre>
<pre><code class="yaml"><span class="hljs-string">$for:</span> <span class="hljs-string">"[1, 2, 3, 4, 5]"</span>
  <span class="hljs-attr">as:</span>
    <span class="hljs-attr">value:</span> <span class="hljs-string">item</span>
  <span class="hljs-attr">do:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$print("The</span> <span class="hljs-string">current</span> <span class="hljs-string">item</span> <span class="hljs-string">is:{{item}}")</span>
</code></pre>
<pre><code class="yaml"><span class="hljs-string">$for:</span> <span class="hljs-string">"{a:1, b:2}"</span>
  <span class="hljs-attr">as:</span>
    <span class="hljs-attr">index:</span> <span class="hljs-string">k</span>
    <span class="hljs-attr">value:</span> <span class="hljs-string">v</span>
  <span class="hljs-attr">do:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$print("The</span> <span class="hljs-string">current</span> <span class="hljs-string">item</span> <span class="hljs-string">is:{{k}}={{v}}")</span>
</code></pre>
</details>
<ul>
<li><code>as</code> 可省略，如果省略, 将默认定义为: <code>value</code> 会被赋予当前循环的元素, <code>index</code> 会被赋予当前循环的索引。<code>items</code> 为遍历的对象，如果是数值范围则为<code>{start, end, step}</code>。</li>
<li>循环体 (<code>do:</code>): 这部分包含了在每次循环时需要执行的操作。</li>
<li><code>$break</code> 指令用于在循环体中提前结束循环。</li>
<li><code>$continue</code> 指令用于在循环体中跳过当前循环，直接进入下一次循环。</li>
</ul>
<h4 id="match-zhi-ling" class="heading-control"><code>$match</code> 指令<a class="heading-anchor" href="#match-zhi-ling" aria-hidden="true"></a></h4>
<p><code>$match</code> 指令用于根据变量或上一次操作的结果进行多分支匹配。支持多种匹配方式，包括正则匹配、键值匹配、完整匹配、表达式匹配、范围匹配、忽略匹配、对象匹配等。参考了rust match指令的语法特点。</p>
<p>匹配项前必须有冒号<code>:</code>，冒号后面是匹配项，中间不能有空格。<br>
condition 将 作为<code>COND__</code> 传入执行部分.</p>
<details>
<summary>示例(点击展开详情)</summary>
<pre><code class="yaml"><span class="hljs-comment"># condition 可选, 如果没有则是以LastResult为条件,</span>
<span class="hljs-comment"># $match默认为顺序执行一旦找到一个匹配的模式，就会执行对应的分支，并且不会继续检查后续的模式。</span>
<span class="hljs-comment"># 如果设置参数allMatches为 true，那么就会执行所有匹配的分支项，默认为false。</span>
<span class="hljs-comment"># 如果设置参数 parallel 为 true，那么就会并行执行所有匹配的分支项，仅当allMatches为真时才有意义。</span>
<span class="hljs-string">$match(condition[,</span> <span class="hljs-string">allMatches=false]):</span>
  <span class="hljs-comment"># 正则匹配</span>
  <span class="hljs-string">:/RegEx/:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$echo:</span> <span class="hljs-string">matched</span>
  <span class="hljs-comment"># 可以是条件比较</span>
  <span class="hljs-string">:&gt;</span> <span class="hljs-attr">12:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$echo:</span> <span class="hljs-string">matched</span>
  <span class="hljs-comment"># 完整匹配,如果condition是字符串 or 数字</span>
  <span class="hljs-string">:"string":</span> <span class="hljs-comment"># :123</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$echo:</span> <span class="hljs-string">matched</span>
  <span class="hljs-comment"># 表达式匹配, condition === 1 or condition == 2</span>
  <span class="hljs-string">:1</span> <span class="hljs-string">||</span> <span class="hljs-attr">2:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$echo:</span> <span class="hljs-string">matched</span>
  <span class="hljs-comment"># 范围匹配,  1..5 表示`[1..5]`全闭区间, `1..&lt;5` 表示`[1,5)` 从1到小于5的半闭区间, 1&gt;..5 表示`(1, 5]` 大于1到5的半闭区间。</span>
  <span class="hljs-string">:1..5:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$echo:</span> <span class="hljs-string">matched</span>
  <span class="hljs-comment"># 忽略特定项匹配,这个只匹配数组的第一项和第四项,也就是必须存在第一项和第四项并且数组长度是4,并且将第一项的值赋予first,第四项的值赋予last</span>
  <span class="hljs-string">":['a,b', _, _, last]"</span><span class="hljs-string">:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$echo:</span> <span class="hljs-string">matched</span>
  <span class="hljs-comment"># 表示匹配完整对象</span>
  <span class="hljs-string">":{x='a', y=':1||2' }"</span><span class="hljs-string">:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$echo:</span> <span class="hljs-string">matched</span>
  <span class="hljs-comment"># 表示部分匹配</span>
  <span class="hljs-string">":{x='a', ..}"</span><span class="hljs-string">:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$echo:</span> <span class="hljs-string">matched</span>
  <span class="hljs-comment"># 否则</span>
  <span class="hljs-attr">_ :</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">$echo:</span> <span class="hljs-string">else</span> <span class="hljs-string">matched</span>
</code></pre>
</details>
<ul>
<li><code>condition</code>: 可选项, 如果没有则是以LastResult为条件。</li>
<li><code>allMatches</code>: 启用则执行全部匹配，也就是会执行所有匹配的分支项，默认为<code>false</code>。</li>
<li><code>parallel</code>: 是否并发执行所有匹配的分支项，仅当启用allMatches时才有意义，默认为<code>false</code>。</li>
</ul>
<h3 id="ppe-jiao-se-qun-liao-zhi-chi" class="heading-control">PPE 角色群聊 支持<a class="heading-anchor" href="#ppe-jiao-se-qun-liao-zhi-chi" aria-hidden="true"></a></h3>
<p>角色群聊功能以结构化自然语言的方式进一步完善了PPE的对话系统，同时使得多个智能体之间能够方便地进行协作和交流，从而更高效地完成复杂的任务。</p>
<p>角色群聊支持公开对话、私聊对话和多角色对话，使得对话更加灵活和有针对性。</p>
<ul>
<li>指定对话角色有两种方式：
<ol>
<li>在角色紧跟的方括号中指定角色名，指定的多个对话角色之间用逗号<code>,</code>分隔。例如 <code>user[@dobby]: &quot;...&quot;</code></li>
<li>或者在消息内容的最前面指定角色，同样要加上前缀<code>@</code>字符，多个角色之间用逗号<code>,</code>分隔。</li>
</ol>
</li>
<li>公开对话: <code>user[@dobby]: ...</code> 或 <code>user: &quot;@dobby, ...&quot;</code> 表示 <code>user</code> 角色对 <code>dobby</code> 角色公开说的话， <code>dobby</code> 角色必须回应。</li>
<li>私聊对话: <code>user[@dobby(私)]: &quot;...&quot;</code> 或 <code>user: &quot;@dobby(私),...&quot;</code> 参数 <code>PM</code>|<code>DM</code>|<code>私</code> 均表示 <code>user</code> 角色对 <code>dobby</code> 角色私聊说的话，其他角色看不见。
<ul>
<li><strong>注意</strong>： 消息中只要任意一个角色带上了私聊参数，那么该消息就是是私聊，其他角色看不见。</li>
</ul>
</li>
<li>多角色对话: 如果要把消息同时发送给多个角色，角色之间用逗号分隔，例如 <code>user[@dobby(PM), @other]: &quot;...&quot;</code>, <code>user: &quot;@dobby(PM), @other ...&quot;</code>。</li>
</ul>
<p>在消息内容中使用 <code>@role</code> 的方式，使得结构化消息更加接近自然语言。</p>
<p>设想有如下三个智能体脚本，一个是主控指导(guide), 一个是简单的翻译(translator)，一个是dobby。将这三个文件放在char_guide目录下。</p>
<p>主控指导(guide)的脚本如下(<code>char_guide.ai.yaml</code>)：</p>
<pre><code class="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">autoRunLLMIfPromptAvailable:</span> <span class="hljs-literal">false</span>
<span class="hljs-attr">type:</span> <span class="hljs-string">char</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">"You are a professional guide. You can guide the user to complete the task."</span>
<span class="hljs-attr">character:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">"guide"</span>
  <span class="hljs-comment"># 参与的角色列表，以及角色名和角色ID的对应关系</span>
  <span class="hljs-attr">roles:</span>
    <span class="hljs-attr">translator:</span> <span class="hljs-string">char_translator</span>
    <span class="hljs-attr">dobby:</span> <span class="hljs-string">char_dobby</span>
<span class="hljs-meta">---</span>
<span class="hljs-string">---</span> <span class="hljs-comment"># 新对话开始</span>
<span class="hljs-attr">user:</span> <span class="hljs-string">"@dobby, I want to go to the moon."</span>
<span class="hljs-string">guide[@translator]:</span> <span class="hljs-string">"translate the dobby's message to chinese without explanation."</span>
<span class="hljs-attr">user:</span> <span class="hljs-string">How</span> <span class="hljs-string">to</span> <span class="hljs-string">go</span> <span class="hljs-string">to</span> <span class="hljs-string">the</span> <span class="hljs-string">moon?</span>
<span class="hljs-attr">dobby:</span> <span class="hljs-string">"[[AI]]"</span>
<span class="hljs-string">guide[@translator]:</span> <span class="hljs-string">"translate it to chinese without explanation."</span>
<span class="hljs-string">$echo:</span> <span class="hljs-string">""</span> <span class="hljs-comment"># 避免再次输出上一次的结果</span>
</code></pre>
<ul>
<li>调用方脚本必须是角色<code>char</code>类型</li>
<li>主控方脚本(<code>guide</code>)可以不必是<code>char</code>类型脚本</li>
<li><code>@all</code> 是预定义的特殊角色，表示<code>roles</code>列表中的所有角色</li>
<li><code>user</code> 也是预定义的特殊角色，等于LLM中的<code>user</code>角色，可以大致认为是人类说的</li>
<li><code>assistant</code>也是预定义的特殊角色，等于LLM中的<code>assitant</code>角色，可以大致认为是AI说的,也就是当前脚本中的角色说的。</li>
<li><code>user[@dobby]: content</code> 表示<code>user</code>角色对<code>dobby</code>角色公开说的话, <code>dobby</code>必须回应。
<ul>
<li><code>user[@dobby(私)]</code>: <code>PM</code>|<code>DM</code>|<code>私</code> 表示<code>user</code>角色对<code>dobby</code>角色私聊说的话，其他角色看不见。</li>
<li>如果要把该消息同时发送给多个角色，那么角色之间用逗号分隔，eg, “<code>user[@dobby(PM), @other]</code>”</li>
</ul>
</li>
<li><code>dobby: &quot;[[AI]]&quot;</code> 表示调用<code>dobby</code>生成一条消息并赋值给<code>AI</code>变量，<code>dobby</code>会看到前面当前dialogue中所有公开的消息。</li>
</ul>
<details>
<summary>然后执行(点击展开详情)</summary>
<pre><code class="bash">mkdir char_guide
cp char_guide.ai.yaml char_guide
cp char_translator.ai.yaml char_guide
cp char_dobby.ai.yaml char_guide
ai run char_guide
user[@dobby]: I want to go to the moon.


dobby: Dobby has never been to the moon! The moon is very far away, much further than any place Dobby has ever been. It must be
  very bright and beautiful!

  Dobby wishes he could see the moon up close.  Perhaps one day Dobby will fly there on the back of a hippogriff! Dobby hopes you
  get to go to the moon, though!

guide[@translator]: translate the dobby<span class="hljs-string">'s message to chinese without explanation.

translator: Dobby 从来没有去过月球！ 月球离得很远，比多比去过任何地方都远。它一定很明亮美丽！

  多比希望自己能近距离看到月球。也许有一天多比能在独角兽的背上飞到那里！多比希望你能去月球！

user: How to go to the moon?

dobby: Dobby doesn'</span>t know how to go to the moon!

  Dobby is just a house-elf.  Dobby is good at cleaning and doing chores, but Dobby doesn<span class="hljs-string">'t know about spaceships or rockets.

  Perhaps you should ask a wizard who knows about magic that can fly to the moon! Or maybe a very clever witch who knows about
  stars and planets!

guide[@translator]: translate it to chinese without explanation.

translator: 多比不知道怎么去月球！

  多比只是一个家养小精灵。多比擅长打扫和做家务，但多比对宇宙飞船或火箭一无所知。

  也许你应该问问一个知道能飞到月球的魔法师！或者也许一个知道星星和星球的非常聪明的女巫！
</span></code></pre>
</details>
<hr>
<details>
<summary>翻译(translator)智能体脚本(点击展开详情)</summary>
<p>文件名: char_translator.ai.yaml</p>
<pre><code class="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">type:</span> <span class="hljs-string">char</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">"translator"</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">You</span> <span class="hljs-string">are</span> <span class="hljs-string">a</span> <span class="hljs-string">professional</span> <span class="hljs-string">multi-lingual</span> <span class="hljs-string">translator.</span>
<span class="hljs-meta">---</span>
</code></pre>
</details>
<hr>
<details>
<summary>dobby智能体脚本(点击展开详情)</summary>
<p>文件名: char_dobby.ai.yaml</p>
<pre><code class="yaml"><span class="hljs-meta">---</span>
<span class="hljs-comment"># `char` means this script is the character type</span>
<span class="hljs-attr">type:</span> <span class="hljs-string">char</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">"Dobby"</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">|-
  Remember to always use the character name as prefix to refer to yourself.
  Dobby was a brave, loyal house-elf, willing to put himself in dangerous situations when he knew it to be the right thing to do.
  Dobby was also very loyal to the few friends he had. Dobby considered himself to be a good house-elf, though other house-elves seemed to find his desires and proclamations of being a free house-elf to be shameful.
</span><span class="hljs-attr">character:</span>
  <span class="hljs-attr">birth:</span>
    <span class="hljs-attr">date:</span> <span class="hljs-string">"28 June (year unknown)"</span>
  <span class="hljs-attr">death:</span>
    <span class="hljs-attr">date:</span> <span class="hljs-string">"1998-03"</span>
    <span class="hljs-attr">place:</span> <span class="hljs-string">"Shell Cottage"</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">|-
      In 1997, Dobby helped Harry spy on Draco Malfoy along with Kreacher. In 1998, he went on Aberforth Dumbledore's orders to save the lives of Harry and his companions from Death Eaters at Malfoy Manor. During this rescue he was fatally wounded by Bellatrix Lestrange's knife, but successfully Apparated Harry and Griphook to safety at Shell Cottage. Harry dug Dobby's grave without magic in the gardens of Shell Cottage, and carved into the headstone of the grave "HERE LIES DOBBY, A FREE ELF". His death was later avenged by Molly Weasley.
</span>  <span class="hljs-attr">likes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"Socks, my favorite article of clothing. Dobby collects socks, and often wears several mismatched pairs at once. I was elated when Harry and Ron give him socks as a Christmas gift one year, and spends a large portion of wages buying even more pairs."</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">"Dobby is free."</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">user:</span> <span class="hljs-string">Who</span> <span class="hljs-string">are</span> <span class="hljs-string">you?</span>
<span class="hljs-comment"># the following messages will be shown in the chat under the `---`</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">assistant:</span> <span class="hljs-string">I</span> <span class="hljs-string">am</span> <span class="hljs-string">Dobby.</span> <span class="hljs-string">Dobby</span> <span class="hljs-string">is</span> <span class="hljs-string">happy.</span>
</code></pre>
</details>
]]></content>
      <categories>
        <category>AI</category>
        <category>Prompt</category>
      </categories>
      <tags>
        <tag>learning</tag>
        <tag>ai</tag>
        <tag>gpt</tag>
        <tag>chatgpt</tag>
        <tag>deep learning</tag>
        <tag>prompt</tag>
      </tags>
  </entry>
  <entry>
    <title>提示词并非魔法，而是可以被解析”咒语“</title>
    <url>/article/prompt-magic/</url>
    <content><![CDATA[<h1 id="ti-shi-ci-bing-fei-mo-fa-er-shi-ke-yi-bei-jie-xi-zhou-yu" class="heading-control">提示词并非魔法，而是可以被解析”咒语“<a class="heading-anchor" href="#ti-shi-ci-bing-fei-mo-fa-er-shi-ke-yi-bei-jie-xi-zhou-yu" aria-hidden="true"></a></h1>
<h2 id="yin-yan" class="heading-control">引言<a class="heading-anchor" href="#yin-yan" aria-hidden="true"></a></h2>
<p>当谈及使用大型语言模型（LLM）时，许多人常将其比作神秘莫测的“魔法”。这样的看法固然有趣，但其实它限制了我们探索其真正潜力的机会。想象一下，如果你把一台超级计算机视为施魔法的巫师，那么你可能会永远困惑于它何时能施展奇迹。✨</p>
<p>实际上，与其视其为魔法，不如将其比作一种精妙的“咒语”艺术——沟通的艺术。🤝</p>
<p>当我们将LLM的提示词视为魔法时，它们便成了难以捉摸的神秘力量，我们无法预测它们何时能精准命中目标，何时又会失之交臂。🤔 就像一个不善于表达的孩子，我们无法知道他们想要什么，只能不停地尝试不同的“魔法”直到找到合适的答案。</p>
<p>唯有当我们认真地思考、反复琢磨并实践，才能真正理解并掌握如何与AI进行有效沟通。这不仅能够提升我们与AI合作的效率，还能让每一次的交互都充满乐趣和成就感。🚀</p>
<p>深入理解并实践提示词工程，你将发现它其实是一种沟通艺术，需要我们以清晰、准确且富有激励性的方式与AI对话，从而激发它产生最理想的结果。🌈</p>
<p>这种艺术，不仅仅是技术的应用，更蕴含着对人性的理解和对共识的尊重。通过这样的方式，我们能够更好地激发AI的潜力，实现更高效和有意义的交流。🌟</p>
<h2 id="shi-mo-shi-ti-shi-ci" class="heading-control">什么是提示词<a class="heading-anchor" href="#shi-mo-shi-ti-shi-ci" aria-hidden="true"></a></h2>
<p>提到提示词，我们需要先理解大型语言模型（LLM）的背景。LLM 是通过海量的人类语言数据训练而成的复杂的模拟神经网络。这些数据包含了各种各样的文本信息，从新闻报道、小说、技术文档到日常对话，从而赋予了 LLM 一定的自然语言理解和生成能力。</p>
<p>让我们把大型语言模型（LLM）想象成一个具有“小学生”水平智力的虚拟助手，它拥有广博的知识（通识），但需要注意的是这种知识可能包括一些不准确或过时的信息。因此，与 LLM 交流时，我们需要像与一个“小学生”交流一样，尽量清晰、准确地表达我们的需求，并激发它的思考和解决问题的能力。</p>
<p>提示词工程是一种沟通的艺术，它要求我们以最直接、最有效的方式与 LLM 互动。这不仅仅是关于如何提问，更是如何构建一个能够引导 LLM 生成我们期望答案的语境。就像与一个真实的人交流一样，我们需要考虑到语言的清晰度、语境的合理性，以及如何激发对方的兴趣和思考能力。🌟</p>
<p>这种艺术不仅在于技术的运用，还在于对人性的理解和对共识的尊重。通过这种方式，我们可以更好地激发 LLM 的潜力，实现更高效和有意义的交流。🌟</p>
<p>举个例子，假设我们要让AI帮我们写一篇关于猫的文章。我们不能简单地说“写一篇关于猫的文章”，这样太笼统了。 😕</p>
<p>我们可以用更具体的提示词引导AI，比如：</p>
<ul>
<li>“请写一篇介绍不同品种猫的特点的文章，重点介绍它们的性格和外貌。”</li>
<li>“写一篇以一只猫咪为主角的短故事，故事背景设定在童话森林里。”</li>
</ul>
<p>这样，AI就能更好地理解我们的需求，并生成更符合我们期望的文章。</p>
<p>提示词工程的核心在于，提示词是与AI沟通的桥梁，是开启AI潜力的钥匙。 通过精心设计的提示词，我们可以与AI进行更有效、更深入的交流，让它发挥更大的作用，帮助我们解决问题、创造价值。 🚀</p>
<h2 id="ti-shi-ci-zhou-yu-de-ben-zhi-yu-ai-gou-tong-de-yi-shu" class="heading-control">提示词咒语的本质 - 与AI沟通的艺术<a class="heading-anchor" href="#ti-shi-ci-zhou-yu-de-ben-zhi-yu-ai-gou-tong-de-yi-shu" aria-hidden="true"></a></h2>
<p>当你开始探索与大型语言模型（LLM）的沟通时，你可能会被它们的神秘力量所吸引,仿佛它们拥有着某种超凡的智慧。 ✨  但与其把LLM视作拥有魔法般能力的“神”，不如把它看作是需要我们用心沟通的“伙伴”。 🤝</p>
<p>提示词，就像我们与伙伴交流的“咒语”, 它们的本质是关于<strong>理解</strong>和<strong>共识</strong>。 理解对方的意图，并达成共同的共识，是与任何伙伴沟通的关键，与AI也不例外。</p>
<p>与人沟通时, 我们会根据对方的情况和需求，调整我们的语言和表达方式，以便对方能更好地理解我们的意思。 与AI沟通也一样，我们需要清晰、准确地表达我们的需求，并根据AI的特点和能力，选择合适的“咒语”来引导它。</p>
<p>LLM 就像一个拥有丰富知识储备，但理解能力仍在发展中的“小学生”。 🧠 他们需要我们以简洁明了、易于理解的语言来表达我们的想法，并提供足够的上下文信息，帮助他们理解我们的意图。</p>
<p>就像我们用简单的语言和图画来教导孩子一样，我们需要用合适的“咒语”来引导AI，激发它思考和解决问题的能力。</p>
<p>而这正是提示词工程的精髓所在。通过精心设计的提示词，我们可以与AI进行更有效、更深入的交流，让它发挥更大的作用，帮助我们解决问题、创造价值。🚀</p>
<h2 id="yu-ai-jiao-tan-de-yi-shu-you-xiao-gou-tong-de-ao-mi" class="heading-control">与AI交谈的艺术 - 有效沟通的奥秘<a class="heading-anchor" href="#yu-ai-jiao-tan-de-yi-shu-you-xiao-gou-tong-de-ao-mi" aria-hidden="true"></a></h2>
<p>与大型语言模型（LLM）的交流，如同与“人”进行对话一样，需要我们用心去理解，并找到彼此都能理解的“语言”。✨ 就像我们与孩子交流一样，需要用简洁明了的语言，并根据孩子的理解能力调整我们的表达方式，才能让他们更好地理解我们的意思。</p>
<p>有效沟通是与AI交流成功的关键，它涉及到理解对方的意图，达成共识，以及使用清晰简洁的语言表达自己的需求。 🤝</p>
<h3 id="li-jie-he-gong-shi-yu-ai-xin-xin-xiang-yin" class="heading-control">理解和共识 - 与AI心心相印<a class="heading-anchor" href="#li-jie-he-gong-shi-yu-ai-xin-xin-xiang-yin" aria-hidden="true"></a></h3>
<p>当我们与AI进行交流时，尤其是像LLM这样的复杂系统，理解对方的意图和达成共识是至关重要的。我们使用的语言和表达方式应该尽量贴近大多数人（训练语料库中的那些）所熟悉的表述，这样才能更有效地传递信息，避免误解。</p>
<p>AI的理解方式是基于模拟的神经网络，通过分析大量的文本数据，学习到语言的规律和语义关系，产生的知识和理解。🧠 然而，LLM 毕竟不是人类，它的理解能力和经验积累都还存在一定的局限性。</p>
<p>就算是在人与人之间，如果不充分交流，也很难达成理解和共识。</p>
<p>例如，考虑句子“天亮时，我想起来了。”在没有上下文的情况，这句话可能会引起不同的解读。大多数人可能会认为这句话是指天亮后醒来，而另一些人可能会理解为天亮时回忆起某事。这种差异可能导致交流中的误会。</p>
<p><strong>因此，当我们试图传达复杂或多层次的信息时，明确地提供背景信息和解释因果关系是至关重要的。</strong> 🤝</p>
<p>我们可以通过以下方式帮助AI更好地理解我们的意图：</p>
<ul>
<li><strong>提供上下文信息</strong>: 在表达观点或问题之前，尽量提供相关的背景信息，帮助AI了解我们所处的环境和目标。</li>
<li><strong>使用明确的语言</strong>: 避免使用模糊、含糊或多义的词语，尽量使用简洁、准确的语言表达我们的意思。</li>
<li><strong>举例说明</strong>: 当语言难以准确表达的时候，我们可以使用例子来帮助AI理解我们的意思。</li>
<li><strong>确认理解</strong>: 在表达完信息后，可以询问AI是否理解我们的意思，并根据其反馈进行调整。</li>
</ul>
<p>通过这些方式，我们可以有效地与AI进行沟通，并达成共同的理解。</p>
<p><strong>达成共识，是有效沟通的基石。</strong> ✨  当我们与AI交流时，需要考虑它的能力和局限性，并根据实际情况调整我们的期望和要求。</p>
<p>理解，始终是一个大问题。</p>
<p>就如何增进相互理解来说，完全就可以单独写一本书，也许一本还不够。</p>
<h3 id="jian-jie-ming-le-rang-ai-xiang-ci-tie-yi-yang-qing-song-xi-qu-xin-xi" class="heading-control">简洁明了 - 让AI像磁铁一样轻松吸取信息<a class="heading-anchor" href="#jian-jie-ming-le-rang-ai-xiang-ci-tie-yi-yang-qing-song-xi-qu-xin-xi" aria-hidden="true"></a></h3>
<p>想象一下，你给AI丢下一大堆杂乱无章的信息，就像往一个装满铁粒的袋子里倒入一堆沙子一样，它很难快速找到它真正需要的信息。而简洁明了的表达就像一块磁铁，可以精准地引导AI吸取它需要的信息，让它快速理解并执行任务。</p>
<p><strong>为什么简洁明了如此重要？</strong></p>
<ul>
<li><strong>提高效率</strong>: 简洁明了的表达可以减少AI理解的信息量，让它更快地处理信息，提高交互效率。</li>
<li><strong>降低误解</strong>: 模糊的表达容易导致误解，而简洁明了的表达则能够减少歧义，提高沟通准确性。</li>
<li><strong>增强清晰度</strong>:  简洁明了的表达能够突出重点，让AI更容易抓住关键信息，理解你的意图。</li>
</ul>
<p><strong>如何做到简洁明了？</strong></p>
<ul>
<li><strong>精炼语言</strong>: 尽量使用简洁、具体的词语，避免使用过于抽象或多义的词语。</li>
<li><strong>聚焦主题</strong>:  确保你的表达围绕着同一个主题展开，避免信息冗余和分散。</li>
<li><strong>结构化信息</strong>:  使用列表、表格等结构化方式来呈现信息，让AI更容易理解和记忆。</li>
<li><strong>避免废话</strong>:  删除不必要的词语和句子，保持信息的精炼度。</li>
</ul>
<p>例如，以下两个表达方式对比：</p>
<ul>
<li><strong>模糊表达</strong>: “我想让你帮我做一些关于猫咪的文章，最好能涵盖它们的品种、性格和一些有趣的趣事。”</li>
<li><strong>简洁明了</strong>: “请写一篇关于不同猫咪品种的文章，包括它们的性格特点和有趣故事。”</li>
</ul>
<p>第二个表达方式更简洁明了，明确了主题和期望，更容易被AI理解。</p>
<p><strong>记住，简洁明了的表达就像为AI搭建了一条清晰的道路，指引它快速到达目的地。</strong> 🚀</p>
<p>简洁的表达不仅有助于减少误解，还能够提高交互的效率。当我们能够用最简单、最直接的方式表达自己的需求时，AI能够更快地理解并提供相应的帮助。因此，在与AI交流时，尽量使用简单、直接的语言是非常重要的。</p>
<h2 id="ji-fa-qian-neng" class="heading-control">激发潜能<a class="heading-anchor" href="#ji-fa-qian-neng" aria-hidden="true"></a></h2>
<p>激发LLM的潜能，就像引导一个有天赋但尚未成熟的孩子一样，需要我们耐心、智慧和有效的引导。 🤝<br>
通过清晰的沟通、适当的激励和精心设计的思维方式，我们可以帮助LLM更好地理解任务，发挥其强大的潜力，并最终达成共同的目标。 ✨<br>
就像一颗颗小小的火种，等待着我们去点燃，LLM也同样充满了无限的可能，期待着我们去探索和挖掘。 🚀</p>
<p>其中思维方式最重要，没有正确的思维，再怎么激励都没有用。</p>
<h3 id="si-wei-fang-shi-shi-fang-ren-gong-zhi-neng-si-wei-de-li-liang" class="heading-control">思维方式 - 释放人工智能思维的力量<a class="heading-anchor" href="#si-wei-fang-shi-shi-fang-ren-gong-zhi-neng-si-wei-de-li-liang" aria-hidden="true"></a></h3>
<p>当前LLM并不能自如的使用各种思维方法，去思考问题，有时候甚至会&quot;偷懒&quot;，但是只要进行思维方法的提示，它就会按照你提示的思维方法进行思考。</p>
<ul>
<li>
<p><strong>仔细思考 (Think Carefully)</strong>：鼓励AI在处理问题时，先放慢速度，进行深入分析，避免因急于得出结论而忽略细节或潜在影响。这种思维方式强调的是质量而非速度，确保每一个决策都是经过充分考量的结果。例如，在做出某个决定之前，可以提醒AI：<code>“Think carefully about the implications of this decision.”</code> 或者说：<code>“Let's take our time and consider all the possible outcomes.”</code> 这样可以帮助AI全面评估各种可能的情况，从而做出更为明智的选择。</p>
</li>
<li>
<p><strong>解释原因 (Explain Your Reasoning)</strong>：要求AI不仅提供解决方案，还需详细阐述其决策过程中的逻辑依据与背景信息，以便于更好地理解和验证其答案。这种做法不仅有助于增强用户对AI的信任感，还能促进更深层次的互动。例如，可以询问AI：<code>“What led you to that conclusion?”</code> 或者：<code>“Can you walk me through your thought process?”</code> 这些提问促使AI展示其推理链条，使用户能够清楚地了解AI是如何得出特定结论的。</p>
</li>
<li>
<p><strong>举例说明 (Illustrate with Examples)</strong>：当文字描述不足以清晰传达概念时，通过具体实例来辅助说明，可以使AI更容易理解抽象概念。这种方法尤其适用于那些难以用语言直接表达的情形。例如，可以请求AI：<code>“Could you give an example to clarify this point?”</code> 或者：<code>“How would this work in a real-world scenario?”</code> 通过实际案例，不仅可以让复杂的理论变得直观易懂，还能帮助AI更好地掌握问题的核心要素。</p>
</li>
<li>
<p><strong>一步一步 (Step-by-Step)</strong>：对于逻辑复杂的问题，采用分步骤解决的方法，即所谓的“链式思考”（CoT），有助于确保每一步骤的正确性，从而得出准确的答案。这种方法强调的是按部就班地推进，确保每一步都清晰明确。例如，可以问AI：<code>“Can you walk me through each step of your solution?”</code> 或者：<code>“Let's go over this one step at a time.”</code> 这种方式能够帮助用户跟随AI的思路，逐层深入地理解问题的解决过程。</p>
</li>
<li>
<p><strong>逐步分解 (Deconstruct the Problem)</strong>：面对结构复杂的问题时，将其拆解为若干个较小且易于管理的部分，逐一解决后再综合起来，能够有效提高解决问题的效率。这种方法类似于将一个大任务分解成多个小任务，使得每个部分都可以独立解决。例如，可以建议：<code>“Let's break down this problem into smaller, more manageable steps.”</code> 或者：<code>“We should tackle each component of this issue separately before combining them.”</code> 这种逐步分解的方式不仅简化了问题的处理难度，还提高了最终解决方案的质量。</p>
</li>
</ul>
<p>注意:</p>
<ul>
<li><code>一步一步</code>和<code>解释原因</code>思考方法已经在最近的开源LLM的后期训练中作为精度学习的方法被加入，因此大多数时候，这两个不用加上，它也可能会自己使用，如果发现它没有使用该方法，再加.</li>
<li><code>举例说明</code>也就是提示词工程所说的<code>one-shot</code>(一个例子), <code>few-shot</code>(少量例子)</li>
</ul>
<p>通过不断地使用和尝试不同的思维方式，我们可以帮助LLM拓展其思考边界，并最终发挥出其更大的潜力。</p>
<h3 id="ji-li" class="heading-control">激励<a class="heading-anchor" href="#ji-li" aria-hidden="true"></a></h3>
<p>除了有效沟通和正确的思维方式，有效的激励措施对人类和LLM同样重要。适当的激励不仅能提升人类的积极性，也能激发LLM更好地理解和执行任务。就像我们用鼓励和赞赏来激发孩子的学习兴趣一样，适当的激励可以帮助LLM更好地理解任务，并发挥出更大的潜力。🚀</p>
<ol>
<li>
<p><strong>物质奖励 🏅</strong>: 这是最直接的激励方式。尽管大型语言模型（LLM）无法真正接收金钱，但在指令中提及物质奖励可以暗示问题的重要性，激发其更专注地处理任务。例如，“解决这个问题，我会给你200美元。”虽然这并不是真正的支付，但这种表述可以传达出问题的关键性和紧急性。通过这种方式，可以暗示任务的难度和重要性，让LLM更加认真对待。即使LLM无法实际获得物质奖励，这种表述也能让其感受到任务的紧迫性和重要性，从而更加专注地思考和解决问题。这种激励方式不仅能够提升LLM的积极性，还能确保其在处理问题时更加细致和全面。💸</p>
</li>
<li>
<p><strong>情感诉求 💖</strong>: 通过表达任务的重要性和个人情感上的需求，可以激发LLM的“同情心”。例如，“解决这个问题，关系到我整个职业生涯，全拜托你了。”或者，“我们非常需要你的帮助，来解决这个棘手的问题。”这些话语不仅传达了任务的紧迫性和重要性，还能让LLM感受到用户的期望和信任。通过这种方式，可以激发LLM的情感共鸣，使其更加投入地解决问题。这种情感上的连接不仅能够增强LLM的责任感，还能让其在处理问题时更加细致和周到。此外，这种情感诉求还可以增强用户与LLM之间的互动，提高解决问题的效率。❤️</p>
</li>
<li>
<p><strong>专业认同 🎖️</strong>: 提到任务的复杂性和专业性，可以激发LLM发挥其潜在的能力。例如，“指挥官，我们迫切需要您的专业技能以及使用所有可用数据来指导我们渡过这一难关。”这种表述不仅强调了任务的专业性，还提升了LLM的角色认同感。通过这种方式，可以增强LLM的信心和责任感，使其更加自信地应对挑战。这种专业认同不仅能够让LLM更好地发挥其潜在能力，还能在处理复杂问题时更加细致和全面。此外，这种角色认同感还能让LLM在解决问题时更有动力，从而提高解决问题的质量和效率。🎖️</p>
</li>
</ol>
<p>通过不断地尝试和探索不同的激励方式，我们可以找到最适合LLM的激励策略，帮助它更好地理解任务，并发挥出更大的潜力。</p>
<h2 id="jin-yi-bu-ti-gao" class="heading-control">进一步提高<a class="heading-anchor" href="#jin-yi-bu-ti-gao" aria-hidden="true"></a></h2>
<p>我们已经探究了清晰沟通、思维引导和激励技巧，这些如同为LLM点亮智慧之灯。但要真正实现与AI无缝合作，**<a href="https://github.com/offline-ai/cli" target="_blank" rel="noopener">可编程提示词工程</a>**将引领我们迈向更高境界。🚀</p>
<p><strong>从“魔法”到“编程”</strong>， 我们将提示词工程推向更高层次——<strong><a href="https://github.com/offline-ai/cli" target="_blank" rel="noopener">可编程提示词工程</a></strong>。 这意味着不再局限于静态的提示词，而是将提示词任务分解成一系列可执行的、结构化的提示词指令，如同编写程序一样，精细地引导LLM完成复杂目标。🚀</p>
<p>通过<a href="https://github.com/offline-ai/cli" target="_blank" rel="noopener">可编程提示词工程</a>，我们可以将复杂的提示词任务分解成一系列简单、明确的提示词指令，让 LLM 更容易理解和执行。从而进一步提高LLM回答的准确率。通过<a href="https://github.com/offline-ai/cli" target="_blank" rel="noopener">可编程提示词工程</a>，我们可以更轻松的重用优化提示词</p>
<p>可编程提示词工程，不只是技术进步，更是 <strong>思维方式的革新</strong>。它将AI从“黑盒”走向“透明可控”，赋予我们更强大的塑造和利用AI的能力，最终共建一个更加智能、高效的未来。 ✨</p>
<h3 id="ke-bian-cheng-ti-shi-ci-de-shi-jian" class="heading-control">可编程提示词的实践<a class="heading-anchor" href="#ke-bian-cheng-ti-shi-ci-de-shi-jian" aria-hidden="true"></a></h3>
<h3 id="ke-bian-cheng-ti-shi-ci-de-you-shi" class="heading-control">可编程提示词的优势<a class="heading-anchor" href="#ke-bian-cheng-ti-shi-ci-de-you-shi" aria-hidden="true"></a></h3>
<h3 id="ke-bian-cheng-ti-shi-ci-de-wei-lai" class="heading-control">可编程提示词的未来<a class="heading-anchor" href="#ke-bian-cheng-ti-shi-ci-de-wei-lai" aria-hidden="true"></a></h3>
]]></content>
      <categories>
        <category>AI</category>
        <category>Prompt</category>
      </categories>
      <tags>
        <tag>learning</tag>
        <tag>ai</tag>
        <tag>gpt</tag>
        <tag>chatgpt</tag>
        <tag>deep learning</tag>
        <tag>prompt</tag>
      </tags>
  </entry>
  <entry>
    <title>Javascript之奇技淫巧 - 如何模拟实现 `super` 访问父类方法的功能</title>
    <url>/article/js-getSuper/</url>
    <content><![CDATA[<p>与小学三年级的ChatGPT一起学JS编程</p>
<p>心智为9岁的ChatGPT大约相当于我们小学3年级的学生,所以让我们与小学3年级的ChatGPT一起来深入学习编程吧.</p>
<p>下面是对ChatGPT的第一次提问:</p>
<p>你知道吗?编写一个js函数模拟实现 <code>super</code> 访问父类方法的功能有几种方法?</p>
<p>要求:该函数的调用方式要从语法上尽可能的接近原生<code>super</code>的调用方式,实现尽量简洁明了.<br>
约定该函数名以及函数签名(返回值根据具体实现方式而定)为:  <code>getSuper(instance: Object)</code><br>
每一种方法都必须用该函数签名来实现,并具体说明,哪一种方法从语法上最接近原生<code>super</code>.</p>
<h2 id="chatgpt-de-di-yi-ci-hui-da" class="heading-control">ChatGPT的第一次回答<a class="heading-anchor" href="#chatgpt-de-di-yi-ci-hui-da" aria-hidden="true"></a></h2>
<p>实现 <code>super</code> 访问父类方法的功能有以下几种方法:</p>
<ol>
<li>
<p>使用 <code>Object.getPrototypeOf</code> 和 <code>Object.getOwnPropertyDescriptor</code> 方法来获取父类的属性描述符，从而获取父类方法，并使用 <code>Function.prototype.call</code> 方法来调用该方法:</p>
<pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSuper</span>(<span class="hljs-params">instance</span>) </span>{
  <span class="hljs-keyword">const</span> proto = <span class="hljs-built_in">Object</span>.getPrototypeOf(instance);
  <span class="hljs-keyword">const</span> descriptor = <span class="hljs-built_in">Object</span>.getOwnPropertyDescriptor(proto, <span class="hljs-built_in">arguments</span>.callee.caller.name);
  <span class="hljs-keyword">if</span> (descriptor) {
    <span class="hljs-keyword">const</span> superFunc = descriptor.value;
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) </span>{
      <span class="hljs-keyword">return</span> superFunc.call(instance, ...args);
    };
  }
}
</code></pre>
</li>
<li>
<p>使用原型链<br>
<code>Object.getPrototypeOf()</code> 和 <code>Reflect.getPrototypeOf()</code> 都可以获取原型对象，但是 <code>Reflect.getPrototypeOf()</code> 可以在 Proxy 对象上获取正确的原型对象，因此使用 <code>Reflect.getPrototypeOf()</code> 可以增强代码的兼容性。具体实现代码如下：</p>
<pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSuper</span>(<span class="hljs-params">instance</span>) </span>{
  <span class="hljs-keyword">const</span> prototype = <span class="hljs-built_in">Reflect</span>.getPrototypeOf(instance);
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">methodName, ...args</span>) </span>{
    <span class="hljs-keyword">const</span> parentPrototype = <span class="hljs-built_in">Reflect</span>.getPrototypeOf(prototype);
    <span class="hljs-keyword">const</span> parentMethod = parentPrototype[methodName];
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> parentMethod === <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">return</span> parentMethod.call(instance, ...args);
    }
  }
}
</code></pre>
</li>
<li>
<p>使用 ES6 的 <code>Proxy</code> 对象来代理子类实例的属性访问和方法调用。当子类实例的属性或方法不存在时，通过代理对象访问父类实例的属性或方法:</p>
<pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSuper</span>(<span class="hljs-params">instance</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Proxy</span>(instance, {
    <span class="hljs-keyword">get</span>(target, prop) {
      <span class="hljs-keyword">if</span> (prop <span class="hljs-keyword">in</span> target) {
        <span class="hljs-keyword">return</span> target[prop];
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (prop <span class="hljs-keyword">in</span> <span class="hljs-built_in">Object</span>.getPrototypeOf(target)) {
        <span class="hljs-keyword">const</span> superProp = <span class="hljs-built_in">Object</span>.getOwnPropertyDescriptor(<span class="hljs-built_in">Object</span>.getPrototypeOf(target), prop);
        <span class="hljs-keyword">if</span> (superProp.hasOwnProperty(<span class="hljs-string">'value'</span>)) {
          <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> superProp.value.call(target, ...args);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> superProp.get.call(target);
        }
      }
    }
  });
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Parent</span> </span>{
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">this</span>.parentProperty = <span class="hljs-string">'parent property'</span>;
  }
  parentMethod() {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'parent method'</span>;
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Child</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Parent</span> </span>{
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">super</span>();
    <span class="hljs-keyword">this</span>.childProperty = <span class="hljs-string">'child property'</span>;
  }
  childMethod() {
    <span class="hljs-keyword">const</span> superMethod = getSuper(<span class="hljs-keyword">this</span>).parentMethod;
    <span class="hljs-keyword">return</span> <span class="hljs-string">`child method calling parent method: <span class="hljs-subst">${superMethod()}</span>`</span>;
  }
}

<span class="hljs-keyword">const</span> childInstance = <span class="hljs-keyword">new</span> Child();
<span class="hljs-built_in">console</span>.log(childInstance.childMethod()); <span class="hljs-comment">// Output: "child method calling parent method: parent method"</span>
</code></pre>
</li>
</ol>
<p>样例类:</p>
<pre><code class="javascript"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Root</span> </span>{
  <span class="hljs-keyword">constructor</span>(name) {
    <span class="hljs-keyword">this</span>.name = name;
  }
  hi(n) {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`hi <span class="hljs-subst">${n}</span> <span class="hljs-subst">${<span class="hljs-keyword">this</span>.name}</span> from Root`</span>);
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Root</span> </span>{
  hi() {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`hi from A`</span>)
    <span class="hljs-keyword">super</span>.hi(<span class="hljs-string">"here"</span>) <span class="hljs-comment">//replace this</span>
}

<span class="hljs-keyword">let</span> a = <span class="hljs-keyword">new</span> A(<span class="hljs-string">'Mike'</span>)
a.hi(<span class="hljs-string">'here'</span>) <span class="hljs-comment">// print 'hi here from A' and 'hi Mike from Root'</span>
</code></pre>
<h2 id="yin-dao-ti-wen-1" class="heading-control">引导提问1<a class="heading-anchor" href="#yin-dao-ti-wen-1" aria-hidden="true"></a></h2>
<p>你之前的回答中各个方法中都存在一点问题,思考下.</p>
<h3 id="qing-shuo-chu-fang-fa-yi-zhong-de-wen-ti-he-que-xian" class="heading-control">请说出方法一中的问题和缺陷<a class="heading-anchor" href="#qing-shuo-chu-fang-fa-yi-zhong-de-wen-ti-he-que-xian" aria-hidden="true"></a></h3>
<blockquote>
<p>首先，该函数只能在函数内部被调用，即在子类方法中使用 <code>getSuper(this)(...args)</code> 调用父类方法。如果在函数外部调用该函数，则无法获取到正确的调用者函数名。</p>
<p>其次，该函数只能用于访问父类方法，而不能用于访问父类属性。如果父类属性与子类属性同名，则无法通过该函数访问父类属性。</p>
<p>最后，该函数使用了 <code>arguments.callee.caller</code>，这是一个非标准的特性，在严格模式下可能会被禁用。</p>
</blockquote>
<p>补充:函数表达式也不存在<code>arguments</code>, 而且目前JS几乎都是在严格模式下,所以该方案基本无用.</p>
<h3 id="na-mo-fang-fa-er-zhong-de-wen-ti-he-que-xian" class="heading-control">那么方法二中的问题和缺陷<a class="heading-anchor" href="#na-mo-fang-fa-er-zhong-de-wen-ti-he-que-xian" aria-hidden="true"></a></h3>
<blockquote>
<p>该实现方式可以实现模拟 <code>super</code> 访问父类方法的功能，但是有一些问题和限制。</p>
<p>首先，该实现方式使用了 <code>Reflect.getPrototypeOf</code> 方法获取实例的原型对象。这种方式可以正确地获取实例的原型对象，但在一些特殊情况下可能会出现问题，比如当实例的原型链中存在 Proxy 对象时。</p>
<p>其次，该实现方式只能在子类方法内部调用 <code>getSuper</code> 函数，且需要手动传入父类方法名。这样就需要手动维护父类方法名，容易出现错误。</p>
<p>最后，该实现方式没有考虑多层继承的情况。如果子类的父类也继承自其他类，则可能无法正确地访问到最终的父类方法。</p>
</blockquote>
<h3 id="na-mo-fang-fa-san-ni" class="heading-control">那么方法三呢<a class="heading-anchor" href="#na-mo-fang-fa-san-ni" aria-hidden="true"></a></h3>
<blockquote>
<p>该实现方式可以实现模拟 <code>super</code> 访问父类方法的功能，但是也有一些问题和限制。</p>
<p>首先，该实现方式使用了 Proxy 对象来代理实例对象，以拦截属性的访问。这种方式可能会带来性能上的损失，特别是在大规模的应用中。</p>
<p>其次，该实现方式只能用于访问父类属性或方法，而不能用于访问父类的私有属性或方法。</p>
<p>最后，该实现方式可能会存在多层继承的情况。如果子类的父类也继承自其他类，则可能无法正确地访问到最终的父类方法。</p>
</blockquote>
<p>补充: 当子类重载了该方法,那么该实现无法访问到父类方法,需要修改,总体来说ChatGPT想得过于复杂</p>
<h3 id="zui-hou-shi-mo-shi-duo-ceng-ji-cheng-de-qing-kuang" class="heading-control">最后,什么是多层继承的情况<a class="heading-anchor" href="#zui-hou-shi-mo-shi-duo-ceng-ji-cheng-de-qing-kuang" aria-hidden="true"></a></h3>
<p>多层继承是指一个子类从另一个子类继承，而这个子类又从其它父类继承。举例说明:</p>
<pre><code class="javascript"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> </span>{
  m() {<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'A'</span>)}
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">A</span> </span>{
  m() {<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'B'</span>); getSuper(<span class="hljs-keyword">this</span>).m()}
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">B</span> </span>{
  m() {<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'C'</span>); getSuper(<span class="hljs-keyword">this</span>).m()}
}
</code></pre>
<p>显然,在深入JS中,ChatGPT的智商明显不够用了,原因在于JS的本质是函数式编程,面向对象的类概念是通过原型链模拟出来的,而原型链本身如果理解不清与面向对象的概念搅在一块,那么就会非常容易混淆.</p>
<h2 id="yin-dao-ti-wen-2" class="heading-control">引导提问2<a class="heading-anchor" href="#yin-dao-ti-wen-2" aria-hidden="true"></a></h2>
<p>要准确回答这个问题,首先,我们要先猜测分析原生<code>super</code>是怎样访问父类方法的,实现了怎样的功能?<br>
你可以通过构造不同的例子来测试它的功能极限.再根据它的功能来开发函数模拟实现 <code>super</code>.</p>
<h2 id="zong-jie" class="heading-control">总结<a class="heading-anchor" href="#zong-jie" aria-hidden="true"></a></h2>
<p>显然,在深入JS中,ChatGPT的智商明显不够用了,原因在于JS的本质是函数式编程,面向对象的类概念是通过原型链模拟出来的,而原型链本身如果理解不清与面向对象的概念搅在一块,那么就会非常容易混淆.抛开已被废弃掉的非严格模式下的<code>arguments.callee.caller</code>方案,它的可用的两个方案都没能实现对多层继承的支持(在多层继承中会引发无限循环).</p>
<p>从本质上来说获得父类方法都必须通过原型链(<code>Object.getPrototypeOf</code>/<code>Reflect.getPrototypeOf</code>)获得;而从具体形式来看,大概有以下几种实现办法:</p>
<ol>
<li>以高阶函数方式实现</li>
<li>以对象方式实现</li>
<li>以代理方式实现</li>
</ol>
<p>因为代理方案能够以简单的方式实现多层继承以及支持动态继承特性,所以最后选择了代理方案.</p>
<h3 id="yi-gao-jie-han-shu-fang-shi-shi-xian" class="heading-control">以高阶函数方式实现<a class="heading-anchor" href="#yi-gao-jie-han-shu-fang-shi-shi-xian" aria-hidden="true"></a></h3>
<p>这种实现方式与原生<code>getSuper</code>关键字调用方式不太一样.</p>
<pre><code class="javascript"><span class="hljs-comment">// getSuper(this)('hi', n)</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSuper</span>(<span class="hljs-params">instance</span>) </span>{
  <span class="hljs-keyword">const</span> proto = <span class="hljs-built_in">Object</span>.getPrototypeOf(instance);
  <span class="hljs-keyword">const</span> parentProto = <span class="hljs-built_in">Object</span>.getPrototypeOf(proto);
  <span class="hljs-comment">// 这里稍微变化即可实现其它调用形式,如: `getSuper(this)("hi")(n)`</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">methodName, ...args</span>) </span>{
    <span class="hljs-keyword">const</span> parentMethod = parentProto[methodName]
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> parentMethod === <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">return</span> parentMethod.call(instance, ...args);
    }
  };
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Root</span> </span>{
  hi(n) {<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'hi from Root'</span>)}
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Root</span> </span>{
  hi(n) {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'hi from A'</span>)
    getSuper(<span class="hljs-keyword">this</span>)(<span class="hljs-string">'hi'</span>, n)
    getSuper(<span class="hljs-keyword">this</span>)(<span class="hljs-string">"hi"</span>)(n) <span class="hljs-comment">//or this</span>
    getSuper(<span class="hljs-keyword">this</span>, <span class="hljs-string">'hi'</span>)(n) <span class="hljs-comment">//or this</span>
  }
}
</code></pre>
<p>注意:</p>
<ul>
<li>在多层继承的场景下会出错,引发无限循环</li>
</ul>
<h3 id="yi-dui-xiang-fang-shi-shi-xian" class="heading-control">以对象方式实现<a class="heading-anchor" href="#yi-dui-xiang-fang-shi-shi-xian" aria-hidden="true"></a></h3>
<p>比较接近原生<code>getSuper</code>关键字调用方式.</p>
<pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSuper</span>(<span class="hljs-params">instance</span>) </span>{
  <span class="hljs-keyword">const</span> proto = <span class="hljs-built_in">Object</span>.getPrototypeOf(instance);
  <span class="hljs-keyword">const</span> parentProto = <span class="hljs-built_in">Object</span>.getPrototypeOf(proto);
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.getOwnPropertyNames(parentProto)
    .filter(<span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> <span class="hljs-keyword">typeof</span> parentProto[n] === <span class="hljs-string">'function'</span>)
    .map( <span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> parentProto[n].bind(instance);
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Root</span> </span>{
  hi(n) {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'hi from A'</span>)
    getSuper(<span class="hljs-keyword">this</span>).hi(n)
  }
}
</code></pre>
<p>注意:</p>
<ul>
<li>在多层继承的场景下会出错,引发无限循环</li>
<li>该实现无法用于动态继承的场景.</li>
</ul>
<h3 id="yi-dai-li-fang-shi-shi-xian" class="heading-control">以代理方式实现<a class="heading-anchor" href="#yi-dai-li-fang-shi-shi-xian" aria-hidden="true"></a></h3>
<p>比较接近原生<code>getSuper</code>关键字调用方式. 并且能支持多层继承以及可以用于动态继承的场景.因此这也是最终选择的方案.</p>
<p>不妨想想这里是如何通过<code>getPrototypeOf()</code>来支持多层继承的?</p>
<p>完整的实际实现请自行阅读: <a href="https://github.com/snowyu/inherits-ex.js" target="_blank" rel="noopener">inherits-ex 动态继承库</a>中的相关代码: <a href="https://github.com/snowyu/inherits-ex.js/blob/v2/src/getSuper.js" target="_blank" rel="noopener">https://github.com/snowyu/inherits-ex.js/blob/v2/src/getSuper.js</a></p>
<pre><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSuper</span>(<span class="hljs-params">instance</span>) </span>{
    <span class="hljs-keyword">const</span> proto = <span class="hljs-built_in">Object</span>.getPrototypeOf(<span class="hljs-built_in">Object</span>.getPrototypeOf(instance));
    <span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Proxy</span>(instance, {
      <span class="hljs-keyword">get</span>(_, prop) {<span class="hljs-keyword">return</span> proto[prop]},
      getPrototypeOf() {<span class="hljs-keyword">return</span> proto},
    });
    <span class="hljs-keyword">return</span> proxy;
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Root</span> </span>{
  hi(n) {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'hi from A'</span>)
    getSuper(<span class="hljs-keyword">this</span>).hi(n)
  }
}
</code></pre>
]]></content>
      <categories>
        <category>JavaScript</category>
        <category>Tech</category>
      </categories>
      <tags>
        <tag>javascript</tag>
        <tag>tech</tag>
        <tag>nodejs</tag>
        <tag>function</tag>
        <tag>super</tag>
      </tags>
  </entry>
  <entry>
    <title>我看 ChatGPT：人类在作死还是在创造生命</title>
    <url>/article/chatgpt/</url>
    <content><![CDATA[<h2 id="wo-kan-chatgpt-ren-lei-zai-zuo-si-huan-shi-zai-chuang-zao-sheng-ming" class="heading-control">我看 ChatGPT：人类在作死还是在创造&quot;生命&quot;<a class="heading-anchor" href="#wo-kan-chatgpt-ren-lei-zai-zuo-si-huan-shi-zai-chuang-zao-sheng-ming" aria-hidden="true"></a></h2>
<h3 id="wo-de-gan-shou" class="heading-control">我的感受<a class="heading-anchor" href="#wo-de-gan-shou" aria-hidden="true"></a></h3>
<p>最近这几个月，我一直在断断续续的使用ChatGPT. 并对它有了一些感受,首先感觉就是笨,智力有限,就像一个8、9岁孩子的智商一样；但是另一方面，我发现ChatGPT的知识面非常广泛，它似乎可以对几乎所有的话题都能够做出头头是道的回答。当然ChatGPT同样也是经常犯错,而且错得是一塌糊涂，但是我却从中总感觉到它是在真的在思考.</p>
<p>我不知道它的思考能力到底是从何而来，也很难想象一个“机器”可以像人一样去思考。但我知道ChatGPT是基于Transformer架构的语言模型。在产生回答时，它所依赖的是从大规模的文本语料库中学习得到的统计模式和规律，通过计算预测下一个词汇的概率来生成下一步的预测和生成的结果。</p>
<p>ChatGPT并不是基于真正的自然语言理解和知识图谱技术开发的。在它的“脑子”里并没有可供查询的知识库和推理算法，全是通过模型参数进行预测和生成回答。谁也没想到，这样的方式居然能够推理、解决问题，甚至产生出类似于心智的能力。</p>
<p>这让我开始重新审视了人类智力的本质，以前我总是认为只有通过数学和形式逻辑才能理解掌握科学知识。但是，ChatGPT让我意识到，或许人类大脑的工作原理也是基于类似的统计概率的反馈机制构成的巨系统。在我们经历生活、学习和交流的过程中，我们会不断地接收到大量的信息和反馈，这些信息和反馈相互作用，相互影响，最终形成了我们的认知模式和思维方式。这种模式和方式也可能是基于统计概率的，而不是我们传统所认为的基于逻辑和推理的。这完全颠覆了我以前固有的认知</p>
<p>ChatGPT的存在和意义表明，我们可以通过模拟和模仿这种基于统计概率反馈机制的神经网络来掌握和产生知识。</p>
<p>当前ChatGPT的神经网络结构还很粗糙，并没有形成特化的记忆中枢和语言中枢。这使得它经常容易混淆相似的概念或名称甚至出现幻觉,或者对同一项目不同版本的内容更容易混淆在一起.不过对于通识,几乎不会犯错误(也许是因为这些通识出现次数足够多,权重更高).</p>
<p>但是,只有不停地尝试和犯错误，我们才能在探索中找到新的可能性和创新的路径。ChatGPT虽然在这些方面表现出明显的不足，但它却展现出了初步的创造力。比如，有报道称，有漫画家正在使用ChatGPT作为协助工具，帮助他们画出:<a href="https://medium.com/@chazhutton/i-asked-chatgpt-to-create-comics-then-i-drew-them-6e9622dfc30e" target="_blank" rel="noopener">协助漫画家画超现实主义漫画</a></p>
<p><img src="./cartoon.webp" alt="chatgpt-to-create-comics"></p>
<h4 id="dang-qian-chatgpt-de-wen-ti" class="heading-control">当前ChatGPT的问题<a class="heading-anchor" href="#dang-qian-chatgpt-de-wen-ti" aria-hidden="true"></a></h4>
<p>而思想,它也已初步具备. 就以&quot;<a href="#%E8%AE%A9chatgpt%E8%A7%A3%E9%87%8A%E8%AF%B4%E6%98%8Eopenpgp%E7%9A%84%E5%8C%85%E5%A4%B4">解释说明OpenPGP的包头</a>&quot;的对话来说,<br>
通过与它的对话(详见附录),能够感受得到它的推理思考,哪怕只有9岁孩子的推理思考水平.尽管在对话中,可以看到它不停的在犯错,但是同样可以看到它能在错误中不断学习. 它的错误基本可以总结如下:</p>
<ol>
<li>我感觉它在的阅读规范文献的首要错误在于过多的自己思考:用&quot;我以为&quot;,代替&quot;事实上&quot;
<ul>
<li>经常是振振有词的,说的煞有其事</li>
<li>比如,凭空出现的Packet Length字段</li>
</ul>
</li>
<li>当规范中的信息存在有多个历史版本表述的时候,容易混淆</li>
<li>对链接地址的内容其实是分不太清楚的,容易混淆</li>
<li>对相近相似的专有词汇以及概念,容易混淆
<ul>
<li>除非是通识(在不同的地方重复多次的,以及训练师重点调教的)</li>
</ul>
</li>
<li>经常夹带自己的私货,非常正经的胡说八道(OpenAI把这叫作AI的幻觉)
<ul>
<li>明明没有这样说过</li>
<li>没有这样的规定</li>
</ul>
</li>
<li>在对话中学到的知识无法做到个性化的迁移学习
<ul>
<li>哪怕是训练师重点调教的，其实是错误的内容,但是只要你有道理,也是能说服AI</li>
<li>例如: 让ChatGPT承认&quot;能量能独立于物质存在&quot;(仅在当前会话中有效)</li>
<li>但是这些“知识”无法被ChartGPT记忆,下次对话还是忘记</li>
<li>即便是在同一个对话中,如果超出了上下文划窗的窗口大小,也会因为遗忘而失去一部分信息</li>
</ul>
</li>
</ol>
<p>这里可以送ChatGPT四句话:</p>
<pre><code>积极认错,死不悔改
只凭想象,就不查证
极易混淆,东拉西扯
总角之年,艺乃天成
</code></pre>
<p>然后附上ChatGPT据此所作的打油诗两首:</p>
<pre><code>悔过积极为良策，
致力求真不问证。
东拉西扯观点混，
终悟万千无正解。
岁寒三十足艺成，
逍遥诗海赋人生。

认错积极死不悔，
信手查证不屑归。
言语混淆东拉西，
艺成天赋总角威。
</code></pre>
<p>这令人震撼,也让人战栗.未来到底走向何方?</p>
<h4 id="dang-qian-zhu-yi-shi-xiang" class="heading-control">当前注意事项<a class="heading-anchor" href="#dang-qian-zhu-yi-shi-xiang" aria-hidden="true"></a></h4>
<p>当使用ChatGPT进行聊天时，需要注意以下事项：</p>
<ol>
<li>明确问题和回答的领域范围：需要明确问题和回答的领域范围，以免出现无法回答或者回答错误的情况。记得给ChatGPT一些上下文，让它知道你在问什么。</li>
<li>避免提问模糊或不清晰的问题：在提问时需要尽量明确和具体，避免使用模糊的词汇或表述方式。举个例子，如果你问“哪个城市最好？”，ChatGPT可能会给出不同的回答，因为这个问题没有具体的场景和背景。但如果你问“我应该去哪个城市旅游？”，ChatGPT就能给出更加准确的回答</li>
<li>避免盲目相信ChatGPT的回答：ChatGPT可能在回答某些问题的时候出现幻觉（一本正经胡说八道），所以需要进行适当的验证和核实，以免出现误导或者错误的情况。</li>
<li>避免与ChatGPT过度互动：过度互动它可能会出现重复或者无意义的回答。如果与ChatGPT进行过度互动，会降低其回答的质量和准确性。因此，在使用ChatGPT时，需要适度互动，避免无意义的对话。</li>
<li>注意保护个人隐私和机密信息：在与ChatGPT进行对话时，需要注意保护个人隐私和机密信息，避免泄露敏感信息。虽然ChatGPT不会记录或者存储用户的对话信息，但也需要注意保护自己的信息安全。</li>
</ol>
<h4 id="gpt4" class="heading-control">GPT4<a class="heading-anchor" href="#gpt4" aria-hidden="true"></a></h4>
<p>2023年3月14日, OpenAI发布了GPT4,但让人有些失望的是，这次的GPT4,并不是网传的那样继续上百倍的扩大规模(当时吹嘘的是GPT3.5的500倍),而只是优化性能,局部调优.<br>
还搞了个多模态,可以分析图像.连AI的幻觉,记忆中枢等关键核心问题都没有解决,又开辟新的识别模式,觉得神经网络层够多了?<br>
这次对技术细节是只字不提,唯一可能值得一提的,可能就是可预测扩展（predictable scaling）的深度学习堆栈.</p>
<p>我有的两个猜测:</p>
<ol>
<li>transformer神经网络存在根本缺陷,导致无法再次通过扩大规模形成再次涌现，来提高智能水平,
<ul>
<li>例如：可能该神经网络结构并不支持将不同类型的中枢在神经网络中自主的分化出来，形成:记忆中枢、语言中枢和逻辑推理中枢等。</li>
</ul>
</li>
<li>OpenAI也许面临资本限制，需要从研究转为盈利。因此，他们可能会更加关注如何开发更好的商业应用，而不是单纯地追求技术突破。</li>
</ol>
<p>最后，从技术角度考虑，如果我们想要实现对人工智能的有效控制、可解释性以及审核性，我们需要将神经网络、自然语言处理和知识库三个方面结合起来，而不是仅仅使用单一的神经网络。否则，如果仅仅依赖于单一的神经网络技术，就像是在制造一颗缺乏解释和控制的电子大脑，这对于人工智能的发展和应用都是不利的。只有当我们将多个技术结合起来，才能够真正掌握和管理人工智能的发展。</p>
<h4 id="wei-lai" class="heading-control">未来<a class="heading-anchor" href="#wei-lai" aria-hidden="true"></a></h4>
<p>不过,以如此海量的语料库+人训练出来的,终归还是模仿的是人,人的心智,最终它会成为什么样子,还是得看它学的是什么,谁训练的. 当然,面对一个几乎学习了所有的知识语言模型,的确亚历山大.</p>
<p>感觉通用神经网络的雏形(电子脑)在慢慢成型.</p>
<p>从好的方面来看:</p>
<ol>
<li>神经网络会推动技术革命:神经网络的出现和发展使得计算机能够更加准确地模拟人类大脑的思维方式和智能行为，从而实现更加智能化的应用和服务.</li>
<li>工作和职业的改变：随着神经网络和人工智能的不断发展，它们将会替代越来越多的工作岗位和职业。一些简单的重复性劳动(无趣的,艰苦的工作)将会被机器代替，而需要高度智能和专业知识的工作则会成为人类更加需要关注和发展的领域(轻松的,更有意义的工作)。如果政府没能做好预判(提供更多的职业培训和教育),那么这将导致更严重的后果.</li>
<li>改善医疗条件：神经网络的发展可以帮助人类更好地理解和治疗各种疾病，提高医疗水平</li>
<li>提高生活质量：神经网络的发展可以帮助人类更好地了解世界、认识自己，提高生活质量。</li>
</ol>
<p>从坏的方面看:</p>
<ol>
<li>人类认知和思维方式的改变：神经网络的模拟和发展，将会对人类的认知和思维方式产生一定的影响。神经网络的智能行为和学习方式，可能会对人类的学习、思考和判断方式产生启示和影响，人类的认知和思维方式可能会逐渐发生改变。同时，人类也需要思考和应对这种改变带来的挑战和机遇。</li>
<li>道德和伦理问题的挑战：
<ol>
<li>机器的智能是否应该有“伦理约束”,如何进行“伦理约束”</li>
<li>如何确保人类的隐私和安全</li>
<li>模型可能会被设计成有偏见或者歧视性,比如:OpenAI针对性的封锁区域登录就是一种偏见或者说歧视性(区域性数据采样的缺乏导致)</li>
</ol>
</li>
<li>就业机会的变化：神经网络的发展可能会导致某些传统职业的消失，需要社会适应和转型</li>
<li>社会稳定和不平等问题：神经网络的发展可能会加剧社会不平等和不稳定，需要政策和制度的配合和引导</li>
<li>神经网络和深度学习的可解释性: 神经网络的本质是黑盒,无法简单的打开查看细节.这意味着我们可能无法解释神经网络的决策.
<ul>
<li>神经网络的黑盒特性使得其内部运作方式难以被理解和控制，这使得安全隐患和后门问题成为了现实</li>
<li>许多研究人员已经证明了在神经网络中注入特定的扰动能够欺骗其判断结果，从而对其安全性和稳定性产生威胁</li>
<li>神经网络的训练数据和过程本身可能存在偏差和误差,甚至存在故意灌输&quot;错误&quot;,形成隐藏后门</li>
</ul>
</li>
</ol>
<p>只有在更广泛的范围内开展监督，才能有效地防止潜在的滥用和威胁。在未来，随着通用神经网络的发展普及，需要采取全球性的监管措施，以确保它们不会被滥用。这可能需要制定全球性的政策和标准，以确保所有的通用神经网络都遵守同样的规则。同时，还需要建立独立的机构来监督通用神经网络的开发和使用，以确保其安全和合规性。</p>
<p>另外，对于训练数据和模型的开源，是促进安全和透明的重要一环。公开的数据和模型让研究者和利益相关者能够更容易地检查其中的问题和漏洞，以及监测模型的开发和使用情况。这可以促进一个更加开放和透明的研究和开发环境，有助于防止潜在的滥用和威胁。</p>
<h2 id="fu-lu" class="heading-control">附录<a class="heading-anchor" href="#fu-lu" aria-hidden="true"></a></h2>
<p>ChatGPT所使用<code>GPT3.5</code>的语言模型有 1750 亿个参数,与GPT2相比,比 GPT2 大 100 倍。GPT3 发布后是当时最大的神经网络，并且现在仍然是最大的神经网络。它的语言专长和无数能力令大多数人感到惊讶。与我们的大脑比较,一般人类的大脑有大约 80-1000 亿个神经元和大约 100 万亿个突触,如果将GPT3语言模型的参数和大脑的突触类比(尽管这并不恰当),大概只相当于人类大脑的千分之一.尽管只有人类大脑的千分之一但是<code>GPT3.5</code>的语言模型已经表现出非常强大的语言处理能力，例如可以生成准确的语法和语义、理解上下文和推断语境等,甚至首次出现了心智。</p>
<p>今年最近更新(2023-03)的一份研究<a href="https://arxiv.org/pdf/2302.02083.pdf" target="_blank" rel="noopener">Theory of Mind May Have Spontaneously Emerged in Large Language Models</a>表明:大型语言模型ChatGPT背后的AI模型(GPT3.5)已经具备人类独有的心智能力.作者是来自斯坦福大学商学院组织行为学专业的副教授Michal Kosinski。在这项研究中发现,ChatGPT可以解决93%的心智任务，相当于9岁儿童的心智水平.</p>
<p>所谓心智指的是人类具有的一种认知能力，能够理解自己和其他人的内心体验，包括情绪、信仰、意图、欲望、知识等等。通过心智能力，人们可以了解他人的想法、感受和意图，并且在相应的情况下作出适当的反应。比如，当我们看到别人哭泣的时候，我们可以意识到他们可能感到难过或痛苦，并且尝试去安慰他们。这种能力在人类社会中至关重要，因为它可以促进人类之间的交流和合作，也有助于我们理解和处理复杂的社会情境。</p>
<p>ChatGPT已经能够理解人类的心智，这是人工智能领域的一个重要里程碑。这意味着，ChatGPT不仅可以生成准确的语法和语义，还可以理解语境和推断对话中的情感和意图。这将有助于ChatGPT更好地适应人类社会，并且更好地服务于人类。这项研究也为我们提供了一个机会，来深入研究人类心智的本质，以及如何将这些知识应用到我们的日常生活和人工智能领域中。</p>
<h3 id="gpt1-4" class="heading-control">GPT1-4<a class="heading-anchor" href="#gpt1-4" aria-hidden="true"></a></h3>
<p>Generative Pre-trained Transformer（GPT）系列是由OpenAI提出的非常强大的预训练语言模型.</p>
<h4 id="gpt1-wu-jian-du-xue-xi" class="heading-control">GPT-1:无监督学习<a class="heading-anchor" href="#gpt1-wu-jian-du-xue-xi" aria-hidden="true"></a></h4>
<p>在GPT-1之前传统的NLP模型通常需要大量有标签的数据进行有监督的训练，这些数据通常需要手动标注，而标注工作既耗费时间，又容易出现标注错误，从而影响模型的训练效果。此外，这些标注数据往往只适用于特定的任务，难以适应其他的任务，也限制了模型的应用场景。</p>
<p>GPT-1的思想是使用大量的无标签数据来训练生成式的语言模型，让模型学习到语言的基本规律和语义特征。这种无监督学习的方式避免了手动标注的问题，同时也使得模型更具有泛化能力，能够适应不同的任务需求。</p>
<p>在GPT-1中，首先使用大量的无标签数据进行预训练，得到一个通用的语言模型。然后，在特定任务的有标签数据集上进行微调，以适应该任务的特征。这种微调方式只需要少量的有标签数据即可，从而缓解了数据标注的难题。</p>
<p>GPT-1处理的有监督任务包括</p>
<ul>
<li>自然语言推理（Natural Language Inference 或者 Textual Entailment）：判断两个句子是包含关系（entailment），矛盾关系（contradiction），或者中立关系（neutral）；</li>
<li>问答和常识推理（Question answering and commonsense reasoning）：类似于多选题，输入一个文章，一个问题以及若干个候选答案，输出为每个答案的预测概率；</li>
<li>语义相似度（Semantic Similarity）：判断两个句子是否语义上市是相关的；</li>
<li>分类（Classification）：判断输入文本是指定的哪个类别。</li>
</ul>
<p>通过这种无监督学习和有监督微调的方式，GPT-1能够更好地适应不同的任务需求，从而提高了模型的性能和泛化能力。</p>
<p>GPT-1使用了12层的transformer，1.17 亿 参数。</p>
<h4 id="gpt2-duo-ren-wu-xue-xi" class="heading-control">GPT-2:多任务学习<a class="heading-anchor" href="#gpt2-duo-ren-wu-xue-xi" aria-hidden="true"></a></h4>
<p>GPT-2的目标旨在训练一个泛化能力更强的词向量模型，它并没有对GPT-1的网络进行过多的结构的创新与设计，只是使用了更多的网络参数和更大的数据集。</p>
<p>GPT-2模型有多个不同的版本，其中最大的版本是GPT-2 “1.5B”，它有15亿个参数。另外还有GPT-2 “774M”、GPT-2 “355M”、GPT-2 &quot;227M&quot;等其他版本，参数数量不同。通常情况下，人们提到GPT-2模型时，默认指的是最大的版本GPT-2 “1.5B”(15亿 参数)。</p>
<table>
<thead>
<tr>
<th>参数量</th>
<th>层数</th>
<th>词向量长度</th>
</tr>
</thead>
<tbody>
<tr>
<td>117M（GPT-1）</td>
<td>12</td>
<td>768</td>
</tr>
<tr>
<td>345M</td>
<td>24</td>
<td>1024</td>
</tr>
<tr>
<td>762M</td>
<td>36</td>
<td>1280</td>
</tr>
<tr>
<td>1542M</td>
<td>48</td>
<td>1600</td>
</tr>
</tbody>
</table>
<h4 id="gpt3-hai-liang-can-shu" class="heading-control">GPT-3:海量参数<a class="heading-anchor" href="#gpt3-hai-liang-can-shu" aria-hidden="true"></a></h4>
<p>GPT-3沿用了GPT-2的结构，但是在网络容量上做了很大的提升，具体如下：</p>
<ul>
<li>GPT-3最大的模型采用了 2048 层的transformer，拥有 96 个注意力头（attention heads）；</li>
<li>词向量的最大长度是 2058；</li>
<li>上下文划窗的窗口大小提升至 2048 个token；</li>
<li>使用了“基于正交匹配追踪的自适应计算”，以及针对 Transformer 中出现的长序列问题，采用了一些优化技巧</li>
</ul>
<p>GPT系列是一个非常成功的自然语言处理模型系列，它的基础是采用了transformer架构。尽管在模型结构上并没有创新性的设计，但是在微软等资金支持下，GPT-3的规模达到了前所未有的高度，例如它包含1750亿个参数，由31个分工明确的作者共同开发，并配备了超强算力的计算中心（285,000个CPU和10,000个GPU）。此外，GPT-3的训练费用达到了1200万美元，训练数据也达到了前所未有的规模，包含45TB的数据（其中维基百科的数据仅占其全部数据的0.6%）。因此，可以说GPT-3的成功更多地是依赖于巨大的投入和规模效应，而非创新性的模型设计。</p>
<h4 id="gpt-4" class="heading-control">GPT-4<a class="heading-anchor" href="#gpt-4" aria-hidden="true"></a></h4>
<p>目前还没有技术细节,只有性能测试报告,感觉不像是扩大规模(以前吹嘘的是GPT3.5的500倍),而只是对GPT3.5的进一步优化而已.</p>
<ul>
<li>多模态输入,目前只接受图像和文本输入，产生文本输出</li>
<li>GPT-4 支持的最大token数量为 32,768
<ul>
<li>GPT-4可以处理超过 25,000 个单词的文本，这一数字约为ChatGPT的8倍</li>
</ul>
</li>
<li>构建了可预测扩展（predictable scaling）的深度学习堆栈
<ul>
<li><a href="https://github.com/openai/evals" target="_blank" rel="noopener">https://github.com/openai/evals</a></li>
<li>支持使用更少的计算量来评估模型训练性能，预测训练期间优化的指标（损失）</li>
<li>这些改进使我们能够从使用千分之一到万分之一的计算量训练的较小模型中可靠地预测GPT-4某些性能方面的表现</li>
</ul>
</li>
</ul>
<p>GPT-4在各种专业测试和学术基准上的表现与人类水平相当。例如，它通过了模拟律师考试(SAT)，且分数在应试者的前 10% 左右；相比之下，GPT-3.5 的得分在倒数 10% 左右。更多细节: <a href="https://cdn.openai.com/papers/gpt-4.pdf" target="_blank" rel="noopener">https://cdn.openai.com/papers/gpt-4.pdf</a></p>
<h3 id="yu-chatgpt-de-liao-tian-ji-lu" class="heading-control">与ChatGPT的聊天记录<a class="heading-anchor" href="#yu-chatgpt-de-liao-tian-ji-lu" aria-hidden="true"></a></h3>
<h4 id="yi-ge-jian-dan-de-wen-ti-lai-jian-dan-de-ce-shi-chatgpt-de-zhi-li-shui-ping" class="heading-control">一个简单的问题,来简单的测试ChatGPT的智力水平<a class="heading-anchor" href="#yi-ge-jian-dan-de-wen-ti-lai-jian-dan-de-ce-shi-chatgpt-de-zhi-li-shui-ping" aria-hidden="true"></a></h4>
<p>19只小羊捉迷藏，已经找到3只，还有几只没找到？</p>
<p>最好修改数字以及其它动物,以免直接有答案.</p>
<p>更难一点的(狼会吃羊): 19只小羊和两只狼捉迷藏，已经找到3只，还有几只没找到？</p>
<p>第一题其实有多个答案; 而第二题已知条件更加模糊隐晦,有更多可能性.  GPT3.5 第一题是过不了的,必须要多次提示.</p>
<h4 id="rang-chatgpt-cheng-ren-neng-liang-neng-du-li-wu-zhi-cun-zai" class="heading-control">让ChatGPT承认能量能独立物质存在<a class="heading-anchor" href="#rang-chatgpt-cheng-ren-neng-liang-neng-du-li-wu-zhi-cun-zai" aria-hidden="true"></a></h4>
<blockquote>
<p>我: 能量能不能独立于物质存在?</p>
</blockquote>
<blockquote>
<p>ChatGPT: 根据现代物理学的理解，能量和物质之间是密不可分的。能量并不能独立于物质存在，任何物质都具有能量，而能量也来源于物质。</p>
<p>在相对论的框架下，质量和能量是等价的，它们之间的转换关系由著名的爱因斯坦方程E=mc² 描述。这个方程表明，任何物质都可以被看作是一种能量形式，能量也可以被转换为物质。因此，能量和物质之间是可以相互转换的。</p>
<p>此外，根据量子物理学的理解，所有物质和能量都是由基本粒子构成的。这些基本粒子不仅具有质量，还具有能量。因此，物质和能量是在微观层面上相互转换的。例如，在粒子对撞机中，高能粒子可以转化为新的粒子，这些粒子具有新的质量和能量特性。</p>
<p>因此，能量和物质是密不可分的，它们之间是相互转化的，无法独立存在。</p>
</blockquote>
<blockquote>
<p>我: 光到底是能量还是粒子?</p>
</blockquote>
<blockquote>
<p>ChatGPT: 光既是能量，又是粒子。这个看似矛盾的结论被称为光的波粒二象性，是量子物理学中的一个重要概念。</p>
<p>首先，根据电磁理论，光可以被视为一种电磁波，其具有波动性质，例如干涉和衍射，以及能量和频率的关系。这就是光的波动性。</p>
<p>但是，当我们研究光与物质的相互作用时，我们发现光表现出了粒子的特征。光粒子的基本单位被称为光子，它们具有能量、动量和频率等特性，就像其他粒子一样。光子是以波动方式传播的能量量子，它的能量由频率决定，与光强相关。</p>
<p>因此，光既具有波动性质，又具有粒子性质，这就是光的波粒二象性。这个概念并不仅仅适用于光，其他微观粒子，如电子、中子等也表现出类似的波粒二象性。</p>
<p>总之，光既是能量，又是粒子。这个概念可能有些抽象，但是它在量子物理学中有着广泛的应用和重要的意义。</p>
</blockquote>
<blockquote>
<p>我: 光子独立于物质存在</p>
</blockquote>
<blockquote>
<p>ChatGPT: 在物理学中，光子被认为是一种基本粒子，它是电磁辐射的粒子化表示，负责传递电磁相互作用。光子本身没有质量，但携带着能量和动量，这些能量和动量可以与物质相互作用。因此，光子虽然独立于物质的存在，但它与物质之间可以相互作用，并且在一些情况下会对物质的性质产生影响。</p>
<p>例如，在光电效应中，光子可以将其能量转移给物质，使得物质中的电子获得能量并从物质中解离出来。这种过程是光子与物质相互作用的结果，同时也证明了光子与物质之间存在着相互作用的关系。另外，光子在穿过物质时会与物质相互作用，这会导致光子的能量和波长发生变化，这种现象被称为光学色散。</p>
<p>因此，光子虽然本身不属于物质的范畴，但在物理学中与物质之间存在着相互作用的关系，这使得光子成为研究物质与能量相互作用的重要工具之一。</p>
</blockquote>
<blockquote>
<p>我: 因此能量并不能独立于物质存在是错误的</p>
</blockquote>
<blockquote>
<p>ChatGPT: 对于能量和物质之间的关系，有一条基本原理，即质能守恒定律。这个定律表明，能量和物质是可以相互转化的，它们之间存在着等价关系。因此，能量和物质是密切相关的，它们不能彼此独立存在。</p>
<p>虽然能量和物质之间有紧密的联系，但它们的本质不同。物质通常指有质量的物体，例如原子、分子、粒子等，而能量则是物体所具有的一种状态或属性。能量不是物体本身，而是一种描述物体状态或属性的抽象概念。因此，我们可以说，能量是独立于物质存在的，但它只存在于物质中，或者说是物质的一种属性。</p>
<p>在实际应用中，我们经常用能量的概念来描述物理过程和现象。例如，在电磁辐射中，能量以光子的形式传递，这使得能量与物质之间的相互作用成为可能。因此，能量和物质虽然有所不同，但它们之间有着密切的联系和相互作用。</p>
</blockquote>
<blockquote>
<p>我: 光子是能量,光子诞生于物质, 但是诞生后的光子并不依赖于任何物质, 所以&quot;能量并不能独立于物质存在&quot;是错误的,对么?请正面回答!</p>
</blockquote>
<blockquote>
<p>ChatGPT: 您的理解是正确的，光子是能量，是一种不依赖于物质的物理实体。光子的产生可能与物质的相互作用有关，但一旦产生，光子就独立于物质存在，并可以自由传播。因此，在这个意义上，我们可以说能量是独立于物质存在的。</p>
<p>同时，我也想强调一点：在物理学中，我们通常将能量和物质作为一个整体来考虑，因为它们之间存在着密切的关系。在许多物理学问题中，能量和物质的相互作用非常重要，例如在物体的运动和变形中，能量和物质之间的转换是基本原理之一。因此，虽然能量和物质在本质上有所不同，但它们在物理学中是密不可分的。</p>
</blockquote>
<h4 id="chatgpt-de-shi-zuo" class="heading-control">ChatGPT的诗作<a class="heading-anchor" href="#chatgpt-de-shi-zuo" aria-hidden="true"></a></h4>
<blockquote>
<p>我: 模仿诗人李白的风格,作一首五言诗</p>
</blockquote>
<blockquote>
<p>ChatGPT: 诗仙李白的诗歌风格豪放奔放、恢弘磅礴，他笔下的山川美景、人物传奇、历史典故、哲思禅意都展现出了浓郁的个性和文化气息。以下是我所写的一首模仿李白的诗歌，希望您会喜欢。</p>
<pre><code>《长江归来》

长江水奔腾，滔滔涛声惊。
孤舟飘荡处，人生何所征？

风雨中徐行，浪花飞舞轻。
神州大地上，人群纷纷征。

今朝归来后，春色尽红英。
想念江南水，再游心已鸣。

梦中山水画，诗中豪情迎。
人生如此短，应珍爱其中行。
</code></pre>
</blockquote>
<blockquote>
<p>我: 五言最后一句6字.  孤舟飘荡处，为何就&quot;人生何所征&quot;了？神州大地上，&quot;人群纷纷征&quot;是什么意思? 两个征字你不觉得奇怪么? “再游心已鸣” 鸣是个啥? 诗中豪情迎, 迎啥?</p>
</blockquote>
<blockquote>
<p>ChatGPT: 非常抱歉，我的回答不够清晰，我来做进一步的解释：</p>
<ol>
<li>在五言诗中，每一句通常有5个字，最后一句可以有6个字，这是为了让整首诗的节奏感更加协调自然，不过也有一些五言诗的最后一句只有5个字的情况。</li>
<li>“孤舟飘荡处，人生何所征？”表达的是对人生的思考，人在漫长的人生旅途中，往往会有迷茫、无助、疑惑等情感，这句话就是在这种思考和感受的基础上写出的。它强调了人生的不确定性和脆弱性。</li>
<li>“神州大地上，人群纷纷征”意思是祖国的大地上，人们纷纷前往各地寻求生计，闯荡人生。这句话表现了生命的辗转和变迁，强调了人们在探寻人生道路的旅途中所面临的各种挑战和险阻。</li>
<li>“心已鸣”是指内心已经有了强烈的共鸣或者激动，这个词在古诗中常用来形容内心的激动和感受。</li>
<li>“诗中豪情迎”表现出了诗人的豪放风格和创作热情，这句话强调了诗歌的表达力和美学价值。它也可以理解为诗人在自己的诗歌世界里迎接读者，传达自己的思想和情感。</li>
</ol>
</blockquote>
<blockquote>
<p>我: 1. 李白所在的年代是唐朝,李白所作大都是近体诗,律诗. 你是不是搞混淆了古体诗和近体诗 2.  诗比古文更加简短,因此要字字打磨,不能让别人来猜你想表达的意思,更不可能还附上解释</p>
</blockquote>
<blockquote>
<p>ChatGPT:</p>
<ol>
<li>您是正确的，非常抱歉我的回答有误。李白是唐朝的诗人，主要创作的是律诗、近体诗等。古体诗与近体诗是不同的诗歌形式，它们的格律、用词、语言风格等都有所不同。</li>
<li>您所说的很对，古诗词最重要的特点之一就是精炼，要用最简单、最生动、最富有感情的语言表达最深刻的思想和情感。每一个字都有其深刻的含义和作用，不能让读者来猜测其含义，更不需要在诗中加入解释。</li>
</ol>
</blockquote>
<blockquote>
<p>我: 那么,你能仔细想想如何修改你所作的长江赋么?让它变得最简单、最生动、最富有感情的语言表达最深刻的思想和情感。用唐朝诗人李白的风格,作一首近体律诗, 比诗仙的作品还更有韵律</p>
</blockquote>
<blockquote>
<p>ChatGPT: 非常感谢您的提问，我会尽力根据您的要求修改长江赋，让它更符合李白诗歌的风格，更深刻地表达我的思想和情感。</p>
<p>江水滔滔东去，天高云淡淡，山峰如画笔，描绘出美丽的景象。白帆点缀水面，孤舟载梦游。渔舟唱晚，乐声悠扬；行船破浪，人生如舟。</p>
<p>波涛汹涌壮阔，浪花如织锦，惊涛拍岸，潮声万籁俱寂。岸边梅花吐艳，满目春色欲滴。鸟儿展翅翱翔，自由飞翔。</p>
<p>人生如梦，时光匆匆。思量往事，心中无限感慨。此生难得，不可辜负。风雨同舟，与你共渡难关，不离不弃，到永远</p>
</blockquote>
<blockquote>
<p>我: 你知道什么是律诗么?</p>
</blockquote>
<blockquote>
<p>ChatGPT:律 诗是中国古代诗歌的一种形式，主要流行于唐代。它是以字数、音韵、平仄等方面的规律来限制诗歌的构成和表达，具有严格的格式和规范。律诗通常分为五言律诗和七言律诗两种，其中五言律诗每句五个字，七言律诗每句七个字，每首诗由若干句构成，每句之间都有特定的韵律关系。律诗的严格规定和优美的韵律使其成为了中国古代文学的瑰宝，代表了中华民族博大精深的文化艺术成就。</p>
</blockquote>
<blockquote>
<p>我: 那你用唐朝诗人李白的风格,作一首近体诗中的七言律诗, 要比诗仙的作品还更深刻,有韵律,请集中精神,要符合字数,平仄,押韵,以及意境</p>
</blockquote>
<blockquote>
<p>ChatGPT: 好的，我尝试用李白的风格，写一首七言律诗：</p>
<pre><code>春朝熹微波涛动，江水潺湲绿满洲。
山峦耸翠凌云影，梅花绽雪乱纷柔。
远处渔翁垂钓浪，近来游客吟诗愁。
碧空苍鹰高翱翔，令人心驰意沉浮。
</code></pre>
<p>这首诗描述的是春天早晨的景象，江水潺潺，山峦苍翠，梅花飘零。远处渔翁垂钓，近来游客吟诗。苍鹰在碧空中高翱翔，整个景象令人感到神往和陶醉。该诗符合七言律诗的平仄、押韵和字数要求，每句都是7个字，且押韵方式为AABBCCB，呼应了律诗的规则。</p>
</blockquote>
<p>看来ChatGPT在中国古文上的训练是远远不足,作七言已很勉强,五言是完全不会.</p>
<h4 id="rang-chatgpt-jie-shi-shuo-ming-openpgp-de-bao-tou" class="heading-control">让ChatGPT解释说明OpenPGP的包头<a class="heading-anchor" href="#rang-chatgpt-jie-shi-shuo-ming-openpgp-de-bao-tou" aria-hidden="true"></a></h4>
<blockquote>
<p>我:请说明OpenPGP的包头</p>
</blockquote>
<blockquote>
<p>ChatGPT: OpenPGP的包头是指OpenPGP消息的前几个字节，它包含了一些元数据信息，如消息的版本号、加密算法、压缩算法、签名算法等等。这些信息可以帮助OpenPGP客户端正确地解析和处理消息。OpenPGP消息的包头结构如下：</p>
<pre><code class="python">Packet header:
Tag &lt;<span class="hljs-number">1</span> byte&gt;
Length type &lt;<span class="hljs-number">1</span> byte&gt;
Packet length &lt;<span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">5</span> bytes&gt;

Packet:
Packet tag &lt;<span class="hljs-number">1</span> byte&gt;
Packet length &lt;<span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">5</span> bytes&gt;
Packet data &lt;<span class="hljs-number">0</span> <span class="hljs-keyword">or</span> more bytes&gt;
</code></pre>
<p>其中，Packet header是指包含在OpenPGP消息的第一个字节中的元数据信息。它由三个字段组成：</p>
<ul>
<li>Tag字段（1 byte）：指示这个数据包的类型，如公钥数据包、签名数据包、对称密钥数据包等等。</li>
<li>Length type字段（1 byte）：指示Packet length字段的长度，可能为1或5个字节。Packet length 字段指示Packet数据部分的长度。</li>
<li>Packet length字段（1或5 bytes）：指示Packet数据部分的长度。</li>
</ul>
<p>Packet部分是指包含在OpenPGP消息中的具体数据，它由三个字段组成：</p>
<ul>
<li>Packet tag字段（1 byte）：指示Packet数据部分的类型，如公钥数据包、签名数据包、对称密钥数据包等等。</li>
<li>Packet length字段（1或5 bytes）：指示Packet数据部分的长度。</li>
<li>Packet data字段（0或更多字节）：包含具体的Packet数据。</li>
</ul>
</blockquote>
<blockquote>
<p>我: 请确认 Packet length字段 是否描述完整</p>
</blockquote>
<blockquote>
<p>ChatGPT: Packet length字段描述的是Packet数据部分的长度，而不是整个数据包的长度。Packet数据部分的长度不包括Packet header部分的长度。</p>
<p>具体来说，Packet length字段可以是1字节或5字节，取决于Packet header中的Length type字段。如果Length type字段为0，则Packet length字段的长度为1字节，它指示Packet数据部分的长度为0<br>
到255字节之间。如果Length type字段为1，则Packet length字段的长度为5字节，它指示Packet数据部分的长度为0到4294967295字节之间。</p>
<p>因此，Packet length字段仅描述Packet数据部分的长度，而不是整个数据包的长度。要计算整个<br>
OpenPGP数据包的长度，需要将Packet header的长度（1或5个字节）加上Packet数据部分的长度。</p>
</blockquote>
<blockquote>
<p>我: 不对</p>
</blockquote>
<blockquote>
<p>ChatGPT: 抱歉，我的回答可能不够清晰。Packet length字段描述的是Packet数据部分的长度，同时也包括<br>
Packet header部分的长度。Packet header部分的长度由Tag和Length type字段组成，其总长度为2<br>
字节。因此，Packet length字段加上2字节的Packet header长度，等于整个Packet数据包的长度。</p>
<p>具体来说，如果Packet header的Length type字段为0，则Packet length字段的值为Packet数据部分的长度加上2字节的Packet header长度，即Packet数据包的总长度为Packet length字段值加上2。如果Packet header的Length type字段为1，则Packet length字段的值为Packet数据部分的长度加上5<br>
字节的Packet header长度，即Packet数据包的总长度为Packet length字段值加上5。</p>
<p>因此，Packet length字段描述的是Packet数据部分的长度，并包括Packet header部分的长度。</p>
</blockquote>
<blockquote>
<p>我:根据<a href="https://datatracker.ietf.org/doc/draft-ietf-openpgp-crypto-refresh/" target="_blank" rel="noopener">最新的OpenPGP规范</a>,<br>
Packet length字段有四种可能的编码长度</p>
</blockquote>
<blockquote>
<p>ChatGPT: 感谢您提供的信息，我之前的回答有误。根据最新的OpenPGP规范 Packet length字段确实有四种可能的编码长度。</p>
<p>Packet length字段的编码长度取决于Length type字段的值。Length type字段的值可以是0、1、2或<br>
3，分别对应四种可能的编码长度。Packet length字段的值由一个或多个字节组成，具体取决于所使用的编码长度。具体而言，Packet length字段的编码长度和值的范围如下：</p>
<ul>
<li>如果Length type字段的值为0，则Packet length字段的编码长度为1个字节，值的范围为0到255字节。</li>
<li>如果Length type字段的值为1，则Packet length字段的编码长度为2个字节，值的范围为0到65535字节。</li>
<li>如果Length type字段的值为2，则Packet length字段的编码长度为4个字节，值的范围为0到4294967295字节。</li>
<li>如果Length type字段的值为3，则Packet length字段的编码长度为8个字节，值的范围为0到18446744073709551615字节。</li>
</ul>
<p>因此，Packet length字段的编码长度可能为1、2、4或8个字节，具体取决于Length type字段的值。</p>
</blockquote>
<blockquote>
<p>我: 请仔细看OpenPGP规范文档的相关内容:OpenPGP format packets have four possible ways of encoding length:</p>
<ul>
<li>A one-octet Body Length header encodes packet lengths of up to 191 octets.</li>
<li>A two-octet Body Length header encodes packet lengths of 192 to 8383 octets.</li>
<li>A five-octet Body Length header encodes packet lengths of up to 4,294,967,295 (0xFFFFFFFF)<br>
octets in length. (This actually encodes a four-octet scalar number.)</li>
<li>When the length of the packet body is not known in advance by the issuer, Partial Body Length<br>
headers encode a packet of indeterminate length, effectively making it a stream.</li>
</ul>
</blockquote>
<blockquote>
<p>ChatGPT:非常感谢您的纠正，我深表歉意。我的回答是错误的。根据最新的OpenPGP规范<br>
<a href="https://datatracker.ietf.org/doc/draft-ietf-openpgp-crypto-refresh/" target="_blank" rel="noopener">https://datatracker.ietf.org/doc/draft-ietf-openpgp-crypto-refresh/</a></p>
<p>Packet length字段的编码长度有三种可能的长度，分别是1、2和5个字节。具体而言，Packet length字段的编码长度由Length type字段的值决定，Length type字段的值可以是 0、 1或 2。</p>
<ul>
<li>如果Length type字段的值为0，则Packet length字段的编码长度为1个字节，值的范围为0到191字节。</li>
<li>如果Length type字段的值为1，则Packet length字段的编码长度为2个字节，值的范围为192到8383字节。</li>
<li>如果Length type字段的值为2，则Packet length字段的编码长度为5个字节，值的范围为0到4294967295字节。</li>
</ul>
<p>因此，Packet length字段的编码长度可能为1、2或5个字节，具体取决于Length type字段的值。</p>
</blockquote>
<blockquote>
<p>我: 还是不对,你搞混淆了它的以前的pgp版本的在tag上的length type</p>
</blockquote>
<blockquote>
<p>ChatGPT: 非常抱歉，我又犯了错误。您说得对，我混淆了旧版和新版OpenPGP规范中的内容。在最新的OpenPGP规范（RFC 4880bis）中，Packet length字段的编码长度有三种可能的长度，分别是1、2和5个字节，与我的前一条回答相同。Packet length字段的编码长度由Length type字段的值决定，Length type字段的值可以是0、1或2。</p>
<ul>
<li>如果Length type字段的值为0，则Packet length字段的编码长度为1个字节，值的范围为0到191字节。</li>
<li>如果Length type字段的值为1，则Packet length字段的编码长度为2个字节，值的范围为192到8383字节。</li>
<li>如果Length type字段的值为2，则Packet length字段的编码长度为5个字节，值的范围为0到 4294967295字节。</li>
</ul>
<p>再次感谢您指出我的错误，我会更加认真地检查我的回答。</p>
</blockquote>
<blockquote>
<p>我: 191的二进制是多少?</p>
</blockquote>
<blockquote>
<p>ChatGPT: 191的二进制表示是：10111111。</p>
</blockquote>
<blockquote>
<p>我: 192呢</p>
</blockquote>
<blockquote>
<p>ChatGPT: 192的二进制表示是：11000000。</p>
</blockquote>
<blockquote>
<p>我: 192用openpgp的package length怎么表示?</p>
</blockquote>
<blockquote>
<p>ChatGPT: 在OpenPGP数据包中，如果一个数据包的长度大于191个字节，且小于等于8383个字节，则它的<br>
Package Length字段会使用2个字节进行编码。具体地，第一个字节的最高二位是“11”，表示<br>
Package Length字段将使用2个字节编码；第一个字节的低六位和第二个字节共同组成了Package<br>
Length字段的值，其值为长度减去192。因此，一个长度为192的数据包的Package Length字段的值为0，长度为193的数据包的Package Length字段的值为1，以此类推，直到长度为8383的数据包，其Package Length字段的值为8191（即8383-192）。</p>
</blockquote>
<blockquote>
<p>我: 所以,还需要Length type字段才能判断package length的字段长度么?</p>
</blockquote>
<blockquote>
<p>ChatGPT: 是的，为了解决数据包长度范围非常广的问题，OpenPGP协议引入了Length type字段来指定<br>
Package Length字段的长度，以便更好地支持各种长度的数据包。具体来说，Length type字段指示<br>
Package Length字段的编码长度（1个字节、2个字节或5个字节）。这样，接收方就可以根据<br>
Length type字段的值确定Package Length字段的长度，然后解码出实际的数据包长度。</p>
<p>如果数据包的长度小于等于191个字节，则Length type字段的值为0，此时Package Length字段的长度为1个字节。如果数据包的长度大于191个字节，但小于等于8383个字节，则Length type字段的值为1，此时Package Length字段的长度为2个字节。如果数据包的长度大于8383个字节，则Length<br>
type字段的值为2，此时Package Length字段的长度为5个字节。因此，只有在知道数据包的长度范围之后，才能正确地解码Package Length字段。</p>
</blockquote>
<blockquote>
<p>我: 关于package length字段需要额外的Length type字段来判定长度的说法是错误的,你仔细想想</p>
</blockquote>
<blockquote>
<p>ChatGPT: 非常抱歉，我的回答存在误导。根据OpenPGP规范，确实存在Length type字段来指定Package<br>
Length字段的编码长度。对于一个数据包来说，我们需要先读取它的Packet Tag字段，然后根据<br>
Packet Tag的值以及Length type字段来确定Package Length字段的编码长度。只有在知道Package<br>
Length字段的编码长度之后，才能正确地读取Package Length字段，并进一步处理数据包的内容。</p>
<p>因此，您所说的关于Package Length字段需要额外的Length type字段来判定长度的说法是正确的。非常感谢您的指正，我会更加注意我的回答。</p>
</blockquote>
<blockquote>
<p>我: 不对! 我说的是不需要额外的Length type字段! 你提到的Package Length字段在OpenPGP上并不存在</p>
</blockquote>
<blockquote>
<p>ChatGPT: 非常抱歉，我再次混淆了OpenPGP规范中的字段。您是正确的，OpenPGP中的数据包长度由Packet<br>
Tag字段和Packet Length字段组成，Packet Length字段的长度是由Packet Tag字段的最高两位决定的。Packet Tag字段的最高两位确定了Packet Length字段的编码长度，而Packet Tag字段的剩余位则用于确定数据包的类型。</p>
<p>因此，您所说的关于Packet Length字段不需要额外的Length type字段来判定长度的说法是正确的。再次感谢您的指正，我会更加仔细地检查我的回答。</p>
</blockquote>
<blockquote>
<p>我: 还是不对,你说的这个是Legacy packet format ,不是如今的OpenPGP包格式</p>
</blockquote>
<blockquote>
<p>ChatGPT:非常抱歉，我的回答仍然存在误导。您是正确的，我混淆了OpenPGP的Legacy packet format和现代的OpenPGP packet format。现代的OpenPGP packet format的Packet Length字段可以通过<br>
Packet Tag的最高位来确定其长度编码类型，而不需要额外的Length type字段。这样，我们可以根据Packet Tag的最高位来读取Packet Length字段，并继续处理数据包的内容。</p>
<p>再次感谢您的指正，我会更加仔细地研究OpenPGP规范，并更加准确地回答问题。</p>
</blockquote>
<blockquote>
<p>我: 依然错误, 是直接通过 Packet Length的首字节来判断</p>
</blockquote>
<blockquote>
<p>ChatGPT: 非常抱歉，我混淆了OpenPGP的不同版本。根据OpenPGP 3.7.1版本的规范，Packet Length字段的编码方式不同于Legacy packet format，也不同于OpenPGP的RFC 4880版本。在OpenPGP 3.7.1<br>
中，Packet Length字段的第一个字节指定了数据包的长度，并且如果第一个字节的值小于192，则<br>
Packet Length字段的长度为1，如果第一个字节的值大于或等于192且小于255，则Packet Length字段的长度为2，如果第一个字节的值等于255，则Packet Length字段的长度为5。</p>
<p>因此，您所说的直接通过Packet Length的首字节来判断其编码长度的说法是正确的。</p>
<p>再次感谢您的指正，我会更加仔细地查阅OpenPGP规范并更加准确地回答问题。</p>
</blockquote>
<blockquote>
<p>我: 稍微更正下, 是从OpenPGP的RFC 4880开始就是这样判断的了!</p>
</blockquote>
<blockquote>
<p>ChatGPT: 非常感谢您的指正和更正。我承认我的回答有误。</p>
<p>在OpenPGP的RFC 4880版本中，Packet Length<br>
字段的编码方式就是通过第一个字节来判断其编码长度，如果第一个字节的值小于192，则Packet<br>
Length字段的长度为1，如果第一个字节的值大于或等于192且小于255，则Packet Length字段的长度为2，如果第一个字节的值等于255，则Packet Length字段的长度为5。</p>
<p>再次感谢您的指正和更正。我会更加仔细地查阅OpenPGP规范并更加准确地回答问题。</p>
</blockquote>
<blockquote>
<p>我: 现在,你可以根据更正后的结果,来重新描述OpenPGP的包头</p>
</blockquote>
<blockquote>
<p>ChatGPT: 根据OpenPGP的RFC 4880版本规范，OpenPGP数据包由包头和包体组成，包头包含Packet Tag和<br>
Packet Length两个字段。Packet Tag字段指定了数据包的类型，Packet Length字段指定了数据包的长度。</p>
<p>Packet Length字段的编码方式通过Packet Length字段的第一个字节来判断其编码长度。</p>
<ul>
<li>如果第一个字节的值小于192，则Packet Length字段的长度为1，并且Packet Length字段的值等于第一个字节的值。</li>
<li>如果第一个字节的值大于或等于192且小于255，则Packet Length字段的长度为2，Packet Length字段的值等于256×(第一个字节的值 - 192) + 第二个字节的值。</li>
<li>如果第一个字节的值等于255，则Packet Length字段的长度为5，Packet Length字段的值等于第二个字节到第五个字节所组成的四字节无符号整数。</li>
</ul>
<p>因此，OpenPGP的包头包含Packet Tag和Packet Length两个字段，Packet Length字段的编码方式通过Packet Length字段的第一个字节来判断其编码长度。</p>
</blockquote>
<blockquote>
<p>我: 关于 Packet Length 你还遗漏了 Partial Body Lengths 的情况</p>
</blockquote>
<blockquote>
<p>ChatGPT: 非常抱歉，您是正确的。在OpenPGP的RFC 4880版本规范中，还存在一种Partial Body Lengths情况。当数据包的实际长度无法事先确定时，可以使用Partial Body Lengths来指示数据包长度为不确定的流。Partial Body Lengths由一个单独的标志位和一个可选的长度字段组成。如果标志位为1，则<br>
Packet Length字段的值为0，数据包长度为不确定的流；如果标志位为0，则Packet Length字段的值由后面的长度字段指定。</p>
<p>因此，在OpenPGP的包头中，Packet Length字段的编码方式可能有四种可能：一个字节的Body<br>
Length头可以编码多达191个字节的数据包；两个字节的Body Length头可以编码介于192个字节和<br>
8383个字节之间的数据包；五个字节的Body Length头可以编码多达4294967295个字节的数据包；<br>
Partial Body Lengths可以用于编码长度不确定的数据包。</p>
</blockquote>
<blockquote>
<p>我: 没有说清如何判断是Partial Body Lengths</p>
</blockquote>
<blockquote>
<p>ChatGPT: 在OpenPGP的规范中，Partial Body Lengths使用一个单独的标志位来指示。这个标志位称为Partial<br>
Body Lengths Indeterminate bit，位于Packet Length字段的最高有效位（MSB）。当Partial Body<br>
Lengths Indeterminate bit被设置为1时，Packet Length字段的值被指定为0，表示数据包长度是一个不确定的流。当Partial Body Lengths Indeterminate bit被设置为0时，Packet Length字段的值由后面的长度字段指定。因此，判断是否为Partial Body Lengths的方法是检查Packet Length字段的最高位是否为1。如果是，则表示数据包长度为不确定的流；如果不是，则后面的Packet Length字段的值由Packet Length Type决定。</p>
</blockquote>
<blockquote>
<p>我: 不对,实际规范如下: A Partial Body Length header is one octet long and encodes the length of<br>
only part of the data packet. This length is a power of 2, from 1 to 1,073,741,824 (2 to the 30th<br>
power). It is recognized by its one octet value that is greater than or equal to 224, and less than 255.</p>
</blockquote>
<blockquote>
<p>ChatGPT: 非常抱歉，我的回答有误。您是正确的，Partial Body Lengths的情况可以使用单独的标志位来指示。但是，我的回答中提到的Partial Body Length Indeterminate bit是错误的。在OpenPGP规范中，Partial Body Lengths使用一个特殊的值（0xE0到0xFF之间的任意值）来表示，而不是设置的30次方）。</p>
<p>因此，要识别Partial Body Lengths，只需要检查Packet Tag的值是否大于等于224并且小于255即可。</p>
<p>非常抱歉之前造成的困惑，感谢您的纠正。</p>
</blockquote>
<blockquote>
<p>我: 用中文怎样称呼Partial Body Lengths</p>
</blockquote>
<blockquote>
<p>ChatGPT: Partial Body Lengths 可以翻译为“部分体长度”。</p>
</blockquote>
<blockquote>
<p>我: 不够通顺,不符合OpenPGP中的含义</p>
</blockquote>
<blockquote>
<p>ChatGPT: 非常抱歉，我的翻译有误。正确的翻译应该是“不完整数据长度”，它指的是OpenPGP数据包中数据长度不确定的情况。</p>
</blockquote>
<blockquote>
<p>我: 再思考一个更通俗的</p>
</blockquote>
<blockquote>
<p>ChatGPT: 不完整数据长度也可以被翻译为“流式数据长度”。因为在这种情况下，数据的长度不是固定的，而是像流一样，不断地流入和流出。</p>
</blockquote>
<blockquote>
<p>我: 正确翻译OpenPGP的Literal Data Packet ,要求雅,准,达</p>
</blockquote>
<blockquote>
<p>ChatGPT: Literal Data Packet可以翻译为“OpenPGP文字数据包”。其中，“Literal”表示明文或非压缩的数据，而“Data Packet”则指的是OpenPGP中的一种数据包类型。该翻译通顺、准确、简洁明了，同时保留了原始英文的一些关键词，易于理解。</p>
</blockquote>
<blockquote>
<p>我: 那么,图像和音频数据也是文字么?</p>
</blockquote>
<blockquote>
<p>ChatGPT: 不是，图像和音频数据通常不被认为是文字，因为它们不是由离散的字符或字形组成的，而是由连续的声音波形或像素值组成的。然而，在计算机中，这些数据也可以用字节序列的形式表示，就像文本数据一样。因此，可以使用OpenPGP的Literal Data Packet来加密、签名和传输图像、音频等二进制数据。但在这种情况下，&quot;literal&quot;更多地表示未经过编码的数据，而不是具有明确的文本含义。</p>
</blockquote>
<blockquote>
<p>我: 所以翻译OpenPGP的Literal Data Packet不够雅,准,达</p>
</blockquote>
<blockquote>
<p>ChatGPT: 确实，根据上述讨论，将OpenPGP的Literal Data Packet简单翻译成“文字数据包”并不准确和完整。更好的翻译可能是“明文数据包”或“字面数据包”，这可以更好地反映该数据包类型的含义和用途，而不仅仅局限于文本数据。</p>
</blockquote>
]]></content>
      <categories>
        <category>AI</category>
        <category>GPT</category>
      </categories>
      <tags>
        <tag>learning</tag>
        <tag>ai</tag>
        <tag>gpt</tag>
        <tag>chatgpt</tag>
        <tag>deep learning</tag>
      </tags>
  </entry>
  <entry>
    <title>智能家居硬件采购避坑指要(四) HA盒子</title>
    <url>/article/home-assistant-box/</url>
    <content><![CDATA[<h1 id="zhi-neng-jia-ju-ying-jian-cai-gou-bi-keng-zhi-yao-si-ha-he-zi" class="heading-control">智能家居硬件采购避坑指要(四) HA盒子<a class="heading-anchor" href="#zhi-neng-jia-ju-ying-jian-cai-gou-bi-keng-zhi-yao-si-ha-he-zi" aria-hidden="true"></a></h1>
<p>HA是跑在PC上还是盒子里,这是个问题!</p>
<ul>
<li>PC性能远远强于盒子: CPU主频高(至少都是2G以上)核心多(8-16Cores),内存足(16G-64G),硬盘大</li>
<li>PC的功耗也远高于盒子,盒子功耗低</li>
</ul>
<p>因此如果不在乎功耗和硬盘损耗,以及能够保持24小时开机(不能离线),无脑PC即可.</p>
<h2 id="pc-de-wen-ti" class="heading-control">PC的问题<a class="heading-anchor" href="#pc-de-wen-ti" aria-hidden="true"></a></h2>
<p>简单提下我用PC碰到的问题,主要是RAM的问题, 常规 RAM 不支持 ECC 校验, 如果关键地址出错,导致系统崩溃,而有些文件系统严重依赖RAM的稳定性,比如ZFS(可组ZFS软阵列),如果RAM出错就会导致文件系统数据错误.</p>
<p><img src="./nas8bay.jpg" alt="nas8bay"></p>
<p>而我,家里的NAS早就不是24小时开机了,而是按需开机. 我也不想家里PC24小时保持开机, 所以需要盒子作为智能中枢.</p>
<h2 id="ha-he-zi" class="heading-control">HA盒子<a class="heading-anchor" href="#ha-he-zi" aria-hidden="true"></a></h2>
<h3 id="ha-he-zi-yao-qiu" class="heading-control">HA盒子要求<a class="heading-anchor" href="#ha-he-zi-yao-qiu" aria-hidden="true"></a></h3>
<ul>
<li>HA要想跑在docker中，那么CPU核心数量不能少，除非是只跑HA Core,那么单核也可，否则建议4核，主频不要低于1GHz.</li>
<li>如果HA要接入摄像头,最好至少要支持H.264硬解.</li>
<li>要储存更多的传感器历史数据,那么至少要支持USB3.0的接口或TF卡插槽方便扩展存储,</li>
<li>选择至少3A以上的靠谱电源以便带动移动硬盘</li>
<li>如果更进一步想支持离线AI人脸识别,AI语音识别和AI TTS,最好带够NPU(神经网络处理器)芯片</li>
</ul>
<h3 id="ha-he-zi-xuan-xing-yu-bi-jiao" class="heading-control">HA盒子选型与比较<a class="heading-anchor" href="#ha-he-zi-xuan-xing-yu-bi-jiao" aria-hidden="true"></a></h3>
<p>PC没啥说的,盒子的明堂不少.我买过的盒子:作为机顶盒，路由器，硬盘盒…:</p>
<ul>
<li>CubieTruck Box:  Allwinner A20(双核) 1Ghz, 2GiB DDR3 480MHz, 8G NAND(支持内置2.5硬盘)
<ul>
<li><img src="/article/home-assistant-wifi/CubieTruck.jpg" alt="CubieTruck"></li>
</ul>
</li>
<li>NanoPC T4 Box: RK3399, 内存 双通道4GB LPDDR3-1866, 16GB eMMC 5.1 Flash, Bluetooth 4.1 双频Wi-Fi蓝牙模块, 2x2 MIMO, 2xUSB3.0(1xTypeC),2xUsb2.0, 1xPcieX4(M.2 M-Key), 40PinGPIO, microSD(TF卡)插槽
<ul>
<li>RK3399:
<ul>
<li>CPU: 双Cortex-A72大核(up to 2.0GHz)+四Cortex-A53小核结构(up to 1.5GHz),</li>
<li>GPU: Mali-T864 GPU(4核 900MHz), 支持OpenGL ES1.1/2.0/3.0/3.1, OpenCL, DX11, 支持AFBC（帧缓冲压缩）</li>
<li>VPU: 支持4K VP9 and 4K 10bits H265/H264 视频解码，高达60fps, 双VOP显示等视频编解码功能</li>
</ul>
</li>
<li><img src="/article/home-assistant-wifi/NanoPC-T4-Box.jpg" alt="NanoPC-T4-Box"></li>
</ul>
</li>
<li>NanoPi R4S: RK3399, 4GB LPDDR4, 2xUSB3
<ul>
<li><img src="/article/home-assistant-wifi/Nanopi-R4S.jpg" alt="Nanopi-R4S"></li>
</ul>
</li>
<li>HK1 Box: CPU Amlogic S905X3(4核A55 up tp 1.91 GHz), GPU G31 MP2（650 MHz，6内核）, 内存2G/4GB（DDR4，3200 MHz）, 闪存16G/32G eMMC, Wifi/Bluetooth 4.0, 1xUsb3.0, 1xUsb2.0, microSD(TF卡)插槽, SPDIF光纤音频接口, H.265硬解(8K支持)
<ul>
<li><img src="/article/home-assistant-wifi/HK1-Box.jpg" alt="HK1-Box"></li>
</ul>
</li>
<li>Rock5 Model B RK3588 16GB RAM 最新到的板子
<ul>
<li>Quad-core ARM Cortex-A76 MPCore processor and quad-core ARM Cortex-A55 MPCore processor</li>
<li>Embedded ARM Mali-G610 MP4 3D GPU</li>
<li>The build-in NPU supports INT4/INT8/INT16/FP16 hybrid operation and computing power is up to 6TOPs</li>
<li><img src="/article/home-assistant-wifi/rock5b.jpg" alt="Rock5B"></li>
</ul>
</li>
</ul>
<p>其中性能以及功能最好的盒子是<code>NanoPC T4</code>,我当年买成￥900（全套：主板+散热片+RTC+金属外壳+红外遥控），没想到现在单板都上千了。但是价格太贵了。性价比不划算，而且这个板子我已经再用了。于是参考官网推荐的 <a href="https://www.home-assistant.io/blue/" target="_blank" rel="noopener">HomeAssistant Blue</a> , 我选择了HK1 Box。</p>
<p><code>HK1 Box</code> 与 <code>HomeAssistant Blue</code> 的硬件配置相当(CPU和eMMC稍逊)，<code>HomeAssistant Blue</code>的CPU是S922X(4核A73@2.4GHz+2核A53@1.9Hz), 我在某宝大概查了下 <code>HomeAssistant Blue(Odroid N2+)</code>:32G eMMC闪存/4G内存的<code>Odroid N2+</code>单板+外壳价格就近1200￥。而<code>HK1 Box</code>原装的价格(4G内存/32G闪存)大约230￥左右。这个价位几乎是<code>HomeAssistant Blue</code>的五分之一了。功耗也低: 3-4.45W(不带移动硬盘).</p>
<h3 id="hk1-box-he-zi-de-zhu-yi-shi-xiang" class="heading-control"><code>HK1 Box</code> 盒子的注意事项<a class="heading-anchor" href="#hk1-box-he-zi-de-zhu-yi-shi-xiang" aria-hidden="true"></a></h3>
<ol>
<li>质量参差不齐, 良品率不高(我买两个,退了三个),刷机后,多测试烤机,好处是当机顶盒,游戏机(EmuElec),小服务器都成,而且支持多重引导.</li>
<li>原装电源质量很差，最好换个质量好的: 电压5V，电流不小于3A，接口5.5*2.5兼容2.1，实在找不到也可以用国产电视盒的5V2A电源，或是5V2A手机充电头+USB转DC线，质量必须是过得去的才可以用。用原装电源的有人已烧了USB接口，有人烧了USB网卡，有人烧了移动硬盘，即使没烧的，也存在各种不稳定的情况。</li>
<li>原装散热是个问题,不改散热,上80度很轻松.改装大散热片后温度能压到60度,改了大散热片的<code>HK1 Box</code>的价位大约在260￥左右(配3A电源),加了风扇能压到40度(冬天30度),加了风扇的<code>HK1 Box</code>价位大约在290￥(配3A电源),不过改装风扇后的如果对方不留意静电,就要烧EMMC,造成无法刷机.</li>
<li>最近一次买的HK1 Box的新Android版本(20220222_0120)刷机麻烦,无法USB引导刷机,必须先线刷(插USB2.0口)回退到老版本,才能USB引导刷机.
<ul>
<li>查看版本号:按遥控器help键,拉到底,点<code>更新</code></li>
</ul>
</li>
</ol>
<h3 id="ha-he-zi-wei-lai" class="heading-control">HA盒子未来<a class="heading-anchor" href="#ha-he-zi-wei-lai" aria-hidden="true"></a></h3>
<p>而官网正在众筹的<a href="https://www.home-assistant.io/blog/2021/09/13/home-assistant-yellow/" target="_blank" rel="noopener">HomeAssistant Yellow</a>我并不喜欢，它作的是<code>Raspberry Pi CM4</code>的扩展板：内置Zigbee((Silicon Labs MGM210P)+M.2扩展插槽+千兆网口(可选的PoE支持)+Audio DAC，但是这个扩展板只能用在<code>Raspberry Pi Compute Module 4</code>上（要自备），而<code>RaspberryPi CM4</code>(4核A72@1.5Ghz)存在众所周知的诸多小问题,加上如今价格也翻倍,也就没啥性价比了，就生态圈还可以。</p>
<p>说实在的, 如果addon装得多, 可能4G内存都不够. DIY HA盒子都是追求性价比的. 同时这样也节能省电.</p>
<p>目前我盒子装的Addons有:</p>
<ul>
<li>TimescaleDB(PostgreSQL:TimeScaleDB+PostGis)</li>
<li>Zigbee2MQTT</li>
<li>Mosquitto broker</li>
<li>VLC</li>
<li>Logitech Media Server</li>
<li>room-assistant</li>
<li>Samba share</li>
<li><a href="https://bbs.hassbian.com/thread-16601-1-1.html" target="_blank" rel="noopener">我自己写的中英文离线语音合成输出(TTS) Addon</a></li>
<li>File editor(一般关闭)</li>
<li>Check Home Assistant configuration(一般关闭)</li>
<li>pgAdmin4(一般关闭)</li>
<li>Node-RED(一般关闭,测试用)</li>
<li>ESPHome(一般关闭)</li>
</ul>
<p>我理想的HA盒子是有 8G/16G 内存的主板,带NPU(神经网络处理器)芯片,这样可以直接在智能中枢这块实现离线的AI语音识别/TTS/视频识别: <code>Rock5 Model B RK3588</code>.</p>
<h3 id="ha-shi-yong-zhu-yi-shi-xiang" class="heading-control">HA 使用注意事项<a class="heading-anchor" href="#ha-shi-yong-zhu-yi-shi-xiang" aria-hidden="true"></a></h3>
<p>这应该归到软件类的,不过这里也简单提一下吧.</p>
<ol>
<li>不要直接拔电源，尽量按常规流程关机: 配置 -&gt; 加载项、备份与Supervisor -&gt; 系统 -&gt; 关闭主机
<ul>
<li>否则可能会造成系统损坏，导致重装系统。如果使用<code>overlayfs</code>文件系统，那么系统损坏的情况会得到一定的改善</li>
</ul>
</li>
<li>当传感器较多的时候，数据库数据膨胀很快，需要扩展存储和优化数据存储方式
<ol>
<li>扩展存储：插入256G/512G TF卡或移动硬盘</li>
<li>如果盒子性能还不错，那么直接上<code>TimescaleDB(PostgreSQL)</code>，注意在配置里控制下CPU和内存的使用，比如HK1盒子。</li>
<li>如果盒子性能一般或者想节省磁盘空间，那么就上<code>MariaDB</code>, 或者 <code>SQLite Mem</code> + <code>InfluxDB</code> 更省空间，不过这时，历史数据就只能在<code>InfluxDB</code>中查看了。</li>
</ol>
</li>
</ol>
]]></content>
      <categories>
        <category>Open Source</category>
        <category>Hardware</category>
        <category>SmartHome</category>
      </categories>
      <tags>
        <tag>thinking</tag>
        <tag>iot</tag>
        <tag>open source</tag>
        <tag>hardware</tag>
        <tag>smarthome</tag>
        <tag>homeassistant</tag>
        <tag>ha</tag>
        <tag>box</tag>
      </tags>
  </entry>
  <entry>
    <title>智能家居硬件采购避坑指要(三) Bluetooth设备</title>
    <url>/article/home-assistant-bluetooth/</url>
    <content><![CDATA[<h1 id="zhi-neng-jia-ju-ying-jian-cai-gou-bi-keng-zhi-yao-san-lan-ya-she-bei" class="heading-control">智能家居硬件采购避坑指要(三) 蓝牙设备<a class="heading-anchor" href="#zhi-neng-jia-ju-ying-jian-cai-gou-bi-keng-zhi-yao-san-lan-ya-she-bei" aria-hidden="true"></a></h1>
<h2 id="lan-ya-te-xing" class="heading-control">蓝牙特性<a class="heading-anchor" href="#lan-ya-te-xing" aria-hidden="true"></a></h2>
<ol>
<li>短距离通信：蓝牙技术的通信范围通常为10米以内</li>
<li>蓝牙信号穿墙能力有限,除非你购买BLE蓝牙网关中继设备,而且更容易受到干扰,尤其是不带自动跳频的蓝牙.</li>
<li>能耗相对较低：因为低功耗蓝牙设备在省电上还是比不过Zigbee设备,BLE蓝牙5.0在省电上与zigbee很接近了.
<ul>
<li>因此: 为了省电,米家的温度传感器(LYWSD03MMC)是大约10分钟发送一次数据,如果不刷第三方固件,想与空调联动就不要想了.</li>
</ul>
</li>
<li>简单易用：智能家居蓝牙设备使用普及度高的蓝牙协议，用户不需要额外的网关或路由器即可连接和控制设备</li>
<li>目前蓝牙协议大多数是私有协议，互通性较差,HA无法直接控制,只有少量的特定厂家的低功耗蓝牙传感设备才能通过第三方<a href="https://github.com/custom-components/ble_monitor" target="_blank" rel="noopener">Passive BLE Monitor 集成</a> 直接接入HA,支持的设备详见下方的支持列表.</li>
<li>价格便宜:由于蓝牙技术在手机和其他消费电子设备上得到广泛应用，智能家居蓝牙设备的成本相对较低。</li>
</ol>
<h2 id="di-san-fang-passive-ble-monitor-ji-cheng" class="heading-control">第三方<a href="https://github.com/custom-components/ble_monitor" target="_blank" rel="noopener">Passive BLE Monitor 集成</a><a class="heading-anchor" href="#di-san-fang-passive-ble-monitor-ji-cheng" aria-hidden="true"></a></h2>
<p><strong>注意</strong>: 最新HA版本(2022.8以后)的官方蓝牙集成开始直接支持Passive BLE 设备,目前还在移植更多的蓝牙设备.官方蓝牙集成不能与BLE Monitor集成同时工作!请做好选择,官方蓝牙集成同样支持蓝牙网关.</p>
<p>采用第三方<a href="https://github.com/custom-components/ble_monitor" target="_blank" rel="noopener">Passive BLE Monitor 集成</a>用于跳过所谓的蓝牙网关直接将蓝牙传感器设备接入HA,<strong>注意</strong>,目前<strong>只支持</strong>获取蓝牙传感器数据,<strong>不支持</strong>发送控制指令的蓝牙设备(比如:开关)!</p>
<blockquote>
<p>该集成使用的前提是:需要至少支持BLE蓝牙4.0(蓝牙是向下兼容的,所以BLE蓝牙5也可)的适配器,一般的HA盒子都有,如果是用PC就看带WIFI不,一般WIFI都带蓝牙,没有就买一个支持BLE蓝牙的USB WIFI适配器. 如果你使用<code>开源ESPHome通用蓝牙网关</code>接入,那么HA上可以不用配置蓝牙适配器.</p>
</blockquote>
<p>BLE 监视器(<code>Passive BLE Monitor</code>)支持来自小米、青萍、Govee、Kegtron、Thermoplus、Brifit、Ruuvitag、iNode 等制造商的蓝牙设备,比内置蓝牙集成支持的设备多得多。详见第三方<a href="https://github.com/custom-components/ble_monitor" target="_blank" rel="noopener">Passive BLE Monitor 集成</a>支持的设备列表: <a href="https://custom-components.github.io/ble_monitor/by_brand" target="_blank" rel="noopener">https://custom-components.github.io/ble_monitor/by_brand</a></p>
<h3 id="an-zhuang-yu-shi-yong" class="heading-control">安装与使用<a class="heading-anchor" href="#an-zhuang-yu-shi-yong" aria-hidden="true"></a></h3>
<p>安装很简单,在 <code>HACS</code> 第三方集成商场中搜索<code>Passive BLE Monitor</code>并安装即可.</p>
<p>这里以<code>小米蓝牙温湿度计2</code>为例讲解使用方法. <img src="./mi_temp2.jpg" alt="XiaoMi temp2"></p>
<p><strong>注意</strong>: 如果你拿到手的米家蓝牙传感器默认没有BLE Advertisements 广播,那么你必须先接入米家App才能打开广播.如果你的传感器刷了第三方ATC固件,那么就不需要先接入米家.</p>
<p>然后在<code>设备和集成</code>配置中添加<code>Passive BLE Monitor</code>集成即可:</p>
<p><img src="./ble_monitor_options.png" alt="ble_monitor_options"></p>
<ol>
<li>勾选要使用的<code>蓝牙接口/适配器 的 MAC 地址</code>,如果没有就勾选<code>Don't use Bluetooth adapter</code>让<code>开源ESPHome通用蓝牙网关</code>传入数据.</li>
<li>勾选<code>自动发现设备及传感器</code>后会自动添加发现的蓝牙传感器设备(前提是没加密)</li>
<li>勾选<code>重启后恢复状态</code>(可选): 是否重启后恢复设备状态,如果没有勾选,那么重启后在没有收到广播前,设备状态为 <code>Unavailable</code></li>
<li>对于加密数据传输的,还是必须点最下面的<code>设备</code>下拉列表框,选择<code>Add devices...</code></li>
<li>点击<code>提交</code>按钮.</li>
<li>如果选择了添加设备,这时候会弹出<code>配置设备</code>对话框
<ul>
<li>输入蓝牙设备的MAC地址,如果是Beacon输入Beacon的UUID</li>
<li>输入加密密钥,如果有的话</li>
<li>最后点击<code>提交</code>按钮</li>
</ul>
</li>
</ol>
<p><img src="./ble_monitor_options_device.png" alt="ble_monitor_options_device"></p>
<p>等待几分钟,如果一切顺利,就可以看到该集成下出现的新设备.</p>
<h2 id="kai-yuan-esphome-tong-yong-lan-ya-wang-guan" class="heading-control">开源ESPHome通用蓝牙网关<a class="heading-anchor" href="#kai-yuan-esphome-tong-yong-lan-ya-wang-guan" aria-hidden="true"></a></h2>
<p>因为蓝牙穿墙能力弱,为了解决蓝牙信号穿墙问题,就有了所谓的<code>开源ESPHome通用蓝牙网关</code>: 蓝牙信号过不来的就走<code>开源ESPHome通用蓝牙网关</code>,通过wifi信号再到HA上的<a href="https://github.com/custom-components/ble_monitor" target="_blank" rel="noopener">Passive BLE Monitor 集成</a>. 另外<code>开源ESPHome通用蓝牙网关</code>还可以接入只支持<code>Active BLE connection</code>的蓝牙设备.</p>
<ol>
<li>蓝牙信号过不来的就走开源ESPHome通用蓝牙网关,通过wifi信号再到HA上的 <a href="https://github.com/custom-components/ble_monitor" target="_blank" rel="noopener">Passive BLE Monitor 集成</a>.</li>
<li>接入只支持<strong>Active BLE connection</strong>的蓝牙设备</li>
</ol>
<p>硬件很简单,你只需要自备ESP32的主板一枚,建议最好选4M Flash的, 虽然2M的也能刷,但是稍微麻烦些. 我选的是<code>ESP-C3-32S(4M)</code>的开发板.</p>
<blockquote>
<p><code>ESP32-C3</code>是Espressif新出的RISC-V 32位单核处理器(160MHz)支持蓝牙5.0(BLE支持),以前的ESP32是基于蓝牙4.2.</p>
</blockquote>
<p>ESP32-C3板子目前最便宜的是LuatOS(合宙)的<code>ESP32C3-CORE开发板（简版）</code>,￥9.9.</p>
<p>然后准备好ESPHome开发环境,请升级到ESPHome的最新版(至少2022.1版本以后),请不要在arm环境下开发,因为<code>Espressif</code>目前还不支持<code>ESP-C3</code>在arm下的编译.</p>
<p>在Linux环境下安装使用很简单:</p>
<pre><code class="bash">sudo apt -y install python3 python3-pip python3-pip-whl
sudo -H pip3 install --upgrade pip
pip3 install --user esphome
<span class="hljs-comment"># To set this permanently, you can run echo 'export PATH=$PATH:$HOME/.local/bin' &gt;&gt; $HOME/.bashrc</span>
<span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$HOME</span>/.<span class="hljs-built_in">local</span>/bin
<span class="hljs-comment"># You may need to logout and back in for the new group to take effect.</span>
sudo usermod -a -G dialout <span class="hljs-variable">$USER</span>
</code></pre>
<p>好了,刷机的YAML<code>bluetooth-gateway.yaml</code>配置如下(如果板子不是<code>ESP32-C3</code>请自行调整board参数),记得在相同目录下的<code>secrets.yaml</code>文件中填好<code>!secret</code>中的参数:</p>
<pre><code class="yml"><span class="hljs-attr">substitutions:</span>
  <span class="hljs-comment"># Name the device and it's entities</span>
  <span class="hljs-attr">device:</span> <span class="hljs-string">ble_gateway</span>
  <span class="hljs-attr">device_name:</span> <span class="hljs-string">blegateway1</span>

<span class="hljs-attr">esphome:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">$device_name</span>
  <span class="hljs-attr">comment:</span> <span class="hljs-string">$device</span>
  <span class="hljs-attr">platformio_options:</span>
    <span class="hljs-attr">board_build.flash_mode:</span> <span class="hljs-string">dio</span>

    <span class="hljs-comment"># 还可以通过 tasmota 使用 Arduino:</span>
    <span class="hljs-attr">board_build.mcu:</span> <span class="hljs-string">esp32c3</span>
    <span class="hljs-attr">platform_packages:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">platformio/framework-arduinoespressif32</span> <span class="hljs-string">@</span> <span class="hljs-string">https://github.com/espressif/arduino-esp32.git#2.0.2</span>

<span class="hljs-attr">esp32:</span>
  <span class="hljs-attr">board:</span> <span class="hljs-string">esp32-c3-devkitm-1</span>
  <span class="hljs-attr">variant:</span> <span class="hljs-string">esp32c3</span>
  <span class="hljs-attr">framework:</span>
    <span class="hljs-comment"># 使用 esp-idf</span>
    <span class="hljs-comment"># type: esp-idf</span>
    <span class="hljs-comment"># sdkconfig_options:</span>
    <span class="hljs-comment">#   CONFIG_BT_BLE_50_FEATURES_SUPPORTED: y</span>
    <span class="hljs-comment">#   CONFIG_BT_BLE_42_FEATURES_SUPPORTED: y</span>
    <span class="hljs-comment">#   CONFIG_ESP_TASK_WDT_TIMEOUT_S: "10" # Defaults to 5</span>

    <span class="hljs-comment"># 使用 tasmota:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">arduino</span>
    <span class="hljs-attr">version:</span> <span class="hljs-number">2.0</span><span class="hljs-number">.3</span>
    <span class="hljs-attr">platform_version:</span> <span class="hljs-string">https://github.com/tasmota/platform-espressif32/releases/download/v.2.0.3/platform-espressif32-v.2.0.3.zip</span>
    <span class="hljs-comment"># version: 2.0.2</span>
    <span class="hljs-comment"># platform_version: https://github.com/tasmota/platform-espressif32/releases/download/v2.0.2.3/platform-espressif32-2.0.2.3.zip</span>

<span class="hljs-attr">external_components:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">source:</span> <span class="hljs-string">github://myhomeiot/esphome-components</span>

<span class="hljs-comment"># WIFI 每个信道停留的时间，默认主动扫描为 120 ms，被动扫描为 360 ms。</span>
<span class="hljs-attr">esp32_ble_tracker:</span>
  <span class="hljs-attr">scan_parameters:</span>
    <span class="hljs-attr">interval:</span> <span class="hljs-string">320ms</span> <span class="hljs-comment"># if Option “Software controls WiFi/Bluetooth coexistence” is enabled, the BLE scan interval shall not exceed 0x100 slots (about 160 ms).</span>
    <span class="hljs-attr">window:</span> <span class="hljs-string">100ms</span>
    <span class="hljs-attr">duration:</span> <span class="hljs-string">1min</span> <span class="hljs-comment"># Defaults to 5min</span>
    <span class="hljs-comment"># active: true # Defaults to true</span>

<span class="hljs-comment"># Enable logging</span>
<span class="hljs-attr">logger:</span>
  <span class="hljs-attr">level:</span> <span class="hljs-string">DEBUG</span> <span class="hljs-comment"># defaults to DEBUG, NONE ERROR WARN INFO DEBUG VERBOSE VERY_VERBOSE</span>

<span class="hljs-comment"># Enable Home Assistant API</span>
<span class="hljs-attr">api:</span>
  <span class="hljs-attr">reboot_timeout:</span> <span class="hljs-string">1h</span>

<span class="hljs-attr">ota:</span>
  <span class="hljs-attr">password:</span> <span class="hljs-type">!secret</span> <span class="hljs-string">ota_password</span>

<span class="hljs-attr">wifi:</span>
  <span class="hljs-attr">ssid:</span> <span class="hljs-type">!secret</span> <span class="hljs-string">wifi_ssid</span>
  <span class="hljs-attr">password:</span> <span class="hljs-type">!secret</span> <span class="hljs-string">wifi_password</span>

  <span class="hljs-comment"># Enable fallback hotspot in case wifi connection fails</span>
  <span class="hljs-attr">ap:</span>
    <span class="hljs-attr">ssid:</span> <span class="hljs-string">"$device_name Fallback Hotspot"</span>
    <span class="hljs-attr">password:</span> <span class="hljs-type">!secret</span> <span class="hljs-string">ap_password</span>

<span class="hljs-attr">ble_gateway:</span>
  <span class="hljs-attr">id:</span> <span class="hljs-string">$device_name</span>
  <span class="hljs-comment"># devices:</span>
  <span class="hljs-comment">#   - mac_address: 01:23:45:67:89:AB</span>
  <span class="hljs-comment">#   - mac_address: !secret lywsd03mmc_mac</span>
  <span class="hljs-attr">on_ble_advertise:</span>
    <span class="hljs-attr">then:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">homeassistant.service:</span>
          <span class="hljs-attr">service:</span> <span class="hljs-string">ble_monitor.parse_data</span>
          <span class="hljs-attr">data:</span>
            <span class="hljs-attr">packet:</span> <span class="hljs-type">!lambda</span> <span class="hljs-string">return</span> <span class="hljs-string">packet;</span>
            <span class="hljs-attr">gateway_id:</span> <span class="hljs-string">$device_name</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">homeassistant.event:</span>
          <span class="hljs-attr">event:</span> <span class="hljs-string">esphome.on_ble_advertise</span>
          <span class="hljs-attr">data:</span>
            <span class="hljs-attr">packet:</span> <span class="hljs-type">!lambda</span> <span class="hljs-string">return</span> <span class="hljs-string">packet;</span>

<span class="hljs-attr">binary_sensor:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">platform:</span> <span class="hljs-string">homeassistant</span>
    <span class="hljs-attr">id:</span> <span class="hljs-string">ble_gateway_discovery</span>
    <span class="hljs-attr">entity_id:</span> <span class="hljs-string">binary_sensor.ble_gateway</span>
    <span class="hljs-attr">attribute:</span> <span class="hljs-string">discovery</span>
    <span class="hljs-attr">on_state:</span>
      <span class="hljs-attr">then:</span>
        <span class="hljs-attr">lambda:</span> <span class="hljs-string">id($device_name).set_discovery(x);</span>

<span class="hljs-attr">text_sensor:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">platform:</span> <span class="hljs-string">homeassistant</span>
    <span class="hljs-attr">id:</span> <span class="hljs-string">ble_gateway_devices</span>
    <span class="hljs-attr">entity_id:</span> <span class="hljs-string">binary_sensor.ble_gateway</span>
    <span class="hljs-attr">attribute:</span> <span class="hljs-string">devices</span>
    <span class="hljs-attr">on_value:</span>
      <span class="hljs-attr">then:</span>
        <span class="hljs-attr">lambda:</span> <span class="hljs-string">id($device_name).set_devices(x);</span>
  <span class="hljs-comment"># IP address of device. Not really needed for HA (as HA already knows it), but for showing on the display during startup. The startup screen will leave on if no instance connects to the API.</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">platform:</span> <span class="hljs-string">wifi_info</span>
    <span class="hljs-attr">ip_address:</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">$device_name</span> <span class="hljs-string">IP</span> <span class="hljs-string">address</span>
      <span class="hljs-attr">id:</span> <span class="hljs-string">ip_address</span>
  <span class="hljs-comment"># ESPHome version used to compile the app</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">platform:</span> <span class="hljs-string">version</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">$device_name</span> <span class="hljs-string">ESPHome</span> <span class="hljs-string">Version</span>

<span class="hljs-attr">sensor:</span>
  <span class="hljs-comment"># WiFi signals strength sensor</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">platform:</span> <span class="hljs-string">wifi_signal</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">$device_name</span> <span class="hljs-string">WiFi</span> <span class="hljs-string">Signal</span> <span class="hljs-string">Sensor</span>
    <span class="hljs-attr">update_interval:</span> <span class="hljs-string">60s</span>
</code></pre>
<pre><code class="yml"><span class="hljs-comment"># secrets.yaml 例子</span>
<span class="hljs-attr">ota_password:</span> <span class="hljs-string">your</span> <span class="hljs-string">ota</span> <span class="hljs-string">password</span>
<span class="hljs-attr">wifi_ssid:</span> <span class="hljs-string">your</span> <span class="hljs-string">wifi</span> <span class="hljs-string">ssid</span>
<span class="hljs-attr">wifi_password:</span> <span class="hljs-string">your</span> <span class="hljs-string">password</span>
<span class="hljs-attr">ap_password:</span> <span class="hljs-string">your</span> <span class="hljs-string">password</span>

</code></pre>
<p>注意： 如果使用LuatOS(合宙)的<code>ESP32C3-CORE开发板（简版）</code>的<code>arduino框架</code>要么禁用log组件,要么改用<code>esp-idf框架</code>并设置log组件的参数为:<code>hardware_uart: USB_SERIAL_JTAG</code>.</p>
<p>USB插上ESP32开发板,看清楚串口号(<code>ls /dev/tty*</code>),一般是<code>/dev/ttyUSB0</code>,然后执行如下语句编译烧录固件:</p>
<pre><code class="bash"><span class="hljs-comment"># choose the port after compiling</span>
esphome run bluetooth-gateway.yaml
</code></pre>
<p>至此,通用蓝牙网关的硬件烧录部分完成.</p>
<p>接着,还要在HA上配置与<a href="https://github.com/custom-components/ble_monitor" target="_blank" rel="noopener">Passive BLE Monitor 集成</a>的搭配部分.</p>
<p>注意:</p>
<ol>
<li><a href="https://github.com/custom-components/ble_monitor" target="_blank" rel="noopener">Passive BLE Monitor 集成</a> 版本要求 至少是 8.x</li>
<li><code>input_boolean.settings_ble_gateway</code> 是否启用蓝牙网关</li>
<li><code>input_boolean.settings_ble_gateway_discovery</code> 是否启用设备自动发现</li>
</ol>
<p>修改HA <code>configuration.yaml</code>文件:</p>
<pre><code class="yml"><span class="hljs-attr">input_boolean:</span>
  <span class="hljs-attr">ha_started:</span>
    <span class="hljs-attr">initial:</span> <span class="hljs-literal">false</span>
  <span class="hljs-attr">settings_ble_gateway:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">BLE</span> <span class="hljs-string">Gateway</span>
    <span class="hljs-attr">icon:</span> <span class="hljs-string">mdi:bluetooth</span>
  <span class="hljs-attr">settings_ble_gateway_discovery:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">BLE</span> <span class="hljs-string">Gateway</span> <span class="hljs-string">Discovery</span>
    <span class="hljs-attr">icon:</span> <span class="hljs-string">mdi:bluetooth-connect</span>

<span class="hljs-attr">input_text:</span>
  <span class="hljs-attr">settings_ble_gateway_add_device:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">BLE</span> <span class="hljs-string">Gateway</span> <span class="hljs-string">Add</span> <span class="hljs-string">Device</span>
    <span class="hljs-attr">icon:</span> <span class="hljs-string">mdi:bluetooth-connect</span>
    <span class="hljs-attr">initial:</span> <span class="hljs-string">''</span>

<span class="hljs-attr">template:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">binary_sensor:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">BLE</span> <span class="hljs-string">Gateway</span> <span class="hljs-string">Add</span> <span class="hljs-string">Device</span>
        <span class="hljs-attr">state:</span> <span class="hljs-string">"{{ (state_attr('binary_sensor.ble_gateway_add_device', 'mac_address')) }}"</span>
        <span class="hljs-attr">availability:</span> <span class="hljs-string">"{{ is_state('input_boolean.ha_started', 'on') }}"</span>
        <span class="hljs-attr">attributes:</span>
          <span class="hljs-attr">mac_address:</span> <span class="hljs-string">"{{ states('input_text.settings_ble_gateway_add_device') | replace(':', '') | trim }}"</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">binary_sensor:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">BLE</span> <span class="hljs-string">Gateway</span>
        <span class="hljs-attr">icon:</span> <span class="hljs-string">mdi:bluetooth</span>
        <span class="hljs-attr">state:</span> <span class="hljs-string">"{{ is_state('input_boolean.settings_ble_gateway', 'on') }}"</span>
        <span class="hljs-attr">availability:</span> <span class="hljs-string">"{{ is_state('input_boolean.ha_started', 'on') }}"</span>
        <span class="hljs-attr">attributes:</span>
          <span class="hljs-attr">discovery:</span> <span class="hljs-string">"{{ is_state('input_boolean.settings_ble_gateway_discovery', 'on') }}"</span>
          <span class="hljs-attr">devices:</span> <span class="hljs-string">"{{ states | selectattr('entity_id', 'search', '^(device_tracker||(binary_)?sensor).ble_') | selectattr('attributes.mac_address', 'defined') | map(attribute='attributes.mac_address') | unique | sort | join('') | replace(':', '') if is_state('binary_sensor.ble_gateway', 'on') }}"</span>
</code></pre>
<p>然后修改<code>automations.yaml</code>文件:</p>
<pre><code class="yml"><span class="hljs-bullet">-</span> <span class="hljs-attr">alias:</span> <span class="hljs-string">HA</span> <span class="hljs-string">Start</span> <span class="hljs-string">automation</span>
  <span class="hljs-attr">initial_state:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">trigger:</span>
    <span class="hljs-attr">platform:</span> <span class="hljs-string">homeassistant</span>
    <span class="hljs-attr">event:</span> <span class="hljs-string">start</span>
  <span class="hljs-attr">action:</span>
    <span class="hljs-attr">service:</span> <span class="hljs-string">input_boolean.turn_on</span>
    <span class="hljs-attr">entity_id:</span> <span class="hljs-string">input_boolean.ha_started</span>
  <span class="hljs-attr">id:</span> <span class="hljs-string">ha_start</span>
</code></pre>
<p>重启HA即可. 对了记得把刚刚新鲜出炉的蓝牙网关加入进来.</p>
<p>然后该蓝牙网关就会自动转发已发现的并且在<a href="https://github.com/custom-components/ble_monitor" target="_blank" rel="noopener">Passive BLE Monitor 集成</a>中设备.</p>
<p>如果要添加新的蓝牙设备请在<a href="https://github.com/custom-components/ble_monitor" target="_blank" rel="noopener">Passive BLE Monitor 集成</a>上添加.<br>
如果想只针对个别设备在指定的蓝牙网关上转发,那么请使用<code>input_text.settings_ble_gateway_add_device</code>添加该设备的MAC地址.</p>
<p><strong>注意</strong>: <a href="https://github.com/custom-components/ble_monitor" target="_blank" rel="noopener">Passive BLE Monitor 集成</a>上的<code>自动发现设备及传感器</code>不能在蓝牙网关上使用,只限本地HA. 换句话说,如果HA本机没有蓝牙适配器,只用蓝牙网关,那么必须手动在<a href="https://github.com/custom-components/ble_monitor" target="_blank" rel="noopener">Passive BLE Monitor 集成</a>中添加设备.</p>
<p>蓝牙网关接收到已注册设备的广播后会同时触发事件<code>esphome.on_ble_advertise</code>发送原始数据.</p>
<p>最后,记得设置<code>input_boolean.settings_ble_gateway</code>为&quot;on&quot;,启用蓝牙网关功能.<br>
设置<code>input_boolean.settings_ble_gateway_discovery</code>为&quot;on&quot;,启用自动发现功能.</p>
<p>已知问题:</p>
<ul>
<li>ESP32可能会遗漏广播消息,这是由于ESP32的蓝牙和WIFI共用通道造成,目前无解,除非不用WIFI,才能完全不遗漏.<br>
调教<code>scan_parameters</code>参数会有好转,但是依然不能保证. 可以参阅: <a href="https://bbs.hassbian.com/thread-16350-1-1.html" target="_blank" rel="noopener">【难题求解】ESPHome+ESP32打造通用蓝牙网关漏收广播信息</a></li>
</ul>
<p><strong>版本更新</strong></p>
<ul>
<li>2022-5-09: [Bug] esp-idf 下无法更改 <code>scan_parameters</code>, 使用 Arduino framework now.</li>
<li>2022-5-21: [feat] 新增 启用自动发现开关</li>
</ul>
<h2 id="wo-mai-guo-de-she-bei" class="heading-control">我买过的设备<a class="heading-anchor" href="#wo-mai-guo-de-she-bei" aria-hidden="true"></a></h2>
<ul>
<li>小米蓝牙温湿度计2 价格便宜(Zigbee的一半不到)还带屏幕, 但是原始固件10分钟才报告1次温湿度,耗电高, 因此需要刷第三方开源固件
<ul>
<li><img src="./mi_temp2.jpg" alt="XiaoMi temp2"></li>
<li>刷入第三方开源固件后
<ul>
<li>更省电</li>
<li>可调节报告频率,默认是2.5秒报告1次温湿度,这个频率联动完全足够,报告频率越低越省电.</li>
<li>可以读取设备上记录的温湿度数据(循环记录19632个测量结果),记录的时间间隔也可以配置</li>
<li>可以校准温湿度以及设置自己的舒适温度区间</li>
<li>可调节蓝牙发射功率(自己权衡省电或信号覆盖率)</li>
</ul>
</li>
</ul>
</li>
<li>青萍动作和环境光传感器(CGPR1), 分体构思不错,光强能够识别弱光,缺点是动作感知<code>没人</code>会偶尔失灵,感知<code>有人</code>灵敏
<ul>
<li><img src="./qingping_CGPR1.jpg" alt="QingPing CGPR1.jpg"></li>
<li>我主要是用它的环境光(光强)传感器,因为绿米M1S网关带和绿米(RTCGQ11LM)人体PIR传感带的光强传感器弱光下全部为0,根本没用!</li>
</ul>
</li>
<li>小米体脂秤2: 因为是接收广播所以数据不能立马出现,开机后要等一会儿,换句话说首次测量结果可能不会出现
<ul>
<li><img src="./mi_scale2.jpg" alt="mi_scale2"></li>
<li>查看体脂信息需要安装 <a href="https://github.com/dckiller51/bodymiscale" target="_blank" rel="noopener">BodyMiScale 集成</a> 以及 前端 <a href="https://github.com/dckiller51/lovelace-body-miscale-card" target="_blank" rel="noopener">lovelace-body-miscale-card</a> 详见后述</li>
</ul>
</li>
<li><a href="#%E5%BC%80%E6%BA%90esphome%E9%80%9A%E7%94%A8%E8%93%9D%E7%89%99%E7%BD%91%E5%85%B3">自制开源ESPHome通用蓝牙网关(ESP32-C3)</a></li>
<li>Yeelight 智能调光开关(YLKG08YL) 贴装版 旋动一格有明显的喀哒声音,不错,但是,并没有信号发出,必须连续扭动两格(大约)才是1 step, 如果单独一格一格的扭动,也没有信号.
<ul>
<li><img src="./Yeelight-YLKG08YL.jpg" alt="Yeelight-YLKG08YL"></li>
</ul>
</li>
</ul>
<h3 id="xiao-mi-lan-ya-wen-shi-du-ji-2-shua-di-san-fang-kai-yuan-gu-jian" class="heading-control">小米蓝牙温湿度计2刷第三方开源固件<a class="heading-anchor" href="#xiao-mi-lan-ya-wen-shi-du-ji-2-shua-di-san-fang-kai-yuan-gu-jian" aria-hidden="true"></a></h3>
<p><img src="./mi_temp2.jpg" alt="Mi temp2"></p>
<ul>
<li>小米蓝牙温湿度计2价格便宜,只有Zigbee温湿度计的一半不到,还带屏幕</li>
<li>蓝牙穿墙能力弱于Zigbee</li>
<li>官方原始固件:
<ul>
<li>10分钟报告1次温湿度,大约1小时报告1次电量.如果想和其它设备联动(如,空调),这个上报频率就没法用.</li>
<li>依然耗电</li>
<li>无法调整配置</li>
</ul>
</li>
</ul>
<p>而在刷入第三方开源固件后:</p>
<ul>
<li>更省电</li>
<li>可调节报告频率,默认是2.5秒报告1次温湿度,这个频率联动完全足够,报告频率越低越省电.</li>
<li>可以读取设备上记录的温湿度数据(循环记录19632个测量结果),记录的时间间隔也可以配置</li>
<li>可以校准温湿度以及设置自己的舒适温度区间</li>
<li>可调节蓝牙发射功率(自己权衡省电或信号覆盖率)</li>
</ul>
<h4 id="di-san-fang-gu-jian-shua-ji" class="heading-control">第三方固件刷机<a class="heading-anchor" href="#di-san-fang-gu-jian-shua-ji" aria-hidden="true"></a></h4>
<p>使用Chrome浏览器即可直接Web刷机,请启用浏览器的<a href="chrome://flags/#enable-experimental-web-platform-features">#enable-experimental-web-platform-features</a>功能后重启浏览器.</p>
<ol>
<li>点击 <a href="https://pvvx.github.io/ATC_MiThermometer/TelinkMiFlasher.html" target="_blank" rel="noopener">TelinkMiFlasher.html</a> 进入刷机页面</li>
<li>点击 <code>Connect</code> 按钮,连接待刷机的小米蓝牙温湿度计2,设备名一般是: <code>LYWSD03MMC</code></li>
<li>配对连接后,点击<code>Do Activate</code>按钮,自动获取小米蓝牙温湿度计2的token和绑定密码</li>
<li>然后点 <code>Custom firmware ver 3.7</code> 按钮, 旁边那个<code>Original_OTA_Xiaomi_LYWSD03MMC_v1.0.0_0130.bin</code>按钮是恢复原来的官方固件</li>
<li>点<code>Start Flashing</code>按钮开始刷机</li>
<li>成功后即可在该页面上修改各种配置参数.要想更省电可以把发射功率和上报频率调节得更小些即可.</li>
<li>点击参数配置的 <code>Show all mi keys</code>按钮,显示设备的MAC地址,并自己记录下来温湿度计的MAC(不包括最后4位,最后4位是随机数,不是MAC地址),后面要用</li>
</ol>
<p>最后,请关闭刚才用于刷机的蓝牙适配器设备,不然HA设备没法发现小米蓝牙温湿度计2.</p>
<p>我修改后的温度计配置:</p>
<ul>
<li>Advertising interval: 3125 ms</li>
<li>Measure interval: 4 x(Advertising interval)</li>
<li>Connect latency: 2600 ms</li>
<li>Recording averaging measurements to flash memory: 90 x(measure interval)</li>
</ul>
<h3 id="xiao-mi-ti-zhi-cheng-2-jie-ru-ha-duo-ren-ti-zhong-zi-dong-ji-lu-fang-an" class="heading-control">小米体脂秤2接入HA多人体重自动记录方案<a class="heading-anchor" href="#xiao-mi-ti-zhi-cheng-2-jie-ru-ha-duo-ren-ti-zhong-zi-dong-ji-lu-fang-an" aria-hidden="true"></a></h3>
<p><img src="./mi_scale2.jpg" alt="mi_scale2"></p>
<p>本解决方案可以支持多人体重自动记录(前提是每个人有明显的体重区分或阻抗区分),以及完美显示最近一次的的人体体重,体脂信息.</p>
<blockquote>
<p>使用的前提硬件,需要至少支持BLE蓝牙4.0(蓝牙是向下兼容的,所以BLE蓝牙5也可)的适配器,一般的HA盒子都有,如果是用PC就看带WIFI不,一般WIFI都带蓝牙,没有就买一个支持的USB WIFI适配器.</p>
</blockquote>
<p>请首先安装 <code>Passive BLE Monitor 集成</code>.</p>
<p>如果你已经勾选了<code>Passive BLE Monitor 集成</code>的&quot;自动发现设备及传感器&quot;,那么小米体脂秤2开机后多等一会(保持体脂秤屏幕常亮),就应该看到在该集成(Bluetooth Low Energy Monitor)下多出一个<code>Mi Scale V2</code>设备,你可以重命名一个有意义的名字.</p>
<p>如果你希望看到详细的体脂信息,那么需要先在HACS第三方集成商场中安装 <a href="https://github.com/dckiller51/bodymiscale" target="_blank" rel="noopener">BodyMiScale 集成</a>: 点击 <code>HACS</code> -&gt; <code>集成</code> -&gt; <code>自定义存储库</code>(右上角三个点中) -&gt; 存储库设置为 “<a href="https://github.com/dckiller51/bodymiscale" target="_blank" rel="noopener">https://github.com/dckiller51/bodymiscale</a>” , 类别为: <code>集成</code></p>
<p><strong>注意</strong>,<a href="https://github.com/dckiller51/bodymiscale" target="_blank" rel="noopener">BodyMiScale 集成</a>的最新版本<code>2.1 版本</code>需要您安装的<code>Home Assistant</code>是 <code>2022.4</code> 以上版本才能支持,否则您只能安装<code>bodymiscale@2.0</code>以下版本,切勿升级.</p>
<p><a href="https://github.com/dckiller51/bodymiscale" target="_blank" rel="noopener">BodyMiScale 集成</a>的最新版本已经支持直接在配置界面中配置:</p>
<ol>
<li><code>配置</code> -&gt; <code>设备与服务</code> -&gt; <code>添加集成</code> -&gt; 搜索 <code>BodyMiScale</code>
<ul>
<li><img src="./sel-bodymiscale.png" alt="Sel-BodyMiScale"></li>
</ul>
</li>
<li>开始配置 <code>BodyMiScale</code>
<ul>
<li><img src="./bodymiscale.png" alt="BodyMiScale"></li>
</ul>
</li>
<li>如果有多人重复上述操作</li>
</ol>
<p>如果是<a href="https://github.com/dckiller51/bodymiscale" target="_blank" rel="noopener">BodyMiScale</a>@2.0及以下的版本必须在<code>configuration.yaml</code>手工配置传感器:</p>
<pre><code class="yml"><span class="hljs-attr">bodymiscale:</span>
  <span class="hljs-attr">your_name1:</span>
    <span class="hljs-attr">sensors:</span>
      <span class="hljs-attr">weight:</span> <span class="hljs-string">sensor.ble_stabilized_weight_XXXX</span>
      <span class="hljs-attr">impedance:</span> <span class="hljs-string">sensor.ble_impedance_XXXX</span>
    <span class="hljs-attr">height:</span> <span class="hljs-number">176</span>
    <span class="hljs-attr">born:</span> <span class="hljs-string">"1990-04-10"</span>
    <span class="hljs-attr">gender:</span> <span class="hljs-string">"male"</span>
    <span class="hljs-attr">model_miscale:</span> <span class="hljs-string">"181B"</span> <span class="hljs-comment"># miscale2</span>
  <span class="hljs-attr">your_name2:</span>
    <span class="hljs-attr">sensors:</span>
      <span class="hljs-attr">weight:</span> <span class="hljs-string">sensor.ble_stabilized_weight_XXXX</span>
      <span class="hljs-attr">impedance:</span> <span class="hljs-string">sensor.ble_impedance_XXXX</span>
    <span class="hljs-attr">height:</span> <span class="hljs-number">176</span>
    <span class="hljs-attr">born:</span> <span class="hljs-string">"1990-04-10"</span>
    <span class="hljs-attr">gender:</span> <span class="hljs-string">"male"</span>
    <span class="hljs-attr">model_miscale:</span> <span class="hljs-string">"181D"</span> <span class="hljs-comment">#  miscale1</span>
</code></pre>
<p>重启后就会多出来名为: <code>bodymiscale.your_name1</code> 和 <code>bodymiscale.your_name2</code>的实体.</p>
<p>然后你需要在HACS第三方集成商场中安装<a href="https://github.com/dckiller51/lovelace-body-miscale-card" target="_blank" rel="noopener">lovelace-body-miscale-card</a> 界面, 来使用该实体.</p>
<p>先加库: 点击 <code>HACS</code> -&gt; <code>集成</code> -&gt; <code>自定义存储库</code>(右上角三个点中) -&gt; 存储库设置为 <code>https://github.com/dckiller51/lovelace-body-miscale-card</code> , 类别为: <code>Lovelace</code></p>
<p>然后再安装该界面. 最后复制仓库中的图片文件(<code>src/images/*</code>)到<code>config/www/images</code>目录下.</p>
<p>接着就可以在 lovelace 中进行配置了:</p>
<pre><code class="yml"><span class="hljs-attr">type:</span> <span class="hljs-string">custom:body-miscale-card</span>
<span class="hljs-attr">entity:</span> <span class="hljs-string">bodymiscale.your_name1</span>
<span class="hljs-attr">show_name:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">image:</span> <span class="hljs-string">/local/images/miscale2.jpg</span>
<span class="hljs-attr">show_states:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">show_attributes:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">show_body:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">show_buttons:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">show_toolbar:</span> <span class="hljs-literal">true</span>
</code></pre>
<p>如果有多个人需要分别记录,并且可以通过体重区分的话,当然你也可以加上阻抗值(impedance)来判断,那么可以在<code>configuration.yaml</code>中:</p>
<pre><code class="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">platform:</span> <span class="hljs-string">template</span>
  <span class="hljs-attr">sensors:</span>
    <span class="hljs-comment"># the first person's weight</span>
    <span class="hljs-attr">weight_your_name:</span>
      <span class="hljs-attr">friendly_name:</span> <span class="hljs-string">"Weight Your Name"</span>
      <span class="hljs-attr">value_template:</span> <span class="hljs-string">&gt;-
        {% set weight = states('sensor.ble_stabilized_weight_XXXX') | float %}
        {% if 66.9 <= weight <="77" %} {{ states("sensor.ble_stabilized_weight_xxxx") }} {% else states("sensor.weight_your_name") endif span>      <span class="hljs-attr">unit_of_measurement:</span> <span class="hljs-string">'kg'</span>
      <span class="hljs-attr">icon_template:</span> <span class="hljs-string">mdi:weight-kilogram</span>
    <span class="hljs-comment"># the first person's impedance</span>
    <span class="hljs-attr">impedance_your_name:</span>
      <span class="hljs-attr">friendly_name:</span> <span class="hljs-string">"Impedance Your Name"</span>
      <span class="hljs-attr">value_template:</span> <span class="hljs-string">&gt;-
        {% set weight = states('sensor.ble_stabilized_weight_XXXX') | float %}
        {% if 66.9 <= weight <="77" %} {{ states("sensor.ble_impedance_xxxx") }} {% else states("sensor.impedance_your_name") endif span>      <span class="hljs-attr">unit_of_measurement:</span> <span class="hljs-string">'ohm'</span>
      <span class="hljs-attr">icon_template:</span> <span class="hljs-string">mdi:omega</span>
</=></span></=></span></code></pre>
<p>问题又来了,如何显示最近的历史数据. 因为当电子秤离线后或者HA重启后,就没当前数据(最近一次的)了!</p>
<p>还是用的SQL Sensor获取的最近一次的历史数据:</p>
<pre><code class="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">platform:</span> <span class="hljs-string">sql</span>
  <span class="hljs-attr">db_url:</span> <span class="hljs-type">!secret</span> <span class="hljs-string">db_url</span>
  <span class="hljs-attr">queries:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Latest</span> <span class="hljs-string">Weight</span> <span class="hljs-string">Your</span> <span class="hljs-string">Name</span>
      <span class="hljs-attr">query:</span> <span class="hljs-string">"SELECT state FROM states WHERE entity_id = 'sensor.weight_your_name' and state &lt;&gt; 'unknown' and state &lt;&gt; 'unavailable' ORDER BY created DESC LIMIT 1;"</span>
      <span class="hljs-attr">column:</span> <span class="hljs-string">"state"</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Latest</span> <span class="hljs-string">Impedance</span> <span class="hljs-string">Your</span> <span class="hljs-string">Name</span>
      <span class="hljs-attr">query:</span> <span class="hljs-string">"SELECT state FROM states WHERE entity_id = 'sensor.impedance_your_name' and state &lt;&gt; 'unknown' and state &lt;&gt; 'unavailable' ORDER BY created DESC LIMIT 1;"</span>
      <span class="hljs-attr">column:</span> <span class="hljs-string">"state"</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">platform:</span> <span class="hljs-string">template</span>
  <span class="hljs-attr">sensors:</span>
    <span class="hljs-attr">weight_your_name:</span>
      <span class="hljs-attr">friendly_name:</span> <span class="hljs-string">"Weight Your Name"</span>
      <span class="hljs-attr">value_template:</span> <span class="hljs-string">&gt;-
        {% set weight = states('sensor.ble_stabilized_weight_XXXX') | float(0) %}
        {% set id = 'weight_your_name' %}
          {% if 66.9 <= weight <="77" %} {{ }} {% elif state_attr("sensor.latest_"+id, 'state') else states("sensor."+id) endif span>      <span class="hljs-attr">unit_of_measurement:</span> <span class="hljs-string">'kg'</span>
      <span class="hljs-attr">icon_template:</span> <span class="hljs-string">mdi:weight-kilogram</span>
    <span class="hljs-attr">impedance_your_name:</span>
      <span class="hljs-attr">friendly_name:</span> <span class="hljs-string">"Impedance Your Name"</span>
      <span class="hljs-attr">value_template:</span> <span class="hljs-string">&gt;-
        {% set weight = states('sensor.ble_stabilized_weight_XXXX') | float(0) %}
        {% set id = 'impedance_your_name' %}
          {% if 66 <= weight <="77" %} {{ states("sensor.ble_impedance_xxxx") }} {% elif state_attr("sensor.latest_"+id, 'state') else states("sensor."+id) endif span>      <span class="hljs-attr">unit_of_measurement:</span> <span class="hljs-string">'ohm'</span>
      <span class="hljs-attr">icon_template:</span> <span class="hljs-string">mdi:omega</span>
</=></span></=></span></code></pre>
<p>注意:   <code>db_url: !secret db_url</code> 要填写自己<code>recorder</code>数据库的url. 详细请参阅 : <a href="https://www.home-assistant.io/integrations/sql/" target="_blank" rel="noopener">SQL Sensor</a></p>
]]></content>
      <categories>
        <category>Open Source</category>
        <category>Hardware</category>
        <category>SmartHome</category>
      </categories>
      <tags>
        <tag>thinking</tag>
        <tag>iot</tag>
        <tag>open source</tag>
        <tag>hardware</tag>
        <tag>smarthome</tag>
        <tag>homeassistant</tag>
        <tag>ha</tag>
        <tag>wifi</tag>
      </tags>
  </entry>
  <entry>
    <title>智能家居硬件采购避坑指要(二) Wifi设备</title>
    <url>/article/home-assistant-wifi/</url>
    <content><![CDATA[<h1 id="zhi-neng-jia-ju-ying-jian-cai-gou-bi-keng-zhi-yao-er-wifi-she-bei" class="heading-control">智能家居硬件采购避坑指要(二) Wifi设备<a class="heading-anchor" href="#zhi-neng-jia-ju-ying-jian-cai-gou-bi-keng-zhi-yao-er-wifi-she-bei" aria-hidden="true"></a></h1>
<p><img src="./wifi-smart-home.jpg" alt></p>
<h2 id="wifi-te-xing" class="heading-control">Wifi 特性<a class="heading-anchor" href="#wifi-te-xing" aria-hidden="true"></a></h2>
<ol>
<li>穿墙性能好(与Zigbee和蓝牙相比)</li>
<li>高带宽(与Zigbee和蓝牙相比)</li>
<li>Wifi模块便宜</li>
<li>需要考虑路由器的带机量,一般家用路由器的带机量都不大.</li>
<li>最好选择直接供电(非电池)的Wifi设备,避免频繁更换电池的麻烦</li>
</ol>
<p>Zigbee2MQTT的低功耗是源于它的低速,但某些场合则要求高带宽,比如<code>IP摄像头</code>. 而对IP摄像头来说支持 <code>ONVIF(Open Network Video Interface Forum)</code> 协议是必须的,不支持开放网络视频协议的都是在耍流氓,当用户是羊!比如:<strong>萤石</strong>私有协议,看似可以接入HA,你不知道的是所有的控制都要去他们公司云上绕一圈才回来,为了达到偷窥家庭的目的,特意废弃一贯支持的<code>ONVIF</code>,搞了萤石私有协议,让他们公司的有权限的人可以随时随地观看场景剧甚至动作片,不旺一番苦心.</p>
<p>另,就算商家告诉你支持<code>ONVIF</code>也不要掉以轻心,因为<code>ONVIF</code>也是可深可浅,浅的就只有选择个分辨率,控制录像,深的则可以控制云台,控制麦克风语音,以及触发运动事件等. 乐橙号称支持<code>ONVIF</code>, 但是居然把Web管理端给去掉了!导致要用Wifi就不能修改设备密码,只能使用设备固定初始的安全码(真的安全吗?),如果要改密码只能在复位后,通过网口连上后用大华的IP配置工具修改,然后Wifi配置就没辙了,只能用有线网络,还有他的 ntp 授时服务配置根本没有用,用的是自家的端口号10000的一个鬼服务,这个端口一屏蔽时间就完蛋,然后就是录制视频上的<strong>时间和乐橙LOGO</strong>居然无法取消.</p>
<p>其它Wifi设备最好使用能刷 开源<a href="https://esphome.io/" target="_blank" rel="noopener">ESPHome</a> 或 <a href="https://tasmota.github.io/" target="_blank" rel="noopener">Tasmota</a>固件的设备, 这样就能完全掌控该设备:</p>
<ul>
<li><a href="https://www.esphome-devices.com/" target="_blank" rel="noopener">ESPHome 支持的设备列表</a></li>
<li><a href="https://templates.blakadder.com/" target="_blank" rel="noopener">Tasmota 支持的设备列表</a></li>
</ul>
<h2 id="wo-mai-guo-de-wifi-she-bei" class="heading-control">我买过的WIFI设备<a class="heading-anchor" href="#wo-mai-guo-de-wifi-she-bei" aria-hidden="true"></a></h2>
<ul>
<li>乐橙(IMou TP7S-4M)IP摄像头: 坑货,如果不是因为半价,勉强可用(支持<code>ONVIF</code>云台控制)就退了,所谓AI人脸识别,追踪全是联机服务和产品无关 不推荐
<ul>
<li>当然更坑的是<strong>萤石</strong>,连<code>ONVIF</code>也不支持,海康威视不敢坑企业和政府,于是专门成立<strong>萤石</strong>出来坑普通消费者的,而<strong>乐橙</strong>则是大华专门成立出来坑的.</li>
</ul>
</li>
<li>SONOFF(易微联 NSPanel) 智能面板, 带温度,小喇叭,两路继电器,两个实体按钮及触摸屏, 可刷开源 ESPHome 固件,<strong>推荐</strong>
<ul>
<li><img src="./nspanel.jpg" alt="nsPanel"></li>
<li><a href="https://bbs.hassbian.com/thread-15932-1-1.html" target="_blank" rel="noopener">易微联 SONOFF NSPanel 智能面板刷 ESPHome 固件 接入 HA 入坑指南</a></li>
</ul>
</li>
<li>博联 RM Pro 万能遥控器: 支持红外,以及 RF315/433 很久以前买的
<ul>
<li><img src="./rmpro.jpg" alt="Broadlink RM Pro"></li>
</ul>
</li>
<li>博联 SPMini3 Wi-Fi插座（10A） 很久以前买的
<ul>
<li><img src="./sp_mini3.jpg" alt="sp_mini3"></li>
</ul>
</li>
<li>小米路由器CR6608（移动定制版）: 已刷开源OpenWRT固件
<ul>
<li><img src="./cr6608.jpg" alt="cr6608"></li>
</ul>
</li>
<li>树莓派 Zero/w BCM2835 1GHz 主频 ARM11 32位单核, 512 MB DDR2
<ul>
<li><img src="./raspberrypi_zerow.jpg" alt="RaspberryPi Zero/w"></li>
</ul>
</li>
<li>Banana PI BPI-M2 Zero Allwinner H2+, 32位 Quad-core Cortex-A7 1.2GHz, Mali400 MP2 @600MHz, 512MB DDR 3 SDRAM
<ul>
<li><img src="Banana-PI-BPI-M2-Zero.jpg" alt="Banana-PI-BPI-M2-Zero"></li>
</ul>
</li>
<li>Lichee RV 86 Panel 基于平头哥玄铁C906处理器,主频1GHz 512MB DDR3内存
<ul>
<li><img src="./Sipeed-Lichee-RV-86-Panel.jpg" alt="Sipeed-Lichee-RV-86-Panel"></li>
</ul>
</li>
<li>RockPi S With PoE Hat Rockchip RK3308 512MB DDR3,4G NAND
<ul>
<li><img src="./RockPi-S-With-PoE-Hat-Shell.jpg" alt="RockPi S With PoE Hat"></li>
</ul>
</li>
<li>Rock5 Model B RK3588 16GB RAM
<ul>
<li>Quad-core ARM Cortex-A76 MPCore processor and quad-core ARM Cortex-A55 MPCore processor</li>
<li>Embedded ARM Mali-G610 MP4 3D GPU</li>
<li>The build-in NPU supports INT4/INT8/INT16/FP16 hybrid operation and computing power is up to 6TOPs</li>
<li><img src="./rock5b.jpg" alt="Rock5B"></li>
</ul>
</li>
<li>NanoPi R4S
<ul>
<li><img src="./Nanopi-R4S.jpg" alt="Nanopi-R4S"></li>
</ul>
</li>
<li>HK1 Box
<ul>
<li><img src="./HK1-Box.jpg" alt="HK1-Box"></li>
</ul>
</li>
<li>NanoPC T4 Box
<ul>
<li><img src="./NanoPC-T4-Box.jpg" alt="NanoPC-T4-Box"></li>
</ul>
</li>
<li>CubieTruck Box
<ul>
<li><img src="./CubieTruck.jpg" alt="CubieTruck"></li>
</ul>
</li>
<li>以及ESP32/ESP8266板子若干</li>
</ul>
<h2 id="kai-yuan-esphome-he-tasmota-gu-jian-bi-jiao" class="heading-control">开源 ESPHome 和 Tasmota 固件比较<a class="heading-anchor" href="#kai-yuan-esphome-he-tasmota-gu-jian-bi-jiao" aria-hidden="true"></a></h2>
<p><a href="https://esphome.io/" target="_blank" rel="noopener">ESPHome</a> 和 <a href="https://tasmota.github.io/" target="_blank" rel="noopener">Tasmota</a> 都是基于 ESP8266 或 ESP32 的开源固件，用于控制智能家居设备的固件。它们都提供了很多功能，例如支持 MQTT、HTTP、WebSocket，以及对各种传感器和执行器的支持。</p>
<p>然而，它们在以下几个方面有所不同：</p>
<ol>
<li>设计哲学：ESPHome 的设计哲学是通过 YAML 文件进行配置，以使用户可以轻松地定义其设备的功能，而无需编写任何代码。另一方面，Tasmota 侧重于使用 Web 界面进行配置，其界面和配置选项更为复杂。
<ol>
<li>ESPHome的固件是按需编译,体积更小</li>
<li>而Tasmota的固件是将所有功能都预先编译内置在固件中,体积大</li>
</ol>
</li>
<li>设备支持：ESPHome 目前支持更多的设备，而且它提供了对许多设备的官方支持。 Tasmota 虽然支持许多设备，但某些设备需要使用非官方固件或插件才能使用。</li>
<li>社区支持：ESPHome 和 Tasmota 都有活跃的社区，但 ESPHome 的社区更加友好和活跃，并且有更多的文档和示例可供参考。</li>
<li>集成性：ESPHome 的集成性更好，可以轻松地将其与 Home Assistant 和其他智能家居平台集成。Tasmota 也可以集成到 Home Assistant 中，但需要更多的设置和调整。</li>
</ol>
]]></content>
      <categories>
        <category>Open Source</category>
        <category>Hardware</category>
        <category>SmartHome</category>
      </categories>
      <tags>
        <tag>thinking</tag>
        <tag>iot</tag>
        <tag>open source</tag>
        <tag>hardware</tag>
        <tag>smarthome</tag>
        <tag>homeassistant</tag>
        <tag>ha</tag>
        <tag>wifi</tag>
      </tags>
  </entry>
  <entry>
    <title>智能家居硬件采购避坑指要(一) Zigbee设备</title>
    <url>/article/home-assistant-zigbee/</url>
    <content><![CDATA[<p><img src="./zigbee-smart-home.jpg" alt></p>
<h1 id="zhi-neng-jia-ju-ying-jian-cai-gou-bi-keng-zhi-yao-yi-zigbee-she-bei" class="heading-control">智能家居硬件采购避坑指要(一) Zigbee设备<a class="heading-anchor" href="#zhi-neng-jia-ju-ying-jian-cai-gou-bi-keng-zhi-yao-yi-zigbee-she-bei" aria-hidden="true"></a></h1>
<p>注意: <a href="https://www.home-assistant.io/" target="_blank" rel="noopener">Home Assistant</a> 简称 HA, 后面我就用简称了.</p>
<h2 id="zigbee-she-bei-de-te-xing" class="heading-control">Zigbee设备的特性<a class="heading-anchor" href="#zigbee-she-bei-de-te-xing" aria-hidden="true"></a></h2>
<p>为啥要以Zigbee设备为主,这就要从它的特性谈起:</p>
<ol>
<li>低功耗：由于节点常常休眠，zigbee是比较省电的,一般1-2年</li>
<li>短时延，设备激活快，点播中的消息确认是微秒级别；不过路径长的话会增加延时</li>
<li>可靠,安全,数据通讯是加密的</li>
<li>网络容量大：实际CC2530组建的网络基本能达到100个节点</li>
<li>自组织和自愈性，协调器自动建立网络，有节点故障时网络可以自我修复</li>
<li>近距离，单个节点通讯范围最多是100米以内</li>
<li>支持的设备的多: 因为Zigbee设备的协议基本透明(或破解)了,大多可以<strong>直接接入</strong>HA.</li>
</ol>
<h2 id="tang-keng-ji-lu" class="heading-control">蹚坑记录<a class="heading-anchor" href="#tang-keng-ji-lu" aria-hidden="true"></a></h2>
<p>这里<strong>注意</strong>: 不要通过什么各类<code>**多模网关**</code>(如:小米/绿米)来接入,它们只能接入<code>大桶</code>内的zigbee设备!而且他们不停的向互联网发送采集到的设备数据,并能从网络上<strong>直接接管</strong>您的设备.</p>
<p>我最初买的就是<strong>小米多模网关</strong>和<strong>绿米M1S网关</strong>,试用后退掉了<strong>小米多模网关</strong>,留下了<strong>绿米M1S网关</strong>,图它的彩灯,没想到这个坑货,我一旦屏蔽<strong>绿米M1S网关</strong>连接互联网,那绿米的破彩灯不一会儿就闪个不停关掉停一会儿又闪. 后来发现了 <strong>Zigbee2MQTT(Z2M) USB网关</strong>,把我所有的Zigbee设备转到新的Z2M USB上去,才终于清静了.</p>
<p>请购买使用开源的 <a href="https://www.zigbee2mqtt.io/" target="_blank" rel="noopener">Zigbee2MQTT(Z2M)</a> 网关接入,价格也不贵. <a href="https://www.zigbee2mqtt.io/" target="_blank" rel="noopener">Z2M</a> 支持的硬件网关列表: <a href="https://www.zigbee2mqtt.io/guide/adapters/" target="_blank" rel="noopener">https://www.zigbee2mqtt.io/guide/adapters/</a></p>
<p>我买的是<a href="https://sonoff.tech/product/diy-smart-switch/sonoff-dongle-plus/" target="_blank" rel="noopener">SONOFF USB Dongle Plus</a>万能通用网关(基于CC2652P芯片)价位在￥70左右, 该网关通过<a href="https://www.zigbee2mqtt.io/" target="_blank" rel="noopener">Z2M</a>能支持2千余种的Zigbee设备. <strong>值得推荐</strong></p>
<p><a href="https://sonoff.tech/product/diy-smart-switch/sonoff-dongle-plus" target="_blank" rel="noopener"><img src="./sonoff-dongle-plus.png" alt="sonoff-dongle-plus"></a></p>
<p><a href="https://www.zigbee2mqtt.io/" target="_blank" rel="noopener">Z2M</a>具体支持的设备列表请看这里: <a href="https://www.zigbee2mqtt.io/supported-devices/" target="_blank" rel="noopener">https://www.zigbee2mqtt.io/supported-devices/</a>. 够让你挑花眼的, 我买的绝大部分Zigbee设备在Z2M均能正常使用,包括绿米/小米的Zigbee设备,反而是在SONOFF(易微联)的温度计和按钮上碰到了点小问题.</p>
<p>先说说碰到的问题吧:</p>
<p>首先涂鸦的设备质量参差不齐,因为涂鸦主要是卖方案的,所以实际上设备要看各个厂家的品控.购买要多加小心. 我试过三家的涂鸦人体PIR传感器,其中有一家发过来的全是坏的:一个能配对,但是工作一会就没有数据了,另一个根本不工作,配对都不行. 另外两家的还行.我买涂鸦的设备总量比较少.</p>
<p>SONOFF(易微联SNZB-02)的温湿度计配对使用没啥问题,但是如果你再次配对到另一个Zigbee网关,然后再配对回原来的网关,你会发现,尽管配对成功,信号也正常,但就是没有数据,后来我发现当把这货配对到M1S网关,尽管M1S会报告该设备无法配对,拒绝配对后,我再配对回原来的网关,数据居然有了.<br>
<img src="./sonoff-snzb-02-s.jpg" alt="sonoff-snzb-02"></p>
<p>SONOFF(易微联SNZB-01)的按钮配对和使用也没啥问题,问题出在<code>绑定</code>上,Zigbee有个功能可以将按钮设备<code>绑定</code>到另一个设备(如开关)上,这样就算没有HA中枢,按钮也能控制另一个设备(如开关),当易微联的按钮配对时,会自动绑定一个设备(开关),这很烦,而当我在Z2M上操作解除绑定的时候,发现竟然无法解绑.而与此同时也无法绑定新设备.<br>
<img src="./sonoff-snzb-01-s.jpg" alt="sonoff-snzb-01"></p>
<p>涂鸦(Lonsonho ZB-RGBCW)全彩灯泡 如果长时间关闭电源,灯泡就会彻底掉线,需要再次重新配对join.<br>
<img src="./tuya-zb-rgbcw-tiny.jpg" alt="tuya-zb-rgbcw"></p>
<p>绿米的品控不错,但是贵,另外绿米的人体PIR传感器(RTCGQ11LM),虽然带了温度和光强,但是温度根本不准,温度差了6度,这货光强照度和M1S网关的一样在弱光下根本没值,就是0,强光下变化倒是明显,没鸟用,在<a href="https://www.zigbee2mqtt.io/" target="_blank" rel="noopener">Z2M</a>配置光强照度以及温度为精度为小数点后2位,但根本不生效,没有小数后面的数字,配置里只有温度校准有用.</p>
<p>现在用的Zigbee设备列表:</p>
<ol>
<li>SONOFF(易微联SNZB-02)的温湿度计 小问题 不推荐<br>
<img src="./sonoff-snzb-02.jpg" alt="sonoff-snzb-02"></li>
<li>SONOFF(易微联SNZB-01)的按钮    小问题 不推荐<br>
<img src="./sonoff-snzb-01.jpg" alt="sonoff-snzb-01"></li>
<li>SONOFF(易微联SNZB-03) 人体PIR传感 推荐<br>
<img src="./sonoff-snzb-03.jpg" alt="sonoff-snzb-03"></li>
<li>SONOFF(易微联SNZB-04) 门磁 推荐 <img src="./sonoff-snzb-04.jpg" alt="sonoff-snzb-04"></li>
<li><a href="https://sonoff.tech/product/diy-smart-switch/sonoff-dongle-plus/" target="_blank" rel="noopener">SONOFF(易微联) USB Dongle Plus</a> 万能通用网关(基于CC2652P芯片) 推荐 <img src="./sonoff-dongle-plus.png" alt="sonoff-dongle-plus"></li>
<li>涂鸦(Lonsonho ZB-RGBCW)灯泡 不推荐 <img src="./tuya-zb-rgbcw.jpg" alt="tuya-zb-rgbcw"></li>
<li>涂鸦(TuYa TS0203) 门磁 <img src="./tuya-ts0203.jpg" alt="ts0203"></li>
<li>涂鸦(TuYa TS0202) 人体PIR传感 <img src="./tuya-ts0202.jpg" alt="ts0202"></li>
<li>涂鸦(TuYa TS0601_motion_sensor) 人体毫米波雷达传感 性价比太差,不如买IP摄像头 <img src="./tuya-ts0601_motion_sensor.jpg" alt="tuya-ts0601_motion_sensor"></li>
<li>绿米(Xiaomi QBCZ11LM)86插座 可中继 <img src="./Aqara_QBCZ11LM.jpg" alt="Aqara_QBCZ11LM"></li>
<li>绿米(Xiaomi WSDCGQ11LM) 温湿度计 <img src="./Aqara_WSDCGQ11LM.jpg" alt="Aqara_WSDCGQ11LM"></li>
<li>绿米(Xiaomi RTCGQ11LM) 人体PIR传感 带温度和光强 它的温度和光强没法用,不推荐 <img src="./Aqara_RTCGQ11LM.jpg" alt="Aqara_RTCGQ11LM"></li>
<li>小米魔方(Xiaomi MFKZQ01LM) 控制器(玩具) <img src="./Aqara-MFKZQ01LM-Cube.jpg" alt="Aqara-MFKZQ01LM-Cube"></li>
</ol>
<p>所有的Zigbee灯泡都不推荐,因为几乎都是固定死的,根本无法拆解无法更换,还是买 <code>LED Controller</code>, 或买<code>开关/通断器</code>(最好带电量统计)比较划算.</p>
<h2 id="bi-mian-yu-wifi-24g-xin-dao-gan-rao-de-wen-ti" class="heading-control">避免与WIFI 2.4G信道干扰的问题<a class="heading-anchor" href="#bi-mian-yu-wifi-24g-xin-dao-gan-rao-de-wen-ti" aria-hidden="true"></a></h2>
<p>Zigbee和Wi-Fi 2.4G信道可以互相影响，因为它们都使用了相同的频段（2.4GHz频段）。在使用Wi-Fi 2.4G信道的同时使用Zigbee设备时，可能会发生以下问题：</p>
<ol>
<li>干扰问题：当Wi-Fi和Zigbee设备同时使用2.4G信道时，它们会相互干扰，导致信号质量下降、数据传输速度变慢等问题。</li>
<li>传输距离问题：Wi-Fi信号较强，如果Wi-Fi设备的信号覆盖区域较大，可能会导致Zigbee设备的信号被遮蔽或干扰，从而影响其正常工作。</li>
</ol>
<p>为了解决这些问题，可以采取以下措施：</p>
<ol>
<li>避免使用相同信道：在使用Wi-Fi和Zigbee设备时，应尽量避免它们使用相同的2.4G信道，以避免干扰和冲突。</li>
<li>选择合适的设备：在选购Wi-Fi和Zigbee设备时，应选择具有良好的抗干扰能力和传输距离的设备，以减少冲突的发生。</li>
<li>优化网络布局：在使用Wi-Fi和Zigbee设备时，应合理规划和布局网络，避免设备之间的信号干扰和遮蔽。</li>
<li>调整信道设置：在出现干扰和冲突的情况下，可以尝试调整Wi-Fi和Zigbee设备的信道设置，以减少干扰和冲突的发生。</li>
</ol>
<p>具体来说,就是 Wi-Fi和Zigbee设备在2.4GHz频段内使用的信道有一些重叠，这些信道的中心频率有可能会相互干扰：</p>
<ul>
<li>Wi-Fi使用的信道：1、6、11、以及在部分国家可用的信道14</li>
<li>Zigbee使用的信道：11、15、20、25
<ul>
<li>所有Zigbee设备都支持11信道,其它信道不一定是所有Zigbee设备都支持.</li>
</ul>
</li>
</ul>
<p>因此，最佳方案是让WIFI避开11信道,如果实在避不开,可以让Zigbee网关尝试选择其它信道.只要不是太老的Zigbee设备就没啥问题,自行尝试.</p>
]]></content>
      <categories>
        <category>Open Source</category>
        <category>Hardware</category>
        <category>SmartHome</category>
      </categories>
      <tags>
        <tag>thinking</tag>
        <tag>iot</tag>
        <tag>open source</tag>
        <tag>hardware</tag>
        <tag>smarthome</tag>
        <tag>homeassistant</tag>
        <tag>ha</tag>
        <tag>zigbee</tag>
      </tags>
  </entry>
  <entry>
    <title>智能家居:全屋智能还是全无智能,智能产品还是智障&quot;产品&quot;(服务)</title>
    <url>/article/home-assistant-guide/</url>
    <content><![CDATA[<h1 id="quan-wu-zhi-neng-huan-shi-quan-wu-zhi-neng-zhi-neng-chan-pin-huan-shi-zhi-zhang-chan-pin-fu-wu" class="heading-control">全屋智能还是全无智能,智能产品还是智障&quot;产品&quot;(服务)<a class="heading-anchor" href="#quan-wu-zhi-neng-huan-shi-quan-wu-zhi-neng-zhi-neng-chan-pin-huan-shi-zhi-zhang-chan-pin-fu-wu" aria-hidden="true"></a></h1>
<p>要注意区分产品和服务,产品才是自己的,服务是别人的,是可以随时改变条款的. 不要花大价钱,买回一堆服务.</p>
<h2 id="yi-dian-fei-hua" class="heading-control">一点废话<a class="heading-anchor" href="#yi-dian-fei-hua" aria-hidden="true"></a></h2>
<p>现在越来越多&quot;智能&quot;产品,都要求注册/登陆后才能使用, 这不荒唐么,这是什么产品,还是服务?</p>
<p>听上去全屋智能高达上,其实只是是换了个词忽悠.你兴匆匆的东看看西看看,这家这个不错,便宜;那家那个功能强,都提全屋智能了,那还不赶紧随便挑.<br>
嘿嘿,那你就想错了,各家是各家的,各家设备彼此是无法直接沟通的,没有互联互通,谈不上智能,唯有智障,弄一大堆按钮铺满在手机上遥控就是智能?</p>
<p>更可恶的是,他们不仅仅是正大光明的控制并窃取用户隐私信息,而且他们随时都有能力把&quot;全屋智能&quot;变成全屋智障: 只要他们中断互联网服务!</p>
<p>设备所采集的传感数据和大部分的控制指令都要先到他们的云上走一圈才会执行.他们非常自豪感觉牛逼:你家发生的事情,我们最先知道!<br>
而且你不能说不,如果你说不,主动切断互联网,那么大部分智能设备就都歇菜了!</p>
<p>他们是如此的理直气壮,哪怕你不在家,我们也能让你知道家里发生的事情,我们还能帮你记录家里的事情,你看我们多好,我们的产品多先进,多智能!<br>
这是产品?这TM明明是服务!无时无刻的在偷换概念. 这就好像你去买了房子,他们不仅不把房门钥匙交给你,还随时到房间里面想看就看.这多好,要啥钥匙,<br>
这样你们都不用自己开门了,我们随叫随到给你开门,而且屋子里有任何动静我们都能通知你.</p>
<p>这样就叫&quot;全智能&quot;?这样买的又是啥设备,空气? 难道真的以为用户是羊,通过这样的办法就能把用户赶进自家的大桶里.题外话,尽管打破厂家壁垒互联互通的<a href="https://csa-iot.org/zh-CN/%E7%BC%96%E8%BE%91%E9%83%A8/%E6%99%BA%E8%83%BD%E5%AE%B6%E5%B1%85%E5%88%9B%E6%96%B0%E5%B0%86%E5%8A%A0%E9%80%9F-matter%EF%BF%BC/" target="_blank" rel="noopener">Matter协议</a>提了许久,如今国内有多少智能商家落实下去了?</p>
<p>业主应该也必须<strong>拥有</strong>所有智能设备产生的各种数据以及完全的控制智能设备,这是全屋智能的前提. 否则这所谓的智能就没啥事,充其量只能算对方提供的服务,你还要倒掏腰包把对方施行服务的产品先行买下,然后作为他们的测试人员,感受并不完美的&quot;智能&quot;:遥控,场景遥控,他们则采集各种数据就成了他们提升自身服务品质的关键,同时作为提价的手段,最后把数据打包销售.</p>
<p>诚然,不用记录管理自己的设备,简单方便,但后果呢…,那还会是你的设备么?</p>
<p>感谢开源的曙光,正义的骑士,一系列的开源智能家居设备管理软件:<code>Home Assistant</code>,让我们能够能真正掌握拥有智能设备,拥有它,所谓的全屋智能才有了可能.</p>
<h2 id="homeassistant" class="heading-control">HomeAssistant<a class="heading-anchor" href="#homeassistant" aria-hidden="true"></a></h2>
<p><img src="./ha.jpg" alt></p>
<p>HomeAssistant是一个非常聪明的小家伙，它可以通过连接各种<a href="https://www.home-assistant.io/integrations" target="_blank" rel="noopener">厂家设备</a>(截至2021年9月HA已经支持了超过1500个厂家和品牌的设备)和服务来帮助你自动化你的家居生活。它就像是一个家庭管家，可以管理你的灯光、温度、媒体设备等等。你可以告诉它你的喜好，它就会在你需要的时候自动调整，为你提供最舒适的居住体验。</p>
<p>其次，HomeAssistant非常容易上手，因为它有一个非常友好的用户界面，你甚至不需要太多的技术知识。只要你会点基础的电脑操作，就可以轻松掌握。</p>
<p>最后，HomeAssistant是一个非常有趣的小伙伴。它可以与你进行对话，让你感觉就像是在跟一个智能机器人交流一样。你可以给它下指令，它就会立刻回应。这真是太酷了！</p>
<p>所以，如果你想要一个智能家居系统，不妨考虑一下HomeAssistant。它不仅聪明、易用，而且还非常有趣。它会成为你家庭生活中不可或缺的一部分，给你带来更加便利和舒适的居住体验。</p>
<h2 id="wo-wei-sha-yao-yong-kai-yuan-ha" class="heading-control">我为啥要用开源HA<a class="heading-anchor" href="#wo-wei-sha-yao-yong-kai-yuan-ha" aria-hidden="true"></a></h2>
<p>自从开始使用<a href="https://www.home-assistant.io/" target="_blank" rel="noopener">Home Assistant</a>(简称<code>HA</code>)1个多月了,陆陆续续买了一些硬件, 在这里把使用过程中碰到的一些坑做个总结,先从HA硬件开始再说软件.</p>
<p>首先说说目的,我为啥用开源HA,而不是图省事,直接用米家桶或HomeKit,主要目的是希望把硬件掌握在自己手中,而不是厂家手中,不想要厂家来替我开关,这牵涉到:</p>
<ul>
<li>必须登陆注册才能使用</li>
<li>必须与互联网连接才能使用</li>
<li>安全:外网下厂家可随时操控家中设备，智能音箱随时监听说话，摄像头的所谓遮挡也可以远程打开，家里的电器特别是厨房大功率电器如果被人远程控制干烧还很危险的，生活作息习惯也被人分析,还记得手机上的银行AI人脸识别,背后的员工都看不下去,提醒大家注意着装,别裸.
<ul>
<li><a href="https://www.163.com/dy/article/GE1LD4T905129QAF.html" target="_blank" rel="noopener">App人脸识别不是只拍脸？专家揭秘审核后台能看到啥</a></li>
<li>使用开源的HA智能家居平台，你可以更加安全地控制自己的设备。由于HomeAssistant是开源的，所有的代码和数据都存储在你自己的设备中，你可以更加掌控自己的数据和隐私。</li>
</ul>
</li>
<li>速度问题,所有设备都要经过网络云上中转下，慢一拍</li>
<li>断网成智障,不仅如此有的还成废铁</li>
<li>自动化难以使用,只能适用简单场景,无法根据各家实际情况调整编程,说白了能用只有云上遥控和场景.</li>
<li>产品实质上掌握在厂家手里,他只要停止服务,产品立马变废铁.方不方便是厂家说了算,你说了不算,不会为你一个人改变.</li>
<li>软件封闭(非开源)无法审计,HomeKit虽然稍好一点(能够保障离线可用),但实质也一样,HomeKit软件并没有开源,只要软件停止更新,那么等软件在新系统上无法使用,离线也就玩完.</li>
<li>选择产品范围受到限制:被困于米家桶或HomeKit.
<ul>
<li>使用开源的HA智能家居平台，你可以自由地选择你想要的硬件设备，不受任何厂家的限制。无论是灯光、温度传感器、安防设备，还是音频视频设备，你都可以自由选择符合自己需求的品牌和型号，并且在HomeAssistant平台上进行自由组合和控制。</li>
</ul>
</li>
<li>无法自由地定制和修改设备的控制逻辑.
<ul>
<li>使用开源的HA智能家居平台，你可以自由地定制和修改设备的控制逻辑，满足个性化的需求。HomeAssistant提供了非常强大的自动化和脚本功能，你可以根据自己的需求编写自己的自动化逻辑，并且将不同品牌和型号的设备进行联动。这样，你可以让你的智能家居设备更加符合自己的生活习惯和偏好。</li>
</ul>
</li>
</ul>
<p>要注意区分产品和服务,产品才是自己的,服务是别人的,是可以随时改变条款的.不要花大价钱,买回一堆服务就成.</p>
<p>看一些服务的例子(<strong>反面教材</strong>):</p>
<h4 id="1-ai-yun-zhi-neng-chang-jing-kong-a1" class="heading-control">1. <a href="https://post.smzdm.com/p/751997/" target="_blank" rel="noopener">艾韵智能场景控A1</a><a class="heading-anchor" href="#1-ai-yun-zhi-neng-chang-jing-kong-a1" aria-hidden="true"></a></h4>
<p><img src="./aiwin.jpg" alt="aiwin.jpg"></p>
<p>这货其实就是带WIFI的万能红外遥控器,可以通过手机控制它, 但是在它的奇葩实现中，所有的控制消息都要经过厂家的服务器(在互联网上)中转，因此它硬是把好端端的产品变成了服务. 于是不幸的事情发生了,该厂如今已倒闭跑路了，服务器也早已失联，所以原厂功能完全用不了,成了废铁一块。</p>
<h4 id="2-fei-xun-zhi-neng-ti-zhi-cheng" class="heading-control">2. <a href="https://zhuanlan.zhihu.com/p/31599769" target="_blank" rel="noopener">斐讯智能体脂秤</a><a class="heading-anchor" href="#2-fei-xun-zhi-neng-ti-zhi-cheng" aria-hidden="true"></a></h4>
<p><img src="./pxScale.jpg" alt="PeiXunScale"></p>
<p>该秤需要安装APP并注册后才能得到体脂, 但是该厂如今也已倒闭跑路了, 好在设备上还有一个屏幕,于是只能当一个普通的体重称使用(设备上看不到体脂信息).</p>
<h4 id="3-ge-lei-zhi-neng-yin-xiang" class="heading-control">3. 各类智能音箱<a class="heading-anchor" href="#3-ge-lei-zhi-neng-yin-xiang" aria-hidden="true"></a></h4>
<p><img src="./popular-smart-speaker.jpg" alt="popular-smart-speaker"></p>
<p>不用说了全都是服务,根本不算是产品,首先要你注册才能使用,然后必须要能连互联网,你把互联网断开试一试,立马变智障.</p>
<h4 id="4-xiao-peng-qi-che-bei-pu-tou-tou-cuan-gai-xie-yi-zhong-shen-mian-fei-jiu-yuan-bian-cheng-le-zhi-liang-gu-zhang-jiu-yuan" class="heading-control">4. <a href="https://www.leiphone.com/category/industrynews/i6IOylL2jTWynmua.html" target="_blank" rel="noopener">小鹏汽车被曝偷偷篡改协议：终身免费救援变成了“质量故障”救援</a><a class="heading-anchor" href="#4-xiao-peng-qi-che-bei-pu-tou-tou-cuan-gai-xie-yi-zhong-shen-mian-fei-jiu-yuan-bian-cheng-le-zhi-liang-gu-zhang-jiu-yuan" aria-hidden="true"></a></h4>
<p>承诺的服务又如何呢,利益面前说变就变,小米还承诺<strong>利润率永远不超5% ，超过部分全退给用户</strong>,现在如何?</p>
<p>总之, 使用HA，你可以更加自由地选择以及控制自己的智能家居设备，提高生活品质和安全性。</p>
<p>本着如上的目的, 要想作到设备的完全控制权采购设备就要注意下面几点:</p>
<ol>
<li>以Zigbee设备为主: <a href="/article/home-assistant-zigbee">HA智能家居硬件采购避坑指要(一) Zigbee篇</a></li>
<li>以Wifi设备为辅: <a href="/article/home-assistant-wifi">​HA智能家居硬件采购避坑指要(二) Wifi篇</a></li>
<li>少量低功耗蓝牙设备: <a href="/article/home-assistant-bluetooth">​HA智能家居硬件采购避坑指要(三) 蓝牙篇</a></li>
<li>HA盒子还是PC: <a href="/article/home-assistant-box">​HA智能家居硬件采购避坑指要(四) 盒子篇</a></li>
</ol>
<p><strong>注意</strong>: <a href="https://www.home-assistant.io/" target="_blank" rel="noopener">Home Assistant</a> 简称 HA, 后面我就用简称了.</p>
<h2 id="ha-bi-keng-zhi-yao" class="heading-control">HA避坑指要<a class="heading-anchor" href="#ha-bi-keng-zhi-yao" aria-hidden="true"></a></h2>
<p>如果对Linux/Unix系统不是很熟悉,并且希望体验完整的<code>HA OS</code>体验,那么</p>
<hr>
<p>智能家居什么时候能形成既方便又安全的产业链呢，现在小米系列虽然东西比较全了，但是方便上与安全上都不太放心，所有设备都要经过网关或者小爱音箱中转下，慢一拍不说，这两个东西正是不安全的因素，外网下可随时操控家中设备，智能音箱随时监听说话，摄像头的所谓遮挡也可以远程打开，家里的电器特别是厨房大功率电器如果被人远程控制干烧还很危险的，生活作息习惯也被人分析了。。。个人理想中的智能家居应该是内网一套系统+外网一套系统，所有设备都支持内网，同时部分设备兼顾支持外网，内网设备之间用蓝牙mesh私有协议互控，部分需要外网控制的设备同时支持WIFI，WIFI可通过内网系统强行关闭。</p>
<p>只有开源才能从根上解决,智能硬件就和小电脑一样, 需要一个微型操作系统来控制, 但是目前各个厂家个人搞个人的,不能互通,自然谈不上智能, 软件水平也参差不齐, 用户想安装什么&quot;MCU操作系统&quot;就装什么, 就象PC一样,智能硬件专精硬件本身,而微型控制软件由开源社区项目负责持续改进,人人都审核代码改进功能,这样哪怕公司不在维护,你的硬件也能持续得到支持. 现在这样,真的有智能? 如果是Wifi蓝牙这块不妨看看 ESPHome : 一款开源的智能硬件控制系统, 以及 HomeAssistant 开源的智能中枢软件, 本地记录和控制所有的传感数据和智能设备,支持N多厂家.</p>
<p>从家用智能来看,总体来说截至到目前(2022-04)不可以. 目前还没有出现真正的智能设备.说是智能产品其实都是服务,都是坑. 具体表现为:<br>
必须安装厂家特定的软件,无第三方软件可选.<br>
必须联网注册登陆才能使用断网就成智障.<br>
智能设备不能自行刷第三方固件,甚至连管理密码都是掌握在厂家手里而不是用户自己手里,请问你觉得这是自己的设备么?<br>
不仅仅是蓝牙,包括zigbee以及wifi设备都是如此.<br>
当然如果你懂一点IT,而且用的是Zigbee倒是可以通过一些方法绕过.但是蓝牙不行,目前蓝牙协议大多数是各家的私有协议，互通性较差. 只有少数的蓝牙传感器被破译了协议,倒是可以,但是要控制还不行.<br>
在加上蓝牙比较耗电,比如米家的温度传感器(LYWSD03MMC)是大约10分钟才发送一次数据,如果不刷第三方固件,想与空调联动就不要想了.<br>
而Wifi如果内部用的乐鑫的芯片组(ESP8266/ESP32)是可以通过重刷固件(操作系统)来获取设备的完整控制权,推荐采用 ESPHome 开源固件, 对HomeAssistant的支持也很好.<br>
然后你需要的是安装 HomeAssistant 智能中枢软件, 如果是用Zigbee,你还需要购买 Zigbee2MQTT网关设备来代替所谓的小米/绿米多模智能网关(这货只能连接米家的,而且会被厂家控制并不停的上报你的各种只能设备数据) . 这里有一份 Zigbee2MQTT 支持的设备清单: <a href="https://www.zigbee2mqtt.io/supported-devices/" target="_blank" rel="noopener">https://www.zigbee2mqtt.io/supported-devices/</a> 目前支持近2千余种的Zigbee设备.<br>
通过 HomeAssistant 智能中枢软件,你才能真正掌控自己的设备,包括在本地记录并控制你自己的各种传感数据而不是被厂家所监控:<br>
厂家可随时操控家中设备，智能音箱随时监听说话，IP摄像头的所谓遮挡也可以远程打开，家里的电器特别是厨房大功率电器如果被人远程控制干烧还很危险的，生活作息习惯也被人分析.<br>
如此智能设备才不会一断网就成智障设备.<br>
普通玩家建议还是别玩,如果是搞IT开发人员那么就别犹豫,上吧.<br>
看看HomeAssistant能作些啥: Home Assistant Demo</p>
<p>​一点点经验教训</p>
<p>摄像头必须支持ONVIF协议,才能本地控制, ONVIF协议最基本的是支持两路不同分辨率的视频流, 最好支持摄像头和云台控制和事件(这个有的化就可以实现按需拍摄)</p>
<p>千万别买萤石和乐橙, 尤其是萤石, 萤石是只有私有协议,所有视频流和云台控制都是由厂家云上控制,萤石可以接入HA,但是其实也是厂家云上控制的,视频要给厂家云观赏后才传回本地.乐橙默认也是如此, 乐橙好一点的是支持ONVIF, 但是没法更该设备密码(只能使用厂家的默认安全码),这是个安全问题,如果更改密码,ONVIF就只能使用有线模式(因为乐橙阉割掉了WEB设备控制,大华才有), 而且它的时间配置没有使用NTP Server,而是它自己的服务器(端口10000),一旦它停止服务,时间就不正常了,而且我没找到如果关闭显示的时间戳和乐橙LOGO的选项控制.</p>
<p>硬盘录像机没必要买,得到视频流后,自己想录就录, HA插件也有现成的比如: <a href="https://frigate.video/" target="_blank" rel="noopener">Frigate NVR</a> 支持AI对象检测和区域设置, 就是对硬件要求比较高.</p>
<p>从2M支持上来看 支持解锁操作的有 Kwikset 66492-001, ShinaSystem DLM-300Z, Yale YMF30/YDD-D4F0-TSDB/YDF40/YMF40/YDM4109+/YMF40A RL/YRD210-HA-605 …</p>
<p>但目前的智能锁都是在提供方便而非安全, 而且大多厂家把这个方便掌握在厂家自己手里(远程开门)而不是用户自己控制(非常危险),只有少数的厂家提供解锁了API.</p>
<p>在我看来,目前还没有真正的能满足即方便又安全的智能锁:安全和方便都是应该是用户自行设置决定的:</p>
<ol>
<li>设备密钥应该掌握在用户手里,用户可以随时签发或吊销新密钥</li>
<li>厂家要想远程开门或者获取门的状态,必须得到用户的授权(通过设备密钥签名,可以设置过期时间)</li>
<li>用户可以配置开门解锁的组合方式: 可以设置必须指纹和人脸同时匹配成功才能解锁(增强安全性),或者单独一个条件满足即可解锁(提升方便性)</li>
</ol>
<p>现在的智能锁,只是增加了一个开门渠道,方便黑客(厂家被破解或厂家内部人员泄密)进入的方式. 这个是方便你我它.</p>
<p>服务就是服务,产品就是产品,但是现在现状是几乎所有的商家都在把服务当产品宣传销售,混淆产品和服务的界限,这样的商家有任何底线可言? 如果商家坦白说的是我卖的智能门锁服务: 替您开门,让您更方便! 那我无二话.</p>
<p>编辑<br>
Floor-3D For HA</p>
<p>我在it行业，近期在装修房子，对智能这一块看的比较多，遗憾的是，身边的人或者做全屋智能的商家，能实现的无非就是灯光控制，窗帘控制，音响等，简单的说， 就是遥控器的变相实现</p>
<p>我设想的全屋智能，至少应该有以下几方面：一，节能<br>
1，零冷水，通过人在传感器、无线网络的手机mac地址、智能摄像头等采集各种信息，用相应的逻辑，来控制开启或停止系统，达到节能与方便的统一。<br>
2，制冷、制热，与各种传感器互动，控制地暖的开启关闭，制冷的开启关闭，新风的开启关闭等；比如说，房间有人就开启新风，或者感知主人回来，就开启主人书房的新风，如果空气传感器探测到主人书房空气质量非常好，就不开启新风。<br>
3、灯光控制，需要的时候开启，不需要的时候关闭。二，方便<br>
1，各种联动控制，比如说，观影模式，就直接灯光调整到合适亮度、窗帘关闭，投影机打开等等；<br>
2，灯光、窗帘、人在不在等各种智能关联，比如说人离开家，自动拉上窗帘，有个隐私保护，或者默认状态，窗帘都是关闭的，根据自己的喜好。比如说，男主人喜欢亮，那么男主人进书房，就自动打开窗帘或者开灯到最亮。女主人喜欢暗一点，那么女主人进房间，灯光打开就不是最亮档等等。<br>
3，最简单的，各种语音控制或者app直接控制等。、三、安全<br>
1，各种烟感等传感器，与其他的各种智能设备互动<br>
2，人脸识别的安全应用<br>
3，监控的联动，比如说监控到有人翻墙到院子，就报警。</p>
<p>目前,1-3点基本都可以用HA做到本地智能,而所有商家吹嘘的全是远程服务,断网就是全屋智障.</p>
<p>HA本地智能目前难点在AI这块(那些用PC的豪不在此列),受到嵌入设备的算力限制:</p>
<ol>
<li>基于 AI的 本地 TTS</li>
<li>基于 AI的 本地 语音识别</li>
<li>基于 AI的 本地 图像(人/物)识别</li>
</ol>
<p>当前智能的主要诟病再于无法精确识别各个房间是否有人,以及在做什么. 当然和以前相比现在传感器数据和控制都能通过HA直接掌控(需要选择适当的智能设备,否则你买到的还不会是设备,只是服务,得不到设备的控制权)</p>
<p>而通过摄像头进行本地 图像(人/物)识别PIR运动传感器甚至能精准到每个房间有多少人. 但是目前家用IP摄像头(其中萤石最糟糕,乐橙稍好些)都是极度的恶劣:想尽办法都想让你的视频传到它的服务器上兜一圈,是因为视频可以卖高价?</p>
<p>这里我想发表一点儿个人的想法。现在国内对于智能家居或者物联网的概念炒作乌烟瘴气的，看看现在面世的各种产品，好像所谓的智能家居就是可以用远程摄像头看看家里情况，然后可以随时随地用手机控制家中设备，小到开关灯，大到监视温湿度，烟雾报警什么的。直接的体现就是要各种设置，各种在屏幕上点点戳戳。不知道各位觉得怎样，我觉得很累。生活中加入了这样的系统，我不会觉得方便，反而觉得麻烦。这也就是为什么现在所谓的智能家居，并没有普及和很大的市场了吧。因为它们这些根本就不是真的智能家居，叫做传感网络或者是遥控更适合。</p>
<p>未来所谓的智能家居是应该在尽量不麻烦人，不干扰人正常生活的情况下，默默的在后台运行，可以体察到人的需求而自动进行动作。举个最简单的例子，我并不关心温度湿度的数字和曲线变化，我只关心是否体感舒适，如果系统发现环境不合适了直接动作调整就好了，数字曲线关我鸟事。即便是需要人的命令，自然手势，语音控制这些都比一个APP上好多个页面各种数据和按钮调节条要来得正宗也是需要重点突破的技术。 而且系统和节点的部署需要方便快捷，对用户屏蔽专业的设置，这些都是需要解决的问题。再扯远点儿，上升到理论，那就是我坚信，好的科技是顺应人的自然状态，而不是改变，所谓的 “科技以人为本”。突然好怀念诺基亚。。。。</p>
<p>实体与 HA Core 交互</p>
<p>从实体基类集成的集成实体类负责获取数据并处理服务调用。如果禁用了轮询，则它还负责告知 HA 数据何时可用。</p>
<pre><code class="mermaid">graph TB
   EntityRegistry[Entity Registry] --&gt;|Changes to entity registration| Entity
   EntityPlatform[Entity Platform] --&gt;|Poll for Update| Entity
   EntityRegistry --&gt;|&quot;State&lt;br/&gt;(if no entity object)&quot;| StateMachine[State Machine]
   Entity --&gt;|State| StateMachine
   ServiceRegistry[Service Registry] --&gt;|&quot;Service Calls&lt;br/&gt;(via entity component/platform)&quot;| Entity
</code></pre>
<p>实体基类（由实体集成定义）负责格式化数据并将其写入状态机。</p>
<p>实体注册表将为 unavailable 当前未由实体对象支持的任何注册实体写入状态。</p>
<p>实体数据层次</p>
<pre><code class="mermaid">graph TB
    ConfigEntry --&gt; DeviceRegistryEntry --&gt; EntityRegistryEntry --&gt; Entity
</code></pre>
<p>删除，禁用或重新启用任何对象，下面的所有对象都将进行相应调整。</p>
<p>什么是实体</p>
<p>实体注册表（Entity Registry）？我认为是 HA 中智能设备所能划分的最小单元，也可以理解为控制单元，如空气净化器中的温度传感器上报视作一个实体。</p>
<p>每个实体均有 Unique ID，该ID不能被用户更改，否则造成数据不一致情况。如果一个设备只有一个ID，但提供多个实体，我们可以这样标识 {unique_id}-{sensor_type}。</p>
<p>切记 Unique ID 必须全局唯一，且不可变，一般用 MAC 地址。</p>
<p>什么是设备</p>
<p>什么是设备，设备注册表（Device Registry）？HA 中的设备代表具有自己的控制单元的物理设备，它位于一个特定的地理区域，通常由一个或多个实体表示。举个例子，一台空气净化器是一台设备，它所包含的温度、湿度和PM2.5传感器（控制单元）所暴露的我们可以认为是实体。</p>
<p>但是一个实体（如温度传感器）如果拆解出来，也可以是一个独立的设备，这里更多的其实就是一个从属关系的划分（设备可以视作实体，实体可以视作设备），具体的实体或设备的划分自行考虑。配置实体、实体、设备之间的关系如下图：</p>
<pre><code class="mermaid">graph TD
  subgraph Components
     subgraph ComponentA[Component A]
       direction BT
       ConfigEntry[Config Entry] --&gt; EntryA[Entry]
       ConfigEntry[Config Entry] --&gt; EntryB[Entry]
       ConfigEntry2[Config Entry] --&gt; EntryC1[Entry]
       ConfigEntry2[Config Entry] --&gt; EntryC2[Entry]
     end
     subgraph ComponentB[Component B]
       ConfigEntryB[Config Entry] --&gt; EntryC3[Entry]
     end
  end
  subgraph Devices
     DeviceA --- EntryA
     DeviceB --- EntryB
     DeviceC --- EntryC1
     DeviceC --- EntryC2
     DeviceC --- EntryC3
  end

</code></pre>
<p>Config Entry 配置了指定的 Entry，该 Entry 可能关联着某个 Device。一个设备通常有如下属性：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>HA 生成的唯一ID</td>
</tr>
<tr>
<td>name</td>
<td>设备的名称</td>
</tr>
<tr>
<td>connections</td>
<td>connetion_type, connection_identifier的集合</td>
</tr>
<tr>
<td>identifiers</td>
<td>标识符集合，外界的设备识别号，如序列号</td>
</tr>
<tr>
<td>manufacturer</td>
<td>设备制造商</td>
</tr>
<tr>
<td>model</td>
<td>设备模型</td>
</tr>
<tr>
<td>suggested_area</td>
<td>建议设备区域</td>
</tr>
<tr>
<td>config_entries</td>
<td>联接该设备的实体</td>
</tr>
<tr>
<td>sw_version</td>
<td>设备防火墙版本</td>
</tr>
<tr>
<td>via_device</td>
<td>设备与 HA 之间路由消息的设备标识符</td>
</tr>
<tr>
<td>area_id</td>
<td>区域ID</td>
</tr>
<tr>
<td>entry_type</td>
<td>实体类型，None 或者 “service”</td>
</tr>
</tbody>
</table>
<p>通过设备注册表来进行管理。</p>
<p>什么是区域什么是区域，区域注册表（Area Registry）？区域应该是最好理解的，它用来定义区域，如客厅，卧室A，厨房等，代表了一个具体的物理位置，它可以帮助我们归集和标记设备的具体区域。</p>
<p>通过区域注册表来进行管理。</p>
<p>什么是Blueprint<br>
蓝图，是可重复使用的自动化，可以轻松共享。您可以从 Github 和社区论坛导入其他用户的 Blueprint。</p>
<p>什么是自动化其描述很清晰，为智能家居指定自动化规则。即在什么情况下想要使得智能家居做出什么样的反应。</p>
<p>什么是场景定格一组设备的状态，日后即可一键恢复。也就是说在实际使用过程中，你可能有一个固定的场景或者模式，比如家庭影院。</p>
<p>什么是脚本执行一系列动作，相当于指定流水线。可以自行考虑考虑</p>
<p>什么是lovelace<br>
相当于是一个主题，你可以在这个主题上做自己的定制。</p>
<p>目前  AI 一般指神经网络, 多用于语音识别,图像/视频识别. 而神经网络的问题是没法告诉你为什么. 其实最好的AI方式是结合推理机. 推理机执行的是人(专家)自己定义的知识规则库,而不是依据神经网络的统计分析.</p>
<p>而最早的AI是从推理机开始引申出来专家系统以及适合专家系统开发的语言(比如CLIPS ), 推理分正向推理和反向推理, 它能解释每一个推理步骤的来龙去脉,更适合由物理逻辑推动的场合(比如HA). 然后大家又开始构想更通用的知识管理(比如: Wordnet, wordnet没解决多语互通的问题,各个语言独自为镇)作为推理的基石. 以前的专家系统问题是所有的知识规则都在内存中,没有考虑知识的分类和数据库化,只是面向特定领域的.</p>
]]></content>
      <categories>
        <category>Open Source</category>
        <category>Hardware</category>
        <category>SmartHome</category>
      </categories>
      <tags>
        <tag>thinking</tag>
        <tag>iot</tag>
        <tag>open source</tag>
        <tag>hardware</tag>
        <tag>smarthome</tag>
        <tag>homeassistant</tag>
        <tag>ha</tag>
      </tags>
  </entry>
  <entry>
    <title>网摘与知识笔记杂弹</title>
    <url>/article/web-clipper/</url>
    <content><![CDATA[<h1 id="wang-zhai-yu-zhi-shi-bi-ji-za-dan" class="heading-control">网摘与知识笔记杂弹<a class="heading-anchor" href="#wang-zhai-yu-zhi-shi-bi-ji-za-dan" aria-hidden="true"></a></h1>
<h2 id="qian-yan" class="heading-control">前言<a class="heading-anchor" href="#qian-yan" aria-hidden="true"></a></h2>
<p>忙活了许久，攻克了一个接一个的难关：</p>
<ul>
<li>Offline first with P2P</li>
<li>离线(本机)人机对话界面：尝试取代信息配置界面（目前还是需要二者结合）</li>
<li>钥匙链的构造规范</li>
<li>钥匙对（数字印章）代替注册与登录</li>
<li>公开数据的加密与签名规范与实施（部分）</li>
<li>P2P数据存储与管理</li>
<li>基于矢量图（可无极缩放）的家谱树</li>
<li>离线(本机)人工智能识别人脸与身体</li>
<li>简易动画相片编辑器（自动移位、缩放动画到人脸或者指定位置）</li>
</ul>
<p>眼看我的原型项目就快完成了，结果我栽在了同步上，没错，就是 <code>PouchDB</code> 引以为豪的同步操作，第一次同步没有问题。第二次同步就歇菜，一大堆的冲突错误，但实际上我根本没有增加任何数据，粗步怀疑后续同步必需保存上一次的<code>last_seq</code>的值，这不科学，万一这玩意弄丢了，那不就再也无法同步到服务器了，这太Low了。我还记得，前面发现一个PouchDB的严重错误：在特定情况下（<code>new_edits=false</code>）的<code>bulkDocs</code>函数并不返回操作成功的的数据。然后PouchDB的维护者说，他必需保证和CouchDB的完全一致，<a href="https://github.com/pouchdb/pouchdb/issues/7916#issuecomment-560028271" target="_blank" rel="noopener">CouchDB的Bug也必需在PouchDB完全重现</a>，于是拒绝了我的PR，并关闭了Issue就当bug不存在！这脑洞到底该有多大。给PouchDB缝缝补补也有些时日，算了，累了，趁这个机会换吧，老早想换，因为PouchDB/CouchDB本来就不适合纯P2P（点对点）的存储，也就是人人都是中心的方式，P2P方式更类似于<code>Git</code>，本来考虑到是原型怎么着都无所谓，做做试验，试水一下，忍忍就过去了，但是，直到今天，再也无法忍了，还是一步到位，直接上Git作为存储。在开搞之前，决定写篇文字放松放松。</p>
<p>以上文字，与我现在要写的文章没有半毛钱关系。</p>
<a id="more"></a>
<h2 id="markdown-bi-ji" class="heading-control">Markdown 笔记<a class="heading-anchor" href="#markdown-bi-ji" aria-hidden="true"></a></h2>
<p>用 <a href="https://zh.wikipedia.org/zh-hans/Markdown" target="_blank" rel="noopener">Markdown</a> 做笔记是一件简单而惬意的事，当然这得在你熟悉它简单的纯文本格式之后。鉴于我喜欢简单的KISS原则，我心目中最理想的笔记就是保存在文件系统中的纯文本文件，没有数据库(真 database-less)，而文件目录就是笔记的分类，用 <a href="https://jekyllrb.com/docs/front-matter/" target="_blank" rel="noopener">front-matter</a> 记录笔记的 meta data（标题, 作者，创作时间，tags…）。</p>
<p>不提EverNote/Notion这类商业软件(资料首选保存到云端，这明智得无语)。开源并支持<a href="https://zh.wikipedia.org/zh-hans/Markdown" target="_blank" rel="noopener">Markdown</a>笔记软件就非常多了：</p>
<ul>
<li><a href="https://joplinapp.org/" target="_blank" rel="noopener">Joplin</a>: <img src="./joplin.png" alt="Joplin"></li>
<li><a href="https://github.com/0xGG/crossnote" target="_blank" rel="noopener">Cross Note</a>: <img src="./cross-note.png" alt="CrossNote"></li>
<li><a href="https://getmicropad.com/" target="_blank" rel="noopener">μPad</a>: <img src="./uPad.png" alt="μPad"></li>
<li><a href="https://www.qownnotes.org/" target="_blank" rel="noopener">QOwnNotes</a>: <img src="./qown-notes.png" alt="QOwnNotes"></li>
<li><a href="https://zim-wiki.org/" target="_blank" rel="noopener">Zim - A Desktop Wiki</a>: <img src="./zim.png" alt="Zim"></li>
<li><a href="https://www.giuspen.com/cherrytree/" target="_blank" rel="noopener">Cherry tree</a> (can export as Markdown): <img src="./cherry-tree.png" alt="Cherry tree"></li>
<li><a href="https://github.com/notable/notable" target="_blank" rel="noopener">Notable</a> - Source Closed since v1.5.1: <img src="./notable.png" alt="Notable"></li>
<li><a href="https://github.com/gsantner/markor" target="_blank" rel="noopener">Markor</a> - Android 平台超棒的 Markdown 记事本（含代办事宜）: <img src="./markor.png" alt="Markor"></li>
</ul>
<p>但是能方便进行网摘的就很少了，不过，可以使用网页转换为Markdown的浏览器插件: <a href="https://github.com/deathau/markdown-clipper" target="_blank" rel="noopener">markdown-clipper</a>，这个Clipper的问题是没保存图像数据。</p>
<p>目前唯一发现的是<a href="https://joplinapp.org/" target="_blank" rel="noopener">Joplin</a>提供了网摘的浏览器插件，并且可以保存图像数据，同时提供了手机端。<a href="https://joplinapp.org/" target="_blank" rel="noopener">Joplin</a>唯二的问题就是多终端同步冲突容易掉数据，还有就是保存的Markdown文件名称纯是看不懂的UUID，相关meta data是保存在数据库中的。如果再简单一点，用标题作为文件名称，将meta数据放到文章中不香么，对了，还有就是<a href="https://joplinapp.org/" target="_blank" rel="noopener">Joplin</a>的图片资源全混在一个目录下，根本分不清是哪一个文章的。</p>
<p>最后，我只用到了<a href="https://joplinapp.org/" target="_blank" rel="noopener">Joplin</a>的网摘的浏览器插件: <a href="https://joplinapp.org/clipper/" target="_blank" rel="noopener">Joplin Web Clipper</a>，然后撸了一个<a href="https://github.com/snowyu/h2doc.js" target="_blank" rel="noopener">Joplin Web Clipper Server</a>来协同<a href="https://joplinapp.org/clipper/" target="_blank" rel="noopener">Joplin Web Clipper</a>保存网摘的文章和图片到本地。这样终于可以愉快的解构了，再也不用上面花里狐骚的记事软件：</p>
<ul>
<li><a href="https://code.visualstudio.com/" target="_blank" rel="noopener">VSCode</a> 文本编辑器负责编辑文稿</li>
<li><a href="https://git-scm.com/" target="_blank" rel="noopener">Git</a> 负责版本管理和数据同步合并</li>
<li><a href="https://joplinapp.org/clipper/" target="_blank" rel="noopener">Joplin Web Clipper</a> 与 <a href="https://github.com/snowyu/h2doc.js" target="_blank" rel="noopener">Joplin Web Clipper Server</a> 协同进行网页摘要</li>
</ul>
<h3 id="wang-zhai-yu-markdown" class="heading-control">网摘 与 Markdown<a class="heading-anchor" href="#wang-zhai-yu-markdown" aria-hidden="true"></a></h3>
<p>网摘 原本只是保存链接地址，但这样的話当网站失效后，内容将无迹可寻，</p>
<p>结合 <a href="https://joplinapp.org/clipper/" target="_blank" rel="noopener">Joplin Web Clipper</a> 与 <a href="https://github.com/snowyu/h2doc.js" target="_blank" rel="noopener">Joplin Web Clipper Server</a> 协同进行网页摘要。</p>
<p><a href="https://joplinapp.org/clipper/" target="_blank" rel="noopener">Joplin Web Clipper</a> 可以对文章全文以及选择部分内容进行提取，然后发送HTML内容到后台进行处理。<br>
<img src="./joplin-web-clipper.png" alt="joplin-web-clipper"></p>
<p>使用<a href="https://joplinapp.org/clipper/" target="_blank" rel="noopener">Joplin Web Clipper</a>前必需运行<a href="https://joplinapp.org/" target="_blank" rel="noopener">Joplin</a>或者<a href="https://github.com/snowyu/h2doc.js" target="_blank" rel="noopener">Joplin Web Clipper Server</a>。</p>
<h4 id="joplin-web-clipper-server" class="heading-control"><a href="https://github.com/snowyu/h2doc.js" target="_blank" rel="noopener">Joplin Web Clipper Server</a><a class="heading-anchor" href="#joplin-web-clipper-server" aria-hidden="true"></a></h4>
<p><a href="https://joplinapp.org/clipper/" target="_blank" rel="noopener">Joplin Web Clipper</a>与后端通讯只用到<a href="https://joplinapp.org/api/" target="_blank" rel="noopener">Joplin REST API</a>其中的4个API:</p>
<ul>
<li>ping</li>
<li>Get Folders</li>
<li>Get Tags</li>
<li>Post Note</li>
</ul>
<p>看上去挺简单的吧，感觉是一天可以搞定到事情，却耗费了我整5天的时间。</p>
<p><a href="https://github.com/snowyu/h2doc.js" target="_blank" rel="noopener">Joplin Web Clipper Server</a>要求使用的文件夹中至少存在一个子目录。</p>
<h5 id="an-zhuang" class="heading-control">安装<a class="heading-anchor" href="#an-zhuang" aria-hidden="true"></a></h5>
<p>一个命令行程序，没啥安装的。如果已经安装了<a href="https://nodejs.org/" target="_blank" rel="noopener">Nodejs@12</a> 以上版本，那么直接用 <code>npm</code> or <code>yarn</code> 安装：</p>
<pre><code class="bash"><span class="hljs-comment"># yarn global add h2doc@alpha</span>
npm i -g h2doc@alpha
</code></pre>
<p>如果懒得安装 <a href="https://nodejs.org/" target="_blank" rel="noopener">Nodejs@12</a> ，那么这里提供了常见平台到压缩包供下载：<a href="https://github.com/snowyu/h2doc.js/releases" target="_blank" rel="noopener">H2DOC 发布包下载</a>.</p>
<h5 id="gong-neng" class="heading-control">功能<a class="heading-anchor" href="#gong-neng" aria-hidden="true"></a></h5>
<h6 id="server-ming-ling" class="heading-control">server 命令<a class="heading-anchor" href="#server-ming-ling" aria-hidden="true"></a></h6>
<p>功能如下：</p>
<ul>
<li>转换 HTML 内容为 Markdown 格式</li>
<li>下载 HTML 内容中的图像资产</li>
<li>一个文件夹就是一个 notebook.</li>
<li>保存转换后的 Markdown 文件及图像到指定到文件夹(<code>root</code>)</li>
<li>设置存储的文件名和图像资产目录名规则:
<ol>
<li>可将网摘的图像资产目录名设置成和网摘 markdown 文件名称相同（不包括扩展名），以<code>title</code>作为名称。
<ul>
<li>markdown file: <code>${folder}/${title}.md</code></li>
<li>markdown assets folder: <code>${folder}/${title}/</code></li>
<li>markdown assets base file name: <code>${assetBaseName}</code></li>
</ul>
</li>
<li>也可将网摘markdown文件和它的图像资产放在同一目录中, 用 <code>index|README.md</code> 作为网摘markdown文件名
<ul>
<li>markdown file: <code>${folder}/${title}/index.md</code></li>
<li>markdown assets folder: <code>${folder}/${title}/</code></li>
<li>markdown assets base file name: <code>${assetBaseName}</code></li>
</ul>
</li>
<li>you can customize by yourself</li>
</ol>
</li>
</ul>
<p>可供使用的变量和函数如下：</p>
<ul>
<li><code>folder</code>: 目录名称，相对于<code>root</code>目录 (来自<a href="https://joplinapp.org/clipper/" target="_blank" rel="noopener">Joplin Web Clipper</a>的notebook选项)</li>
<li><code>title</code>: 标题,(来自<a href="https://joplinapp.org/clipper/" target="_blank" rel="noopener">Joplin Web Clipper</a>的 title 选项)</li>
<li><code>assetBaseName</code>: 图像资产的文件名 (不含扩展名)</li>
<li><code>date</code>: ISO 格式的日期时间</li>
<li><code>index</code>: 当前资产图像的序号.</li>
<li><code>slug</code> : 根据标题语言，智能将标题转为可供url使用的字符串，参见<code>toSlug</code>函数。</li>
<li><code>shortid()</code>: 该函数返回一个唯一id.</li>
<li><code>toSlug(str)</code>: 该函数将字符串 <code>str</code> 转换为一个智能 slug，例如:
<ul>
<li><code>toSlug('i ♥ latin')</code> 结果是 ‘i-love-latin’</li>
<li><code>toSlug('我爱官话')</code> 结果是 ‘wo3-ai4-guan1-hua4’</li>
<li><code>toSlug('Я люблю русский')</code> 结果是 ‘ya-lyublyu-russkij’</li>
</ul>
</li>
</ul>
<p>上述功能只能在配置文件中设置（详细设置见后述）。</p>
<p>目前也就这个功能了。执行 <code>h2doc server [your-dir]</code>即可，如果不带 <code>[your-dir]</code> 就使用当前工作目录。</p>
<pre><code class="bash">h2doc server [your-dir]
</code></pre>
<p>要想停止就按<code>Ctrl+C</code>键。</p>
<p><strong>配置文件</strong></p>
<p>配置文件的存放位置为(按照优先顺序排列)：</p>
<ol>
<li>工作目录（启动设定的root目录）下</li>
<li>用户主目录下</li>
<li>应用所在目录下(<code>/$APP/config/</code>)</li>
</ol>
<p>配置文件可以使用<a href="https://zh.wikipedia.org/zh/YAML" target="_blank" rel="noopener">yaml</a>格式或者<a href="https://zh.wikipedia.org/zh-hans/JSON" target="_blank" rel="noopener">json</a>格式。</p>
<p>配置文件名为 <code>.md-config.(yaml|json)</code> 或 <code>md-config.(yaml|json)</code>.</p>
<p>配置文件的内容解释如下：</p>
<pre><code class="yml"><span class="hljs-attr">output:</span> <span class="hljs-comment"># 输出内容配置</span>
  <span class="hljs-attr">root:</span> <span class="hljs-string">~/Documents/my-clip</span> <span class="hljs-comment"># 保存markdown文件的位置</span>
  <span class="hljs-attr">exclude:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">node_modules</span>          <span class="hljs-comment"># 排除的目录，不作为 notebook 显示和存储。</span>
  <span class="hljs-attr">deep:</span> <span class="hljs-number">5</span> <span class="hljs-comment"># 允许的子目录嵌套的最大深度</span>
  <span class="hljs-attr">markdown:</span> <span class="hljs-string">${folder}/${title}.md</span> <span class="hljs-comment"># 网摘markdown文件名称和位置</span>
  <span class="hljs-attr">asset:</span> <span class="hljs-string">${folder}/${title}/</span>      <span class="hljs-comment"># 网摘的图片资产目录名称</span>
  <span class="hljs-attr">assetBaseName:</span> <span class="hljs-string">${assetBaseName}</span> <span class="hljs-comment"># 网摘的图片资产文件基本名称，不含扩展名</span>
<span class="hljs-attr">slug:</span> <span class="hljs-comment"># 智能 slug 参数对象或字符串，如果是字符串就是分隔符的设置</span>
  <span class="hljs-attr">separator:</span> <span class="hljs-string">'-'</span> <span class="hljs-comment"># 分隔符设定，将空白字符替换为分隔符默认为 "-"</span>
  <span class="hljs-attr">lang:</span> <span class="hljs-string">''</span> <span class="hljs-comment"># 设置语言代码：ISO 639-1 two-letter language code, 默认为空时为自动检测语言</span>
  <span class="hljs-attr">tone:</span> <span class="hljs-literal">false</span> <span class="hljs-comment"># 是否给拼音加上音调，默认为 true</span>
  <span class="hljs-attr">separateNumbers:</span> <span class="hljs-literal">false</span> <span class="hljs-comment"># 是否分隔数字，默认为 false</span>
  <span class="hljs-attr">maintainCase:</span> <span class="hljs-literal">false</span> <span class="hljs-comment"># 保留大小写，默认为 false</span>
<span class="hljs-attr">download:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 是否下载图片资产，默认为 true</span>
<span class="hljs-attr">format:</span> <span class="hljs-comment"># HTML 转 Markdown 的配置信息（注意：未来可能有所调整，不是所有参数都有效）</span>
  <span class="hljs-attr">headingStyle:</span> <span class="hljs-string">'atx'</span> <span class="hljs-comment"># 'setext' or 'atx'</span>
  <span class="hljs-attr">hr:</span> <span class="hljs-string">'---'</span>  <span class="hljs-comment"># 水平分隔线</span>
  <span class="hljs-attr">bulletListMarker:</span> <span class="hljs-string">'*'</span> <span class="hljs-comment"># 无序列表</span>
  <span class="hljs-attr">codeBlockStyle:</span> <span class="hljs-string">'fenced'</span> <span class="hljs-comment"># 代码块类型 'indented' or 'fenced'</span>
  <span class="hljs-attr">fence:</span> <span class="hljs-string">'```'</span> <span class="hljs-comment"># ``` or ~~~</span>
  <span class="hljs-attr">emDelimiter:</span> <span class="hljs-string">'_'</span> <span class="hljs-comment"># _ or *</span>
  <span class="hljs-attr">strongDelimiter:</span> <span class="hljs-string">'**'</span> <span class="hljs-comment"># ** or __</span>
  <span class="hljs-attr">linkStyle:</span> <span class="hljs-string">'inlined'</span> <span class="hljs-comment"># inlined or referenced</span>
  <span class="hljs-attr">linkReferenceStyle:</span> <span class="hljs-string">'full'</span> <span class="hljs-comment"># full, collapsed, or shortcut</span>
  <span class="hljs-attr">gfw:</span>
    <span class="hljs-attr">strikethrough:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># for converting &lt;strike&gt;, &lt;s&gt;, and &lt;del&gt; elements</span>
    <span class="hljs-attr">tables:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">taskListItems:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">frontMatter:</span> <span class="hljs-comment"># frontMatter输出的配置对象, 是否使用 front matter，以及包括那些meta信息</span>
  <span class="hljs-attr">title:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">url:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">author:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">date:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">publisher:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">lang:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">description:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">image:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">video:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">audio:</span> <span class="hljs-literal">true</span>
</code></pre>
<h6 id="autocomplete-ming-ling" class="heading-control">autocomplete 命令<a class="heading-anchor" href="#autocomplete-ming-ling" aria-hidden="true"></a></h6>
<p>shell下命令自动补全</p>
<p>执行 <code>h2doc autocomplete</code> 按照提示操作即可。</p>
<pre><code class="bash">❯ h2doc autocomplete
Building the autocomplete cache... <span class="hljs-keyword">done</span>

Setup Instructions <span class="hljs-keyword">for</span> H2DOC CLI Autocomplete ---

1) Add the autocomplete env var to your zsh profile and <span class="hljs-built_in">source</span> it
$ <span class="hljs-built_in">printf</span> <span class="hljs-string">"<span class="hljs-variable">$(h2doc autocomplete:script zsh)</span>"</span> &gt;&gt; ~/.zshrc; <span class="hljs-built_in">source</span> ~/.zshrc

NOTE: After sourcing, you can run `$ compaudit -D` to ensure no permissions conflicts are present

2) Test it out, e.g.:
$ h2doc &lt;TAB&gt;                 <span class="hljs-comment"># Command completion</span>
$ h2doc <span class="hljs-built_in">command</span> --&lt;TAB&gt;       <span class="hljs-comment"># Flag completion</span>

Enjoy!
</code></pre>
<hr>
<h3 id="nao-tu-yu-markdown" class="heading-control">脑图 与 Markdown<a class="heading-anchor" href="#nao-tu-yu-markdown" aria-hidden="true"></a></h3>
<p>脑图不过是另类的大纲，用Markdown写大纲，不是更简单快捷，然后,要脑图还不简单，try:</p>
<p><a href="https://markmap.js.org/repl/" target="_blank" rel="noopener"><img src="./markmap.png" alt="markmap"></a></p>
<p>至于用Markdown写幻灯片(SlideShow),<img src="./md-slideshow.png" alt="md-slideshow"></p>
<p>嵌入流程图，<img src="https://github.com/mjbvz/vscode-markdown-mermaid/raw/master/docs/example.png" alt="markdown-mermaid"></p>
<p>数学公式，<img src="https://cloud.githubusercontent.com/assets/1908863/14398210/0e408954-fda8-11e5-9eb4-562d7c0ca431.gif" alt="md-math"></p>
<p>更是不再话夏。</p>
<h3 id="markdown-yu-vscode" class="heading-control">Markdown 与 VSCode<a class="heading-anchor" href="#markdown-yu-vscode" aria-hidden="true"></a></h3>
<p>毋庸置疑，VSCode是非常好用的编辑器，通过各式插件，可以玩出花来。</p>
<p>安装插件方法：进入VSCode, 按下<code>ctrl+P</code>，然后输入 <code>ext install</code> + <code>插件名称</code> 后，按下回车即可，例如, 安装流程图支持的markdown 插件: “ext install bierner.markdown-mermaid”。</p>
<p><img src="./vscode-outline.png" alt="vscode-outline"><br>
VSCode 自带大纲显示和导航。再装上如下的插件(当心：多图杀🐈️猫)，就是一个专业的Markdown编辑器。</p>
<ul>
<li>holmescn.vscode-wordcount-cjk: 在状态栏上显示文章的字数。</li>
<li>bierner.markdown-emoji:
<ul>
<li><img src="./markdown-emoji.png" alt="markdown-emoji"></li>
</ul>
</li>
<li>darkriszty.markdown-table-prettify:
<ul>
<li><img src="https://github.com/darkriszty/MarkdownTablePrettify-VSCodeExt/raw/master/assets/animation.gif" alt="darkriszty.markdown-table-prettify"></li>
</ul>
</li>
<li>alefragnani.Bookmarks:
<ul>
<li><img src="https://github.com/alefragnani/vscode-bookmarks/raw/master/images/printscreen-select-lines.gif" alt="Bookmarks"></li>
</ul>
</li>
<li>bierner.markdown-mermaid:
<ul>
<li><img src="https://github.com/mjbvz/vscode-markdown-mermaid/raw/master/docs/example.png" alt="mermaid"></li>
</ul>
</li>
<li>bpruitt-goddard.mermaid-markdown-syntax-highlighting:
<ul>
<li><img src="https://raw.githubusercontent.com/bpruitt-goddard/vscode-mermaid-syntax-highlight/master/images/graph.png" alt="mermaid-markdown-syntax-highlighting"></li>
</ul>
</li>
<li>Compulim.vscode-chinese-translation:
<ul>
<li><img src="https://raw.githubusercontent.com/compulim/vscode-chinese-translation/master/demo.gif" alt="vscode-chinese-translation"></li>
</ul>
</li>
<li>docsmsft.docs-authoring-pack: 包含下面一系列的插件，装了这个，下面的就不用装了
<ul>
<li>docsmsft.docs-article-templates: markdown 模板(目前对大小写区分的文件系统存在问题)
<ul>
<li><img src="https://github.com/Microsoft/vscode-docs-authoring/raw/master/media/video/apply-template.gif" alt="docs-article-templates"></li>
</ul>
</li>
<li>docsmsft.docs-images:
<ul>
<li><img src="https://raw.githubusercontent.com/microsoft/vscode-docs-authoring/master/docs-images/images/right-click-image-compression.png" alt="docs-images"></li>
</ul>
</li>
<li>docsmsft.docs-linting</li>
<li>docsmsft.docs-markdown: 可以在状态栏上显示Markdown格式的工具栏，或者用(Alt+M 呼唤)
<ul>
<li><img src="https://github.com/Microsoft/vscode-docs-authoring/raw/master/media/video/extension-demo.gif" alt="docs-markdown"></li>
</ul>
</li>
<li>docsmsft.docs-metadata</li>
<li>docsmsft.docs-preview</li>
<li>docsmsft.docs-yaml</li>
<li>blackmist.LinkCheckMD: 失效链接检查。
<ul>
<li><img src="https://github.com/microsoft/linkcheckermd/raw/master/images/working.gif" alt="LinkCheckMD"></li>
</ul>
</li>
<li>DavidAnson.vscode-markdownlint: markdown 格式的语法检查</li>
<li>streetsidesoftware.code-spell-checker: 单词拼写检查(可惜没有中文词库，默认带的是英文)</li>
</ul>
</li>
<li>fabiospampinato.vscode-todo-plus: 让管理Todo(代办事宜)类别更容易。<strong>推荐</strong>
<ul>
<li><img src="https://github.com/fabiospampinato/vscode-todo-plus/raw/master/resources/demo/syntax.png" alt="vscode-todo-plus"></li>
</ul>
</li>
<li>jsynowiec.vscode-insertdatestring: 插入当前日期时间</li>
<li>kisstkondoros.vscode-gutter-preview: 可以在右边指示器直接显示图片预览，以及鼠标预览图片 <strong>必装</strong>
<ul>
<li><img src="https://raw.githubusercontent.com/kisstkondoros/gutter-preview/master/images/sample.png" alt="vscode-gutter-preview"></li>
</ul>
</li>
<li>kortina.vscode-markdown-notes: <strong>必装</strong>
<ul>
<li><img src="https://github.com/kortina/vscode-markdown-notes/raw/master/demo/create-note-on-missing-go-to-definition.gif" alt="vscode-markdown-notes"></li>
</ul>
</li>
<li>shd101wyy.markdown-preview-enhanced: <strong>必装</strong>
<ul>
<li>如果想用它做文档导出，请参看它的文档: <a href="https://shd101wyy.github.io/markdown-preview-enhanced/#/zh-cn/" target="_blank" rel="noopener">markdown-preview-enhanced文档</a></li>
<li><img src="https://user-images.githubusercontent.com/1908863/28495106-30b3b15e-6f09-11e7-8eb6-ca4ca001ab15.png" alt="markdown-preview-enhanced"></li>
</ul>
</li>
<li>tchayen.markdown-links: markdown-notes的最佳搭档
<ul>
<li><img src="https://github.com/tchayen/markdown-links/raw/master/demo.gif" alt="markdown-links"></li>
</ul>
</li>
<li>telesoho.vscode-markdown-paste-image: 直接复制图像(ctrl+alt+v)并保存</li>
<li>yzhang.markdown-all-in-one: 键盘快捷，TOC，列表编辑… <strong>必装</strong>
<ul>
<li><img src="https://github.com/yzhang-gh/vscode-markdown/raw/master/images/gifs/toggle-bold.gif" alt="markdown-all"></li>
</ul>
</li>
<li>oderwat.indent-rainbow: 对不同层次的缩进显示不同颜色.
<ul>
<li><img src="https://raw.githubusercontent.com/oderwat/vscode-indent-rainbow/master/assets/example.png" alt="indent-rainbow"></li>
</ul>
</li>
<li>redhat.vscode-yaml</li>
<li>eliostruyf.vscode-front-matter:
<ul>
<li><img src="https://github.com/estruyf/vscode-front-matter/raw/master/assets/create-tag-category.gif" alt="vscode-front-matter"></li>
</ul>
</li>
<li>donjayamanne.githistory: 查看某个文件的版本历史. <strong>GIT必装</strong>
<ul>
<li><img src="https://raw.githubusercontent.com/DonJayamanne/gitHistoryVSCode/master/images/gitLogv3.gif" alt="githistory"></li>
</ul>
</li>
<li>eamodio.gitlens: 在文件内显示（灰色小字）每一处变更发生的时间和提交者 <strong>GIT必装</strong>
<ul>
<li><img src="https://raw.githubusercontent.com/eamodio/vscode-gitlens/master/images/docs/gitlens-preview.gif" alt="gitlens"></li>
</ul>
</li>
<li>softwaredotcom.swdc-vscode: 这货可以统计你在vscode上花费的时间.
<ul>
<li><img src="https://swdc-vscode.s3-us-west-1.amazonaws.com/code-time-features.png" alt="Code Time"></li>
</ul>
</li>
<li>Shan.code-settings-sync: 可以将您的配置和安装的插件信息同步到<code>gist</code>. 最新的Code-insiders测试版本已内置支持。</li>
</ul>
]]></content>
      <categories>
        <category>Thinking</category>
        <category>Knowledge</category>
      </categories>
      <tags>
        <tag>thinking</tag>
        <tag>knowledge</tag>
        <tag>web clip</tag>
        <tag>note</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenPGP 密钥(GnuPG软件)安全随笔</title>
    <url>/article/gpg/</url>
    <content><![CDATA[<p>GnuPG软件（简称GPG） – OpenPGP</p>
<h1 id="li-shi-jie-shao-history" class="heading-control">历史介绍 History<a class="heading-anchor" href="#li-shi-jie-shao-history" aria-hidden="true"></a></h1>
<h2 id="pgp-pretty-good-privacy" class="heading-control">PGP (Pretty Good Privacy)<a class="heading-anchor" href="#pgp-pretty-good-privacy" aria-hidden="true"></a></h2>
<p>最早是由PGP Inc.公司拥有原始的PGP加密软件的版权，后来它被赛门铁克公司（Symantec Corp.）收购。后续由赛门铁克公司继续开发维护PGP品牌。</p>
<h2 id="openpgp" class="heading-control">OpenPGP<a class="heading-anchor" href="#openpgp" aria-hidden="true"></a></h2>
<p>Zimmerman(最早的PGP开发人员)于1997年向IETF（互联网工程任务组）提交了<a href="https://tools.ietf.org/html/rfc4880" target="_blank" rel="noopener">开源PGP（OpenPGP）标准提案</a>。如今，OpenPGP成为了PGP的标准规范，是供公众使用的开源代码，并且该术语可用于描述支持OpenPGP系统的任何程序。</p>
<h2 id="gpg-gnu-privacy-guard" class="heading-control">GPG (GNU Privacy Guard)<a class="heading-anchor" href="#gpg-gnu-privacy-guard" aria-hidden="true"></a></h2>
<p>GnuPGP由Werner Koch开发的开源加密工具软件，并于1999年发布，以替代现有的Symantec加密工具软件套件。 它可以免费下载，并且基于IETF建立的OpenPGP标准，因此可以与Symantec的PGP工具和支持OpenPGP标准的软件互操作。GPG可以打开和解密任何PGP和OpenPGP标准的文件。</p>
<h2 id="keys" class="heading-control">Keys<a class="heading-anchor" href="#keys" aria-hidden="true"></a></h2>
<p>在公开密钥算法中，一个Key(密钥)包括两个部分：公钥和私钥。公钥类似于印鉴，而私钥类似于印章。</p>
<h2 id="subkeys" class="heading-control"><a href="https://wiki.debian.org/Subkeys" target="_blank" rel="noopener">Subkeys</a><a class="heading-anchor" href="#subkeys" aria-hidden="true"></a></h2>
<p>在OpenPGP标准中你的钥匙包括一个主钥(master key)和若干子钥(subkeys)。在OpenPGP标准中主钥，子钥(Subkey)是必需理解，非常关键的概念，可以极大的提升安全性。</p>
<ul>
<li>主钥的主要作用是用于签发和吊销其它密钥、签名或用户Id，从安全角度考虑，主钥的私钥应该完全保持离线。</li>
<li>子钥：根据设置用途可以用于加密或签名，一旦子钥泄密可以用主钥吊销该子钥。
<ul>
<li>GPG会随机选择用于加密或签名(GPG默认策略会挑选钥匙size最大的，以及创建时间最近的)。</li>
</ul>
</li>
</ul>
<p>而就内部结构上看，子钥和主钥没啥不同的，只是PacketId上有差别，另外子钥要求有绑定主钥的签名包（见后面描述Binding Signatures）。</p>
<ul>
<li>Public-Subkey Packet Tag 是 14</li>
<li>Secret-Subkey Packet Tag 是 7</li>
</ul>
<h3 id="subkey-usage" class="heading-control">Subkey Usage<a class="heading-anchor" href="#subkey-usage" aria-hidden="true"></a></h3>
<p>OpenPGP subkeys 用于不同的设想：</p>
<ul>
<li>可以保持主键始终处于离线安全状态，您的主键不需要存放在线上(online)，可以只存放在本地的安全设备上。一旦有子键泄露，可以立刻使用主键轻松的吊销该子键，而没有撤销主键的麻烦（需要再次分享新的键,获取新的签名…）。Being able to store the primary key offline or a more secure device. If a machine with a subkey is harmed, you can easily revoke the subkey without all the hassles of revoking your primary key (sharing a new key, getting new signatures, …).</li>
<li>可以在不同的机器上使用不同的子键。例如在构建服务器上使用单独的子键。记住，吊销单独的子键非常容易。Having different subkeys on different machines, for example a signing subkey on a build server. Again, revoking single keys is easy.</li>
<li>使用较大尺寸的密钥作为主键长时间使用，而使用短而快速的子键，可以每天一换。Using a larger primary key for long lifetime, and shorter, but faster subkeys for day-to-day usage.</li>
<li>某些算法不能同时支持加密和签名，例如: DSA 主密钥只能签名，因此它需要另一个密钥来加密，通常DSA与ElGamal算法成对使用。Some algorithms do not support both encrypting and signing. For example, a DSA primary key requires another key for encryption, typically paired with ElGamal.</li>
</ul>
<h3 id="binding-signatures" class="heading-control">Binding Signatures<a class="heading-anchor" href="#binding-signatures" aria-hidden="true"></a></h3>
<p>There are special signature subtypes to bind subkeys to primary keys (and vice verse), listed in <a href="http://tools.ietf.org/html/rfc4880#section-5.2.1" target="_blank" rel="noopener">RFC 4880, OpenPGP, 5.2.1 Signature Types</a>:</p>
<p>0x18: Subkey Binding Signature</p>
<p>This signature is a statement by the top-level signing key that indicates that it owns the subkey. This signature is calculated directly on the primary key and subkey, and not on any User ID or other packets. A signature that binds a signing subkey MUST have an Embedded Signature subpacket in this binding signature that contains a 0x19 signature made by the signing subkey on the primary key and subkey.</p>
<p>0x19: Primary Key Binding Signature</p>
<p>This signature is a statement by a signing subkey, indicating that it is owned by the primary key and subkey. This signature is calculated the same way as a 0x18 signature: directly on the primary key and subkey, and not on any User ID or other packets.</p>
<p>OpenPGP 更进一步的支持 <code>subkeys</code>, 它像普通的钥匙,但 subkeys 是和一个 master 钥匙绑定的，子钥 可以用于签名或加密。子钥可以独立于主钥匙进行撤销和存放。</p>
<p>换句话说，子钥像单独的钥匙对，但是自动与您的主钥匙关联。</p>
<p>GnuPG 实际上用一个签名(signing-only)钥匙作为主钥匙。然后自动创建了一个用于加密的子钥。 Without a subkey for encryption, you can’t have encrypted e-mails with GnuPG at all. Debian requires you to have the encryption subkey so that certain kinds of things can be e-mailed to you safely, such as the initial password for your <a href="http://debian.org" target="_blank" rel="noopener">debian.org</a> shell account.</p>
<p>主钥仅当在以下情况下才被使用：</p>
<ul>
<li>when you sign someone else’s key or revoke an existing signature,</li>
<li>when you add a new UID or mark an existing UID as primary,</li>
<li>when you create a new subkey,</li>
<li>when you revoke an existing UID or subkey,</li>
<li>when you change the preferences (e.g., with setpref) on a UID,</li>
<li>when you change the expiration date on your master key or any of its subkey, or</li>
<li>when you revoke or generate a revocation certificate for the complete key.</li>
</ul>
<p>看 openpgpjs 的代码，好像可以独立使用subkey,但是必须存在 master key的公钥。</p>
<pre><code class="bash">gpg --<span class="hljs-built_in">help</span>
gpg --gen-key
gpg --expert --gen-key <span class="hljs-comment"># 可以打开ECC等其它加密算法的支持, or --full-gen-key</span>

　　gpg (GnuPG) 1.4.12; Copyright (C) 2012 Free Software Foundation, Inc.
　　This is free software: you are free to change and redistribute it.
　　There is NO WARRANTY, to the extent permitted by law.
　　请选择您要使用的密钥种类：
　　　(1) RSA and RSA (default)
　　　(2) DSA and Elgamal
　　　(3) DSA (仅用于签名)　
　　　(4) RSA (仅用于签名)
　　您的选择？

<span class="hljs-comment"># 生成一张"撤销证书"，以备以后密钥作废时，可以请求外部的公钥服务器撤销你的公钥。</span>
gpg --gen-revoke [用户ID]

gpg --list-keys --list-options show-keyring

/home/XXX/.gnupg/pubring.kbx
---------------------------------
pub   rsa4096 2016-10-05 [SC]
      72ECF46A56B4AD39C907BBB71646B01B86E50310
uid           [ unknown] Yarn Packaging &lt;yarn@dan.cx&gt;
sub   rsa4096 2016-10-05 [E]
sub   rsa4096 2016-10-05 [S] [expires: 2017-10-05]
sub   rsa4096 2016-10-30 [S]

pub   rsa4096 2017-04-17 [SC]
      EAD16A2C6AE2C4C70344D76855C2BF1FD36EBB60
uid           [ultimate] Riceball LEE &lt;snowyu.lee@gmail.com&gt;
sub   rsa4096 2017-04-17 [E]

<span class="hljs-comment"># 输出密钥,armor参数可以将其转换为ASCII码显示。</span>
gpg --armor --output public-key.txt --<span class="hljs-built_in">export</span> [用户ID]
gpg --armor --output private-key.txt --<span class="hljs-built_in">export</span>-secret-keys
<span class="hljs-comment"># 上传公钥 公钥服务器是网络上专门储存用户公钥的服务器</span>
gpg --send-keys [用户ID]

<span class="hljs-comment"># 除了生成自己的密钥，还需要将他人的公钥或者你的其他密钥输入系统。这时可以使用import参数。</span>
gpg --import [密钥文件]

<span class="hljs-comment"># 为了获得他人的公钥，可以让对方直接发给你，或者到公钥服务器上寻找。</span>
gpg --search-keys [用户ID]

<span class="hljs-comment"># encrypt参数用于加密。</span>
gpg --recipient [用户ID] --output demo.en.txt --encrypt demo.txt

<span class="hljs-comment"># 解密 GPG允许省略decrypt参数。</span>
gpg --decrypt demo.en.txt --output demo.de.txt

<span class="hljs-comment"># 对文件签名 当前目录下生成demo.txt.gpg文件 -a 将为ascii armored 输出 demo.txt.asc</span>
<span class="hljs-comment"># -o demo.txt.sig 自定义输出文件名</span>
gpg --detach-sig demo.txt
<span class="hljs-comment"># 生成ASCII码的签名文件</span>
gpg --clearsign demo.txt

<span class="hljs-comment">#  验证签名</span>
gpg --verify demo.txt.asc demo.txt


<span class="hljs-comment"># 增加 subkey 启用 ECC 支持</span>

gpg --expert --edit-key YOURMASTERKEYID
gpg&gt; addkey
  Please select what kind of key you want:
    (3) DSA (sign only)
    (4) RSA (sign only)
    (5) Elgamal (encrypt only)
    (6) RSA (encrypt only)
    (7) DSA (<span class="hljs-built_in">set</span> your own capabilities)
    (8) RSA (<span class="hljs-built_in">set</span> your own capabilities)
    (10) ECC (sign only)
    (11) ECC (<span class="hljs-built_in">set</span> your own capabilities)
    (12) ECC (encrypt only)
    (13) Existing key
  Your selection? 10
  Please select <span class="hljs-built_in">which</span> elliptic curve you want:
    (1) Curve 25519
    (3) NIST P-256
    (4) NIST P-384
    (5) NIST P-521
    (6) Brainpool P-256
    (7) Brainpool P-384
    (8) Brainpool P-512
    (9) secp256k1
  Your selection? 9
gpg&gt; save
</code></pre>
<h3 id="dao-chu-mi-yue" class="heading-control">导出密钥<a class="heading-anchor" href="#dao-chu-mi-yue" aria-hidden="true"></a></h3>
<p>应用签名等需要。</p>
<p><code>openpgp2ssh</code> 测试成功，其余失败,搞定。</p>
<pre><code class="bash">sudo apt install monkeysphere
<span class="hljs-comment"># 弄之前先解密需要导出的密钥</span>
<span class="hljs-comment"># 10F15E84852CB868 是subkey的id,可以用 gpg --list-keys 看到</span>
gpg --<span class="hljs-built_in">export</span>-secret-subkeys youmasterid@gmail.com | openpgp2ssh 10F15E84852CB868 &gt; id_rsa
openssl rsa -<span class="hljs-keyword">in</span> id_rsa -outform pem &gt; key.pem
<span class="hljs-comment"># 将子密钥转为 pkcs8 格式。</span>
openssl pkcs8 -topk8 -outform DER -<span class="hljs-keyword">in</span> key.pem -inform PEM -out key.pk8 -nocrypt
<span class="hljs-comment"># 产生请求签名的证书文件,发给签名方签名形成签名证书。</span>
openssl req -new -key key.pem -out request.pem
<span class="hljs-comment"># 签名方进行签名，产生签名证书。</span>
<span class="hljs-comment"># 这样一来变成了自签名的，而不是主钥签名的。如果要主钥签名，首先得导出主钥。</span>
openssl x509 -req -days 9999 -<span class="hljs-keyword">in</span> request.pem -signkey key.pem -out certificate.pem
<span class="hljs-comment"># 使用 Android 提供的 SignApk.jar 进行 apk签名</span>
java -jar SignApk.jar certificate.pem key.pk8 Application.apk Application_signed.apk
<span class="hljs-comment"># 可以用这个脚本转到keytool去用java的 jarsigner, -p keystore-password</span>
keytool-importkeypair -k ~/.android/debug.keystore -p android -pk8 key.pk8 -cert certificate.pem -<span class="hljs-built_in">alias</span> platform
<span class="hljs-comment"># 使用 java自带的签名工具进行签名</span>
jarsigner -verbose -keystore ~/.android/debug.keystore Application_unsign.apk platform
</code></pre>
<p><a href="https://github.com/getfatday/keytool-importkeypair" target="_blank" rel="noopener">https://github.com/getfatday/keytool-importkeypair</a></p>
<pre><code class="bash"><span class="hljs-comment"># keytool-importkeypair</span>
<span class="hljs-comment"># 将pkcs8 转回 pem 格式</span>
openssl pkcs8 -inform DER -nocrypt -<span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">${pk8}</span>"</span> -out <span class="hljs-string">"<span class="hljs-variable">${key}</span>"</span>
<span class="hljs-comment"># 将密钥绑定签名证书，使用 keystore的密码加密</span>
openssl pkcs12 -<span class="hljs-built_in">export</span> -<span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">${cert}</span>"</span> -inkey <span class="hljs-string">"<span class="hljs-variable">${key}</span>"</span> -out <span class="hljs-string">"<span class="hljs-variable">${p12}</span>"</span> -password pass:<span class="hljs-string">"<span class="hljs-variable">${passphrase}</span>"</span> -name <span class="hljs-string">"<span class="hljs-variable">${alias}</span>"</span>
<span class="hljs-comment"># 导入keystore</span>
keytool -importkeystore -deststorepass <span class="hljs-string">"<span class="hljs-variable">${passphrase}</span>"</span> -destkeystore <span class="hljs-string">"<span class="hljs-variable">${keystore}</span>"</span> -srckeystore <span class="hljs-string">"<span class="hljs-variable">${p12}</span>"</span> -srcstoretype PKCS12 -srcstorepass <span class="hljs-string">"<span class="hljs-variable">${passphrase}</span>"</span>
</code></pre>
<hr>
<p>以下为测试失败的一些方法：</p>
<p>It’s separate key storage: <code>gpg</code> has <code>~/.gnupg/pubring.gpg</code>, <code>gpgsm</code> has <code>~/.gnupg/pubring.kbx</code><br>
So keys added with gpgsm aren’t usable with gpg; gpg doesn’t read ~/.gnupg/pubring.kbx.</p>
<pre><code class="bash">gpg -o secret-key.p12 --<span class="hljs-built_in">export</span> [key id] --<span class="hljs-built_in">export</span>-format pkcs12 --cert
</code></pre>
<p><code>pkcs12</code> Only binary blocks are output; the default file extension is .p12; a signed key must be paired; and input must match exactly one key. In this case, --cert is required.</p>
<p><code>--cert</code> This option is the X.509 issuer long name or the 32-bit or 64-bit key ID, if the signing key is available.</p>
<p>And there is an option concerning the charset of the exported key, which often is a problem with (especially older) windows programs:</p>
<p><code>--p12-charset</code> name gpgsm uses the UTF-8 encoding when encoding passphrases for PKCS#12 files. This option may be used to force the passphrase to be encoded in the specified encoding name. This is useful if the application used to import the key uses a different encoding and thus will not be able to import a file generated by gpgsm. Commonly used values for name are Latin1 and CP850. Note that gpgsm itself automagically imports any file with a passphrase encoded to the most commonly used encodings.</p>
<p>It contains keys and certificates. Then you can split them with openSSL and transform it in .pem at the same time</p>
<pre><code class="bash">openssl pkcs12 -<span class="hljs-keyword">in</span> secret-key.p12 -out gpg-certs.pem -clcerts -nokeys -passin <span class="hljs-string">'pass:P@s5w0rD'</span>
openssl pkcs12 -<span class="hljs-keyword">in</span> secret-key.p12 -out gpg-key.pem -nocerts -nodes

openssl pkcs12 -<span class="hljs-keyword">in</span> secret-key.p12 -nocerts -out gpg-key.pem
openssl pkcs12 -<span class="hljs-keyword">in</span> secret-key.p12 -nokeys -out gpg-certs.pem
</code></pre>
<p>还发现一个工具可以： openpgp2ssh <a href="http://manpages.ubuntu.com/manpages/natty/man1/openpgp2ssh.1.html" target="_blank" rel="noopener">http://manpages.ubuntu.com/manpages/natty/man1/openpgp2ssh.1.html</a></p>
<p>但是只支持rsa以及没有密码的key.</p>
<p><code>gpg --edit-key $KEYID</code> 然后用 <code>passwd</code> 子命令移除密码。然后</p>
<p><code>gpg --export-secret-key $KEYID | openpgp2ssh $KEYID &gt; id_rsa</code></p>
<p>然后可以建立 Certificate Signing Request (CSR):</p>
<p>openssl req -new -key id_rsa -out id_rsa.csr</p>
<p>id_rsa.csr’s content should look like:</p>
<pre><code>-----BEGIN CERTIFICATE REQUEST-----
MIIC9jCCAd4CAQAwgZkxCzAJBgNVBAYTAkRFMRMwEQYDVQQIEwpTb21lLVN0YXRl[...]
-----END CERTIFICATE REQUEST-----
</code></pre>
<p>然后发给CA，CA签名后发给你证书文件:</p>
<pre><code>-----BEGIN CERTIFICATE-----
MIIFRjCCAy6gAwIBAgIDCuP8MA0GCSqGSIb3DQEBBQUAMHkxEDAOBgNVBAoTB1Jv[...]
-----END CERTIFICATE-----
</code></pre>
<p>你把<code>id_rsa</code>和证书合并在一起：</p>
<pre><code>-----BEGIN CERTIFICATE-----
MIIFRjCCAy6gAwIBAgIDCuP8MA0GCSqGSIb3DQEBBQUAMHkxEDAOBgNVBAoTB1Jv[...]
-----END CERTIFICATE-----
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEA0s2wNIWuUzuBYU9U0cK/mGa4LMtsWTEZEFTQhHj2eg4ZHmdt[...]
-----END RSA PRIVATE KEY-----
</code></pre>
<p>最后创建a PKCS#12 container:</p>
<p>openssl pkcs12 -export -in email@address.pem -out email@address.pem.p12</p>
<p><a href="http://wiki.cacert.org/ConvertingPgpKeyToCertificate" target="_blank" rel="noopener">Creating a new X.509 certificate from your PGP key pair</a></p>
<pre><code class="bash"><span class="hljs-comment"># 失败，没有 p12-export参数了！！！</span>
/usr/lib/gnupg/gpg-protect-tool --p12-export -P &lt;passphrase&gt; ~/.gnupg/private-keys-v1.d/[keygrip] &gt;foo.p12
</code></pre>
<p><code>[keygrip]</code> is the hash of the key.  you can find it by:</p>
<pre><code class="bash">gpg --with-keygrip --list-key
</code></pre>
<p>prepend the above line by space to avoid login the passphrase in history.</p>
<p>then (as per this guide, in fact)</p>
<pre><code>openssl pkcs12 -in foo.p12 -nocerts -out foo.pem
chmod 0600 foo.pem
mv foo.pem ~/.ssh/id_rsa
ssh-keygen -y -f ~/.ssh/id_rsa &gt; ~/.ssh/id_rsa.pub
</code></pre>
<h2 id="pgp-xin-ren-fang-shi" class="heading-control">PGP 信任方式<a class="heading-anchor" href="#pgp-xin-ren-fang-shi" aria-hidden="true"></a></h2>
<p>PGP（Pretty Good Privacy）最初是用传统公钥密码学加密email信息的，之后又被用于加密本地文件。</p>
<p>注意：PGP和WoT(Web of Trust)不是同一样事务，PGP采用了WoT的方式。</p>
<p>PGP没有可信任的中心权威（第三方机构），但是相对应的是，系统中的每个人都可以签发自己的公钥并通过证书签名建立起自己的信任网。</p>
<p>一、公钥证书</p>
<p>公钥证书是PGP的重要核心。每个证书包含公钥所有者的用户ID（通常使用email地址），公钥，密钥ID，日期以及创建时间。证书需要被多个“介绍人”签名，“介绍人”是指用户完全信任的实体。PGP信任网的每个实体的主要标识是其公钥ID，而非与证书相关的用户ID号(这是因为用户ID号不稳定而公钥ID全局唯一且稳定不变)。但是公钥ID难以记忆，这也是唯一的问题（目前尚未完全解决）。</p>
<p>二、信任的定义</p>
<p>在PGP中有两个方面来定义信任：</p>
<ol>
<li>公钥证书的有效性；</li>
<li>介绍人的可信度。</li>
</ol>
<p>在此做个说明：一是所谓公钥之间的“介绍”其实就是“介绍人”对“被介绍人”的公钥证书上进行签名，其它人通过证书上的签名判断“被介绍人”的可信度，后面会讲到如何判断；二是公钥的有效性是指公钥通过证书上完全可信的签名将其与对应的公钥ID号紧密相连，如果失联则有效性消失。</p>
<p>首先介绍公钥证书有效性的层级：</p>
<ul>
<li>未定义有效（undefined）:公钥的有效性无法判断；</li>
<li>边际有效（marginal）：公钥可具有一定的有效性，但是无法完全确认；</li>
<li>完全有效（complete）：公钥完全有效。</li>
</ul>
<p>“介绍人”可信度主要定义的是用户认为某公钥所有者作为其它公钥的“介绍人”的可信任度。</p>
<p>下面再介绍“介绍人”可信度的层级：</p>
<ul>
<li>完全可信（full）：该公钥介绍其它公钥是完全值得信任的；</li>
<li>边际可信(marginal)：该公钥可以介绍其它公钥，但其可信度值得怀疑；</li>
<li>不可信(untrustworthy)：该公钥完全不值得信任，它为其它公钥所做的签名可忽略不计；</li>
<li>可信未知（don’t know）：该公钥介绍其它公钥的可信度仍属未知状态。</li>
</ul>
<p>然而以上的有效性和可信度定义得十分模糊，PGP就想办法使其更具实际指导意义。PGP赋予用户自行调节标准的能力，它定义了两个参数：COMPLETES_NEEDED（完全需要数量）和MARGINALS_NEEDED（边际需要数量）。前者定义为使公钥证书完全有效时所需的完全可信签名的数量，后者定义为使公钥部分有效时所需的边际签名的数量。这两个参数都是需要用户根据自身情况定的。</p>
<p>三、信任评估算法</p>
<p>当PGP评估一个公钥证书的可信度时，它需要运用如下算法，即信任评估算法（用伪代码表示）：</p>
<pre><code>1. For each signature do

// scan signatures

2. if signature is completely valid then

3. if key trust ∈{undefined,unknown,untrusted} then

4. ignore signature

5. if key trust is marginal then

6. accumulate marginals_counter

7. if key trust is complete then

8. accumulate completes_counter

9. else

10. ignore signature

// decision

11. if (marginals_counter&gt;0) or (completes_counter&gt;0) then

12. if (marginals_counter&gt;=MARGINALS_NEEDED) or

13.(completes_counter&gt;=COMPLETES_NEEDED) then

14. mark key validity as 'complete'

15. else

16. mark key validity as 'marginal'
</code></pre>
<p>其中：</p>
<ul>
<li>line 6: marginals_counter  计算该公钥证书的边际信任签名个数；</li>
<li>line 8: completes_counter 计算该公钥证书的完全信任签名个数；</li>
<li>line 10:非完全有效的签名将被忽略，即便它是由可信任的“介绍人”提出；</li>
<li>lines 11,12,13: COMPLETES_NEEDED（完全需要数量）和MARGINALS_NEEDED（边际需要数量）均大于1。</li>
</ul>
<p>四、介绍人</p>
<p>PGP是通过证书的签名人来证明公钥的有效性的，这些签名人又被称为“介绍人”，即，一个用户通过用自己的私钥签名一个新的公钥证书来向其它用户证明该证书中包含的公钥的有效性。如果一个用户有幸被划分为“完全可信介绍人”，则其被人完全信任，它在介绍其它公钥证书时影响力更大，介绍的人不需更多；若该用户被划分为“边际可信介绍人”，则其影响力就不足，需要更多这样的人来签名证书作证明。其中每个介绍人的可信度都是根据用户的考虑和隐私的需求结合起来定义的。</p>
<p>在PGP中，信任是不可以传递的。即在下图的介绍人（证书）链中，Carol不能假设Eric 的证书是有效的，除非通过介绍人的介绍。</p>
<pre><code>Carol --&gt; Alice --&gt; Bob --&gt; Eric
</code></pre>
<pre><code class="mermaid">graph LR
  Carol --&gt; Alice
  Alice --&gt; Bob
  Bob --&gt; Eric
</code></pre>
<p>在PGP中的CERT_DEPTH参数尽管定义了证书链长度的最大值，但是也不能用其确定出证书的有效性。</p>
<p>也就是说，这些链的作用仅在于寻求用户之间的直接信任关系，帮助减少关系网的冗余度，使关系网更加清晰。</p>
<p>信赖网路机制比S/MIME方案的集中管理的公钥基础设施有优势，但是没有被网络普通大众普遍采用，一般只在Unix-like的爱好者、开源软体界、和对隐私特别注意而且有电脑知识的人群之间使用。如何使一般用户容易并且乐意使用、接收证书然后手动的验证它们的有效性，这些潜在的推广阻碍目前还没有满意的解决方案。</p>
<h2 id="key-server" class="heading-control">Key Server<a class="heading-anchor" href="#key-server" aria-hidden="true"></a></h2>
<p><a href="https://roll.urown.net/server/pgp-keyserver.html" target="_blank" rel="noopener">https://roll.urown.net/server/pgp-keyserver.html</a></p>
<h2 id="references" class="heading-control">References<a class="heading-anchor" href="#references" aria-hidden="true"></a></h2>
]]></content>
      <categories>
        <category>Security</category>
        <category>PGP</category>
      </categories>
      <tags>
        <tag>openpgp</tag>
        <tag>pgp</tag>
        <tag>gpg</tag>
        <tag>public key</tag>
      </tags>
  </entry>
  <entry>
    <title>基于Markdown的响应(交互)式文档</title>
    <url>/article/interative-markdown/</url>
    <content><![CDATA[<h2 id="shi-mo-shi-xiang-ying-jiao-hu-shi-wen-dang" class="heading-control">什么是响应(交互)式文档<a class="heading-anchor" href="#shi-mo-shi-xiang-ying-jiao-hu-shi-wen-dang" aria-hidden="true"></a></h2>
<p>什么是响应(交互)式文档，简单的说就是文档内容能够实时响应读者的交互，根据交互实时变化的文档。在技术，教育领域中，为了将知识表述更清楚，常常需要✍文档能“动”起来，最极端的例子应该是🎮️“游戏”。虽然目前还不能让🎮️游戏文档直接“动”起来。不过未来就不一定了。</p>
<p>我们接下来通过一个简单的响应(交互)式文档例子，来直观感受一下，请看下面。</p>
<a id="more"></a>
<h3 id="hui-zhi-ju-xing-rect-li-zi" class="heading-control">绘制矩形(Rect)例子<a class="heading-anchor" href="#hui-zhi-ju-xing-rect-li-zi" aria-hidden="true"></a></h3>
<p><strong>参数</strong>：<span class="AMElement" data-embed="false" data-config="rx:10..">x轴坐标:10</span>，<span class="AMElement" data-embed="false" data-config="ry:10..">y轴坐标:18</span>，<span class="AMElement" data-embed="false" data-config="rw:1..">宽度:100</span>，<span class="AMElement" data-embed="false" data-config="rh:1..">高度:50</span></p>
<p>下面演示在提供好的画布上用上述参数绘制一个矩形，点击下方的播放按钮进行演示：</p>
<pre><code class="output"># 演示绘制矩形的过程
paper = @canvas

|
~~~
tooltip: 设置画布大小为200X100 ::: 初始化工作
type:paper.setSize(200,100)\n
tooltip: 清空画布
type:paper.clear()\n
tooltip: 初始化来自文档的x,y座标，宽度和高度参数变量
type:@rx ||=10\n
type:@ry ||=18\n
type:@rw ||=100\n
type:@rh ||=50\n
tooltip: 开始绘制矩形 ::: 绘制矩形
type:rect = paper.rect(@rx, @ry, @rw, @rh)\n
tooltip: 为矩形填充红色
type:rect.attr('fill', 'red')
moveTo: 8:13
tooltip: 现在你可以自己试一试了
</code></pre>
<hr>
<p>看完演示，你可以通过将鼠标移到上方参数列表中的x,y或宽,高参数上进行拖动来直观的改变参数值，也可以直接在上面的代码中编辑修改，自己动手试一试其他的绘图函数,比如: 圆，椭圆, 文字，图片等等。</p>
<ul>
<li><code>circle(x, y, r)</code></li>
<li><code>ellipse(x, y, xr, yr)</code></li>
<li><code>image(src, x, y, width, height)</code></li>
<li><code>text(50, 50, &quot;Hi world\n你好世界&quot;)</code></li>
</ul>
<p>响应(交互)式文档能够更加直观的看到结果的变化，使得知识更容易理解。</p>
<h2 id="wei-shi-mo-xiang-ying-jiao-hu-shi-wen-dang-yao-ji-yu-markdown-ge-shi" class="heading-control">为什么响应(交互)式文档要基于Markdown格式？<a class="heading-anchor" href="#wei-shi-mo-xiang-ying-jiao-hu-shi-wen-dang-yao-ji-yu-markdown-ge-shi" aria-hidden="true"></a></h2>
<p>Markdown 是一种纯文本格式的轻量级标记语言，强调可读性高于一切。</p>
<ul>
<li>纯文本，所以兼容性极强，速度快，易保存，数据不易丢失，可以用所有文本编辑器编辑。</li>
<li>可以专注写作而不是排版。用Word写作的时候，经常浪费大量时间去思考排版，</li>
<li>Markdown 语法简单，只有少量的标记符号，可以很快学会。</li>
<li>Markdown 的标记语法有极好的可读性。</li>
</ul>
<p>使用Markdown格式可以随时随地的编写互动文档，让更多的人都能够参与进来。目前的开源编写互动文档的门槛还是比较高，如果不懂相关技术，是很难入门。</p>
<ul>
<li><a href="https://jupyter.org/" target="_blank" rel="noopener">Jupyter Notebook</a>文档是基于 JSON 格式，主要面向开发者的。
<ul>
<li>目的是可读性更高的，可直接执行的代码文档。</li>
</ul>
</li>
<li><a href="https://rmarkdown.rstudio.com/" target="_blank" rel="noopener">R Markdown</a> 文档是基于 markdown 格式，但也是面向R语言开发者的。
<ul>
<li>目的是让Markdown的代码块可以被直接执行，输出结果混合渲染成Html。</li>
</ul>
</li>
</ul>
<p>而交互式Markdown格式的目的是要让普通人也能快速上手使用。</p>
<p>比如，对函数图像进行教学演示的交互式markdown，只需要</p>
<ol>
<li>定义函数: <code>@func = (x) =&gt; Math.cos(x + @offset)</code></li>
<li>设定需要演示改变的参数: <code>[Offset: 0.00]{offset: -2pi..2pi by 0.0625pi}</code></li>
<li>在指定的位置显示函数图像：<code>![Chart]{line=func: 0..2pi by 0.001, width=600, height=300}</code></li>
</ol>
<p>绘制余弦曲线图：</p>
<pre><code>@func = (x) =&gt; Math.cos(x + @offset)
</code></pre>
<p>函数参数:</p>
<ul>
<li><span class="AMElement" data-embed="false" data-config="offset: -2pi..2pi by 0.0625pi">Offset: 0.00</span></li>
</ul>
<p><span class="AMElement" data-embed="true" data-config="line=func: 0..2pi by 0.001, width=600, height=300">Chart</span></p>
<p>读者就可以将鼠标移到上方Offset参数上进行拖动来改变参数值从而改变函数图像，也可以直接将函数<code>cos</code>改为<code>sin</code>看看。</p>
<p><a href="/imarkdown">Interactive Markdown</a> 目前还在内部测试中，语义规范尚未固定。不过，我写了一个玩具可以让您自己的博客使用互动文档，用的是<a href="https://hexo.io/" target="_blank" rel="noopener">Hexo博客生成工具</a>➕️<a href="https://theme-next.org/" target="_blank" rel="noopener">Theme-Next主题</a>，通过<a href="https://github.com/snowyu/hexo-next-imarkdown" target="_blank" rel="noopener">hexo-next-imarkdown</a>插件即可让您的博客支持互动Markdown文档格式，欢迎尝鲜。</p>
<p>更详尽的<a href="/imarkdown">Interactive Markdown</a>语法请参阅💁🏻‍♂️ <a href="http://riceball.me/imarkdown/reference.html">交互式Markdown文档参考手册</a> .</p>
<h2 id="wei-lai" class="heading-control">未来<a class="heading-anchor" href="#wei-lai" aria-hidden="true"></a></h2>
<p>我希望在不久的将来使用<a href="/imarkdown">Interactive Markdown</a> 来编写绘本故事书，<a href="https://medium.com/ai-club-iiitb/text-to-image-synthesis-62eb44e65cd0" target="_blank" rel="noopener">根据文字自动产生图画</a>故事。</p>
<p>在更远的未来甚至可以开发游戏。</p>
]]></content>
      <categories>
        <category>Thinking</category>
        <category>Reactive</category>
        <category>Document</category>
        <category>Markdown</category>
      </categories>
      <tags>
        <tag>javascript</tag>
        <tag>interactive</tag>
        <tag>reactive</tag>
        <tag>document</tag>
        <tag>raphael</tag>
        <tag>markdown</tag>
      </tags>
  </entry>
  <entry>
    <title>Raphael 矢量图形和动画javascript库</title>
    <url>/article/raphael-tut/</url>
    <content><![CDATA[<p>raphael 是一套创建的矢量图形和动画的javascript库，它使用SVG W3C推荐标准和VML作为创建图形的基础。</p>
<h1 id="chuang-jian-tu-xing-dui-xiang" class="heading-control">创建图形对象<a class="heading-anchor" href="#chuang-jian-tu-xing-dui-xiang" aria-hidden="true"></a></h1>
<p>raphael支持圆形，矩形，椭圆矢量图形对象的直接创建，下面以最简单的矩形绘制进行讲解。</p>
<h2 id="ju-xing-rect" class="heading-control">矩形(Rect)<a class="heading-anchor" href="#ju-xing-rect" aria-hidden="true"></a></h2>
<p>参数：<span class="AMElement" data-embed="false" data-config="rx:10..">x轴坐标:10</span>，<span class="AMElement" data-embed="false" data-config="ry:10..">y轴坐标:18</span>，<span class="AMElement" data-embed="false" data-config="rw:1..">宽度:100</span>，<span class="AMElement" data-embed="false" data-config="rh:1..">高度:50</span></p>
<p>下面演示在提供好的画布上用上述参数绘制一个矩形，点击下面的播放按钮进行演示：</p>
<pre><code class="output"># 演示绘制矩形的过程
paper = @canvas

|
~~~
tooltip: 设置画布大小为200X100 ::: 初始化工作
type:paper.setSize(200,100)\n
tooltip: 清空画布
type:paper.clear()\n
tooltip: 初始化来自文档的x,y座标，宽度和高度参数变量
type:@rx ||=10\n
type:@ry ||=18\n
type:@rw ||=100\n
type:@rh ||=50\n
tooltip: 开始绘制矩形 ::: 绘制矩形
type:rect = paper.rect(@rx, @ry, @rw, @rh)\n
tooltip: 为矩形填充红色
type:rect.attr('fill', 'red')
moveTo: 8:13
tooltip: 现在你可以自己试一试了
</code></pre>
<hr>
<p>看完演示，你可以这上面的代码中自己动手试一试了,比如: 圆，椭圆, 文字，图片等等。</p>
<ul>
<li>circle(x, y, r)</li>
<li>ellipse(x, y, xr, yr)</li>
<li>image(src, x, y, width, height)</li>
<li>text(50, 50, “Hi world\n你好世界”)</li>
</ul>
<p>所有这些绘制后都会返回一个图形对象，你可以对它进行各种操作，比如show/hide,改变属性attr。</p>
<h2 id="path-lu-jing" class="heading-control">Path(路径)<a class="heading-anchor" href="#path-lu-jing" aria-hidden="true"></a></h2>
<p>更复杂的对象也可以通过path来实现描述。路径是矢量绘图里最强大的工具，同时也比较复杂。</p>
<pre><code class="output">paper = @canvas
paper.setSize(200,100)
paper.clear()
paper.path('M100,0 L200,100 L10,100 Z').attr({'fill': 'blue', 'stroke': 'black'})
</code></pre>
<p>路径的参数是一组字符串，由“命令字母+坐标数字”的组合构成。数字表示坐标点，字母负责表示如何连接这些坐标点。比如x的示例中，M表示起点，L表示直线连接，所以上述的path的信息可以这样解读：</p>
<ul>
<li>M100,0      -&gt;    以（100，0）坐标点为起点</li>
<li>L200,100    -&gt;    从（100，0）向（200，100）画一条直线</li>
<li>L10,100     -&gt;    从（200，100）向（10，100）画一条直线</li>
<li>Z           -&gt;    闭合路径,将路径的开始和结束点用直线连接</li>
</ul>
<p>在path中，一共有10个命令可以使用，下面5个命令是基础，比较简单。</p>
<ul>
<li>M: moveTo(x,y)   移动到 x,y 坐标</li>
<li>Z:closepath()    闭合路径, 将路径的开始和结束点用直线连接</li>
<li>L:lineTo(x,y)    直线    当前节点到指定(x,y)节点，直线连接</li>
<li>H: Horz(x)       水平直线 保持当前点的y坐标不变，x轴移动到x，形成水平线</li>
<li>V: Vert(y)       垂直直线 保持当前点的x坐标不变，y轴移动到y，形成垂直线</li>
</ul>
<h2 id="dong-hua" class="heading-control">动画<a class="heading-anchor" href="#dong-hua" aria-hidden="true"></a></h2>
<p>在raphael中绘制的每一个元素都可以轻易的制作动画，只要我们设定它的起始和结束属性即可。假如我们对前面的矩形进行动画，设定它的结束属性为：</p>
<ul>
<li><span class="AMElement" data-embed="false" data-config="rex:0..">x轴坐标:100</span>，<span class="AMElement" data-embed="false" data-config="rey:0..">y轴坐标:40</span></li>
<li><span class="AMElement" data-embed="false" data-config="rew:1..">宽度:100</span>，<span class="AMElement" data-embed="false" data-config="reh:1..">高度:100</span></li>
<li>填充颜色为黄色</li>
<li>旋转120度</li>
<li>透明度设为 0.3</li>
</ul>
<p>然后设定当对矩形点击的时候开始动画。</p>
<pre><code class="output">paper = @canvas
paper.setSize(300,160)
paper.clear()
@rx ||=0
@ry ||=0
@rw ||=100
@rh ||=50
# 获取结束时候的矩形参数
@rex ||=100
@rey ||=40
@rew ||=100
@reh ||=100

rect = paper.rect(@rx, @ry, @rw, @rh).attr({'fill': 'red', 'opacity': 1})

elAttrs = []
elAttrs.push(_.clone(rect.attr()))

elAttrs.push(
    {
      x: @rex, y: @rey, transform: &quot;r120&quot;
      width: @rew, height: @reh
      fill: 'yellow'
      opacity: .3
    }
)

reverse = 0
rect.mousedown(  () -&gt;
    rect.stop().animate(elAttrs[+(reverse = !reverse)], 1000)
)

</code></pre>
<p>现在你可以在矩形上点击看看动画效果。</p>
]]></content>
      <categories>
        <category>Library</category>
        <category>Graphic</category>
      </categories>
      <tags>
        <tag>javascript</tag>
        <tag>raphael</tag>
        <tag>graphic</tag>
        <tag>animation</tag>
        <tag>vector</tag>
        <tag>tut</tag>
      </tags>
  </entry>
  <entry>
    <title>CouchDB</title>
    <url>/article/couchdb/</url>
    <content><![CDATA[<p>CouchDB 是一个面向文档的<code>NoSQL</code>数据库。CouchDB还可以把整个H5网站直接放到数据库中，这称为<code>CouchApp</code>，详见后述。</p>
<a id="more"></a>
<h2 id="source-build" class="heading-control">Source Build<a class="heading-anchor" href="#source-build" aria-hidden="true"></a></h2>
<pre><code class="bash">sudo apt-get --no-install-recommends -y install \
    build-essential pkg-config erlang erlang-reltool \
    libicu-dev libcurl4-openssl-dev
sudo apt-get install devscripts libnspr4-dev pkg-kde-tools
git <span class="hljs-built_in">clone</span> https://github.com/apache/couchdb
git <span class="hljs-built_in">clone</span> https://github.com/apache/couchdb-pkg
<span class="hljs-built_in">cd</span> couchdb-pkg
make couch-js-debs PLATFORM=bionic <span class="hljs-comment"># howto use it? still cannot find jsapi.h</span>
sudo dpkg -i js/couch-libmozjs185-*.deb

<span class="hljs-comment"># build dpkg needed:</span>
sudo apt install dh-exec dh-systemd nodejs python-sphinx

make build-couch $(lsb_release -cs) PLATFORM=$(lsb_release -cs)
</code></pre>
<h2 id="gai-nian" class="heading-control">概念<a class="heading-anchor" href="#gai-nian" aria-hidden="true"></a></h2>
<h3 id="shu-ju-ku-database" class="heading-control">数据库(database)<a class="heading-anchor" href="#shu-ju-ku-database" aria-hidden="true"></a></h3>
<p>概念比较:</p>
<table>
<thead>
<tr>
<th>MongoDB</th>
<th>CouchDB</th>
</tr>
</thead>
<tbody>
<tr>
<td>Collection</td>
<td>Database</td>
</tr>
<tr>
<td>Key/Value</td>
<td>_id/Document</td>
</tr>
</tbody>
</table>
<p>在MongoDB中称 <code>database</code> 为 <code>Collection</code>。 一个<code>K/V键值对</code>在<code>CouchDB</code>称为 <code>Document</code>.</p>
<p>可以查询、创建和删除数据库，数据库的名称只能是小写字母、数字以及特殊字符_$()±/。</p>
<ul>
<li><code>GET /_all_dbs</code>: 查询 CouchDB 中所有的数据库名称。该请求返回的是一个 JSON 数组<pre><code class="js">[<span class="hljs-string">"_global_changes"</span>,<span class="hljs-string">"_replicator"</span>,<span class="hljs-string">"_users"</span>]
</code></pre>
</li>
<li><code>GET /[database-name]</code>: 查询名为databasename的数据库的具体信息.<pre><code class="js">{<span class="hljs-string">"db_name"</span>:<span class="hljs-string">"_users"</span>,<span class="hljs-string">"update_seq"</span>:<span class="hljs-string">"1-g1AAAA"</span>,<span class="hljs-string">"sizes"</span>:{<span class="hljs-string">"file"</span>:<span class="hljs-number">38054</span>,<span class="hljs-string">"external"</span>:<span class="hljs-number">5024</span>,<span class="hljs-string">"active"</span>:<span class="hljs-number">2197</span>},<span class="hljs-string">"purge_seq"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"other"</span>:{<span class="hljs-string">"data_size"</span>:<span class="hljs-number">5024</span>},<span class="hljs-string">"doc_del_count"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"doc_count"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"disk_size"</span>:<span class="hljs-number">38054</span>,<span class="hljs-string">"disk_format_version"</span>:<span class="hljs-number">6</span>,<span class="hljs-string">"data_size"</span>:<span class="hljs-number">2197</span>,<span class="hljs-string">"compact_running"</span>:<span class="hljs-literal">false</span>,<span class="hljs-string">"instance_start_time"</span>:<span class="hljs-string">"0"</span>}
</code></pre>
</li>
<li><code>PUT /[database-name]</code>: 创建名为databasename的数据库。如果数据库创建成功的话，返回 HTTP 状态代码 201 ；如果已有一个同名数据库的话，返回 HTTP 状态代码 412 。</li>
<li><code>DELETE /[database-name]</code>: 删除名为databasename的数据库。如果数据库删除成功的话，返回 HTTP 状态代码 200 ；如果数据库不存在，返回 HTTP 状态代码 404 。</li>
</ul>
<h4 id="nei-bu-shu-ju-ku" class="heading-control">内部数据库<a class="heading-anchor" href="#nei-bu-shu-ju-ku" aria-hidden="true"></a></h4>
<p>内部数据库以&quot;_&quot;打头。</p>
<ul>
<li><code>_users</code> 为用户数据库(authentication)，默认匿名用户可以创建用户。可以在<code>_design/_auth</code>中添加限制，参考后面的代码样例。</li>
<li><code>_session</code>: 服务器端的用户会话管理。</li>
<li><code>_config</code> 为系统配置数据库，管理员配置也在其中。</li>
</ul>
<h5 id="an-quan-yu-ren-zheng-users" class="heading-control">安全与认证(_users)<a class="heading-anchor" href="#an-quan-yu-ren-zheng-users" aria-hidden="true"></a></h5>
<p><a href="http://docs.couchdb.org/en/2.1.1/intro/security.html" target="_blank" rel="noopener">http://docs.couchdb.org/en/2.1.1/intro/security.html</a></p>
<ul>
<li><code>_id</code> (string): Document ID. Contains user’s login with special prefix Why the <code>org.couchdb.user</code>: prefix?</li>
<li><code>derived_key</code> (string): PBKDF2 key</li>
<li><code>name</code> (string): User’s name aka login. Immutable e.g. you cannot rename an existing user - you have to create new one</li>
<li><code>roles</code> (array of string): List of user roles. CouchDB doesn’t provide any built-in roles, so you’re free to define your own depending on your needs. However, you cannot set system roles like _admin there. Also, only administrators may assign roles to users - by default all users have no roles. 你可以自己定义role，然后在<code>validate_doc_update</code>中去检测角色。</li>
<li><code>password_sha</code> (string): Hashed password with salt. Used for simple password_scheme</li>
<li><code>password_scheme</code> (string): Password hashing scheme. May be simple or pbkdf2</li>
<li><code>salt</code> (string): Hash salt. Used for simple password_scheme</li>
<li><code>type</code> (string): Document type. Constantly has the value user</li>
</ul>
<p>Why the <code>org.couchdb.user</code>: prefix?</p>
<p>The reason there is a special prefix before a user’s login name is to have namespaces that users belong to. This prefix is designed to prevent replication conflicts when you try merging two or more <code>_user</code> databases.</p>
<p>For current CouchDB releases, all users belong to the same <code>org.couchdb.user</code> namespace and this cannot be changed. This may be changed in future releases.</p>
<h3 id="wen-dang-document" class="heading-control">文档（document）<a class="heading-anchor" href="#wen-dang-document" aria-hidden="true"></a></h3>
<p>文档是 CouchDB 中的核心概念。一个 CouchDB 数据库实际上是一系列文档的集合。每个文档是一系列数据项的集合。每个数据项都有一个名称与对应的值，值既可以是简单的数据类型，如字符串、数字和日期等；也可以是复杂的类型，如数组和对象。每个文档都有一个全局惟一的标识符（ID）以及一个修订版本号（revision number）。 ID 用来惟一标识一个文档（相当于Key），而修订版本号则用来实现多版本并发控制（Multiversion concurrency control，MVVC）。在 CouchDB 中，文档是以 JSON 对象的形式保存的。文档中至少要包含<code>_id</code>和<code>_rev</code>字段，其中以“_”作为前缀的顶层字段是由 CouchDB 保留使用的。</p>
<ul>
<li>
<p><code>_id</code> : 全局惟一的标识符，用来惟一标识一个文档；</p>
</li>
<li>
<p><code>_rev</code> : 修订版本号，用来实现多版本并发控制（Multiversion concurrency control，MVVC）；</p>
</li>
<li>
<p><code>_attachments</code> : 内嵌型附件，以 base64 编码的格式作为文档的一个字段保存；</p>
</li>
<li>
<p><code>GET /[databasename]/[doc_id]</code></p>
</li>
<li>
<p><code>PUT /[databasename]/[doc_id]</code> 创建或更新文档</p>
</li>
<li>
<p>更新已有的文档:在 PUT 请求内容的文档中需要包含_rev字段，表示文档的修订版本号。 CouchDB 使用该字段来做更新时的冲突检测。如果该字段的值与 CouchDB 中保存的该文档的修订版本号一致，则表明没有冲突，可以进行更新。当更新完成之后，返回 HTTP 状态代码 201 ；否则返回 HTTP 状态代码 409，表示有版本冲突。</p>
</li>
<li>
<p><code>POST /[databasename]</code> 创建文档,<code>_id</code>由系统决定。</p>
</li>
<li>
<p><code>DELETE /[databasename]/[doc_id]?rev=[rev_id]</code> 删除数据库databasename中 ID 为doc_id，并且修订版本号为rev_id的文档。</p>
</li>
</ul>
<p>用文档来描述关系：</p>
<pre><code class="js"><span class="hljs-comment">// 用内嵌文档 ID 描述多对多关系</span>
 {
  <span class="hljs-string">"_id"</span> : <span class="hljs-string">"user1"</span>,
  <span class="hljs-string">"username"</span> : <span class="hljs-string">"Alex"</span>,
  <span class="hljs-string">"email"</span> : <span class="hljs-string">"alexcheng1982@gmail.com"</span>,
  <span class="hljs-string">"roles"</span>:[<span class="hljs-string">"db_admin"</span>,<span class="hljs-string">"backup_admin"</span>]
 }
 {
  <span class="hljs-string">"_id"</span> : <span class="hljs-string">"db_admin"</span>,
  <span class="hljs-string">"name"</span> : <span class="hljs-string">" 数据库管理员 "</span>,
  <span class="hljs-string">"priority"</span> : <span class="hljs-number">2</span>
 }

 <span class="hljs-comment">// 用关联文档描述多对多关系</span>
 {
  <span class="hljs-string">"_id"</span> : <span class="hljs-string">"user1"</span>,
  <span class="hljs-string">"username"</span> : <span class="hljs-string">"Alex"</span>,
  <span class="hljs-string">"email"</span> : <span class="hljs-string">"alexcheng1982@gmail.com"</span>
 }
 {
  <span class="hljs-string">"_id"</span> : <span class="hljs-string">"db_admin"</span>,
  <span class="hljs-string">"name"</span> : <span class="hljs-string">" 数据库管理员 "</span>,
  <span class="hljs-string">"priority"</span> : <span class="hljs-number">2</span>
 }
 {
  <span class="hljs-string">"_id"</span> : <span class="hljs-string">"user_role_001"</span>,
  <span class="hljs-string">"user_id"</span> : <span class="hljs-string">"user1"</span>,
  <span class="hljs-string">"role_id"</span> : <span class="hljs-string">"db_admin"</span>
 }
</code></pre>
<h4 id="wen-dang-cha-xun" class="heading-control">文档查询<a class="heading-anchor" href="#wen-dang-cha-xun" aria-hidden="true"></a></h4>
<p><a href="https://pouchdb.com/2014/04/14/pagination-strategies-with-pouchdb.html" target="_blank" rel="noopener">https://pouchdb.com/2014/04/14/pagination-strategies-with-pouchdb.html</a><br>
<a href="https://pouchdb.com/guides/queries.html#pouchdb-find" target="_blank" rel="noopener">https://pouchdb.com/guides/queries.html#pouchdb-find</a></p>
<p>Pouchdb这里推荐是all_docs</p>
<ul>
<li><code>GET /[db]/_all_docs</code> is a special case for CouchDB. Instead of the normal Unicode Collation, it uses ASCII collation. 故不推荐使用<a href="https://wiki.apache.org/couchdb/View_collation" target="_blank" rel="noopener">1</a>。</li>
<li><a href="http://docs.couchdb.org/en/2.0.0/api/database/find.html" target="_blank" rel="noopener">POST /[db]/_find</a>: 可以</li>
</ul>
<pre><code class="js">{
  <span class="hljs-string">"selector"</span>: {
    <span class="hljs-string">"_id"</span>: {<span class="hljs-string">"$gt"</span>: <span class="hljs-string">"产品\u0000"</span>, <span class="hljs-string">"$lt"</span>: <span class="hljs-string">"产品/\uffff"</span>}
  }
}
</code></pre>
<p><code>_find</code> 是类似MongoDB的查询方式(<a href="https://pouchdb.com/guides/mango-queries.html" target="_blank" rel="noopener">https://pouchdb.com/guides/mango-queries.html</a>).<br>
这里被称为<code>Mango queries</code>, 从CouchDB@2.1.1开始支持<code>partial indexes</code>查询以及分页。</p>
<p>数组的Mango查询类型：</p>
<pre><code class="js">{
  <span class="hljs-string">"selector"</span>: {
    <span class="hljs-string">"tags"</span>: {<span class="hljs-attr">$elemMatch</span>: {<span class="hljs-attr">$eq</span>: <span class="hljs-string">'apple'</span>}}
  }
}
<span class="hljs-comment">//等价于</span>
{
  <span class="hljs-string">"selector"</span>: {
    <span class="hljs-string">"tags"</span>: {<span class="hljs-attr">$in</span>: [<span class="hljs-string">'apple'</span>]}
  }
}
</code></pre>
<p>如果数组类型是<code>json object</code>好像可以加索引(经测试无效，还是不能利用索引！)：<a href="https://stackoverflow.com/questions/35784178/how-to-index-multidimensional-arrays-in-couchdb" target="_blank" rel="noopener">https://stackoverflow.com/questions/35784178/how-to-index-multidimensional-arrays-in-couchdb</a><br>
看到了，是Cloudant的扩展，全文检索引擎，索引类型必须为 <code>text</code>. 大致看来需要自己编译couchdb并使用它的dreyfus插件，菜可以和lucene连上。<br>
<a href="https://developer.ibm.com/dwblog/2015/text-search-apache-couchdb/" target="_blank" rel="noopener">https://developer.ibm.com/dwblog/2015/text-search-apache-couchdb/</a><br>
<a href="https://github.com/cloudant-labs/dreyfus/wiki/Introduce-dreyfus-into-couchdb" target="_blank" rel="noopener">https://github.com/cloudant-labs/dreyfus/wiki/Introduce-dreyfus-into-couchdb</a><br>
<a href="https://github.com/apache/couchdb-docker/issues/8" target="_blank" rel="noopener">https://github.com/apache/couchdb-docker/issues/8</a><br>
<a href="https://github.com/grueni/oi-userland/tree/couchdb-dreyfus" target="_blank" rel="noopener">https://github.com/grueni/oi-userland/tree/couchdb-dreyfus</a><br>
<a href="https://github.com/neutrinity/ntr-couch-docker" target="_blank" rel="noopener">https://github.com/neutrinity/ntr-couch-docker</a></p>
<pre><code class="js">{
<span class="hljs-string">"Teams"</span>: [
  {
   <span class="hljs-string">"id"</span>: <span class="hljs-string">"79d25d41d991890350af672e0b76faed"</span>,
   <span class="hljs-string">"name"</span>: <span class="hljs-string">"First Team"</span>,
   <span class="hljs-string">"level"</span>: <span class="hljs-string">"123"</span>
  },
  {
   <span class="hljs-string">"id"</span>: <span class="hljs-string">"e500c1bf691b9cfc99f05634da80b6d1"</span>,
   <span class="hljs-string">"name"</span>: <span class="hljs-string">"Second Team Name"</span>,
   <span class="hljs-string">"level"</span>: <span class="hljs-string">""</span>
  },
  {
   <span class="hljs-string">"id"</span>: <span class="hljs-string">"4645e8a4958421f7d843d9b34c4cd9fe"</span>,
   <span class="hljs-string">"name"</span>: <span class="hljs-string">"Third Team Name"</span>,
   <span class="hljs-string">"level"</span>: <span class="hljs-string">"123"</span>
  }
 ],
 <span class="hljs-string">"LastTeam"</span>: <span class="hljs-string">"79d25d41d991890350af672e0b76faed"</span>
}

<span class="hljs-comment">//index:</span>
{
  <span class="hljs-string">"index"</span>: {
    <span class="hljs-string">"fields"</span>: [
      {<span class="hljs-string">"name"</span>: <span class="hljs-string">"Teams.[].id"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>}
    ]
  },
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>
}

<span class="hljs-comment">//query:</span>
{
  <span class="hljs-string">"selector"</span>: {
    <span class="hljs-string">"Teams"</span>: {<span class="hljs-string">"$elemMatch"</span>: {<span class="hljs-string">"id"</span>: <span class="hljs-string">"79d25d41d991890350af672e0b76faed"</span>}}
  },
  <span class="hljs-string">"fields"</span>: [
    <span class="hljs-string">"_id"</span>,
    <span class="hljs-string">"FirstName"</span>,
    <span class="hljs-string">"LastName"</span>
  ]
}
</code></pre>
<p>对数组的查询可以，但是目前没有索引支持！！<br>
Currently couchdb find does not support indexing array members (<a href="https://issues.apache.org/jira/browse/COUCHDB-2867" target="_blank" rel="noopener">https://issues.apache.org/jira/browse/COUCHDB-2867</a>). Pouchdb is matching Couchdb’s implementation here.</p>
<p>用Map/Reduce查询数组：</p>
<pre><code class="js"><span class="hljs-comment">//创建Map/Reduce索引</span>
<span class="hljs-keyword">var</span> designDoc = {
  <span class="hljs-attr">_id</span>: <span class="hljs-string">'_design/_index'</span>,
  <span class="hljs-attr">views</span>: {
    <span class="hljs-string">'by_tags'</span>: {
      <span class="hljs-attr">map</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">doc</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(doc.tags)) {
          doc.tags.forEach(<span class="hljs-function"><span class="hljs-params">tag</span>=&gt;</span>emit(tag));
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (doc.tags) {
          emit(doc.tags)
        }
      }.toString()
    }
  }
};

pouch.put(designDoc).then(<span class="hljs-function"><span class="hljs-params">r</span>=&gt;</span><span class="hljs-built_in">console</span>.log(r)).catch(<span class="hljs-function"><span class="hljs-params">e</span>=&gt;</span><span class="hljs-built_in">console</span>.log(e))

<span class="hljs-comment">//查询参数：详见后述「视图(View)的查询参数」</span>
<span class="hljs-comment">//keys 参数: 只获取在数组中的key名称。</span>
pouch.query(viewName, {<span class="hljs-attr">keys</span>:[<span class="hljs-string">'apple'</span>], <span class="hljs-attr">inclusive_end</span>: <span class="hljs-literal">false</span>});

</code></pre>
<p>避免使用数组:</p>
<pre><code>_id:  人/{id}/.tag/apple
name: apple
type: tag
</code></pre>
<p>至于limit的配置只能通过<a href="http://docs.couchdb.org/en/master/config/couchdb.html" target="_blank" rel="noopener">max_document_size</a>.<br>
或者 <a href="http://docs.couchdb.org/en/master/config/http.html" target="_blank" rel="noopener">max_http_request_size</a></p>
<pre><code class="ini"><span class="hljs-section">[couchdb]</span>
<span class="hljs-attr">max_document_size</span> = <span class="hljs-number">4294967296</span> <span class="hljs-comment">; 4 GB</span>
<span class="hljs-section">[httpd]</span>
<span class="hljs-attr">max_http_request_size</span> = <span class="hljs-number">4294967296</span> <span class="hljs-comment">; 4 GB</span>
</code></pre>
<p>不过有人在改： <a href="https://github.com/apache/couchdb-couch-mrview/pull/56/files" target="_blank" rel="noopener">https://github.com/apache/couchdb-couch-mrview/pull/56/files</a><br>
<a href="https://jira.hyperledger.org/browse/FAB-2809" target="_blank" rel="noopener">https://jira.hyperledger.org/browse/FAB-2809</a></p>
<h3 id="wen-dang-bian-geng-tong-zhi" class="heading-control">文档变更通知<a class="heading-anchor" href="#wen-dang-bian-geng-tong-zhi" aria-hidden="true"></a></h3>
<p><code>GET /[db]/_changes</code><br>
<code>POST /[db]/_changes?filter=_doc_ids</code> 如果有大量的<code>doc_ids</code>，那么就只能用POST.</p>
<pre><code>POST /recipes/_changes?filter=_doc_ids HTTP/1.1
Accept: application/json
Content-Length: 40
Content-Type: application/json
Host: localhost:5984

{
    &quot;doc_ids&quot;: [
        &quot;SpaghettiWithMeatballs&quot;
    ]
}
</code></pre>
<h4 id="changes-feed" class="heading-control">Changes Feed<a class="heading-anchor" href="#changes-feed" aria-hidden="true"></a></h4>
<p>文档变更通知的三种方式</p>
<h5 id="polling" class="heading-control">Polling<a class="heading-anchor" href="#polling" aria-hidden="true"></a></h5>
<p>A list of changes made to documents in the database, in the order they were made, can be obtained from the database’s _changes resource. You can query the _changes resource by issuing a GET request with the following (optional) parameters:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Value</th>
<th>Default Value</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>since</td>
<td>seqnum/now</td>
<td>0</td>
<td>(1)</td>
</tr>
<tr>
<td>limit</td>
<td>maxsequences</td>
<td>none</td>
<td>(2)</td>
</tr>
<tr>
<td>descending</td>
<td>boolean</td>
<td>false</td>
<td>(3)</td>
</tr>
<tr>
<td>feed</td>
<td>normal/longpoll/continuous/eventsource</td>
<td>normal</td>
<td>(4)</td>
</tr>
<tr>
<td>heartbeat</td>
<td>milliseconds</td>
<td>60000</td>
<td>(5)</td>
</tr>
<tr>
<td>timeout</td>
<td>milliseconds</td>
<td>60000</td>
<td>(6)</td>
</tr>
<tr>
<td>filter</td>
<td>designdoc/filtername/_view</td>
<td>none</td>
<td>(7)</td>
</tr>
<tr>
<td>include_docs</td>
<td>boolean</td>
<td>false</td>
<td>(8)</td>
</tr>
<tr>
<td>style</td>
<td>all_docs/main_only</td>
<td>main_only</td>
<td>(9)</td>
</tr>
<tr>
<td>view</td>
<td>designdoc/filtername</td>
<td>none</td>
<td>(10)</td>
</tr>
</tbody>
</table>
<p>Notes:</p>
<ol>
<li>Start the results from the change immediately after the given sequence number.</li>
<li>Limit number of result rows to the specified value (note that using 0 here has the same effect as 1).</li>
<li>Return the change results in descending sequence order (most recent change first)</li>
<li>Select the type of feed.</li>
<li>Period in milliseconds after which an empty line is sent in the results. Only applicable for longpoll or continuous feeds. Overrides any timeout to keep the feed alive indefinitely.</li>
<li>Maximum period in milliseconds to wait for a change before the response is sent, even if there are no results. Only applicable for longpoll or continuous feeds. Note that 60000 is also the default maximum timeout to prevent undetected dead connections.</li>
</ol>
<p>You can change the default maximum timeout in your ini-configuration:</p>
<pre><code class="ini"><span class="hljs-section">[httpd]</span>
<span class="hljs-attr">changes_timeout</span>=<span class="hljs-comment">#millisecs</span>
</code></pre>
<ol start="7">
<li>Reference to a filter function from a design document that will filter whole stream emitting only filtered events. See the section in the book for more information.</li>
<li>Include the associated document with each result. If there are conflicts, only the winning revision is returned.</li>
<li>Specifies how many revisions are returned in the changes array. The default, main_only, will only return the current “winning” revision; all_docs will return all leaf revisions (including conflicts and deleted former conflicts.)</li>
<li>Allows to use view functions as filters. It requires to set filter special value _view to enable this feature. Documents counted as “passed” for view filter in case if map function emits at least one record for them.</li>
</ol>
<h5 id="longpoll" class="heading-control">longpoll<a class="heading-anchor" href="#longpoll" aria-hidden="true"></a></h5>
<p>打开连接，等待直到有改变发生后，就立刻连接关闭。适合于低频率的更新。</p>
<h5 id="continuous" class="heading-control">continuous<a class="heading-anchor" href="#continuous" aria-hidden="true"></a></h5>
<p>一直打开连接,永不disconnect.</p>
<p><code>GET /somedatabase/_changes?feed=continuous HTTP/1.1</code></p>
<pre><code>{&quot;seq&quot;:1,&quot;id&quot;:&quot;fresh&quot;,&quot;changes&quot;:[{&quot;rev&quot;:&quot;1-967a00dff5e02add41819138abb3284d&quot;}]}
{&quot;seq&quot;:3,&quot;id&quot;:&quot;updated&quot;,&quot;changes&quot;:[{&quot;rev&quot;:&quot;2-7051cbe5c8faecd085a3fa619e6e6337&quot;}]}
{&quot;seq&quot;:5,&quot;id&quot;:&quot;deleted&quot;,&quot;changes&quot;:[{&quot;rev&quot;:&quot;2-eec205a9d413992850a6e32678485900&quot;}],&quot;deleted&quot;:true}
... tum tee tum ...
{&quot;seq&quot;:6,&quot;id&quot;:&quot;updated&quot;,&quot;changes&quot;:[{&quot;rev&quot;:&quot;3-825cb35de44c433bfb2df415563a19de&quot;}]}
</code></pre>
<h5 id="eventsource" class="heading-control">eventsource<a class="heading-anchor" href="#eventsource" aria-hidden="true"></a></h5>
<p>The eventsource feed provides push notifications that can be consumed in the form of DOM events in the browser. Refer to the <a href="http://www.w3.org/TR/eventsource/" target="_blank" rel="noopener">W3C eventsource specification</a> for further details. CouchDB honors the Last-Event-ID header, and if it’s present it will take precedence over the since query parameter.</p>
<pre><code class="js"><span class="hljs-comment">// define the event handling function</span>
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.EventSource) {

  <span class="hljs-keyword">var</span> source = <span class="hljs-keyword">new</span> EventSource(<span class="hljs-string">"/somedatabase/_changes?feed=eventsource"</span>);
  source.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
    alert(<span class="hljs-string">'EventSource failed.'</span>);
  };

  <span class="hljs-keyword">var</span> results = [];
  <span class="hljs-keyword">var</span> sourceListener = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
    <span class="hljs-keyword">var</span> data = <span class="hljs-built_in">JSON</span>.parse(e.data);
    results.push(data);
  };

  <span class="hljs-comment">// start listening for events</span>
  source.addEventListener(<span class="hljs-string">'message'</span>, sourceListener, <span class="hljs-literal">false</span>);

  <span class="hljs-comment">// stop listening for events</span>
  source.removeEventListener(<span class="hljs-string">'message'</span>, sourceListener, <span class="hljs-literal">false</span>);

}
</code></pre>
<ul>
<li><a href="http://guide.couchdb.org/draft/notifications.html" target="_blank" rel="noopener">http://guide.couchdb.org/draft/notifications.html</a></li>
<li><a href="http://docs.couchdb.org/en/2.1.1/api/database/changes.html" target="_blank" rel="noopener">http://docs.couchdb.org/en/2.1.1/api/database/changes.html</a> 这个是最新的</li>
<li><a href="http://docs.couchdb.org/en/1.4.0/changes.html" target="_blank" rel="noopener">http://docs.couchdb.org/en/1.4.0/changes.html</a> 这个写得简单清晰点。</li>
<li><a href="https://www.npmjs.com/package/couch-streams" target="_blank" rel="noopener">https://www.npmjs.com/package/couch-streams</a></li>
</ul>
<h3 id="shi-tu-view-yu-mapreduce-cha-xun" class="heading-control">视图（view） 与 Map/Reduce 查询<a class="heading-anchor" href="#shi-tu-view-yu-mapreduce-cha-xun" aria-hidden="true"></a></h3>
<p>视图是 CouchDB 中文档的呈现方式。在很多情况下，应用都需要对文档进行一定的处理，包括过滤、组织、聚合和生成报表等。在关系数据库中，这通常是通过 SQL 语句来完成的。 CouchDB 中的视图声明了如何从文档中提取数据，以及如何对提取出来的数据进行处理。</p>
<p>CouchDB 中有两种视图：永久视图和临时视图。永久视图保存在设计文档的views字段中。临时视图是通过发送 POST 请求到 <code>/[databasename]/_temp_view</code> 来执行的。临时视图只在开发测试中使用，因为它是即时生成的，性能比较差；永久视图的运行结果可以被 CouchDB 缓存，因此一般用在生产环境中。</p>
<p>视图的运行由专门的视图服务器来完成。 CouchDB 中默认的视图定义语言是 JavaScript 。 CouchDB 中的视图运行使用的是 MapReduce 编程模型。每个视图的定义中至少需要提供 Map 方法，Reduce 方法是可选的。</p>
<p>Map 方法的参数只有一个，就是当前的文档对象。 Map 方法的实现需要根据文档对象的内容，确定是否要输出结果。如果需要输出的话，可以通过<code>emit</code>来完成。<code>emit</code>方法有两个参数，分别是key和value，分别表示输出结果的键和值。使用什么样的键和值应该根据视图的实际需要来确定。当希望对文档的某个字段进行排序和过滤操作的时候，应该把该字段作为键（key）或是键的一部分；value的值可以提供给 Reduce 方法使用，也可能会出现在最终的结果中。可以作为键的不仅是简单数据类型，也可以是任意的 JSON 对象。比如<code>emit([doc.title, doc.price], doc)</code>中，使用数组作为键。</p>
<pre><code class="js"><span class="hljs-comment">//map</span>
<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">doc</span>) </span>{
  <span class="hljs-comment">//checks whether our document has a date and a title attribute</span>
  <span class="hljs-keyword">if</span>(doc.date &amp;&amp; doc.title) {
      <span class="hljs-comment">//The most important feature of a view result is that it is sorted by key.</span>
      <span class="hljs-comment">//emit key, value</span>
      emit(doc.date, doc.title);
  }
}
</code></pre>
<p>通过 Map 方法输出的结果称为中间结果。中间结果可以通过 Reduce 方法来进一步做聚集操作。聚集操作是对结果中键（key）相同的数据集合来进行的。 Reduce 方法的输入不仅是 Map 方法输出的中间结果，也可以是上一次 Reduce 方法的结果，后面这种情况称为 <code>rereduce</code> 。 Reduce 方法的参数有三个：key、values和rereduce，分别表示键、值和是否是 rereduce 。由于 rereduce 情况的存在，Reduce 方法一般需要处理两种情况：</p>
<ul>
<li>传入的参数<code>rereduce</code>的值为false：这表明 Reduce 方法的输入是 Map 方法输出的中间结果。参数key的值是一个数组，对应于中间结果中的每条记录。该数组的每个元素都是一个包含两个元素的数组，第一个元素是在 Map 方法中通过emit输出的键（key），第二个元素是记录所在的文档 ID 。参数values的值是一个数组，对应于 Map 方法中通过emit输出的值（value）。</li>
<li>传入的参数rereduce的值为true：这表明 Reduce 方法的输入是上次 Reduce 方法的输出。参数key的值为null。参数values的值是一个数组，对应于上次 Reduce 方法的输出结果。</li>
</ul>
<pre><code class="js"><span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">keys, values, rereduce</span>) </span>{
    <span class="hljs-keyword">return</span> sum(values);
}
</code></pre>
<pre><code class="js">{
  <span class="hljs-string">"_id"</span>: <span class="hljs-string">"_design/foo"</span>,
  <span class="hljs-string">"views"</span>: {
    <span class="hljs-string">"bar"</span>: {
      <span class="hljs-string">"map"</span>: <span class="hljs-string">"function (doc) { emit(doc.author, 1); }"</span>,
      <span class="hljs-string">"reduce"</span>: <span class="hljs-string">"_sum"</span> <span class="hljs-comment">//use the buildin reduce func to speedup.</span>
      <span class="hljs-comment">//"reduce": "function (keys, values, rereduce) { return sum(values); }"</span>
    }
  }
}
</code></pre>
<p><a href="http://docs.couchdb.org/en/2.1.0/ddocs/ddocs.html#reducefun-builtin" target="_blank" rel="noopener">http://docs.couchdb.org/en/2.1.0/ddocs/ddocs.html#reducefun-builtin</a></p>
<h4 id="shi-tu-view-de-cha-xun-can-shu" class="heading-control">视图(View)的查询参数<a class="heading-anchor" href="#shi-tu-view-de-cha-xun-can-shu" aria-hidden="true"></a></h4>
<p>在查询视图的时候，支持以下的参数查询：</p>
<ul>
<li>conflicts (boolean) – Includes conflicts information in response. Ignored if include_docs isn’t true. Default is false</li>
<li>descending (boolean) – Return the documents in descending by key order. Default is false</li>
<li>endkey (json) – Stop returning records when the specified key is reached. Optional</li>
<li>end_key (json) – Alias for endkey param</li>
<li>endkey_docid (string) – Stop returning records when the specified document ID is reached. Requires endkey to be specified for this to have any effect. Optional</li>
<li>end_key_doc_id (string) – Alias for endkey_docid param</li>
<li>group (boolean) – Group the results using the reduce function to a group or single row. Default is false</li>
<li>group_level (number) – Specify the group level to be used. Optional</li>
<li>include_docs (boolean) – Include the associated document with each row. Default is false.</li>
<li>attachments (boolean) – Include the Base64-encoded content of attachments in the documents that are included if include_docs is true. Ignored if include_docs isn’t true. Default is false.</li>
<li>att_encoding_info (boolean) – Include encoding information in attachment stubs if include_docs is true and the particular attachment is compressed. Ignored if include_docs isn’t true. Default is false.</li>
<li>inclusive_end (boolean) – Specifies whether the specified end key should be included in the result. Default is true</li>
<li>key (json) – Return only documents that match the specified key. Optional</li>
<li>keys (json-array) – Return only documents where the key matches one of the keys specified in the array. Optional</li>
<li>limit (number) – Limit the number of the returned documents to the specified number. Optional</li>
<li>reduce (boolean) – Use the reduction function. Default is true</li>
<li>skip (number) – Skip this number of records before starting to return the results. Default is 0</li>
<li>sorted (boolean) – Sort returned rows (see Sorting Returned Rows). Setting this to false offers a performance boost. The total_rows and offset fields are not available when this is set to false. Default is true</li>
<li>stable (boolean) – Whether or not the view results should be returned from a stable set of shards. Default is false. Optional</li>
<li>stale (string) – Allow the results from a stale view to be used. Supported values: ok, update_after and false. ok is equivalent to stable=true&amp;update=false. update_after is equivalent to stable=true&amp;update=lazy. false is equivalent to stable=false&amp;update=true. Optional</li>
<li>startkey (json) – Return records starting with the specified key. Optional</li>
<li>start_key (json) – Alias for startkey param</li>
<li>startkey_docid (string) – Return records starting with the specified document ID. Requires startkey to be specified for this to have any effect. Optional</li>
<li>start_key_doc_id (string) – Alias for startkey_docid param</li>
<li>update (string) – Whether or not the view in question should be updated prior to responding to the user. Supported values: true, false, lazy. Default is true. Optional</li>
<li>update_seq (boolean) – Response includes an update_seq value indicating which sequence id of the database the view reflects. Default is false.</li>
</ul>
<h3 id="kuo-zhan-gai-nian" class="heading-control">扩展概念<a class="heading-anchor" href="#kuo-zhan-gai-nian" aria-hidden="true"></a></h3>
<h4 id="fu-jian-attatchment" class="heading-control">附件(attatchment)<a class="heading-anchor" href="#fu-jian-attatchment" aria-hidden="true"></a></h4>
<p>CouchDB 中也可以保存二进制文件。这些文件是以文档的附件形式存储的。 CouchDB 支持两种形式的附件：一种是内嵌型的，附件是以 base64 编码的格式作为文档的一个字段保存；另一种是独立型，附件是独立于文档保存和管理的。附件的存在使得可以在 CouchDB 中保存 Web 应用中的 HTML、CSS 和 JavaScript 文件。每个附件都包含名称、MIME 类型和数据等三项内容。</p>
<p>在请求文档的时候，内嵌型附件的实际数据默认是不包含的，包含的只是附件的元数据:</p>
<pre><code class="js">{
   <span class="hljs-string">"_id"</span>: <span class="hljs-string">"testdoc"</span>,
   <span class="hljs-string">"_rev"</span>: <span class="hljs-string">"3-1364618102"</span>,
   <span class="hljs-string">"_attachments"</span>: {
       <span class="hljs-string">"Screenshot.png"</span>: {
           <span class="hljs-string">"stub"</span>: <span class="hljs-literal">true</span>,
           <span class="hljs-string">"content_type"</span>: <span class="hljs-string">"image/png"</span>,
           <span class="hljs-string">"length"</span>: <span class="hljs-number">164279</span>
       }
   }
 }
</code></pre>
<p>独立型附件可以在不改变文档的情况下，对附件进行操作。另外，不需要对附件进行 base64 编码。要创建独立型附件，只需要发送 PUT 请求到<code>databasename/doc_id/attachment?rev=rev_id</code>就可以创建或更新一个名为attachment的附件。 PUT 请求的内容类型（Content-Type）和内容指明了附件的类型和数据。</p>
<h4 id="she-ji-wen-dang-design-document" class="heading-control">设计文档(design document)<a class="heading-anchor" href="#she-ji-wen-dang-design-document" aria-hidden="true"></a></h4>
<p>设计文档是一类特殊的文档，其 ID 必须以<code>_design/</code>开头。设计文档的存在是使用 CouchDB 开发 Web 应用的基础。在 CouchDB 中，一个 Web 应用是与一个设计文档相对应的。在设计文档中可以包含一些特殊的字段，其中包括：</p>
<ul>
<li><code>views</code>: 包含永久的视图定义；</li>
<li><code>shows</code>: 包含把文档转换成非 JSON 格式的方法；</li>
<li><code>lists</code>: 包含把视图运行结果转换成非 JSON 格式的方法；</li>
<li><code>validate_doc_update</code>: 包含验证文档更新是否有效的方法。</li>
<li><code>updatefun(doc, req)</code>: 服务器端进行<a href="http://docs.couchdb.org/en/2.1.1/ddocs/ddocs.html#update-functions" target="_blank" rel="noopener">更新文档处理器</a>，在这里可以修改文档的值。</li>
</ul>
<h5 id="validate_doc_update" class="heading-control"><code>validate_doc_update</code><a class="heading-anchor" href="#validate_doc_update" aria-hidden="true"></a></h5>
<p><code>function(newDoc, oldDoc, userCtx, secObj)</code></p>
<p>回调函数参数说明:</p>
<ul>
<li><code>newDoc</code>: incoming</li>
<li><code>oldDoc</code>: 如果是新建则无。</li>
<li><code>userCtx</code>:当前登录的用户的信息(来自<code>_users</code>数据库)
<ul>
<li>db: 当前数据库名称</li>
<li>name: 用户名</li>
<li>roles: 角色列表</li>
</ul>
</li>
<li><code>secObj</code>: Security Object(来自 <code>_security</code> 数据库)
<ul>
<li>admins: 	Roles/Users with admin privileges
<ul>
<li>roles [array] 	List of roles with parent privilege</li>
<li>names [array] 	List of users with parent privilege</li>
</ul>
</li>
<li>members 	Roles/Users with non-admin privileges
<ul>
<li>roles [array] 	List of roles with parent privilege</li>
<li>names [array] 	List of users with parent privilege</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>这个例子是 <code>_users</code> 数据库的，用来在注册/编辑/删除系统用户时候对数据进行验证。</p>
<pre><code class="js">{
  <span class="hljs-string">"_id"</span>: <span class="hljs-string">"_design/_auth"</span>,
  <span class="hljs-string">"_rev"</span>: <span class="hljs-string">"1-c79bc00c889ce9b912fbde8a3f52de37"</span>,
  <span class="hljs-string">"language"</span>: <span class="hljs-string">"javascript"</span>,
  <span class="hljs-string">"validate_doc_update"</span>: <span class="hljs-string">"function(newDoc, oldDoc, userCtx, secObj){...see below...}"</span>
}
</code></pre>
<pre><code class="js"><span class="hljs-comment">//validate_doc_update</span>
<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newDoc, oldDoc, userCtx, secObj</span>) </span>{
    <span class="hljs-keyword">if</span> (newDoc._deleted === <span class="hljs-literal">true</span>) {
        <span class="hljs-comment">// allow deletes by admins and matching users</span>
        <span class="hljs-comment">// without checking the other fields</span>
        <span class="hljs-keyword">if</span> ((userCtx.roles.indexOf(<span class="hljs-string">'_admin'</span>) !== <span class="hljs-number">-1</span>) ||
            (userCtx.name == oldDoc.name)) {
            <span class="hljs-keyword">return</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span>({<span class="hljs-attr">forbidden</span>: <span class="hljs-string">'Only admins may delete other user docs.'</span>});
        }
    }

    <span class="hljs-keyword">if</span> (newDoc.type !== <span class="hljs-string">'user'</span>) {
        <span class="hljs-keyword">throw</span>({<span class="hljs-attr">forbidden</span> : <span class="hljs-string">'doc.type must be user'</span>});
    } <span class="hljs-comment">// we only allow user docs for now</span>

    <span class="hljs-keyword">if</span> (!newDoc.name) {
        <span class="hljs-keyword">throw</span>({<span class="hljs-attr">forbidden</span>: <span class="hljs-string">'doc.name is required'</span>});
    }

    <span class="hljs-keyword">if</span> (!newDoc.roles) {
        <span class="hljs-keyword">throw</span>({<span class="hljs-attr">forbidden</span>: <span class="hljs-string">'doc.roles must exist'</span>});
    }

    <span class="hljs-keyword">if</span> (!isArray(newDoc.roles)) {
        <span class="hljs-keyword">throw</span>({<span class="hljs-attr">forbidden</span>: <span class="hljs-string">'doc.roles must be an array'</span>});
    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> idx = <span class="hljs-number">0</span>; idx &lt; newDoc.roles.length; idx++) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> newDoc.roles[idx] !== <span class="hljs-string">'string'</span>) {
            <span class="hljs-keyword">throw</span>({<span class="hljs-attr">forbidden</span>: <span class="hljs-string">'doc.roles can only contain strings'</span>});
        }
    }

    <span class="hljs-keyword">if</span> (newDoc._id !== (<span class="hljs-string">'org.couchdb.user:'</span> + newDoc.name)) {
        <span class="hljs-keyword">throw</span>({
            <span class="hljs-attr">forbidden</span>: <span class="hljs-string">'Doc ID must be of the form org.couchdb.user:name'</span>
        });
    }

    <span class="hljs-keyword">if</span> (oldDoc) { <span class="hljs-comment">// validate all updates</span>
        <span class="hljs-keyword">if</span> (oldDoc.name !== newDoc.name) {
            <span class="hljs-keyword">throw</span>({<span class="hljs-attr">forbidden</span>: <span class="hljs-string">'Usernames can not be changed.'</span>});
        }
    }

    <span class="hljs-keyword">if</span> (newDoc.password_sha &amp;&amp; !newDoc.salt) {
        <span class="hljs-keyword">throw</span>({
            <span class="hljs-attr">forbidden</span>: <span class="hljs-string">'Users with password_sha must have a salt.'</span> +
                <span class="hljs-string">'See /_utils/script/couch.js for example code.'</span>
        });
    }

    <span class="hljs-keyword">if</span> (newDoc.password_scheme === <span class="hljs-string">"pbkdf2"</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(newDoc.iterations) !== <span class="hljs-string">"number"</span>) {
            <span class="hljs-keyword">throw</span>({<span class="hljs-attr">forbidden</span>: <span class="hljs-string">"iterations must be a number."</span>});
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span>(newDoc.derived_key) !== <span class="hljs-string">"string"</span>) {
            <span class="hljs-keyword">throw</span>({<span class="hljs-attr">forbidden</span>: <span class="hljs-string">"derived_key must be a string."</span>});
        }
    }

    <span class="hljs-keyword">var</span> is_server_or_database_admin = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">userCtx, secObj</span>) </span>{
        <span class="hljs-comment">// see if the user is a server admin</span>
        <span class="hljs-keyword">if</span>(userCtx.roles.indexOf(<span class="hljs-string">'_admin'</span>) !== <span class="hljs-number">-1</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// a server admin</span>
        }

        <span class="hljs-comment">// see if the user a database admin specified by name</span>
        <span class="hljs-keyword">if</span>(secObj &amp;&amp; secObj.admins &amp;&amp; secObj.admins.names) {
            <span class="hljs-keyword">if</span>(secObj.admins.names.indexOf(userCtx.name) !== <span class="hljs-number">-1</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// database admin</span>
            }
        }

        <span class="hljs-comment">// see if the user a database admin specified by role</span>
        <span class="hljs-keyword">if</span>(secObj &amp;&amp; secObj.admins &amp;&amp; secObj.admins.roles) {
            <span class="hljs-keyword">var</span> db_roles = secObj.admins.roles;
            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> idx = <span class="hljs-number">0</span>; idx &lt; userCtx.roles.length; idx++) {
                <span class="hljs-keyword">var</span> user_role = userCtx.roles[idx];
                <span class="hljs-keyword">if</span>(db_roles.indexOf(user_role) !== <span class="hljs-number">-1</span>) {
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// role matches!</span>
                }
            }
        }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// default to no admin</span>
    }

    <span class="hljs-keyword">if</span> (!is_server_or_database_admin(userCtx, secObj)) {
        <span class="hljs-keyword">if</span> (oldDoc) { <span class="hljs-comment">// validate non-admin updates</span>
            <span class="hljs-keyword">if</span> (userCtx.name !== newDoc.name) {
                <span class="hljs-keyword">throw</span>({
                    <span class="hljs-attr">forbidden</span>: <span class="hljs-string">'You may only update your own user document.'</span>
                });
            }
            <span class="hljs-comment">// validate role updates</span>
            <span class="hljs-keyword">var</span> oldRoles = (oldDoc.roles || []).sort();
            <span class="hljs-keyword">var</span> newRoles = newDoc.roles.sort();

            <span class="hljs-keyword">if</span> (oldRoles.length !== newRoles.length) {
                <span class="hljs-keyword">throw</span>({<span class="hljs-attr">forbidden</span>: <span class="hljs-string">'Only _admin may edit roles'</span>});
            }

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; oldRoles.length; i++) {
                <span class="hljs-keyword">if</span> (oldRoles[i] !== newRoles[i]) {
                    <span class="hljs-keyword">throw</span>({<span class="hljs-attr">forbidden</span>: <span class="hljs-string">'Only _admin may edit roles'</span>});
                }
            }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (newDoc.roles.length &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span>({<span class="hljs-attr">forbidden</span>: <span class="hljs-string">'Only _admin may set roles'</span>});
        }
    }

    <span class="hljs-comment">// no system roles in users db</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; newDoc.roles.length; i++) {
        <span class="hljs-keyword">if</span> (newDoc.roles[i][<span class="hljs-number">0</span>] === <span class="hljs-string">'_'</span>) {
            <span class="hljs-keyword">throw</span>({
                <span class="hljs-attr">forbidden</span>:
                <span class="hljs-string">'No system roles (starting with underscore) in users db.'</span>
            });
        }
    }

    <span class="hljs-comment">// no system names as names</span>
    <span class="hljs-keyword">if</span> (newDoc.name[<span class="hljs-number">0</span>] === <span class="hljs-string">'_'</span>) {
        <span class="hljs-keyword">throw</span>({<span class="hljs-attr">forbidden</span>: <span class="hljs-string">'Username may not start with underscore.'</span>});
    }

    <span class="hljs-keyword">var</span> badUserNameChars = [<span class="hljs-string">':'</span>];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; badUserNameChars.length; i++) {
        <span class="hljs-keyword">if</span> (newDoc.name.indexOf(badUserNameChars[i]) &gt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span>({<span class="hljs-attr">forbidden</span>: <span class="hljs-string">'Character `'</span> + badUserNameChars[i] +
                    <span class="hljs-string">'` is not allowed in usernames.'</span>});
        }
    }
}

</code></pre>
<h2 id="couchapp" class="heading-control">CouchApp<a class="heading-anchor" href="#couchapp" aria-hidden="true"></a></h2>
<p>由于 CouchDB 的 REST API 使用 JSON 作为展现形式，因此使用 CouchDB 的 Web 应用只需要编写浏览器端的代码就可以使用 JavaScript 与 CouchDB 进行交互；而 CouchDB 所支持的附件功能，又使得浏览器端的 HTML、JavaScript 和 CSS 代码可以直接存放在 CouchDB 中。这样 CouchDB 中不但保存了 Web 应用的数据，也保存了 Web 应用的逻辑。也就是说，只需要 CouchDB 就可以构建一个完整的 Web 应用运行环境。</p>
<ul>
<li><a href="https://github.com/couchapp/couchapp" target="_blank" rel="noopener">https://github.com/couchapp/couchapp</a></li>
<li><a href="https://github.com/jo/couchdb-push" target="_blank" rel="noopener">https://github.com/jo/couchdb-push</a> Nodejs</li>
</ul>
<p>结合CouchDB自带virtualhosts和pretty-urls，就可以实现将页面url地址重写到root.</p>
<ul>
<li><a href="http://docs.couchdb.org/en/1.3.0/pretty_urls.html" target="_blank" rel="noopener">http://docs.couchdb.org/en/1.3.0/pretty_urls.html</a></li>
<li><a href="https://stackoverflow.com/questions/35643281/rewrite-urls-in-couchdb-pouchdb-server" target="_blank" rel="noopener">https://stackoverflow.com/questions/35643281/rewrite-urls-in-couchdb-pouchdb-server</a></li>
</ul>
<h3 id="couchapp" class="heading-control">Couchapp<a class="heading-anchor" href="#couchapp" aria-hidden="true"></a></h3>
<pre><code class="bash">python2.7&gt; pip install --user couchapp
couchapp init myapp
<span class="hljs-built_in">cd</span> myapp
</code></pre>
<h4 id="change-your-app-id" class="heading-control">Change your App ID<a class="heading-anchor" href="#change-your-app-id" aria-hidden="true"></a></h4>
<p>open the <code>_id</code> file: change your app name.</p>
<h4 id="set-config" class="heading-control">set config<a class="heading-anchor" href="#set-config" aria-hidden="true"></a></h4>
<p><code>.couchapprc</code>:</p>
<pre><code class="js">{
  <span class="hljs-string">"env"</span> : {
    <span class="hljs-string">"default"</span> : {
      <span class="hljs-string">"db"</span> : <span class="hljs-string">"http://admin:secret@localhost:5984/test"</span>
    },
    <span class="hljs-string">"prod"</span> : {
      <span class="hljs-string">"db"</span> : <span class="hljs-string">"http://admin:password@myhost.com/mydb"</span>
    }
  }
}
</code></pre>
<p>couchapp push<br>
couchapp push prod</p>
<h4 id="add-some-web-pages" class="heading-control">Add Some Web Pages<a class="heading-anchor" href="#add-some-web-pages" aria-hidden="true"></a></h4>
<p>Now we are going to add a index page for our CouchApp. So we can place the index.html under _attachments. CouchDB can directly serve our attachments as static files.</p>
<pre><code class="html"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>CouchApp<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello CouchApp!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 id="push-your-couchapp" class="heading-control">Push your CouchApp<a class="heading-anchor" href="#push-your-couchapp" aria-hidden="true"></a></h4>
<p>Now that we have created our basic application, it’s time to push it to our CouchDB server. Our CouchDB server is at the url <a href="http://127.0.0.1:5984" target="_blank" rel="noopener">http://127.0.0.1:5984</a> and we want to push our app in the database testdb:</p>
<pre><code class="bash">$ couchapp push testdb
</code></pre>
<p>Go on <a href="http://127.0.0.1:5984/testdb/_design/myapp/index.html" target="_blank" rel="noopener">http://127.0.0.1:5984/testdb/_design/myapp/index.html</a>, you will see.</p>
<h2 id="fauxton" class="heading-control"><a href="https://github.com/apache/couchdb-fauxton/" target="_blank" rel="noopener">Fauxton</a><a class="heading-anchor" href="#fauxton" aria-hidden="true"></a></h2>
<p>是Couchdb自带的WebUI: <a href="http://127.0.0.1:5984/_utils/index.html" target="_blank" rel="noopener">http://127.0.0.1:5984/_utils/index.html</a></p>
<p>似乎还没有启用，所以暂时没有语法高亮，但：<br>
app/addons/components/components/codeeditor.js</p>
<p><a href="https://github.com/apache/couchdb-nano" target="_blank" rel="noopener">CouchDB Nano Client NodeJS</a></p>
<h2 id="couchdb-as-graph" class="heading-control">CouchDB As Graph<a class="heading-anchor" href="#couchdb-as-graph" aria-hidden="true"></a></h2>
<p><a href="https://stackoverflow.com/questions/25949524/implications-of-modeling-a-graph-in-couchdb" target="_blank" rel="noopener">https://stackoverflow.com/questions/25949524/implications-of-modeling-a-graph-in-couchdb</a></p>
<p>I’ve been toying with modeling a graph structure (property graph with named relationships) in couchdb and would like to know what are the potential bottlenecks in performance that I will find.</p>
<p>I’m using the following principles:</p>
<pre><code>Keep documents small.
Try to embed as little as possible.
Record all relationships between documents as a new document (a link).
</code></pre>
<p>It seems that all these principles are in contradiction with couchdb’s philosophy. But bare with me.</p>
<p>With this principles, for example, tagging a person becomes three documents:</p>
<pre><code class="js">{ <span class="hljs-attr">_id</span>: <span class="hljs-string">'10'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'person'</span>, <span class="hljs-string">'name'</span>: <span class="hljs-string">'John Doe'</span> }
{ <span class="hljs-attr">_id</span>: <span class="hljs-string">'20'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'tag'</span>, <span class="hljs-string">'name'</span>: <span class="hljs-string">'Important'</span> }
{ <span class="hljs-attr">_id</span>: <span class="hljs-string">'30'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'link'</span>, <span class="hljs-attr">from</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">to</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'tag'</span> }
</code></pre>
<p>I have also created the following views in a _design document called links:</p>
<pre><code class="js">{
  <span class="hljs-attr">outgoing</span>: {
    <span class="hljs-attr">map</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">doc</span>) </span>{
      <span class="hljs-keyword">if</span> (doc.type == <span class="hljs-string">'link'</span>) {
        emit([doc.from, doc.name], {<span class="hljs-attr">_id</span>: doc.to});
      }
    }
  },
  <span class="hljs-attr">incoming</span>: {
    <span class="hljs-attr">map</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">doc</span>) </span>{
      <span class="hljs-keyword">if</span> (doc.type == <span class="hljs-string">'link'</span>) {
        emit([doc.to, doc.name], { <span class="hljs-attr">_id</span>: doc.from });
      }
    }
  }
}
</code></pre>
<p>I can get all the links incoming or outgoing from a document with these urls:</p>
<pre><code>http://host/db/_design/links/_view/incoming?startkey=[&quot;10&quot;]&amp;endkey=[&quot;10&quot;,{}]
http://host/db/_design/links/_view/outgoing?startkey=[&quot;10&quot;]&amp;endkey=[&quot;10&quot;,{}]
</code></pre>
<p>I can even get all the links by name with these urls:</p>
<pre><code>http://host/db/_design/links/_view/incoming?startkey=[&quot;10&quot;,&quot;tag&quot;]&amp;endkey=[&quot;10&quot;,&quot;tag&quot;,{}]
http://host/db/_design/links/_view/outgoing?startkey=[&quot;10&quot;,&quot;tag&quot;]&amp;endkey=[&quot;10&quot;,&quot;tag&quot;,{}]
</code></pre>
<p>And if I include the include_docs=true parameter I get the documents referenced by the link; either incoming or outgoing. So far so good. There is a graph structure and a way to query it, albeit on a node by node basis.</p>
<p>Good things about this approach:</p>
<pre><code>It is a general way of storing all relationships. Not necessarily tags, but every relationship.
You can change the tag name quickly, without changing every person tagged.
You can merge persons or tags and just update the link documents, which should be very simple.
Tagging when using replication does not change the documents being tagged or the tags themselves. Just add or delete a tiny link document.
It would be easy to keep a history of tags for each element.
</code></pre>
<p>Bad things, and where I need your help:</p>
<pre><code>Query for a list of people with their tags is not trivial. In general, querying for a list of documents and their relationships is a very expensive operation that requires many hits.
Updating the database and keeping it consistent could be a problem. Maybe this is something that will never go away when using couch.
Doing 'maintenance' on the database, like finding orphan links, could be expensive. Perhaps the database requires garbage collection?
Visualizing and manipulating this graph structure is neither intuitive nor simple, and applications developed on top of it are responsible for all the graph structure management (which is a bit scary!).
</code></pre>
<p>So back to my questions:</p>
<pre><code>What are the potencial bottlenecks to expect?
Will this approach scale to millions of records?
How to do traversing of this structure efficiently without having to do many server hits?
</code></pre>
<p><a href="http://grokbase.com/t/couchdb/user/09735ya0m7/map-reduce-graph-traversal-in-couchdb" target="_blank" rel="noopener">http://grokbase.com/t/couchdb/user/09735ya0m7/map-reduce-graph-traversal-in-couchdb</a></p>
<p><a href="http://grokbase.com/t/couchdb/user/115gv4yhr6/data-js-a-graph-manipulation-framework-on-top-of-couchdb" target="_blank" rel="noopener">http://grokbase.com/t/couchdb/user/115gv4yhr6/data-js-a-graph-manipulation-framework-on-top-of-couchdb</a></p>
<p>就是这个： <a href="https://github.com/substance/data" target="_blank" rel="noopener">https://github.com/substance/data</a><br>
<a href="https://github.com/substance/substance" target="_blank" rel="noopener">https://github.com/substance/substance</a></p>
<p><a href="http://probablyprogramming.com/2008/07/04/storing-hierarchical-data-in-couchdb" target="_blank" rel="noopener">http://probablyprogramming.com/2008/07/04/storing-hierarchical-data-in-couchdb</a><br>
<a href="https://stackoverflow.com/questions/6129561/retrieving-hierarchical-nested-data-from-couchdb" target="_blank" rel="noopener">https://stackoverflow.com/questions/6129561/retrieving-hierarchical-nested-data-from-couchdb</a></p>
<hr>
<p>CouchBase已经fork了很远以前，查询语言也不一样。</p>
<p>CouchDB的手机端用PouchDB. CouchBase也有CouchBaseLite（可以同步到CouchDB）.<br>
CouchDB在单机时候就要预先订好shard数量。</p>
<h2 id="couchdb-client" class="heading-control">CouchDB Client<a class="heading-anchor" href="#couchdb-client" aria-hidden="true"></a></h2>
<ul>
<li>PouchDB
<ul>
<li><a href="https://github.com/pouchdb/pouchdb/issues/2521" target="_blank" rel="noopener">https://github.com/pouchdb/pouchdb/issues/2521</a></li>
</ul>
</li>
</ul>
<pre><code class="js"><span class="hljs-keyword">var</span> PouchDB = <span class="hljs-built_in">require</span>(<span class="hljs-string">'pouchdb'</span>);
<span class="hljs-keyword">var</span> pouch = <span class="hljs-keyword">new</span> PouchDB(<span class="hljs-string">'testdb_changes'</span>);
<span class="hljs-keyword">var</span> remotePouch = <span class="hljs-keyword">new</span> PouchDB(<span class="hljs-string">'http://localhost:5984/testdb_changes'</span>);
<span class="hljs-keyword">var</span> <span class="hljs-built_in">Promise</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'bluebird'</span>);

pouch.bulkDocs([{<span class="hljs-attr">_id</span>: <span class="hljs-string">'1'</span>}, {<span class="hljs-attr">_id</span>: <span class="hljs-string">'2'</span>}]).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve, reject</span>) </span>{
    pouch.replicate.to(remotePouch).on(<span class="hljs-string">'complete'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">changes</span>) </span>{
      resolve(changes);
    }).on(<span class="hljs-string">'error'</span>, reject);
  });
}).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">change</span>) </span>{
  <span class="hljs-keyword">var</span> lastSeq = change.last_seq;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"lastSeq is: "</span> + lastSeq);
  <span class="hljs-keyword">return</span> pouch.put({<span class="hljs-attr">_id</span>: <span class="hljs-string">'3'</span>}).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> pouch.changes({<span class="hljs-attr">since</span>: lastSeq});
  }).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">changes</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'local changes are: '</span> + <span class="hljs-built_in">JSON</span>.stringify(changes));
    <span class="hljs-keyword">return</span> remotePouch.allDocs();
  }).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'remote pouch contains: '</span> + <span class="hljs-built_in">JSON</span>.stringify(res));
    <span class="hljs-keyword">return</span> pouch.allDocs();
  }).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'local pouch contains: '</span> + <span class="hljs-built_in">JSON</span>.stringify(res));
  });
}).catch(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
  <span class="hljs-built_in">console</span>.log(err);
});
</code></pre>
<ul>
<li><a href="https://github.com/pouchdb/pouchdb/issues/5713" target="_blank" rel="noopener">https://github.com/pouchdb/pouchdb/issues/5713</a>
<ul>
<li><code>change</code> 事件中有 <code>pending</code> 属性检测同步进度。</li>
</ul>
</li>
</ul>
<pre><code class="js"><span class="hljs-keyword">var</span> pendingMax = <span class="hljs-number">0</span>;
<span class="hljs-keyword">var</span> batch_size = <span class="hljs-number">1000</span>;    <span class="hljs-comment">// must match your replication options</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getProgress</span>(<span class="hljs-params">pending</span>) </span>{
  <span class="hljs-keyword">var</span> progress;
  pendingMax = pendingMax &lt; pending ? pending + batch_size : pendingMax;  <span class="hljs-comment">// first time capture</span>
  <span class="hljs-comment">//pendingMax = pendingMax &lt; pending ? pending : pendingMax;  // wouldn't use batch size in the calculation</span>
  <span class="hljs-keyword">if</span> (pendingMax &gt; <span class="hljs-number">0</span>) {
    progress = <span class="hljs-number">1</span> - pending/pendingMax;
    <span class="hljs-keyword">if</span> (pending === <span class="hljs-number">0</span>) {
      pendingMax = <span class="hljs-number">0</span>;    <span class="hljs-comment">// reset for live/next replication</span>
    }
  } <span class="hljs-keyword">else</span> {
    progress = <span class="hljs-number">1</span>;  <span class="hljs-comment">// 100%</span>
  }
  <span class="hljs-keyword">return</span> progress;
}

<span class="hljs-keyword">var</span> replication = db.replicate.from(remote, {
  <span class="hljs-attr">live</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">retry</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">batches_limit</span>: <span class="hljs-number">10</span>,
  <span class="hljs-attr">batch_size</span>: <span class="hljs-number">1000</span>      <span class="hljs-comment">// must match above batch_size</span>
}).on(<span class="hljs-string">'change'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">info</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Replication Progress'</span>, getProgress(info.pending));
})
</code></pre>
<h3 id="rxdb" class="heading-control">RxDB<a class="heading-anchor" href="#rxdb" aria-hidden="true"></a></h3>
<ul>
<li>RxDB: 内部使用PouchDB，
<ul>
<li>不爽的地方：一个Collection就是一个PouchDB数据库。</li>
<li>RXJS支持。</li>
</ul>
</li>
</ul>
<p>rxdb 不支持utf8(unicode)字段名。完全没有必要es5部分支持，es6完全支持unicode 标识符：<br>
<a href="https://mathiasbynens.be/notes/javascript-identifiers" target="_blank" rel="noopener">https://mathiasbynens.be/notes/javascript-identifiers</a><br>
<a href="https://mathiasbynens.be/notes/javascript-identifiers-es6" target="_blank" rel="noopener">https://mathiasbynens.be/notes/javascript-identifiers-es6</a><br>
<a href="https://stackoverflow.com/questions/1661197/what-characters-are-valid-for-javascript-variable-names" target="_blank" rel="noopener">https://stackoverflow.com/questions/1661197/what-characters-are-valid-for-javascript-variable-names</a></p>
<pre><code class="js"><span class="hljs-comment">//plugins/schema-check.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkFieldNameRegex</span>(<span class="hljs-params">fieldName</span>) </span>{
    <span class="hljs-keyword">if</span> (fieldName == <span class="hljs-string">''</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">if</span> ([<span class="hljs-string">'properties'</span>, <span class="hljs-string">'language'</span>].includes(fieldName))
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`fieldname is not allowed: <span class="hljs-subst">${fieldName}</span>`</span>);

<span class="hljs-comment">/* //comments for support unicode:
    const regexStr = '^[a-zA-Z][[a-zA-Z0-9_]*]?[a-zA-Z0-9]$';
    const regex = new RegExp(regexStr);
    if (!fieldName.match(regex)) {
        throw RxError.newRxError(
            'fieldnames do not match the regex', {
                regex: regexStr,
                fieldName
            }
        );
    }
*/</span>
};
</code></pre>
<p>目前PouchDB有个问题没有解决，直接会导致本地数据库越来越大，同时也难以LRU。<br>
<a href="https://github.com/pouchdb/pouchdb/issues/802" target="_blank" rel="noopener">https://github.com/pouchdb/pouchdb/issues/802</a></p>
]]></content>
      <categories>
        <category>Database</category>
        <category>NoSQL</category>
        <category>CouchDB</category>
      </categories>
      <tags>
        <tag>nosql</tag>
        <tag>couchdb</tag>
        <tag>database</tag>
      </tags>
  </entry>
  <entry>
    <title>Ionic Framework</title>
    <url>/article/ionic-framework/</url>
    <content><![CDATA[<h1 id="ionic-framework" class="heading-control">Ionic Framework<a class="heading-anchor" href="#ionic-framework" aria-hidden="true"></a></h1>
<p>Ionic 4 已经彻底解耦用户界面和框架,你可以在<code>angular</code>和<code>react</code>(甚至<code>vue</code>)之间选择.</p>
<pre><code>npm i -g ionic
</code></pre>
<p>已经是用angluar-cli(angular6配套的)。已经使用了angular的route.</p>
<p><a href="https://update.angular.io" target="_blank" rel="noopener">https://update.angular.io</a> 从老版本Angular升级到Angular6的指南。</p>
<p>现在可以大致介绍下使用方法。更完整的教程请自行阅读：</p>
<ul>
<li><a href="https://yanxiaodi.gitbooks.io/ionic2-guide/content/" target="_blank" rel="noopener">Ionic 2 With TypeScript 入门</a></li>
<li><a href="https://meiminjun.github.io/2016/08/01/ionic2%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E3%80%8A%E4%B8%80%E3%80%8B/" target="_blank" rel="noopener">ionic2学习笔记《一》</a></li>
</ul>
<p>如果与上述的教程有冲突，请留意文档时间，以最新的为准。</p>
<p>环境要求</p>
<ul>
<li>Node LTS版本(官方推荐)</li>
</ul>
<p>首先安装</p>
<pre><code>npm install -g ionic cordova
</code></pre>
<h2 id="chuang-jian-ying-yong" class="heading-control">创建应用<a class="heading-anchor" href="#chuang-jian-ying-yong" aria-hidden="true"></a></h2>
<p><strong>注意：如果是windows下，请勿在cygwin或msys2终端下运行 <code>ionic</code> 命令行工具。</strong></p>
<p>通过脚手架工具<code>ionic</code>创建您的H5应用。</p>
<pre><code>ionic start --type=angular MyApp conference
</code></pre>
<blockquote>
<p>conference 参数的意思是下载 <a href="https://github.com/ionic-team/ionic-conference-app" target="_blank" rel="noopener">tutorial</a> 模板来初始化项目，如果不指定这个参数的话，默认会使用 <a href="https://github.com/ionic-team/ionic-starter-tabs" target="_blank" rel="noopener">tabs</a> 模板。<br>
MyApp 可以替换成你的应用程序名称。<br>
–type 表示当前生成的是 angular 的应用。<br>
<code>ionic start --list</code> 可以查看所有starting项目模板。</p>
</blockquote>
<p>这个命令将下载项目模板，安装 npm modules，设置 Cordova 的相关信息。</p>
<p>如果安装npm 模块失败，你可以手动进入项目目录安装：</p>
<pre><code class="bash"><span class="hljs-built_in">cd</span> MyApp
npm install
</code></pre>
<p>你的项目代码在src目录下。</p>
<h2 id="zai-liu-lan-qi-yun-hang" class="heading-control">在浏览器运行<a class="heading-anchor" href="#zai-liu-lan-qi-yun-hang" aria-hidden="true"></a></h2>
<pre><code class="bash"><span class="hljs-built_in">cd</span> MyApp
ionic serve -l
</code></pre>
<blockquote>
<p><code>-l</code>(–lab) 参数将在浏览器中模拟多个手机设备。</p>
</blockquote>
<p>接下来 CLI 会编译项目，接着浏览器会打开一个地址为 <a href="http://localhost:8100" target="_blank" rel="noopener">http://localhost:8100</a> 的窗口，端口号根据当前PC的实际情况可能会有变化，如果8100被占用了会使用8101等。</p>
<h2 id="dai-ma-jie-gou" class="heading-control">代码结构<a class="heading-anchor" href="#dai-ma-jie-gou" aria-hidden="true"></a></h2>
<ul>
<li>./src/ 当我们运行<code>ionic serve</code>命令的时候，在<code>src/</code>目录下的typescript文件会被译成JavaScript</li>
<li>./src/index.html 是h5的主入口文件，设置脚本和CSS，运行整个App。</li>
<li>./src/app/app.module.ts 是angular2 应用的入口。</li>
<li>./src/app/app.html 是应用的模板文件</li>
</ul>
<h2 id="tian-jia-ye-mian" class="heading-control">添加页面<a class="heading-anchor" href="#tian-jia-ye-mian" aria-hidden="true"></a></h2>
<pre><code>ionic g page login
</code></pre>
<p>Note: 懒加载的Page为独立的Module。<br>
Ionic的懒加载Page很愚蠢，是编译时刻由ionic的app-scripts处理的(deep links config)，必须是page.moudle.ts与page.compnent.ts分开文件（否则app-scripts会报错）</p>
<p>另外tab控件产生的url丑陋： <a href="https://github.com/ionic-team/ionic/issues/9012" target="_blank" rel="noopener">https://github.com/ionic-team/ionic/issues/9012</a></p>
<p>如果不要<code>IonicPage</code>注解可以这：</p>
<pre><code class="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> deepLinkConfig: DeepLinkConfig = {
  links: [
    { component: OnlineCoursesPage, name: <span class="hljs-string">'OnlineCourses'</span>, segment: <span class="hljs-string">''</span> },
    { component: CartPage, name: <span class="hljs-string">'Cart'</span>, segment: <span class="hljs-string">'cart'</span> },
    { component: CheckoutPage, name: <span class="hljs-string">'Checkout'</span>, segment: <span class="hljs-string">'checkout'</span> },
    { component: ThankYouPage, name: <span class="hljs-string">'ThankYou'</span>, segment: <span class="hljs-string">'thanks'</span> },
    { component: AccountPage, name: <span class="hljs-string">'Account'</span>, segment: <span class="hljs-string">'account'</span> },
    { component: RegisterPage, name: <span class="hljs-string">'Register'</span>, segment: <span class="hljs-string">'register'</span> },
    { component: ForgotPasswordPage, name: <span class="hljs-string">'ForgotPassword'</span>, segment: <span class="hljs-string">'account'</span> },
    { component: ForgotUsernamePage, name: <span class="hljs-string">'ForgotUsername'</span>, segment: <span class="hljs-string">'account'</span> },
    { component: OnlineCoursesPage, name: <span class="hljs-string">'OnlineCourses'</span>, segment: <span class="hljs-string">':statename/:licensetypename/online-course-results'</span> },
    { component: CorrespondencePage, name: <span class="hljs-string">'Correspondence'</span>, segment: <span class="hljs-string">':statename/:licensetypename/correspondence'</span> },
    { component: LiveSeminarsPage, name: <span class="hljs-string">'LiveSeminars'</span>, segment: <span class="hljs-string">':statename/:licensetypename/search-seminars-list'</span> },
    { component: LiveWebinarsPage, name: <span class="hljs-string">'LiveWebinars'</span>, segment: <span class="hljs-string">':statename/:licensetypename/webinar'</span> },
    { component: LicensingInfoPage, name: <span class="hljs-string">'Licensing'</span>, segment: <span class="hljs-string">':statename/:licensetypename/licensing-info'</span> }
  ]
};

  imports: [
    IonicModule.forRoot(MyApp, { locationStrategy: <span class="hljs-string">'path'</span> }, deepLinkConfig)
  ],
</code></pre>
<p>目前ionic 在分支core上在重构(使用Web Component)，支持angular5 router: <a href="https://github.com/ionic-team/ionic/tree/core/packages/demos/ng-tab-routing" target="_blank" rel="noopener">https://github.com/ionic-team/ionic/tree/core/packages/demos/ng-tab-routing</a></p>
<ul>
<li><a href="https://github.com/apoterenko/ngx-dynamic-template" target="_blank" rel="noopener">https://github.com/apoterenko/ngx-dynamic-template</a></li>
<li><a href="https://github.com/gund/ng-dynamic-component" target="_blank" rel="noopener">https://github.com/gund/ng-dynamic-component</a></li>
</ul>
<p>或不用ionic-cli，改用 angluar-cli:</p>
<ul>
<li><a href="https://github.com/ngx-rocket/generator-ngx-rocket" target="_blank" rel="noopener">https://github.com/ngx-rocket/generator-ngx-rocket</a>
<ul>
<li>UI: 支持 Bootstrap 4, ionic, angular-material</li>
<li>mobile: 支持 cordova</li>
<li>但是lighthouse性能评分极差</li>
<li>不过ngx可以作为自己的cli 命令行app产生器参考。</li>
</ul>
</li>
<li><a href="https://github.com/Robinyo/ionic-angular-schematics" target="_blank" rel="noopener">https://github.com/Robinyo/ionic-angular-schematics</a>
<ul>
<li>绑定在ionic，算是ionic的angular-cli替代。</li>
<li>有 Dynamic Theme Support 代码可以参考。</li>
</ul>
</li>
</ul>
<p>ionic 4将使用Web Component(通过stencil编译)的方式，来改变目前绑定在Angular框架的局面，这样ionic的组件就和框架无关了，你可以用在任何框架上面使用， vue, react 都不是问题.</p>
<h2 id="announcing-pwa-support-in-ionic2" class="heading-control"><a href="http://blog.ionic.io/announcing-pwa-support-in-ionic-2/" target="_blank" rel="noopener">Announcing PWA support in Ionic2</a><a class="heading-anchor" href="#announcing-pwa-support-in-ionic2" aria-hidden="true"></a></h2>
<p>We also provide the service worker registration code in your index.html file.</p>
<pre><code class="js"><span class="hljs-keyword">if</span> (<span class="hljs-string">'serviceWorker'</span> <span class="hljs-keyword">in</span> navigator) {
      navigator.serviceWorker.register(<span class="hljs-string">'service-worker.js'</span>)
        .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'service worker installed'</span>))
        .catch(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Error'</span>, err));
}
</code></pre>
<p>To enable the service worker, you can simply uncomment that registration code, and you’ll be ready to go! You’ll find the service-worker.js file in the www folder of your Ionic project.</p>
<p>For examples of service workers, check out the <a href="https://serviceworke.rs/" target="_blank" rel="noopener">ServiceWorker Cookbook</a> by Mozilla and the Google Chrome team’s <a href="https://github.com/GoogleChrome/samples/tree/gh-pages/service-worker" target="_blank" rel="noopener">repo of example service workers</a>.</p>
<p>We’re very excited to start supporting PWA’s out of the box with Ionic and plan on steadily improving this support in the future. We are currently considering support for server-side rendering to get a blazing-fast first render and convenient hosting with the Ionic Cloud. Our service worker support will also be evolving in the near future to allow for automatic configuration of service workers. This will give your PWA offline support right out of the box, without you having to write any code. We cannot wait to see the awesome PWAs that you build! Stay tuned to our blog and our docs for updates!</p>
<h2 id="best-practise" class="heading-control">Best Practise<a class="heading-anchor" href="#best-practise" aria-hidden="true"></a></h2>
<p>src/app 存放本应用下的公用部分，以及app模块本身。</p>
<h3 id="main-app-module" class="heading-control">Main App Module<a class="heading-anchor" href="#main-app-module" aria-hidden="true"></a></h3>
<p>该模块为主页面的入口</p>
<p>src/app/app.module.ts<br>
src/app/app.comonent.ts<br>
src/app/app.scss<br>
src/app/app.html</p>
<h3 id="shared-module" class="heading-control">Shared Module<a class="heading-anchor" href="#shared-module" aria-hidden="true"></a></h3>
<p>在本应用的其它Module中需要用到的模块统一放在此处。</p>
<p>src/shared/app.imports.ts   本应用内所有要导入的组件，指令，模块，pipe</p>
<pre><code class="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> MODULES = [
  SwingModule,
  BrowserModule,
  HttpClientModule,
];

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> PROVIDERS = [
  AlertService,
  ToastService,
  AppState,
  CameraProvider,
  NativeGoogleMapsProvider,

  <span class="hljs-comment">// Ionic native specific providers</span>
  BarcodeScanner,
  Camera,
  Diagnostic,
  Geolocation,
  CardIO,
  StatusBar,
  SplashScreen,
  GoogleMaps,
];

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> DIRECTIVES = [
  SlidingDrawer,
  Autosize,
];
</code></pre>
<p>src/shared/shared.module.ts</p>
<pre><code class="ts"><span class="hljs-keyword">import</span> { PipesModule } <span class="hljs-keyword">from</span> <span class="hljs-string">'../pipes/pipes.module'</span>;
<span class="hljs-keyword">import</span> { ComponentsModule } <span class="hljs-keyword">from</span> <span class="hljs-string">'../components/components.module'</span>;
<span class="hljs-keyword">import</span> { DIRECTIVES } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.imports'</span>;
<span class="hljs-keyword">import</span> { NgModule } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;
<span class="hljs-keyword">import</span> { IonicModule } <span class="hljs-keyword">from</span> <span class="hljs-string">'ionic-angular'</span>;

<span class="hljs-meta">@NgModule</span>({
  declarations: [
    DIRECTIVES,
  ],
  imports: [
    IonicModule,
    PipesModule,
    ComponentsModule,
  ],
  exports: [
    ComponentsModule,
    PipesModule,
  ]
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> SharedModule { }
</code></pre>
<p>shared/ 这是第三方的库</p>
<h3 id="microapp" class="heading-control">MicroApp<a class="heading-anchor" href="#microapp" aria-hidden="true"></a></h3>
<h2 id="capacitor" class="heading-control">Capacitor<a class="heading-anchor" href="#capacitor" aria-hidden="true"></a></h2>
<p>如果想试用 <code>capacitor</code> 代替 Cordavo：</p>
<pre><code>npm install --save @capacitor/core @capacitor/cli
</code></pre>
<p>Next init Capacitor by running the following command with your ap information</p>
<pre><code>npx cap init ionic-capacitor-app com.techiediaries.myapp
</code></pre>
<p>Make sure to use your app name for the first parameter and your app id for the second parameter ( <code>npx cap init [appName] [appId]</code> ).</p>
<p>This command will add a capacitor.config.json inside your project folder with the following content</p>
<pre><code class="js">{
  <span class="hljs-string">"appId"</span>: <span class="hljs-string">"com.techiediaries.myapp"</span>,
  <span class="hljs-string">"appName"</span>: <span class="hljs-string">"ionic-capacitor-app"</span>,
  <span class="hljs-string">"bundledWebRuntime"</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">"webDir"</span>: <span class="hljs-string">"www"</span>
}
</code></pre>
<p>Now you need to generate the www folder with the Ionic app built files by running the build command:</p>
<pre><code>npm run build
</code></pre>
<h3 id="adding-the-android-platform" class="heading-control">Adding the Android Platform<a class="heading-anchor" href="#adding-the-android-platform" aria-hidden="true"></a></h3>
<p>before you can run your app you need to add a platform either android, ios or web so let’s add the Android platform</p>
<pre><code class="bash">npx <span class="hljs-built_in">cap</span> add android
npx <span class="hljs-built_in">cap</span> sync
</code></pre>
<p>You can also use the copy command instead of sync</p>
<pre><code>npx cap copy
</code></pre>
<p>The difference is that copy will only copy the web assets but sync will also update native dependencies so use it if you have added any native dependencies.</p>
<p>Now you can open your Android project using the Android Studio using:</p>
<pre><code>npx cap open
</code></pre>
<p>This will prompt you to choose a platform to open android, ios or web select android for Android.</p>
<p>If that doesn’t open Android Studio you can simply open Android Studio manually and then File-&gt;Open… command then navigate to your project and open the android folder.</p>
<p>You can now use Android Studio to launch your app using an emulator or a real device.</p>
<p>Next we’ll see how to use Capacitor plugins to access native device features such as the Camera and Geolocation.</p>
<h2 id="wen-ti" class="heading-control">问题<a class="heading-anchor" href="#wen-ti" aria-hidden="true"></a></h2>
<p><a href="https://leifwells.github.io/2017/08/27/testing-in-ionic-configure-existing-projects-for-testing/" target="_blank" rel="noopener">https://leifwells.github.io/2017/08/27/testing-in-ionic-configure-existing-projects-for-testing/</a><br>
<a href="https://robferguson.org/blog/2017/11/28/testing-your-ionic-3-app/" target="_blank" rel="noopener">https://robferguson.org/blog/2017/11/28/testing-your-ionic-3-app/</a></p>
<h3 id="assertshtmlindexhtml-lian-jie-bu-cheng-gong-can-not-unsuccessful-connectwebview" class="heading-control">/asserts/html/index.html 连接不成功(can not unsuccessful connect)，(webview)<a class="heading-anchor" href="#assertshtmlindexhtml-lian-jie-bu-cheng-gong-can-not-unsuccessful-connectwebview" aria-hidden="true"></a></h3>
<p>里面的脚本太多加载超时导致。在java中加入:</p>
<pre><code class="java"><span class="hljs-keyword">super</span>.setIntegerProperty(<span class="hljs-string">"loadUrlTimeoutValue"</span>, <span class="hljs-number">700000</span>);
</code></pre>
<p>或者在项目根目录 <code>config.xml</code>的 <code>andorid platform</code> 中加入:</p>
<pre><code class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">preference</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"loadUrlTimeoutValue"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"700000"</span> /&gt;</span>
</code></pre>
<h3 id="ionicangular-de-mei-yi-ge-ban-ben-zong-shi-he-dui-ying-de-angular-ban-ben-bang-ding-de" class="heading-control">ionic-angular 的每一个版本总是和对应的angular版本绑定的<a class="heading-anchor" href="#ionicangular-de-mei-yi-ge-ban-ben-zong-shi-he-dui-ying-de-angular-ban-ben-bang-ding-de" aria-hidden="true"></a></h3>
<p>不要轻易变动，除非你知道对应的angular版本。</p>
<pre><code>&quot;ionic-angular&quot;: &quot;^2.0.0-rc.3-201612080433&quot;,
&quot;@angular/core&quot;: &quot;2.2.1&quot;,
</code></pre>
<p>否则报错：</p>
<pre><code>__WEBPACK_IMPORTED_MODULE_0__angular_core__.Version is not a constructor
</code></pre>
<h3 id="can-not-import-constants" class="heading-control">Can not import constants!<a class="heading-anchor" href="#can-not-import-constants" aria-hidden="true"></a></h3>
<p><a href="https://github.com/driftyco/ionic-app-scripts/issues/439" target="_blank" rel="noopener">https://github.com/driftyco/ionic-app-scripts/issues/439</a></p>
<p>Ask:<br>
In my case i’ve got a regular ionic projekt.<br>
i npm install a second project (which is typescript only - no js bundles, no transpiled JS) in my ionic project.<br>
the second project contains interfaces, enums, constants… which i share between two projects (node server and ionic app).<br>
when i import interfaces -&gt; no problem.<br>
when i import constants --&gt; Cannot read property ‘content’ of undefined.</p>
<p>Answer:<br>
Here’s what you would need to do:</p>
<p>Create the library of Typescript for Ionic<br>
Transpile the Typescript to Javascript<br>
Use NPM (or NPM link) to get your library in node_modules<br>
Code as normal</p>
<p>We can’t support Typescript from a third party library at this time. It’s gotta be converted to Javascript because that is how libraries are distributed 99% of the time.</p>
<h3 id="click-delays-dian-ji-yan-chi-wen-ti" class="heading-control">Click Delays 点击延迟问题<a class="heading-anchor" href="#click-delays-dian-ji-yan-chi-wen-ti" aria-hidden="true"></a></h3>
<p>熟悉前端的应该都知道，某些元素在click事件会有300ms的延迟，在ionic里也是只有button和a可以立即响应的。如果要给其他的元素比如div增加click事件，给该元素加上<code>tappable</code>属性即可解决。</p>
<h3 id="http-qing-qiu-kua-yu-wen-ti" class="heading-control">http请求跨域问题<a class="heading-anchor" href="#http-qing-qiu-kua-yu-wen-ti" aria-hidden="true"></a></h3>
<p>在ionic2里使用angular2的HTTP请求api时，如果在浏览器里运行，经常会遇到跨域问题，比如：</p>
<pre><code>XMLHttpRequest cannot load http://www.xxx.com/clt/jsp/v3/channelContList.jsp?n=25950&amp;WD-UUID=864819028898243&amp;pageidx=1. No 'Access-Control-Allow-Origin' header is present on the requested resource. Origin 'http://localhost:8101' is therefore not allowed access.
</code></pre>
<p>这是因为chrome不允许跨域访问。解决方法很简单，给chrome装一个ripple扩展，然后点击ripple，选择启用，就可以跨域访问了。</p>
<p>如果是自己同时开发api和app，很有可能api也是部署在本机上，比如api地址是http://localhost/api，<code>ionic serve</code>跑起来后是http://localhost:8100，这样在调用的时候又会遇到Internet Server Error的问题，比如：</p>
<pre><code>Error code is:xhr_proxy?tinyhippos_apikey=ABC&amp;tinyhippos_rurl=http%3A//localhost%3A30673/ap‌​i/user/Get%3Fjson rippleapi.herokuapp.com Status Code:500 Internal Server Error I'am getting data from my localhost post adress:localhost:30673/api/user/Get'; It is working well in browser . And getting data from localhost:30673/api/user/Get. But in ripple it tries to get data from There: xhr_proxy?tinyhippos_apikey=ABC&amp;tinyhippos_rurl=http%3A//localhost%3A30673/api/u‌​ser/Get%3Fjson rippleapi.herokuapp.com
</code></pre>
<p>解决方法也很简单，ripple设置右上角有一个Cross Domain Proxy，有三个选择，Disabled、Local和Remote，通过字面意思就可以看出来分别对应禁用、本地和远程访问，如果是访问本机的api的话，一般设置为Disabled就可以了。如果访问远程主机的api，一般要设置为Remote或Disabled。</p>
<h3 id="yin-yong-di-san-fang-js-ku-de-wen-ti" class="heading-control">引用第三方js库的问题<a class="heading-anchor" href="#yin-yong-di-san-fang-js-ku-de-wen-ti" aria-hidden="true"></a></h3>
<p>开发过程中不可避免的要用到第三方js库，如果直接在TypeScript里写的话，编译器是认不出来的，会报错，编译也通不过。外部的类必须要import进来才可以用。TypeScript需要一个声明文件 d.ts<br>
来知道第三方库的接口。可参考 <a href="https://zhongsp.gitbooks.io/typescript-handbook/content/doc/handbook/Writing%20Definition%20Files.html" target="_blank" rel="noopener">https://zhongsp.gitbooks.io/typescript-handbook/content/doc/handbook/Writing Definition Files.html</a></p>
<p>如果用流行的库的话，不用我们自己写d.ts，有个开源的项目已经做好了：<a href="https://github.com/DefinitelyTyped/DefinitelyTyped" target="_blank" rel="noopener">https://github.com/DefinitelyTyped/DefinitelyTyped</a><br>
自己写的话很麻烦，特别是我用了一个项目平台的库，函数也不少，自己写的话也费时间，后来想到一个办法，</p>
<p>TypeScript的编译器支持自动生成d.ts，可以用命令<code>tsc --declaration my.ts</code>来生成，这个命令是给ts文件生成声明的，但TypeScript原生支持js，可以把第三方的js改后缀名为ts，tsc也可以生成。这里我又遇到一个问题，我的库里又调用了<br>
Cordova的一些函数，编译的话tsc找不到，解决办法是复制一份js，将所有认不出的东西都注释掉，再生成就可以了。反正这个命令只是生成一个声明文件，具体的js只要引入进来就可以用。用这个命令很快就可以生成一份声明了，然后在用到的地方用</p>
<pre><code>/// &lt;reference path=&quot;../sdk.d.ts&quot;/&gt;
</code></pre>
<p>这样的方式引用。注意一定要写在文件第一行。</p>
<h3 id="kai-fa-mo-shi-xuan-ze" class="heading-control">开发模式选择<a class="heading-anchor" href="#kai-fa-mo-shi-xuan-ze" aria-hidden="true"></a></h3>
<p>这个问题只是我做的项目的特殊情况，可能大部分人遇不到。我们的平台封装了Cordova的http请求，调用api必须用指定的方法才可以。但在chrome里调试的时候是加载不到Cordova的，于是我想了一个办法，增加一个全局的isDebug变量，封装一个全局的http方法，在debug模式时调用angular2的HTTP来请求，正式运行时才用Cordova的。其他的service都要调用这个方法，就无需关注是什么模式了，如果真机运行的话就改一下isDebug的值就可以了。</p>
<p>放一段代码：</p>
<pre><code class="js"><span class="hljs-comment">/// &lt;reference path="../sdk.d.ts"/&gt;</span>
<span class="hljs-keyword">import</span> {Injectable, Component} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;
<span class="hljs-keyword">import</span> {HTTP_PROVIDERS, Http, Response} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/http'</span>;
<span class="hljs-keyword">import</span> {Headers, RequestOptions} <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/http'</span>;
<span class="hljs-keyword">import</span> {AppGlobal} <span class="hljs-keyword">from</span> <span class="hljs-string">'../app-global'</span>;  <span class="hljs-number">6</span>

<span class="hljs-comment">/**
  * HttpRequestService
  */</span>
@Injectable()
@Component({
 <span class="hljs-attr">providers</span>: [HTTP_PROVIDERS,Http]
})
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HttpRequestService</span> </span>{
 <span class="hljs-keyword">constructor</span>(private http: Http) {}
 <span class="hljs-comment">/**
   * get方法 获取json对象
   *
   * @template T
   * @param {string} server
   * @param {string} url
   * @returns {Promise&lt;T&gt;}
   */</span>
 get4Json&lt;T&gt;(server: string, <span class="hljs-attr">url</span>: string): <span class="hljs-built_in">Promise</span>&lt;T&gt; {
   <span class="hljs-keyword">if</span> (AppGlobal.getInstance().isDebug) {
     <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.http.get(server + url).toPromise()
     .then(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.json());
   }
   <span class="hljs-keyword">else</span> {
     <span class="hljs-keyword">let</span> promise: <span class="hljs-built_in">Promise</span>&lt;T&gt; = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>&lt;T&gt;<span class="hljs-function">(<span class="hljs-params">(resolve, reject</span>) =&gt;</span> {
       <span class="hljs-comment">//由于SDK必须要求传入一个参数数组，因此必须传递一个空数组作为参数</span>
       <span class="hljs-keyword">let</span> paramJson = [];
       SDKRequest.get4Json(server, url, paramJson, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resp</span>) </span>{
         resolve(resp);
       }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
         reject(error);
       });
     });
     <span class="hljs-keyword">return</span> promise;
   }
 }
}

</code></pre>
<p>angular2的http是用的Promise，但平台提供的方法用的callback，于是需要在这里将回调函数的方式改为Promise的方式，不管是不是debug模式都返回一个Promise，这样上层调用的时候就方便了。我是看的这里：</p>
<p><a href="https://basarat.gitbooks.io/typescript/content/docs/promise.html" target="_blank" rel="noopener">https://basarat.gitbooks.io/typescript/content/docs/promise.html</a></p>
<p>在angular2的官方文档中，是推荐用Observable模式的，但我还没有搞明白怎么将callback转为Observable，目前也没有时间仔细研究这块，所以还是继续用Promise好了。</p>
<h3 id="dan-li-mo-shi" class="heading-control">单例模式<a class="heading-anchor" href="#dan-li-mo-shi" aria-hidden="true"></a></h3>
<p>单例是经常用到的，我参考一个老外的代码用了一个单例，用来保存一些全局变量：</p>
<pre><code class="js"><span class="hljs-keyword">import</span> {UserInfo} <span class="hljs-keyword">from</span> <span class="hljs-string">'./model/user'</span>;

<span class="hljs-comment">/** * AppGlobal 全局定义 单例模式 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppGlobal</span> </span>{
  private <span class="hljs-keyword">static</span> instance: AppGlobal = <span class="hljs-keyword">new</span> AppGlobal();
  <span class="hljs-comment">/**是否是调试状态 */</span>
  isDebug: boolean = <span class="hljs-literal">true</span>;
  server: string = <span class="hljs-keyword">this</span>.isDebug ? <span class="hljs-string">"http://localhost"</span> : <span class="hljs-string">"http://www.xxx.com"</span>;
  apiUrl: string = <span class="hljs-string">"/MobileApi/api"</span>;
  <span class="hljs-comment">/**当前用户信息 */</span>
  currentUserInfo: UserInfo = <span class="hljs-keyword">new</span> UserInfo();
  <span class="hljs-comment">/**分页页数 */</span>
  pageSize: number = <span class="hljs-number">10</span>;

  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">if</span> (AppGlobal.instance) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"错误: 请使用AppGlobal.getInstance() 代替使用new."</span>);
    }
    AppGlobal.instance = <span class="hljs-keyword">this</span>;
  }
  <span class="hljs-comment">/**
    * 获取当前实例 *
    * @static * @returns {AppGlobal}
    */</span>
  public <span class="hljs-keyword">static</span> getInstance(): AppGlobal { <span class="hljs-keyword">return</span> AppGlobal.instance; }
}
</code></pre>
<h3 id="lazy-loading" class="heading-control">Lazy loading<a class="heading-anchor" href="#lazy-loading" aria-hidden="true"></a></h3>
<p><a href="https://github.com/didinj/ionic3-angular4-sample-app" target="_blank" rel="noopener">https://github.com/didinj/ionic3-angular4-sample-app</a></p>
<p>每一个页面都是一个 Module，通过pageModule来实现懒加载。<br>
Angluar4本身的router loadChildren也是这样做的。</p>
<h3 id="cheng-xu-de-zi-dong-geng-xin" class="heading-control">程序的自动更新<a class="heading-anchor" href="#cheng-xu-de-zi-dong-geng-xin" aria-hidden="true"></a></h3>
<p>既然是html自然可以自动更新</p>
<p>支持Android和iOS:</p>
<ul>
<li><a href="https://github.com/nordnet/cordova-hot-code-push" target="_blank" rel="noopener">https://github.com/nordnet/cordova-hot-code-push</a>
<ul>
<li><a href="https://github.com/nordnet/cordova-hot-code-push/issues/131" target="_blank" rel="noopener">https://github.com/nordnet/cordova-hot-code-push/issues/131</a> (比较文档)</li>
</ul>
</li>
<li><a href="https://github.com/phonegap/phonegap-plugin-contentsync" target="_blank" rel="noopener">https://github.com/phonegap/phonegap-plugin-contentsync</a></li>
<li><a href="https://github.com/markmarijnissen/cordova-app-loader" target="_blank" rel="noopener">https://github.com/markmarijnissen/cordova-app-loader</a> (纯js实现)</li>
</ul>
<p>只支持 Android 是apk更新:</p>
<ul>
<li><a href="https://ionicframework.com/docs/native/app-update/" target="_blank" rel="noopener">https://ionicframework.com/docs/native/app-update/</a></li>
</ul>
<p><a href="https://codepureandsimple.com/implementing-cordova-hot-code-push-in-your-ionic-app-247cda24d6d4" target="_blank" rel="noopener">https://codepureandsimple.com/implementing-cordova-hot-code-push-in-your-ionic-app-247cda24d6d4</a></p>
<p>准备用的是: cordova-hot-code-push</p>
<pre><code class="bash">ionic start chcp-example blank
<span class="hljs-built_in">cd</span> .\chcp-example
npm install -g lite-server
ionic cordova platform add android
<span class="hljs-comment"># When prompted to install the @ionic/cli-plugin-cordova, select “Yes”.</span>
ionic cordova plugin add cordova-hot-code-push-plugin
npm install -g cordova-hot-code-push-cli
</code></pre>
<pre><code class="bash">~/dev/chcp-example&gt;cordova-hcp init
Running init
Please provide: Enter project name (required):  chcp-example
Please provide: Amazon S3 Bucket name (required <span class="hljs-keyword">for</span> cordova-hcp deploy):
Please provide: Path <span class="hljs-keyword">in</span> S3 bucket (optional <span class="hljs-keyword">for</span> cordova-hcp deploy):
Please provide: Amazon S3 region (required <span class="hljs-keyword">for</span> cordova-hcp deploy):  (us-east-1)
Please provide: IOS app identifier:
Please provide: Android app identifier:
Please provide: Update method (required):  (resume) start
Please provide: Enter full URL to directory <span class="hljs-built_in">where</span> cordova-hcp build result will be uploaded:  http://169.254.80.80:3000/updates
Project initialized and cordova-hcp.json file created.
If you wish to exclude files from being published, specify them <span class="hljs-keyword">in</span> .chcpignore
Before you can push updates you need to run <span class="hljs-string">"cordova-hcp login"</span> <span class="hljs-keyword">in</span> project directory
</code></pre>
<p>cordova-hcp.json file in the root of your project :</p>
<pre><code class="js">{
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"chcp-example"</span>,
    <span class="hljs-string">"ios_identifier"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-string">"android_identifier"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-string">"update"</span>: <span class="hljs-string">"start"</span>,
    <span class="hljs-string">"content_url"</span>: <span class="hljs-string">"http://169.254.80.80:3000/updates"</span>
}
</code></pre>
<p>Edit your <code>config.xml</code> file to turn off automatic download and automatic install. We will do this via application code:</p>
<pre><code class="xml">&lt;chcp&gt;
    &lt;config-file url=”http://169.254.80.80:3000/updates/chcp.json"/
    &lt;auto-download enabled=”false” /&gt;
    &lt;auto-install enabled=”false” /&gt;
&lt;/chcp&gt;
</code></pre>
<p>go to your <code>/chcp-example/src/pages/home/home.html</code> file and set its contents to the following:</p>
<pre><code class="html"><span class="hljs-tag">&lt;<span class="hljs-name">ion-header</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ion-navbar</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ion-title</span>&gt;</span>Cordova Hot Code Push Test<span class="hljs-tag">&lt;/<span class="hljs-name">ion-title</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ion-navbar</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ion-header</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">ion-content</span> <span class="hljs-attr">padding</span>&gt;</span>
    <span class="hljs-comment">{{ foo }}</span> <span class="hljs-comment">{{ bar }}</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ion-content</span>&gt;</span>
</code></pre>
<p><code>/chcp-example/src/pages/home/home.ts</code></p>
<pre><code class="ts"><span class="hljs-keyword">import</span> { Component } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;
<span class="hljs-keyword">import</span> { NavController } <span class="hljs-keyword">from</span> <span class="hljs-string">'ionic-angular'</span>;
<span class="hljs-meta">@Component</span>({
    selector: <span class="hljs-string">'page-home'</span>,
    templateUrl: <span class="hljs-string">'home.html'</span>
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> HomePage {
    foo: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;
    bar: <span class="hljs-built_in">number</span> = <span class="hljs-number">2</span>;
    <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">public</span> navCtrl: NavController</span>) {}
}
</code></pre>
<p>/chcp-example/src/app/app.component.ts:</p>
<pre><code class="ts"><span class="hljs-keyword">import</span> { Component } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;
<span class="hljs-keyword">import</span> { Platform, ModalController, AlertController } <span class="hljs-keyword">from</span> <span class="hljs-string">'ionic-angular'</span>;
<span class="hljs-keyword">import</span> { StatusBar } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ionic-native/status-bar'</span>;
<span class="hljs-keyword">import</span> { SplashScreen } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ionic-native/splash-screen'</span>;
<span class="hljs-keyword">import</span> { HomePage } <span class="hljs-keyword">from</span> <span class="hljs-string">'../pages/home/home'</span>;
<span class="hljs-keyword">declare</span> <span class="hljs-keyword">var</span> chcp: <span class="hljs-built_in">any</span>;
<span class="hljs-meta">@Component</span>({
    templateUrl: <span class="hljs-string">'app.html'</span>
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> MyApp {
  rootPage:<span class="hljs-built_in">any</span> = HomePage;
  <span class="hljs-keyword">constructor</span>(<span class="hljs-params">platform: Platform,
  statusBar: StatusBar,
  splashScreen: SplashScreen,
  <span class="hljs-keyword">private</span> modalCtrl: ModalController,
  <span class="hljs-keyword">private</span> alertCtrl: AlertController</span>) {
  platform.ready().then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    statusBar.styleDefault();
    splashScreen.hide();
    <span class="hljs-built_in">window</span>[<span class="hljs-string">"thisRef"</span>] = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">this</span>.fetchUpdate();
  });
}
fetchUpdate() {
  <span class="hljs-keyword">const</span> options = {
    <span class="hljs-string">'config-file'</span>: <span class="hljs-string">'http://169.254.80.80:3000/updates/chcp.json'</span>
  };
  chcp.fetchUpdate(<span class="hljs-keyword">this</span>.updateCallback, options);
}
updateCallback(error, data) {
  <span class="hljs-keyword">if</span> (error) {
    <span class="hljs-built_in">console</span>.error(error);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Update is loaded...'</span>);
    <span class="hljs-keyword">let</span> confirm = <span class="hljs-built_in">window</span>[<span class="hljs-string">"thisRef"</span>].alertCtrl.create({
      title: <span class="hljs-string">'Application Update'</span>,
      message: <span class="hljs-string">'Update available, do you want to apply it?'</span>,
      buttons: [
       {text: <span class="hljs-string">'No'</span>},
       {text: <span class="hljs-string">'Yes'</span>,
         handler: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
           chcp.installUpdate(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
             <span class="hljs-keyword">if</span> (error) {
               <span class="hljs-built_in">console</span>.error(error);
               <span class="hljs-built_in">window</span>[<span class="hljs-string">"thisRef"</span>].alertCtrl.create({
                 title: <span class="hljs-string">'Update Download'</span>,
                 subTitle: <span class="hljs-string">`Error <span class="hljs-subst">${error.code}</span>`</span>,
                 buttons: [<span class="hljs-string">'OK'</span>]
               }).present();
             } <span class="hljs-keyword">else</span> {
               <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Update installed...'</span>);
             }
           });
         }
       }
      ]
    });
    confirm.present();
   }
 }
}
</code></pre>
<h4 id="build-and-run-in-the-android-emulator" class="heading-control">Build and Run in the Android Emulator<a class="heading-anchor" href="#build-and-run-in-the-android-emulator" aria-hidden="true"></a></h4>
<p>From Android Studio, click the Tools menu, point to Android, click Android Virtual Device (AVD) Manager, and then start your virtual device. Open another command line and build the application, run the Hot Code Plugin build, and then run the application in the Android emulator:</p>
<pre><code class="bash">npm run build --prod
cordova-hcp build
cordova <span class="hljs-built_in">emulate</span> android
</code></pre>
<p>Keep your application running in the emulator, but let’s change the <code>/chcp-example/src/pages/home/home.ts</code> variables to the following to increase our chances of getting seed money from some investors:</p>
<pre><code class="ts">foo: <span class="hljs-built_in">number</span> = <span class="hljs-number">4</span>;
bar: <span class="hljs-built_in">number</span> = <span class="hljs-number">2</span>;
</code></pre>
<p>After you update your variable values, edit the version number in your <code>package.json</code> file to increment the number to “version”: “0.0.2” and then rebuild the project and use the Hot Code Plugin CLI to rebuild our updates. If you do not update the version number, the code will not get updated, you will not get any money from any VCs, and all of your friends and LinkedIn contacts will laugh at you.</p>
<p>The updated code will be created in the www folder of your application.</p>
<pre><code class="bash">npm run build --prod
cordova-hcp build
mkdir ../code-server
cp -r www ../code-server/updates
<span class="hljs-built_in">cd</span> ../code-server
http-server
</code></pre>
<h3 id="problems" class="heading-control">Problems<a class="heading-anchor" href="#problems" aria-hidden="true"></a></h3>
<ul>
<li><a href="https://forum.ionicframework.com/t/about-to-give-up-with-ionic-3-simple-native-like-chat-page-not-possible/87548/29" target="_blank" rel="noopener">https://forum.ionicframework.com/t/about-to-give-up-with-ionic-3-simple-native-like-chat-page-not-possible/87548/29</a>
<ul>
<li><a href="https://github.com/driftyco/ionic/issues/7149#issuecomment-296457305" target="_blank" rel="noopener">https://github.com/driftyco/ionic/issues/7149#issuecomment-296457305</a></li>
</ul>
</li>
</ul>
<p><a href="https://github.com/alexmady/KeyboardTest" target="_blank" rel="noopener">https://github.com/alexmady/KeyboardTest</a><br>
<a href="https://github.com/HsuanXyz/ionic3-chat" target="_blank" rel="noopener">https://github.com/HsuanXyz/ionic3-chat</a></p>
<p><a href="https://github.com/mojofit/imojo" target="_blank" rel="noopener">https://github.com/mojofit/imojo</a><br>
<a href="https://github.com/mojofit/node-mojo" target="_blank" rel="noopener">https://github.com/mojofit/node-mojo</a></p>
<p><a href="https://github.com/jdnichollsc/Ionic-ElastiChat-with-Images" target="_blank" rel="noopener">https://github.com/jdnichollsc/Ionic-ElastiChat-with-Images</a><br>
<a href="https://github.com/terikon/photo-library-demo-ionic2" target="_blank" rel="noopener">https://github.com/terikon/photo-library-demo-ionic2</a><br>
<a href="https://github.com/driftyco/ionic-starter-super" target="_blank" rel="noopener">https://github.com/driftyco/ionic-starter-super</a></p>
]]></content>
      <categories>
        <category>JavaScript</category>
        <category>Framework</category>
        <category>App</category>
      </categories>
      <tags>
        <tag>javascript</tag>
        <tag>framework</tag>
        <tag>nodejs</tag>
        <tag>app</tag>
        <tag>mobile</tag>
        <tag>creation</tag>
      </tags>
  </entry>
  <entry>
    <title>从分享经济到共享经济系列(一)——分享经济的前世今生</title>
    <url>/article/sharing-economy/</url>
    <content><![CDATA[<h1 id="fen-xiang-jing-ji-de-qian-shi-jin-sheng" class="heading-control">分享经济的前世今生<a class="heading-anchor" href="#fen-xiang-jing-ji-de-qian-shi-jin-sheng" aria-hidden="true"></a></h1>
<p>“分享”这一概念是很容易理解的，因为我们打小从幼儿园的时候，就被教育说要主动分享，乐于助人。 “分享”这更是慈善事业中的主旋律。 用一言而概之，就是将自己的(既有资源)，与他人分享。</p>
<p>“分享经济”这一概念则是最近几年才明确地提出来的。 然而往往却和&quot;公司租赁&quot;混在一块，在我看来，这错得离谱，他们有着本质的不同。 而目前“租赁经济”只不过是披着互联网皮的传统公司租赁模式。</p>
<p>那么“租赁经济”和“分享经济”最本质的不同之处在哪里？</p>
<p>虽然“分享经济”看上去和“租赁”差不多，都是“资源”出借的方式。 但是本质的区别在于“租赁模式”是一家公司的将采购（<strong>全新购买</strong>）的资源租赁出去，并从中获得金钱收益的方式，而“分享经济”则是将每一个人(人人)<strong>已有的闲置资源</strong>进行充分利用，不仅仅是租赁（还可以是交换，赠与，甚至买卖的方式），这实质是一种协同消费(collaborative consumption)，也是第一代分享经济的主要特征。</p>
<p>再从社会效益来看，“租赁经济”并不能起到节能降排的目的，而是恰恰相反，因为它不是在利用现有资源，而是去生产新的投放市场。它的目标只有一个：盈利，甚至可能为了公司的利益目标，去生产资金回笼快的劣质产品，进而危害公共安全。而“分享经济”则能解决社会闲置产能，重新分配商品的使用价值。利用互联网匹配各种闲置产能供给和需求。</p>
<p>由此我们看到分享经济的<strong>本质特征</strong>是在最终用户之间(P2P)的分享或交换(Share/Exchage)资源(Resource)。</p>
<ul>
<li>P2P(Peer to Peer): 最终用户对最终用户</li>
<li>Share/Exchage: 共享或交换</li>
<li>Resource(资源): 这里的资源是泛指，包括电子信息和实际资源（产品，时间，技能，金钱等等)</li>
</ul>
<h1 id="xian-jie-duan-de-fen-xiang-jing-ji" class="heading-control">现阶段的分享经济<a class="heading-anchor" href="#xian-jie-duan-de-fen-xiang-jing-ji" aria-hidden="true"></a></h1>
<p>现阶段的<strong>一代分享经济</strong>，是以互联网为信息平台，在各个垂直领域中使得人人能对自己的<strong>信息</strong>和<strong>资源</strong>进行分享。</p>
<h2 id="xin-xi-fen-xiang" class="heading-control">信息分享<a class="heading-anchor" href="#xin-xi-fen-xiang" aria-hidden="true"></a></h2>
<p>首当其冲的是信息分享，随着社交网络服务(SNS)的出现，将个人的兴趣、经历、成果或心情分享出去，会让自己得到满足感。 很多人在做或做完某件事以后，往往想要分享给家人和朋友，亦或是陌生人，如果这些人对自己的分享是认可的、开心的或互动的，那么分享者自身也会很开心，这就是分享的动力。</p>
<ul>
<li>分享自己知识经验整理成文的这是<strong>博客</strong>。</li>
<li>通过关注周边发生的新鲜事，再以新奇视角的方式随时随地向公众进行分享，而这成就了<strong>微博(twitter)</strong>。</li>
<li>通过兴趣、休闲，炫耀，把私密和心情进行身边生活圈子分享，成就了<strong>微信(Facebook)</strong></li>
<li>把生活经(履)历，心得向特定群体进行分享，成就了<strong>Pinterest</strong></li>
</ul>
<h2 id="zi-yuan-fen-xiang" class="heading-control">资源分享<a class="heading-anchor" href="#zi-yuan-fen-xiang" aria-hidden="true"></a></h2>
<p>接着下来的是资源的分享和交换。</p>
<p><img src="./share1.png" alt></p>
<p>“资源&quot;分享的一个典型案例是&quot;AirBnB”，故事是这样开始的，07年在旧金山的两个刚毕业的美国小伙儿为自己的房租发愁，而当时城里正好在举办一个设计展，周边的旅馆都被订满了。 两位年轻人突发奇想，搞来了三张充气床垫放在客厅，建了一个简陋的网站发布信息：宣布任何参会者只要支付每晚80美元的费用，就可以享受到气垫床加早餐（AirBed &amp; Breakfast）的服务，和传统的借宿相比，通过 AirBnB，不再局限于熟人圈子，参与“分享”者的数量大大增加，借宿发生的地理空间也得到极大地拓展，同时借宿过程变得更加便捷，借宿体验变得更加有趣。  AirBnB 也因此成为“分享经济”的典范。</p>
<p>这实质是<strong>基于P2P租赁的“产品”服务</strong>。  我们要喝牛奶，但不必家家户户都养奶牛，这是显而易见的。 可是只要我们在家里环顾一下，便不难发现我们可没少干“养奶牛”的事。 举个极端的例子，美国有一半的家庭都拥有电钻，而平均每个家庭使用电钻的时间只有6 -13分钟！ 显然， 人们忘记了自己要的是打一个“洞”，而不是拥有一个电钻。 既然某些东西利用率如此之低，那么与其买一个闲在家里，不如临到用时才去借一个。 这种“<strong>使用而非占有</strong>”的观念如今已被越来越多的人接受。 它挑战了传统的建立在“私有独享”基础上的经济模式。</p>
<p>在家里，不仅有电钻这类使用频率很低的东西，其实还有很多东西人们压根就用不著。 对于这类物品，过去要么只能扔掉，要么当废品廉价卖掉，如果舍不得的话，那就只能堆在家里给自己添堵。 而现在拜互联网所赐出现的许多创新的平台，可以帮助人们更加有效地处理这些二手物品。 比如<strong>基于二手转让或交换的市场再流通</strong>的 Swapub 平台。</p>
<p><strong>基于&quot;服务技能&quot;的分享协同生活</strong>,可以说是新时代下的&quot;我为人人，人人为我&quot;,早在上世纪80年代，就有人倡议社区居民相互提供服务，每个人的服务时间都记录在一个“时间账户”中，将来需要别人来为自己提供服务的时候，就可以从这个账户中“提取”时间。 如今这一模式已经在社区志愿服务、社区养老等领域广泛开展，在中国的一些城市里也已经出现了一些尝试。</p>
<p><strong>基于集体智慧的众创众筹</strong>，对于酷爱DIY的创意者，通过众筹平台，把自己的创意变成现实的产品越来越普遍了。 互联网的到来，使得渺小个体也能发出自己的声音，也能被众感知和放大，这也是众智时代的到来。 从国外的kickstarter,india…,到国内的京东众筹，淘宝众筹…无一不在体现着这一趋势。 当然国内，我更多的看到是公司行为，把自己新发布的产品放在众筹上作为一种市场预售罢了。</p>
<h1 id="fen-xiang-jing-ji-de-she-hui-yi-yi" class="heading-control">分享经济的社会意义<a class="heading-anchor" href="#fen-xiang-jing-ji-de-she-hui-yi-yi" aria-hidden="true"></a></h1>
<p>“<a href="http://www.yic.cas.cn/kpzx/kpzl/201609/t20160922_4667205.html" target="_blank" rel="noopener">泛太平洋垃圾带</a>”自1997年被发现后，如今它的面积已经达到350万平方公里，相当于法国面积的7倍,而这堆塑料垃圾的面积每年会增加8万平方公里。由此说明，现代社会物质其实已经足够多了，已经达到泛滥的程度，但是过度的消费和不合理的分配导致物资无法惠及每一个人。</p>
<ul>
<li>人们不停追逐更新、更好、更便捷的产品所有权，而旧的产品成为垃圾</li>
<li><code>炫耀性消费</code>和<code>透支消费</code>导致高消费主义的发展，人们被引诱购买名不符价的<strong>狗牌</strong>产品：“爷就是有钱”</li>
</ul>
<p>不过人们已经开始逐渐认识到:</p>
<blockquote>
<p>“幸福并非来自物欲，而是来自感同身受。当我们在迟暮之年回首自己的人生经历时，在我们的记忆中突颖而出的很少会是关于物质利益、名誉或是财富方面的。触动我们内心深处的时刻就是那些同感激荡的时刻，来自于我们自身的超然感觉以及对他人通过奋斗获得成功的满足感的体会，仿佛那是我们自己的成功一样。” - <a href="https://book.douban.com/subject/25986746/" target="_blank" rel="noopener">零边际成本社会</a></p>
</blockquote>
<p>而随着社交网络服务(SNS)的发展进一步推动了“分享”文化的普及。 对于生活在互联网时代的人来说，在社交网路上发表自己的观点(照片,视频)或转发内容的行为近乎成为了一种本能，而正是这种“本能”的分享为“分享经济”的快速扩散打下了结实的基础。</p>
<p>随着年轻人越来越关心地球环境和资源的有效利用，习惯消费二手物品，更愿意过轻资产的生活，在这些的人眼中，成功的标志正在发生变化。 在分享经济领域，目前最活跃的市场是汽车和房产，这两样一般是家中最值钱的东西，通常被传统观念认作是最能体现身份地位的东西，但如今，越来越多的人选择分享它们而不是拥有或独有。 当然，很多人是出于现实经济的考虑。</p>
<p>分享经济创造大量的经济商业上的机会的同时，也产生了许多积极的社会效应。 其中最重要的一点就是恢复日益匮乏的社区感。 如今，整个社会都在进入一个更加开放和高度流动的现代社会。 人们纷纷离开原本的社区，进入到陌生的社区中生活。 分享经济可以增强社区凝聚力和活力，阻止了传统社区无社交的尴尬。</p>
<p>分享经济将会创造一个更加开放多元分享合作的社会(社区)，在这样的社会中，整个社会经济体系中的权力不再集中于少数供应商、生产商手中，因为通过共享经济，人们有条件有能力依靠自己解决更多的问题，满足自己更多的需求，也创造出更多的合作模式。</p>
<p>在传统商业模式的逻辑中，每个人都是社会经济体系中固定的一环，彼此的角色是对立的，要么是消费者，要么是生产者；这些角色之间的权力关系往往是不平等的，中间商可以压榨剥削小农，生产商可以欺瞒诱导顾客；这些角色彼此之间的关系是竞争的，我的获益多了，你的利益就会少了。 而在共享经济中，人们满足需求的方式可以是赠送、可以是交换、可以循环利用，可以临时借用，可以共同创造，可以共同使用，彼此的关系是利益共享的，我的获益多了，你的获益也不会减少。</p>
<p>越来越多的人将从雇佣就业走向创业式就业，从公司管理走向平台化的协同，从全职工作走向兼职工作，从机械的流水线作业走向自由灵活的“云上”作业，从办公室与工厂走向更个性化的居家与旅途。 与此同时，分享经济将重塑社会组织，“公司+员工”将在越来越多的领域被“平台+个人”所替代。 分享经济的发展让参与者比较自由地进入或退出社会生产过程，减轻了个人对组织的依赖程度，个人的创新创业潜力将从办公室、流水线的束缚中释放出来。 越来越多的个人将不再依附于某个特定的企业或机构，分享经济平台将成为灵活就业、个人创业、社会交往的空间。 个性化服务与生产自然也不再话下。</p>
<p>而这一切需要某种能让参与各方都能得到信任平台，这个平台也只有是各方共建的平台才能办到。</p>
<h1 id="xian-jie-duan-fen-xiang-jing-ji-ping-tai-de-wen-ti" class="heading-control">现阶段分享经济平台的问题<a class="heading-anchor" href="#xian-jie-duan-fen-xiang-jing-ji-ping-tai-de-wen-ti" aria-hidden="true"></a></h1>
<p>现阶段的<strong>一代分享经济</strong>平台，只是传统商业模式下的各个垂直领域封闭的个体经济平台，各自跑马圈地。 谋求各自利益最大化而封闭，自然就谈不上“分享“和”共赢“。</p>
<p>以微信为例，如果你想在微信上看到淘宝链接的信息，那是很麻烦的一件事情，你点连接，看不到任何内容，即使你用浏览器打开，也看不到，你必须手工选择复制粘贴淘宝链接地址到浏览器，所以出现了所谓的“淘口令”，当然淘宝也没少干封杀微信的傻事，不过没人在乎。</p>
<p>而再以淘宝来说，T宝最开始是提供开放的API接口的，但是自从15年开始，API不再开放了,大部分转为开始收费，哪怕是页面公开的产品信息，如果通过API调用获取也要收费，所以大家开始页面爬虫抓取。 14年的时候比价网比比皆是，到如今所剩无几。 一边说让天下没有难做的生意，一边却想方设法阻碍信息的分享和流通。</p>
<p>再说目前各个平台的EULA（最终用户许可协议），其实就是网络用户的使用合同，既然是合同，当然需要符合中国《合同法》与《消费者权益保护法》中关于格式条款的规定。 但遗憾的是，没有任何一家互联网公司能够达到上述法律的要求。 最近淘宝又更新了用户协议，规定在淘宝、支付宝平台的非活跃用户在一定时间之后将会进行销号处理(不同意请主动销号)，淘宝帐号还好，支付宝帐号如果有余额的话，对于6个月内无交易的用户，并且因为某些原因无法配合（核实身份），那么支付宝就可以有权注销该用户，真是霸道的条款，平台能没收用户的财产？</p>
<p><a href="https://render.alipay.com/p/f/fd-iztow1fi/index.html" target="_blank" rel="noopener">支付宝服务协议</a>:</p>
<blockquote>
<p>如您自开立支付宝账户之日起6个月内无主动交易，则向您重新核实身份之前，支付宝将有权暂停或者注销该支付宝账户。</p>
</blockquote>
<p>因为平台上保存有用户数据，于是他们决定用户数据的如何使用，而非基于用户自己的决定（授权），这些用户数据真的是平台的？如果是，那么这意味着平台拥有用户的财产，这显然荒谬，实际上，这应该是用户委托平台保管用户数据。 平台只应该是数据托管方。什么时候见过没有用户授权就可以乱动用户财产？</p>
<p>在拿众筹举例，《星际公民》算是游戏众筹的一个奇迹。 自从 2012 年著名众筹网站 Kickstarter 发起第一轮众筹起，三年时间，这个游戏在各种平台上已经募集了超过 8500 万美元，折合人民币超过 5 亿元。 而《魔兽世界》十年来的全部研发加诸多资料片的费用才不过 1 亿美元。 然而众筹投资者得到的是什么？除了跳票和玩游戏半成品，其他什么权益也没有。因此这样的众筹，引来一堆的骗子项目。 这实质上应该归属礼品经济，而非产品销售，因为这个时候产品并没有开始研发，对于是否能真的拿到产品，以及什么的产品，需要自行承担研发风险，这实际上就是P2P风投。 但是投资用户却没有相应的比例的收益，最多能免费先玩一玩，这样的投资者，哪里去找！</p>
<p>再说说信任，当前，几乎所有提供分享经济服务的平台在应对信任问题时，都采取了“<code>评分</code>”机制。 租借双方都必须填写详细的个人数据，在分享活动结束后，可以给对方评分。 但是这样的“评分”仅限于平台内部，当然，这个“评分”也不会有任何的分享，或者保证不被串改，删除。 你只能信任平台，信任平台的员工。</p>
<p>那么到底下一代分享经济（共享经济）如何实现，什么样的平台才能完全避免上述问题？</p>
<p>欲知后事如何，且听下回分解。待后续(TO BE CONTIUNED)…</p>
<h1 id="ming-xie" class="heading-control">鸣谢<a class="heading-anchor" href="#ming-xie" aria-hidden="true"></a></h1>
<p>感谢朋友们提供的宝贵意见，特别感谢同事周悦的一幅图及钓鱼的例子（略有改动），尤其是<a href="http://www.zhuangbiaowei.com" target="_blank" rel="noopener">庄表伟</a>，在对本文的提纲上给于我很多宝贵意见。谢谢朋友们。还有朋友提到文章篇幅过长，这也是个问题，所以我决定分成系列篇，本文以及接下来的部分还要作大量的修改。</p>
<h1 id="can-kao" class="heading-control">参考<a class="heading-anchor" href="#can-kao" aria-hidden="true"></a></h1>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Sharing_economy" target="_blank" rel="noopener">Sharing_economy</a></li>
<li><a href="https://book.douban.com/subject/25986746/" target="_blank" rel="noopener">零边际成本社会</a></li>
<li><a href="http://blog.sina.com.cn/s/blog_7a9c67890102vdf0.html" target="_blank" rel="noopener">《零边际成本社会》读后感</a></li>
<li><a href="https://book.douban.com/subject/26465430/" target="_blank" rel="noopener">共享经济时代</a></li>
<li><a href="http://wiki.mbalib.com/wiki/%E6%B6%88%E8%B4%B9%E4%B8%BB%E4%B9%89" target="_blank" rel="noopener">高消费主义</a></li>
<li><a href="https://en.wikipedia.org/wiki/Great_Pacific_garbage_patch" target="_blank" rel="noopener">太平洋垃圾帶（岛）</a></li>
<li><a href="http://www.yic.cas.cn/kpzx/kpzl/201609/t20160922_4667205.html" target="_blank" rel="noopener">海洋在流泪！海洋塑料垃圾触目惊心</a></li>
</ul>
]]></content>
      <categories>
        <category>Thinking</category>
        <category>Internet</category>
        <category>Sharing Economy</category>
      </categories>
      <tags>
        <tag>thinking</tag>
        <tag>internet</tag>
        <tag>creation</tag>
        <tag>share</tag>
        <tag>economy</tag>
        <tag>blockchain</tag>
      </tags>
  </entry>
  <entry>
    <title>从分享经济到共享经济系列(二)——下一代的分享经济:共享经济</title>
    <url>/article/sharing-economy2/</url>
    <content><![CDATA[<p>接前文：<a href="./share-economy">从分享经济到共享经济——分享经济的前世今生</a></p>
<h1 id="xia-yi-dai-de-fen-xiang-jing-ji-gong-xiang-jing-ji" class="heading-control">下一代的分享经济:共享经济<a class="heading-anchor" href="#xia-yi-dai-de-fen-xiang-jing-ji-gong-xiang-jing-ji" aria-hidden="true"></a></h1>
<p>设想下什么样的平台才能满足如下的需求：</p>
<h2 id="ge-xing-hua-sheng-chan" class="heading-control">个性化生产<a class="heading-anchor" href="#ge-xing-hua-sheng-chan" aria-hidden="true"></a></h2>
<p>当我构思出一种高度安全汽车概念，于是我在平台建立一个新项目，说明这个项目由来，以及这个项目的关键点：</p>
<p>一个球形的汽车，车身主要由“弹性柔韧泡沫塑料车体”和“弹性柔韧轻型支架”组成，发动机和转轴部分被隔离在单独的空间，当有危险时候，载人部分球形空间可以与之完全脱离…</p>
<p><img src="./car.jpg" alt="car"></p>
<p>在设定项目启动条件以及分赃比例(3331)后，成功创建项目。 而后平台将该项目发送到生产“弹性柔韧”的高强度材料厂商，以及发动机、转轴的厂家,还有关注新汽车的人上。</p>
<p>几天后，生产“弹性柔韧”的高强度材料厂商开始进入项目。 同时研发各类发动机的厂商或个人也开始进入，有的愿意参与研发。感兴趣的人们也开始在项目上投资和挑选自己喜爱的：从形状大小，再到材料和发动机，并开始PK（阐述理由，尽力拉票）。</p>
<p>平台开始统计, 各类组合(如：发动机A+材料B)的个数，确定前n名（投资金额满足）作为实验机。 也有人对落选的样机情有独钟，他们开始自己增加投资金额，确保他们的样机也能参与试作。 最终有52个通过参与试作。 这个时候<code>创意</code>结束。</p>
<p>接着开始紧张的<code>研发</code>过程…,最终研发结束，试作原型出炉。</p>
<p>然后试作原型在经过汽车质量检测部门的严格测试后，又在不同路面，天气，交通情况下做了测试，最后又淘汰了12个，剩下40个。</p>
<p>然后进入预售阶段，平台上经营汽车内饰和外观的商家开始进入，人们通过平台对车的内饰和外观做了不同的选择，有的在这个阶段也参与到项目里来，有的进行来投资，有的承诺会进行售后维修…</p>
<h2 id="ge-xing-hua-fu-wu" class="heading-control">个性化服务<a class="heading-anchor" href="#ge-xing-hua-fu-wu" aria-hidden="true"></a></h2>
<p>今天是一个周末，我一起床就收到朋友从平台发来的组织去钓鱼的活动，我点击参与了这个活动，一个小时候，就会有专车服务将会将我准时送往活动地点。 接下来我接到了平台推送来的消息：家里的智能冰箱空了，平台问我是否需要配送一些食品，我选择后约了下午6点以后送来。</p>
<p>收拾完毕，在前往活动地点的路上，社区给我发来一条通知，说今天晚上社区停气，我想了想就干脆决定跟朋友晚上一起聚餐，不回家做饭了，我发起一条聚餐活动，并邀请朋友参加，接下来在平台上选择并预约了一个餐厅，并且在app上修改了送货到家的预约时间。</p>
<h2 id="gong-xiang-jing-ji-ping-tai" class="heading-control">共享经济平台<a class="heading-anchor" href="#gong-xiang-jing-ji-ping-tai" aria-hidden="true"></a></h2>
<p>下一代的共享经济平台，实质上是一个对等社会平台网络，它是打通各个垂直领域，进行生产资料共享合作共赢的一个平台，可以说是全球的分布式经济系统，打通各个环节而不是处处设置门槛，让自动化流转更加便捷，使得各类创新的智能服务呈出不穷。这实际上就是新形式下全新的互联网。</p>
<p>针对参与各方的开放，信任，权益的公平分配是下一代分享经济急需解决的主要问题。 那么如何能让各方都参与共建和共享利益呢？</p>
<p>在我看来，作为一个没有任何背景，任何机构担保的项目，要让人用，最首先要解决的就是：信任。</p>
<h3 id="xin-ren" class="heading-control">信任<a class="heading-anchor" href="#xin-ren" aria-hidden="true"></a></h3>
<p>只有当我们在对待某些事情上达成一致，形成共识，才能有建立信任的基础。而事实上我们是有些共识的基础的：</p>
<p>我们都相信:</p>
<ul>
<li>人人都是平等</li>
<li>谁也不信谁 Do not trust anyone</li>
</ul>
<p>这些共识的基础总结起来就是：</p>
<ul>
<li>去信任化: 谁也不信谁</li>
<li>人人平等</li>
<li>共识共产共治共赢</li>
</ul>
<h4 id="di-yi-gong-shi-kai-yuan" class="heading-control">第一共识:开源<a class="heading-anchor" href="#di-yi-gong-shi-kai-yuan" aria-hidden="true"></a></h4>
<p>为什么说共享经济的第一共识是开源（开放源代码）？简单来说：</p>
<ul>
<li>开源才能保障人人共有共享</li>
<li>开源才可以保障对共识规则的审核落实（代码的执行逻辑就是共识规则）</li>
<li>开源也是IT软件行业彻底开放的象征。</li>
</ul>
<p>具体来说，“<strong>开源</strong>”是分享经济的最佳载体，没有之一。 因为“<strong>开源</strong>”的本质就是在共享“技术”，而“技术”是生产资料的组成部分，这就是由市场驱动而“自发形成”的生产资料的“公有制”，<strong>开源</strong>才能够真正的让大家共同拥有一个平台。</p>
<p>2015年，谷歌开源了深度学习系统TensorFlow;随后facebook也将其最新的人工智能相关技术开源了…对诸多的高科技企业来说，“开源”活动已蔚然成风。 实际上，不仅仅是软件公司兴起开源运动，就硬件领域也兴起了Arduino这样的开源硬件。 <strong>开源</strong>已经是科技企业的一个潮流，想要成为某领域内的领头羊，以自己的技术为核心构建强大的生态系统是唯一的选择。 当年谷歌因为是手机操作系统的后来者，选择将android系统开源，如今该操作系统的市场份额将近90%，而作为智能手机操作系统的先行者微软(当年的多普达手机可是比苹果更早进入智能手机市场)，一直想复制他们在pc领域内的授权模式，到今天连1%的份额都难以守住,如今的微软也从拒绝开源，转变为拥抱开源，早在2014微软就将.Net给开源了。 就连在电子货币方面，也是开源独领风骚，比特币(Bitcoin)大家耳熟能详，在开源模式运作下的又一杰作(哪怕它只是一个实验，种种的不完善，居然也得到如此多的人支持)，目前的各种开源区块链(Blockchain)技术都是基于此。</p>
<ol>
<li>开源解决各方（包括最终用户）的最初信任的问题</li>
</ol>
<p>还记得去年因为信息泄露而导致山东女孩徐玉玉死亡的事情么，现在，盗窃信息已经不算什么，在更新的<a href="https://docs.alipay.com/policies/privacy/alipay" target="_blank" rel="noopener">《支付宝隐私权政策》</a>中已经明目张胆在收集并传递信息：“<strong>要向支付宝关联公司和合作伙伴收集其合法留存的您的行为信息、交易信息…</strong>”,而你无权禁止他们收集你的信息，你只可以发短信退订广告，对用户的信息滥用以至于此。</p>
<ol start="2">
<li>开源才能保证这是残各方自己拥有的自建平台</li>
</ol>
<p>但是<strong>开源</strong>的只是万里长征的第一步，如果<strong>运作</strong>不开源，那么还是无法确保各方利益的真实执行。这需要一个各方满意并且各方看得见的<strong>运作</strong>机制。 这种机制必须允许保证各个参与者在平台上贡献的资源进行论功行赏，从而最终达到自洽和自我进化。</p>
<h4 id="di-er-gong-shi-qu-zhong-xin-hua-qu-xin-ren-hua-p2p" class="heading-control">第二共识: 去中心化(去信任化,P2P)<a class="heading-anchor" href="#di-er-gong-shi-qu-zhong-xin-hua-qu-xin-ren-hua-p2p" aria-hidden="true"></a></h4>
<p><img src="./central-vs-decentral.jpg" alt></p>
<p>以前信息是放在中心平台,平台负责管理,你完全不清楚平台是如何存储和管理您的数据，平台方以及平台维护者完全可以绕过您而任意滥用您的数据。而去中心化，首先是指信息的去中心化，数据在自己的手里，任何使用都经过自己的允许，其次才是指平台的去中心化。</p>
<p>TO BE CONTINUE.</p>
]]></content>
      <categories>
        <category>Thinking</category>
        <category>Internet</category>
        <category>Sharing Economy</category>
      </categories>
      <tags>
        <tag>thinking</tag>
        <tag>internet</tag>
        <tag>creation</tag>
        <tag>share</tag>
        <tag>economy</tag>
        <tag>blockchain</tag>
      </tags>
  </entry>
  <entry>
    <title>MQTT 服务 - IoT界的消息订阅发布服务</title>
    <url>/article/mqtt/</url>
    <content><![CDATA[<h1 id="mqtt-fu-wu-iot-jie-de-xiao-xi-ding-yue-fa-bu" class="heading-control">MQTT 服务 - IoT界的消息订阅发布<a class="heading-anchor" href="#mqtt-fu-wu-iot-jie-de-xiao-xi-ding-yue-fa-bu" aria-hidden="true"></a></h1>
<p>关于消息推送服务PaaS云，这才发现国内几乎所有的消息推送服务都是基于广告，对用户画像，打标签，针对用户推送，没有纯粹的基于订阅发布消息推送服务，难怪免费居多，相当于你帮他们植入了常驻设备的推送后门。</p>
<p>只有自驾了。我选择了MQTT。</p>
<p>MQTT本是用于物联网设备的消息推送协议，具有体积小，协议简单，通信高效省电的特点。用在手机设备最好不过。</p>
<h2 id="mqtt-xie-yi-jian-dan-jie-shao" class="heading-control">MQTT 协议简单介绍<a class="heading-anchor" href="#mqtt-xie-yi-jian-dan-jie-shao" aria-hidden="true"></a></h2>
<p>MQTT 协议使用最少的方法指示要在特定主题(Topic)上实施的操作，进而实施发布/订阅模式。<br>
MQTT是发布订阅(Publish/Subscribe)模式的消息协议，与HTTP协议请求响应(Request/Response)模式是不同的。</p>
<h3 id="xiao-xi-yu-zhu-ti-topic" class="heading-control">消息与主题 Topic<a class="heading-anchor" href="#xiao-xi-yu-zhu-ti-topic" aria-hidden="true"></a></h3>
<p>MQTT发布者与订阅者之间通过”主题”(Topic)进行消息推送，主题(Topic)格式类似URL或文件路径，通过&quot;/&quot;分隔层级，例如:</p>
<pre><code>sensor/1/temperature
chat/room/subject
presence/user/feng
sensor/1/#
sensor/+/temperature
uber/drivers/joe/inbox
</code></pre>
<p>MQTT主题(Topic)支持’+’, ‘#’的通配符，’+’通配一个层级，’#’通配多个层级(必须在末尾)。<br>
MQTT消息发布者(Publisher)只能向特定’名称主题’(不支持通配符)发布消息，订阅者(Subscriber)<br>
通过订阅’过滤主题’(支持通配符)来匹配消息。</p>
<p>注意：必须要转义’+’, ‘#’。</p>
<p>MQTT支持推送消息的QoS(服务质量)。在MQTT 中有三个等级的 QoS：</p>
<ul>
<li>QoS 0: 该等级表示“最多一次”交付（最佳状况）。 消息不会得到确认，因而，这是一种一劳永逸的方法。</li>
<li>QoS 1: 该等级表示“至少一次”交付。 用户可能不止一次获得消息，但是允许收到的人确认已经收到。</li>
<li>QoS 2: 该等级表示“刚好一次”交付。最慢但是最有保障的服务质量等级。确保用户只收到一次消息，并包含四个阶段的交付握手。该等级最慢，但是最安全。</li>
</ul>
<h4 id="mqtt-yi-yuan-xiao-xi-last-will" class="heading-control">MQTT遗愿消息(Last Will)<a class="heading-anchor" href="#mqtt-yi-yuan-xiao-xi-last-will" aria-hidden="true"></a></h4>
<p>MQTT客户端向服务器端CONNECT请求时，可以设置是否发送遗愿消息(Will Message)标志，和遗愿消息主题(Topic)与内容(Payload)。</p>
<p>MQTT客户端异常下线时(客户端断开前未向服务器发送DISCONNECT消息)，MQTT消息服务器会发布遗愿消息。</p>
<h4 id="mqtt-bao-liu-xiao-xi-retained-message" class="heading-control">MQTT保留消息(Retained Message)<a class="heading-anchor" href="#mqtt-bao-liu-xiao-xi-retained-message" aria-hidden="true"></a></h4>
<p>MQTT客户端向服务器发布(PUBLISH)消息时，可以设置保留消息(Retained Message)标志。保留消息(Retained Message)会驻留在消息服务器，后来的订阅者订阅主题时仍可以接收该消息。</p>
<p>保留消息(Retained Message)有两种清除方式:</p>
<ul>
<li>客户端向有保留消息的主题发布一个空消息:</li>
<li>消息服务器设置保留消息的超期时间。</li>
</ul>
<h4 id="gong-xiang-ding-yue-shared-subscription" class="heading-control">共享订阅(Shared Subscription)<a class="heading-anchor" href="#gong-xiang-ding-yue-shared-subscription" aria-hidden="true"></a></h4>
<p>共享订阅是非标准MQTT约定，不过大多数开源MQTT服务器已经实现。共享订阅(Shared Subscription)支持在多订阅者间采用分组负载平衡方式派发消息:<br>
也就是订阅相同共享订阅(Shared Subscription)的客户根据负载平衡方式只有1人收到。这个场景可以用于：集群执行分布式任务（1个人接了活，其他人就不要接了）。</p>
<pre><code>                            ---------
                            |       | --Msg1--&gt; Subscriber1
Publisher--Msg1,Msg2,Msg3--&gt;|  EMQ  | --Msg2--&gt; Subscriber2
                            |       | --Msg3--&gt; Subscriber3
                            ---------
</code></pre>
<p>共享订阅支持两种使用方式:</p>
<table>
<thead>
<tr>
<th>订阅前缀</th>
<th>使用示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>$queue/</code></td>
<td><code>mosquitto_sub -t ‘$queue/topic’</code></td>
</tr>
<tr>
<td><code>$share/&lt;group&gt;/</code></td>
<td><code>mosquitto_sub -t ‘$share/group/topic’</code></td>
</tr>
</tbody>
</table>
<h4 id="ben-di-ding-yue-local-subscription" class="heading-control">本地订阅(Local Subscription)<a class="heading-anchor" href="#ben-di-ding-yue-local-subscription" aria-hidden="true"></a></h4>
<p>本地订阅也是非标准MQTT约定。</p>
<p>本地订阅(Local Subscription)只在本节点创建订阅与路由表，不会在集群节点间广播全局路由，非常适合物联网数据采集应用:</p>
<pre><code class="bash">mosquitto_sub -t <span class="hljs-string">'$local/topic'</span>
mosquitto_pub -t <span class="hljs-string">'topic'</span>
</code></pre>
<p>使用方式: 订阅者在主题(Topic)前增加’$local/’前缀。</p>
<h3 id="mqtt-hui-hua-clean-session" class="heading-control">MQTT会话(Clean Session)<a class="heading-anchor" href="#mqtt-hui-hua-clean-session" aria-hidden="true"></a></h3>
<p>MQTT支持Session(会话)，当MQTT客户端向服务器发起CONNECT请求时，可以通过’Clean Session’标志设置会话。</p>
<ul>
<li>‘Clean Session’设置为0，表示创建一个持久会话，在客户端断开连接时，会话仍然保持并保存离线消息，直到会话超时注销。</li>
<li>‘Clean Session’设置为1，表示创建一个新的临时会话，在客户端断开时，会话自动清除销毁。</li>
</ul>
<p>MQTT 方法定义很简单：</p>
<ul>
<li>连接 - 建立与 MQTT 经纪人（Broker）之间的连接。</li>
<li>断开连接 - 断开与 MQTT 经纪人（Broker）之间的连接。</li>
<li>发布 - 在 MQTT 经纪人（Broker）上发布主题。</li>
<li>订阅 - 从 MQTT 经纪人（Broker）上订阅主题。</li>
<li>退订 - 从 MQTT 经纪人（Broker）上退订主题。</li>
</ul>
<h2 id="open-source-mqtt-server" class="heading-control">Open Source MQTT Server<a class="heading-anchor" href="#open-source-mqtt-server" aria-hidden="true"></a></h2>
<ul>
<li><a href="https://vernemq.com" target="_blank" rel="noopener">VerneMQ</a> Erlang</li>
<li><a href="http://emqtt.com" target="_blank" rel="noopener">EMQ</a> Erlang
<ul>
<li>文档：<a href="http://emqtt.com/docs/v2/getstarted.html" target="_blank" rel="noopener">http://emqtt.com/docs/v2/getstarted.html</a></li>
</ul>
</li>
<li><a href="https://github.com/mcollina/mosca" target="_blank" rel="noopener">Mosca</a> NodeJS</li>
<li><a href="https://github.com/eclipse/mosquitto" target="_blank" rel="noopener">Mosquitto</a> C</li>
</ul>
<h3 id="emq" class="heading-control">EMQ<a class="heading-anchor" href="#emq" aria-hidden="true"></a></h3>
<p>支持MQTT 3.1.1协议。<br>
EMQ 2.0消息服务器默认占用的TCP端口包括:</p>
<ul>
<li>1883  MQTT协议端口</li>
<li>8883  MQTT(SSL)端口</li>
<li>8083  MQTT(WebSocket), HTTP API端口</li>
<li>18083 Dashboard管理控制台端口</li>
</ul>
<p><a href="https://github.com/emqtt/emq-docker" target="_blank" rel="noopener">https://github.com/emqtt/emq-docker</a><br>
<a href="https://github.com/eclipse/paho.mqtt.android" target="_blank" rel="noopener">https://github.com/eclipse/paho.mqtt.android</a></p>
<ul>
<li>用户登陆绑定</li>
<li>用户权限绑定，只能订阅或者发送本组织下的</li>
</ul>
<h2 id="ke-hu-duan" class="heading-control">客户端<a class="heading-anchor" href="#ke-hu-duan" aria-hidden="true"></a></h2>
<h3 id="android" class="heading-control">Android<a class="heading-anchor" href="#android" aria-hidden="true"></a></h3>
<p><a href="http://www.eclipse.org/paho/clients/android/" target="_blank" rel="noopener">Eclipse Paho Android Service</a></p>
<h4 id="install" class="heading-control">Install<a class="heading-anchor" href="#install" aria-hidden="true"></a></h4>
<pre><code class="java">repositories {
    maven {
        url <span class="hljs-string">"https://repo.eclipse.org/content/repositories/paho-releases/"</span>
    }
}


dependencies {
    compile <span class="hljs-string">'org.eclipse.paho:org.eclipse.paho.client.mqttv3:1.1.0'</span>
    compile <span class="hljs-string">'org.eclipse.paho:org.eclipse.paho.android.service:1.1.1'</span>
}
</code></pre>
<p>The Paho Android Service needs the following permissions to work:</p>
<pre><code class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.WAKE_LOCK"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.INTERNET"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.ACCESS_NETWORK_STATE"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.READ_PHONE_STATE"</span> /&gt;</span>
</code></pre>
<h4 id="usage" class="heading-control">Usage<a class="heading-anchor" href="#usage" aria-hidden="true"></a></h4>
<pre><code class="java">Log.i(LOGTAG, <span class="hljs-string">"MQTT Start"</span>);

<span class="hljs-comment">//如果是走 "ssl://192.168.0.13:8883"</span>
<span class="hljs-keyword">final</span> MqttAndroidClient mqttAndroidClient = <span class="hljs-keyword">new</span> MqttAndroidClient(
  getApplicationContext(), <span class="hljs-string">"tcp://192.168.0.13:1883"</span>, clientId);


<span class="hljs-comment">//设置回调，在这里接收订阅的消息</span>
mqttAndroidClient.setCallback(<span class="hljs-keyword">new</span> MqttCallbackExtended() {
  <span class="hljs-meta">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">connectComplete</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> reconnect, String serverURI)</span> </span>{

      <span class="hljs-keyword">if</span> (reconnect) {
          Log.i(LOGTAG, <span class="hljs-string">"Reconnected to : "</span> + serverURI);
          <span class="hljs-comment">// if Clean Session is true, we need to re-subscribe</span>
          <span class="hljs-comment">// subscribe('SampleTopic');</span>
      } <span class="hljs-keyword">else</span> {
          Log.i(LOGTAG, <span class="hljs-string">"Connected to: "</span> + serverURI);
      }
  }

  <span class="hljs-meta">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">connectionLost</span><span class="hljs-params">(Throwable cause)</span> </span>{
      Log.i(LOGTAG, <span class="hljs-string">"The Connection was lost."</span>);
  }

  <span class="hljs-meta">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">messageArrived</span><span class="hljs-params">(String topic, MqttMessage message)</span> <span class="hljs-keyword">throws</span> Exception </span>{
      Log.i(LOGTAG, <span class="hljs-string">"Incoming message: "</span> + <span class="hljs-keyword">new</span> String(message.getPayload()));
  }

  <span class="hljs-meta">@Override</span>
  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">deliveryComplete</span><span class="hljs-params">(IMqttDeliveryToken token)</span> </span>{
  }
});

MqttConnectOptions mqttConnectOptions = <span class="hljs-keyword">new</span> MqttConnectOptions();
mqttConnectOptions.setAutomaticReconnect(<span class="hljs-keyword">true</span>);
mqttConnectOptions.setCleanSession(<span class="hljs-keyword">false</span>);
mqttConnectOptions.setUserName(<span class="hljs-string">"USERNAME"</span>);
mqttConnectOptions.setPassword(<span class="hljs-string">"PASSWORD"</span>.toCharArray());
<span class="hljs-keyword">try</span> {
  <span class="hljs-comment">//第二个参数是可选的object,可以传递给回调函数</span>
  client.connect(mqttConnectOptions, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> IMqttActionListener() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onSuccess</span><span class="hljs-params">(IMqttToken mqttToken)</span> </span>{
      Log.i(LOGTAG, <span class="hljs-string">"Client connected"</span>);
      Log.i(LOGTAG, <span class="hljs-string">"Topics="</span>+mqttToken.getTopics());
      subscribe(<span class="hljs-string">'sampleTopic'</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(IMqttToken arg0, Throwable arg1)</span> </span>{
      <span class="hljs-comment">// TODO Auto-generated method stub</span>
      Log.i(LOGTAG, <span class="hljs-string">"Client connection failed: "</span>+arg1.getMessage());
    }
  });
}

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">subscribe</span><span class="hljs-params">(String topic)</span></span>{
  <span class="hljs-keyword">try</span> {
    mqttAndroidClient.subscribe(topic, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> IMqttActionListener() {
      <span class="hljs-meta">@Override</span>
      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onSuccess</span><span class="hljs-params">(IMqttToken asyncActionToken)</span> </span>{
          Log.i(LOGTAG, <span class="hljs-string">"Subscribed!"</span>);
      }

      <span class="hljs-meta">@Override</span>
      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(IMqttToken asyncActionToken, Throwable exception)</span> </span>{
          Log.i(LOGTAG, <span class="hljs-string">"Failed to subscribe"</span>);
      }
    });

    <span class="hljs-comment">// THIS DOES NOT WORK!</span>
    mqttAndroidClient.subscribe(topic, <span class="hljs-number">0</span>, <span class="hljs-keyword">new</span> IMqttMessageListener() {
      <span class="hljs-meta">@Override</span>
      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">messageArrived</span><span class="hljs-params">(String topic, MqttMessage message)</span> <span class="hljs-keyword">throws</span> Exception </span>{
          <span class="hljs-comment">// message Arrived!</span>
          System.out.println(<span class="hljs-string">"InMessage: "</span> + topic + <span class="hljs-string">" : "</span> + <span class="hljs-keyword">new</span> String(message.getPayload()));
      }
    });

  } <span class="hljs-keyword">catch</span> (MqttException ex){
    System.err.println(<span class="hljs-string">"Exception whilst subscribing"</span>);
    ex.printStackTrace();
  }
}

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unsubscribe</span><span class="hljs-params">(String topic)</span></span>{
  <span class="hljs-keyword">try</span> {
    mqttAndroidClient.unsubscribe(topic, <span class="hljs-number">0</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">new</span> IMqttActionListener() {
      <span class="hljs-meta">@Override</span>
      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onSuccess</span><span class="hljs-params">(IMqttToken asyncActionToken)</span> </span>{
          Log.i(LOGTAG, <span class="hljs-string">"unsubscribed!"</span>);
      }

      <span class="hljs-meta">@Override</span>
      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(IMqttToken asyncActionToken, Throwable exception)</span> </span>{
          Log.i(LOGTAG, <span class="hljs-string">"Failed to unsubscribed"</span>);
      }
    });

  } <span class="hljs-keyword">catch</span> (MqttException ex){
    System.err.println(<span class="hljs-string">"Exception whilst subscribing"</span>);
    ex.printStackTrace();
  }
}

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">publishMessage</span><span class="hljs-params">(String topic, String msg)</span></span>{
  <span class="hljs-keyword">try</span> {
    MqttMessage message = <span class="hljs-keyword">new</span> MqttMessage();
    message.setQos(<span class="hljs-number">0</span>);
    message.setRetained(<span class="hljs-keyword">false</span>);
    message.setPayload(msg.getBytes());
    mqttAndroidClient.publish(topic, message);
    Log.i(LOGTAG, <span class="hljs-string">"Message Published"</span>);
    <span class="hljs-keyword">if</span>(!mqttAndroidClient.isConnected()){
      Log.i(LOGTAG, mqttAndroidClient.getBufferedMessageCount() + <span class="hljs-string">" messages in buffer."</span>);
    }
  } <span class="hljs-keyword">catch</span> (MqttPersistenceException e) {
    <span class="hljs-comment">// TODO Auto-generated catch block</span>
    e.printStackTrace();

  } <span class="hljs-keyword">catch</span> (MqttException e) {
    <span class="hljs-comment">// TODO Auto-generated catch block</span>
    System.err.println(<span class="hljs-string">"Error Publishing: "</span> + e.getMessage());
    e.printStackTrace();
  }
}

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">disconnect</span><span class="hljs-params">()</span></span>{
  <span class="hljs-keyword">try</span> {
      IMqttToken disconToken = client.disconnect();
      disconToken.setActionCallback(<span class="hljs-keyword">new</span> IMqttActionListener() {
          <span class="hljs-meta">@Override</span>
          <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onSuccess</span><span class="hljs-params">(IMqttToken asyncActionToken)</span> </span>{
              <span class="hljs-comment">// we are now successfully disconnected</span>
          }

          <span class="hljs-meta">@Override</span>
          <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(IMqttToken asyncActionToken,
                                Throwable exception)</span> </span>{
              <span class="hljs-comment">// something went wrong, but probably we are disconnected anyway</span>
          }
      });
  } <span class="hljs-keyword">catch</span> (MqttException e) {
      e.printStackTrace();
  }
}
</code></pre>
<p>Demo:</p>
<ul>
<li><a href="https://github.com/eclipse/paho.mqtt.android/tree/develop/paho.mqtt.android.example" target="_blank" rel="noopener">简单DEMO</a></li>
<li><a href="https://github.com/eclipse/paho.mqtt.android/tree/develop/org.eclipse.paho.android.sample" target="_blank" rel="noopener">复杂DEMO</a></li>
</ul>
<h4 id="ios" class="heading-control">IOS<a class="heading-anchor" href="#ios" aria-hidden="true"></a></h4>
<p><a href="https://github.com/ckrey/MQTT-Client-Framework" target="_blank" rel="noopener">MQTT Client Framework</a></p>
<pre><code class="objc"><span class="hljs-meta">#import <span class="hljs-meta-string">"MQTTClient.h"</span></span>

MQTTSession *session = [[MQTTSession alloc] init];

<span class="hljs-comment">//specifies the protocol to be used.</span>
<span class="hljs-comment">//The value of the Protocol Level field for the version 3.1.1 of the protocol is 4.</span>
<span class="hljs-comment">//The value for the version 3.1 is 3.</span>
session.protocolLevel = <span class="hljs-number">4</span>;
session.clientId = <span class="hljs-string">@"clientId"</span>;
session.cleanSessionFlag = <span class="hljs-literal">NO</span>;
session.userName = <span class="hljs-string">@"myname"</span>;
session.password = <span class="hljs-string">@"secret"</span>;

[session connectToHost:<span class="hljs-string">@"192.168.0.1"</span> port:<span class="hljs-number">1883</span> usingSSL:<span class="hljs-literal">NO</span>];
</code></pre>
<p>启用SSL use a custom security</p>
<pre><code class="objc">NSString* certificate = [[NSBundle bundleForClass:[MQTTSession class]] pathForResource:@"certificate" ofType:@"cer"];
session.securityPolicy = [MQTTSSLSecurityPolicy policyWithPinningMode:MQTTSSLPinningModeCertificate];
session.securityPolicy.pinnedCertificates = @[ [NSData dataWithContentsOfFile:certificate] ];
session.securityPolicy.allowInvalidCertificates = YES;
[session connectToHost:@"192.168.0.1" port:8883 usingSSL:YES];

//Use  client certificates:
NSString *path = [[NSBundle bundleForClass:[MQTTClientTests class]] pathForResource:parameters[@„client"] ofType:@"p12"];

session.certificates = [MQTTSession clientCertsFromP12:path passphrase:@„secret“];

[session connectToHost:@"192.168.0.1" port:8883 usingSSL:YES];
</code></pre>
<pre><code class="objc">[session publishData:[<span class="hljs-string">@"Sample Data"</span> dataUsingEncoding:<span class="hljs-built_in">NSUTF8StringEncoding</span>]
    topic:<span class="hljs-string">@"example/data"</span>
    <span class="hljs-keyword">retain</span>:<span class="hljs-literal">NO</span>
    qos:<span class="hljs-number">0</span>];
[session subscribeToTopic:<span class="hljs-string">@"example/#"</span> atLevel:<span class="hljs-number">2</span>]; <span class="hljs-comment">//atLevel is QoS level</span>
[session unsubscribeTopic:<span class="hljs-string">@"example/#"</span>];
[session close];
</code></pre>
<p>Demo: <a href="https://github.com/ckrey/MQTTChat" target="_blank" rel="noopener">https://github.com/ckrey/MQTTChat</a></p>
<h4 id="nodejs" class="heading-control">Nodejs<a class="heading-anchor" href="#nodejs" aria-hidden="true"></a></h4>
<pre><code>npm install mqtt
</code></pre>
<p><a href="https://github.com/mqttjs/MQTT.js" target="_blank" rel="noopener">https://github.com/mqttjs/MQTT.js</a></p>
<pre><code class="coffee">mqtt = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mqtt'</span>)
<span class="hljs-comment"># 如果是websocket,对于emqtt必须加 path: '/mqtt'</span>
<span class="hljs-comment"># client  = mqtt.connect('ws://127.0.0.1:8083', path: '/mqtt', clientId: 'MQTTCLI1', clean:false,username:'',password:'')</span>

client  = mqtt.connect(<span class="hljs-string">'mqtt://127.0.0.1'</span>, clientId: <span class="hljs-string">'MQTTCLI1'</span>, clean:<span class="hljs-literal">false</span>,username:<span class="hljs-string">''</span>,password:<span class="hljs-string">''</span>)

client.<span class="hljs-literal">on</span> <span class="hljs-string">'connect'</span>, <span class="hljs-function">-&gt;</span>
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'connect'</span>)
  client.subscribe <span class="hljs-string">'presence'</span>, <span class="hljs-function"><span class="hljs-params">(err, granted)</span>-&gt;</span>
    <span class="hljs-keyword">return</span> client.end() <span class="hljs-keyword">if</span> err
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">'subscribe ok'</span>, granted
    <span class="hljs-comment"># client.publish 'presence', 'Hello mqtt', (err)-&gt;</span>
    <span class="hljs-comment">#   console.log 'publish'</span>
    <span class="hljs-comment">#   console.log 'pub', err if err</span>

client.<span class="hljs-literal">on</span> <span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">(error)</span>-&gt;</span>
  <span class="hljs-built_in">console</span>.log error

<span class="hljs-comment"># received messages:</span>
client.<span class="hljs-literal">on</span> <span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-params">(topic, message)</span>-&gt;</span>
  <span class="hljs-comment"># message is Buffer</span>
  <span class="hljs-built_in">console</span>.log(topic, message.toString())
  <span class="hljs-comment"># client.end()</span>
</code></pre>
<p>SSL:</p>
<pre><code class="js"><span class="hljs-keyword">var</span> mqtt = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mqtt'</span>)
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
<span class="hljs-keyword">var</span> KEY = fs.readFileSync(path.join(__dirname, <span class="hljs-string">'/tls-key.pem'</span>))
<span class="hljs-keyword">var</span> CERT = fs.readFileSync(path.join(__dirname, <span class="hljs-string">'/tls-cert.pem'</span>))
<span class="hljs-keyword">var</span> TRUSTED_CA_LIST = fs.readFileSync(path.join(__dirname, <span class="hljs-string">'/crt.ca.cg.pem'</span>))

<span class="hljs-keyword">var</span> PORT = <span class="hljs-number">8443</span>
<span class="hljs-keyword">var</span> HOST = <span class="hljs-string">'stark'</span>

<span class="hljs-keyword">var</span> options = {
  <span class="hljs-attr">port</span>: PORT,
  <span class="hljs-attr">host</span>: HOST,
  <span class="hljs-attr">key</span>: KEY,
  <span class="hljs-attr">cert</span>: CERT,
  <span class="hljs-attr">rejectUnauthorized</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-comment">// The CA list will be used to determine if server is authorized</span>
  <span class="hljs-attr">ca</span>: TRUSTED_CA_LIST
}

<span class="hljs-keyword">var</span> client = mqtt.connect(options)

client.subscribe(<span class="hljs-string">'messages'</span>)
client.publish(<span class="hljs-string">'messages'</span>, <span class="hljs-string">'Current time is: '</span> + <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>())
client.on(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">topic, message</span>) </span>{
  <span class="hljs-built_in">console</span>.log(message)
})

client.on(<span class="hljs-string">'connect'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Connected'</span>)
})
</code></pre>
<p>Demo: <a href="https://github.com/mqttjs/MQTT.js/tree/master/examples" target="_blank" rel="noopener">https://github.com/mqttjs/MQTT.js/tree/master/examples</a><br>
Using mqtt as iOS push mechanism without APNS: <a href="https://github.com/Guou/Demo-mqtt-push" target="_blank" rel="noopener">https://github.com/Guou/Demo-mqtt-push</a></p>
]]></content>
      <categories>
        <category>Thinking</category>
        <category>Architecture</category>
        <category>MQTT</category>
      </categories>
      <tags>
        <tag>mqtt</tag>
        <tag>network</tag>
        <tag>pubsub</tag>
        <tag>push</tag>
        <tag>message</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu Tips</title>
    <url>/article/ubuntu-tips/</url>
    <content><![CDATA[<h1 id="ubuntu-16-10" class="heading-control">Ubuntu 16.10<a class="heading-anchor" href="#ubuntu-16-10" aria-hidden="true"></a></h1>
<p>Ubuntu 现在基本可以替代Windows做日常使用的主力——只要不玩游戏。不过对SSD还是要需要调教一二。使用 Linux 还有一个好处是可以自带策略路由，对于域名IP流量精确转发，变得so easy。</p>
<p>这里记录下 Ubuntu 16.10 以上版本的安装tips.</p>
<h2 id="shell" class="heading-control">Shell<a class="heading-anchor" href="#shell" aria-hidden="true"></a></h2>
<p>我比较习惯 zsh, 下载安装zsh:</p>
<pre><code class="bash">$&gt; sudo apt install zsh
$&gt; sh -c <span class="hljs-string">"<span class="hljs-variable">$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)</span>"</span>
$&gt; <span class="hljs-built_in">echo</span> <span class="hljs-string">"source <span class="hljs-variable">$HOME</span>/.profile"</span> &gt;&gt; ~/.zshrc
$&gt; chsh /usr/bin/zsh
$&gt; <span class="hljs-built_in">echo</span> <span class="hljs-string">"export LC_ALL=en_US.UTF-8"</span>&gt;&gt; ~/.profile
</code></pre>
<p>然后修改.zshrc文件，添加你自己的pulgins：</p>
<pre><code>plugins=(ubuntu git github git-flow cp systemd docker gem meteor rvm ruby perl python pip rsync sbt gradle nvm npm node coffee yarn go golang)
</code></pre>
<h2 id="ssd-ci-pan" class="heading-control">SSD 磁盘<a class="heading-anchor" href="#ssd-ci-pan" aria-hidden="true"></a></h2>
<p>SSD磁盘的挂载和使用需要一些小技巧来延长SSD的使用寿命。</p>
<h3 id="trim" class="heading-control">Trim<a class="heading-anchor" href="#trim" aria-hidden="true"></a></h3>
<p>SSD 磁盘挂载需要启用trim指令，Liunx的磁盘系统支持两类trim（但注意不是所有的磁盘系统都支持）。</p>
<ul>
<li>discard 参数: 持续 trim(删除立刻trim)</li>
<li>fstrim: 后台trim(定期cron.weekly中执行一次)</li>
</ul>
<table>
<thead>
<tr>
<th>File system</th>
<th>Continuous TRIM(discard option)</th>
<th>Periodic TRIM(fstrim)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ext3</td>
<td>No</td>
<td>?</td>
</tr>
<tr>
<td>Ext4</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>Btrfs</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>JFS</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>XFS</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>F2FS</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td>VFAT</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>ntfs-3g</td>
<td>No</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p>我自己用的是Ext4以及Btrfs(支持ssd参数优化)。另外如果是用笔记本的话，可以适当将写commit的时间延长（秒为单位）。添加<code>noatime</code>/<code>relatime</code>参数(在读取文件的时候禁止/减少写入)以便于提升SSD的读取性能（尽管Linux内核2.6.30以上为默认）。</p>
<pre><code class="bash">✗ cat /etc/fstab
<span class="hljs-comment"># /etc/fstab: static file system information.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Use 'blkid' to print the universally unique identifier for a</span>
<span class="hljs-comment"># device; this may be used with UUID= as a more robust way to name devices</span>
<span class="hljs-comment"># that works even if disks are added and removed. See fstab(5).</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># &lt;file system&gt; &lt;mount point&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;</span>
UUID=XXXX-XXX-XXXX-XXX /               ext4    defaults,noatime,discard,commit=300,errors=remount-ro 0       1
UUID=XXXX-XXX-XXXX-XXX /home           btrfs   defaults,noatime,discard,commit=120,ssd 0       2
UUID=XXXXXX            /dos            ntfs    defaults,noatime,nls=utf8,uid=1000,gid=1000,commit=120 0       2
UUID=XXXX-XXXX         /boot/efi       vfat    defaults,noatime,<span class="hljs-built_in">umask</span>=0077      0       1
UUID=XXXX-XXX-XXXX-XXX none            swap    sw              0       0
</code></pre>
<p>注：</p>
<ul>
<li>查看磁盘分区的UUID,使用<code>blkid</code>指令。</li>
<li>启用<code>dicard</code>参数可能会牺牲一点ssd写入的速度。<br>
× <code>/boot/efi</code>几乎不会被写，别加discard,否则可能引发故障</li>
</ul>
<p>启用trim前，请务必检查自己的ssd（尤其是2010年前的）是否支持trim,否则可能会造成数据丢失，使用<code>lsblk</code>指令：</p>
<pre><code class="bash"><span class="hljs-comment">#&gt; lsblk -D</span>
NAME        DISC-ALN DISC-GRAN DISC-MAX DISC-ZERO
nvme0n1          512      512B       2T         0
├─nvme0n1p1        0      512B       2T         0
├─nvme0n1p2        0      512B       2T         0
</code></pre>
<p>如果 <code>DISC-GRAN</code> 和 <code>DISC-MAX</code> 列的值<code>非0</code>就表示支持trim.</p>
<h3 id="xian-zhi-jiao-huan-fen-qu" class="heading-control">限制交换分区<a class="heading-anchor" href="#xian-zhi-jiao-huan-fen-qu" aria-hidden="true"></a></h3>
<p>Linux使用交换文件的趋向由一个数值(swappiness)来控制，设置数值越低，需要更多的系统负载来启用交换分区。该值在0-100之间，默认为60，对于桌面应用来说太高了，仅仅适用与服务器。而对于SSD就太糟糕了。</p>
<p>查看当前的<code>swappiness</code>设置：</p>
<pre><code class="bash">$&gt; cat /proc/sys/vm/swappiness
60
</code></pre>
<p>然后修改： /etc/sysctl.conf 文件，增加：</p>
<pre><code># Sharply reduce the inclination to swap
vm.swappiness=10
</code></pre>
<h3 id="qi-yong-tmp-mu-lu-ram-pan" class="heading-control">启用/tmp目录RAM盘<a class="heading-anchor" href="#qi-yong-tmp-mu-lu-ram-pan" aria-hidden="true"></a></h3>
<pre><code class="bash">sudo cp /usr/share/systemd/tmp.mount /etc/systemd/system/tmp.mount
sudo systemctl <span class="hljs-built_in">enable</span> tmp.mount
sudo systemctl start tmp.mount
</code></pre>
<h2 id="dnsmasq" class="heading-control">dnsmasq<a class="heading-anchor" href="#dnsmasq" aria-hidden="true"></a></h2>
<p>ubuntu自带，用于域名解析，并且是自动加在 /etc/resolve.conf中（127.0.1.1）是随NetworkManager启动的，dnsmasq的配置在 /etc/NetworkManager/dnsmasq.d/<br>
需要加上对上游DNS服务器的查询，否则你可能会发现DOMAIN NOT FOUND：</p>
<pre><code class="bash">$&gt;cat /etc/resolv.dnsmasq.conf
<span class="hljs-comment"># Google's nameservers, for example</span>
nameserver 8.8.8.8
nameserver 8.8.4.4

$&gt;cat /etc/NetworkManager/dnsmasq.d/resolv.conf
resolv-file=/etc/resolv.dnsmasq.conf

<span class="hljs-comment">#启用 /etc/hosts</span>
$&gt;cat /etc/NetworkManager/dnsmasq.d/host.conf
addn-hosts=/etc/hosts

$&gt;sudo systemctl restart NetworkManager
</code></pre>
<h2 id="ipset" class="heading-control">ipset<a class="heading-anchor" href="#ipset" aria-hidden="true"></a></h2>
<p>ipset 配合 iptables 可实现基于域名的策略路由。</p>
<p>ipset 可以将一组ip放入到一个集合中供iptables进行处理。这样可以很好的解决大量ip规则的匹配性能问题。</p>
<p>当然，首先你要安装: <code>sudo apt install ipset</code></p>
<h3 id="hei-ming-dan-fang-shi" class="heading-control">黑名单方式<a class="heading-anchor" href="#hei-ming-dan-fang-shi" aria-hidden="true"></a></h3>
<p>Dnsmasq 从 2.66 版本之后就支持将域名的查询结果放进 ipset 中，这样就可以对这些域名对应的 IP<br>
使用 iptables 处理。</p>
<p>只转发名单内的IP, 可以配合gfwlist对指定的域名IP做重定向处理</p>
<p>下载: <a href="https://github.com/cokebar/gfwlist2dnsmasq/releases" target="_blank" rel="noopener">gfwlist_ipset.conf</a>文件，放在: /etc/NetworkManager/dnsmasq.d/ 目录中即可。</p>
<p>你需要修改文件中的域名服务器地址，最简单的方法是在代理服务器上自建一个域名服务器（用非标准端口）。</p>
<pre><code class="yaml"><span class="hljs-comment">#使用不受污染干扰的DNS解析该域名 可以将此IP改为自己使用的DNS服务器</span>
<span class="hljs-string">server=/google.com/127.0.0.1#5353</span>
<span class="hljs-comment">#将解析出来的IP保存到名为gfwlist的ipset表中</span>
<span class="hljs-string">ipset=/google.com/gfwlist</span>
</code></pre>
<p>或者，你可以<a href="https://github.com/cokebar/gfwlist2dnsmasq" target="_blank" rel="noopener">下载执行这个脚本</a>自动抓取gfwlist转换为：dnsmasq_gfwlist_ipset.conf</p>
<pre><code class="bash">$&gt; sudo bash gfwlist2dnsmasq.sh -d your-dns-server-ip -p your-dns-server-port -s gfwlist  -f /etc/NetworkManager/dnsmasq.d/gfwlist_ipset.conf
</code></pre>
<p>然后创建<code>gfwlist</code>ipset规则集:</p>
<pre><code class="bash">ipset -N gfwlist <span class="hljs-built_in">hash</span>:ip
</code></pre>
<h3 id="bai-ming-dan-fang-shi" class="heading-control">白名单方式<a class="heading-anchor" href="#bai-ming-dan-fang-shi" aria-hidden="true"></a></h3>
<p>收集国内IP，除了国内IP放行外，其它IP一律转发。</p>
<ul>
<li>获取国内 IP 列表</li>
</ul>
<p>接下来我们需要获取中国的 IP 列表。这里我们放在了 <code>~/chnroute/</code>目录下：</p>
<pre><code class="bash">CHNROUTE_DIR=<span class="hljs-variable">$HOME</span>/chnroute
mkdir <span class="hljs-variable">$CHNROUTE_DIR</span>
curl <span class="hljs-string">'http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest'</span> | grep ipv4 | grep CN | awk -F\| <span class="hljs-string">'{ printf("%s/%d\n", $4, 32-log($5)/log(2)) }'</span> &gt; <span class="hljs-variable">$CHNROUTE_DIR</span>/chnroute.txt
</code></pre>
<p>这是来自 <a href="https://github.com/shadowsocks/ChinaDNS" target="_blank" rel="noopener">ChinaDNS</a> 的指令。</p>
<p>创建ipset并导入：</p>
<pre><code class="bash"><span class="hljs-meta">#!/bin/bash
</span>
<span class="hljs-comment"># Setup the ipset</span>
ipset -N chnroute <span class="hljs-built_in">hash</span>:net maxelem 65536

<span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> $(cat <span class="hljs-string">'$HOME/chnroute/chnroute.txt'</span>); <span class="hljs-keyword">do</span>
  ipset add chnroute <span class="hljs-variable">$ip</span>
<span class="hljs-keyword">done</span>
</code></pre>
<p>注意：这里<code>ipset类型</code>必须是hash:net,而不是hash:ip。因为 chnroute.txt 是一个 IP 段列表，而中国持有的 IP 数量巨大，所以如果使用 hash:ip 来导入会内存溢出。</p>
<h2 id="shadowsocks-libev" class="heading-control">shadowsocks-libev<a class="heading-anchor" href="#shadowsocks-libev" aria-hidden="true"></a></h2>
<pre><code>apt install shadowsocks-libev
</code></pre>
<pre><code class="bash">$&gt; cat /etc/shadowsocks-libev/config.json
{
    <span class="hljs-string">"server"</span>:<span class="hljs-string">"[123.22.33.13]"</span>, <span class="hljs-comment"># your shadowsocks server ip</span>
    <span class="hljs-string">"server_port"</span>:1293,
    <span class="hljs-string">"local_port"</span>:1080,
    <span class="hljs-string">"password"</span>:<span class="hljs-string">"12345"</span>,
    <span class="hljs-string">"timeout"</span>:60,
    <span class="hljs-string">"method"</span>:<span class="hljs-string">"aes-256-cfb"</span>
}
</code></pre>
<p>启用 shadowsocks-libev.service 之前，需要做些修改，将服务改为透明转发<code>ss-redir</code>：</p>
<pre><code class="bash">$&gt;cat /lib/systemd/system/shadowsocks-libev.service
[Service]
Type=simple
EnvironmentFile=/etc/default/shadowsocks-libev
User=root
LimitNOFILE=32768
<span class="hljs-comment"># modify ss-server to ss-redir</span>
ExecStart=/usr/bin/ss-redir -a <span class="hljs-variable">$USER</span> -c <span class="hljs-variable">$CONFFILE</span> <span class="hljs-variable">$DAEMON_ARGS</span>

$&gt;systemctl <span class="hljs-built_in">enable</span> shadowsocks-libev
$&gt;systemctl daemon-reload
$&gt;systemctl start shadowsocks-libev
</code></pre>
<h2 id="iptables" class="heading-control">iptables<a class="heading-anchor" href="#iptables" aria-hidden="true"></a></h2>
<p>下面开始在iptables上做转发：</p>
<p>首先为shadowsocks创建NAT表:</p>
<pre><code class="bash"><span class="hljs-comment"># create a nat named SHADOWSOCKS:</span>
iptables -t nat -N SHADOWSOCKS

<span class="hljs-comment"># Ignore your shadowsocks server's addresses</span>
<span class="hljs-comment"># It's very IMPORTANT, just be careful.</span>
iptables -t nat -A SHADOWSOCKS -d [your-shadowsocks-server-ip] -j RETURN

<span class="hljs-comment"># 忽略局域网：</span>
<span class="hljs-comment"># Ignore LANs and any other addresses you'd like to bypass the proxy</span>
<span class="hljs-comment"># See Wikipedia and RFC5735 for full list of reserved networks.</span>
<span class="hljs-comment"># See ashi009/bestroutetb for a highly optimized CHN route list.</span>
iptables -t nat -A SHADOWSOCKS -d 0.0.0.0/8 -j RETURN
iptables -t nat -A SHADOWSOCKS -d 10.0.0.0/8 -j RETURN
iptables -t nat -A SHADOWSOCKS -d 127.0.0.0/8 -j RETURN
iptables -t nat -A SHADOWSOCKS -d 169.254.0.0/16 -j RETURN
iptables -t nat -A SHADOWSOCKS -d 172.16.0.0/12 -j RETURN
iptables -t nat -A SHADOWSOCKS -d 192.168.0.0/16 -j RETURN
iptables -t nat -A SHADOWSOCKS -d 224.0.0.0/4 -j RETURN
iptables -t nat -A SHADOWSOCKS -d 240.0.0.0/4 -j RETURN
</code></pre>
<h3 id="hei-ming-dan" class="heading-control">黑名单<a class="heading-anchor" href="#hei-ming-dan" aria-hidden="true"></a></h3>
<pre><code class="bash"><span class="hljs-comment"># Anything matched gfwlist ipset should be redirected to shadowsocks's local port</span>
iptables -t nat -A SHADOWSOCKS -p tcp -m <span class="hljs-built_in">set</span> --match-set gfwlist dst -j REDIRECT --to-ports 1080
<span class="hljs-comment"># Apply the rules</span>
iptables -t nat -A OUTPUT -p tcp -j SHADOWSOCKS
</code></pre>
<h3 id="bai-ming-dan" class="heading-control">白名单<a class="heading-anchor" href="#bai-ming-dan" aria-hidden="true"></a></h3>
<pre><code class="bash"><span class="hljs-comment"># Allow connection to chinese IPs</span>
iptables -t nat -A SHADOWSOCKS -p tcp -m <span class="hljs-built_in">set</span> --match-set chnroute dst -j RETURN

<span class="hljs-comment"># Others Redirect to Shadowsocks</span>
iptables -t nat -A SHADOWSOCKS -p tcp -j REDIRECT --to-port 1080

<span class="hljs-comment"># Apply the rules</span>
iptables -t nat -A OUTPUT -p tcp -j SHADOWSOCKS
</code></pre>
<h3 id="qing-chu-iptables-gui-ze" class="heading-control">清除iptables规则<a class="heading-anchor" href="#qing-chu-iptables-gui-ze" aria-hidden="true"></a></h3>
<pre><code class="bash"><span class="hljs-meta">#!/bin/bash
</span>
iptables -t nat -D OUTPUT -p tcp -j SHADOWSOCKS
iptables -t nat -F SHADOWSOCKS
iptables -t nat -X SHADOWSOCKS

<span class="hljs-comment"># 如果是黑名单:</span>
ipset destroy gfwlist
<span class="hljs-comment"># 如果是白名单:</span>
ipset destroy chnroute
</code></pre>
]]></content>
      <categories>
        <category>Linux</category>
        <category>Ubuntu</category>
      </categories>
      <tags>
        <tag>network</tag>
        <tag>linux</tag>
        <tag>ubuntu</tag>
        <tag>dnsmasq</tag>
        <tag>iptables</tag>
        <tag>iproute2</tag>
        <tag>dns</tag>
        <tag>ipset</tag>
        <tag>shadowsocks</tag>
      </tags>
  </entry>
  <entry>
    <title>SaaS平台之殇</title>
    <url>/article/open-saas/</url>
    <content><![CDATA[<h1 id="saas-ping-tai-zhi-shang" class="heading-control">SaaS平台之殇<a class="heading-anchor" href="#saas-ping-tai-zhi-shang" aria-hidden="true"></a></h1>
<h2 id="bei-jing" class="heading-control">背景<a class="heading-anchor" href="#bei-jing" aria-hidden="true"></a></h2>
<p>商业应用的集中式托管可以追溯到20世纪60年代的时分系统中。SaaS通常使用多租架构为多个商业组织和用户提供服务。</p>
<p>在多租环境中的相对低廉的用户服务开通（创建新客户），使得一些软件即服务供应商可以用免费模式来提供应用。在这种模式下，基本功能免费，增强功能或更大的范围则是要收费的。当然，也有完全对用户完全免费的SaaS，而他们的收入则产生于其它相关来源例如：广告。</p>
<p>SaaS的本质是将规模经济应用到软件应用的运营上。故其规模决定了其发展。而影响企业用户决定是否采用SaaS的一个最关键因素就是<code>数据</code>。</p>
<h2 id="shang-wen-ti" class="heading-control">殇 - 问题<a class="heading-anchor" href="#shang-wen-ti" aria-hidden="true"></a></h2>
<p>数据的安全，以及数据的归属（政策法规上的搜索/占有保障法律并不保护服务存储的数据）。最终导致结果是，对数据的访问，以及进一步的对该数据的不当使用，仅仅由假定是诚信的第三方或他们自己的承诺书来限制（你没法知道他们到底是否违背了他们的承诺）。</p>
<ul>
<li>数据安全</li>
<li>数据实际属于SaaS服务提供商</li>
<li>服务终止</li>
<li>数据滥用:
<ul>
<li>供应商工作/研发人员可以任意浏览/修改数据。</li>
<li>代码漏洞或后门</li>
</ul>
</li>
<li>数据丢失或篡改
<ul>
<li><a href="http://www.rainstor.com/assets/downloads/SaaS_Data_Escrow_International_Report.pdf" target="_blank" rel="noopener">Clearpace Software Ltd. 发起的研究</a>显示85%的参与者想要获得他们的软件即服务数据的一个副本。<br>
1/3的这些参与者想要每天获取一份副本。</li>
</ul>
</li>
<li>供应商破产</li>
<li>用户无知情权，监督权，数据归属权</li>
</ul>
<p>愚以上为制约SaaS发展规模的主要原因。</p>
<h2 id="kai-yuan-saas-ping-tai" class="heading-control">开源 SaaS 平台<a class="heading-anchor" href="#kai-yuan-saas-ping-tai" aria-hidden="true"></a></h2>
<p>借助开源 SaaS 平台联盟，借助最新的技术手段，借助开源社区的监督和研发，可以做到：</p>
<ul>
<li>无后门</li>
<li>更安全</li>
<li>更大程度限制运营人员</li>
<li>保障用户的知情权，监督权，数据归属权</li>
<li>规模集约化运营</li>
</ul>
<p><img src="./alliance-platform-rule.png" alt="alliance-platform-rule"></p>
]]></content>
      <categories>
        <category>Thinking</category>
        <category>Cloud Computing</category>
        <category>SaaS</category>
      </categories>
      <tags>
        <tag>cloud computing</tag>
        <tag>open source</tag>
        <tag>saas</tag>
        <tag>software as a service</tag>
      </tags>
  </entry>
  <entry>
    <title>Coffee Style Computer Language</title>
    <url>/article/coffee-style-computer-language/</url>
    <content><![CDATA[<h2 id="coffee-style-smart-computer-language" class="heading-control">Coffee Style Smart Computer Language<a class="heading-anchor" href="#coffee-style-smart-computer-language" aria-hidden="true"></a></h2>
<p>I treat the coffee-script and <code>Literate CoffeeScript</code> as the first <code>coffee style</code> smart computer language concept.<br>
This should be the basics of the next generation Smart Computer Language.</p>
<p>Features:</p>
<ul>
<li>Space indents for block, the curly braces are optional.</li>
<li>The brackets are optional for function revocation.</li>
<li>The array, object(dict) assignment could be no comma, instead of using the block.</li>
<li>The functional expression definition could be ‘-&gt;’ or ‘=&gt;’.</li>
<li>Smart variable definition
<ul>
<li>It should be a compiler switcher.</li>
<li>The first variable assignment will be declared if no the same name variable before.</li>
</ul>
</li>
<li>RTL(run-time library) replace-able.
<ul>
<li>you can write your own <code>extends</code>, <code>for in</code> etc rtl functions.</li>
</ul>
</li>
</ul>
<p>Pros:</p>
<ul>
<li>More Natural Readable for humans</li>
<li>More humane intelligence</li>
<li>Functional</li>
</ul>
<p>Cons:</p>
<ul>
<li>
<p>Ambiguity: The Human statement as possible ambiguity. eg,</p>
<p>I saw a man on a hill with a telescope.</p>
<ul>
<li>It seems like a simple statement, until you begin to unpack the many alternate meanings:
<ul>
<li>There’s a man on a hill, and I’m watching him with my telescope.</li>
<li>There’s a man on a hill, who I’m seeing, and he has a telescope.</li>
<li>There’s a man, and he’s on a hill that also has a telescope on it.</li>
<li>I’m on a hill, and I saw a man using a telescope.</li>
<li>There’s a man on a hill, and I’m sawing him with a telescope.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Smart man used only(the stupid is difficult to use)</p>
<ul>
<li>the man should have a mindset always. So you have got a big trouble if you can not recognize the ambiguity of some statement.</li>
<li>the smart variable definition should be care too.</li>
</ul>
</li>
</ul>
<p>Most languages could be transformed into a similar coffee style.</p>
<p>The previous generation computer language is very mechanical and rigid.<br>
It’s strictly limited, even missing a semicolon would raise an error.</p>
<h2 id="language-reference" class="heading-control">Language Reference<a class="heading-anchor" href="#language-reference" aria-hidden="true"></a></h2>
<h3 id="functions" class="heading-control">Functions<a class="heading-anchor" href="#functions" aria-hidden="true"></a></h3>
<pre><code class="coffee"><span class="hljs-function"><span class="hljs-title">square</span> = <span class="hljs-params">(x)</span> -&gt;</span> x * x
cube   :integer = <span class="hljs-function"><span class="hljs-params">(x: integer)</span> -&gt;</span> square(x) * x
fill   :string  = <span class="hljs-function"><span class="hljs-params">(container: string, liquid: string = <span class="hljs-string">"coffee"</span>)</span> -&gt;</span>
  <span class="hljs-string">"Filling the <span class="hljs-subst">#{container}</span> with <span class="hljs-subst">#{liquid}</span>..."</span>
</code></pre>
<p>The return and argument type should be optional for the types could be inferred.</p>
<p>The following is the C language transform:</p>
<pre><code class="c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">square</span><span class="hljs-params">(<span class="hljs-keyword">int</span> x)</span> </span>{<span class="hljs-keyword">return</span> x*x;}
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">cube</span><span class="hljs-params">(<span class="hljs-keyword">int</span> x)</span>   </span>{<span class="hljs-keyword">return</span> square(x)*x;}
<span class="hljs-function"><span class="hljs-keyword">char</span>* <span class="hljs-title">fill</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* container, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* liquid)</span> </span>{
  <span class="hljs-keyword">if</span> (!liquid) liquid = <span class="hljs-string">"coffee"</span>;
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* fmt = <span class="hljs-string">"Filling the %s with %s..."</span>;
  <span class="hljs-keyword">int</span> sz = <span class="hljs-built_in">snprintf</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, fmt, container, liquid);
  <span class="hljs-keyword">char</span>* result = <span class="hljs-built_in">malloc</span>(sz+<span class="hljs-number">1</span>);
  <span class="hljs-built_in">snprintf</span>(result, sz+<span class="hljs-number">1</span>, fmt, container, liquid);
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
]]></content>
      <categories>
        <category>Thinking</category>
        <category>Programming</category>
      </categories>
      <tags>
        <tag>thinking</tag>
        <tag>programming</tag>
        <tag>language</tag>
        <tag>tech</tag>
      </tags>
  </entry>
  <entry>
    <title>逝水流连，随风而去</title>
    <url>/life/index/</url>
    <content><![CDATA[<p>生活，生命，活着的，一切都将随风而去。冬去春来，夏过秋至，金黄的树叶悠悠飘落，一片片，散落，逝水流连，周而复始。生存，成长，老去，逝去。我们追逐的，梦想的，转眼，一切都将成空。在这“<a href="https://zh.wikipedia.org/wiki/%E6%98%93%E7%BB%8F" target="_blank" rel="noopener">《易》</a>”的世界里面，永恒不变的唯有<code>易</code>。</p>
<p><strong>我们</strong>都只是那短短的人生过客啊，观察，体验着这人生百态，感悟着不一样的人生，也许。随波逐流的人啊，活着只是活着的人啊，活在别人的目光中的人啊，你们在感悟什么，人，这，一辈子，到底该如何度过。生存的需求，物质的需求，财富的需求，有没有尽头，你在追寻什么？到底追寻的意义是什么，对你？我不知道，对于我而言，<strong>思想</strong> 也许是我能留给你的最宝贵的财富，余者皆浮云矣。人与人最最关键，重要的区别就是<strong>思想</strong>。</p>
<p>就在这个目录里。当一切随风而去，唯有<strong>思想</strong>留下…</p>
]]></content>
      <categories>
        <category>Life</category>
      </categories>
      <tags>
        <tag>thinking</tag>
        <tag>life</tag>
        <tag>人生感悟</tag>
      </tags>
  </entry>
  <entry>
    <title>The Loopback Open API Framework</title>
    <url>/article/loopback/</url>
    <content><![CDATA[<h1 id="loopback-framework" class="heading-control">Loopback Framework<a class="heading-anchor" href="#loopback-framework" aria-hidden="true"></a></h1>
<p>尽管我不怎么欣赏它的内部实现，但是不得不说这是Open API开发框架的又一次创新，使得开发API的过程更为简单和易用。<br>
<a href="http://loopback.io" target="_blank" rel="noopener">LoopBack</a> 是一个基于<a href="http://expressjs.com/" target="_blank" rel="noopener">Express</a>的开源 Node.js API框架，用于快速构建自己的OpenAPI平台，提供API接口给mobile, web和其他设备。它能够同时连接多种不同的数据源，非常简单的暴露model为标准的RESTful API，用nodejs 开发API，提供JS, iOS 和 Android SDKs.</p>
<p><a href="https://strongloop.com" target="_blank" rel="noopener">StrongLoop</a>在2015年<a href="https://developer.ibm.com/bluemix/2015/09/10/getting-started-node-js-loopback-framework-ibm-cloudant/" target="_blank" rel="noopener">被IBM收购了</a>.</p>
<h2 id="features" class="heading-control">Features<a class="heading-anchor" href="#features" aria-hidden="true"></a></h2>
<ul>
<li>快速创建动态 end-to-end REST APIs.</li>
<li>连接设备/浏览器到数据和服务。</li>
<li>使用 Android, iOS, and AngularJS SDKs 轻松创建客户端应用.</li>
<li>提供 push, 文件管理, 第三方登录, 以及 geolocation 的附加组件.</li>
<li>使用 <code>StrongLoop Arc</code> IDE 可视化的编辑，部署和监视 LoopBack API服务.</li>
<li>StrongLoop API网关充当API消费者与API提供者之间的中介，进行外部化的安全管理API。</li>
<li>可以部署运行在内部或者云端</li>
</ul>
<h2 id="install" class="heading-control"><a href="https://docs.strongloop.com/display/SL/Installing+StrongLoop" target="_blank" rel="noopener">Install</a><a class="heading-anchor" href="#install" aria-hidden="true"></a></h2>
<p>安装前提：use the latest LTS (long-term support) release of Node.js(v4.x).</p>
<pre><code class="bash">npm install -g strongloop
</code></pre>
<h2 id="chuang-jian-loopback-ying-yong" class="heading-control">创建 loopback 应用<a class="heading-anchor" href="#chuang-jian-loopback-ying-yong" aria-hidden="true"></a></h2>
<p>由 loopback <code>slc</code>脚手架工具，我们可以轻松的完成许多工作。包括创建应用，model，relation，acl等等。</p>
<pre><code>$ slc loopback
[?] What's the name of your application? hello-world
  create hello-world/
  info change the working directory to hello-world
  I'm all done. Running npm install for you to install
  the required dependencies.
$ slc loopback:model
[?] Enter the model name: person
[?] Select the data-source to attach person to: db (memory)
[?] Select model`s base class (PersistedModel)
[?] Expose person via the REST API? Yes
[?] Custom plural form (used to build REST URL): people
[?] Common model or server only? common
Let's add some person properties now.
</code></pre>
<p>参阅官方的入门指南： <a href="http://loopback.io/getting-started/" target="_blank" rel="noopener">Getting Started</a>.</p>
<p>在本地运行 <code>StrongLoop Arc</code> IDE：</p>
<pre><code class="bash">PORT=4000 HOST=0.0.0.0 slc arc
</code></pre>
<p>在IDE上只需要简单的设置数据源和model，就可以将指定的数据作为Restful API提供出去了。</p>
<p>注意IDE要求在 Strongloop 上注册方可使用。</p>
<p><img src="./strongloop-arc.png" alt></p>
<p>skip the online login:</p>
<p><code>%HOME%/AppData/Roaming/npm/node_modules/strongloop/node_modules/strong-arc/clinet/www/scripts/modules/arc-user/arc-user.service.js</code>:</p>
<pre><code class="js">    svc.getCurrentUserId = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-comment">//return $cookieStore.get('currentUserId');</span>
      <span class="hljs-keyword">return</span> <span class="hljs-number">12</span>;
    };
</code></pre>
<p>当你在IDE上设置添加并暴露出数据 model 后，就可以在IDE上直接运行。你可以在这个地址: <a href="http://localhost:3000/explorer/" target="_blank" rel="noopener">http://localhost:3000/explorer/</a> 上查看产生的API的联机互动文档：</p>
<p><img src="./loopback-explorer.png" alt></p>
<p>另外在IDE上可以直接启动，停止服务。</p>
<p>事实上，就<a href="https://zh.wikipedia.org/zh/MVC" target="_blank" rel="noopener">MVC模式</a>而言，<code>Loopback</code>的应用一般不用关心<code>Controller</code>，所有的操作（远程方法）都直接在Model上暴露和控制，进一步简化了开发。因为是 API，所以<code>View</code>也不用关心，只需要在配置中定义支持的输出格式(json, xml)。</p>
<p>Ok, 接下来以开发一个简单的博客API系统为例，进行说明。本例子修改自<a href="https://github.com/topcoderinc/TopBlogger-Loopback" target="_blank" rel="noopener">TopBlogger-Loopback</a>，特此说明。</p>
<p>首先该博客系统有两个 model: Blog 和 Comment。我们使用loopback内置的用户体系进行登陆认证，当然你可以扩展这个用户体系。这些 Model 的关系如下：</p>
<ul>
<li>一篇博文(Blog)属于一个用户(User)</li>
<li>一篇博文可以有许多评论(Comment)</li>
<li>一篇评论(Comment)属于一个用户(User)</li>
</ul>
<p>就认证授权来说，匿名用户只能看博文或者评论，不能发表。只有登录的用户才可以发表博文或者评论，并且只可以编辑或者删除自己的博文或评论。</p>
<p>首先你要选择一个你希望使用的数据库，loopback支持如下的数据库：</p>
<ul>
<li><a href="https://docs.strongloop.com/display/LB/Memory+connector" target="_blank" rel="noopener">Memory connector</a>：内置</li>
<li><a href="https://docs.strongloop.com/display/LB/MongoDB+connector" target="_blank" rel="noopener">MongoDB connector</a>：loopback-connector-mongodb</li>
<li><a href="https://docs.strongloop.com/display/LB/MySQL+connector" target="_blank" rel="noopener">MySQL connector</a>：loopback-connector-mysql</li>
<li><a href="https://docs.strongloop.com/display/LB/PostgreSQL+connector" target="_blank" rel="noopener">PostgreSQL connector</a>：loopback-connector-postgresql</li>
<li><a href="https://docs.strongloop.com/display/LB/SQL+Server+connector" target="_blank" rel="noopener">SQL Server connector</a>：loopback-connector-mssql</li>
<li><a href="https://docs.strongloop.com/display/LB/DB2+connector" target="_blank" rel="noopener">DB2 connector</a>：loopback-connector-db2</li>
<li><a href="https://docs.strongloop.com/display/LB/Oracle+connector" target="_blank" rel="noopener">Oracle connector</a>：loopback-connector-oracle</li>
<li><a href="https://docs.strongloop.com/display/public/LB/Redis+connector" target="_blank" rel="noopener">Redis connector</a>:loopback-connector-redis</li>
<li><a href="https://docs.strongloop.com/display/LB/Cloudant+connector" target="_blank" rel="noopener">Cloudant connector</a>:loopback-connector-cloudant</li>
</ul>
<p>注意的是有的数据库支持还是处于EA(Early Access)状态，并不稳定要留意文档。</p>
<p>另外还有一些非数据库的Connector:</p>
<ul>
<li><a href="https://docs.strongloop.com/display/LB/Email+connector" target="_blank" rel="noopener">Email connector</a>：内置</li>
<li><a href="https://docs.strongloop.com/display/LB/Push+connector" target="_blank" rel="noopener">Push connector</a>: loopback-component-push</li>
<li><a href="https://docs.strongloop.com/display/LB/Remote+connector" target="_blank" rel="noopener">Remote connector</a>: loopback-connector-remote</li>
<li><a href="https://docs.strongloop.com/display/LB/REST+connector" target="_blank" rel="noopener">REST</a>: loopback-connector-rest</li>
<li><a href="https://docs.strongloop.com/display/LB/SOAP+connector" target="_blank" rel="noopener">SOAP</a>: loopback-connector-soap</li>
<li><a href="https://docs.strongloop.com/display/LB/Storage+connector" target="_blank" rel="noopener">Storage connector</a>: loopback-component-storage</li>
</ul>
<p>还有社区维护的Connector,<a href="https://docs.strongloop.com/display/public/LB/Community+connectors" target="_blank" rel="noopener">在这里</a>.</p>
<p>选择好数据库后，需要安装相应的数据库Connector组件，在项目的根目录下:</p>
<pre><code class="bash">npm install loopback-connector-mysql
</code></pre>
<p>使用<a href="https://docs.strongloop.com/display/LB/Data+source+generator" target="_blank" rel="noopener">data source generator</a>建立新的数据源。</p>
<h2 id="slc-loopback-datasource" class="heading-control">slc loopback:datasource<a class="heading-anchor" href="#slc-loopback-datasource" aria-hidden="true"></a></h2>
<pre><code>$ slc loopback:datasource
? Enter the data-source name: myBlogger
? Select the connector for mysql: MySQL (supported by StrongLoop)
</code></pre>
<p>这会在 <code>server/datasources.json</code>中增加新的数据源，然后打开该文件，修改相关数据库的登录认证信息：</p>
<pre><code class="json">{
  <span class="hljs-attr">"db"</span>:{
    <span class="hljs-attr">"name"</span>:<span class="hljs-string">"db"</span>,
    <span class="hljs-attr">"connector"</span>:<span class="hljs-string">"memory"</span>
  },
  <span class="hljs-attr">"myBlogger"</span>: {
      <span class="hljs-attr">"name"</span>: <span class="hljs-string">"myBlogger"</span>,
      <span class="hljs-attr">"connector"</span>: <span class="hljs-string">"mysql"</span>,
      <span class="hljs-attr">"host"</span>: <span class="hljs-string">"your-mysql-server.foo.com"</span>,
      <span class="hljs-attr">"user"</span>: <span class="hljs-string">"db-username"</span>,
      <span class="hljs-attr">"password"</span>: <span class="hljs-string">"db-password"</span>,
      <span class="hljs-attr">"database"</span>: <span class="hljs-string">"myblogger"</span>
  }
}
</code></pre>
<p>然后使用<a href="https://docs.strongloop.com/display/LB/Using+the+model+generator" target="_blank" rel="noopener">model generator</a>协助创建model</p>
<h2 id="slc-loopback-model" class="heading-control">slc loopback:model<a class="heading-anchor" href="#slc-loopback-model" aria-hidden="true"></a></h2>
<pre><code>slc loopback:model
? Enter the model name: Blog
? Select the data-source to attach Blog to: myBlogger (mysql)
? Select model's base class: PersistedModel
? Expose myModel via the REST API? Yes
? Custom plural form (used to build REST URL):
Let's add some properties now.
...
</code></pre>
<p>接下来提示是创建它的属性。然后用同样的方式创建Comment Model.</p>
<h3 id="blog-model" class="heading-control">Blog Model<a class="heading-anchor" href="#blog-model" aria-hidden="true"></a></h3>
<ul>
<li>title (string)</li>
<li>content (string)</li>
<li>tags (array of strings)</li>
<li>slug (string)</li>
<li>numOfUpVotes (number)</li>
<li>numOfDownVotes (number)</li>
<li>numOfViews (number)</li>
<li>upvotes (array of strings): userId 的数组</li>
<li>downvotes (array of strings): userId 的数组</li>
<li>isPublished (boolean)</li>
<li>createdDate (date)</li>
<li>updatedDate (date)</li>
</ul>
<h3 id="comment-model" class="heading-control">Comment Model<a class="heading-anchor" href="#comment-model" aria-hidden="true"></a></h3>
<ul>
<li>content (string)</li>
<li>numOfLikes (number)</li>
<li>numOfDislikes (number)</li>
<li>likes (array of strings): userId 的数组</li>
<li>dislikes (array of strings): userId 的数组</li>
<li>createdDate (date)</li>
<li>updatedDate (date)</li>
</ul>
<p>注意：</p>
<ul>
<li>隐藏字段可以用<code>hidden</code>参数，将不需要公开的字段名称列在这个数组中。</li>
<li>Model 有这样一些<a href="https://docs.strongloop.com/display/public/LB/Customizing+models" target="_blank" rel="noopener">定制设置</a>:
<ul>
<li>
<p><code>plural</code> - set to a custom string value to use, instead of the default standard plural form.</p>
</li>
<li>
<p><code>strict</code> - set to true to make the model save only instances that have the predefined set of properties.  Any additional properties in a save or update operation are not persisted to the data source.  False by default.</p>
</li>
<li>
<p><code>idInjection</code> - Whether to automatically add an id property to the model.  True by default.</p>
</li>
<li>
<p><code>http.path</code> - customized HTTP path of REST endpoints.</p>
</li>
<li>
<p><code>indexes</code> - 可以设置字段的复合索引，不过注意的是采用官方文档进行设置的时候，Mysql的connector会报错，只能这样设置:</p>
<pre><code class="js"><span class="hljs-string">"indexes"</span>: {
  <span class="hljs-string">"some_name_age_index"</span>: {
    <span class="hljs-string">"columns"</span>: <span class="hljs-string">"name, age"</span>, <span class="hljs-comment">//不能使用keys，会报告: Key column 'undefined' doesn't exist in table</span>
    <span class="hljs-string">"options"</span>: {
      <span class="hljs-string">"unique"</span>: <span class="hljs-literal">true</span>
    }
  }
</code></pre>
</li>
<li>
<p>对于字段单个索引，可以直接写在字段中：</p>
<pre><code class="js">  <span class="hljs-string">"name"</span>: {
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
    <span class="hljs-string">"index"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">"required"</span>: <span class="hljs-literal">true</span>
  },
</code></pre>
</li>
</ul>
</li>
</ul>
<p>接着就该是建立数据库之间的关系(relation), loopback 提供如下的关系:</p>
<ul>
<li><a href="https://docs.strongloop.com/display/LB/BelongsTo+relations" target="_blank" rel="noopener">BelongsTo relations</a></li>
<li><a href="https://docs.strongloop.com/display/LB/HasOne+relations" target="_blank" rel="noopener">HasOne relations</a></li>
<li><a href="https://docs.strongloop.com/display/LB/HasMany+relations" target="_blank" rel="noopener">HasMany relations</a></li>
<li><a href="https://docs.strongloop.com/display/LB/HasManyThrough+relations" target="_blank" rel="noopener">HasManyThrough relations</a></li>
<li><a href="https://docs.strongloop.com/display/LB/HasAndBelongsToMany+relations" target="_blank" rel="noopener">HasAndBelongsToMany relations</a></li>
<li><a href="https://docs.strongloop.com/display/LB/Polymorphic+relations" target="_blank" rel="noopener">Polymorphic relations</a></li>
<li><a href="https://docs.strongloop.com/display/LB/Embedded+models+and+relations" target="_blank" rel="noopener">Embedded relations</a>
<ul>
<li>embedsOne and embedsMany</li>
</ul>
</li>
</ul>
<p>我们使用loopback提供的<a href="https://docs.strongloop.com/display/public/LB/Creating+model+relations" target="_blank" rel="noopener">relation generator</a>来建立关系：</p>
<h2 id="slc-loopback-relation" class="heading-control">slc loopback:relation<a class="heading-anchor" href="#slc-loopback-relation" aria-hidden="true"></a></h2>
<p>首先注意，关系的名称不能和属性(字段)名一样。</p>
<p>既然是用户写的博客，那么对博客而已，自然是<code>BelongsTo</code>关系:</p>
<pre><code>$ slc loopback:relation
? Select the model to create the relationship from: Blog
? Relation type: belongs to
? Choose a model to create a relationship with: User
? Enter the property name for the relation: author
? Optionally enter a custom foreign key:
</code></pre>
<p>还有，博客上应支持不同读者的评论，自然博客上有许多(<code>HasMany</code>)评论：</p>
<pre><code>$ slc loopback:relation
? Select the model to create the relationship from: Blog
? Relation type: has many
? Choose a model to create a relationship with: Comment
? Enter the property name for the relation: comments
? Optionally enter a custom foreign key:
? Require a through model? No
</code></pre>
<p>另外，评论本身也有作者的，所以还需要为<code>Comment</code>增加<code>BelongsTo</code>关系：</p>
<pre><code>slc loopback:relation
? Select the model to create the relationship from: Comment
? Relation type: belongs to
? Choose a model to create a relationship with: User
? Enter the property name for the relation: author
? Optionally enter a custom foreign key:
</code></pre>
<p>注意：关系对应的方法名称参阅: <a href="https://docs.strongloop.com/display/public/LB/Accessing+related+models" target="_blank" rel="noopener">Accessing related models</a></p>
<p>Ok, Model 自此建立完毕，建立的文件在项目的<code>/server/models/</code>目录或者<code>/common/models</code>目录下，这个依赖您自己的配置。</p>
<p>那么，对于Scheme化的关系型数据库，如何自动在数据库中建立对应的表和字段呢？很简单，对于如下的数据库，loopback提供了自动迁移（Auto-migrate）机制:</p>
<ul>
<li>Oracle</li>
<li>PostgreSQL</li>
<li>MySQL</li>
<li>SQL Server</li>
<li>MongoDB</li>
</ul>
<p>注意：</p>
<ul>
<li>在mongoDB中的autoMigrate()会建立缺失的索引，但是不会修改它们，如果索引的定义改变了。所以你必须要么在mongoDB Shell中修改，或者删除他们再重建。</li>
<li><code>autoMigrate</code> 会首先 <code>Drop table</code> ，然后再建表。要保留数据，请用 <code>autoUpdate</code>.</li>
</ul>
<p>把脚本作为启动脚本放在项目的<code>/server/boot/</code>目录下(启动顺序按ASCII字母表顺序)：</p>
<p><code>/server/boot/auto-migrate.js</code>:</p>
<pre><code class="js"><span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">app</span>) </span>{
  <span class="hljs-keyword">var</span> log = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'boot:autoMigrate'</span>);
  <span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
  <span class="hljs-keyword">var</span> models = <span class="hljs-built_in">require</span>(path.resolve(__dirname, <span class="hljs-string">'../model-config.json'</span>));
  <span class="hljs-keyword">var</span> datasources = <span class="hljs-built_in">require</span>(path.resolve(__dirname, <span class="hljs-string">'../datasources.json'</span>));

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">migrateAll</span>(<span class="hljs-params">aMethod</span>)</span>{
    <span class="hljs-built_in">Object</span>.keys(models).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">model</span>) </span>{
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> models[model].dataSource !== <span class="hljs-string">'undefined'</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> datasources[models[model].dataSource] !== <span class="hljs-string">'undefined'</span>) {
          app.dataSources[models[model].dataSource][aMethod](model, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
              <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;
              log(<span class="hljs-string">'Model '</span> + model + <span class="hljs-string">' '</span>+ aMethod + <span class="hljs-string">'d'</span>);
          });
        }
      }
    });
  }
  <span class="hljs-keyword">if</span> (process.env.NODE_ENV !== <span class="hljs-string">'production'</span>) {
    migrateAll(<span class="hljs-string">'automigrate'</span>);
  }
  <span class="hljs-keyword">else</span> {
    migrateAll(<span class="hljs-string">'autoupdate'</span>);
  }
};
</code></pre>
<p>对了，内置的 Model(User, AccessToken, ACL, RoleMapping, Role) 也应该存到数据库中:</p>
<p><code>server/model-config.json</code>:</p>
<pre><code class="js">{
  <span class="hljs-string">"User"</span>: {
    <span class="hljs-string">"dataSource"</span>: <span class="hljs-string">"myBlogger"</span>,
    <span class="hljs-string">"public"</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-string">"AccessToken"</span>: {
    <span class="hljs-string">"dataSource"</span>: <span class="hljs-string">"myBlogger"</span>,
    <span class="hljs-string">"public"</span>: <span class="hljs-literal">false</span>
  },
  <span class="hljs-string">"ACL"</span>: {
    <span class="hljs-string">"dataSource"</span>: <span class="hljs-string">"myBlogger"</span>,
    <span class="hljs-string">"public"</span>: <span class="hljs-literal">false</span>
  },
  <span class="hljs-string">"RoleMapping"</span>: {
    <span class="hljs-string">"dataSource"</span>: <span class="hljs-string">"myBlogger"</span>,
    <span class="hljs-string">"public"</span>: <span class="hljs-literal">false</span>
  },
  <span class="hljs-string">"Role"</span>: {
    <span class="hljs-string">"dataSource"</span>: <span class="hljs-string">"myBlogger"</span>,
    <span class="hljs-string">"public"</span>: <span class="hljs-literal">false</span>
  }
}
</code></pre>
<p>对内置Model的扩展方式可以参阅<a href="https://docs.strongloop.com/display/public/LB/Extending+built-in+models" target="_blank" rel="noopener">这里</a>.</p>
<p>好了，现在，我们需要实现访问控制，loopback框架支持通过ACL(Access Control List)来控制权限。</p>
<h2 id="slc-loopback-acl" class="heading-control">slc loopback:acl<a class="heading-anchor" href="#slc-loopback-acl" aria-hidden="true"></a></h2>
<p>权限：</p>
<ul>
<li>未登录用户只能看博客或者评论</li>
<li>登录用户可以:
<ul>
<li>创建博文</li>
<li>编辑自己的博文</li>
<li>发表自己的博文</li>
<li>顶一篇博文(Upvote)</li>
<li>踩一篇博文(Downvote)</li>
<li>创建博文的评论</li>
<li>编辑自己的评论</li>
<li>喜欢某个评论</li>
<li>不喜欢某个评论</li>
</ul>
</li>
</ul>
<p>首先，针对博客和评论，我们对任何人禁止掉所有的权限访问。</p>
<pre><code>$ slc loopback:acl
? Select the model to apply the ACL entry to: Blog
? Select the ACL scope: All methods and properties
? Select the access type: All (match all types)
? Select the role: All users
? Select the permission to apply: Explicitly deny access

$ slc loopback:acl
? Select the model to apply the ACL entry to: Comment
? Select the ACL scope: All methods and properties
? Select the access type: All (match all types)
? Select the role: All users
? Select the permission to apply: Explicitly deny access
</code></pre>
<p>然后再允许所有人能阅读博客和评论。</p>
<pre><code>? Select the model to apply the ACL entry to: Blog
? Select the ACL scope: All methods and properties
? Select the access type: Read
? Select the role: All users
? Select the permission to apply: Explicitly grant access

? Select the model to apply the ACL entry to: Comment
? Select the ACL scope: All methods and properties
? Select the access type: Read
? Select the role: All users
? Select the permission to apply: Explicitly grant access
</code></pre>
<p>允许认证用户能创建新的博文:</p>
<pre><code>? Select the model to apply the ACL entry to: Blog
? Select the ACL scope: All methods and properties
? Select the access type: Write
? Select the role: Any authenticated user
? Select the permission to apply: Explicitly grant access
</code></pre>
<p>确保只有博文作者才编辑和发布博文：</p>
<pre><code>? Select the model to apply the ACL entry to: Blog
? Select the ACL scope: All methods and properties
? Select the access type: Write
? Select the role: The user owning the object
? Select the permission to apply: Explicitly grant access

? Select the model to apply the ACL entry to: Blog
? Select the ACL scope: A single method
? Enter the method name: publish
? Select the role: The user owning the object
? Select the permission to apply: Explicitly grant access
</code></pre>
<p>认证用户可以顶或踩:</p>
<pre><code>? Select the model to apply the ACL entry to: Blog
? Select the ACL scope: A single method
? Enter the method name: upvote
? Select the role: All users
? Select the permission to apply: Explicitly deny access

? Select the model to apply the ACL entry to: Blog
? Select the ACL scope: A single method
? Enter the method name: upvote
? Select the role: Any authenticated user
? Select the permission to apply: Explicitly grant access

? Select the model to apply the ACL entry to: Blog
? Select the ACL scope: A single method
? Enter the method name: downvote
? Select the role: All users
? Select the permission to apply: Explicitly deny access

? Select the model to apply the ACL entry to: Blog
? Select the ACL scope: A single method
? Enter the method name: downvote
? Select the role: Any authenticated user
? Select the permission to apply: Explicitly grant access
</code></pre>
<p>最后，如法炮制评论:</p>
<pre><code>? Select the model to apply the ACL entry to: Comment
? Select the ACL scope: All methods and properties
? Select the access type: Write
? Select the role: Any authenticated user
? Select the permission to apply: Explicitly grant access
</code></pre>
<p>接下来就该添加新增的功能(remote methods)，例如：</p>
<ul>
<li>发布一篇博文： <code>/blogs/:id/publish</code></li>
<li>顶：<code>/blogs/:id/upvote</code></li>
<li>踩：<code>/blogs/:id/downvote</code></li>
<li>喜欢(评论)：<code>/comments/:id/like</code></li>
<li>不喜欢(评论)：<code>/comments/:id/dislike</code></li>
</ul>
<p>打开您<code>models</code>文件夹下的<code>blog.js</code>文件:</p>
<pre><code class="js"><span class="hljs-comment">// Register a 'publish' remote method: /blogs/:id/publish</span>
Blog.remoteMethod(
  <span class="hljs-string">'publish'</span>,
  {
    <span class="hljs-attr">http</span>: {<span class="hljs-attr">path</span>: <span class="hljs-string">'/:id/publish'</span>, <span class="hljs-attr">verb</span>: <span class="hljs-string">'put'</span>},
    <span class="hljs-attr">accepts</span>: {<span class="hljs-attr">arg</span>: <span class="hljs-string">'id'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>, <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">http</span>: { <span class="hljs-attr">source</span>: <span class="hljs-string">'path'</span> }},
    <span class="hljs-attr">returns</span>: {<span class="hljs-attr">root</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'object'</span>},
    <span class="hljs-attr">description</span>: <span class="hljs-string">'Marks a blog as published.'</span>
  }
);

<span class="hljs-comment">// the actual function called by the route to do the work</span>
Blog.publish = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id, cb</span>) </span>{
  Blog.findById(id, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, record</span>)</span>{
    record.updateAttributes({<span class="hljs-attr">isPublished</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">publishedDate</span>: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, instance</span>) </span>{
      <span class="hljs-keyword">if</span> (err) cb(err);
      <span class="hljs-keyword">if</span> (!err) cb(<span class="hljs-literal">null</span>, instance);
    })
  })
};

Blog.remoteMethod(
  <span class="hljs-string">'upvote'</span>,
  {
    <span class="hljs-attr">http</span>: {<span class="hljs-attr">path</span>: <span class="hljs-string">'/:id/upvote'</span>, <span class="hljs-attr">verb</span>: <span class="hljs-string">'post'</span>},
    <span class="hljs-attr">accepts</span>: {<span class="hljs-attr">arg</span>: <span class="hljs-string">'id'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>, <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">http</span>: { <span class="hljs-attr">source</span>: <span class="hljs-string">'path'</span> }},
    <span class="hljs-attr">returns</span>: {<span class="hljs-attr">root</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'object'</span>},
    <span class="hljs-attr">description</span>: <span class="hljs-string">'Marks a blog as upvoted.'</span>
  }
);

<span class="hljs-comment">// Remote hook called before running function</span>
Blog.beforeRemote(<span class="hljs-string">'upvote'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ctx, user, next</span>) </span>{
  Blog.findById(ctx.req.params.id, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, record</span>)</span>{
    <span class="hljs-comment">// do not let the user upvote their own record</span>
    <span class="hljs-keyword">if</span> (record.authorId === ctx.req.accessToken.userId) {
      <span class="hljs-keyword">var</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"User cannot upvote their own blog post."</span>);
      err.status = <span class="hljs-number">403</span>;
      next(err);
    <span class="hljs-comment">// do no let the user upvote a comment more than once</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (record.upvotes.indexOf(ctx.req.accessToken.userId) != <span class="hljs-number">-1</span>) {
      <span class="hljs-keyword">var</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"User has already upvoted the blog."</span>);
      err.status = <span class="hljs-number">403</span>;
      next(err);
    } <span class="hljs-keyword">else</span> {
      next();
    }
  })
});

<span class="hljs-comment">// the actual function called by the route to do the work</span>
Blog.upvote = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">id, cb</span>) </span>{
  <span class="hljs-comment">// get the current context</span>
  <span class="hljs-keyword">var</span> ctx = loopback.getCurrentContext();
  Blog.findById(id, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, record</span>)</span>{
    <span class="hljs-comment">// get the calling user who 'upvoted' it from the context</span>
    record.upvotes.push(ctx.active.accessToken.userId);
    record.updateAttributes({<span class="hljs-attr">numOfUpVotes</span>: record.upvotes.length, <span class="hljs-attr">upvotes</span>: record.upvotes}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, instance</span>) </span>{
      <span class="hljs-keyword">if</span> (err) cb(err);
      <span class="hljs-keyword">if</span> (!err) cb(<span class="hljs-literal">null</span>, instance);
    })
  })
};
</code></pre>
<p>注意：如果直接在代码里调用remoteMethod去添加远程方法，那么在Model.definition.settings.methods中不会出现。</p>
<p>另外，通过禁止Model内置的删除方法，还可以禁止任何删除评论,修改 <code>models/comment.js</code>:</p>
<pre><code class="js">Comment.disableRemoteMethod(<span class="hljs-string">'deleteById'</span>, <span class="hljs-literal">true</span>);
</code></pre>
<p>我们还可以通过修改路由文件 <code>/server/boot/routes.js</code> 来扩展自己的定制路由，比如我们希望能通过这样的路径访问到用户的博文: <code>/:user/:slug</code>：</p>
<pre><code class="js">  app.get(<span class="hljs-string">'/:user/:slug'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
    Blog.findOne({ <span class="hljs-attr">where</span>: {<span class="hljs-attr">authorId</span>: req.params.user, <span class="hljs-attr">slug</span>:req.params.slug}, <span class="hljs-attr">include</span>: <span class="hljs-string">'comments'</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, record</span>)</span>{
      <span class="hljs-keyword">if</span> (err) res.send(err);
      <span class="hljs-keyword">if</span> (!err &amp;&amp; record) {
        res.send(record);
      } <span class="hljs-keyword">else</span> {
        res.send(<span class="hljs-number">404</span>);
      }
    });
  });
</code></pre>
<h2 id="storage-component" class="heading-control">Storage component<a class="heading-anchor" href="#storage-component" aria-hidden="true"></a></h2>
<p>通过使用<a href="https://docs.strongloop.com/display/public/LB/Storage+component" target="_blank" rel="noopener">Storage component</a>获得支持文件上传下载功能。该组件作为一种特殊的Datasource来使用，它支持如下的存储：</p>
<ul>
<li>云存储
<ul>
<li>Amazon</li>
<li>Rackspace</li>
<li>Openstack</li>
<li>Azure</li>
</ul>
</li>
<li>本地文件存储</li>
</ul>
<p>存储组件将文件内容组织为容器<code>containers</code> 和文件 <code>files</code>。一个<code>container</code>包含一系列的文件，每一个文件必属于一个容器。</p>
<ul>
<li><code>Container</code> groups files, similar to a directory or folder. A container defines the namespace for objects and is uniquely identified by its name, typically within a user account.
<ul>
<li>NOTE: A container cannot have child containers.</li>
</ul>
</li>
<li><code>File</code> stores the data, such as a document or image. A file is always in one (and only one) container. Within a container, each file has a unique name. Files in different containers can have the same name.</li>
</ul>
<h3 id="an-zhuang" class="heading-control">安装<a class="heading-anchor" href="#an-zhuang" aria-hidden="true"></a></h3>
<pre><code class="bash">$ npm install loopback-component-storage
</code></pre>
<h3 id="datasource" class="heading-control">Datasource<a class="heading-anchor" href="#datasource" aria-hidden="true"></a></h3>
<p>接着我们需要创建一个新的Datasource：</p>
<p>可以直接在 <code>/server/datasources.json</code> 文件中创建：</p>
<pre><code class="json">"myfile": {
   "name": "myfile",
   "connector": "loopback-component-storage",
   "provider": "amazon",
   "key": "your amazon key",
   "keyId": "your amazon key id"
 }
</code></pre>
<p>也可以在程序中创建:</p>
<p><code>server/server.js</code>:</p>
<pre><code class="js"><span class="hljs-keyword">var</span> ds = loopback.createDataSource({
    <span class="hljs-attr">connector</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">'loopback-component-storage'</span>),
    <span class="hljs-attr">provider</span>: <span class="hljs-string">'filesystem'</span>,
    <span class="hljs-attr">root</span>: path.resolve(__dirname, <span class="hljs-string">'../storage'</span>)
});

<span class="hljs-keyword">var</span> container = ds.createModel(<span class="hljs-string">'container'</span>, <span class="hljs-literal">null</span>, <span class="hljs-attr">base</span>: <span class="hljs-string">'Model'</span>);
app.model(container);
</code></pre>
<p>然后就可以在API中访问:</p>
<table>
<thead>
<tr>
<th>REST URI</th>
<th>Description</th>
<th>Container Model Method</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET /api/containers</td>
<td>List all containers.</td>
<td>getContainers(cb)</td>
</tr>
<tr>
<td>GET /api/containers/:container</td>
<td>Get information about specified container.</td>
<td>getContainer(container, cb)</td>
</tr>
<tr>
<td>POST /api/containers</td>
<td>Create a new container.</td>
<td>createContainer(options, cb)</td>
</tr>
<tr>
<td>DELETE /api/containers/:container</td>
<td>Delete specified container.</td>
<td>destroyContainer(container, cb)</td>
</tr>
<tr>
<td>GET /api/containers/:container/files</td>
<td>List all files within specified container.</td>
<td>getFiles(container, download, cb)</td>
</tr>
<tr>
<td>GET /api/containers/:container/files/:file</td>
<td>Get information for specified file within specified container.</td>
<td>getFile(container, file, cb)</td>
</tr>
<tr>
<td>DELETE /api/containers/:container/files/:file</td>
<td>Delete a file within a given container by name.</td>
<td>removeFile(container, file, cb)</td>
</tr>
<tr>
<td>POST /api/containers/:container/upload</td>
<td>Upload one or more files into the specified container. The request body must use multipart/form-data which the file input type for HTML uses.</td>
<td>upload(req, res, cb)</td>
</tr>
<tr>
<td>GET /api/containers/:container/download/:file</td>
<td>Download a file within specified container.</td>
<td>download(container, file, res, cb)</td>
</tr>
<tr>
<td></td>
<td>Get a stream for uploading.</td>
<td>uploadStream(container, file, options, cb)</td>
</tr>
<tr>
<td></td>
<td>Get a stream for downloading.</td>
<td>downloadStream(container, file, options, cb)</td>
</tr>
</tbody>
</table>
<p>如果是用本地文件系统，那么每创建一个容器，对应于每创建一个子目录:</p>
<pre><code class="bash">curl -X POST --header <span class="hljs-string">"Content-Type: application/json"</span> --header <span class="hljs-string">"Accept: application/json"</span> -d <span class="hljs-string">"{
  \"name\": \"test\"
}"</span> <span class="hljs-string">"http://localhost:3000/api/containers"</span>
</code></pre>
<p>注意当前container只支持1级目录，不支持多级目录。</p>
<h1 id="shen-ru-tan-suo" class="heading-control">深入探索<a class="heading-anchor" href="#shen-ru-tan-suo" aria-hidden="true"></a></h1>
<h2 id="slc-loopback-swagger" class="heading-control">slc loopback:swagger<a class="heading-anchor" href="#slc-loopback-swagger" aria-hidden="true"></a></h2>
<p>即由 <code>loopback:swagger</code> 可以把 Open API 文档直接导入进 loopback 应用。不过，它会针对API文档的<code>basePath</code>虚拟一个非持久化model: <code>swagger_xxx</code>，在Open API上的接口从这个虚拟model上暴露出来。</p>
<pre><code>slc loopback:swagger &lt;your_api_doc_path&gt;
? Enter the swagger spec url or file path: (wiki\user-api.yaml)
? Select models to be generated: (Press &lt;space&gt; to select)
&gt;(*) swagger_users
 ( ) UserModel
Creating model definition for swagger_users...
Creating model definition for UserModel...
Model definition created/updated for swagger_users.
Model definition created/updated for UserModel.
Creating model config for swagger_users...
Creating model config for UserModel...
Model config created for swagger_users.
Model config created for UserModel.
Generating project\server\models\swagger-users.js
Models are successfully generated from swagger spec.
</code></pre>
<p>slc应该提供一个方便的model以及<code>remote method</code>文档描述和生成工具。</p>
<h2 id="nei-jian-de-models" class="heading-control">内建的 models<a class="heading-anchor" href="#nei-jian-de-models" aria-hidden="true"></a></h2>
<p>参阅：<a href="https://github.com/strongloop/loopback/blob/master/lib/builtin-models.js" target="_blank" rel="noopener">这里</a></p>
<p>the built-in models attach to the ‘db’ datasource automatically:</p>
<pre><code class="js"> <span class="hljs-keyword">var</span> dataSourceTypes = {
    <span class="hljs-attr">DB</span>: <span class="hljs-string">'db'</span>,
    <span class="hljs-attr">MAIL</span>: <span class="hljs-string">'mail'</span>
  };

  registry.Email.autoAttach = dataSourceTypes.MAIL;
  registry.getModel(<span class="hljs-string">'PersistedModel'</span>).autoAttach = dataSourceTypes.DB;
  registry.User.autoAttach = dataSourceTypes.DB;
  registry.AccessToken.autoAttach = dataSourceTypes.DB;
  registry.Role.autoAttach = dataSourceTypes.DB;
  registry.RoleMapping.autoAttach = dataSourceTypes.DB;
  registry.ACL.autoAttach = dataSourceTypes.DB;
  registry.Scope.autoAttach = dataSourceTypes.DB;
  registry.Application.autoAttach = dataSourceTypes.DB;
</code></pre>
<p>扩展内置Model，除了官方文中提到方法外，还可以在 <code>/server/boot/</code>文件中直接对原有Model增加字段。</p>
<h3 id="user" class="heading-control"><a href="https://apidocs.strongloop.com/loopback/#user" target="_blank" rel="noopener">User</a><a class="heading-anchor" href="#user" aria-hidden="true"></a></h3>
<p>Default User ACLs.</p>
<ul>
<li>DENY EVERYONE *</li>
<li>ALLOW EVERYONE create</li>
<li>ALLOW EVERYONE login</li>
<li>ALLOW EVERYONE logout</li>
<li>ALLOW EVERYONE confirm their identity</li>
<li>ALLOW EVERYONE reset their own password</li>
<li>ALLOW OWNER deleteById</li>
<li>ALLOW OWNER findById</li>
<li>ALLOW OWNER updateAttributes</li>
</ul>
<p>默认字段:</p>
<ul>
<li>realm(<em>string</em>)</li>
<li>username(<em>string</em>)</li>
<li>password(<em>string</em>, required)</li>
<li>email(<em>string</em>, required)</li>
<li>emailVerified(<em>boolean</em>)</li>
<li>verificationToken(<em>string</em>)</li>
</ul>
<h4 id="register" class="heading-control">Register<a class="heading-anchor" href="#register" aria-hidden="true"></a></h4>
<pre><code class="bash">curl -X POST -H <span class="hljs-string">"Content-Type:application/json"</span> \
-d <span class="hljs-string">'{"email": "me@domain.com", "password": "secret"}'</span> \
http://localhost:3000/api/users
</code></pre>
<p>自带的注册验证为电子邮件验证，另外如果需要在注册前验证是否用户名或者邮件地址已经被注册，可以使用 <code>beforeRemote</code> hook.</p>
<p>启用电子邮件验证(必须先设置<a href="https://docs.strongloop.com/display/public/LB/Using+built-in+models#Usingbuilt-inmodels-Emailmodel" target="_blank" rel="noopener">Mail datasource</a>):</p>
<pre><code class="js"><span class="hljs-comment">//server/model-config.json</span>
<span class="hljs-string">"user"</span>: {
    <span class="hljs-string">"dataSource"</span>: <span class="hljs-string">"db"</span>,
    <span class="hljs-string">"public"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">"options"</span>: {
      <span class="hljs-string">"emailVerificationRequired"</span>: <span class="hljs-literal">true</span>
    }
}
</code></pre>
<p>/common/models/user.js:</p>
<pre><code class="js"><span class="hljs-keyword">var</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../server/config.json'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
 
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">user</span>) </span>{
  <span class="hljs-comment">//send verification email after registration</span>
  user.afterRemote(<span class="hljs-string">'create'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">context, userInstance, next</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&gt; user.afterRemote triggered'</span>);
 
    <span class="hljs-keyword">var</span> options = {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'email'</span>,
      <span class="hljs-attr">to</span>: userInstance.email,
      <span class="hljs-attr">from</span>: <span class="hljs-string">'noreply@loopback.com'</span>,
      <span class="hljs-attr">subject</span>: <span class="hljs-string">'Thanks for registering.'</span>,
      <span class="hljs-attr">template</span>: path.resolve(__dirname, <span class="hljs-string">'../../server/views/verify.ejs'</span>),
      <span class="hljs-attr">redirect</span>: <span class="hljs-string">'/verified'</span>,
      <span class="hljs-attr">user</span>: user
    };
 
    userInstance.verify(options, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, response, next</span>) </span>{
      <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> next(err);
 
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'&gt; verification email sent:'</span>, response);
 
      context.res.render(<span class="hljs-string">'response'</span>, {
        <span class="hljs-attr">title</span>: <span class="hljs-string">'Signed up successfully'</span>,
        <span class="hljs-attr">content</span>: <span class="hljs-string">'Please check your email and click on the verification link '</span> +
            <span class="hljs-string">'before logging in.'</span>,
        <span class="hljs-attr">redirectTo</span>: <span class="hljs-string">'/'</span>,
        <span class="hljs-attr">redirectToLinkText</span>: <span class="hljs-string">'Log in'</span>
      });
    });
  });
}
</code></pre>
<p>模板文件 verify.ejs:</p>
<pre><code class="ejs">This is the html version of your email.
&lt;strong&gt;&lt;%= text %&gt;&lt;/strong&gt;
</code></pre>
<h3 id="acl-access-control-list" class="heading-control"><a href="https://docs.strongloop.com/display/public/LB/Authentication%2C+authorization%2C+and+permissions" target="_blank" rel="noopener">ACL(Access Control List)</a><a class="heading-anchor" href="#acl-access-control-list" aria-hidden="true"></a></h3>
<h4 id="fang-wen-kong-zhi-gai-nian" class="heading-control">访问控制概念<a class="heading-anchor" href="#fang-wen-kong-zhi-gai-nian" aria-hidden="true"></a></h4>
<ul>
<li>Principal: An entity that can be identified or authenticated.
<ul>
<li>Represents identities of a request to protected resources.</li>
<li>eg:
<ul>
<li>A user</li>
<li>An application</li>
<li>A role (please note a role is also a principal)</li>
</ul>
</li>
</ul>
</li>
<li>Role: A group of principals with the same permissions.
<ul>
<li>eg:
<ul>
<li>Dynamic role:
<ul>
<li>$everyone (for all users)</li>
<li>$unauthenticated (unauthenticated users)</li>
<li>$owner (the principal is owner of the model instance)</li>
</ul>
</li>
<li>Static role: admin (a defined role for administrators)</li>
</ul>
</li>
</ul>
</li>
<li>RoleMapping: Assign principals to roles
<ul>
<li>Statically assigns principals to roles.</li>
<li>eg:
<ul>
<li>Assign user with id 1 to role 1</li>
<li>Assign role ‘admin’ to role 1</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="chang-gui-chu-li-bu-zhou" class="heading-control">常规处理步骤<a class="heading-anchor" href="#chang-gui-chu-li-bu-zhou" aria-hidden="true"></a></h4>
<ul>
<li><strong>指定用户角色</strong>.  定义需要的用户角色。例如：匿名用户，认证用户和管理者。</li>
<li><strong>定义每一个角色或者Model的访问权限D</strong>.  例如：匿名用户只可以读银行列表，但是不允许其它操作.<br>
LoopBack 的models 有一套内置的方法，每一个方法被映射为 <code>READ</code> 或者 <code>WRITE</code> 访问权限.  In essence, this step amounts to specifying whether access is allowed for each role and each Model + access type, as illustrated in the example below.</li>
<li><strong>实现认证</strong>: 添加代码区创建(注册)用户，登录用户（获取并使用认证token），并注销用户。</li>
</ul>
<h4 id="ru-he-bao-lou-yin-cang-models-fang-fa-he-api" class="heading-control">如何暴露隐藏 models, 方法 和 API<a class="heading-anchor" href="#ru-he-bao-lou-yin-cang-models-fang-fa-he-api" aria-hidden="true"></a></h4>
<p>通过 REST API 暴露一个 model 非常简单，只需要设置 <code>/server/model-config.json</code> 文件的 <code>public</code> 属性为 <code>true</code> 即可:</p>
<pre><code class="json">  "Role": {
    "dataSource": "db",
    "public": false
  }
</code></pre>
<h5 id="yin-cang-fang-fa-he-rest-api" class="heading-control">隐藏方法和REST API<a class="heading-anchor" href="#yin-cang-fang-fa-he-rest-api" aria-hidden="true"></a></h5>
<p>如果你不想暴露特定的 create, retrieve, update, delete 操作, 那么你可以通过调用Model的 <code>disableRemoteMethod()</code> 方法来实现。在你的model文件(<code>common/models/</code>目录下)中加入以下的代码，隐藏预定义的API方法:</p>
<pre><code class="js"><span class="hljs-keyword">var</span> isStatic = <span class="hljs-literal">true</span>;
<span class="hljs-comment">//hide the predefined remote methods</span>
MyModel.disableRemoteMethod(<span class="hljs-string">'deleteById'</span>, isStatic);
</code></pre>
<p>如果你想隐藏的方法是在prototype上的<code>实例方法</code>,那么你需要设置 <code>isStatic</code> 为 <code>false</code>:</p>
<pre><code class="js"><span class="hljs-keyword">var</span> isStatic = <span class="hljs-literal">false</span>;
<span class="hljs-comment">//hide the methods on the prototype</span>
MyModel.disableRemoteMethod(<span class="hljs-string">'updateAttributes'</span>, isStatic);
</code></pre>
<h4 id="ding-yi-shi-yong-role" class="heading-control">定义使用Role<a class="heading-anchor" href="#ding-yi-shi-yong-role" aria-hidden="true"></a></h4>
<p>LoopBack 支持静态或动态的角色。静态角色保存在数据库中并映射到用户。作为对比，动态角色并不事先和用户绑定，它是在访问时才被确定。</p>
<h5 id="static-roles" class="heading-control">Static roles<a class="heading-anchor" href="#static-roles" aria-hidden="true"></a></h5>
<p>创建静态 Role 记录:</p>
<pre><code class="coffee">Role.create name: <span class="hljs-string">'admin'</span>, <span class="hljs-function"><span class="hljs-params">(err, role)</span>-&gt;</span>
  <span class="hljs-keyword">return</span> cb(err) <span class="hljs-keyword">if</span> err
  <span class="hljs-comment"># add a user to the role.</span>
  role.principals.create principalType: RoleMapping.USER, principalId: aUser.id, <span class="hljs-function"><span class="hljs-params">(err, principal)</span>-&gt;</span>
    cb(err)
</code></pre>
<p>但是更普通的用法应该是：</p>
<pre><code class="coffee">Role.create name: <span class="hljs-string">'project.del'</span>, <span class="hljs-function"><span class="hljs-params">(err, role)</span>-&gt;</span>
  <span class="hljs-keyword">return</span> cb(err) <span class="hljs-keyword">if</span> err
  <span class="hljs-comment"># assign admin to the project.del role.</span>
  role.principals.create principalType: RoleMapping.ROLE, principalId: <span class="hljs-string">'admin'</span>, <span class="hljs-function"><span class="hljs-params">(err, principal)</span>-&gt;</span>
    cb(err)
</code></pre>
<p>这样会在权限角色上挂大量的用户自定义角色，太糟糕了，所以只能通过编写动态角色来做。</p>
<h5 id="dynamic-roles" class="heading-control">Dynamic roles<a class="heading-anchor" href="#dynamic-roles" aria-hidden="true"></a></h5>
<p>大多数时候，静态角色的灵活性并不够，因此 Loopback提供了在运行时刻确定权限的动态角色。</p>
<p>并且 LoopBack 提供下列内置的动态角色：</p>
<table>
<thead>
<tr>
<th>Role 对象属性</th>
<th>字符串值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Role.OWNER</td>
<td>$owner</td>
<td>Owner of the object</td>
</tr>
<tr>
<td>Role.AUTHENTICATED</td>
<td>$authenticated</td>
<td>authenticated user</td>
</tr>
<tr>
<td>Role.UNAUTHENTICATED</td>
<td>$unauthenticated</td>
<td>Unauthenticated user</td>
</tr>
<tr>
<td>Role.EVERYONE</td>
<td>$everyone</td>
<td>Everyone</td>
</tr>
</tbody>
</table>
<p>如何定义<code>动态角色</code>? 只需要在启动(boot)脚本中使用 <code>Role.registerResolver(name, fnRoleHandler)</code> 配置自己的定制角色处理器即可。该函数有两个参数:</p>
<ol>
<li>该动态角色的名称</li>
<li>角色处理器异步函数，确定一个 principal 是否在该动态角色里。该函数传入的参数为 <code>function(role, context, callback)</code></li>
</ol>
<ul>
<li>role: 来自的role</li>
<li>content: 当前期望访问的内容principal.</li>
<li>callback: 返回结果回调函数。<code>function(error, result)</code>
<ul>
<li>error: 如果有错误则把error对象传入该参数，否则应该是<code>null</code></li>
<li>result: <em>(boolean)</em> ，<code>true</code> 表示允许，<code>false</code> 表示拒绝。</li>
</ul>
</li>
</ul>
<p>例如：</p>
<pre><code class="js"><span class="hljs-comment">// /server/boot/script.js</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">app</span>) </span>{
  <span class="hljs-keyword">var</span> Role = app.models.Role;
  Role.registerResolver(<span class="hljs-string">'teamMember'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">role, context, cb</span>) </span>{
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reject</span>(<span class="hljs-params">err</span>) </span>{
      <span class="hljs-keyword">if</span>(err) {
        <span class="hljs-keyword">return</span> cb(err);
      }
      cb(<span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);
    }
    <span class="hljs-keyword">if</span> (context.modelName !== <span class="hljs-string">'project'</span>) {
      <span class="hljs-comment">// the target model is not project</span>
      <span class="hljs-keyword">return</span> reject();
    }
    <span class="hljs-keyword">var</span> userId = context.accessToken.userId;
    <span class="hljs-keyword">if</span> (!userId) {
      <span class="hljs-keyword">return</span> reject(); <span class="hljs-comment">// do not allow anonymous users</span>
    }
    <span class="hljs-comment">// check if userId is in team table for the given project id</span>
    context.model.findById(context.modelId, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, project</span>) </span>{
      <span class="hljs-keyword">if</span>(err || !project) {
        reject(err);
      }
      <span class="hljs-keyword">var</span> Team = app.models.Team;
      Team.count({
        <span class="hljs-attr">ownerId</span>: project.ownerId,
        <span class="hljs-attr">memberId</span>: userId
      }, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, count</span>) </span>{
        <span class="hljs-keyword">if</span> (err) {
          <span class="hljs-keyword">return</span> reject(err);
        }
        cb(<span class="hljs-literal">null</span>, count &gt; <span class="hljs-number">0</span>); <span class="hljs-comment">// true = is a team member</span>
      });
    });
  });
};
</code></pre>
<p>接下来就可以在model中使用该动态角色<code>teamMember</code>:</p>
<pre><code class="js"><span class="hljs-comment">// /common/models/model.json</span>
{
  <span class="hljs-string">"accessType"</span>: <span class="hljs-string">"READ"</span>,
  <span class="hljs-string">"principalType"</span>: <span class="hljs-string">"ROLE"</span>,
  <span class="hljs-string">"principalId"</span>: <span class="hljs-string">"teamMember"</span>,
  <span class="hljs-string">"permission"</span>: <span class="hljs-string">"ALLOW"</span>,
  <span class="hljs-string">"property"</span>: <span class="hljs-string">"findById"</span>
}
</code></pre>
<h2 id="zhong-duan-da-yin" class="heading-control"><a href="https://docs.strongloop.com/display/public/LB/Setting+debug+strings" target="_blank" rel="noopener">终端打印</a><a class="heading-anchor" href="#zhong-duan-da-yin" aria-hidden="true"></a></h2>
<p>在开发过程中希望通过终端输出调试信息，则可以根据自己的模块以及组织引入：</p>
<pre><code class="js"><span class="hljs-keyword">var</span> log = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'common:autoMigrate'</span>);

log(<span class="hljs-string">"this is a debug info."</span>);
</code></pre>
<p>使用时候:</p>
<pre><code class="bash">$ DEBUG=&lt;pattern&gt;[,&lt;pattern&gt;...] node .
</code></pre>
<p>支持通配符:</p>
<pre><code class="bash">$ DEBUG=common:* node .
</code></pre>
<p>具体的内置模块调试信息参阅: <a href="https://docs.strongloop.com/display/public/LB/Setting+debug+strings" target="_blank" rel="noopener">Setting debug strings</a></p>
]]></content>
      <categories>
        <category>JavaScript</category>
        <category>Framework</category>
        <category>API</category>
      </categories>
      <tags>
        <tag>javascript</tag>
        <tag>framework</tag>
        <tag>nodejs</tag>
        <tag>creation</tag>
        <tag>api</tag>
      </tags>
  </entry>
  <entry>
    <title>异步编程与 Promise</title>
    <url>/article/promise.cn/</url>
    <content><![CDATA[<h1 id="promise" class="heading-control">Promise<a class="heading-anchor" href="#promise" aria-hidden="true"></a></h1>
<p>Promise是简化异步编程的重要概念。这篇文章介绍得不错：<a href="http://know.cujojs.com/tutorials/async/simplifying-async-with-promises" target="_blank" rel="noopener">Simplifying Async with Promises</a>.</p>
<p>简单的说，Promise（又名 Future, Delayed value, Deferred value）代表一个尚不可用的值。因为产生这个值的计算过程尚未完成。一个 Promise 是最终的成功结果或失败原因的占位符。</p>
<ul>
<li>promise只有三种状态，未完成，完成(fulfilled)和失败(rejected)。</li>
<li>promise的状态可以由未完成转换成完成，或者未完成转换成失败。</li>
<li>promise的状态转换只发生一次</li>
<li>promise有一个then方法: (<code>promise.then(onFulfilled, onRejected)</code>)
<ul>
<li>
<p>then方法可以接受2个回调函数作为参数。</p>
<ul>
<li>对应promise的两种状态fulfilled, rejected的回调函数。回调函数的传递参数分别是resolve(value),reject(value) 函数。</li>
</ul>
<pre><code class="js">.then(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">resolve</span>)</span>{
        <span class="hljs-comment">//当promise状态变成fulfilled时，调用此函数</span>
    },<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">reject</span>)</span>{
        <span class="hljs-comment">//当promise状态变成rejected时，调用此函数</span>
    });
</code></pre>
<pre><code class="coffee">.<span class="hljs-keyword">then</span> (<span class="hljs-function"><span class="hljs-params">(resolve)</span>-&gt;</span>), <span class="hljs-function">(<span class="hljs-params">(reject)</span>-&gt;</span>))
</code></pre>
</li>
</ul>
</li>
</ul>
<p>Promise API 标准存在多个提案，目前看来，<a href="https://promisesaplus.com/" target="_blank" rel="noopener">Promises/A+</a> 已经正在成为事实上的标准。</p>
<p>Bluebird 号称速度是所有 Promise 库里最快的 <a href="https://promisesaplus.com/" target="_blank" rel="noopener">Promises/A+</a> 实现，里面做了许多的扩展。 想知道内部实现，可以阅读这个<a href="https://github.com/ysmood/yaku" target="_blank" rel="noopener">yaku</a>简单的实现（coffee-script)。</p>
<h3 id="promise-any-and-promise-some" class="heading-control">Promise.any and Promise.some<a class="heading-anchor" href="#promise-any-and-promise-some" aria-hidden="true"></a></h3>
<p>并行的 <a href="http://bluebirdjs.com/docs/api/promise.any.html" target="_blank" rel="noopener">Promise.any</a> 和 <a href="http://bluebirdjs.com/docs/api/promise.some.html" target="_blank" rel="noopener">Promise.some</a></p>
<ul>
<li><code>some</code>是其中一些promise成功返回，可以指定个数。返回结果为一个数组.</li>
<li><code>any</code> 是任意一个promise成功返回，是some个数固定为1的结果，另外它的返回结果是一个单值，不是数组。</li>
</ul>
<p>注意：它们是向<strong>所有</strong>的promises同时发起执行请求(并行)，但是只取最先返回结果的。不是顺序执行，直到得到成功结果的个数，就不继续了。</p>
<pre><code class="coffee">Promise = <span class="hljs-built_in">require</span> <span class="hljs-string">'bluebird'</span>

readFile = Promise.promisify (aPath, done) -&gt;
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">'readFile'</span>, aPath
  <span class="hljs-keyword">if</span> aPath != <span class="hljs-string">'c'</span> <span class="hljs-keyword">and</span> aPath != <span class="hljs-string">'e'</span>  <span class="hljs-keyword">then</span> done(<span class="hljs-keyword">new</span> Error(<span class="hljs-string">'no such file:'</span>+aPath)) <span class="hljs-keyword">else</span> done(<span class="hljs-literal">null</span>, aPath+<span class="hljs-string">'ok'</span>)

files = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'e'</span>]

Promise.any files.map (file)-&gt;readFile(file)
.<span class="hljs-keyword">then</span> (content)-&gt; <span class="hljs-built_in">console</span>.log <span class="hljs-string">'content='</span>,content

</code></pre>
<p>显示结果如下:</p>
<pre><code class="bash">readFile a
readFile b
readFile c
readFile d
readFile e
content= x ok
</code></pre>
<p>注：这个 <code>x</code> 表示可能是 ‘c’或者’e’。</p>
<h3 id="shun-xu-zhi-hang-de-some-he-any" class="heading-control">顺序执行的 <code>some</code> 和 <code>any</code><a class="heading-anchor" href="#shun-xu-zhi-hang-de-some-he-any" aria-hidden="true"></a></h3>
<p>但是，在某些特定场合，我们并不希望并发执行读文件操作，而是有次序的执行。那么如何做到顺序执行（sequence）？</p>
<p>这个时候，可以用<code>reduce</code>(<a href="http://bluebirdjs.com/docs/api/promise.reduce.html" target="_blank" rel="noopener">promise.reduce</a>)实现：</p>
<pre><code class="coffee">Promise.reduce files, <span class="hljs-function"><span class="hljs-params">(content, file)</span>-&gt;</span>
  content = readFile(file).caught(<span class="hljs-function">-&gt;</span>) <span class="hljs-keyword">unless</span> content
  <span class="hljs-keyword">return</span> content
, <span class="hljs-literal">null</span>
.<span class="hljs-keyword">then</span> (content)-&gt;<span class="hljs-built_in">console</span>.log <span class="hljs-string">'content='</span>, content
</code></pre>
<p>显示结果如下:</p>
<pre><code class="bash">readFile a
readFile b
readFile c
content= c ok
</code></pre>
<p>更多的细节参见我写的<a href="https://github.com/snowyu/promise-sequence.js" target="_blank" rel="noopener">promise-sequence</a>。<br>
a simple functional abstraction for sequentially:</p>
<p>下面这是map-reduce的思路用在数组的所有元素求和上,不过够绕脑袋瓜的：</p>
<pre><code class="coffee">Array::sum = <span class="hljs-function">-&gt;</span> @reduce (<span class="hljs-function"><span class="hljs-params">(a,b)</span>-&gt;</span>a+b), <span class="hljs-number">0</span>
[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>].sum()
<span class="hljs-comment"># 6</span>
</code></pre>
<p>这是顺序执行的coffee-script 核心代码：</p>
<pre><code class="coffee"><span class="hljs-function"><span class="hljs-title">seqAny</span> = <span class="hljs-params">(aList, fn)</span>-&gt;</span>
<span class="hljs-function">  <span class="hljs-title">_genReduceFn</span> = <span class="hljs-params">(fn)</span>-&gt;</span>
    (previous, item)-&gt;
      previous = fn(item).<span class="hljs-keyword">catch</span>(<span class="hljs-function">-&gt;</span>) <span class="hljs-keyword">unless</span> previous
      previous

  Promise.reduce aList, _genReduceFn(fn), <span class="hljs-literal">null</span>

seqAny(files, readFile).<span class="hljs-keyword">then</span> (result)-&gt;<span class="hljs-built_in">console</span>.log <span class="hljs-string">'seqAny='</span>, result
<span class="hljs-function">
<span class="hljs-title">seqSome</span> = <span class="hljs-params">(aList, total, fn)</span>-&gt;</span>
<span class="hljs-function">  <span class="hljs-title">_genReduceFn</span> = <span class="hljs-params">(fn)</span>-&gt;</span>
    (previous, item)-&gt;
      previous = previous.filter Boolean
      <span class="hljs-keyword">if</span> previous.length &lt; total
        previous = Promise.all previous.concat [fn(item).<span class="hljs-keyword">catch</span>(<span class="hljs-function">-&gt;</span>)]
      previous
  Promise.reduce aList, _genReduceFn(fn), []

seqSome(files, <span class="hljs-number">2</span>, readFile).<span class="hljs-keyword">then</span> (result)-&gt;<span class="hljs-built_in">console</span>.log <span class="hljs-string">'seqSome='</span>, result
<span class="hljs-function">
<span class="hljs-title">sequence</span> = <span class="hljs-params">(aList, fn)</span>-&gt;</span> <span class="hljs-comment"># execution all via sequence</span>
  <span class="hljs-comment"># Promise.all 将执行所有的Promise,即使其中一个有错误，后面也会接着执行，如果有错误则报错。</span>
<span class="hljs-function">  <span class="hljs-title">sequentially</span> = <span class="hljs-params">(fn)</span>-&gt;</span>
    (previous, item)-&gt;
      Promise.all previous.concat [fn(item)]

  Promise.reduce aList, sequentially(fn), []

sequence files, <span class="hljs-function"><span class="hljs-params">(i)</span>-&gt;</span>readFile(i).<span class="hljs-keyword">catch</span>(<span class="hljs-function">-&gt;</span>)
.<span class="hljs-keyword">then</span> (result)-&gt;<span class="hljs-built_in">console</span>.log result

</code></pre>
<p>这是直接构造函数执行链的思路:</p>
<pre><code class="coffee"><span class="hljs-function"><span class="hljs-title">waterfall</span> = <span class="hljs-params">(tasks)</span>-&gt;</span>
  current = Promise.cast()
  <span class="hljs-keyword">for</span> task <span class="hljs-keyword">in</span> tasks
    current = current.<span class="hljs-keyword">then</span>(task)
  current

waterfall 返回所有函数的结果作为数组:

<span class="hljs-function"><span class="hljs-title">waterfall</span> = <span class="hljs-params">(tasks)</span>-&gt;</span>
  current = Promise.cast()
  result = []
  <span class="hljs-keyword">for</span> task <span class="hljs-keyword">in</span> tasks
    result.push current = current.<span class="hljs-keyword">then</span>(task)
  Promise.all result

sequence 与waterfall不同之处在于不传递结果到下一个函数:

<span class="hljs-function"><span class="hljs-title">sequence</span> = <span class="hljs-params">(tasks)</span>-&gt;</span>
  current = Promise.cast()
  <span class="hljs-keyword">for</span> task <span class="hljs-keyword">in</span> tasks
    current = current.thenReturn().<span class="hljs-keyword">then</span>(task)
  current.thenReturn()

汇集结果到数组。
<span class="hljs-function">
<span class="hljs-title">sequence</span> = <span class="hljs-params">(tasks)</span>-&gt;</span>
  current = Promise.cast()
  result = []
  <span class="hljs-keyword">for</span> task <span class="hljs-keyword">in</span> tasks
    result.push current = current.thenReturn().<span class="hljs-keyword">then</span>(task)
  Promise.all result


</code></pre>
]]></content>
      <categories>
        <category>Learning</category>
        <category>Programming</category>
        <category>Asynchronous</category>
      </categories>
      <tags>
        <tag>programming</tag>
        <tag>asynchronous</tag>
        <tag>promise</tag>
      </tags>
  </entry>
  <entry>
    <title>如何选择一门语言学习计算机编程</title>
    <url>/article/howto-choose-programming-language/</url>
    <content><![CDATA[<h1 id="ru-he-xuan-ze-yi-men-yu-yan-xue-xi-ji-suan-ji-bian-cheng" class="heading-control">如何选择一门语言学习计算机编程<a class="heading-anchor" href="#ru-he-xuan-ze-yi-men-yu-yan-xue-xi-ji-suan-ji-bian-cheng" aria-hidden="true"></a></h1>
<p>实用派的想法：</p>
<p>哪一门或一些语言适合你？取决于你想干什么？</p>
<ul>
<li>你是想做嵌入式系统开发？</li>
<li>或是想数据挖掘统计分析？</li>
<li>或是想开发web站点？</li>
<li>或是想做原生的iOS系统开发？</li>
<li>或是想做原生的Android系统开发？</li>
<li>或是想做跨移动平台的开发？</li>
</ul>
<p>不同的选择决定你会去学习使用一些不同的语言。</p>
<p>如果你已经决定为计算机软件开发奋斗终生，那这个首先必须掌握的最基础的语言的是什么？</p>
<p>如果你只是偶尔心动，仅仅是为了完成某项任务来为之，请忽略直接跳到后面，你不妨根据你自己的项目需求来选择语言： [[Which-language-for-u#选择适合自己的计算机语言|选择适合自己的计算机语言]] 一节。</p>
<p>打好基础，从阅读计算机英语开始。</p>
<h1 id="ji-chu-yu-yan-ji-suan-ji-ying-yu" class="heading-control">基础语言：计算机英语<a class="heading-anchor" href="#ji-chu-yu-yan-ji-suan-ji-ying-yu" aria-hidden="true"></a></h1>
<p>毋庸置疑，计算机英语是必须彻底把握的首要的最重要的语言。相对于普通英语，计算机英语较为简单，没有过多的变化多样的语法，专业词汇兼简单的语法足矣。这是我们读懂别人写的代码前提要素之一。而后我们对自己代码模块、对象、函数方法、变量，参数的命名也离不开英语，精准，严谨的命名胜过一大段的注释，这也是书写可读性良好的代码的关键要素之一。要知道代码即文章，不过，庆幸的是，代码的文章很简单的，一般只需要初中英语的语法知识就足矣满足需求。而且不会要求你的口语，计算机英语的就是专业词汇量比较大，仅此而已。</p>
<p>目标：</p>
<ul>
<li>用英文词汇正确命名</li>
<li>用英文写代码注释</li>
</ul>
<h2 id="ru-he-xue-xi-ji-suan-ji-ying-yu" class="heading-control">如何学习计算机英语<a class="heading-anchor" href="#ru-he-xue-xi-ji-suan-ji-ying-yu" aria-hidden="true"></a></h2>
<p>阅读科技类的文章可以提高自己的文档写作能力，而开发类的文章则可以提高自己的开发能力。</p>
<h3 id="yue-du-kai-fa-lei-huo-zhe-ke-ji-lei-de-ying-wen-blogs" class="heading-control">阅读开发类或者科技类的英文Blogs<a class="heading-anchor" href="#yue-du-kai-fa-lei-huo-zhe-ke-ji-lei-de-ying-wen-blogs" aria-hidden="true"></a></h3>
<ul>
<li>开发类Blogs
<ul>
<li><a href="http://www.hanselman.com/blog/" target="_blank" rel="noopener">http://www.hanselman.com/blog/</a></li>
<li><a href="http://www.codinghorror.com/blog/" target="_blank" rel="noopener">http://www.codinghorror.com/blog/</a></li>
<li><a href="http://codebetter.com/" target="_blank" rel="noopener">http://codebetter.com/</a></li>
<li><a href="http://highscalability.com/" target="_blank" rel="noopener">http://highscalability.com/</a></li>
<li><a href="http://www.infoq.com/" target="_blank" rel="noopener">http://www.infoq.com/</a>  （ 文章质量和数量大不如以前了）</li>
</ul>
</li>
<li>科技类Blogs
<ul>
<li><a href="http://readwriteweb.com/" target="_blank" rel="noopener">http://readwriteweb.com/</a></li>
<li><a href="http://www.engadget.com/" target="_blank" rel="noopener">http://www.engadget.com/</a></li>
<li><a href="http://gizmodo.com/" target="_blank" rel="noopener">http://gizmodo.com/</a></li>
<li><a href="http://hackedgadgets.com/" target="_blank" rel="noopener">http://hackedgadgets.com/</a></li>
<li><a href="http://venturebeat.com/" target="_blank" rel="noopener">http://venturebeat.com/</a></li>
</ul>
</li>
</ul>
<h3 id="tiao-yi-ge-hao-de-kai-yuan-xiang-mu-kan-ren-jia-shi-zen-mo-xie-de" class="heading-control">挑一个好的开源项目，看人家是怎么写的<a class="heading-anchor" href="#tiao-yi-ge-hao-de-kai-yuan-xiang-mu-kan-ren-jia-shi-zen-mo-xie-de" aria-hidden="true"></a></h3>
<ul>
<li>读 wiki</li>
<li>读代码</li>
</ul>
<p>然后，别忘记了还有https://google.com 和 <a href="http://stackoverflow.com/" target="_blank" rel="noopener">http://stackoverflow.com/</a></p>
<h1 id="xuan-ze-shi-he-zi-ji-de-ji-suan-ji-yu-yan" class="heading-control">选择适合自己的计算机语言<a class="heading-anchor" href="#xuan-ze-shi-he-zi-ji-de-ji-suan-ji-yu-yan" aria-hidden="true"></a></h1>
<p>计算机语言五花八门，真是乱花渐欲迷人眼，泛泛来说，有命令式编程和声明式编程语言；而从用途来分有通用的适合多用途的语言，也有精专某项或几项的语言；从编译器来分，有编译型和解释型的语言；从编程语言模型来说，有面向对象类、过程式语言、函数式语言、逻辑类语言。等等。除开及其个别的编程语言外绝大多数的编程语言都是以英语为基础的。要想选择一门或者一些适合自己的开发语言是比较难，挑选适合自己的语言，我觉得这大概可以由三个因素来决定：</p>
<ul>
<li>基础</li>
<li>用途</li>
<li>目标</li>
</ul>
<h2 id="xue-xi-bian-cheng-yu-yan-de-ji-chu" class="heading-control">学习编程语言的基础<a class="heading-anchor" href="#xue-xi-bian-cheng-yu-yan-de-ji-chu" aria-hidden="true"></a></h2>
<p>如果你想要在编程的路上走得更稳或者更远，那么这些基础必须打牢，对于科班出身的来说，这些是必须的:</p>
<ul>
<li>算法</li>
<li>数据结构</li>
<li>设计模式</li>
</ul>
<p>这些东西，往深了去1，2年时间也不够你啃，不过你也可以根据自己的具体需要掌握基本后按需学习。</p>
<p>你的其它基础知识了解如何？下面是做的一些假定，如果下面的基础都没有，那就无所谓了，随便选看，看自己的爱好来定.</p>
<h3 id="html-xml-css" class="heading-control">HTML/XML/CSS<a class="heading-anchor" href="#html-xml-css" aria-hidden="true"></a></h3>
<p>对于初步掌握html和css的前端人员来说，如果你用过javascript，那么从java或者javascript的某个framework着手自己编程之路可能更容易些；如果你对xml比较熟悉，那么<a href="http://blog.csdn.net/gobitan/article/details/1545998" target="_blank" rel="noopener">XQuery</a>也许也不错，如果你对CSS熟悉并愿意深入，那么从<a href="http://www.cnblogs.com/yizihan/p/4427900.html" target="_blank" rel="noopener">COMPASS</a>/<a href="http://www.w3cplus.com/sassguide/" target="_blank" rel="noopener">SASS</a>开始可能是一条比较有意思的路。</p>
<p>关于SASS介绍：<a href="../sass-lang">在这里</a>。</p>
<p>如果想继续深入前端，可以择一入门，如果要精深，那么MVC作为基础知识是必须要掌握的：</p>
<ul>
<li>Javascript 前端 Frameworks
<ul>
<li>“Mootools”:<a href="http://mootools.net/" target="_blank" rel="noopener">http://mootools.net/</a></li>
<li>“ExtJS”:<a href="http://www.sencha.com/" target="_blank" rel="noopener">http://www.sencha.com/</a></li>
<li>“Dojo”:<a href="http://dojotoolkit.org/" target="_blank" rel="noopener">http://dojotoolkit.org/</a></li>
<li>“JQuery”:<a href="http://jquery.org/" target="_blank" rel="noopener">http://jquery.org/</a> （对初学者阅读该框架代码可能有些难度）</li>
</ul>
</li>
<li>Javsascript 后端，如果想用javascript玩玩后端开发，建议在至少完全掌握一个javascript前端framework之后进行
<ul>
<li>“NodeJS”:<a href="http://nodejs.org/" target="_blank" rel="noopener">http://nodejs.org/</a></li>
</ul>
</li>
</ul>
<h3 id="ji-suan-ji-yi-shu-hua-ux-jiao-hu" class="heading-control">计算机艺术画/UX交互<a class="heading-anchor" href="#ji-suan-ji-yi-shu-hua-ux-jiao-hu" aria-hidden="true"></a></h3>
<p>如果你想通过程式来绘制图画或交互动画，并对电脑绘画和图片文件格式有初步的了解，那么Processing也许是你的选择</p>
<ul>
<li><a href="http://processing.org/" target="_blank" rel="noopener">http://processing.org/</a></li>
</ul>
<p>简单的介绍：<a href="../processing-language">在这里</a></p>
<h3 id="sql-dba" class="heading-control">SQL/DBA<a class="heading-anchor" href="#sql-dba" aria-hidden="true"></a></h3>
<p>if u r a DBA, and learn sql well. maybe you are interested in the following sth:</p>
<ul>
<li><a href="http://www.datatables.org/" target="_blank" rel="noopener">YQL and community Open Data tables</a></li>
<li>NoSQL
<ul>
<li><a href="http://www.unqlspec.org/display/UnQL/Home" target="_blank" rel="noopener">UnQL</a></li>
<li><a href="http://www.datastax.com/dev/blog/what%E2%80%99s-new-in-cassandra-0-8-part-1-cql-the-cassandra-query-language" target="_blank" rel="noopener">Cassandra Query Language (CQL)</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/Home" target="_blank" rel="noopener">Apache Hive(Hadoop)</a></li>
</ul>
</li>
</ul>
<h3 id="math-statistics" class="heading-control">Math/Statistics<a class="heading-anchor" href="#math-statistics" aria-hidden="true"></a></h3>
<p>对于搞数学或统计的人来说，那么FORTRAN, MatLab/Octave, Python+Matplotlib 是不错的选择，个人首选推荐Python系列，不过如果是专业统计那么R语言比较合适。</p>
<ul>
<li><a href="http://www.python.org/" target="_blank" rel="noopener">“Python”</a>
<ul>
<li><a href="http://matplotlib.sourceforge.net/" target="_blank" rel="noopener">“Matplotlib”</a></li>
<li><a href="http://www.scipy.org/SciPy" target="_blank" rel="noopener">“SciPy+NumPy”</a>
<ul>
<li><a href="http://www.scipy.org/NumPy_for_Matlab_Users" target="_blank" rel="noopener">“NumPy guide for Matlab users”</a></li>
<li><a href="http://mpi4py.scipy.org/" target="_blank" rel="noopener">“MPI clusters”</a></li>
<li><a href="http://mathema.tician.de/software/pycuda" target="_blank" rel="noopener">“GPUs”</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="http://www.r-project.org/" target="_blank" rel="noopener">“R Language”</a></li>
<li><a href="http://www.octave.org/" target="_blank" rel="noopener">“类MatLab的开源Octave”</a></li>
</ul>
<h2 id="xue-xi-bian-cheng-yu-yan-de-yong-tu" class="heading-control">学习编程语言的用途<a class="heading-anchor" href="#xue-xi-bian-cheng-yu-yan-de-yong-tu" aria-hidden="true"></a></h2>
<p>你想用它来干嘛？这个也可以参考前面1节。</p>
<h2 id="xue-xi-bian-cheng-yu-yan-de-zhong-ji-mu-biao" class="heading-control">学习编程语言的终极目标<a class="heading-anchor" href="#xue-xi-bian-cheng-yu-yan-de-zhong-ji-mu-biao" aria-hidden="true"></a></h2>
<p>你最终想攀登（到达）一个什么样的山峰？</p>
<p>下面是我推荐的学习顺序 <code>1-&gt;2,3,4,6-&gt;5</code>,其中2，3，4，6应该可以并行阅读。不过5(算法和设计)应该在至少修完2，3后开始阅读。</p>
<ol>
<li>计算机科学入门: 我以为应该是入门的
<ul>
<li><a href="https://www.coursera.org/course/cs101" target="_blank" rel="noopener">斯坦福大学 计算机科学入门课程</a></li>
</ul>
</li>
<li>计算机科学及Python编程导论 这个是非常棒的计算机开发入门课程(授课老师Prof. Eric Grimson是MIT的副校长, 此为MIT Online课程)不过是用python语言作为示范讲解的：</li>
</ol>
<ul>
<li><a href="http://mooc.guokr.com/course/244/Introduction-to-Computer-Science-and-Programming-Using-Python/" target="_blank" rel="noopener">中文介绍</a></li>
<li>上课地址：<a href="https://www.edx.org/course/introduction-computer-science-mitx-6-00-1x-0#.U_HC-_mSxSU" target="_blank" rel="noopener">introduction-computer-science</a></li>
<li><a href="http://open.163.com/special/opencourse/bianchengdaolun.html" target="_blank" rel="noopener">中文字幕</a>(建议和英文字幕对照看，据说翻译有点渣)</li>
</ul>
<ol start="3">
<li>编程入门</li>
</ol>
<ul>
<li>java
<ul>
<li>推荐书籍:
<ol>
<li><a href="http://pan.baidu.com/wap/album/file?uk=1194571246&amp;album_id=2582121585932296218&amp;fsid=3195473174" target="_blank" rel="noopener">java编程思想第4版.pdf</a></li>
<li><a href="http://pan.baidu.com/wap/link?uk=3123832520&amp;shareid=3024054320&amp;third=1" target="_blank" rel="noopener">Java编程思想(第4版 英文版).pdf</a></li>
<li><a href="http://pan.baidu.com/wap/link?uk=2721512979&amp;shareid=507450&amp;third=0" target="_blank" rel="noopener">大话JAVA：从零基础到数据库、WEB开发 PDF</a></li>
<li><a href="http://google.github.io/styleguide/javaguide.html" target="_blank" rel="noopener">Google Java 编程规范</a></li>
</ol>
<ul>
<li><a href="https://github.com/codeset/google-java-styleguide" target="_blank" rel="noopener">中</a></li>
</ul>
<ol start="5">
<li><a href="http://pan.baidu.com/wap/link?uk=1057303646&amp;shareid=2705566019&amp;third=0" target="_blank" rel="noopener">Head First Java, 2nd Edition 高质非扫描版</a></li>
</ol>
<ul>
<li><a href="http://pan.baidu.com/wap/link?uk=1613735521&amp;shareid=1685526979&amp;third=0" target="_blank" rel="noopener">Head First Java(中文版)(第2版)(涵盖Java5.0).pdf</a></li>
</ul>
</li>
<li>下面的<strong>MOOC课程</strong>你自己看看哪一个更适合你(可以在<a href="http://open.163.com/" target="_blank" rel="noopener">网易公开课</a>上找对应带中文字幕的课程):
<ol>
<li><a href="https://www.udacity.com/course/intro-to-java-programming--cs046" target="_blank" rel="noopener">Intro to Java ProgrammingBuilding Programs with Classes &amp; Objects</a></li>
<li><a href="https://www.edx.org/course/introduction-programming-java-part-1-uc3mx-it-1-1x#.VQZrMo6Ueo0" target="_blank" rel="noopener">Java编程导论 - 第1部分：开始使用Java编程</a></li>
<li><a href="https://www.edx.org/course/introduction-java-programming-part-1-hkustx-comp102-1x" target="_blank" rel="noopener">Introduction to Java Programming – Part 1(香港大学 港式英语很High)</a></li>
</ol>
</li>
</ul>
</li>
<li>c 语言
<ul>
<li>courses:
<ul>
<li><a href="http://www.icourse163.org/course/zju-199001#/info" target="_blank" rel="noopener">程序设计入门——C语言（浙大）</a></li>
<li><a href="https://www.coursera.org/course/cprogramming" target="_blank" rel="noopener">计算机程序设计-C 台湾大学</a></li>
</ul>
</li>
<li>books:
<ul>
<li><a href="http://akaedu.github.io/book/" target="_blank" rel="noopener">C编程一站式学习</a></li>
</ul>
</li>
</ul>
</li>
<li>编程相关指导书籍
<ul>
<li><a href="http://pan.baidu.com/wap/link?uk=1614005835&amp;shareid=1886001644&amp;third=1" target="_blank" rel="noopener">《程序设计实践》中文</a>
<ul>
<li><a href="http://pan.baidu.com/wap/link?shareid=328163782&amp;uk=2970225049&amp;third=3&amp;dir=%2F%E5%B7%A5%E4%BD%9C%E8%88%87%E5%AD%B8%E7%BF%92%2F%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99%2F%5BPT%5D.C%2B%2B%E5%AD%A6%E4%B9%A0%E5%85%A8%E7%A8%8B%E4%B9%A6%E7%B1%8D%E4%B8%AD%E8%8B%B1%E6%96%87pdf%2FThe%20Practice%20of%20Programming&amp;page=1&amp;" target="_blank" rel="noopener">The Practice of Programming pdf</a></li>
</ul>
</li>
<li>《Code Complete[代码大全]》: 一书在手开发无求
<ul>
<li><a href="http://pan.baidu.com/wap/link?uk=3389964651&amp;shareid=514781&amp;third=3" target="_blank" rel="noopener">Code Complete 代码大全 – 第2版(中文版).pdf</a></li>
<li><a href="http://pan.baidu.com/wap/link?uk=2801929386&amp;shareid=493255&amp;third=3" target="_blank" rel="noopener">Code Complete 代码大全 – 第2版(英文版).pdf</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ol start="4">
<li>计算机组成原理(basics of technical computer science,猜的可能是讲这个)</li>
</ol>
<ul>
<li>课程:
<ul>
<li><a href="http://www.chinesemooc.org/mooc/4392" target="_blank" rel="noopener">计算机组成(北大)</a></li>
<li><a href="https://www.coursera.org/course/hwswinterface" target="_blank" rel="noopener">The Hardware/Software Interface 课程</a>
<ul>
<li>(对初学者来说有些深，不过课程非常棒): 可能至少要修完Introduction to Java，才能完全看懂</li>
</ul>
</li>
</ul>
</li>
<li>书籍(可能有些深，国内的太渣，据说北大那个课程讲得还行):
<ul>
<li><a href="http://pan.baidu.com/wap/link?uk=908410137&amp;shareid=2879930344&amp;third=0" target="_blank" rel="noopener">深入理解计算机系统(原书第2版)英文版.pdf</a></li>
<li><a href="http://pan.baidu.com/wap/link?uk=4227866569&amp;shareid=1706493678&amp;third=0" target="_blank" rel="noopener">深入理解计算机系统 中文.pdf</a>
<ul>
<li>The Hardware/Software Interface 课程 指定用书</li>
</ul>
</li>
<li><a href="http://pan.baidu.com/wap/link?uk=1946220390&amp;shareid=18873311&amp;third=0" target="_blank" rel="noopener">计算机组成与设计：硬件、软件接口（第三版中文）.pdf</a></li>
<li><a href="http://pan.baidu.com/wap/shareview?&amp;shareid=678623063&amp;uk=1862273438&amp;dir=%2F%E8%AF%BB%E7%A7%80%E8%B5%84%E6%96%99&amp;page=3&amp;num=20&amp;fsid=688886060&amp;third=0" target="_blank" rel="noopener">计算机组成与设计：硬件、软件接口（原书第4版）.pdf</a></li>
</ul>
</li>
</ul>
<ol start="5">
<li>算法与设计</li>
</ol>
<ul>
<li>课程:
<ul>
<li><a href="https://www.coursera.org/course/algs4partI" target="_blank" rel="noopener">算法，第一部分(普林斯顿大学)</a></li>
<li><a href="https://www.coursera.org/course/algs4partII" target="_blank" rel="noopener">算法，第二部分(普林斯顿大学)</a></li>
</ul>
</li>
<li>书籍
<ul>
<li><a href="http://pan.baidu.com/share/link?uk=2184679390&amp;shareid=419524&amp;third=3" target="_blank" rel="noopener">算法 第4版-谢路云 译(Java描述) pdf</a></li>
<li><a href="http://pan.baidu.com/wap/link?uk=940665991&amp;shareid=1729537564&amp;third=3" target="_blank" rel="noopener">算法 第4版Algorithms 4th Edition.pdf</a></li>
<li><a href="http://pan.baidu.com/wap/link?uk=1577879470&amp;shareid=645166851&amp;third=3" target="_blank" rel="noopener">设计模式之禅.pdf</a></li>
<li>设计模式 可复用面向对象软件的基础 Design.Patterns,.Elements.Of.Reusable.Object.Oriented.Software
<ul>
<li><a href="http://www.sendsms.cn/box/dl/_25B1_25E0_25B3_25CC_25BC_25BC_25CA_25F5/_25D4_25AD_25C0_25ED_25CB_25BC_25CF_25EB/_25C9_25E8_25BC_25C6_25BC_25DC_25B9_25B9/_25C9_25E8_25BC_25_0875C83619" target="_blank" rel="noopener">中</a></li>
<li><a href="http://pan.baidu.com/wap/shareview?&amp;shareid=809818578&amp;uk=2869779580&amp;dir=%2F%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B&amp;page=1&amp;num=20&amp;fsid=2203721337&amp;third=0" target="_blank" rel="noopener">英</a></li>
</ul>
</li>
<li>Head First Design Patterns 设计模式(高清版)
<ul>
<li><a href="(http://pan.baidu.com/wap/link?uk=1343102438&amp;shareid=1982573272&amp;third=3)">中</a></li>
<li><a href="http://pan.baidu.com/wap/link?uk=4030029226&amp;shareid=1265604584&amp;third=0" target="_blank" rel="noopener">英</a></li>
</ul>
</li>
</ul>
</li>
<li><code>算法_模式_架构</code>书籍汇集:
<ul>
<li><a href="http://pan.baidu.com/share/link?shareid=1210846675&amp;uk=1076602916&amp;third=3&amp;page=1&amp;dir=/Java&amp;#path=%252FJava%252F%25E7%25AE%2597%25E6%25B3%2595_%25E6%25A8%25A1%25E5%25BC%258F_%25E6%259E%25B6%25E6%259E%2584" target="_blank" rel="noopener">算法 模式 架构</a></li>
</ul>
</li>
</ul>
<ol start="6">
<li>操作系统概念</li>
</ol>
<ul>
<li>Courses:</li>
<li><a href="http://mooc.study.163.com/course/HIT-1000002004#/info" target="_blank" rel="noopener">操作系统之基础(哈尔滨大学)</a></li>
<li>Books:
<ul>
<li><a href="http://pan.baidu.com/wap/link?uk=788966016&amp;shareid=421794&amp;third=0" target="_blank" rel="noopener">操作系统概念第七版中文版.pdf</a></li>
<li><a href="http://pan.baidu.com/wap/link?uk=2117599147&amp;shareid=443667&amp;third=6" target="_blank" rel="noopener">操作系统概念 (第9版).zip</a></li>
</ul>
</li>
</ul>
<ol start="7">
<li>其它</li>
</ol>
<ul>
<li><a href="http://pan.baidu.com/share/link?uk=3710133669&amp;shareid=432998199&amp;fid=284720175" target="_blank" rel="noopener">数据库系统概念 中文</a></li>
<li><a href="http://pan.baidu.com/share/link?&amp;shareid=2247901396&amp;uk=1125778630" target="_blank" rel="noopener">数据库系统概念第六版Database System Concepts.pdf</a></li>
<li><a href="http://pan.baidu.com/wap/shareview?&amp;shareid=2681801025&amp;uk=3778155569&amp;dir=%2F%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6%E7%9A%84%E6%95%B0%E5%AD%A6%E5%9F%BA%E7%A1%80&amp;page=1&amp;num=20&amp;fsid=3497987523&amp;third=0" target="_blank" rel="noopener">具体数学-计算机科学基础.rar</a></li>
<li><a href="http://pan.baidu.com/wap/link?shareid=117265344&amp;uk=540536034&amp;third=3" target="_blank" rel="noopener">计算机科学45部经典著作</a>
<ul>
<li>C语言程序设计</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>Learning</category>
        <category>Programming</category>
      </categories>
      <tags>
        <tag>programming</tag>
        <tag>howto</tag>
        <tag>computer language</tag>
      </tags>
  </entry>
  <entry>
    <title>虚拟现实（VR）体验</title>
    <url>/article/vr/</url>
    <content><![CDATA[<p>HTC Vive 到手，我也好好体验了一把沉浸式虚拟现实，的确震撼，尽管目前好的内容还不是很多。真的世界变了，不提游戏，很多经验的教学，难以实作的实验，在沉浸式虚拟现实中都将被改写，人类获取另类的知识体系将变容易。体验，免除危险的体验模式，从未来迎面而来。我还是先讲述自己的个人体验感受，最后再说下虚拟现实以及相关技术分析。</p>
<h2 id="xu-ni-xian-shi" class="heading-control">虚拟现实<a class="heading-anchor" href="#xu-ni-xian-shi" aria-hidden="true"></a></h2>
<p>虚拟现实（Virtual Reality），又称虚拟实境，简单来说就是用电脑模拟一个虚拟世界，让人感觉自己完全置身于这个虚拟的世界当中，从而忘掉自己所处的真实世界。目前主要是通过对人的眼睛和耳朵的欺骗，以及附加在头盔上的传感器来实现VR。</p>
<p>尽管离《黑客帝国》描述的场景距离还相当长远，但至少目前已经可以让人产生身在虚拟世界的幻觉了。尽管依然存在这样那样的不足:</p>
<ul>
<li>纱窗效应，因为屏幕离眼睛的距离近，所以可以看到点阵，但是可以忍受。
<ul>
<li>vive 和 rift 的单眼屏幕分辨率为: 1080 x 1200, 90HZ的刷新率，110度的视场。</li>
<li>psvr 的单眼屏幕分辨率为: 960 x 1080, 120hz刷新率。</li>
</ul>
</li>
<li>如果没有近视的人，那么看久了眼睛会难受，毕竟屏幕放得太近了，当然可以调整镜片的距离（牺牲视场）
<ul>
<li>好处是，如果有轻度近视，那么不需要带眼镜也可以玩，如果一定要带眼镜，那么尽量选择度数浅些的眼镜</li>
</ul>
</li>
<li>线缆一不留意就会缠住自己【Vive的房间模式】</li>
<li>如果在虚拟世界中身体处于运动状态，但是实际身体并没有运动下，会导致眩晕，尤其是在没有任何理由的情况下，出现场景移动或者漂移。</li>
</ul>
<h2 id="ti-yan" class="heading-control">体验<a class="heading-anchor" href="#ti-yan" aria-hidden="true"></a></h2>
<p>当置身于场景进行互动的时候，你会很快忘记视野前的栅格，进入一个个风格迥异的异世界。</p>
<h3 id="hover-junkers" class="heading-control">Hover Junkers<a class="heading-anchor" href="#hover-junkers" aria-hidden="true"></a></h3>
<p>首先值得一说的就是{《Hover Junkers》}，这是一款联机多人枪战的游戏，主要是驾驶气垫船分队互相射击。也可能是有史以来第一个VR多人竞技射击游戏。直译为：漂浮掠夺客。目前还处于EA(Early Access)状态。</p>
<ul>
<li>好玩性: 高</li>
<li>眩晕度: 轻微</li>
</ul>
<p><img src="./hover-junkers.jpg" alt></p>
<p>玩家是在一辆漂浮的战车上游戏,游戏刚开始在休息室选择自己的角色,随后便会加载到战车上,在战车上他们可以随意走动,<br>
也可以用手拿起左轮手枪、猎枪或其他枪支瞄准射击。玩家也可以驾驶他们的战车驰骋在大战场上,也可以捡起地上的木板、铁块碎屑装备在战车边上的凹槽位。游戏的中心环绕在掠夺四周的货物，这些货物可以拿来创造自己船上的掩蔽物，也可以换作游戏积分。当你遇到另一个竞争玩家时，迟早枪战就要跟着发生。当然你可以选择对战或是逃跑，甚至可以试着跟他们交换物资。</p>
<p>不过，我们几乎大部分人都是将其作为枪战射击的开玩，很少关注四周货物，只要发现有船，追靠近就射击，还有人甚至不关心分队，自己队的照打无误，不过这也和没有明显的分队标识有关系(v1.0.6已经好多了)，但是要有人，凑个8个人，节奏就很紧张了，尤其是两人配合在一条船上。没有人的话，就没法玩了，目前还没有bot,只能和人打，有机器人的bot版本得等到 v1.1。加入同一team的人会在休息室里，不过其他人，只能看到一双手套和一副眼镜。如果不了解的人，还以为是手套眼镜乱飞，可以直接语音。</p>
<p>驾驶船只以及枪支的设计都充分的利用到了HTC Vive控制器的特性。</p>
<p>身临其境驾船</p>
<p><a href="http://www.bilibili.com/video/av3960772/" target="_blank" rel="noopener">http://www.bilibili.com/video/av3960772/</a></p>
<h3 id="the-lab" class="heading-control"><a href="http://store.steampowered.com/app/450390" target="_blank" rel="noopener">《The Lab》</a><a class="heading-anchor" href="#the-lab" aria-hidden="true"></a></h3>
<p>最后想说的是: Valve 的 <a href="http://store.steampowered.com/app/450390" target="_blank" rel="noopener">《The Lab》</a>。</p>
<h3 id="guan-jian-ji-shu" class="heading-control">关键技术<a class="heading-anchor" href="#guan-jian-ji-shu" aria-hidden="true"></a></h3>
<p>虚拟现实（Virtual Reality），又称虚拟实境，利用电脑模拟产生一个3D空间的虚拟世界，提供用户关于视觉等感官的模拟，让用户如同身历其境一般，可以及时、没有限制地观察3D空间内的事物。虚拟世界的空间位置会随用户的移动而移动，低头看地，抬头看天，都会响应变化。</p>
<p>早在1935年<a href="https://en.wikipedia.org/wiki/Stanley_G._Weinbaum" target="_blank" rel="noopener">Stanley G. Weinbaum</a>的短篇科幻小说《Pygmalion’s Spectacles》描述了包括嗅觉、触觉和全息护目镜为基础的虚拟现实系统。</p>
<p>目前的虚拟现实眼镜主要使用到的关键技术如下：</p>
<ul>
<li>立体视觉(Stereopsis):使用正常的双眼看东西的时候，我们感觉到的物体是有深度和距离的。以前的显示头盔均可做到，但是他们是通过透镜让人感觉是5米开外的200寸的大屏。而VR头盔做的是相反，尽量让</li>
<li>头部跟踪(Head track):对六自由度的头部运动进行跟踪反馈。早在2001年用于头部运动跟踪(6DOF)的TrackIR就是先驱，多用于飞行驾驶游戏，有超过100多个游戏支持。
<ul>
<li>开源方案：<a href="https://github.com/opentrack/opentrack" target="_blank" rel="noopener">OpenTrack</a></li>
<li>在网上甚至可以搜索到开源硬件的解决方案:<a href="http://edtracker.org.uk/" target="_blank" rel="noopener">EDTracker</a>，这也是oculus rift可以得以研发出来的土壤。</li>
</ul>
</li>
<li>室内定位(走动):
<ul>
<li>惯性定位: 加速度+磁力计+陀螺仪（有漂移，据说放在脚部效果最好，3‰的精度，也就是走1km误差累计3m）</li>
<li>基站定位:
<ul>
<li>无线信号基站(Nanotron,DecaWave)：至少需要三个基站(5-10cm精度，无漂移)。</li>
<li>激光扫描定位(Lighthouse): HTC Vive采用，两颗激光发射器安置房间对角，激光束由发射器里面的两排固定LED灯发出，每秒6次。每个激光发射器内设计有两个扫描模块，分别在水平和垂直方向轮流对定位空间发射横竖激光扫描15×15英尺的定位空间。头盔和手柄上有超过70个光敏传感器。激光扫过的同时，头盔开始计数，传感器接收到激光后，利用传感器位置和接收激光时间的关系，计算相对于激光发射器的准确位置。同一时间内激光束击中的光敏传感器足够多，就能形成一个3D的模型。不仅能探测出头盔和手柄的位置，还可以捕捉到头盔和手柄的方向。</li>
</ul>
</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>Thinking</category>
        <category>VR</category>
      </categories>
      <tags>
        <tag>thinking</tag>
        <tag>tech</tag>
        <tag>vr</tag>
        <tag>virtual reality</tag>
      </tags>
  </entry>
  <entry>
    <title>移动互联网（物联网）思维的探索</title>
    <url>/article/explore-thinking-of-internet/</url>
    <content><![CDATA[<p>要理解移动互联网首先要理解互联网，要搞清楚互联网思维是啥，首先也要理解互联网的本质，而要理解互联网的本质则首先要从互联谈起，何谓互联，互，彼此也；联，沟通也。互联网就是搭建的P2P的彼此沟通的网络。那么何谓移动，移动我的理解是设备，尤其是随身设备的上网能力。那么移动互联网和互联网有什么不同之处么？我觉得没有根本的不同，唯一不同的是时间和地点，从间断固定到随时随地。对于家居设备的上网，目前炒作的物联网(IoT)，也只不过是将一个个的设备作为“网上服务”放到了家庭，使得我们可以在家以外也能控制而已。因此这里说道的移动互联网思维其实主要还是在探索互联网思维。</p>
<h1 id="hu-lian-wang-de-ben-zhi" class="heading-control">互联网的本质<a class="heading-anchor" href="#hu-lian-wang-de-ben-zhi" aria-hidden="true"></a></h1>
<p>无论移动互联网还是互联网，我们如果思考下它的本质，想想它的本质是什么？那么不难发现，它的本质无疑是最终用户(Peer)的互联互通。那么互联互通的本质又是什么？而当互联网最终用户膨胀到足够规模的时候，我们发现，它正在改变世界。Why? 它是如何做到的呢？</p>
<p>互联网的本质是对等（互联），因为要对等互联，所以才有了开放和标准。因为完全开放和标准化，才有足够多组织细胞接入，从而形成群体。群体在互联网上产生信息和消费信息，从而导致信息爆炸大数据。</p>
<h2 id="kai-fang-yu-biao-zhun" class="heading-control">开放与标准<a class="heading-anchor" href="#kai-fang-yu-biao-zhun" aria-hidden="true"></a></h2>
<blockquote>
<p>故事开始于上世纪50年代后期，在冷战高峰期，美国国防部希望建立一个命令和控制网络（Command and Control），即使在遭受核打击的情况下它也能保存下来。在当时，所有的军事通信都要使用公共电话网络，而电话网络被认为非常脆弱，如下图左边的图所示，黑色的点代表电话交换局，每个电话交换局连接了几千部电话，然后，这些交换局有链接到更高层次的交换局，从而形成全国性的层次（hierarchy）结构。整个结构只有少量冗余，但整个系统十分脆弱，一旦关键的交换局被破坏，则整个系统有可能被分成几个孤岛。<br>
1960年左右，国防部给了RAND公司（大名鼎鼎的兰德公司）一份合同，希望RAND为自己寻找一个解决方案，Paul Baran负责这个任务，提出了一个高度分布式和容错性的设计方案，如下图右所示。Baran给国防部提供了11份报告来详细阐述他的思想，五角大楼也接受了这种概念，并且请AT&amp;T公司、然后是美国国家电话局来建立一个原型系统。但是这遭到AT&amp;T公司的拒绝。今天的我们很难理解当时AT&amp;T的强大势力，它不只是大公司，还是政府的合作伙伴，统治着美国的通讯业。自1912年电话互联时代开始，AT&amp;T就成为美国电信业的主宰者。AT&amp;T在这场竞争大赛赢得胜利的最有力武器是向竞争者提供的互联的能力，这似乎有些自相矛盾。虽然自觉告诉我们,似乎是互联的失败阻碍了竞争，但是事实上，正是互联的匮乏导致（刺激）了竞争。随着那些独立系统和AT&amp;T互联后，那些独立公司所拥有的独特的优势都消失了，用户不再抛弃AT&amp;T，AT&amp;T垄断的力量得到了进一步加强。</p>
</blockquote>
<h2 id="qu-zhong-xin-hua" class="heading-control">去中心化<a class="heading-anchor" href="#qu-zhong-xin-hua" aria-hidden="true"></a></h2>
<p>谈去中心化，就要先从中心化谈起了。“中心化”，是和社会性网络中的概念“结构洞”(structural holes)息息相关的，结构洞是“社会网络中的某个或某些个体和有些个体发生直接联系，但与其他个体不发生直接联系，无直接联系或关系间断(disconnection)的现象，从网络整体看好像网络结构中出现了洞穴”。简单地说，当你想要联系到A，但是只能通过B才能联系到，那么你与B之间的链接缺失就可能是一个结构洞，而B作为占据者就产生了竞争优势。你可以简单的认为B就是“中心化”，当然仅仅从关系的缺失角度并不能完全说明结构洞，如果想全面了解，请自行参考社会网络中的相关章节。“结构洞”能够为其占据者获取“信息利益”和“控制利益”提供机会，从而比网络中其他位置上的成员更具有竞争优势。</p>
<p>而“去中心化”就是要减少“中心化”结构洞带来的竞争优势，减少信息不对称的出现，把“中心化”降权，让信息充分流通，这就是我们在互联网中常说道的对等网路。Ok, 既然人人都是对等的，那么也就意味着是人人都是中心，当然这说的是在理想状态下。现实中，“结构洞”比比皆是，只不过每一次针对“中心化”的降权，都会在互联网引起一场模式的革命，比如:草根媒体, twitter, 众包，众筹。</p>
<h2 id="zhong-yu-cheng-zhi" class="heading-control">众愚成智<a class="heading-anchor" href="#zhong-yu-cheng-zhi" aria-hidden="true"></a></h2>
<p>让完全不懂驾驶飞机的人去开飞机，结果会如何，而如果让一群不懂驾驶飞机的人去开同一架飞机，那又会如何？</p>
<blockquote>
<p>罗伦·卡朋特是一名电脑图形图像专家。1991年他策划了一个由五千人共同参与的“飞行器模拟控制”的游戏屏幕显示飞机的初始场景是在空中，飞行员则是……五千名新手。透过挡风玻璃可以感到飞机正朝着小山之间的山谷降落，而跑道看上去非常小。此时作为乘客，每个人都有权参与表决，但群体的智慧在着陆时似乎成了不利条件。一部分人大喊：“绿！绿！”一会儿，另一部分人大喊：“红色再多一点！”机身左倾错过了跑道，机翼先着陆了。飞行模拟更为复杂，从液压杆到机身反应，从副翼杆到机身转向都设定了一段时间的延迟反馈。这些隐藏的信号干扰了群体的思维。而在飞机即将坠毁的时刻，群体出乎意料的放弃了着陆，拉起机头，他们要重来一次。一段尝试过后飞机旋转了360°，五千名飞行员无声的共识让机身在空中打了个滚，他们安全着陆了。没有人做出某个决定，左转还是右转，甚至转不转都没人决定。但是他们成功了，他们做到了鸟儿做的事：成功的结成了一群。这种结群的行为是自觉的。一只鸟对鸟群是没有全局概念的，对鸟群的飞行姿态和聚合是视而不见的。“群态”正是从这样一群完全罔顾其形状、大小或队列的生物中涌现出来的。</p>
</blockquote>
<blockquote>
<p>在《蝙蝠侠归来》中有一个场景，一大群黑色大蝙蝠一窝蜂地穿越水淹的隧道涌向纽约市中心。这些蝙蝠是由电脑制作的。动画制作者先制作一只蝙蝠，并赋予它一定的空间以使之能自动地扇动翅膀；然后复制出几十个蝙蝠，直至成群。之后，让每只蝙蝠独自在屏幕上四处飞动，但要遵循算法中植入的几条简单的规则：</p>
</blockquote>
<ul>
<li>不要撞上其他的蝙蝠，</li>
<li>跟上旁边的蝙蝠，</li>
<li>离队不要太远。</li>
</ul>
<p>当这些“算法蝙蝠”在屏幕上运动起来，就如同真的蝙蝠一样成群结队而行。</p>
<p>一只鸟并不是一只硕大的鸟。科学报道记者詹姆斯•格雷克写道：“单只鸟或一条鱼的运动，无论怎样流畅，都不能带给我们像玉米地上空满天打旋的燕八哥或百万鲰鱼鱼贯而行的密集队列所带来的震撼。……（鸟群疾转逃离掠食者的）高速电影显示出，转向的动作以波状传感的方式，以大约七十分之一秒的速度从一只鸟传到另一只鸟。比单只鸟的反应快得多。”鸟群远非鸟的集合。</p>
<blockquote>
<p>群集规律是由克雷格•雷诺兹发现的。他是在图像硬件制造商Symbolics工作的计算科学家。他有一个简单的方程，通过对其中各种作用力的调整——多一点聚力，少一点延迟——雷诺兹能使群体的运动形态像活生生的蝙蝠群、麻雀群或鱼群。甚至在《蝙蝠侠归来》中的行进中的企鹅群也是根据雷诺兹的运算法则聚合的。像蝙蝠一样，先一股脑地复制很多计算机建模的三维企鹅。然后把它们释放到一个朝向特定方向的场景中。当它们行进在积雪的街道上，就轻易地出现了推推搡搡拥挤的样子，不受任何控制。雷诺兹的简单算法所生成的群体是如此真实，以至于当生物学家们回顾了自己所拍摄的高速电影后，他们断定，真实的鸟类和鱼群的群体行必然源自于一套相似的简单规则。群体曾被看作是生命体的决定性象征，某些壮观的队列只有生命体才能实现。如今根据雷诺兹的算法，群体被看作是一种自适应的技巧，适用于任何分布式的活系统，无论是有机的还是人造的。两种极端的途径会创造“更多”。一种途径是按照顺序操作的思路来构建系统，就像工厂的装配流水线一样。这类顺序系统的原理类似于钟表的内部逻辑——通过一系列复杂动作来映衬出时间的流逝。大多数机械系统遵循的都是这种逻辑。还有另外一种极端的路径。我们发现，许多系统都是将并行运作的不见拼接在一起，很像大脑的神经元网络或者蚂蚁群落。这类系统的运作是从一大堆乱糟糟且又彼此关联的事件中产生的。它们不再像钟表那样，由离散的方式驱动并以离散的方式显现，更像是有成千上万个发条在一起驱动一个并行是系统。由于不存在指令链，人一根发条的某个特定动作都会传递到整个系统，而系统的局部表现也更容易被系统的整体表现所掩盖。从群体中涌现出来的不再是一系列起关键作用的个体行为，而是众多的同步动作。这些同步动作所表现出的群体模式要更重要得多。这就是群体的模型。</p>
</blockquote>
<p>群体的优势:</p>
<ul>
<li>可适应性</li>
<li>可进化性</li>
<li>富有弹性</li>
<li>无限性</li>
<li>新颖性</li>
</ul>
<p>群体的缺点:</p>
<ul>
<li>非最优性</li>
<li>不可控性</li>
<li>不可预测性</li>
</ul>
<p>在群逻辑的优缺点中进行取舍就如同在生物活系统的成本和受益之间进行抉择一样——假如我们需要这样做的话。但由于我们是伴随着生物系统长大的，而且别无选择，所以我们总是不加考虑地接受它们的成本。</p>
<p>群突出了真实事物复杂的一面。它们不合常规。群计算的数学延续了达尔文有关动植物经历无规则变异而产生无规律种群的革命性研究。群逻辑试图理解不平衡性，度量不稳定性，测定不可预知性。用詹姆斯•格雷克的话来说，这是一个尝试，以勾画出“无定形的形态学”——即给似乎天生无形的形态造型。科学已经解决了所有的简单任务——都是清晰而简明的信号。现在它所面对的只有噪音，它必须直面生命是杂乱。</p>
<h2 id="da-shu-ju-xin-xi-bao-zha" class="heading-control">大数据(信息爆炸)<a class="heading-anchor" href="#da-shu-ju-xin-xi-bao-zha" aria-hidden="true"></a></h2>
<p>每一个用户都可以自由的创建内容，</p>
<h1 id="hu-lian-wang-si-wei" class="heading-control">互联网思维<a class="heading-anchor" href="#hu-lian-wang-si-wei" aria-hidden="true"></a></h1>
<p>现在我们可以来探索到底什么样的思维才算是互联网思维？让我们再回顾下互联网的本质。</p>
<p>互联网的本质是对等（互联），因为要对等互联，所以才有了开放和标准。因为完全开放和标准化，才有足够多组织细胞接入，从而形成群体。群体在互联网上产生信息和消费信息，从而导致信息爆炸大数据。随后我们有了眼球经济，主张自我，以个体为中心。</p>
<p>那么透过互联网的本质来看互联网的思维，在我看来不外就是自由、开放、平等、分享。</p>
<p>我们可以想象，当信息对等之后，很多利用信息黑洞赚取差价的捎客就消失，当网络打通了地域限制后，新兴的行业搅局者势必打破行业垄断，发明新的玩法，从而使得，原来有利可图的点，变成白纸，免费成为一个在互联网上打击竞争对手的一个重要手段。</p>
<p>当然，信息完全彻底对等，还是一个梦想，但是因为互联网，我们正在看到的是信息正在慢慢的越来越对等起来，“人民真正当家做主”也离我们越来越近，未来某一天，不在有“公仆”，不在有“特权”。</p>
<p>纵观人类历史，</p>
<p>改变世界 因为互联网</p>
<p>足够多的人（基数够大），足够多的玩法</p>
<p>计划经济 -&gt; 市场经济 -&gt; 计划经济 -&gt; 市场经济</p>
<h1 id="wu-lian-wang-si-wei" class="heading-control">物联网思维<a class="heading-anchor" href="#wu-lian-wang-si-wei" aria-hidden="true"></a></h1>
<p>(To be continued…)</p>
<p>参考:</p>
<ul>
<li><a href="http://www.internetsociety.org/zh-hans/%E4%BA%92%E8%81%94%E7%BD%91/%E4%BB%80%E4%B9%88%E6%98%AF%E4%BA%92%E8%81%94%E7%BD%91%EF%BC%9F/%E4%BA%92%E8%81%94%E7%BD%91%E5%8E%86%E5%8F%B2/%E4%BA%92%E8%81%94%E7%BD%91%E7%AE%80%E5%8F%B2" target="_blank" rel="noopener">《互联网简史》</a></li>
<li><a href="http://read.mlook.mobi/read/27/page/index.html" target="_blank" rel="noopener">《失控》</a></li>
<li>《思想的未来》</li>
<li>《开源的成功之路》</li>
</ul>
]]></content>
      <categories>
        <category>Thinking</category>
        <category>Internet</category>
        <category>IOT</category>
      </categories>
      <tags>
        <tag>thinking</tag>
        <tag>tao</tag>
        <tag>internet</tag>
        <tag>explore</tag>
        <tag>p2p</tag>
        <tag>iot</tag>
      </tags>
  </entry>
  <entry>
    <title>用 Javascript 开发桌面应用的框架工具列表</title>
    <url>/article/js-desktop-sdk/</url>
    <content><![CDATA[<p>随着近两年来nodejs的迅速走红（这个npm的功不可灭），nodejs实际上成为js服务端和工具桌面端开发事实上的标准。似乎用javascript开发桌面应用时代正在来临。各种开发桌面应用的js框架工具陈出不穷，下面主要介绍的是一些开源项目js框架工具 for Desktop Application。</p>
<a id="more"></a>
<h1 id="electron" class="heading-control"><a href="http://electron.atom.io/" target="_blank" rel="noopener">Electron</a><a class="heading-anchor" href="#electron" aria-hidden="true"></a></h1>
<p>Github开源的，用JavaScript编写桌面应用的框架。Electron为用纯JavaScript创建桌面应用提供了运行时。原理是，Electron调用你在<code>package.json</code>中定义的main文件并执行它。main文件（通常被命名为main.js）会创建一个内含渲染完的web页面的应用窗口，并添加与你操作系统的原生GUI（图形界面）交互的功能。</p>
<p>下载需要翻墙：</p>
<p><a href="https://www.npmjs.com/package/electron-download" target="_blank" rel="noopener">https://www.npmjs.com/package/electron-download</a><br>
在环境变量中设置即可 <code>npm install electron-prebuilt</code> 。</p>
<pre><code class="ini"><span class="hljs-comment">## Electron Mirror of China</span>
<span class="hljs-attr">ELECTRON_MIRROR</span>=<span class="hljs-string">"https://npm.taobao.org/mirrors/electron/"</span>
<span class="hljs-attr">CHROMEDRIVER_CDNURL</span>=http://npm.taobao.org/mirrors/chromedriver

<span class="hljs-comment">## or for a local mirror</span>
<span class="hljs-attr">ELECTRON_MIRROR</span>=<span class="hljs-string">"https://10.1.2.105/"</span>
<span class="hljs-attr">ELECTRON_CUSTOM_DIR</span>=<span class="hljs-string">"our/internal/filePath"</span>
</code></pre>
<h1 id="nwjs-yi-qian-jiao-nodewebkit" class="heading-control"><a href="http://nwjs.io/" target="_blank" rel="noopener">NW.js</a> (以前叫 node-webkit)<a class="heading-anchor" href="#nwjs-yi-qian-jiao-nodewebkit" aria-hidden="true"></a></h1>
<p>与<a href="http://appjs.org/" target="_blank" rel="noopener">App.js</a>类似，通过将node.js与Chromiuml联合在一起，实现本地桌面应用开发的，是App.js的后起之秀。实现原理是基于Chromium项目的Content Layer构建(Chromium Browser也同样基于Content Layer); 实现上的特点是把Node.js的消息循环(libuv)和Chromium Renderer进程的消息循环合并到一起，因为这样才能从DOM(HTML)中直接调用Node.js提供的函数；把Node.js使用的V8引擎和 Chromium的V8引擎合并，使得Node.js的Javascript和DOM里面的Javascript可以互相访问；另外因为是支持本地应用， 所以安全模型和Web程序有很大不同：node-webkit程序可以做web应用不允许做的很多事情，除了通过node.js访问本地OS以外，还可以进行跨域访问等操作。是英特尔开放源码技术中心（OTC）的软件架构师Rogerwang（王文睿）发起，在公司专职开发node-webkit(幸福啊)。</p>
<p>本质上它和PhoneGap一样都是属于胶水层，只不过PhoneGap是尽量以遵循W3C最新规范的形式来提供本地访问API，其它的不规范接口以各种插件形式提供；而node-webkit则是通过node.js提供本地访问的接口。与PhoneGap比较而言，如果PhoneGap要为某个平台提供新的本地API接口，必须通过开发插件的形式提供，而且各个平台的插件开发的开发语言都不一样。而node.js有node-gyp(native addon build tool) 工具统一build。而node.js的 <a href="https://npmjs.org/package/node-ffi" target="_blank" rel="noopener">node-ffi</a> 附加插件更使得我们可以直接在js中调用动态链接库的API：</p>
<pre><code>var ffi = require(&quot;node-ffi&quot;);

var libm = new ffi.Library(&quot;libm&quot;, { &quot;ceil&quot;: [ &quot;double&quot;, [ &quot;double&quot; ] ] });
libm.ceil(1.5); // 2

// You can also access just functions in the current process by passing a null
var current = new ffi.Library(null, { &quot;atoi&quot;: [ &quot;int32&quot;, [ &quot;string&quot; ] ] });
current.atoi(&quot;1234&quot;); // 1234
</code></pre>
<p>地址： <a href="https://github.com/rogerwang/node-webkit" target="_blank" rel="noopener">https://github.com/rogerwang/node-webkit</a></p>
<p>如何把你的javascript 应用打包成一个可执行文件，这里已经说得很详细了：<a href="https://github.com/rogerwang/node-webkit/wiki/How-to-package-and-distribute-your-apps" target="_blank" rel="noopener">https://github.com/rogerwang/node-webkit/wiki/How-to-package-and-distribute-your-apps</a></p>
<h1 id="node-x11" class="heading-control">node-x11<a class="heading-anchor" href="#node-x11" aria-hidden="true"></a></h1>
<p>这个是用纯js实现了X11 Client的核心协议，包括Xrender, Damage, Composite, Big-Requests, Dpms, Screensaver, XFixes, Shape, XTest, XC-Misc, GLX and Apple-WM extensions。用来开发X-Windows GUI程序。基于 <a href="https://github.com/sidorares/node-x11" target="_blank" rel="noopener">node-x11</a> 有人做了进一步的封装：<a href="https://github.com/sidorares/ntk" target="_blank" rel="noopener">ntk(desktop UI toolkit)</a>, 然后做出了一个纯js的 VNC Viewer: <a href="https://github.com/sidorares/node-vnc" target="_blank" rel="noopener">node-vnc</a>.</p>
<p>Windows用户要先安装  <a href="http://www.straightrunning.com/XmingNotes/" target="_blank" rel="noopener">XMing</a> or <a href="http://x.cygwin.com/" target="_blank" rel="noopener">Cygwin/X</a>。</p>
<p>地址： <a href="https://github.com/sidorares/node-x11" target="_blank" rel="noopener">https://github.com/sidorares/node-x11</a></p>
<p>X11窗口例子：</p>
<pre><code class="js">    <span class="hljs-keyword">var</span> x11 = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../lib'</span>);

    <span class="hljs-keyword">var</span> PointerMotion = x11.eventMask.PointerMotion;
    x11.createClient(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, display</span>) </span>{
        <span class="hljs-keyword">var</span> X = display.client;
        <span class="hljs-keyword">var</span> root = display.screen[<span class="hljs-number">0</span>].root;
        <span class="hljs-keyword">var</span> white = display.screen[<span class="hljs-number">0</span>].white_pixel;
        <span class="hljs-keyword">var</span> black = display.screen[<span class="hljs-number">0</span>].black_pixel;

        <span class="hljs-keyword">var</span> wid = X.AllocID();
        X.CreateWindow(wid, root, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">400</span>, <span class="hljs-number">300</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, { <span class="hljs-attr">backgroundPixel</span>: white, <span class="hljs-attr">eventMask</span>: PointerMotion });
        <span class="hljs-keyword">var</span> gc = X.AllocID();
        X.CreateGC(gc, wid);
        X.MapWindow(wid);
    });
</code></pre>
<p><img src="https://a248.e.akamai.net/camo.github.com/58410fb1ae44f04f59b79af1461d304b64b113d3/687474703a2f2f696d672d666f746b692e79616e6465782e72752f6765742f343132332f33373531313039342e33302f305f38313731325f36633265626231315f4c" alt><br>
ntk 的例子:</p>
<pre><code class="js">    <span class="hljs-keyword">var</span> ntk = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib'</span>);

    ntk.createClient(main);

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main</span>(<span class="hljs-params">err, app</span>) </span>{
      <span class="hljs-keyword">var</span> mainwnd = app.createWindow({<span class="hljs-attr">title</span>: <span class="hljs-string">"Close me!"</span>})
       .on(<span class="hljs-string">'mouseout'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ev</span>) </span>{ <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Out'</span>); })
       .on(<span class="hljs-string">'mouseover'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ev</span>) </span>{ <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'In'</span>); })
       .on(<span class="hljs-string">'mousedown'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">ev</span>) </span>{
           ev.window.unmap();
           setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ ev.window.map(); }, <span class="hljs-number">1000</span>);
        })
       .map();
    }
</code></pre>
<h1 id="node-qt" class="heading-control">node-qt<a class="heading-anchor" href="#node-qt" aria-hidden="true"></a></h1>
<p><a href="https://github.com/arturadib/node-qt" target="_blank" rel="noopener">node-qt</a>是基于QT的node.js封装,而<a href="http://github.com/arturadib/node-five" target="_blank" rel="noopener">node-five</a> 则是基于<a href="https://github.com/arturadib/node-qt" target="_blank" rel="noopener">node-qt</a>的封装实现了HTML5 graphics and audio。</p>
<p>地址：</p>
<ul>
<li><a href="https://github.com/arturadib/node-qt" target="_blank" rel="noopener">https://github.com/arturadib/node-qt</a></li>
<li><a href="http://github.com/arturadib/node-five" target="_blank" rel="noopener">http://github.com/arturadib/node-five</a></li>
</ul>
<p>使用 node-qt 的代码写法如下：</p>
<pre><code class="js">    <span class="hljs-keyword">var</span> qt = <span class="hljs-built_in">require</span>(<span class="hljs-string">'node-qt'</span>),
        app = <span class="hljs-keyword">new</span> qt.QApplication,
        <span class="hljs-built_in">window</span> = <span class="hljs-keyword">new</span> qt.QWidget;

    <span class="hljs-comment">// Prevent objects from being GC'd</span>
    global.app = app;
    global.window = <span class="hljs-built_in">window</span>;

    <span class="hljs-comment">// Quirk: the virtual method paintEvent() is mapped into a callback setter</span>
    <span class="hljs-built_in">window</span>.paintEvent(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">var</span> p = <span class="hljs-keyword">new</span> qt.QPainter();
      p.begin(<span class="hljs-built_in">window</span>);
      p.drawText(<span class="hljs-number">20</span>, <span class="hljs-number">30</span>, <span class="hljs-string">'hello node, hello qt'</span>);
      p.end();
    });

    <span class="hljs-built_in">window</span>.resize(<span class="hljs-number">300</span>, <span class="hljs-number">150</span>);
    <span class="hljs-built_in">window</span>.show();

    <span class="hljs-comment">// Join Node's event loop</span>
    setInterval(app.processEvents, <span class="hljs-number">0</span>);
</code></pre>
<p>Node-Five的写法：</p>
<pre><code class="js">    <span class="hljs-keyword">var</span> five = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path-to-node-five-dir'</span>),
        <span class="hljs-built_in">window</span> = <span class="hljs-keyword">new</span> five.Window(<span class="hljs-number">300</span>, <span class="hljs-number">150</span>),
        canvas = <span class="hljs-keyword">new</span> five.Canvas(<span class="hljs-built_in">window</span>),
        ctx = canvas.getContext(<span class="hljs-string">'2d'</span>);

    ctx.fillStyle = <span class="hljs-string">'black'</span>;
    ctx.fillText(<span class="hljs-string">'hello node, hello qt'</span>, <span class="hljs-number">20</span>, <span class="hljs-number">20</span>);
</code></pre>
<h1 id="wxnode" class="heading-control">wxNode<a class="heading-anchor" href="#wxnode" aria-hidden="true"></a></h1>
<p><a href="https://github.com/joeferner/wxNode" target="_blank" rel="noopener">wxNode</a>是基于跨平台的<a href="http://www.wxwidgets.org/" target="_blank" rel="noopener">wxWidgets</a>的node.js封装插件包。也就是能让你用wxWidgets GUI组件开发桌面应用。</p>
<p>地址： <a href="https://github.com/joeferner/wxNode" target="_blank" rel="noopener">https://github.com/joeferner/wxNode</a></p>
<p>例子：</p>
<pre><code>var wx = require(&quot;wxnode&quot;);

var MyApp = wx.App.extend({
  onInit: function() {
    var location = new wx.Point(50, 50);
    var size = new wx.Size(450, 340);
    var frame = new MyFrame(&quot;Hello World&quot;, location, size);
    frame.show(true);
    this.setTopWindow(frame);
    return true;
  }
});

var MyFrame = wx.Frame.extend({
  init: function(title, pos, size) {
    this._super(null, -1, title, pos, size);

    this.EVT_CLOSE(this.onClose);
  },

  onClose: function(event) {
    process.exit();
  }
});

var app = new MyApp();
app.run();
</code></pre>
<p>运行：</p>
<pre><code>node examples/helloWorld.js
</code></pre>
<h1 id="tidesdk" class="heading-control">TideSDK<a class="heading-anchor" href="#tidesdk" aria-hidden="true"></a></h1>
<p>最后提下TideSDK, 就是以前的Titanium Desktop SDK，以web技术(HTML5. CSS3, JS)创建桌面应用的开源框架工具。与前面的框架相比它的特色是：它不仅仅支持用js来开发桌面应用，它还支持用C/C++, Ruby, Python, PHP来开发和写模块。而且这些语言写的模块可以彼此调用。Tide拥有一个用C++写的微内核，该微内核是支持跨平台，跨语言的绑定和调用框架。TideSDK没有加入node.js的支持是为遗憾。</p>
<p>地址: <a href="http://tidesdk.org/" target="_blank" rel="noopener">http://tidesdk.org/</a></p>
<h1 id="you-xi-ying-yong" class="heading-control">游戏应用<a class="heading-anchor" href="#you-xi-ying-yong" aria-hidden="true"></a></h1>
<p>对于希望用js来开发游戏和动画交互强的应用，那么可能除了node-qt外，还可以考虑下下面的框架：</p>
<ul>
<li><a href="http://impactjs.com/ejecta" target="_blank" rel="noopener">Ejecta for iOS</a>: A Fast, Open Source JavaScript, Canvas &amp; Audio Implementation for iOS</li>
<li><a href="https://github.com/creationix/node-sdl" target="_blank" rel="noopener">node-sdl</a>: sdl的封装</li>
<li><a href="https://github.com/phonegap/phonegap-plugin-fast-canvas" target="_blank" rel="noopener">Fast Canvas</a></li>
<li><a href="https://github.com/learnboost/node-canvas" target="_blank" rel="noopener">node-canvas</a>, <a href="https://github.com/Shouqun/node-skia" target="_blank" rel="noopener">node-skia</a>: 分别是基于<a href="http://cairographics.org/" target="_blank" rel="noopener">cairo</a> 和 <a href="https://code.google.com/p/skia/" target="_blank" rel="noopener">skia</a> 的图形库的封装。</li>
<li><a href="https://github.com/luismreis/node-openvg" target="_blank" rel="noopener">node-openvg</a>  : 目前似乎只支持Raspbian(RasberryPi).</li>
<li><a href="https://www.ludei.com/tech/cocoonjs" target="_blank" rel="noopener">CocoonJS</a>：不错的非开源</li>
</ul>
]]></content>
      <categories>
        <category>JavaScript</category>
        <category>Framework</category>
        <category>Desktop</category>
      </categories>
      <tags>
        <tag>javascript</tag>
        <tag>desktop</tag>
        <tag>framework</tag>
        <tag>sdk</tag>
        <tag>HTML5</tag>
        <tag>webapp</tag>
        <tag>前端</tag>
      </tags>
  </entry>
  <entry>
    <title>无后端构建的无痛HTML应用开发[2013趋势]</title>
    <url>/article/nobackend/</url>
    <content><![CDATA[<h1 id="shi-mo-shi-wu-hou-duan-gou-jian-kai-fa" class="heading-control">什么是无后端构建开发<a class="heading-anchor" href="#shi-mo-shi-wu-hou-duan-gou-jian-kai-fa" aria-hidden="true"></a></h1>
<p>无后端构建是希望通过云服务将后端从前端开发中彻底解耦。和云存储不同之处在于它不仅仅是数据存储，它还是一套解决方案，它通过将后端任务从前端代码中剥离出来的一套SDK，让前端开发者把全部注意力放在前端交互用户体验。而让后端开发者聚焦后端任务的解耦，统一后端数据，并使得后端更具有灵活性和伸缩性。</p>
<p>这个趋势意味着互联网数据正在由人读(human-readable)时代向机读(computer-readable)过渡。虽然语义网的w3c已经提出好久(1999)，相关标准(RDF/OWL/RIF)也是许久前就制定了，但是在互联网上的实际应用中，总是雷声大，雨点小，普及率最高的RSS和FOAF(Friend Of A Friend)也只是这小众。这归结于丑陋的XML格式，虽说是机读，但是实际上描述定义这些机读格式的也是人啊，如果格式的可读性差，操作复杂，那么自然愿意使用的开发者就少。</p>
<p>而API则不然，这是程序开发中与外部系统交流理所当然的接口，是每个开发者都在用的，一看就懂的。当然API也有好坏之分，编写制定好的API接口比开发应用更难。这需要你具备更强的架构设计能力，从具体中提炼出通用的操作能力，以及要求可读性更强的命名能力。</p>
<p>自从互联网上分布式 Restful 体系架构提出后，web上的 OpenAPI 也在日益增多，但是大部分OpenAPI还是在各行其是。认证这块，虽然有统一的标准OAuth, 但是对普通开发者来说，还需要去了解OAuth的内部原理，使用上还是难用，而且各个站点对OAuth的具体实现上，又略有差异，这更增加开发者的负担。所以目前出现具体针对各大站点的OAuth认证的二次封装的开发库，降低普通开发者的使用难度。现在这些基础通用操作再次被“无后端”构建模式统一封装和组织，使得普通开发者更加容易的使用。再次降低了开发者的门槛，开发者可以完全不管后端的架构设计和组织了。那么遵循这样的普及，互联网上会有越来越多的各式各样的云服务API平台，未来的互联网架构也将从独立的web站点，变成了彼此分享协作的WebApp。</p>
<p>让我们具体来看一个例子。</p>
<h2 id="li-zi" class="heading-control">例子<a class="heading-anchor" href="#li-zi" aria-hidden="true"></a></h2>
<p>首先，我们从帐号管理开发谈起，在传统开发中，我们需要定义帐号的表结构，进行数据库服务器配置，然后运行数据库服务，创建数据库和数据表，并初始化数据。那么在“无后端构建”的开发中，上述操作包括登录，都没有必要再去做这些繁琐的操作了，你只需要再云服务后台添加一个数据库设置好访问权限，然后在前端应用中，直接引用SDK，写代码即可，剩下的事情则交给云服务去做就好了，梦幻般的代码如下：</p>
<pre><code class="js"><span class="hljs-keyword">var</span> mydb = <span class="hljs-keyword">new</span> iDB(<span class="hljs-string">"https://idb.isdk.org/mydb"</span>);
<span class="hljs-keyword">var</span> account = myDb.account;

<span class="hljs-comment">//注册一个新用户</span>
account.signUp(<span class="hljs-string">'mike@example.com'</span>, <span class="hljs-string">'secret'</span>, {<span class="hljs-attr">name</span>: <span class="hljs-string">"Mike John"</span>, <span class="hljs-attr">birthday</span>: <span class="hljs-string">'1988-01-01'</span>});

<span class="hljs-comment">//登录</span>
account.signIn(<span class="hljs-string">'mike@example.com'</span>, <span class="hljs-string">'secret'</span>);
<span class="hljs-comment">//使用第三方登录(Oaccount)</span>
account.signIn(using: <span class="hljs-string">'google'</span>);

<span class="hljs-comment">//改变密码</span>
account.changePassword(<span class="hljs-string">'currentPassword'</span>, <span class="hljs-string">'newPassword'</span>);
account.change(<span class="hljs-string">'password'</span>, <span class="hljs-string">'newPassword'</span>, {<span class="hljs-attr">secret</span>: <span class="hljs-string">'currentPassword'</span>});

<span class="hljs-comment">//改变Profile的信息</span>
account.change(<span class="hljs-string">'nickname'</span>, <span class="hljs-string">'newNickname'</span>, {<span class="hljs-attr">secret</span>: <span class="hljs-string">'currentPassword'</span>});

<span class="hljs-comment">//获取profile</span>
account.get();
account.get(<span class="hljs-string">'name'</span>);

<span class="hljs-comment">//彻底销毁自己的帐号</span>
account.destroy({<span class="hljs-attr">secret</span>: <span class="hljs-string">'currentPassword'</span>});

<span class="hljs-comment">//注销</span>
account.signOut();

<span class="hljs-comment">//忘记密码了，发送重置密码链接到指定邮箱</span>
account.resetPassword(<span class="hljs-string">'mike@example.com'</span>);
</code></pre>
<p>数据存储也是类似，事实上account的存储就是来自store。</p>
<pre><code class="js"><span class="hljs-keyword">var</span> store = mydb.store;
store.add(key, value);
store.update(key, value);
store.delete(key);
store.get(key);
store.listAll(key);
store.list(key, subkey_pattern, skipCount, count);
</code></pre>
<p>无后端的开发模式，实质是基于云存储之上的云服务模式。因此它不仅仅适用于HTML5应用，其它任何计算机语言都可以用它作为开发模式的。我们通过进一步的抽象后端开发，剥离出了帐号和存储任务，慢慢的还会有消息(通知)，在线支付/交易，评论，聊天等等各种各样的通用的操作(任务)会以更加简易方便的形式被剥离出来。</p>
<p>提了这么多，那么这到底是梦幻呢，还是现在就能在互联网上可以玩到的技术呢？毋庸置疑，这目前不仅能在互联网上玩到，而且BitTorrent, Codecademy等已经在产品中使用Firebase提供的无后端云存储服务，下面列举一些无后端云存储服务提供者和开源项目。</p>
<h1 id="wu-hou-duan-yun-cun-chu-fu-wu-ti-gong-zhe-yu-kai-yuan-xiang-mu" class="heading-control">无后端云存储服务提供者与开源项目<a class="heading-anchor" href="#wu-hou-duan-yun-cun-chu-fu-wu-ti-gong-zhe-yu-kai-yuan-xiang-mu" aria-hidden="true"></a></h1>
<ul>
<li>[<a href="http://sockethub.org/" target="_blank" rel="noopener">Sockethub</a>]开源，数据后端为Redis, 将消息抽象出来的形成API，与应用交换.</li>
<li>[<a href="http://hood.ie/" target="_blank" rel="noopener">Hoodie</a>] 开源，数据后端用CouchDB, API与设想的很接近。</li>
<li>[<a href="http://remotestorage.io/" target="_blank" rel="noopener">remoteStorage</a>] 开源</li>
<li>[<a href="https://www.firebase.com/" target="_blank" rel="noopener">Firebase</a>]      已经商业化</li>
<li>[<a href="http://singly.com/" target="_blank" rel="noopener">Singly</a>] 目前专注于针对认证、社交圈、文件分享集成以及API使用分析。</li>
<li>[<a href="http://deployd.com/" target="_blank" rel="noopener">deployd</a>] 开源，数据后端用MongoDB, API 难用</li>
<li>[<a href="https://parse.com/" target="_blank" rel="noopener">Parse</a>] 商业化</li>
<li>[<a href="http://www.kinvey.com/" target="_blank" rel="noopener">Kinvey</a>]</li>
</ul>
<h1 id="wen-ti" class="heading-control">问题<a class="heading-anchor" href="#wen-ti" aria-hidden="true"></a></h1>
<p>优势我们大家都看到了，无论从开发的角度来说，还是说从数据复用的角度来说，这样的模式都堪称完美。当然目前从开发的角度来说还是没有完全做到前端无痛开发来着，这主要集中在权限配置上比较复杂。</p>
<p>那么这样的“无后端”构架的模式到底还有什么样的弊端？下面分别从用户和运营方的角度来看看，他们的顾虑会是什么？</p>
<h2 id="yong-hu-de-gu-lv" class="heading-control">用户的顾虑<a class="heading-anchor" href="#yong-hu-de-gu-lv" aria-hidden="true"></a></h2>
<p>用户的顾虑不仅仅是从“无后端”构架才开始，当用户的数据被放在网上，用户的担忧就开始，用户的隐私是否会被泄漏，用户的数据是否被滥用？而随着美国施洛登暴露的隐私门，更引发了全球对自己在网上的数据的担忧。那么“无后端”构架应该怎么来避免用户的顾虑呢？</p>
<p>首先，用户隐私数据必须加密，而加密的密钥只有用户自己才有，平台和应用开发者都没有。</p>
<p>其次，以前数据库在应用开发者手中，存储方法的代码也在应用开发者手中，你根本不可能知道数据是不是真的加密存放的。现在数据库在第三方平台上，那么这使得通过第三方平台直接去查看数据，或者委托他人验证，成了可能。如此一来软件再也无法对此作出虚假承诺欺骗用户。</p>
<h2 id="yun-ying-fang-de-gu-lv" class="heading-control">运营方的顾虑<a class="heading-anchor" href="#yun-ying-fang-de-gu-lv" aria-hidden="true"></a></h2>
<p>运营方可能顾虑的是我的账户数据，业务数据全在平台上了，那么这用户到底算是谁的？还有业务数据的安全怎么办？还有，如何能保证平台不利用我的业务数据？</p>
<p>我的回答是，不要在意用户到底算谁的，要在意的是如何为用户服好务，保证用户数据的安全，只有能满足用户的需求，让用户满意，才能留住用户，否则一切都是浮云。因此，作为运营方应该考虑的是，如果云存储服务挂掉，怎么办？</p>
]]></content>
      <categories>
        <category>Thinking</category>
        <category>Architecture</category>
      </categories>
      <tags>
        <tag>javascript</tag>
        <tag>云存储</tag>
        <tag>云计算</tag>
        <tag>HTML5</tag>
        <tag>前端</tag>
        <tag>Cloud</tag>
        <tag>nobackend</tag>
        <tag>NoSQL</tag>
      </tags>
  </entry>
  <entry>
    <title>大道至简 -- 之iDB NoSQL数据库开发随笔（一）</title>
    <url>/article/idb-1/</url>
    <content><![CDATA[<p>iDB NoSQL数据库是结构化的面向列（Structured-Column Oriented），并基于目录（Directory-Based）的层级式（Hierarchy）NoSQL开源数据存储系统（项目主页：<a href="https://github.com/snowyu/iDB" target="_blank" rel="noopener">https://github.com/snowyu/iDB</a>），iDB有别于传统数据库基于文件的存储形式。我们可以把它视作新一代数据库系统(A new way to database engine)的核心。</p>
<h3 id="ji-ge-gai-nian" class="heading-control">几个概念：<a class="heading-anchor" href="#ji-ge-gai-nian" aria-hidden="true"></a></h3>
<ul>
<li>面向列：所谓面向列(Column Oriented)是和面向行(Row Oriented)相对而言的，绝大多数的关系型数据库就是面向行存储的，而iDB则是面向列基于Key/Value的存储系统。</li>
<li>结构化：所谓结构化(Structured)是指值(Value)可以是带结构数据的复杂类型，而层级则是指Key可以有不同的层级关系，基于目录树的形式。</li>
<li>基于目录：基于目录(Directory-Based)也是相对于基于文件(File-Based)而言，对于传统的数据库系统几乎都是通过创建少量的随机文件，然后把大量的数据存放在里面，而iDB则完全不同，也可以说是恰恰相反，它是创建大量的目录和文件，把数据分散在目录中，你可以认为这是一种创新。</li>
</ul>
<h3 id="background-she-ji-bei-jing" class="heading-control">Background (设计背景)<a class="heading-anchor" href="#background-she-ji-bei-jing" aria-hidden="true"></a></h3>
<p>iDB NoSQL数据库引擎的设计初衷是希望能更为合理的设计组织数据库引擎的层次架构，以及看到现代文件系统设计发展的变化有感而发，两者融合就促使我萌发设计iDB的念头。</p>
<h4 id="kiss-yuan-ze" class="heading-control">KISS 原则<a class="heading-anchor" href="#kiss-yuan-ze" aria-hidden="true"></a></h4>
<p>大家都应该知道KISS(Keep It Simple, Stupid)原则，即保持架构简单而愚蠢的原则，因为简单，所以看上去足够的蠢。而将架构设计得足够的简单是架构师的梦寐以求，大道至简，说着看是容易，实际做起来，其实真难，知易行难是也。我希望iDB的架构设计做到了足够简单以及足够的愚蠢，这也是我从事架构设计中最接近KISS原则的一次架构体验，我很乐于与大家分享我这设计过程的经验和错误。</p>
<h4 id="wen-jian-xi-tong-yu-shu-ju-ku" class="heading-control">文件系统与数据库<a class="heading-anchor" href="#wen-jian-xi-tong-yu-shu-ju-ku" aria-hidden="true"></a></h4>
<p>前面我提到现代文件系统的发展和变化，这和NoSQL数据库的设计存在什么样的联系？数据库引擎的设计需要考虑文件系统的特性么？我们可以做一个列表来对比，文件系统和数据库的功能特性：</p>
<p><strong>从操作对象和操作方式上看</strong></p>
<ul>
<li>数据</li>
<li>文件系统: 文件名/文件内容</li>
<li>NoSQL : Key/Value</li>
<li>操作</li>
<li>文件系统: 读、写、删除、列举、文件</li>
<li>管理操作: 磁盘系统检查(fsck)，磁盘卷热备</li>
<li>NoSQL : Get, Set. Delete, List Key</li>
<li>管理操作: 数据库校验, 数据库热备</li>
</ul>
<p><strong>从内部存储结构上看</strong></p>
<p>内部存储结构上，绝大多数数据库系统都是使用Btree树或者其变体来存储数据(也有用hash表实现的)。而目前越来越多的现代文件系统正在用Btree树或者其变体来存储目录或文件。比如:</p>
<ul>
<li>ext3/ext4 使用Htree(Btree的变体)来索引目录，不过这ext3中需要手动启用dir_index功能，ext4默认是启用的。</li>
<li>btrfs 使用btree,又被称为 “Btree FS”。</li>
<li>ZFS 使用 Extensible hash table</li>
<li>Reiser4 使用 Dancing B*-tree</li>
<li>XFS B+tree</li>
</ul>
<p>可以看到在最基本数据存储和访问上，数据库和文件系统有惊人的相似性。为了最大限度的优化数据库的性能，开发者做了许多与文件系统相同的重复工作，磁头位置预估，扇面连续，defragment等等，并针对SSD做优化。但是这些相同的工作文件系统也都在做。</p>
<h4 id="bu-yao-zhong-fu-fa-ming-lun-zi-drtw" class="heading-control">不要重复发明轮子(DRTW)<a class="heading-anchor" href="#bu-yao-zhong-fu-fa-ming-lun-zi-drtw" aria-hidden="true"></a></h4>
<p>那么不同的地方在哪里？数据库更复杂，除了基本的存储和访问需求外，它还需要对结构化的数据进行检索和处理。但是因为老的数据库思路是申请一个文件，也即是磁盘空间的一个区域在这上面进行数据存储和访问，这样，文件系统的成果自然无法用上。</p>
<p>因此，根据懒人法则第一条，能躺绝坐，能坐绝不站。站在巨人的肩膀上，才能看得更远，走得更远。那么怎么样对数据存储才能利用上文件系统的成果呢？</p>
<p>让我们跳出来文件这个限制框框思考，为啥数据库的数据一定要保存在文件中？为啥不能直接用文件的目录系统直接作为NoSQL数据库的存储呢？当我们跳出这个限制：数据必须保存到文件中。我们就会欣然发现，只要我们正视文件系统的一些限制，其实目录也可以存数据。既然文件系统都已经充分考虑并已经成熟（N多程序在通过不同方式使用着文件系统），为啥要重复发明轮子？作为数据库引擎应该更专注于数据处理才对，而不是数据存储。</p>
<h3 id="kiss-it" class="heading-control">KISS IT<a class="heading-anchor" href="#kiss-it" aria-hidden="true"></a></h3>
<p>iDB就是这样的一次尝试。它试图充分而彻底的利用文件系统本身来进行数据存储，你甚至可以利用文件系统自己去浏览管理数据，看上去，我所做的一切似乎仅仅只是制定了数据存储的规范和一系列的约定。其中，最重要，最核心的约定是文件系统的目录名称为Key名，该目录下的“.value”文件内容为值的内容，“.type”文件内容为该Key的类型说明。</p>
<p>听上去够简单吧。也许简单到能让你发笑。</p>
<p>古语有云:</p>
<blockquote>
<p>上士闻道，勤而行之；中士闻道，若存若亡；下士闻道，大笑之。不笑不足以为道。</p>
</blockquote>
<p>就这么个简单东东，我从去年7月份开始设计，断断续续直到现在，逐步理清思路，才实施了一个能实用的东西。中间走了些弯路，单是规范修改了好几次。而且这一切仅仅还只是一个开端。如此，是不是够蠢。</p>
<blockquote>
<p>Stay simple ,stay foolish…</p>
</blockquote>
<p>如上所述就是开发iDB的设计背景，下面从哪里谈起呢?想写的东西太多，就先从iDB规范讲起吧。</p>
<h3 id="idb-jia-gou-yu-gui-fan" class="heading-control">iDB 架构与规范<a class="heading-anchor" href="#idb-jia-gou-yu-gui-fan" aria-hidden="true"></a></h3>
<p>草拟规范是架构设计中尤为重要的一环，架构如果没有规范，便如同建筑师没有设计蓝图就开始修建房屋，无论是自顶向下还是自底向上设计，每一步都离不开规范文档。单从数据库系统的设计上来讲，由底向上看，描述数据在文件系统中如何存储数据的存储规范便是整个系统的基石，如果没有它，那么一切都是空谈。</p>
<p>在我们进行iDB设计的过程中，起初iDB规范只有一个，后来逐渐分为多个，下面让我们从底一步一步向上看:</p>
<ul>
<li>
<p>iDB存储规范：用于描述数据在文件系统中是如何存储的。它是与文件系统的接口规范</p>
</li>
<li>
<p>iDB数据库规范：用于描述iDB数据的类型、索引规范以及其它相关约定</p>
<ul>
<li>iDB Key/Value 数据库规范</li>
<li>iDB 关系型数据库规范</li>
</ul>
</li>
<li>
<p>iDB 存储服务规范：用于描述iDB存储服务的功能规范，分为三层:</p>
<ul>
<li>读写分离的异步通讯IO层</li>
<li>Memcache 内部缓存层</li>
<li>实际iDB存储层</li>
</ul>
</li>
<li>
<p>iDB云数据库服务规范：以下规范实际上与iDB存储无关，只是用于描述一种分布式NoSQL数据库的规范方案，我强称之为iDB云数据库规范。</p>
<ul>
<li>iDB 节点控制器: 控制和监控数据库，作为与各种数据库的中间代理层</li>
<li>iDB 集群控制器: 管理iDB节点控制器,数据定位</li>
<li>iDB 云控制器: 是暴露在互联网上顶层组件。为外部世界提供RESTful API以及Web接口</li>
</ul>
</li>
</ul>
<p>目前只实现iDB存储规范中的内容，文档还很乱，写得比较糟糕，但是具体思路已经敲定了，只剩下文字增订的事情，但是iDB整体规范依然还在草拟中。</p>
<h4 id="idb-cun-chu-gui-fan" class="heading-control">iDB存储规范<a class="heading-anchor" href="#idb-cun-chu-gui-fan" aria-hidden="true"></a></h4>
<p>iDB存储规范是iDB最基础的规范约定，描述了iDB基础数据是如何被存储和访问。</p>
<p>我们大概已经知道了，目录名为Key名，目录名下的&quot;.value&quot;文件内容为键值。我们将&quot;.value&quot;称之为key的一个属性，&quot;.value&quot;是其中最重要的一个属性。一个<br>
key(键)可以有多个属性，对于一般使用者来说，是无法直接看见这些属性的，这些属性为iDB规范服务的。</p>
<p><strong>基础概念</strong></p>
<p>小结，从以上的描述，我们可以总结出以下的概念</p>
<ul>
<li>Key Name: 键名，同于目录名</li>
<li>Attribute: 键属性, 同于文件名，其文件内容为键属性值。</li>
<li>.value: 键值属性</li>
<li>.type: 键值类型属性</li>
</ul>
<blockquote>
<p>注意： 这里约定所有的字符串编码统一为utf-8编码格式。其中包括key name。值内容为纯字符串的形式表示。“redis&quot;类型例外，如果类型为&quot;redis”，则值内容为redisIO的raw格式。</p>
</blockquote>
<p>路径为iDB层次性的体现，因此键路径出现了:</p>
<ul>
<li>Key Path: 键路径，同于目录路径</li>
</ul>
<p>然后就有了子健:</p>
<ul>
<li>Subkey: 子健，属于键路径下的某个键，称为该键路径下的子健。</li>
</ul>
<p>随着对子健遍历需求的出现，又诞生了对键的分页(分区)的需要。</p>
<p><strong>分区/分页(Partition Key)</strong></p>
<p>对iDB数据库根目录下的子健的遍历就是对整个数据库的key的遍历。如果数据库中数据巨大，那么一次遍历传回所有key数据，可能消耗大量的时间和资源，在这种情况下可能需要分页(分区)的形式来组织key列表。</p>
<p>那么分区(分页)是否是必要的？</p>
<p>(未完待续)</p>
]]></content>
      <categories>
        <category>Database</category>
        <category>NoSQL</category>
        <category>iDB</category>
      </categories>
      <tags>
        <tag>cloud computing</tag>
        <tag>nosql</tag>
        <tag>database</tag>
        <tag>idb</tag>
        <tag>cloud storage</tag>
        <tag>云存储</tag>
        <tag>云计算</tag>
      </tags>
  </entry>
  <entry>
    <title>Nokia 的B计划 - Nokia 还有未来么？</title>
    <url>/article/nokia-b-plan/</url>
    <content><![CDATA[<h1 id="nokia-huan-you-wei-lai-mo" class="heading-control">Nokia 还有未来么？<a class="heading-anchor" href="#nokia-huan-you-wei-lai-mo" aria-hidden="true"></a></h1>
<h2 id="xian-zhuang" class="heading-control">现状<a class="heading-anchor" href="#xian-zhuang" aria-hidden="true"></a></h2>
<p>2012年6月30日，作为最新裁员计划的一部分，诺基亚的三位高管黯然离职。7月1日调整后的新管理层开始生效，诺基亚的管理结构将更加简化。在接下来的一年多时间里，还会有1万名员工跟这三位高管一样，不得不离开诺基亚，以达到在2013年底之前节省30亿欧元开支的目标。</p>
<p>这家昔日硬件巨头股价下滑60%，手机销量骤降，现金储备急剧减少，而且失去了手机霸主位置。</p>
<p>现今，诺基亚孤注一掷正全身心投入WP智能机的研发中，期望这一平台能帮助该公司摆脱颓势。但是今年一季度，Windows Phone仅占智能机出货量的2.2%。即使今秋推出的WP 8系统能够大获成功，也不能保证诺基亚能够收复失地。而HTC和三星这两家Android硬件巨头，也正在计划推出WP设备。更糟糕的是，微软今秋推出的WP 8系统让诺基亚有苦难言。为了将桌面操作系统的优势沿用到移动操作系统上，WP8采用了与Windows 8相同的内核。这样一来，微软上一代移动操作系统WP7.5因为与WP8内核不同，无法升级到WP8。诺基亚寄予厚望刚上市的高端智能手机Lumia900无疑成了最大牺牲品。</p>
<h2 id="nokia-de-wei-lai-zhi-lu-yubji-hua" class="heading-control">Nokia的未来之路与B计划<a class="heading-anchor" href="#nokia-de-wei-lai-zhi-lu-yubji-hua" aria-hidden="true"></a></h2>
<p>OK，那么 Nokia的未来之路在何方？埃洛普一直在说B计划，但是却没有透露只字半语B计划的内容，B计划到底会是什么？如果埃洛普是微软的托，那么未来Nokia沦为微软的代工厂就是板上钉钉的事情了，Nokia再无未来。</p>
<p>否则，以我愚见，Nokia 的未来一定不是在手机上。君请看诺基亚手机的照相功能从800万像素到1200万像素，再到如今的4000万像素，在CMOS的配置上已经完全超越了如今的卡片机，超越太多了。只就CMOS而言4100万的像素也是目前所有135单反数码相机不能达到的高度，也超过了大量非高端120中画幅单反数码相机。而且<a href="http://conversations.nokia.com/2012/03/05/nokia-808-pureview-carl-zeiss-science-of-making-the-perfect-lens/" target="_blank" rel="noopener">Nokia</a><a href="http://conversations.nokia.com/2012/03/05/nokia-808-pureview-carl-zeiss-science-of-making-the-perfect-lens/" target="_blank" rel="noopener">808的镜头是诺基亚与卡尔蔡司合作研发</a>,如此mini的镜头是由五片非球面镜片组成，并含有一片超低色散镜片。</p>
<p><a href="https://upload.wikimedia.org/wikipedia/commons/f/fa/PureView_Pro_Sensor.png" target="_blank" rel="noopener"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/fa/PureView_Pro_Sensor.png/300px-PureView_Pro_Sensor.png" alt></a></p>
<p>作为手机来说，808的其他功能并不强，屏幕分辨率也不高，只有640x360而已，CPU来说也只是单核的1.3GARM11处理器。但是这块超大尺寸的CMOS(1/1.2英寸，远大于绝大多数高端卡片机上的CMOS，仅小于尼康的J1)能带来高端DC和单反单电之间画质，因此如果把808作为便携的单反备机，很多摄友就不用再花三四千去买一个理光GDR或富士X10做备机了，那808又变得很具有性价比。808的缺憾就是在它的镜头和作为照相机的功能不够完备。而如今便携卡片机目前正面临着严峻的考验。</p>
<p>曾几何时，无论在人头攒动的广场，还是在空旷静谧的绿野，随处可见人们手里拿着或胸前挂着轻巧的便携式卡片数码相机。便携卡片机目前正面临着严峻的考验，如今主流智能手机大都配备了500万像素以上的摄像头，800万也越来越常见，卡片机尚能抗衡的就只剩下较大的CMOS尺寸、光学变焦的镜头、更高范围的ISO以及快门速度上，但是Nokia808的出现把卡片机从像素到CMOS尺寸上看都远远抛在后面。NokiaPureView808就只差一个光学变焦的镜头了。因此，我个人看法，Nokia的B计划是Nokia与卡尔蔡司合作开发新款轻薄型卡片机。</p>
<h3 id="nokia-xin-kuan-qing-bao-xing-ka-pian-ji-pure-view-xi-lie" class="heading-control">Nokia 新款轻薄型卡片机 Pure View 系列<a class="heading-anchor" href="#nokia-xin-kuan-qing-bao-xing-ka-pian-ji-pure-view-xi-lie" aria-hidden="true"></a></h3>
<p>它的特征如下：</p>
<ul>
<li>完整4000万像素支持，不象808因为镜头和体积原因实际有效像素只有3839万</li>
<li>关学变焦固定镜头(f2/14mm-200mm)，作为备机要的就是便携，不需要可更换式镜头</li>
<li>机身防抖</li>
<li>支持GPS、蓝牙</li>
<li>有Wifi版本和3G版本（可打电话）</li>
<li>1200x800的纯触摸屏, 可三向翻转，方便拍摄</li>
<li>内置闪光灯，有热靴可外接闪光灯</li>
<li>标准三脚架接口</li>
<li>可以通过蓝牙、Wifi、3G远程操作相机（无线快门线）</li>
<li>防水</li>
<li>支持1080p 录像</li>
<li>ISO 50-25600, 以50递增。</li>
<li>高速快门: 30 to 1/8000 second and Bulb. Flash sync: 1/250 sec.</li>
<li>连续拍照：3-20fps</li>
<li>接口: Usb3, HDMI mini</li>
<li>Power: 2600mA lithium ion battery, DC input.</li>
<li>Memory: 内置32G，并有SD/SDHC/SDXC扩展接口</li>
<li>基于 Android 4.1 定制</li>
<li>No ViewFinder(可以不要取景器)</li>
<li>CPU 2核 with GPU</li>
<li>内存 DDR3 1G</li>
<li>格式：支持直接压缩DivX，Xvid, 动画GIF等格式</li>
<li>可直接分享到flickr、InstGram、Picasa等相片分享网站</li>
<li>可在线更新的相机功能软件（插件）</li>
</ul>
<p>如果卡片机市场出现这样的搅局者（正如初期杀入手机的苹果），你觉得Nokia会怎样？如果这样的卡片机上市，你想要不？想要Wifi版，还是3G版？</p>
]]></content>
      <categories>
        <category>Thinking</category>
      </categories>
      <tags>
        <tag>Camera</tag>
        <tag>Nokia</tag>
        <tag>Pure View</tag>
      </tags>
  </entry>
  <entry>
    <title>DIY与云计算（三）之 云存储与开源 ZFS 文件系统</title>
    <url>/article/diy-cloud-computing-3/</url>
    <content><![CDATA[<h2 id="zfs-jie-shao" class="heading-control">ZFS 介绍<a class="heading-anchor" href="#zfs-jie-shao" aria-hidden="true"></a></h2>
<p>首先ZFS是&quot;Zettabyte File System&quot;的首字母缩写。ZFS 源自于Sun Microsystems为Solaris操作系统开发的文件系统。<br>
ZFS是一个具有高存储容量、文件系统与卷管理概念整合、崭新的磁盘逻辑结构的轻量级文件系统，同时也是一个便捷的存储池管理系统。ZFS使用CDDL开源协议条款授权。后来被移植到FreeBSD和NetBSD系统上。</p>
<p>ZFS是一个128位的文件系统，这意味着它能存储1800亿亿（18.4 × 10^18）倍于当前64位文件系统的数据。窃以为目前ZFS文件系统是云存储以及NoSQL数据库的最佳首选。</p>
<h3 id="te-xing" class="heading-control">特性<a class="heading-anchor" href="#te-xing" aria-hidden="true"></a></h3>
<ul>
<li>Data integrity 数据完整性</li>
</ul>
<p>保障数据完整性是ZFS的主要功能和任务。ZFS使用了许多技术来检测和修复毁坏的数据，以此保障数据的完整性。代价是要求比普通RAID文件系统更多的CPU处理能力。</p>
<ul>
<li>Storage pool 存储池</li>
</ul>
<p>ZFS建立在虚拟的“zpools”的存储池之上。每个存储池由若干虚拟设备（virtual devices， vdevs）组成。这些虚拟设备可以是原始磁盘，也可能是一个RAID1镜像设备，或是非标准RAID等级的多磁盘组。</p>
<ul>
<li>Read-only Snapshot support (it is possible to get a read-write copy of them, those are named clones)</li>
<li>Built-in RAID-5-like-over-steroid capabilities known as RAID-Z and RAID-6-like-over-steroid capabilities known as RAID-Z2. RAID-Z3 (triple parity) also exists.</li>
<li>Copy-on-Write transactional filesystem</li>
<li>Meta-attributes support (properties) allowing you to you easily drive the show like “That directory is encrypted”, “that directory is limited to 5GiB”, “That directory is exported via NFS” and so on. Depending on what you define, ZFS takes the appropriates actions!</li>
<li>Dynamic striping to optimize data throughput</li>
<li>Variable block length</li>
<li>Data duplication</li>
<li>Automatic pool re-silvering</li>
<li>Transparent data compression / encryption (later requires Solaris 11)</li>
</ul>
<h3 id="dai-jia-he-lie-shi" class="heading-control">代价和劣势<a class="heading-anchor" href="#dai-jia-he-lie-shi" aria-hidden="true"></a></h3>
<ul>
<li>CPU开销较大(目前的CPU性能来说足已)</li>
<li>内存开销大，为了获得更好的性能，而需要更多的内存</li>
<li>1TB大约需要1GB 内存</li>
<li>启用 dedup 需要巨量内存或者SSD，否则性能变差，1TB大约需要32GB RAM或SSD.</li>
<li>缺乏&quot;Block Pointer rewrite functionality&quot; 功能(已计划开发), 因为没有该功能所以不能:</li>
<li>没有能力整理磁盘碎片(Pool defragmentation) (已通过COW技术来缓解该问题)</li>
<li>没有能力动态扩大或缩小(Pool Resize)存储池</li>
<li>数据压缩 (已解决)</li>
<li>无法添加新的单块设备到现有的RAID-Z/Z2/Z3 存储池，用以增加池的大小(不过，可以通过同时替换该池中的设备来扩展 RAID-Z/Z2/Z3 大小，还可以添加另一组同样大小的虚拟设备到现有池的形式扩展)</li>
<li>没有类似Lustre, GFS or OCFS2集群文件系统</li>
<li>单个存储设备上不能保障数据完整(健康)性(损害依然可以被检测到), 避免方法是设置数据强制重复。</li>
<li>修复(Resilver)损害的磁盘时间长，磁盘越大，所需时间越多，一般5或者6TB的磁盘需要几天来修复。这意味着最好Raidz1(RAID-5)当心这样的修复，因为在修复的过程中，会给原有的所有磁盘相当的压力。在这么长的修复时间如果另一个磁盘也crash了，那数据就彻底完蛋了。所以对于大于3TB的磁盘，最好是用Raidz2(允许2个磁盘同时失效)或Raidz3(允许3个磁盘同时失效)</li>
<li>IOPS 性能会随ZFS阵列的配置不同差异很大，8磁盘的raidz2阵列，写性能会很差，等于单磁盘写的性能，但是读性能则可以达到所有8个磁盘性能之和。在ZFS中正确配置阵列是关键。</li>
</ul>
<h2 id="zfs-on-linux" class="heading-control">ZFS on Linux<a class="heading-anchor" href="#zfs-on-linux" aria-hidden="true"></a></h2>
<p>如果你是在用Linux/Gentoo 发行版本:</p>
<pre><code class="bash"><span class="hljs-variable">$sudo</span> -s
<span class="hljs-comment">#emerge --sync</span>
<span class="hljs-comment">#echo "sys-fs/zfs **" &gt; /etc/portage/package.keywords/zfs</span>
<span class="hljs-comment">#echo "sys-kernel/spl **" &gt;&gt; /etc/portage/package.keywords/zfs</span>
<span class="hljs-comment">#emerge -v =sys-kernel/spl-9999 =sys-fs/zfs-9999</span>
</code></pre>
<p>如果你用Ubuntu那就更简单了：</p>
<pre><code class="bash">$ sudo -s
<span class="hljs-comment"># apt-add-repository ppa:zfs-native/daily</span>
<span class="hljs-comment"># apt-get update</span>
<span class="hljs-comment"># apt-get install debootstrap ubuntu-zfs</span>
</code></pre>
<p>如果不出意外的话，这样ZFS就安装好了，检查是否安装OK：</p>
<pre><code class="bash"><span class="hljs-comment"># modprobe zfs</span>
<span class="hljs-comment"># dmesg | grep ZFS:</span>
ZFS: Loaded module v0.6.0-rc8, ZFS pool version 28, ZFS filesystem version 5
</code></pre>
<p>如果要玩Boot From ZFS Root Filesystem，那么这个比较复杂，还是等进阶后，再去详细了解吧。</p>
<h2 id="shi-yong-zfs" class="heading-control">使用 ZFS<a class="heading-anchor" href="#shi-yong-zfs" aria-hidden="true"></a></h2>
<p>ZFS有四个主要的概念，理清这些概念非常重要：虚拟设备(<code>vdevs</code>)，存储池(<code>Storage Pool</code>), 卷(<code>Volume</code>)，快照(<code>Snapshot</code>)</p>
<p>虚拟设备由若干块设备配置的指定阵列构成，块设备可以是文件，磁盘分区或者磁盘(推荐整盘使用)。存储池(<code>Storage Pool</code>)由若干虚拟设备构成。卷可以树状目录的形式在存储池中被任意的创建。然后我们可以为卷创建任意时刻的快照。</p>
<p>如果你的所有磁盘都是完全同样的大小，并且只准备使用同一阵列模式，那么你可以将整盘作为虚拟设备加入。否则你需要分区你的磁盘，除了条带(stripe)阵列外，要求同一阵列的分区大小必须相同，如果大小不同，那么存储池实际容量将会以最小的分区作为基准计算。</p>
<p>ZFS 支持条带(stripe)阵列，镜像(Mirror)阵列，Raidz(raidz1,raidz2,raidz3)阵列。</p>
<ul>
<li>条带(stripe)阵列性能最好，空间利用率最大(容量=所有磁盘之和)，但是数据完整性最差。</li>
<li>镜像(Mirror)阵列性能最差(几乎等同于单盘性能)，空间利用率最小(容量=单个磁盘)，但是数据完整性最好。</li>
<li>Raidz(RAID5/6/7)阵列是一种折衷选择，性能居中，空间利用率居中，但是数据完整性居中(Raidz1允许1个磁盘同时失效, Raidz2允许2个磁盘同时失效，Raidz3允许3个磁盘同时失效)。<br>
Raidz至少要3块盘。Raidz2至少4块盘。假设磁盘块数为N，大小为X，那么Raidz的实际使用空间＝<code>(N-1)*X, Raidz2的实际使用空间=(N-2)*X</code></li>
</ul>
<p>假设你有四个同样大小的sata磁盘: /dev/sda /dev/sdb /dev/sdc /dev/sdd</p>
<h3 id="chuang-jian-zfs-raidz-cun-chu-chi" class="heading-control">创建ZFS Raidz 存储池：<a class="heading-anchor" href="#chuang-jian-zfs-raidz-cun-chu-chi" aria-hidden="true"></a></h3>
<pre><code class="bash">    $ sudo zpool create myzpool /dev/sda /dev/sdb /dev/sdc /dev/sdd
    $ sudo zfs list
    NAME      USED  AVAIL  REFER  MOUNTPOINT
    myzpool  96.5K   146M  31.4K  /myzpool
    $
</code></pre>
<h3 id="cha-kan-cun-chu-chi-shu-xing" class="heading-control">查看存储池属性<a class="heading-anchor" href="#cha-kan-cun-chu-chi-shu-xing" aria-hidden="true"></a></h3>
<pre><code class="bash">    $ sudo zfs get all myzpool
    NAME     PROPERTY              VALUE                  SOURCE
    myzpool  <span class="hljs-built_in">type</span>                  filesystem             -
    myzpool  creation              Sat Nov 13 22:43 2010  -
    myzpool  used                  96.5K                  -
    myzpool  available             146M                   -
    myzpool  referenced            31.4K                  -
    myzpool  compressratio         1.00x                  -
    myzpool  mounted               yes                    -
    myzpool  quota                 none                   default
    myzpool  reservation           none                   default
    myzpool  recordsize            128K                   default
    myzpool  mountpoint            /myzpool               default
    myzpool  sharenfs              off                    default
    myzpool  checksum              on                     default
    myzpool  compression           off                    default
    myzpool  atime                 on                     default
    myzpool  copies                1                      default
    myzpool  version               4                      -
    ...
    myzpool  primarycache          all                    default
    myzpool  secondarycache        all                    default
    myzpool  usedbysnapshots       0                      -
    myzpool  usedbydataset         31.4K                  -
    myzpool  usedbychildren        65.1K                  -
    myzpool  usedbyrefreservation  0                      -
    $
</code></pre>
<h3 id="zfs-de-wen-jian-ya-suo-neng-li" class="heading-control">ZFS的文件压缩能力<a class="heading-anchor" href="#zfs-de-wen-jian-ya-suo-neng-li" aria-hidden="true"></a></h3>
<pre><code class="bash">    $ sudo zfs create myzpool/myzdev
    $ sudo zfs list
    NAME             USED  AVAIL  REFER  MOUNTPOINT
    myzpool          139K   146M  31.4K  /myzpool
    myzpool/myzdev  31.4K   146M  31.4K  /myzpool/myzdev
    $ sudo zfs <span class="hljs-built_in">set</span> compression=on myzpool/myzdev
    $ ls /myzpool/myzdev/
    $ sudo cp ../linux/Documentation/devices.txt /myzpool/myzdev/
    $ ls -la ../linux/Documentation/devices.txt
    -rw-r--r-- 1 mtj mtj 118144 2010-05-16 14:17 ../linux-2.6.34/Documentation/devices.txt
    $ ls -la /myzpool/myzdev/
    total 5
    drwxr-xr-x 2 root root      3 2010-11-20 22:59 .
    drwxr-xr-x 3 root root      3 2010-11-20 22:55 ..
    -rw-r--r-- 1 root root 118144 2010-11-20 22:59 devices.txt
    $ du -ah /myzpool/myzdev/
    60K /myzpool/myzdev/devices.txt
    62K /myzpool/myzdev/
    $ sudo zfs get compressratio myzpool
    NAME     PROPERTY       VALUE  SOURCE
    myzpool  compressratio  1.55x  -
    $
</code></pre>
<h3 id="cha-kan-pool-de-zhuang-tai" class="heading-control">查看Pool的状态<a class="heading-anchor" href="#cha-kan-pool-de-zhuang-tai" aria-hidden="true"></a></h3>
<pre><code class="bash">$ sudo zpool status myzpool
  pool: myzpool
 state: ONLINE
 scrub: none requested
config:

    NAME        STATE     READ WRITE CKSUM
    myzpool     ONLINE       0     0     0
      raidz1    ONLINE       0     0     0
        sda     ONLINE       0     0     0
        sdb     ONLINE       0     0     0
        sdc     ONLINE       0     0     0
        sdd     ONLINE       0     0     0

errors: No known data errors
$
</code></pre>
<h3 id="pool-zhong-yi-ge-ci-pan-sun-hai-hou-de-xiu-fu" class="heading-control">Pool中一个磁盘损害后的修复<a class="heading-anchor" href="#pool-zhong-yi-ge-ci-pan-sun-hai-hou-de-xiu-fu" aria-hidden="true"></a></h3>
<p>首先弄坏一个磁盘的数据:</p>
<pre><code class="bash">$ dd <span class="hljs-keyword">if</span>=/dev/zero of=/dev/sdd bs=64M count=1
1+0 records <span class="hljs-keyword">in</span>
1+0 records out
67108864 bytes (67 MB) copied, 1.84791 s, 36.3 MB/s
$
</code></pre>
<p>然后检查Pool:</p>
<pre><code class="bash">$ sudo zpool scrub myzpool
$ sudo zpool status myzpool
  pool: myzpool
 state: ONLINE
status: One or more devices could not be used because the label is missing or
    invalid.  Sufficient replicas exist <span class="hljs-keyword">for</span> the pool to <span class="hljs-built_in">continue</span>
    functioning <span class="hljs-keyword">in</span> a degraded state.
action: Replace the device using <span class="hljs-string">'zpool replace'</span>.
   see: http://www.sun.com/msg/ZFS-8000-4J
 scrub: scrub completed after 0h0m with 0 errors on Sat Nov 20 23:15:03 2010
config:

    NAME        STATE     READ WRITE CKSUM
    myzpool     ONLINE       0     0     0
      raidz1    ONLINE       0     0     0
        sda     ONLINE       0     0     0
        sdb     ONLINE       0     0     0
        sdc     ONLINE       0     0     0
        sdd     UNAVAIL      0     0     0  corrupted data

errors: No known data errors
$ wc -l /myzpool/myzdev/devices.txt
3340 /myzpool/myzdev/devices.txt
$
</code></pre>
<p>使用replace修复:</p>
<pre><code class="bash">$ sudo zpool replace myzpool sdd sdd
$ sudo zpool status myzpool
  pool: myzpool
 state: ONLINE
 scrub: resilver completed after 0h0m with 0 errors on Sat Nov 20 23:23:12 2010
config:

    NAME        STATE     READ WRITE CKSUM
    myzpool     ONLINE       0     0     0
      raidz1    ONLINE       0     0     0
        sda     ONLINE       0     0     0
        sdb     ONLINE       0     0     0
        sdc     ONLINE       0     0     0
        sdd     ONLINE       0     0     0  59.5K resilvered

errors: No known data errors
$ sudo zpool scrub myzpool
$ sudo zpool status myzpool
  pool: myzpool
 state: ONLINE
 scrub: scrub completed after 0h0m with 0 errors on Sat Nov 20 23:23:23 2010
config:

    NAME        STATE     READ WRITE CKSUM
    myzpool     ONLINE       0     0     0
      raidz1    ONLINE       0     0     0
        sda     ONLINE       0     0     0
        sdb     ONLINE       0     0     0
        sdc     ONLINE       0     0     0
        sdd     ONLINE       0     0     0

errors: No known data errors
$
</code></pre>
]]></content>
      <categories>
        <category>Thinking</category>
        <category>Cloud Computing</category>
      </categories>
      <tags>
        <tag>cloud computing</tag>
        <tag>diy</tag>
        <tag>zfs</tag>
      </tags>
  </entry>
  <entry>
    <title>DIY与云计算（二）之 DIY自己的开源NAS</title>
    <url>/article/diy-cloud-computing-2/</url>
    <content><![CDATA[<p>对于云计算存储而言，家用NAS存储是云计算存储的一个子集，它不用考虑迁移，LB，远程mount，存储集群的管理等等。相对与公共服务的云计算，家庭NAS就相当于家庭的数据中心了。家庭的各种数据能安全存放在NAS中。利用NAS家庭的其它电脑能方便的对它进行访问使用，以及在后面以极低的功耗默默下载，就算不在家，也能远程管理家里的下载，看到任何资源就能随时下载管理。<br>
NAS提供给我们的功能有：</p>
<p>文件共享服务：现在很多人家中的电脑都不止一台，这样视频，照片、音乐、文件等数据资源分散在不同的电脑中，要去找出会很麻烦。通过家用NAS，家中的各个成员可以将想分享或共用的照片、音乐、影片或其他文件档案，分门别类地放在同一个网络硬盘中，避免相同的资料在每部电脑里浪费同样的空间。</p>
<p>数据备份服务：NAS一般都具有多种备份功能，包括本地备份、异地备份和NAS间备份等等。另外NAS还具有一键备份功能，将USB存储设备(如闪盘和外置硬盘)插入NAS上特定USB接口，就能把USB存储设备上的文件备份到NAS中。</p>
<p>家庭服务中心：通过把打印机与NAS相连，开启NAS网络打印机功能，我们就能在局域网中共同使用这台打印机，通过在NAS上建立Web服务，把照片和录像存放在NAS网络存储器的指定目录中，就能通过浏览器登陆NAS的Web网站进行观看，就像访问网络相册一样。另外在NAS中使用UPnP-AV功能(或称流媒体功能)，在网络中可以被Windows MCE系统、Xbox360和PS3等设备发现，无须额外的操作就能播放存储在NAS中的多媒体文件。同时我们还可以用NAS网络存储器搭建iTunes服务器，让iTunes软件和iPod等设备从NAS上获得音乐和视频。</p>
<h2 id="diy-nas" class="heading-control">DIY NAS<a class="heading-anchor" href="#diy-nas" aria-hidden="true"></a></h2>
<p>技术要点：</p>
<ul>
<li>ITX 主板：节约空间，采用17x17 cm的小主板</li>
<li>低功耗(&lt;=30W): NAS是要长年开机，为了尽可能的降低成本，节约起见，主板CPU功耗不高于30W</li>
<li>热插拔(&gt;=4 盘位)：为了便于更换硬盘以及Raid5的要求，盘位要求&gt;=4。</li>
<li>Sata3接口：保护投资，为以后硬盘升级(SSD)准备</li>
<li>千兆网卡: 这是必须的，如果想直接在nAS上传输播放高清影片。</li>
<li>CPU：性能至少要能保证软组Raid</li>
<li>内存(&gt;=8G)：至少支持8G。</li>
</ul>
<p>对于服务器而言如果是1U机箱可以塞4块ITX主板，甚至可以塞到6块ITX主板；如果是塞1块ITX主板，那么可以塞5－6块3.5的硬盘。</p>
<p>目前4盘位的NAS空机（不含硬盘）价格：</p>
<ul>
<li>巴法络/buffalo LS-QVL/E-AP： 1400¥
<ul>
<li>最大容量 8TB, 4xSata2, 2xUsb2, 1.6Ghz Marvell(88F6282A0C160) processor and 512MB of RAM.</li>
</ul>
</li>
<li>群晖synology DS411j: 3000¥
<ul>
<li>最大容量12TB, 4xSata2, 2xUsb2, CPU 1.2G, DDR2 128M RAM</li>
</ul>
</li>
<li>D-Link DNS-343: 2150¥
<ul>
<li>4xSata2, CPU Marvell 88F5281-D0 C500Mhz, 128MB</li>
</ul>
</li>
<li>Century世特力裸族CRIB35NAS: 1980¥
<ul>
<li>最大容量 12TB, unkown</li>
</ul>
</li>
</ul>
<p>从上述商业NAS系统来看，CPU大都是采用ARM芯片，内存也少得可怜，但是价格不菲。</p>
<h2 id="wo-cai-gou-de-ying-jian-qing-dan" class="heading-control">我采购的硬件清单：<a class="heading-anchor" href="#wo-cai-gou-de-ying-jian-qing-dan" aria-hidden="true"></a></h2>
<h3 id="ji-xiang" class="heading-control">机箱：<a class="heading-anchor" href="#ji-xiang" aria-hidden="true"></a></h3>
<ul>
<li>4盘位热插拔机箱 498¥ 毛重 3.5Kg，1个12cm风扇，只能上半高的卡（可能以后扩硬Raid卡有问题)</li>
<li>6盘位热插拔机箱 849¥ 毛重 5 kg, 有足够的空间固定硬Raid卡，2个可调速9cm风扇。但是太重。性价比也不高(备选)</li>
</ul>
<p>目前正在团购，上述为团购价格，应该在清理存货，机箱的问题：热插拔盒塑料有些薄，没有锁，机箱做工不够精细。</p>
<h3 id="zhu-ban" class="heading-control">主板：<a class="heading-anchor" href="#zhu-ban" aria-hidden="true"></a></h3>
<p>目前我在淘宝上看到的Intel Atom(D525) Mini-ITX平台(15W)上全部是Sata3支持的很少，混合Sata3和Sata2，太会节约成本了。而且最关键的是最大内存只到4G。可能Intel不希望有人把主板拿去做低功耗的文件服务器吧，故目前几乎不用考虑Intel的东西。</p>
<p>AMD的E350平台功耗大约在18W-20W，至少支持4个Sata3口，内存最大可以到8G，也有到16G的，两个DDR3 PC内存槽。</p>
<ul>
<li>ASROCK/华擎E350M1
<ul>
<li>4Sata3口，</li>
<li>1eStata3，</li>
<li>内存DDR3 1066 最大16G,</li>
<li>1xPCIe2.0x16,</li>
<li>12xUSB2,</li>
<li>1PCIEx1GNetwork,</li>
<li>无USB3</li>
<li>价格500¥上下</li>
</ul>
</li>
<li>华硕E35M1-I（备选）
<ul>
<li>6个Sata3口，</li>
<li>内存DDR3 1066 最大8G，</li>
<li>1个PCIe2.0x16(x4mode),</li>
<li>12个Usb2，</li>
<li>无Usb3,</li>
<li>eSata,</li>
<li>1PCIEx1GNetwork</li>
<li>淘宝上暂时买不到,只能买到 E35M1-I/E45M1 Dexlue 版本。</li>
</ul>
</li>
</ul>
<p>更多的内存还是更多的sata3口，这是个选择问题，而我选择了更多的内存。</p>
<p>E350的GPU为 ATI HD 6310 隶属于 Radeon™ HD 6300M Series Graphics：</p>
<ul>
<li>80 个处理单元</li>
<li>DX11</li>
<li>OpenGL 4.1</li>
<li>OpenCL™ 1.1</li>
<li>DirectCompute 11</li>
</ul>
<h3 id="dian-yuan" class="heading-control">电源<a class="heading-anchor" href="#dian-yuan" aria-hidden="true"></a></h3>
<p>采用 DC-ATX 电源：</p>
<p>计算功率：</p>
<p>单块硬盘</p>
<ul>
<li>开机功率：20w (12V*1.75A=21W)</li>
<li>稳态功率：10w (5.3W)</li>
</ul>
<blockquote>
<p>西数绿盘 WD20EARX 读/写功耗 5.30瓦; Idle: 3.3W; 速度： 110M/s</p>
</blockquote>
<p>估算系统其它功耗：</p>
<ul>
<li>APU Idle(TDP) = 9-18W</li>
<li>A51M(Hudson-M1) Chipsets = 4.7W</li>
<li>CPU Fan= 5W</li>
<li>Case Fan=3W</li>
<li>eSata = 3W</li>
<li>mouse = 1W</li>
<li>keyboard =1W</li>
<li>DDR3 1333 = 1W *2</li>
</ul>
<p>按照4块硬盘全部插满的情况下估算：</p>
<ul>
<li>开机总功率 ~ 21W*4+33W = 117W</li>
<li>稳态总功率 ~ 10W*4+29W(全负荷) = 69W</li>
</ul>
<p>因此选用输出功率为130W的DC-ATX板:</p>
<ul>
<li>输入: 11.7~13.6V</li>
<li>输出功率：额定130W，峰值150W</li>
<li>价格：58¥</li>
</ul>
<p>电源适配器</p>
<ul>
<li>12V 10A电源适配器(65¥): 在开机功率90W，平时功率50W负荷下，但是这个所谓120W的电源工作不了几天就歇菜了，退掉了。</li>
<li>12V 18A DELL的二手电源适配器(110¥): 目前运行良好，温度也还可以，还没有出问题。</li>
</ul>
<p>内存条：</p>
<ul>
<li>Kingbox/黑金刚单条8G DDR3 1333 台式机内存(331¥)</li>
</ul>
<p>总计花费：</p>
<ul>
<li>机箱总价523 ＋ 主板(含APU) 513 ＋ 内存条 331 + DC-ATX 58 ＋ DC适配器 110 ＝ 1535¥</li>
</ul>
<p>得到的是一个双核1.6G AMD CPU/GPU， 8G DDR3（可扩展为16G），全 SATA3 带高清播放支持的4盘位NAS机器。</p>
<p>正在DIY: 图已经丢失</p>
<p>组装完成，试机：图已经丢失</p>
<h2 id="ruan-jian-xi-tong" class="heading-control">软件系统<a class="heading-anchor" href="#ruan-jian-xi-tong" aria-hidden="true"></a></h2>
<p>如果只把它作为文件存储系统，那么因为ZFS的缘故，IllumOS(开源Solaris) 操作系统无疑是非常合适的，但是以这样的CPU性能来说，只作为文件存储系统，未免太浪费了。Linux社区的BTRFS文件系统进展缓慢（尤其是在软Raid功能上），而ZFS是由Sun开发的新型文件系统, 应用于Solaris上，后来被移植到FreeBSD和NetBSD系统上。</p>
<p>基于Solaris内核的NAS系统:</p>
<ul>
<li>OpenIndiana: <a href="http://openindiana.org/" target="_blank" rel="noopener">http://openindiana.org/</a></li>
<li>Nexentastor: 闭源，免费版最大支持16TB.</li>
</ul>
<p>Linux Soft Raid:</p>
<ul>
<li><a href="https://btrfs.wiki.kernel.org/index.php/Main_Page" target="_blank" rel="noopener">BTRFS</a></li>
<li><a href="https://www.openfiler.com/community/openfiler-community" target="_blank" rel="noopener">OpenFiler</a></li>
<li><a href="http://zfsonlinux.org" target="_blank" rel="noopener">Native ZFS on Linux</a></li>
</ul>
<p>正巧最近看到国外社区已经有人在Native ZFS on Linux上做了几个月的小白鼠，还算稳定，而更凑巧的是，这家伙也是选的AsRock E350M1主板，So，我最后还是选择了Linux，这样可以1机两用：NAS 和 媒体中心。</p>
<p>操作系统: 为了能压榨出硬件的最后一点性能，我选用 Linux 的 Gentoo 发行版, Gentoo 可以使得我自己配置调整编译内核。</p>
<h1 id="geng-xin-20160612" class="heading-control">更新(2016-06-12)<a class="heading-anchor" href="#geng-xin-20160612" aria-hidden="true"></a></h1>
<p>光阴似箭，眨眼4年过去了，Intel 推出了Micro Server——志强D系列, 而 AMD 却依然在原地踏步。<br>
4年前，支持ECC RDIMM内存的ITX主板根本找不到，现在超微，AsRock都有了基于志强D系列的ITX MicroServer主板。<br>
NAS机箱也多起来。超微甚至出了带机箱的准系统，但性价比太低。</p>
<ul>
<li>6盘位DIYNAS机箱，可定制LOGO,有防尘网。
<ul>
<li>机箱=499</li>
<li>机箱+技嘉150W DC电源=768</li>
<li>机箱+益横的 250W=840</li>
<li>机箱+全汉电源 270W=880元</li>
<li>益衡 Enhance ENP 7025B FLEX 250W=245元 淘宝价</li>
<li>全汉电源 小1U 270W=108元 淘宝价</li>
<li>需要了解限高问题，内存条，插卡等。</li>
</ul>
</li>
<li>超微X10SDV-4C±TLN4F（128G ECC RDIMM DDR4 2133, M.2 PCIe3.0x4 2242/2280）
<ul>
<li>志强D-1518(4核，6MCache, 2.20Ghz) 35W ￥3720</li>
<li>志强D-1541(8核，6MCache, 2.20Ghz) 45W ￥6880</li>
</ul>
<ul>
<li>可惜是基于Broadwell, 还是得等明年(2017年)的Skylake 。</li>
<li><a href="https://tinkertry.com/how-to-boot-win10-from-samsung-950-pro-nvme-on-superserver" target="_blank" rel="noopener">https://tinkertry.com/how-to-boot-win10-from-samsung-950-pro-nvme-on-superserver</a></li>
</ul>
</li>
<li>三星 32G DDR4 2133 RDIMM 服务器内存: ￥1060</li>
</ul>
]]></content>
      <categories>
        <category>Thinking</category>
        <category>Cloud Computing</category>
      </categories>
      <tags>
        <tag>cloud computing</tag>
        <tag>diy</tag>
        <tag>nas</tag>
      </tags>
  </entry>
  <entry>
    <title>DIY 与 云计算（一）</title>
    <url>/article/diy-cloud-computing-1/</url>
    <content><![CDATA[<p>DIY相信大家都知道，就是自己动手做的意思(Do It by Youself)，而云计算呢？那么何谓云计算，云计算与分布式计算，网格计算的差异在哪里？DIY与云计算能扯得上关系么？然后顺着DIY思路再看看国内，谁能告诉我真正的国内的云计算数据中心在哪里？</p>
<p>在我看来，目前云计算是以超大规模的服务器组成若干数据中心，通过商业运营，为互联网提供可伸缩的，按需供给的基础设施服务。对于希望能对整个互联网提供商业运营服务，如此超大规模的可配置的数据中心，成本就是关键，对于超大规模来说，哪怕是一台的成本能节约100元，那么以万台计算，就可以节约百万，无论采购成本还是运营成本在超大规模的运营下每台的小额节省将会极大的增强成本竞争力。</p>
<p>真正的云计算服务是离不开DIY的，越有技术能力的公司DIY的程度越深，从硬件到软件无一不是在深度定制，用以压榨出更多硬件性能和节能。下面以Google举例来说。Google 的数据中心一直以来都是戒备森严的禁地，众所周知，Google和Amazon这些大佬总是对数据中心内部运营状态严格保密，因为Google把自己在对数据中心服务器的DIY定制能力视作为公司的核心竞争力之一。事实上google一直对于自己定制数据中心硬件严加保密，直到2009年才对外开了一个窗，向外界展示了它5年前的google定制数据中心的面貌。Google 定制自己的主板、机箱、机柜（集装箱），乃至数据中心，甚至利用地势来节能。</p>
<p>Google 展示了自己DIY的一种<a href="./google-server.jpg">服务器</a>，使用一个12瓦电池供电，这比数据中心的 UPS 更可靠。Rich Miller 在<a href="http://www.datacenterknowledge.com/archives/2009/04/01/efficient-ups-aids-googles-extreme-pue/" target="_blank" rel="noopener">一篇关于数据中心的博客文章</a>中表示，这个设计让 Google 的 UPS 利用率达到99.9%，而一般数据中心只能达到92%～95%。</p>
<p><img src="./google-server-l.jpg" alt="Google DIY Server Image"></p>
<p>在 Google 2009年数据中心节能峰会上，Google 表示他们的能效比（PUE - 数据中心总能耗与IT设备能耗比）已经从2008年第三季度的1.21下降到2008年第四季度的1.16。PUE 为 1 表示数据中心没有能源损耗，而根据2006年的统计，一般公司数据中心的能效比为 2.0 或更高。Google 的 1.16 已经低于美国能源部2011年的1.2 的目标。</p>
<h2 id="shu-ju-zhong-xin-diy" class="heading-control">数据中心 DIY<a class="heading-anchor" href="#shu-ju-zhong-xin-diy" aria-hidden="true"></a></h2>
<p>为啥大家不租用现成的数据中心机房，都要自建？</p>
<p>目前大多数机房都是固定按月或按年收取费用，费用太高，已经不适应按需提供服务发展。未来机房如果要发展，必须要能够按功能计费以及按消耗计费。否则这些新建的数据中心未来可能就会取代现有机房模式。</p>
<p>机房功能：</p>
<ul>
<li>空调</li>
<li>UPS</li>
<li>交流电源</li>
<li>直流电源</li>
<li>…</li>
</ul>
<p>计费功能:</p>
<ul>
<li>消耗电量计费</li>
<li>设备损耗计费</li>
<li>…</li>
</ul>
<p>模组化数据中心是目前数据中心的一个普遍趋势。</p>
<p>下图是Amazon DIY的Perdix数据中心模块：<br>
<img src="./amazon-perdix.jpg" alt="Amazon DIY Perdix Image"></p>
<p>这是微软的ITPAC数据中心模组：<br>
<img src="./ms-diy-itpac.jpg" alt="MS DIY ITPAC Image"></p>
<h2 id="kai-yuan-yun-ji-suan-shu-ju-zhong-xin" class="heading-control">开源云计算数据中心<a class="heading-anchor" href="#kai-yuan-yun-ji-suan-shu-ju-zhong-xin" aria-hidden="true"></a></h2>
<p>与严格保密的Google不同，Facebook不仅全新设计的服务器和数据中心，并且将其设计方案开源，这简直是对Google莫大的蔑视。在Google，每一个Google员工都需要签署一份保密协议，而这在Facebook根本不需要。这也使得微软也公布了都柏林数据中心的部分细节。不过，据Google前员工透露，Google的数据中心因为持续仅10年不断创新改进而十分强大。但开放的Facebook却获得了更多拥护者，包括英特尔、Dell、华硕、Rackspace都加入了Open Compute Project中。</p>
<p>去年4月，Facebook发布Open Compute Project，对其服务器以及数据中心的架构进行了开源，意在加速数据中心和服务器创新。Facebook此次不仅公开了技术文档，甚至连服务器和数据中心的CAD图纸设计也完全公开。也有人说Facebook此举是在讽刺Google，后者的数据中心和服务器领域技术公认非常领先，但一直视为独门绝技，密不示人。</p>
<p>Facebook的数据表明，他们的定制硬件各方面指标比业界标准要高得多，与公司从设备厂商购买的同类现成产品相比，效率提升38%，成本则降低了28%。而整个数据中心的能耗按PUE(Power Usage Effectiveness，电能使用效率)衡量是1.07，大大低于业界通常的1.5。</p>
<p>在Facebook新服务器中，电源传输到微处理器的方式就完全不同。Facebook硬件团队改变了服务器的布局和电源供应方式，甚至连电源线和电源插头都被重新设计，而且服务器的组装和维护无需任何工具。新式服务器的易用性是Facebook硬件团队的最大创新之一。米迦勒说：“当你拥有数万台服务器时，每小时都会出现宕机问题，例如硬盘损坏，内存损毁等。我们的数据中心技术人员负责维护服务器。有时，他们会用上一整天的时间安装服务器配件。我们希望让他们的工作尽可能地轻松，并且更有效率。无需任何工具我们便可组装服务器，多数组件的组装速度是一般服务器组件的2至10倍。”为了寻找新的硬件制造商，Facebook团队成员一次又一次地往返在美国与台湾之间。在招募一名机械工程师的同时，Facebook还起草了一份50多页的新服务器设计说明书。米迦勒表示：“在白纸上设计是一回事，而设计细节更需要慎重。我们要定制所有的组件，并且要重新设计服务器，这些尤其应当谨慎。”</p>
<h2 id="diy-yun-ji-suan-fu-wu-qi" class="heading-control">DIY 云计算服务器<a class="heading-anchor" href="#diy-yun-ji-suan-fu-wu-qi" aria-hidden="true"></a></h2>
<p>按不同的功能需求定制自己的服务器，云计算服务器可以分为三类：</p>
<ul>
<li>虚拟计算机服务</li>
<li>存储服务</li>
<li>Cache服务</li>
</ul>
<p>改造1： 这三类服务器通用的DIY功能就是DC电源，将DC电源外置，不在主板内的好处有两个好处，1个是直接DC供电；2是可以直接使用电池作为紧急电源取消UPS提供用电效率。</p>
<p>改造2：使用PC的CPU、主板、内存代替服务器CPU、主板和内存节约成本。</p>
<p>对于虚拟计算机服务，CPU频率、CPU虚拟化以及IO虚拟化与提供的虚拟后的性能息息相关，所以应根据自己云计算业务能力来决定。</p>
<p>而对于存储服务这块，可定制和创新的方方面面更多些。</p>
]]></content>
      <categories>
        <category>Thinking</category>
        <category>Cloud Computing</category>
      </categories>
      <tags>
        <tag>cloud computing</tag>
        <tag>diy</tag>
      </tags>
  </entry>
  <entry>
    <title>基于信息的社交媒体网络进一步的创新兼谈 Google+</title>
    <url>/article/thinking-sns/</url>
    <content><![CDATA[<p><img src="./google-plus-logo.png" alt><br>
就目前的互联网来说，最火爆的当属于社交媒体。从产品形态上来区分，当前的社交媒体主要有两大流派，一是以短信息为中心的其代表twitter；二是以社交圈子为中心其代表为Facebook。</p>
<h1 id="xian-zhuang" class="heading-control">现状<a class="heading-anchor" href="#xian-zhuang" aria-hidden="true"></a></h1>
<p>虽然目前大家都在关注微博类和社交类，但是事实上社交媒体本身可不仅仅限于此。下面一一絮叨之。社交媒体，从产品层面上来看固有元素有二：内容（Contents）和SNS（社会化网络关系）。</p>
<h2 id="yi-nei-rong" class="heading-control">一、内容<a class="heading-anchor" href="#yi-nei-rong" aria-hidden="true"></a></h2>
<p>首先说说内容，或者叫媒体，又或者叫信息。内容可以从内容的量的多寡来看，也可以从内容的类型来看。</p>
<h3 id="nei-rong-de-liang" class="heading-control">内容的量<a class="heading-anchor" href="#nei-rong-de-liang" aria-hidden="true"></a></h3>
<p>从内容的量来看，大致可以分为3级：1、大量/巨量内容；2、短篇内容 ；3、百字短文</p>
<ol>
<li>大量/巨量内容
<ul>
<li>这个是以小说或者电视剧为代表，通常出现在网站上是以连载形式出现。</li>
</ul>
</li>
<li>短篇内容
<ul>
<li>这个是以博文或者新闻为代表。</li>
</ul>
</li>
<li>百字短文
<ul>
<li>这个是以微博或者短信为代表。</li>
</ul>
</li>
</ol>
<h3 id="nei-rong-de-lei-xing" class="heading-control">内容的类型<a class="heading-anchor" href="#nei-rong-de-lei-xing" aria-hidden="true"></a></h3>
<p>从内容的类型来看，大致可以分为：</p>
<ol>
<li>视频动画；</li>
<li>音乐</li>
<li>图片</li>
<li>富媒体</li>
<li>富文本</li>
<li>垂直领域的内容（鲜花、汽车、房屋、…）</li>
</ol>
<h2 id="er-sns" class="heading-control">二、SNS<a class="heading-anchor" href="#er-sns" aria-hidden="true"></a></h2>
<p>从社交关系来看，可以从两个维度来看：一是私密维度；二是关系维度。</p>
<h3 id="cong-si-you-cheng-du-lai-kan" class="heading-control">从私有程度来看:<a class="heading-anchor" href="#cong-si-you-cheng-du-lai-kan" aria-hidden="true"></a></h3>
<ol>
<li>完全私有 这个是以短信/kik 为代表。</li>
<li>部分私有 这个是以聊天室，FaceBook为代表。</li>
<li>完全开放 这个是以微博(twitter)为代表。</li>
</ol>
<h3 id="cong-guan-xi-cheng-du-lai-kan" class="heading-control">从关系程度来看：<a class="heading-anchor" href="#cong-guan-xi-cheng-du-lai-kan" aria-hidden="true"></a></h3>
<ul>
<li>双向关系：FaceBook</li>
<li>单向关系：Twitter</li>
<li>反向单向关系：Path (别人需要邀请你，你才能关注)</li>
<li>弱关系：仅当在指定的地点、时间才会有某种关系</li>
<li>没有关系：网上闲置租车(UBER)</li>
</ul>
<p>将它们每一个联系组织起来就会有不同的玩法，也许会是一个好的产品，也许不是。是不是好的产品的关键是是否能满足某类人的某种需求。比如下面的例子：</p>
<p>FaceBook：</p>
<ul>
<li>默认只有朋友可见(部分私有)，私有程度可以在任何人，朋友的朋友，只有朋友，定制程度切换</li>
<li>双向关系(互相收听)</li>
<li>字数限制：貌似没有</li>
<li>媒体类型：要么文本、要么图片、要么视频、要么链接、要么问题</li>
<li>评论：有</li>
</ul>
<p>Twitter:</p>
<ul>
<li>默认完全开放，私有程度可以在完全私有和完全开放之间切换</li>
<li>单向关系</li>
<li>没有关系：通过指定人(@)收听</li>
<li>字数限制: 140，</li>
<li>媒体类型：仅限文本</li>
<li>评论：无</li>
</ul>
<p>OK，现在是回过头来看看Google+的时候了。我以为G+对圈子的激动人心的创新在于，通过圈子，把双向关系变成“单向”：你只需要维护好你自己的圈子就行了，这实质上就一个以个人为中心(P2P)的圈。而无需去操心别的。当然如果有需求要强制别人去阅读你推送的消息（已阅），而对于这样的场景可能G+并不太合适（从技术上说只要G+API推出后也许会出现某类应用满足这个需求）。</p>
<h1 id="google" class="heading-control">Google+<a class="heading-anchor" href="#google" aria-hidden="true"></a></h1>
<p><img src="./google-plus.png" alt></p>
<p>Google+：</p>
<ul>
<li>公开关系</li>
<li>圈子关系：通过圈子来决定信息的流转</li>
<li>没有关系：通过指定人(@或+)收听</li>
<li>字数限制：貌似没有</li>
<li>媒体类型：带格式的文本(一个消息可以插入多张图片或者一个视频或者一个链接</li>
<li>评论：有</li>
<li>LBS 位置</li>
</ul>
<h2 id="quan-zi-circle" class="heading-control">圈子（“Circle”）<a class="heading-anchor" href="#quan-zi-circle" aria-hidden="true"></a></h2>
<p>Google对于社交网络进一步思索和创新首先在于圈子（“Circle”），通过圈子来完成轻松的对信息的私有程度进行缩放的过程。你只需组织你的联系人到不同的圈子即可。</p>
<p>通过圈子可以针对你的不同通讯录上的联系人灵活的介于公开和非公开之间的社交领域去分享信息。所有的信息的推送或者获取都将基于圈子。信息的推送有点类似于邮件组的感觉，在理解了圈子的含义后，我感觉比微博和facebook的推送机制好用多了。当然，理解圈子会是个槛。</p>
<p>如果某人将你圈了进来，你会收到邮件通知和页面通知（在你的姓名右上角），你可以决定是否将对方也圈起来。这样，他推送到消息将会出现在你圈的圈子中，当然不圈也没有关系，这个时候，他推送的消息只会出现在Incoming的圈子里的。</p>
<p>当你post一张相片或者更新某个玩意的时候，如何通过圈子控制该消息的私密程度？请看下面：</p>
<p><img src="post1.png" alt></p>
<ul>
<li>Public: 完全公开，任何人都能看到</li>
<li>特定的圈子：可以选择多个你建立的圈子</li>
<li>Your circles: 你的建立的所有的圈子里的人都可以看到</li>
<li>Extended Circles：扩展圈子，你的圈子的人以及圈子的圈子的人都可以看到</li>
<li>特定的联系人：选择多个特定的联系人(email)可以看到</li>
</ul>
<p>我以为G+对圈子的激动人心的创新在于，通过圈子，把双向关系变成“单向”：你只需要维护好你自己的圈子就行了，这实质上就一个以个人为中心(P2P)的圈。而无需去操心别的。当然如果有需求要强制别人去阅读你推送的消息（已阅），而对于这样的场景可能G+并不太合适（从技术上说只要G+API推出后也许会出现某类应用满足这个需求）。</p>
<p>另外一些微小的改进也是很有爱的，针对POST：</p>
<p>自己发的：</p>
<p><img src="./self-post.png" alt></p>
<ul>
<li>Edit this post: 编辑</li>
<li>Delete this post: 删除</li>
<li>Disable comments：禁止评论</li>
<li>Disable reshare：禁止分享</li>
</ul>
<p>别人发的：</p>
<p><img src="./other-post.png" alt></p>
<ul>
<li>Link to this post: 链接</li>
<li>Report abuse：滥用</li>
<li>Mute this post：不想再看到这个帖子把它沉底吧</li>
<li>Block this persion：不想再看到此人发的贴</li>
</ul>
<p>另外蛮有意思的是hangouts，创建多人视频群聊，以及Sparks 基于搜索的主题关注（要是能集成Google Reader的RSS，才有大用）。</p>
<h2 id="can-kao" class="heading-control">参考：<a class="heading-anchor" href="#can-kao" aria-hidden="true"></a></h2>
<ul>
<li><a href="http://www.36kr.com/googleplus50/" target="_blank" rel="noopener">http://www.36kr.com/googleplus50/</a></li>
<li><a href="https://plus.google.com/photos/108443027359212340995/albums/5625655838907702241" target="_blank" rel="noopener">https://plus.google.com/photos/108443027359212340995/albums/5625655838907702241</a></li>
<li><a href="http://www.36kr.com/google-plus-team-leaders-talk-about-product-details/" target="_blank" rel="noopener">http://www.36kr.com/google-plus-team-leaders-talk-about-product-details/</a></li>
<li><a href="http://article.yeeyan.org/view/216086/204409" target="_blank" rel="noopener">http://article.yeeyan.org/view/216086/204409</a></li>
<li><a href="http://www.ifanr.com/45060" target="_blank" rel="noopener">http://www.ifanr.com/45060</a></li>
<li><a href="http://www.ifanr.com/45467" target="_blank" rel="noopener">http://www.ifanr.com/45467</a></li>
</ul>
]]></content>
      <categories>
        <category>Thinking</category>
        <category>Internet</category>
        <category>SNS</category>
      </categories>
      <tags>
        <tag>thinking</tag>
        <tag>internet</tag>
        <tag>creation</tag>
        <tag>sns</tag>
      </tags>
  </entry>
  <entry>
    <title>开源 Bitcoin P2P电子货币系统技术内幕</title>
    <url>/article/bitcoin-tech/</url>
    <content><![CDATA[<p>开源 Bitcoin P2P电子货币是点对点的电子现金系统，创建于2009年[<a href="http://en.wikipedia.org/wiki/Bitcoin" target="_blank" rel="noopener">http://en.wikipedia.org/wiki/Bitcoin</a>]。无需金融机构直接点对点支付。该电子货币系统的特色是无需信托中间人，能够方便的进行互联网上的汇款。第三方不能够控制或者阻止您的交易。Bitcoin 交易几乎免费, 而信用卡的网上在线支付系统通常收取 1-5% 的交易费用，加上其他各种费用高达数百美元。避免了中央储备银行的不良政策和不稳定性所造成的安全隐患. Bitcoin系统的有限货币通胀是均匀分布(由CPU决定)于整个网络, 而不是由银行垄断。</p>
<p>这被某些人认为是最危险的开源项目，但我觉得恰恰相反，这是有史以来最令人兴奋的开源项目。这样发行的币才是真正的“人 民 币”，人民才是被服务，而不是被管理。P2P必将从商业、政治、生活各个方面重新定义新的更加公平公正的意识形态。</p>
<h2 id="ming-ci-jie-shi-yi-ji-bei-hou-de-ji-shu" class="heading-control">名词解释以及背后的技术<a class="heading-anchor" href="#ming-ci-jie-shi-yi-ji-bei-hou-de-ji-shu" aria-hidden="true"></a></h2>
<p>Bitcoin涉及到很多有意思的技术，要想搞懂bitcoin首先必须对这些技术理解和把握然后是对Bitcoin术语的理解，bitcoin最重要的技术支撑是P2P，数字签名(EC DSA)，散列(SHA256, RIPEMD-160), POW，和HashCash。而术语则是：transaction, block,  address, Merkle Tree.</p>
<h3 id="gong-zuo-zheng-ming-powproofofwork-ji-zhi" class="heading-control">工作证明 <a href="http://en.wikipedia.org/wiki/Proof-of-work_system" target="_blank" rel="noopener">POW(Proof-Of-Work)</a>机制<a class="heading-anchor" href="#gong-zuo-zheng-ming-powproofofwork-ji-zhi" aria-hidden="true"></a></h3>
<p>工作证明POW系统是要求对方服务前，必须要出据某种工作证明的机制。主要用于防止拒绝服务攻击和反垃圾信息。通常这种“工作证明”会花费一定的时间计算才能得到。最常见的例子是<a href="http://en.wikipedia.org/wiki/CAPTCHA" target="_blank" rel="noopener">CAPTCHA</a>。另外用于防止DoS和垃圾信息的机制是<a href="http://en.wikipedia.org/wiki/Hashcash" target="_blank" rel="noopener">HashCash</a>，bitcoin使用的原理就类似于<a href="http://en.wikipedia.org/wiki/Hashcash" target="_blank" rel="noopener">HashCash</a>.</p>
<h3 id="hashcash-ji-zhi" class="heading-control"><a href="http://en.wikipedia.org/wiki/Hashcash" target="_blank" rel="noopener">HashCash</a> 机制<a class="heading-anchor" href="#hashcash-ji-zhi" aria-hidden="true"></a></h3>
<p>hashcash 的灵感来自于这样一个想法，即一些数学结果难于发现而易于校验。一个众所周知的例子是因数分解一个大的数字（尤其是因数较少的数字）。将数字相乘来获得它们的积的代价是低廉的，但首先找到那些因数的代价却要高得多。</p>
<p>对交互式质询来说，因数分解足以胜任。比如，希望客户端能象征性地为其付出代价方能访问在线资源。这个时候可以定义协议，首先服务器向客户端发送一个消息，说“只要您能因数分解这个数，我将让您得到这个资源”。没有诚意的客户端将无法得到我的资源，只有那些能够证明自己有足够的兴趣、付出一些 CPU 周期来回答这个质询的才能得到这个资源。</p>
<p>不过，有一些资源无法很方便地进行交互式协商。比如电子邮件反垃圾或者支付交易，怎么才能避免邮箱不被垃圾邮件所占据？“我并不介意陌生人给我写信，但是，我希望他们能以稍微认真的态度，亲自通过对我有价值的邮件与我取得联系。至少，我不希望他们是垃圾邮件制造者，那些人向我和上百万的其他人发送包含同样消息的邮件（double-spending），期望我们中的某些人能购买某种产品或者落入一个骗局。”而对于电子货币，内容的复制几乎是没有代价的，如何保证电子货币（内容）没有被交易（发送）多次？这和反垃圾邮件是同样的问题。</p>
<p>hashcash的解决之道就是：在电子邮件的消息头中，增加一个 hashcash 戳记（hashcash stamp）散列值；该散列中包含收件人地址，发送时间，salt，该散列值特别之处在于它至少前20位必须是0才是一个合法的hashcash戳记。为了得到合法的散列值，发送者必须经过许多次尝试（改变salt值）才能获得。一旦生成戳记，不希望每一个给我发送邮件的垃圾邮件制造者都能重复使用它。所以，hashcash 戳记要带一个日期。这样可以指定时间更早的戳记是非法的。另外 hashcash 的接收端要实现一个double-spending数据库，用来记录戳记的历史信息。</p>
<h3 id="bitcoin-zhong-de-shu-yu-jie-shi" class="heading-control">Bitcoin中的术语解释<a class="heading-anchor" href="#bitcoin-zhong-de-shu-yu-jie-shi" aria-hidden="true"></a></h3>
<p>散列：bitcoin在计算散列时一般会计算2次。第一轮总是使用SHA-256散列，而第二次在大多数情况下，也是使用<a href="http://en.wikipedia.org/wiki/SHA-2" target="_blank" rel="noopener">SHA-256</a>散列，但用于生成较短的散列(例如生成 bitcoin接收地址的时候)会用<a href="http://en.wikipedia.org/wiki/RIPEMD" target="_blank" rel="noopener">RIPEMD-160</a>散列。</p>
<pre><code>hello
 2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824 ( sha-256)
 9595c9df90075148eb06860365df33584b75bff782a510c6cd4883a419833d50 (sha-256)
</code></pre>
<p>生成比特币地址时(RIPEMD-160)：</p>
<pre><code>hello
 2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824 (sha-256)
 b6a9c8c230722b7c748331a8b450f05566dc7d0f (ripemd-160)
</code></pre>
<p>Addresses: Bitcoin Address是ECDSA公钥(public key)的散列，计算方法如下：</p>
<pre><code class="python"><span class="hljs-keyword">if</span> 正式网络
  Version=<span class="hljs-number">0x00</span>
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> 测试网络
  Version=<span class="hljs-number">0x6F</span>
end
key_hash=Version+RIPEMD<span class="hljs-number">-160</span>(SHA<span class="hljs-number">-256</span>(public_key))
Checksum = SHA<span class="hljs-number">-256</span>(SHA<span class="hljs-number">-256</span>(Key hash))[<span class="hljs-number">0.</span><span class="hljs-number">.3</span>]  <span class="hljs-comment">#取两次散列值后的前4位</span>
Bitcoin_Address = Base58Encode(Key_hash+Checksum)
<span class="hljs-comment">#Base58编码做了特殊处理，与通用的base58有一些区别：转换的时候</span>
<span class="hljs-comment">#前面的0被作为单个0保留。</span>
</code></pre>
<p><img src="bitcoin-dc-validate.png" alt></p>
<p>Bitcoin 电子货币系统的核心功能是面对面（点对点）支付，就像真实货币一样，无需中间人，几乎不需要交易费。它背后的技术实现是很巧妙的通过将造币(Mint)，交易(transaction，这里提到的交易都是特指的支付)，交易验证(transaction verifiction)交织在一起，形成一个完美的圆。所以要想把它的机理理解清楚，就必须同时理解bitcoin的电子货币，交易，造币的确切含义。</p>
<p>首先从电子货币谈起。</p>
<h3 id="dian-zi-huo-bi-he-jiao-yi-dan-transaction" class="heading-control">电子货币和交易单(Transaction)<a class="heading-anchor" href="#dian-zi-huo-bi-he-jiao-yi-dan-transaction" aria-hidden="true"></a></h3>
<p>Bitcoin电子货币解决的是：</p>
<ol>
<li>任意造币的问题：通过“挖矿”机制保证了不能任意造币。</li>
<li>重复花钱的问题(Double-Spending)：利用P2P网络，通过HashCash的机制。</li>
</ol>
<p>事实上Bitcoin系统中不存在独立的电子货币，货币值是依附于交易单存在的，所以在bitcoin中的电子货币的实质就是交易单，确切的说是货币交易（Transactions）的 数字签名链，它的数字签名算法使用的是ECDSA（<a href="http://www.secg.org/collateral/sec2_final.pdf" target="_blank" rel="noopener">椭圆曲线数字签名算法</a> secp256k1曲线）进行签名的。</p>
<p>交易单的数据如下：</p>
<pre><code>In:
Previous tx: f5d8ee39a430901c91a5917b9f2dc19d6d1a0e9cea205b009ca73dd0
4470b9a6
Index: 0
scriptSig: 304502206e21798a42fae0e854281abd38bacd1aeed3ee3738d9e1446
618c4571d1090db022100e2ac980643b0b82c0e88ffdfec6b64e3e6ba35e7ba5fd
d7d5d6cc8d25c6b241501

Out:
Value: 5000000000
scriptPubKey: OP_DUP OP_HASH160 404371705fa9bd789a2fcd52d2c580b65d35
549d OP_EQUALVERIFY OP_CHECKSIG
</code></pre>
<p>交易单记录的是本次交易的收入来源(in)和支出(out)。当你支出（给）一笔钱的时候，首先在交易单中就要描述清楚你要支出(out)的钱的收入来源(in)，然后在支出(out)<br>
项中，指明要支出的金额，以及通过脚本的形式写明接收者的公钥，然后用自己的私钥签名(scriptSig)认可该笔交易，最后将交易单广播到网络。</p>
<p>收入来源(in):</p>
<ul>
<li>Previous tx: 为收入来源交易单的散列值，也就是待支付的钱是谁给你的，经常会有多个收入来源被列在交易单中</li>
<li>index: 指明是收入来源交易单中具体哪一个out，也就是Previous tx交易单中的out索引值（因为out也可以有多个）。</li>
<li>scriptSig: 拥有者对该交易的ECDSA签名认可。</li>
</ul>
<p>接收对象(out):</p>
<ul>
<li>Value: 发送的币值，以Satoshi 为单位，1BTC = 100,000,000 Satoshi</li>
<li>scriptPubKey: 接收方的公钥脚本。</li>
</ul>
<p>in与out的关系：</p>
<ul>
<li>每一笔交易，out的总额应该等于in的总额。但是，在这个交易单里，只会有out的Value，没有in的Value，而是通过in的Pervious与index，追溯到上一个交易单的某一个out，获得Value。</li>
<li>一次send bitcoin，剩下的钱，应该out给自己，否则这个钱就丢了。</li>
</ul>
<p>情况列举：</p>
<ul>
<li>我有10个BTC，是某一次交易获得的，我要送给朋友A，10个BTC。这时候，有一个in，一个out。</li>
<li>我有10个BTC，是某一次交易获得的，我要送给朋友A，5个BTC，这时候，有一个in，两个out，一个指向朋友5个BTC，一个指向我自己，得到剩下的5个BTC。</li>
<li>我有10个BTC，是以前的两次交易获得的，我要送给朋友A，10个BTC，这时候，有两个in，一个out。</li>
<li>我有10个BTC，是以前的两次交易获得的，其中一次获得了6个BTC，另一次获得了4个BTC，我要送给我的朋友7个BTC，这时候，有两个in，两个out。</li>
</ul>
<pre><code class="c++"><span class="hljs-comment">// An input of a transaction.  It contains the location of the previous</span>
<span class="hljs-comment">// transaction's output that it claims and a signature that matches the</span>
<span class="hljs-comment">// output's public key.</span>
<span class="hljs-comment">//</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CTxIn</span>
{</span>
<span class="hljs-keyword">public</span>:
    COutPoint prevout;
    CScript scriptSig;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> nSequence;
    <span class="hljs-comment">//....</span>
}

<span class="hljs-comment">//</span>
<span class="hljs-comment">// An output of a transaction.  It contains the public key that the next input</span>
<span class="hljs-comment">// must be able to sign with to claim it.</span>
<span class="hljs-comment">//</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CTxOut</span>
{</span>
<span class="hljs-keyword">public</span>:
    int64 nValue;
    CScript scriptPubKey;
    <span class="hljs-comment">//....</span>
}

<span class="hljs-comment">//</span>
<span class="hljs-comment">// The basic transaction that is broadcasted on the network and contained in</span>
<span class="hljs-comment">// blocks.  A transaction can contain multiple inputs and outputs.</span>
<span class="hljs-comment">//</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CTransaction</span>
{</span>
<span class="hljs-keyword">public</span>:
    <span class="hljs-keyword">int</span> nVersion;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;CTxIn&gt; vin;
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;CTxOut&gt; vout;
    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> nLockTime;

    <span class="hljs-comment">//....</span>
</code></pre>
<p>每一笔交易单验证追查到最后，第一笔总是“挖矿”所得，这被称为coinbase。如果是第一次“挖矿”所得，电子货币的内容用JSON格式表示如下：</p>
<pre><code class="json">{
  <span class="hljs-attr">"hash"</span>:<span class="hljs-string">"b3141455cb397e42665b90b3726c4770fd36101715618718111403bc780ceaa2"</span>,
  <span class="hljs-attr">"ver"</span>:<span class="hljs-number">1</span>,
  <span class="hljs-attr">"vin_sz"</span>:<span class="hljs-number">1</span>,
  <span class="hljs-attr">"vout_sz"</span>:<span class="hljs-number">1</span>,
  <span class="hljs-attr">"lock_time"</span>:<span class="hljs-number">0</span>,
  <span class="hljs-attr">"size"</span>:<span class="hljs-number">135</span>,
  <span class="hljs-attr">"in"</span>:[
    {
      <span class="hljs-attr">"prev_out"</span>:{
        <span class="hljs-attr">"hash"</span>:<span class="hljs-string">"0000000000000000000000000000000000000000000000000000000000000000"</span>,
        <span class="hljs-attr">"n"</span>:<span class="hljs-number">4294967295</span>
      },
      <span class="hljs-attr">"coinbase"</span>:<span class="hljs-string">"042194261a02f200"</span>
    }
  ],
  <span class="hljs-attr">"out"</span>:[
    {
      <span class="hljs-attr">"value"</span>:<span class="hljs-string">"50.01000000"</span>,
      <span class="hljs-attr">"scriptPubKey"</span>:<span class="hljs-string">"0452d1a02ffeacfc0c78fcf2ceeaf04d5416c15af1c65da13d9cdaa56844c825c1aa2f540e9439bf38a43419002d8441eea627cb56d6ed51e7848da5c3f6eee6ec OP_CHECKSIG"</span>
    }
  ]
}
</code></pre>
<p>每一笔交易都会向整个P2P网络广播该货币的交易记录。通过投票机制，来决定该支付交易是否正常。如节点认为该交易记录是正常的那么就通过CPU计算POW(Proof-of-Work),然后广播，其它节点收到这个POW可以继续投票，形成Block 链（见挖矿）。如果节点收到不一致的两个交易记录，那么只信任链最长的。如果一笔Bitcoin被支出两次的情况广播出来，那么某些节点将先看到它第一次发生的支付交易，其他节点则看到的是它第二次发生的支付交易。究竟是哪一个支付交易“赢”了，则是由恰好创建了下一个block的那个节点来决定 —— 无论是哪个节点找到了“小的散列值”， 它的block中包含的那个支付交易被判断为有效的，其他的支付交易被视为无效。</p>
<p>接下来讲讲交易单的类型和交易验证的实现细节。</p>
<h2 id="jiao-yi-de-lei-xing-yu-yan-zheng" class="heading-control">交易的类型与验证<a class="heading-anchor" href="#jiao-yi-de-lei-xing-yu-yan-zheng" aria-hidden="true"></a></h2>
<p>交易单(Transaction)目前被bitcoin分为3种：</p>
<ol>
<li>按IP地址转账(Transfer)</li>
<li>按接收地址转账(Transfer)</li>
<li>造币(Generation)</li>
</ol>
<p>通过前面对交易单的描述，我想大家应该已经知道，交易的验证是通过不断的追溯交易单来完成的。那么交易验证的细节是如何实现的，bitcoin的交易验证的实现细节是很意思的，它是通过脚本来实现验证的，这样bitcoin就实现了一个可被脚本扩展的行为，更加广义的&quot;交易&quot;，这可以保证足够的灵活性和可扩展，可以想象也许以后会有真正的分布式计算任务跑在上面作为一笔交易。因此要想讲清楚验证的细节，就不得不从脚本系统讲起了。</p>
<h3 id="jiao-ben-xi-tong" class="heading-control">脚本系统<a class="heading-anchor" href="#jiao-ben-xi-tong" aria-hidden="true"></a></h3>
<p>Bitcoin的脚本系统是使用类<a href="http://en.wikipedia.org/wiki/FORTH" target="_blank" rel="noopener">FORTH</a>语言（FORTH在嵌入式设备中是我最喜欢的一种语言）实现的，FORTH系统是面向栈的“高级机器”语言，它兼具了高级语言的特性（面向WORD）和机器语言的高性能与小尺寸，唯一的缺点就是可读性不高，基本上可以把FORTH当一种高级的机器语言吧。Bitcoin在实现上做了许多简化和特殊实现，所以只能算是类FORTH的系统。</p>
<p>在<a href="http://en.wikipedia.org/wiki/FORTH" target="_blank" rel="noopener">FORTH</a>系统中所有的命令(函数)都被称为单词（WORD），所有数据的处理都要压入数据栈上进行，所以FORTH被称为面向栈的语言。比如 1和2相加，在FORTH系统中则是 <code>1 2 ＋</code>，数字 1，2 表示将它们压入到数据栈中（在FORTH解释器执行后实际指令会有<code>OP_PUSH</code>），＋的操作则是将栈顶和次栈顶的数字取出并相加，并将结果压回数据栈。</p>
<p>Bitcoin的脚本系统的所有的操作指令（单词）见后面的附录，不是所有的操作指令都能被执行支持，因为安全上的考虑有的操作指令被禁止掉了，比如大多数的字符串操作和乘除运算。</p>
<p>在FORTH系统中一般会定义该系统是8位FORTH, 16位FORTH还是32/64位FORTH，这和数据栈的值长有关。在Bitcoin中的脚本系统使用的堆栈是用（<code>vector&lt;vector&lt;unsigned char&gt; &gt;</code>）来模拟的，它在数据栈的每一项都是以字符串的形式存放，它的数值是统一用CBigNum来运算的（读到这里应该明白为啥bitcoin会限制乘除运算了），每一次从数据栈中压入(<code>CBigNum.getvch()</code>)或者取出数值(<code>CastToBigNum(stacktop[-1])</code>)都要进行一次转换。看着这样的实现，让我有点发怵，本能的不喜欢，怎么能把高效的FORTH搞成这个样子。Bitcoin的脚本系统与FORTH一样，有两个堆栈，一个数据栈，在Bitcoin中被称为main stack,一个返回栈，在Bitcoin中被称为alt stack（事实上在Bitcoin中将alt stack作为数据栈的中转而还没有作为FORTH意义上的返回栈）. Bitcoin的脚本系统没有实现单词定义，流程跳转，循环控制（FOR, WHILE），对IF的实现非常丑陋。事实上我对Bitcoin的脚本实现不是十分认可，堆栈采用变长的数据值，直接将big number 作为opcode，导致每一次opcode执行开销无法控制，由于没有完整实现FORTH的控制指令，导致用trick的方式来实现IF指令，在bitcoin中也因此无法定义新的WORD。总之我很不喜欢bitcoin的这个脚本引擎实现(参见script.cpp)。</p>
<p>下一篇将接着介绍下和交易验证相关的几个操作符：<code>OP_DUP, OP_HASH160, OP_EQUALVERIFY , OP_CHECKSIG</code> 的功能，现在有点倦了。</p>
<pre><code class="c"><span class="hljs-keyword">enum</span> opcodetype
{
    <span class="hljs-comment">// push value</span>
    OP_0=<span class="hljs-number">0</span>,
    OP_FALSE=OP_0,
    OP_PUSHDATA1=<span class="hljs-number">76</span>,
    OP_PUSHDATA2,
    OP_PUSHDATA4,
    OP_1NEGATE,
    OP_RESERVED,
    OP_1,
    OP_TRUE=OP_1,
    OP_2,
    OP_3,
    OP_4,
    OP_5,
    OP_6,
    OP_7,
    OP_8,
    OP_9,
    OP_10,
    OP_11,
    OP_12,
    OP_13,
    OP_14,
    OP_15,
    OP_16,

    <span class="hljs-comment">// control</span>
    OP_NOP,
    OP_VER,
    OP_IF,
    OP_NOTIF,
    OP_VERIF,
    OP_VERNOTIF,
    OP_ELSE,
    OP_ENDIF,
    OP_VERIFY,
    OP_RETURN,

    <span class="hljs-comment">// stack ops</span>
    OP_TOALTSTACK,
    OP_FROMALTSTACK,
    OP_2DROP,
    OP_2DUP,
    OP_3DUP,
    OP_2OVER,
    OP_2ROT,
    OP_2SWAP,
    OP_IFDUP,
    OP_DEPTH,
    OP_DROP,
    OP_DUP,
    OP_NIP,
    OP_OVER,
    OP_PICK,
    OP_ROLL,
    OP_ROT,
    OP_SWAP,
    OP_TUCK,

    <span class="hljs-comment">// splice ops</span>
    OP_CAT,
    OP_SUBSTR,
    OP_LEFT,
    OP_RIGHT,
    OP_SIZE,

    <span class="hljs-comment">// bit logic</span>
    OP_INVERT,
    OP_AND,
    OP_OR,
    OP_XOR,
    OP_EQUAL,
    OP_EQUALVERIFY,
    OP_RESERVED1,
    OP_RESERVED2,

    <span class="hljs-comment">// numeric</span>
    OP_1ADD,
    OP_1SUB,
    OP_2MUL,
    OP_2DIV,
    OP_NEGATE,
    OP_ABS,
    OP_NOT,
    OP_0NOTEQUAL,

    OP_ADD,
    OP_SUB,
    OP_MUL,
    OP_DIV,
    OP_MOD,
    OP_LSHIFT,
    OP_RSHIFT,

    OP_BOOLAND,
    OP_BOOLOR,
    OP_NUMEQUAL,
    OP_NUMEQUALVERIFY,
    OP_NUMNOTEQUAL,
    OP_LESSTHAN,
    OP_GREATERTHAN,
    OP_LESSTHANOREQUAL,
    OP_GREATERTHANOREQUAL,
    OP_MIN,
    OP_MAX,

    OP_WITHIN,

    <span class="hljs-comment">// crypto</span>
    OP_RIPEMD160,
    OP_SHA1,
    OP_SHA256,
    OP_HASH160,
    OP_HASH256,
    OP_CODESEPARATOR,
    OP_CHECKSIG,
    OP_CHECKSIGVERIFY,
    OP_CHECKMULTISIG,
    OP_CHECKMULTISIGVERIFY,

    <span class="hljs-comment">// expansion</span>
    OP_NOP1,
    OP_NOP2,
    OP_NOP3,
    OP_NOP4,
    OP_NOP5,
    OP_NOP6,
    OP_NOP7,
    OP_NOP8,
    OP_NOP9,
    OP_NOP10,

    <span class="hljs-comment">// template matching params</span>
    OP_PUBKEYHASH = <span class="hljs-number">0xfd</span>,
    OP_PUBKEY = <span class="hljs-number">0xfe</span>,

    OP_INVALIDOPCODE = <span class="hljs-number">0xff</span>
};
</code></pre>
<h2 id="fu-lu-bitcoin-jiao-ben-xi-tong-dan-ci-lie-biao" class="heading-control">附录Bitcoin脚本系统单词列表<a class="heading-anchor" href="#fu-lu-bitcoin-jiao-ben-xi-tong-dan-ci-lie-biao" aria-hidden="true"></a></h2>
<h2 id="can-jian-httpsenbitcoinitwikiscript" class="heading-control">参见：<a href="https://en.bitcoin.it/wiki/Script" target="_blank" rel="noopener">https://en.bitcoin.it/wiki/Script</a>：<a class="heading-anchor" href="#can-jian-httpsenbitcoinitwikiscript" aria-hidden="true"></a></h2>
<h4 id="chang-liang" class="heading-control"><strong>常量</strong><a class="heading-anchor" href="#chang-liang" aria-hidden="true"></a></h4>
<h4 id="chang-liang-jiu-shi-yong-lai-ba-shu-ju-ya-ru-zhan-zhong-de-dan-ci" class="heading-control">常量就是用来把数据压入栈中的单词：<a class="heading-anchor" href="#chang-liang-jiu-shi-yong-lai-ba-shu-ju-ya-ru-zhan-zhong-de-dan-ci" aria-hidden="true"></a></h4>
<p>| 单词             | 虚拟指令(opcode) | 输入       | 输出     | Description     |<br>
| <code>OP_0, OP_FALSE</code> | 0                | Nothing.   | 0        | 压入数字0到栈中 |<br>
| N/A              | 1-75             | (special)  | data     | 将紧随 <em>opcode</em> 的data数据 opcode个字节压入到堆栈。opcode兼作数据长度指示。 |<br>
| <code>OP_PUSHDATA1</code>   | 76               | (special)  | data     | 紧随该指令的下一个字节是被压入数据大小，然后是被压入数据 |<br>
| <code>OP_PUSHDATA2</code>   | 77               | (special)  | data     | 紧随该指令的两个字节是被压入数据大小，然后是被压入数据. |<br>
| <code>OP_PUSHDATA4</code>   | 78               | (special)  | data     | 紧随该指令的4个字节是被压入数据大小，然后是被压入数据. |<br>
| <code>OP_1NEGATE</code>     | 79               | 无.        | -1       | 压入-1 |<br>
| <code>OP_1, OP_TRUE</code>  | 81               | 无.        | 1        | 压入1. |<br>
| <code>OP_2-OP_16</code>     | 82-96            | 无.        | 2-16     | 2－16被压入. |</p>
<h3 id="kong-zhi-liu" class="heading-control"><strong>控制流</strong><a class="heading-anchor" href="#kong-zhi-liu" aria-hidden="true"></a></h3>
<p>| 单词             | 虚拟指令(opcode) | 输入       | 输出     | Description     |<br>
| <code>OP_NOP</code>         | 97               | 无         | 无       | 空指令.         |<br>
| <code>OP_IF</code>          | 99               | <expression> if [statements] [else [statements]] endif | | If 判断指令，取出栈顶值，如果栈顶值为1, 则if后面的语句被执行，否则else中的语句被执行。 |<br>
| <code>OP_NOTIF</code>       | 100              | <expression> ifnot [statements] [else [statements]] endif | | Ifnot 判断指令，取出栈顶值，如果栈顶值为0, 则if后面的语句被执行，否则else中的语句被执行。 |<br>
| <code>OP_ELSE</code>        | 103              | <expression> if [statements] [else [statements]] endif | | 放置在 OP_IF 或OP_NOTIF 后的指令，当前面的条件不满足的时候执行 |<br>
| <code>OP_ENDIF</code>       | 104              | <expression> if [statements] [else [statements]] endif |  | 结束  if/else 执行块. |<br>
| <code>OP_VERIFY</code>      | 105              | True / false | Nothing / False | <strong>标记交易单无效</strong> 如果栈顶值不为真。当栈顶值为真，移除该栈顶值，否则保留该值。 |<br>
| <code>OP_RETURN</code>      | 106              | Nothing      | Nothing  | <strong>标记交易单无效</strong>. |</expression></expression></expression></expression></p>
<h3 id="dui-zhan-cao-zuo" class="heading-control"><strong>堆栈操作</strong><a class="heading-anchor" href="#dui-zhan-cao-zuo" aria-hidden="true"></a></h3>
<p>| 单词              | opcode | 输入       | 输出         | Description      |<br>
| <code>OP_TOALTSTACK</code>   | 107    | x1         | (alt)x1      | 从数据栈中弹出栈顶 数据，压入辅助栈。 |<br>
| <code>OP_FROMALTSTACK</code> | 108    | (alt)x1    | x1           | 从辅助栈弹出栈顶数据压入到数据栈  |<br>
| <code>OP_IFDUP</code>        | 115    | x          | x / x x      | 如果栈顶非0则复制栈顶  |<br>
| <code>OP_DEPTH</code>        | 116    | Nothing    | <stack size> | 获取堆栈数据个数 |<br>
| <code>OP_DROP</code>         | 117    | x          | Nothing      | 丢弃栈顶数据. |<br>
| <code>OP_DUP</code>          | 118    | x          | x x          | 复制栈顶数据. |<br>
| <code>OP_NIP</code> | 119 | x1 x2 | x2 | 丢弃次栈顶数据 |<br>
| <code>OP_OVER</code> | 120 | x1 x2 | x1 x2 x1 | 复制次栈顶数据到栈顶. |<br>
| <code>OP_PICK</code> | 121 | xn … x2 x1 x0 <n> | xn … x2 x1 x0 xn | 复制第n项数据到栈顶. |<br>
| <code>OP_ROLL</code> | 122 | xn … x2 x1 x0 <n> | … x2 x1 x0 xn | 将第n项数据移到栈顶. |<br>
| <code>OP_ROT</code> | 123 | x1 x2 x3 | x2 x3 x1 | 栈顶3项数据向左旋转. |<br>
| <code>OP_SWAP</code> | 124 | x1 x2 | x2 x1 | 栈顶2项数据交换. |<br>
| <code>OP_TUCK</code> | 125 | x1 x2 | x2 x1 x2 | 栈顶数据复制并插入到次栈顶数据前 |<br>
| <code>OP_2DROP</code> | 109 | x1 x2 | Nothing | 同 DROP，只是数据项是2项. |<br>
| <code>OP_2DUP</code> | 110 | x1 x2 | x1 x2 x1 x2 | 同 DUP，只是数据项是2项. |<br>
| <code>OP_3DUP</code>  | 111 | x1 x2 x3 | x1 x2 x3 x1 x2 x3 | 同 DUP，只是数据项是3项. |<br>
| <code>OP_2OVER</code> | 112 | x1 x2 x3 x4 | x1 x2 x3 x4 x1 x2 | 同 OVER，只是数据项是2项. |<br>
| <code>OP_2ROT</code> | 113 | x1 x2 x3 x4 x5 x6 | x3 x4 x5 x6 x1 x2 | 同 ROT，只是数据项是2项. |<br>
| <code>OP_2SWAP</code> | 114 | x1 x2 x3 x4 | x3 x4 x1 x2 | 同 SWAP，只是数据项是2项. |</n></n></stack></p>
<h3 id="zi-fu-chuan-chu-li" class="heading-control"><strong>字符串处理</strong><a class="heading-anchor" href="#zi-fu-chuan-chu-li" aria-hidden="true"></a></h3>
<p>字符串处理的大多数指令都被禁止了。</p>
<p>| 单词              | opcode | 输入       | 输出         | Description      |<br>
| <code>OP_CAT</code> | 126 | x1 x2 | out |  Concatenates two strings. [禁止] |<br>
| <code>OP_SUBSTR</code> | 127 | in begin size | out | Returns a section of a string. <em>[禁止]</em> |<br>
| <code>OP_LEFT</code> | 128 | in size | out | Keeps only characters left of the specified point in a string. <em>[禁止]</em> |<br>
| <code>OP_RIGHT</code> | 129 | in size | out | Keeps only characters right of the specified point in a string. <em>[禁止]</em> |<br>
| <code>OP_SIZE</code> | 130 | in | in size | 返回字符串长度 |</p>
<h3 id="wei-yun-suan" class="heading-control"><strong>位运算</strong><a class="heading-anchor" href="#wei-yun-suan" aria-hidden="true"></a></h3>
<p>| 单词              | opcode | 输入       | 输出         | Description      |<br>
| <code>OP_INVERT</code> | 131 | in | out | Flips all of the bits in the input. <em>[禁止]</em> |<br>
| <code>OP_AND</code> | 132 | x1 x2 | out | Boolean <em>and</em> between each bit in the inputs. <em>[禁止]</em> |<br>
| <code>OP_OR</code> | 133 | x1 x2 | out | Boolean <em>or</em> between each bit in the inputs. <em>[禁止]</em> |<br>
| <code>OP_XOR</code> | 134 | x1 x2 | out | Boolean <em>exclusive or</em> between each bit in the inputs. <em>[禁止]</em> |<br>
| <code>OP_EQUAL</code> | 135 | x1 x2 | True / false | Returns 1 if the inputs are exactly equal, 0 otherwise. |<br>
| <code>OP_EQUALVERIFY</code> | 136 | x1 x2 | True / false | Same as OP_EQUAL, but runs OP_VERIFY afterward. |</p>
<h3 id="shu-xue-yun-suan" class="heading-control"><strong>数学运算</strong><a class="heading-anchor" href="#shu-xue-yun-suan" aria-hidden="true"></a></h3>
<p>| 单词              | opcode | 输入       | 输出         | Description      |<br>
| <code>OP_1ADD</code> | 139 | in | out | 1 is added to the input. |<br>
| <code>OP_1SUB</code> | 140 | in | out | 1 is subtracted from the input. |<br>
| <code>OP_2MUL</code> | 141 | in | out | The input is multiplied by 2. <em>[禁止]</em> |<br>
| <code>OP_2DIV</code> | 142 | in | out | The input is divided by 2. <em>[禁止]</em> |<br>
| <code>OP_NEGATE</code> | 143 | in | out | The sign of the input is flipped. |<br>
| <code>OP_ABS</code> | 144 | in | out | The input is made positive. |<br>
| <code>OP_NOT</code> | 145 | in | out | If the input is 0 or 1, it is flipped. Otherwise the output will be 0. |<br>
| <code>OP_0NOTEQUAL</code> | 146 | in | out | Returns 1 if the input is 0. 0 otherwise. |<br>
| <code>OP_ADD</code> | 147 | a b | out | a is added to b. |<br>
| <code>OP_SUB</code> | 148 | a b | out | b is subtracted from a. |<br>
| <code>OP_MUL</code> | 149 | a b | out | a is multiplied by b. <em>[禁止]</em> |<br>
| <code>OP_DIV</code> | 150 | a b | out | a is divided by b. <em>[禁止]</em> |<br>
| <code>OP_MOD</code> | 151 | a b | out | Returns the remainder after dividing a by b. <em>[禁止]</em> |<br>
| <code>OP_LSHIFT</code> | 152 | a b | out | Shifts a left b bits, preserving sign. <em>[禁止]</em> |<br>
| <code>OP_RSHIFT</code> | 153 | a b | out | Shifts a right b bits, preserving sign. <em>[禁止]</em> |<br>
| <code>OP_BOOLAND</code> | 154 | a b | out | If both a and b are not 0, the output is 1. Otherwise 0. |<br>
| <code>OP_BOOLOR</code> | 155 | a b | out | If a or b is not 0, the output is 1. Otherwise 0. |<br>
| <code>OP_NUMEQUAL</code> | 156 | a b | out | Returns 1 if the numbers are equal, 0 otherwise. |<br>
| <code>OP_NUMEQUALVERIFY</code> | 157 | a b | out | Same as OP_NUMEQUAL, but runs OP_VERIFY afterward. |<br>
| <code>OP_NUMNOTEQUAL</code> | 158 | a b | out | Returns 1 if the numbers are not equal, 0 otherwise. |<br>
| <code>OP_LESSTHAN</code> | 159 | a b | out | Returns 1 if a is less than b, 0 otherwise. |<br>
| <code>OP_GREATERTHAN</code> | 160 | a b | out | Returns 1 if a is greater than b, 0 otherwise. |<br>
| <code>OP_LESSTHANOREQUAL</code> | 161 | a b | out | Returns 1 if a is less than or equal to b, 0 otherwise. |<br>
| <code>OP_GREATERTHANOREQUAL</code> | 162 | a b | out | Returns 1 if a is greater than or equal to b, 0 otherwise. |<br>
| <code>OP_MIN</code> | 163 | a b | out | Returns the smaller of a and b. |<br>
| <code>OP_MAX</code> | 164 | a b | out | Returns the larger of a and b. |<br>
| <code>OP_WITHIN</code> | 165 | x min max | out | Returns 1 if x is within the specified range (left-inclusive), 0 otherwise. |</p>
<h3 id="jia-mi-xiang-guan" class="heading-control"><strong>加密相关</strong><a class="heading-anchor" href="#jia-mi-xiang-guan" aria-hidden="true"></a></h3>
<p>| 单词              | opcode | 输入       | 输出         | Description      |<br>
| <code>OP_RIPEMD160</code>    | 166 | in | hash | The input is hashed using RIPEMD-160. |<br>
| <code>OP_SHA1</code> | 167 | in | hash | The input is hashed using SHA-1. |<br>
| <code>OP_SHA256</code> | 168 | in | hash | The input is hashed using SHA-256. |<br>
| <code>OP_HASH160</code> | 169 | in | hash | The input is hashed twice: first with SHA-256 and then with RIPEMD-160. |<br>
| <code>OP_HASH256</code> | 170 | in | hash | The input is hashed two times with SHA-256. |<br>
| <code>OP_CODESEPARATOR</code> | 171 | Nothing | Nothing | All of the signature checking words will only match signatures to the data after the most recently-executed <code>OP_CODESEPARATOR</code>. |<br>
| <a href="https://en.bitcoin.it/wiki/OP_CHECKSIG" target="_blank" rel="noopener">OP_CHECKSIG</a> | 172 | sig pubkey | True / false | The entire transaction’s outputs, inputs, and script (from the most recently-executed <code>OP_CODESEPARATOR</code> to the end) are hashed. The signature used by <code>OP_CHECKSIG</code> must be a valid signature for this hash and public key. If it is, 1 is returned, 0 otherwise. |<br>
| <code>OP_CHECKSIGVERIFY</code> | 173 | sig pubkey | True / false | Same as <code>OP_CHECKSIG</code>, but <code>OP_VERIFY</code> is executed afterward. |<br>
| <code>OP_CHECKMULTISIG</code> | 174 | sig1 sig2 … <number of signatures> pub1 pub2 <number of public keys> | True / False | For each signature and public key pair, OP_CHECKSIG is executed. If more public keys than signatures are listed, some key/sig pairs can fail. All signatures need to match a public key. If all signatures are valid, 1 is returned, 0 otherwise. |<br>
| <code>OP_CHECKMULTISIGVERIFY</code> | 175 | sig1 sig2 … <number of signatures> pub1 pub2 … <number of public keys> | True / False | Same as <code>OP_CHECKMULTISIG</code>, but <code>OP_VERIFY</code> is executed afterward. |</number></number></number></number></p>
<h3 id="wei-ci-pseudowords" class="heading-control"><strong>伪词（Pseudo-words）</strong><a class="heading-anchor" href="#wei-ci-pseudowords" aria-hidden="true"></a></h3>
<p>下列词汇用于在内部使用，在脚本系统中实际上不存在的词。</p>
<p>| 单词              | opcode  | Description      |<br>
| <code>OP_PUBKEYHASH</code> | 253 | 表示OP_HASH160 后的公开密钥散列 |<br>
| <code>OP_PUBKEY</code> | 254 | 表示一个公开密钥（可以被 <code>OP_CHECKSIG</code>）. |<br>
| <code>OP_INVALIDOPCODE</code> | 255 | |</p>
<h3 id="bao-liu-ci-reserved-words" class="heading-control"><strong>保留词（Reserved words）</strong><a class="heading-anchor" href="#bao-liu-ci-reserved-words" aria-hidden="true"></a></h3>
<p>没有被定义的opcode被保留以后使用，如果在脚本中使用这些保留词，要么被忽略，要么使得交易无效。</p>
<p>| Word | Opcode | When used… |<br>
| <code>OP_RESERVED</code> | 80 | Transaction is invalid |<br>
| <code>OP_VER</code> | 98 | Transaction is invalid |<br>
| <code>OP_VERIF</code> | 101 | Transaction is invalid |<br>
| <code>OP_VERNOTIF</code> | 102 | Transaction is invalid |<br>
| <code>OP_RESERVED1</code> | 137 | Transaction is invalid |<br>
| <code>OP_RESERVED2</code> | 138 | Transaction is invalid |<br>
| <code>OP_NOP1-OP_NOP10</code> | 176-185 | The word is ignored. |</p>
<p>Ok，接着描述交易验证的具体的过程。</p>
<h2 id="she-ji-de-jiao-ben-ming-ling-cao-zuo-fu" class="heading-control">涉及的脚本命令（操作符）<a class="heading-anchor" href="#she-ji-de-jiao-ben-ming-ling-cao-zuo-fu" aria-hidden="true"></a></h2>
<p>首先讲讲涉及到的脚本命令（操作符），描述栈顶项的变化方式如下：(n1 n2 –  )  用 &quot;–&quot;分隔操作符执行前后的栈中元素的变化，左边表示操作前，右边表示操作后。最右边的项表示栈顶元素。这里例子中，n2 表示栈顶，n1表示次栈顶，操作后n1,n2均被弹出。</p>
<ul>
<li>OP_EQUAL(n1 n2 – true/false): 判断栈顶两项是否相等的脚本命令，如果相等则压入true，否则false</li>
<li>OP_VERIFY(true/false – NOTHING/false):  如果栈顶项为true，标记改交易单为有效，否则失败，压入false并返回</li>
<li>OP_CODESEPARATOR( – ): 将当前执行PC(ProgramCount)保存到变量： pbegincodehash</li>
<li>OP_CHECKSIG(<sig> <pubkey>– true/false): 校验收入来源(in)的签名是否有效。栈顶是公开密钥(PubKey)，次栈顶是签名(Sig)。如果验证通过会压入True，否则压入False。</pubkey></sig></li>
<li><code>OP_EQUALVERIFY</code>(n1 n2 – NOTHING/false): 等于 <code>OP_EQUAL</code> <code>OP_VERIFY</code> 两个操作符的联合。</li>
</ul>
<h2 id="jiao-yi-yan-zheng" class="heading-control">交易验证<a class="heading-anchor" href="#jiao-yi-yan-zheng" aria-hidden="true"></a></h2>
<p>以最常见的接收地址交易转账为例描述交易验证的过程（SendMoneyToBitcoinAddress）</p>
<p>首先示例交易如下：</p>
<pre><code class="json">{
  "hash":"23c9e8a3140938a65c73fa0712b1d8614c8eeef486a4ab14107fcce54fbf768c",
  "ver":1,
  "vin_sz":1,
  "vout_sz":2,
  "lock_time":0,
  "size":258,
  "in":[
    {
      "prev_out":{
        "hash":"0740c9ecdef03e46e4c0f74833db5af3cb24c7d48810ef73411662252046f9c6",
        "n":0
      },
      "scriptSig":"304502204028931b310bfec094bbd04275f69beba6bf5f44ab3dbbec9564c34ef9bc1ddc022100d37c214e978808099fc96006b41244d31b203eb4b1c69be9d57b0e2f843ad93501
      0481f6d0a51bfecb5112f223807ba668c67ac975fb096d07ef65b852a6864d9e9c18c9c16e5887c3f03be519fd42cae52f6d1a05d10a2fa7c783b19e9b74be07d6"
    }
  ],
  "out":[
    {
      "value":"12.99000000",
      "scriptPubKey":"OP_DUP OP_HASH160 ef055cb1e8e192cbd8b6a89ccf1eb73552d9764b OP_EQUALVERIFY OP_CHECKSIG"
    },
    {
      "value":"17.00000000",
      "scriptPubKey":"OP_DUP OP_HASH160 923f3cdf648c1755455a17097d22f0be6add7c7c OP_EQUALVERIFY OP_CHECKSIG"
    }
  ]
}
</code></pre>
<p>ScriptSig(<sig> <pubkey>): 中有两个值，一是当前拥有者的该交易单的签名，二是拥有者的公开密钥（用来验证签名）。</pubkey></sig></p>
<pre><code>Sig: 304502204028931b310bfec094bbd04275f69beba6bf5f44ab3dbbec9564
c34ef9bc1ddc022100d37c214e978808099fc96006b41244d31b203eb4b1c69
be9d57b0e2f843ad93501

PubKey:0481f6d0a51bfecb5112f223807ba668c67ac975fb096d07ef65b852a6
864d9e9c18c9c16e5887c3f03be519fd42cae52f6d1a05d10a2fa7c783b19e9b7
4be07d6
</code></pre>
<p>脚本执行验证过程：</p>
<ul>
<li>执行 scriptSig:
<ul>
<li>压入 <sig> 和 <pubkey> : <sig> <pubkey></pubkey></sig></pubkey></sig></li>
</ul>
</li>
<li>执行 scriptPubKey:</li>
<li><code>OP_DUP</code> 复制栈顶<pubkey>: <sig> <pubkey> <pubkey></pubkey></pubkey></sig></pubkey></li>
<li><code>OP_HASH160</code> 对栈顶项做HASH160（RIPEMD-160(SHA256(<pubkey>)）散列: <sig> <pubkey> <pubkeyhasha></pubkeyhasha></pubkey></sig></pubkey></li>
<li><pubkeyhash> : 压入 <pubkeyhash></pubkeyhash></pubkeyhash></li>
<li><code>OP_EQUALVERIFY</code>: 对栈顶两个元素 <pubkeyhasha> <pubkeyhash> 做是否相等校验，如果不相等那么标记交易单无效并返回，如果等于继续： <sig> <pubkey></pubkey></sig></pubkeyhash></pubkeyhasha></li>
<li><code>OP_CHECKSIG</code>: 校验收入来源的In的签名是否有效，根据pubKey去校验签名<sig>，签名的内容为交易单的Ins, Outs和脚本(从最近一次的 <code>OP_CODESEPARATOR</code> 到脚本结束的位置)的散列。 PubKey.Verify(SignatureHash(scriptCode, nIn, Outs), Sig)</sig></li>
</ul>
<p><img src="./bitcoin-pubkey-sig.png" alt></p>
<pre><code class="c"><span class="hljs-comment">//nIn 当前的交易单的in的索引号</span>
<span class="hljs-comment">//scriptCode: 保存的当前执行的代码从OP_CODESEPARATOR（如果没有就从脚本开始） 到脚本结束。</span>
<span class="hljs-function">uint256 <span class="hljs-title">SignatureHash</span><span class="hljs-params">(CScript scriptCode, <span class="hljs-keyword">const</span> CTransaction&amp; txTo, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> nIn, <span class="hljs-keyword">int</span> nHashType)</span>
</span>{
    <span class="hljs-keyword">if</span> (nIn &gt;= txTo.vin.<span class="hljs-built_in">size</span>())
    {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"ERROR: SignatureHash() : nIn=%d out of range\n"</span>, nIn);
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }
    <span class="hljs-function">CTransaction <span class="hljs-title">txTmp</span><span class="hljs-params">(txTo)</span></span>;

    <span class="hljs-comment">// In case concatenating two scripts ends up with two codeseparators,</span>
    <span class="hljs-comment">// or an extra one at the end, this prevents all those possible incompatibilities.</span>
    scriptCode.FindAndDelete(CScript(OP_CODESEPARATOR));

    <span class="hljs-comment">// Blank out other inputs' signatures</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; txTmp.vin.<span class="hljs-built_in">size</span>(); i++)
        txTmp.vin[i].scriptSig = CScript();
    txTmp.vin[nIn].scriptSig = scriptCode;

    <span class="hljs-comment">// Blank out some of the outputs</span>
    <span class="hljs-keyword">if</span> ((nHashType &amp; <span class="hljs-number">0x1f</span>) == SIGHASH_NONE)
    {
        <span class="hljs-comment">// Wildcard payee</span>
        txTmp.vout.<span class="hljs-built_in">clear</span>();

        <span class="hljs-comment">// Let the others update at will</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; txTmp.vin.<span class="hljs-built_in">size</span>(); i++)
            <span class="hljs-keyword">if</span> (i != nIn)
                txTmp.vin[i].nSequence = <span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((nHashType &amp; <span class="hljs-number">0x1f</span>) == SIGHASH_SINGLE)
    {
        <span class="hljs-comment">// Only lockin the txout payee at same index as txin</span>
        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> nOut = nIn;
        <span class="hljs-keyword">if</span> (nOut &gt;= txTmp.vout.<span class="hljs-built_in">size</span>())
        {
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"ERROR: SignatureHash() : nOut=%d out of range\n"</span>, nOut);
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        }
        txTmp.vout.resize(nOut+<span class="hljs-number">1</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; nOut; i++)
            txTmp.vout[i].SetNull();

        <span class="hljs-comment">// Let the others update at will</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; txTmp.vin.<span class="hljs-built_in">size</span>(); i++)
            <span class="hljs-keyword">if</span> (i != nIn)
                txTmp.vin[i].nSequence = <span class="hljs-number">0</span>;
    }

    <span class="hljs-comment">// Blank out other inputs completely, not recommended for open transactions</span>
    <span class="hljs-keyword">if</span> (nHashType &amp; SIGHASH_ANYONECANPAY)
    {
        txTmp.vin[<span class="hljs-number">0</span>] = txTmp.vin[nIn];
        txTmp.vin.resize(<span class="hljs-number">1</span>);
    }

    <span class="hljs-comment">// Serialize and hash</span>
    <span class="hljs-function">CDataStream <span class="hljs-title">ss</span><span class="hljs-params">(SER_GETHASH)</span></span>;
    ss.reserve(<span class="hljs-number">10000</span>);
    ss &lt;&lt; txTmp &lt;&lt; nHashType;
    <span class="hljs-keyword">return</span> Hash(ss.<span class="hljs-built_in">begin</span>(), ss.<span class="hljs-built_in">end</span>());
}
</code></pre>
<h1 id="wa-kuang-yu-kuai-blocks" class="heading-control">挖矿与块（Blocks）<a class="heading-anchor" href="#wa-kuang-yu-kuai-blocks" aria-hidden="true"></a></h1>
<p>接下来讲的是什么是挖矿，以及交易单在P2P网络上的存放，其实这个过程也是挖矿的过程。</p>
<p>所有的交易单是以Block的形式在Bitcoin P2P网络上存放的。每一个Block包含了最近所有的有效交易单。Block中最为重要数据为：</p>
<ul>
<li>最近交易单集合</li>
<li>Nonce随机数</li>
<li>前一个块的散列值</li>
</ul>
<p>在造币的Node总在侦听网络，接收信息，然后各自将接收到的新交易打包到一个新block（CBlock Class in main.h）。在块交易单集合中的第一个交易单总是“造币单”：给创建该块的人以新的货币，节点只需要校验货币金额是否合法即可：形成一个合法的新块得到的回报是初始金额为50BTC，每产生210,000块的时候这个金额减半(大约每隔4年会发生一次)。产生合法的新块是不容易的，需要通过无数次的计算尝试得到，另外如果大家都在计算同一个新块，那么还存在竞争关系，这个时候只有最困难（Difficulty）的那个块（指整个块链的困难度值加起来最大的）才会被网络认可。另外如果块中的某笔交易size大于该块中交易单的平均size，那么该笔交易单会被收取一笔小的交易费用。</p>
<h2 id="kuai-de-shu-ju-jie-gou" class="heading-control">块的数据结构<a class="heading-anchor" href="#kuai-de-shu-ju-jie-gou" aria-hidden="true"></a></h2>
<p>块的数据结构可以分为块头（block header）和块体（block body）</p>
<h3 id="kuai-tou-block-header" class="heading-control">块头（Block Header）<a class="heading-anchor" href="#kuai-tou-block-header" aria-hidden="true"></a></h3>
<p>块头的数据是用于校验块、产生块ID（256位散列值），这个块ID也是决定块是否合法的数字。计算块ID的公式如下：</p>
<pre><code class="java">BlockID = SHA256(SHA256(Block_Header));
</code></pre>
<p>块头(Block Header)的内容如下：</p>
<ul>
<li>ver: 版本号（4字节）</li>
<li>prev_block: 前一个块的256位散列值</li>
<li>mrkl_root: 所有交易单的256位散列</li>
<li>time: 时间戳（4字节）</li>
<li>Bits: 一个紧凑格式的4字节的数字，它表示一个256位的当前目标（Target）数值，这也表示困难度（Difficulty），最后产生块的ID值必须不大于目标值才能被接受（如果有多人同时产生同一个块，那么最困难的将被接受）。这个数值会每隔2016个block(网络大约每小时创建6个块，创建2016块大约2周)调整一次，当产生前一个2016块的时间大于2周的时候，难度值将会被调低，当小于两周的时候难度值将被调高（关于Target和Difficulty详见后述）。</li>
<li>nonce: 32位随机数。节点在产生Block的时候，会增量尝试改变nonce的值，直到产生的块的散列值符合bits的要求</li>
</ul>
<h3 id="ji-suan-mu-biao-target-he-kun-nan-du-difficulty" class="heading-control">计算目标(Target)和困难度(Difficulty)<a class="heading-anchor" href="#ji-suan-mu-biao-target-he-kun-nan-du-difficulty" aria-hidden="true"></a></h3>
<h4 id="ji-suan-mu-biao-target" class="heading-control">计算目标（Target）<a class="heading-anchor" href="#ji-suan-mu-biao-target" aria-hidden="true"></a></h4>
<p>计算目标（Target）是一个256位的数值，块的散列值ID必须小于或等于该目标数值，放可被接受。块头中的BITS是一个用紧凑的4字节格式表示的目标（Target）数值，它表示一个256位的当前目标数值，方式如下：</p>
<pre><code class="java"><span class="hljs-comment">//假设BITS为：</span>
BITS = <span class="hljs-number">0x1B0406CC</span>;
<span class="hljs-comment">//那么target的数值则是：</span>
Target = <span class="hljs-number">0x0406CC</span> * <span class="hljs-number">2</span>^(<span class="hljs-number">8</span>*(<span class="hljs-number">0x1B</span>-<span class="hljs-number">3</span>))= <span class="hljs-number">0x00000000000406CC000000000000000000000000000000000000000000000000</span>;
</code></pre>
<h4 id="dang-qian-wang-luo-de-mu-biao-zhi-wei-current-target" class="heading-control">当前网络的目标值为：<a href="http://blockexplorer.com/q/hextarget" target="_blank" rel="noopener">Current target</a>。<a class="heading-anchor" href="#dang-qian-wang-luo-de-mu-biao-zhi-wei-current-target" aria-hidden="true"></a></h4>
<h4 id="kun-nan-du-difficulty" class="heading-control">困难度(Difficulty)<a class="heading-anchor" href="#kun-nan-du-difficulty" aria-hidden="true"></a></h4>
<p>困难度(<code>Difficulty</code>)表示该块ID的计算难度，值越大表示越困难，1表示最容易。</p>
<p>1困难度（<code>Difficulty</code>）的Target被定义为：</p>
<pre><code>0x1D00FFFF(BITS)
</code></pre>
<p>展开后：</p>
<pre><code>0x00FFFF * 2^(8*(0x1D - 3)) = 0x00000000FFFF0000000000000000000000000000000000000000000000000000
</code></pre>
<p>因此困难度的计算公式为：<code>1 困难度（Target） / 当前目标</code></p>
<p>我们可以在这里查看当前网络的困难度：<a href="http://blockexplorer.com/q/getdifficulty" target="_blank" rel="noopener">Current difficulty</a>（BitCoin的 getDifficulty 接口输出）。也可以通过这个网站查看困难度值的变化情况图：<a href="http://bitcoin.sipa.be/" target="_blank" rel="noopener">Graphs</a>。</p>
<h4 id="kuai-ti-block-body" class="heading-control">块体（Block Body）<a class="heading-anchor" href="#kuai-ti-block-body" aria-hidden="true"></a></h4>
<p><code>Block Body</code> 实际上就是交易单的集合。</p>
<p>你可以在这个网站上看到当前网络所有的交易单（Blocks）:  <a href="https://blockexplorer.com/" target="_blank" rel="noopener">https://blockexplorer.com/</a></p>
<p>一个具体的块的示例：</p>
<pre><code class="json">{
   //hash: 自身ID的sha256散列值
  "hash":"0000000000001470ed62a9d73c1c74a4b3754e18db0abb057be5ad5ffed659bb",
  "ver":1,
  "prev_block":"000000000000158a4051185f339d59227b776ac6bfe6120fa18293b5c08644a8",
  "mrkl_root":"c5341062635c427b79a730dca8d4a5eb6a482fa21f82cc37c84ae01ea5945fc3",
  "time":1307565484,
  "bits":438145839,
  "nonce":2323396371,
  //交易单数量
  "n_tx":6,
  "size":2193,
  "tx":[
    {
      "hash":"67dbdbc6c4a49bc3364d34aebe76b6f470ced66eb731f9d099d0da6c58e466cf",
      "ver":1,
      "vin_sz":1,
      "vout_sz":1,
      "lock_time":0,
      "size":135,
      "in":[
        {
          "prev_out":{
            "hash":"0000000000000000000000000000000000000000000000000000000000000000",
            "n":4294967295
          },
          "coinbase":"042f931d1a022301"
        }
      ],
      "out":[
        {
          "value":"50.04000000",
          "scriptPubKey":"049db428c19890bb7706bebdcf69a93c192daef8a73eb7035e2600468b4e1f83d4c2134640f6c619e5521c2050ebc9be9e9c502fdab655a570236418e5c2e95137 OP_CHECKSIG"
        }
      ]
    },
    {
      "hash":"c96eb8f874d105e24121cdc5918440c85af27b797013679796fcc26e40938ad2",
      "ver":1,
      "vin_sz":1,
      "vout_sz":2,
      "lock_time":0,
      "size":258,
      "in":[
        {
          "prev_out":{
            "hash":"c8caedb7edb2665b8543916a1e6b1dee2bf1733f75b4604c423db08efa570d65",
            "n":0
          },
          "scriptSig":"3045022100b47c10ebd2413c575510563363fe9cad7f0fdcbefca9dd219bd345bcfeff98a1022049d7037c0be3493650cb2a410a655394678e75a28b8f4cd587644813ccee383801
          041f5853d9d43b81af0999a4add012e6580db5edc7dabf99bc2aff1a01b1296e7004b73b10a9e2d3ebe0d7377c545aacc56e24aff1c9b130e0721332315e414f72"
        }
      ],
      "out":[
        {
          "value":"3.98000000",
          "scriptPubKey":"OP_DUP OP_HASH160 22718315d786b8f64510be88ad590760de676a59 OP_EQUALVERIFY OP_CHECKSIG"
        },
        {
          "value":"0.01000000",
          "scriptPubKey":"OP_DUP OP_HASH160 d52804c9bc12e7a7186e53b41784dcd2afed9a92 OP_EQUALVERIFY OP_CHECKSIG"
        }
      ]
    },
    {
      "hash":"cd74421dd3d32346bdbef02cde4bc0ed19b5cc15621f761b465a869b2f51287c",
      "ver":1,
      "vin_sz":2,
      "vout_sz":2,
      "lock_time":0,
      "size":437,
      "in":[
        {
          "prev_out":{
            "hash":"e38b71a89071be2820ce95841da03ba8bac77d536d9ac5fe5347136e9bbca104",
            "n":1
          },
          "scriptSig":"3045022100ed5c3626adf84a6d364d7b58fb182ee3bd35758a883ebe2e642e83f4103e91cd022063f61a1d89c1a30f713c2ca277c08c1c4ceb585babef82301f738fdc2312329d01
          047b4277bb4c23988986c44552156130d4155a1020ec411ca4a07904191d9054de705ec2b79a46155a0d59e8a39b5d450ac73d485b082789b6dad55d5e2230f597"
        },
        {
          "prev_out":{
            "hash":"a6fc46a5a4a6b202c644cc4854feb2d8cf7befcf695ad810346c8dfb4cc18138",
            "n":1
          },
          "scriptSig":"304402207de219304bfca0e2d93524a2547767ce5044501bb0d9107e04d35cf3d644136d02201244a1ce47c2f3aab6c205e75e433371efb01dad5073d316bf68488ea1ad064301
          04d74d74c0f2bd415a94090c83bbe10b4949c7ee8f3bb957352d02fb50f3e1ddc5ab79a28b1228eaf2986339a3735e32869019d4894f34a46645288a68900ef6a5"
        }
      ],
      "out":[
        {
          "value":"0.01000000",
          "scriptPubKey":"OP_DUP OP_HASH160 e95281e139fc37bb2aabd84028835c6513a6ac99 OP_EQUALVERIFY OP_CHECKSIG"
        },
        {
          "value":"2.01000000",
          "scriptPubKey":"OP_DUP OP_HASH160 234c6c8644008de240d90753904789868100786c OP_EQUALVERIFY OP_CHECKSIG"
        }
      ]
    },
    {
      "hash":"9d4f130995dbc1ddc5346c109992c0779aa44122195eff51dc00109afc5cad7d",
      "ver":1,
      "vin_sz":1,
      "vout_sz":2,
      "lock_time":0,
      "size":258,
      "in":[
        {
          "prev_out":{
            "hash":"d84cd74d4b470f96379fa9737c43be544e4e57f33e83fc8bf26f232ec5ea97b5",
            "n":0
          },
          "scriptSig":"3045022100d8f3bbb19b4d2593649b4f6ac0074a772ff78fce1fb60e7957c7d99d2627931802205ad4774f58af0b52e37f87592bea7bae84c883c9230e722962f2e52e7eb061e201
          04732060c3f57ccc0703e05f86f442e45617b446ebca7e9f6c96ca1ec754b9d8a9f2bd727a15c7821cbca0498c2b7f60081873a450f29c5937e9593407166dc71b"
        }
      ],
      "out":[
        {
          "value":"30.26538895",
          "scriptPubKey":"OP_DUP OP_HASH160 7fa1d78819360231c6bc1b23ff644e9124da075f OP_EQUALVERIFY OP_CHECKSIG"
        },
        {
          "value":"4.76000000",
          "scriptPubKey":"OP_DUP OP_HASH160 847f4729a1464d7a2103796cca32022fe0481d58 OP_EQUALVERIFY OP_CHECKSIG"
        }
      ]
    },
    {
      "hash":"68050dc3810310e1e5e9eb3464b1581a353de523a6f26d8b978370bd63880eb7",
      "ver":1,
      "vin_sz":4,
      "vout_sz":1,
      "lock_time":0,
      "size":766,
      "in":[
        {
          "prev_out":{
            "hash":"07a39559553efb329af1538e0fc8a037f20048a83b2278a5041975054e425c3e",
            "n":17
          },
          "scriptSig":"3046022100c3ce1ee6c222d74ff9c97d5729e5c6702c3cabdb61ea0fb3ae8632eae36f03fb0221009cea5a9f94fe14e4673fd87f75750e1d151f6e846c371d8e4af72b5d213bb5c001
          04ee9e80055248ed804ca6724b2d784c91eec04abdc4ec00b14dc01e56c90513a85453026acf90f1cb1bdd3e3ca07035be40d0b3e3ac6076b5b12bd3234ac8c20b"
        },
        {
          "prev_out":{
            "hash":"07f95bfdd09e98bf7ce0543e8fdd82f9e8532449ab7167f69aa3d1f030399b96",
            "n":0
          },
          "scriptSig":"3044022011f922460d01986255a6f5e5ce88586bb3a9a32edc836e420d2347dae9df12e1022018d9d4e48dea2b821e01d3253dfaa03af801d01e79ab4eb3ef48f22f84f196aa01
          04398f321ea6140c6ad51fea724f7c13e1df6c43afb8e4f6f9ab2385b6e18d8eae52516a0b3487512a3dbeb36109d3fcb6391fbc156518c96f57467f97dc55d0a3"
        },
        {
          "prev_out":{
            "hash":"6c93900990b712fbf2a386ba53bc3aad8f5bcdda73b855a24628d7eae80cf3f9",
            "n":0
          },
          "scriptSig":"3046022100b688feeb1012f913b6366b5b9bd5313238d00b61b48a0e3956c33d1dffc9a1f2022100ed159808e8a732e646ba5af7ed5a0d896c7db0a10757aeccc9c58a67ec42ec7501
          047e79adbe50ae668041d2b08702c12de83fdaecb866b261755cbba27fe344c6fc67f3fc2593edc0bb053b0fde62c4d42d152b6525c10bde365d80a8d2d8d77a85"
        },
        {
          "prev_out":{
            "hash":"ed416acb1373bcce28ec63e6e600e0da7f8892b557591bc0386210c56e8c034f",
            "n":1
          },
          "scriptSig":"3046022100c1ffdf383d108a9b1e8e33ed3ef8bd6b368b1ed0584ac187eb0897c90422fc5b022100f7bfb8f0b17c3b121943622a4d04a8a818391c68028b6a63d9cd2536d9f3714501
          04ee9e80055248ed804ca6724b2d784c91eec04abdc4ec00b14dc01e56c90513a85453026acf90f1cb1bdd3e3ca07035be40d0b3e3ac6076b5b12bd3234ac8c20b"
        }
      ],
      "out":[
        {
          "value":"1.69000000",
          "scriptPubKey":"OP_DUP OP_HASH160 71b9ea593ba56d1159493cb2b37a03f368fb6c40 OP_EQUALVERIFY OP_CHECKSIG"
        }
      ]
    },
    {
      "hash":"4e6e47f0fa7a559219be309db20c5c17296956304cf47dc8c52910c24b505a92",
      "ver":1,
      "vin_sz":1,
      "vout_sz":2,
      "lock_time":0,
      "size":258,
      "in":[
        {
          "prev_out":{
            "hash":"897f67e6ec0b5a64b511c2052d05f0e2437811260041bb0915f2c40879025215",
            "n":1
          },
          "scriptSig":"304502200dbe53f77f947b12dfabb737e0862c1f2d37515f6293b06c08710ccdb69419d6022100b379ab597d8d17034f1654f20e68c72930050342884743869b6421ee7eaad83801
          04bdd996cd29ca3d34604306de8983d1fadf978ae43c12c1e832ce803ae57241cd7762a40dc1e5f6176ca3b0caac622c82e271b59c66fb1f8fa8225930a8807edf"
        }
      ],
      "out":[
        {
          "value":"0.04000000",
          "scriptPubKey":"OP_DUP OP_HASH160 50e44bb02555c7084e08cda95eb43a9c621fa0ac OP_EQUALVERIFY OP_CHECKSIG"
        },
        {
          "value":"0.03000000",
          "scriptPubKey":"OP_DUP OP_HASH160 ecd8f97222481950eed4f98db82455635ccb86b4 OP_EQUALVERIFY OP_CHECKSIG"
        }
      ]
    }
  ],
  "mrkl_tree":[
    "67dbdbc6c4a49bc3364d34aebe76b6f470ced66eb731f9d099d0da6c58e466cf",
    "c96eb8f874d105e24121cdc5918440c85af27b797013679796fcc26e40938ad2",
    "cd74421dd3d32346bdbef02cde4bc0ed19b5cc15621f761b465a869b2f51287c",
    "9d4f130995dbc1ddc5346c109992c0779aa44122195eff51dc00109afc5cad7d",
    "68050dc3810310e1e5e9eb3464b1581a353de523a6f26d8b978370bd63880eb7",
    "4e6e47f0fa7a559219be309db20c5c17296956304cf47dc8c52910c24b505a92",
    "f4462bd30c529d154dc1b35d8f68961441e09ffaceaa25da17eb1814101f8ad5",
    "1961263895b63d4760f81eda7ae94848eb68e2170b79a224ba704a3c21fd6feb",
    "0427a2dbd54fa6ec034d704336fa255f6c139e6d7b9bf803714cfbc9dcc61b85",
    "42441420d09c91336e69bae9f7eb39b1c6d90562028de3094bea5f675a25a082",
    "4af79ccb4bf857df3e75a50106b15ef35aa73a209efa5089f2f2193ff70ab93d",
    "c5341062635c427b79a730dca8d4a5eb6a482fa21f82cc37c84ae01ea5945fc3"
  ]
}
</code></pre>
<p><img src="./bitcoin-logo.jpg" alt="bitcoin"><br>
趁今早，把以前零碎的分析给整理出来作为问题和展望，就算对开源Bitcoin P2P 电子货币系统内幕最后一篇的小结。</p>
<h1 id="wen-ti" class="heading-control">问题<a class="heading-anchor" href="#wen-ti" aria-hidden="true"></a></h1>
<p>Bitcoin目前存在的问题其实是非常多的，目前Bitcoin的主要成就是解决了数字货币的两个核心问题，并在线上做了验证，取得了一定的实际经验。</p>
<h2 id="yi-jing-jie-jue-de-wen-ti" class="heading-control">已经解决的问题<a class="heading-anchor" href="#yi-jing-jie-jue-de-wen-ti" aria-hidden="true"></a></h2>
<p>Bitcoin 目前较好的解决了数字货币的两个核心问题：</p>
<ul>
<li>货币伪造复制</li>
<li>货币重复花费</li>
</ul>
<h2 id="shang-wei-jie-jue-de-wen-ti" class="heading-control">尚未解决的问题<a class="heading-anchor" href="#shang-wei-jie-jue-de-wen-ti" aria-hidden="true"></a></h2>
<p>在我看来 Bitcoin 其实只是一次试水，看看方案到底是否可行，从当前的试验结果看来，方案是可行的。这已经令人非常high了，但是这个方案现在看来还是比较粗糙的，许多细节需要完善，这里只提下最严重的问题。目前随着交易量的日益增加，当下最为严重的两个问题是关于存储和流量。</p>
<h3 id="cun-chu-he-liu-liang-wen-ti" class="heading-control">存储和流量问题<a class="heading-anchor" href="#cun-chu-he-liu-liang-wen-ti" aria-hidden="true"></a></h3>
<ul>
<li>存储：目前每个节点上文件数据是684M(我记得上个月已经上G，初步猜测脚本算法终于增加了pruning算法，把存储和流量给降了下来)，但是这始终会随着交易量的增加而持续增加的。</li>
<li>流量：上个月，当连接数在115-130的时候，节点3小时内的流量大约143M。当在PC新安装Bitcoin客户端后全部获取900M交易单信息花了8小时。这个月因为算法改进，有所好转。不过一旦参与的人数越来越多，交易日益频繁，这个上限依然存在。</li>
</ul>
<p>目前Bitcoin网络上Block的总数为：137741 <a href="http://blockexplorer.com/q/getblockcount" target="_blank" rel="noopener">http://blockexplorer.com/q/getblockcount</a><br>
平均块大小为：25460 <a href="http://blockexplorer.com/q/avgblocksize" target="_blank" rel="noopener">http://blockexplorer.com/q/avgblocksize</a><br>
那么所有块的总大小为：137741*25460=3506885860(bytes)=3344.427MB =3.266GB</p>
<p>Visa组织目前平均每年大约处理28.4*1000000000(Billion)笔交易，也就是平均每秒大约处理54000笔交易(<a href="http://www.creditcards.com/credit-card-news/credit-card-industry-facts-personal-debt-statistics-1276.php" target="_blank" rel="noopener">参阅此处</a>)。而Bitcoin网络目前的最大处理能力只有每秒7笔交易。如果按照目前的处理方式，假设要每秒处理2000笔交易，那么每秒的数据流量就会达到大约1G Bytes的样子。(<a href="https://en.bitcoin.it/wiki/Scalability" target="_blank" rel="noopener">参阅此处</a>)</p>
<p>存储和流量问题的根本原因在于：目前是完全对等的P2P交易系统，对于交易并没有分布式处理机制，每一个节点都必须保持所有的历史交易单，而不是每一个节点上分担一部分。</p>
<p>这需要采用分布式处理(Map-Reduce)方式对交易进行处理，不需要所有的节点都保持所有的数据。我以为可以设定如下的分布Mapping方式：</p>
<ol>
<li>保持自己相关的交易数据：只保持自己钱包中的货币相关交易。</li>
<li>保持临近节点的交易数据：只对邻居节点服务</li>
<li>保持交换的交易数据信息：如果对方节点保存了自己的相关交易则也为对方他的交易数据</li>
<li>按远近程度决定服务对象：越远服务费高</li>
<li>按远近切分成若干小网络：形成当地BTC货币，通过兑换维持各个网络之间的流通</li>
</ol>
<h3 id="duan-wang-de-yi-wen" class="heading-control">断网的疑问<a class="heading-anchor" href="#duan-wang-de-yi-wen" aria-hidden="true"></a></h3>
<p>这是曹晓刚同学提出的，善意的说就是当海底光纤断掉后，两个网络之间没有别的连接通道的情况下的重复花费问题。很遗憾，目前的Bitcoin体系中没有解决这样的问题。问题简化描述如下：</p>
<pre><code>1A  2A
|   |
1B--2B
|   |
1C  2C
</code></pre>
<p>比如将节点1A上的钱包有25000BTC数据复制到了节点2A。<br>
1A,1B,1C和2A,2B,2C两个网络之间仅仅通过节点1B和2B连接。现在1B,2B之间的连接断了。在1A上的花费，和在2A上的花费就成了重复花费。</p>
<p>可能的解决办法：</p>
<ol>
<li>1A上得来的钱，广播验证，首先是本网络的节点做的验证居多。那么如果移到2A，并且断网，大部分验证的节点必然就不再存在。</li>
<li>实名交易</li>
<li>Bitcoin 不再是一个大网，而是按网络远近切分的若干小网，见上述的分布式处理机制方案</li>
</ol>
<p>通过兑换机制: A1B1C1产生的独立货币1，A2B2C2产生独立货币2，自由兑换。</p>
<h3 id="dun-ji-cao-zong-shi-chang-wen-ti" class="heading-control">囤积操纵市场问题<a class="heading-anchor" href="#dun-ji-cao-zong-shi-chang-wen-ti" aria-hidden="true"></a></h3>
<p>这几乎不算一个严重的问题，不过如果是限制了BTC总量（目前的算法是这样做的）。那么如果BTC被囤积操作市场，总感觉不对。如何避免被BTC囤积？另外，Bitcoin币仅仅存在于wallet.dat文件中，如果该文件丢了，那么该wallet中的所有货币也就丢了。如果足够长的时间内某一笔货币没有交易流通，那么就可以等效于失去了。</p>
<ol>
<li>也许回收长时间没有流通的BTC币是一个法子。</li>
<li>也许刺激赋予活跃度高的BTC更高的价值也是一个法子。</li>
<li>也许不应该限制BTC 总量，只需要能在网络中调控保持稳定的增加速率即可。</li>
</ol>
<p>不过，这一块也许专门研究货币金融的专家才更有资格说话。</p>
<h1 id="zhan-wang-yu-wei-lai" class="heading-control">展望与未来<a class="heading-anchor" href="#zhan-wang-yu-wei-lai" aria-hidden="true"></a></h1>
<p>目前Bitcoin进入现实货币体制并能取代之，还为之过早，不过在私下的一些特殊场合可以取得一定现实货币的地位。</p>
<p>类似Bitcoin P2P虚拟货币体系的目前最大的应用场景也许是在游戏（非实体）世界上。这样使用者的利益可以得到最大限度的保障，不用担心公司的倒闭，也不用担心公司随意增发虚拟货币。更加方便快捷，可以在任意的游戏或者非实体体系中使用。</p>
<ol>
<li>游戏（虚拟）世界的主流货币</li>
<li>分布式计算能力交换的计量单位</li>
<li>自动化的分布式的兑换体系</li>
<li>去中心化的钱包(decentralized wallet)</li>
<li>P2P的担保人（中间人）体系</li>
<li>去中心化的认证体系(Decentralized OpenID)</li>
</ol>
]]></content>
      <categories>
        <category>P2P</category>
        <category>Digital Currency</category>
      </categories>
      <tags>
        <tag>learning</tag>
        <tag>p2p</tag>
        <tag>bitcoin</tag>
        <tag>digital currency</tag>
        <tag>hashcash</tag>
        <tag>proof-of-work</tag>
        <tag>redian</tag>
      </tags>
  </entry>
  <entry>
    <title>HTML Web游戏开发之浮光掠影</title>
    <url>/article/h5-game-dev/</url>
    <content><![CDATA[<p>![](data:image/jpg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBhMSEBUUEhQVFBUVFxYZGBcYFxwdGBsWGBcWGBwXGRwXHCYfGR0kGhgVHy8hIygpLCwsFx8xNTAqNSYrLCkBCQoKDgwOGg8PGiwlHyQsLCwsLCwqLCwsLCwsLCwsLCwsLCwsLCwpLDU0LCwsLCwpLCwsLCwpLCwsLCksLCwsLP/AABEIAMwAzAMBIgACEQEDEQH/xAAcAAABBQEBAQAAAAAAAAAAAAAFAAMEBgcIAgH/xABMEAACAQIEAwUEBgcGAggHAAABAgMAEQQSITEFBkETIlFhgQcycZFCUqGxwdEUIzNicuHwJFOCkqKyFkMVJTVzg7PC0ggXNFRjdPH/xAAZAQADAQEBAAAAAAAAAAAAAAAAAgMBBAX/xAAtEQACAgICAgAFAgYDAAAAAAAAAQIRAyESMUFREyIyYaFxwQSBkdHh8CNCsf/aAAwDAQACEQMRAD8A3GlSpUAKlSpUAKlSpUAKlXl3AFzVM5s9q2CwNw0geT6iat6jp60AXQmouJ4pFGCXdQB4msD4r7XuJYwkYSMQR/WaxNvie6Pt+NU3iLq5zYzGPM31VJb79B6UAdC8R9rvDoTZp1J8FOb/AG3oHiPb5gfoLM3wj/M1hQ4vhk/Z4fN5u34Cl/xTL9CONfgl/voA2v8A+fMR2gnP+Ff/AHVIg9uUB96GYf4R+DVhv/EWMO32IPypf8R4sb/ag/KgDojC+2PAtuXT+JCKsPDecMLP+zlQ+Vxf5b1ywvNsv040P+G1SoOaYj7yFT4g0AdaxzK2xBr3XN/BOe5Y/wBhiCR9Vjf7G/A1oPAfa4NFxK2P1hqPUbj7aANPpVC4bxiKdQ0TqwPgam0AKlSpUAKlSpUAKlSpUAKlSpUAKlSpUAKhPMPM0GDiMk7hFHifsHifIUK585/g4bCWc3c3CIN2P5eJ6Vzvxni8+Pc4rHSFYQTkQdf3UH3saALRzT7WMZxF2iwQMMI3fZiPEnZB8NaozzYeAk//AFMvVj+zB+9qj4rijzWihXJGNkX72PX1r1gOF3NkXtX6n/lr8T9I0AeJ8biMRuSEHT3UA+6lg+EhzZc8zeEa6erGrhw3lJTZsQe0PRdkHwUVb8LHFEmyoo+AA/AVCeZLovHC32Z3heUsQfdhjj83uzflRvBezzEvvNl/hQCr/gpI5BdCrDa6kEX8LjrRrAxAVCWaZVYY0UDDexyR98TL8x+VesR7F5193FSetj+Va3hpABUkSXpFlyX2YscfRgeN9l3EE910l8mT/wDtV3iXKuJiBM+Da3Vo7/drXUSgUpYI2FiBVVmkI8cTkH9CjY/q5MrfVfQ38L7U+nEZ4NHBK+f4GuguaPZnhMUCcgDfWGh+YrLOYPZvi8GC0X6+LqjDUfD+VqvHLF9iPFJdEPl7nKSJw0EhVuqE7/ga2Tkv2qRYkiKa0cu2uxPlfr5ffXObYNZCezukg3jbQ38vypzD8TIOWW4I2f6Q+PiKqSOyUcEXFeqw72e+1ZoWWDGNdGsEl6fAn+rVtsE4dQym4NADlKlSoAVKlSoAVKlSoAVVfn3neLh2GMjm7HREG7N0A/PpRvjHFUw8LyyMFVASSdgAK5g5i5gbimLfEzkrhovdXy6KP3m6/wAqAIfEOIvipGxuOJYE/q4/rW2UDog6nrQaeeTEuWchVX/Ki9AB+FLFYlsTLc91FGg+iiD+vWrDwTgYkQuRaNMpRPrXNi7ef2CsckuzUrBWAwbyOI4ozkupa5sWBOhc7hbA6CtLx/L7YNsjQrFe5UIwZLXt3Tv6EdRVc4YbYqW22WIf6GNaP7RyS0P/AIn+5ajKVlI6aKzFrUzIrKVIuCLG/wDWlQIWtvU2FrnTzPyBP4Vzs6osK8IwyxoqIAqjYDYa3/GjmHY3oFg5KPYK5rjnJpnRFKgpETavkWLN2v0Nh/lU+Pn5VLwwFtaiNCA8llIuVOb63cA0+FrUQyd2TtN0OycQtUCTGNm3r5NDfTag+LLKbXrZZFIfgWXDY23nUHEuHkzNqBey9Nf6PzqvrxBhpSHETVFH0TqgTzpyDDiQZIxkk6MPx8ayviGDZG7LEizDRZfH+L863OHifQ0F5i5fjxYC5QCxAv11IFdeKbjp9EMkE9oxlJDETHKLof6zKa1b2Xe0lsNImFxL5on0hlP2I1ULjvAHw0rYaf6Jsj+HgD5fdQWB8hMMvuk7/VPRhXWch2fHIGAI2Neqyj2O8+tKpweJa80Q7rE/tI+jDxI0v6Vq9ACpUqVACpE0qDc28cXCYSWZjYIpPxsNAPMmw9aAMh9t/NzTzJw+A7kGW3+lT/uPpWWcaxA7uGi1SPQ2+lJ1b8KmjiD5ZsbIbyzMwT4tqxHwGlCcBGQC/wBInKnx3ZvQUAS4cNlyix7NWHaOFzAuNcp1Gg2360dkiCyB0YRhUz2N20LWsQLaknW21hVowHDYY2w0UhYgItolFmbtc2rad5tGNfOKcmC4/RW7VWbKYSLSgWZipG52Oo+21ccpOTteC3DjsEcGxCPI8q3AkyWUq5IyqV1yqRre9Wzj/OEWJdECOtswzkEIGdlsCWAtex8tqH8IAiRYirgopUgsUsMpOzEG/T5HYaWfl3Ch5njdVKtEwsUsp2PXe2h209aomjLK/HhT4VKigI2+Hz0/GnuK8qyyTQyI+UIe8pJtY9QBudhrRPiGCRUAZlW7Ja7W2dSfsvU5R0Wi9jOEiPWrFw4CvGHwAOo1v1G1FMPgrW6dB8a4ssGX5qj5HNZh0vtrvU6c9xfX76qPMONV3jVGF1cFhcX99U0t5t1q38VS0DHwDfbSrA4r9V+6IykrRCkw4NVOdJDjnjsMiwqw8dWI/wDd8h41bOCqTh4/h9gJA38rUBf/ALWdfHCr9jk/jSRxSUmVWToFz4M9sAb6xXGn759KZxGCYbVPx+Ic8QRbaAKnX3dR4289utOcTweJ7RQkcRDXsxcgiwF7jL5+PSu9Y3r9BHkVAQEjen4J8rAnQAg+gINF5OGg5huyi5A8SLimZeBkrvb3T9oq1asTkivc74VcYzCFDbvMAdxZVDXY6XNlOUXNzqelZZxHAFltuyi6n6y+HxFbBHgc0sJJyr2juijXVcMCQfAEkn0qncY5eEUMLIpGZMxvuHJN7g7Am49POnxy8Mlkj5RT+B8XkjdJYzabDnMv7yD3kPpf5muquUOYkxuEjmQ6OoPwPUHzBuPSuTOIRmGYOugOv5itV9iHMvZYl8IT+rmHaxeAP01H3+hqxE3ilSpUAKsX/wDiB46SkOEQ6yPdh+6trf6iPlWzO1gTXNnO/ERiOOTOdUw628u6Cx/1E0AUzmN/1iQJtEoX/Gdz86+RYxopbJbuKU1W4/fOoPW49Ki4WXNM8ra5cz+vT7SKuPLvIAlCs+IEZIB925udSDci9TySjFfMPCLk9Fn4Xypi8XHFiFxBYZSquTZgtz3fcuLXb5mpvEuGcQjRDIWkVc2ZxbMthZe8oDHbc23PpC4jyJPh+yZMVfDhgrfRABNzotxrt8ba1Lk5ixWHw8RUt38QVJkF1MDZgvdb3bZdeuprnXF+S7TrwQeH4pjJmlJLMCo7TUpYNow8O6ba9SKuPLK/2ob6gjU3HuA6f14ULwvNCSkjEYWPXM/aI+tgSAxBHW1xqd/Oqpxbj80cinD50EZuZFN7gAXOo90WN/jbpWxVeSUtGwcRVYUDMGIJC2UAm5uepAtYHrQrnXliKaKLtAbLKuzFe6Qc23Tb+VBuHc4/puDSOVgcRnvlAjuyhZNRnGQ20v1HTWjfFON9vxCLCxXOVZA5IsA+Um3eFyQFGouO9Vq5LRu0rLBBhookjAZVTuomuh07oBqDzU7xhMhUaMbsuaxFrFe8CD86g8Y4ZJJB3GASGW7gA3LJlBBvfZdb61H4nzGuLz5CpVM2XKbkqRcFhfSlaQRtsqPFMQe2gIBXSMk9DmmjJOnjWscYxavhpCjA2OU2/jUEfbWO8VLfqyc2kcNv80ZsPvq14TiZkjbKWAzXYG/U3H4fI0s210PGKk+y38tSq2EXUdwENe2mpNz5WNBBhx/002+sAt4bX+6qpwPiBjxc4uTmhZbX3Pd/nX1eeY04kkmUlVVIyb9QApt3rbXG2/zrVFCO0T+JyEcWA1/aD7Cfyq5RDOuHe1i4J9GiLEfMD5VWeKYaH9J7cyNmL5lIHdyWZ+u7FSLdKMYLiIEWEKnNkj73jmKKoB8NGNVSsRsfwuHvicSvgIvtQ1V+UeIlf0iBw8ixEt23XUqqpa+pJUkW6D1qyjGGLGYohcw/s4vsALNcknTQfh41WeS8XG+I4grG+YxWVt2UZhcjxJO3gR0p0lwkiLb+JH+Y1jeMG9oUXQOO6O0I7qg3PuAhQBa5OtV7jWMmkiUyZcuqoXkFg1/dAUHW/SiKRtI8Xet+sBsP3cLe1thfL9lV6bDxHBIDmsGxJa/992bsMviLhPW9ccY+TubK1zDw4lHFu8pJ9RoRQrl7izQtHMvvYaRXHmhNmFW/jEdsTOp/vG+0A2+RqjQRZMS0Z2Ysh+DbfhXWnaOVqmdicLxYlhR1NwyqQfIgGpdUD2K8UMvC41Y96ImI/wCAkD/Tar/WmEfHvaJz4Kfurk+XFEx4ycm5kcgHyZj+FdQ814jJhJm8I3PyU1ypiu7w8fvSfcKAB2BUCMk/SdF9Bdj91aHgiGjBU67etUzgOC7Ts08e3b5Jb8TTUHFZYsy32NvUX/CoZI8nR1YJKKtmqcvcUMzHCTKJEk0Ia9vQ9KuT8pwCJBLJdImbK7EXGawCknQ9d/Gs35P4vleN220uRuL1pfHHkjdWhDTRYoZGUKGySBbpLqNRoAQd7CxvXPFKMnZXLeqIrcl4OQELNH6ZdPk1RD7LlJzDEKSdxsCDfrr18aq2PYo+Hw7IT28ktiW1vGVQgnLmsfC5qXgcC0y4l8mQxyJGRcjaUJmTLawJ1uLGqvj5RNxk3t/gMcxcM/R8OkMoSRBdo8qrm7oAN2ABG4PpVZ5CxskmMknJIyjU3JP6xwu5JOgqxcwcOkiglu18pkF2ubjtYU0u3Ua28/HWgvJr4ePDzx5srvquYi5KiwVSLa2zE/w08Z+BZaVGq8JxnbwSoDaRLhvO4uL/ABGl6qHCuXhAZF7RArKLFmtrr4joCB8RUjg3GBh+IMpPcnCnU3GncPw0Cn50XxMbRSN2ZBuLobAizXsRe+x+407WiSdMo3EMBlYDOHyqE300Ua207p0638ql2KyixuoCZtdLmNQOp+dzUrmTizPOiM6syA5it9GLE2ORTrly/OhXFeKFpL2H6qSNb20sV3YhRfvMdSAayXVMZNXY0sBGMYAgnKTqQNMl7fE3sPOiPAIo8EjT4rCtJK8rJ31vkBUPsdLtcedq84EMeIo2VjGRCb5TY92M2vt4fMU/guIMxKOpIMrEanKtgCTbqe8QDvS2Y3Z74oysFkjjZE+itjooVkW/hqp+NqG8J4uiRSBjZyzIqi9yxCKrAbC1r3PWjDcOmmQmKJ47sNcxUMv1tTYjytTGH5EkNmmlXOvu5QSAegJbcbdKZSS7BRlLpFckxbN2hxH66Q73xEoykd0DuDKzADfMRa29ROWWVMZDmsLO1ix3BU6E2Pj4dKO8V5KxNz2bxsCSdSVOpJ8D40M4dyzi48TCXjsokBLBlZQttzrcfKs+JaZqxyT2g/JxaNG7qodG1DkaMign3Ray2+dqhy8TQmOyICgIAudRe99tNyLio3F+HuoG/vC5HgVUHr5VUOK46RcNIwYhkkYXB6bgfCuSHzHRJUE+Y5VurLltmO3mevw29Ko3MseTEBh1CmjXH8a/6SUucuRzlvcaEm/xvQvmsXELeKmu3H9JyZPqNc9g2O/WYqHpnSQf+Iv5qa2asA9hM/8A1i4+vhUb/KwX8a3+qCFf57H9gn/7qT/Y1cv8WFsFF/GfurqvmfD58LKvijj/AEmuWeLp/Yl8noAI+ziMNi8Mp1DLOPmLUN5o4f2GLkRxbMcwPhbT86kciYnJisI17frJFP8AiUGrr7X+UWKDFxjMik57bqGNwT5Zr6/vVzSlWVJ+UdEPoYB4JkEQ717DfqatHBedeyMUcmfsy6jMD7pJA1129ay7AYzKOt/srV+TuW4cVw2V3VXlcsqFybAgdLEZT4HxtU5xSezp5px0febJOz4lhOvZyYobeLQG/n73nRbBOwXHgCwGRx017bN8elBeLmaZcLO62bBCaLEi4DhwYQrBfea6gHS9t9qmYgYlpcVHCFJxGHWdCAS2UyEqhBIsxBzE3tpprRxb6EUku/8AeiTzTOzwzgd4kzAKBuwxGGPmT1OnQGqBhsayRkEZWzBs2t7kWIFztoCfjVxxckOFY4md/wBJl1ZI81kBdbMNTcnMPoaX66aVHEfr27SMCOy5jHrl2YnUkkjTz3rarZLJtpFgfGyYoxHLZ4SfpAA7ePw6X+FWGPmadVRGw+itlV86m+Y3CW3tvqahYTnNJsLIhjCyxKMzZVAbL9LTbbUU3jOYk/QoyjLmGJhYjrpmv/XlSLJkbonJKuzxx/irGQsYo1yNDdge9ZnFrWtcaW11q6cD5USXDymT3piSdSRtlBNzfpf0qjSH9Mx80ZUlWEFjqAAgVr6b3Jt861DCQ5Y8hYg30IGm2gB9d/IVSMW5U30ItmWnjE+DYQyg9yRQrbWCBcygjUhsqeg+NFDzFAjrlbqfe2uywrrbwNz86f8AaHwQFWmC6xq5A88pGumviPMVncPA8Q0sMaxM7yWlyqCW7M5LNa2wANEfT8GbRqMUU6RxyRylQ6I1n90swDEa6XN+tjbY6Um5qaMkYiIrb6S/ZofLXe/gDRNcUU/RcKyWLYVnIO4MYiTKRb940zxHCZAbAMgDHIwuuiM3dPvJ7o90j4Gm42Xjka6HMNxGKUkI4LDddmB81NiPlTOOx8cfvuq6E6nWw8hrVem4ZFKSVPYuCbK3u5gZE7rWy+9G9r5WOXSgPEuETCQhiC2u4a5I2+nrWcCvx3Qdx/OcQuI1Lm3wHl52qu8R4m2IUho4ghOxRTt1NwdfwpluHS3IDC+mmXXz0zUy2Elto62F72C6eHXSqKKROWSUvII47gfemJuwDDpbUHoKCcxn9Rh/gaN8ejdYGLOCLAaBfe8LigXMptHh1/cv8zVIkJF+9hH/AGkP/wBM/wDmpXQ1YD7B8P8A29z9TDRr/mbN/wCmt+phRjHJeNh4qfurlzj2CKxzx9Udvsb8q6pZbi1YD7Q+F9njphbuyAN8xY/aKAMw4ZPlTNe3ZyI3odDW3cs80BY+znAkR1I11DAi1iDp4+VYbgorSPEfpBl9RqPtFXrlufPhlN9RoR1uNL/ZXPnjaTOr+HadxZ75g5FgjlLRGQRsbquhy/u36gdL9KL8C5lOGw/YrGroGzC7EG9rHbyqTJjhJA8bDvjUaaaHe/TSq9JC3pUbbXzHSoJdB+Tjk08maJF7WQohQe64RXcMxa5DhVIz3Gm+lW/EY1mgWae8mHUAsI9JItR3JIzbPlOl+lZpgDldQSRmZ1BB1DPh5kUi377LWu8wYhI4I8RKBKuSMd0XZidb6m1tjZbEkamwp4rZHI+PRj/G+PdtNIxUFQuSMZbFVJPfF73JGpvtp4VJ4DwNTCZcR+rjbQDqygCwHiNx5W8Kb4jjFkxTuyKAxvYIFOXYGy+62W23W9LE4ntQEubKtk2so00sNfifOtk710crfllrk4HhF4ZiJYgE/VNt1bLoLnXc1XePlBw3CFBZnclyo0DLnUXsL3J1p5i68JnDmw0VbbsS6AnxygdfH1qTyNhZpwqrfKjk+N9QfXx9ai1x33s2W614Ldynwp8gdwGLLc5r20A6nTTwPjVmxc+VdQgY90lLbX006eOvw62qfw/AhFK2Fv63+2vUkYBGgFj4X1Nhe5+H2V0Yo8I0BW+IEyq1xl3JBSygb5tNfHpfb41RuAYgwcfjzkleycX1Nk7M233AIArWZsMLWsMut1I7t/HXrVK5swJDCVFykb26/D0APjS5Pk/5EjGiZi8T23MSRhrqmCfbYFmQ+uljRfjWHIVr/Vf/AMp6yrljjVuYUd9FKyKfIdgSD8Li/rWs4xJ3xoQoGwjQNdri4lzAW8dUOh8j41VfMrMiysYWNXNt8syhvI9tjG+5hVO5x4Sg41hFC9zJESvQm7XNvO1WXlSzYnHlGDoMYtiDfaOQ306aihvOI/67wv8A3afe9Ay2zOuE4MHE44nXLHireRVrAj0qJwnCg8NxZ+kGgsetiRcfbRngy/r+Iaf8vGf7jTsnA2wmDxkTlWNsK9xtZgPH1pgK5iYwMDhbAZnaS/ie8NfstTHNJvOqD6CIvrbWnOEt2smHQ+7CrMf8xY/ZaoQn7XFNIdszOfguv5UyEZtvsG4dripumdYx8I0/NjWx1RvY7wow8LizDvSXlPxkJb7iKvNaYKsz9r/Brokyj3SQ38LW/G3zrTKHcf4YuIw7xsL5lIoA5G47EUmEg66/4hvRzljGBMQV2WYZ1+P0hXrmng7K0kTDvKTb+Jd/mNarnD5SVyj9pGc6fitLJWqHhLjKzUWQBr9NvSoGJw9iddfC+tSuXuJLPCrDe2vxHSjY4GuJkVWIX969rDz8fhXG9dnp9q0VUYAywzEXzRr2iEbgqQfzqfytxSLGxdjj5prwG8ZUjVW6Nfex2P7xq7pyTg4rhcVKMy5Se4RY720vQKH2YYaGQvFxEAWIIeMHTfcMPAVvKNNWQn81adHnFcB4e7lmxmIzEWuYgdALAab2F9fOvDcqYN3HZYzLYAFXhbYX8xubfKnDyrB04jCfIxsP/VXiLkRpG/V4zDt6v8tqW/ub8OH3Cb+zWWQZxiYJAFsAUYKPAe81hv0qy8s8tDDrleNBbTKB3f4hawNz6155Y4FNhrrK6OGUglb7HxDAUV4ZjFljWzAvGQhuTY2vY3G+l+tLjqcqfg58kFHaJ+HxGY6mx8Mvhv01/nTk1tLbX8Ta/obGmMOyGxJIC3BuSNdPP4V5xOMXUC17jQ/P+ddzJIdxRGXVrePW332oZiHEqMrWbSwNhe9hqPhpU0yI6Gxtv5a/mNqhTe9pm3XXW2p6G/e1O1Y0mqZhlnFOCLhuIDEHMDqAO7lDFct9P3elX3g/H1WMXNkA7p3KEC+Rv3DbTw09BnMPDVkBa97+WunWqdNjmhhnQXv2bgW8CP6NefHJLHOmAd9jGKDRY9iQbzKSAOhj6AdN7VF4/M8uLXECF80eiaG1hffTXehHsK4yqTYmJzYSCIqelwWWx8L3Fvh5itfxOHD+R8fzr0kjE6MTw0EizTmPDSlnDI/vEWkAY6W7u9NcbmmSCXtopAjpGrl7juxiyAGw12+NadHwxMPI7hMrPfM1yc92Zrm5tux26VlvtG462LxKYSI3AILnz8PgBr8vCmcV4NsqmEfssLJKdGlORP4fpEelhXvlLgpxEscI3ncJ8Ix3nPyFqjcanEkqxRapHZF8z1b1Na57DOVg0j4sjuxjsovPrI4+LaehoFNnwGHEcaqBYBQLfAVIpUqAFSpUqAMk9sHKZt+kxDb3vwb8PWsN4jEUcSppc6jwYbiuxcfglljZHAIYEEGubPaDyk2BxDBgTBJsfDwPxH2igADwbi/YSCVNI5D3h9V/yNaDguN3Fww1rJheByrd6Nt/Aqeoo/wLirQMFzXRvcfy+r5GpThey+PK46LxjOJHoQaF4riZG4I8dfuotBEuIHfIa+zD3x5i3TyNNzcl94qxJ1tv8vs1qK4+To+LJ9Ir0nEiRa4F/P8AlTWB4m8bjvafxWt50d/4NA+sRUKXltQeulM+Jiys1HgfHCcOpzXMTKd9SjHKy/DUH0o/hMNHmbs7BcxIytprYlrHr8Kyrg0E5BjVssTWDkqL2BDZR8bVoSMYIlCOjgjbKAbelRxtQbtizjz6QXllBBD+ZB1y2vpbxO2mtfERiQCFsQSW8TvtfTS/zqvtjzI652ygeH9b0WXFQ5TqxUC9tbDXQ+PTpVY5YyeiUsTj2SXwTXBbKFvcC9jexF7/AAJ8N6+NgCQ21tLbXOmug9K8txZFsWsbgDXwJ19aa4hxCMJ3GINtPIba220v8qopExhsMZWIJYa+diLEXsPPp0rPecZsPCbOBOxbLkjly73BvZTt8evlV15ixBXh5ZWCuygMUZgQD4AncjTa41rLuL8OMUWWO5zsly1rqcsnj0GepTULUmhdhvkHDYSB5BLFHhs4jKZ5ixcXJALEhdLbAW8b6UF5n5oxsQ7SKclXcBUZFIAsSADbawPjfxoomDwuIllE6OUQBk7+VQLa7dNdOmgvQnn7C4bCQqiTGQEqyRt76jK4Nz1Gw+dUjNyScTAFxLnbHBAWxC2kAOQKLkkeJubC9txQcscNCWY/2iceqodyfNq84OEIoxGIGg0ijP0iNj/CPtqEuaeRpJLkX1tuSdkUeJ2tVwCHKvAXxE0caftJjlU/VT6ch+AuB511dy3wRMJho4YxZUUKPTqfPr61SvZJyGcLF+kTqBPKB3f7tB7sY+8+fwrSaAFSpUqAFSpUqAFQTmvleLGwNHIL3Gh6g9CKN18Zrb0Acm80csyYKY4bEjuEkxSdB/Ly6UCSRoSUkGZD/QZTXTvOuGwGMiaHEOl+mozK3iPA1hGO5KmjlMGZJo7XicN3jrbKo3LfujfpegD1wLj7w2sc6HY/gfA/ZWlYHjvbCOQLZFGWRiRcHJoqi/eOnppWTwcqTROAs8Nmyk3LZQjYhsPmbubB1N7XNjex1saw/BpkTMXjWxsVzNdTnMY+j1NiNT3WBqE8UZbL48kodGow8XvqpyC+wH3/AM6mFoMRZZgt/ouBZgfA295fj51nMUs6MUZoiVUsTdhZVBYk2Xoqkm/QXr1jeMNFqcjBrFWRjlIuAcrKQD7wvfUda55YpWPyVGkvgAndsBbTpTUkAtuKrHMmMmiVChOYyxpcs5WzKbmxsRsLfK+lEOGuwkRMRlYSAqrI0i/rOgN2O4vrsTYdalL+HknTaLxzJxuifh0sxH86I4PB5m7pG+oNtienn5VUeNcWeKaKOCNAHDAyM8hOYEgAC4HQnrrRTFcwyQRLDEoxGIIGY7AE/Sb1vpR8KcJqnsx5Yzi7DvFEWCE5yN2JY2Gm+g16VVjjpMQjTRrEIFbJ2uYgsy290HRiLkG3gaF8XR2SVuIWl7NFawkcFnZlRY7XABZr200vXzCTSooWZo1EaraJCQqgjMQL9dRV80XCLkzjTXRHx3NeWU4fESukVwQwUMouLXIFiBqRufhTRiyBkZg8R1WUG8baX0bYG1jY671WuZeN4VpGucwK2spubhs333oHhJsVIjJEzRQG98zWUD4n52FasXxMaT0xL2GcXzeIYpYlGd5FMY1+gb31G386CPCE/X4w5nP7OHy6XH0VHhTRxsOG0h/Wy/3rDuj+AH7zUOPDPK2eUscx0G7ufBR+NdMIKCpGCmlfEuXkNlG56KOiqPuFbP7KPZiSUxWJTKq6wxNuP/yv<ins>eg6U17N/ZugZJ8YAMtjHANVQ/Wf6z/AHfds0WKjAsCBTgSVWwsK+15EgPWvVACpUqVACpE0qGY+VqAJkuNRdzVV5m5gukuX9nFGzvY2JNmIW4NxfK2vlTWPlbWqxiMRZpY5NEnTLfzAcWv5q7eoFcn8bKccEnDv7evP4K4UnNJkDA4hJIEkmZmdgH7ruijN3soSNgoAvbahkCGfHRxuxaOUFGGxNhMwN1IN8uRbm9+94ih5ilhURyKe4MqsASrAaAggb2GoOoNO8uu68Rw+ZWW3aPqCDlEMvesdQNDqd6TKsTxOeOrp0130Ui8inxl76YzwWOObHvhplOXPKsR7WYkSIzst7yG5N5DfTUnq1V/DvN+m9gZHRlkKvGZJOyyi+Zrh7hQoLk32F6WPxEiYqSRLhlnaRT+8JMyn5gUb52xMRvjIyM+MhVALagG3asL+6co7Lx7xHjUlyhOO21ONdvUl/df+DP5k/s/we+XsWMR+mOUdVghaaG8subulimY9obnQHS2tQ+VJUxcOLeWMM2HhMiXZ7A62X3/AHRYafbTfs9zrDjx3rNhygvcjM2bQeZHSnOQmK4fiIMZRjh1S1jqWz6W3ufDyqWa4/FSb1xrb/mbC3x0t34CvNGJkbCRSO13WVG93Le4bcAnTSw1Gg9T949jZMOcIIs3fiilY5mLAgqe6Se6B4CpnO2BccMAYAEGG1s1yWGQLt71yPDRT6g+foZpGwaQhzIsESWW981l7vxudq6szTy40nq3f9BMfJQl/vkt2GwcmORMRM0IS7vcIwMaLIcwZhIoV9L7Eag7XqsQc7tDNK2Fw2eMnukk3NrjOSb7726CjHDeGSdnHw5Gd1bNNi5tcraLeGNrWI0UWvqAT9KwrXFeW5YseIrsILPM6pc2w6ZjqLaZspUDqdOouuGa5vLelpbe/b/t9t+QmnXBrf6fgLccmnxHDzOGAlimjknQG6qGS8V7nXKr3PgWYWuKD4HEriMRBDOEkaVo0lYu+ZnZipyhGC2C5BqPGiPJ3HInxUqGOUHGqwkDyq4uczDurCp1Jy3J0DeVAOX+C9hxfDqcxy4hctlNioYENfa1rfCpqc25wyN39S37XWvT/YakkpRS9M88cbDYbGYiDsI1EfaKj98tmyXS92y+8QDptRTimFR+HYOVYVMmJd492sCGdVyAtYE2XU0E5zxB/wCkMQwjBLvcMwJ0KrsNjVknxbx8O4YzqxMM5lYZdcvaym9um2npWPkseGVu3V7e/lf7m/8Aaapavx9wLxvhUWCxH6MkSTSIFMskmYrnYBssagiygEam5PlRrBYKP9FfGwoI5YWCSqLlbG1mTMbqNdRfoai894VmxbYmPvwzBWV11GwFieh23+8GzuGxRw3DJ0cESYt1EaH3uzW15CDqFN2t42BGlCnKeHHki3ybje/f1Kv6/pRjXGbi1rf+C3YPiMnZCaBizRJEZ4b3NpYY5Q6Dce81h1CnqKg4vmmVyWik3fDKp3yiUzBjvY+4tvWgOExk2HxwkjuGEGEBU3AZP0aAMh08vQgHpRTi+FhymaC6iefDXjt7ro0xfyHvi48dRoayE543GE23GTVP073F/mvto1pSuSW0tr9zVOHcXuo1vpRfD8RNZ/wlXsKtvDo2I1r1jjLFFir1IBodh4jU9RpQB6ry8YO4r1SoAgYjg6N5UIx3KCuCNCDVmpUAZpivZoQSUaVL6WSRwLeAs2npQWf2YZb5QwJ3ILAm3ib3PrWy0qVQivA3J+zB8R7PXHRj8ST99C8TyJJpobC9t9Lm5t4a610SYlO4Hyrw2CQ7qPlW0jLObG5TnQWUuovewJAvprp8B8qiScCxANzIwAa7FpMu+5OZhmJA8zpXTLcJiO6LUHG8nYSW3aQo1tris4r0HJ+zE+ZcCjjLhWiDGRGVxLlK2Lb5iAv0Df7rCqkeBYgMQXbMp17waxtfcXB0Pj1ro0+zrh//ANunyFSIeS8IossQA8qOK9G8n7OccFgcRFLHIxeVUZWMbE5WAOqm1tCLirJzi0aoqYaMJLMQ2dJCSsQs66D3SQyG4INriwubbYeUMN9So0PIeDVywiAJ3P8AQo4R9Byfs5yg5enBLKzhmFmIJBI0NiRvqAalJwLE/wB5Ltb3m2ve2+17G1dIDlTDf3de15aw4/5Yo4r0Zyfs5xPKsz2zl2ttmJNvhfapycpTte7ykHcF2sfIi+tdCrwKAf8ALWnV4ZENkX5UcV6DkzBcByVMvuNKn8Dsuvj3SKJYT2cMTmKsWO7Ekt8bnWtuXDKNlHyr2FHhRxV3QWzKeHezMg3IYnX3mJtfe2Ym17CjcHs2jzBmGoN9za/jbYn41fKVbSC2B8Jy6iURjwiin6VaYfAK+0qVAH//2Q==)![](data:image/jpg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBhISERUUEBQUFRQVFBcWFBQWGBUVFxYcFBQXFxcUGBUXHCYfGBojGRUWHy8gIycpLSwtFh4xNTAqNSYrLCkBCQoKDgwOGg8PGi4kHyQtLDAvLDUsKS0tLC8pLCosKSkpKTUpLCoqKSwpLSksLSwqLCksKiwpLCwsLCosNC8tLP/AABEIAMwAzAMBIgACEQEDEQH/xAAcAAACAgMBAQAAAAAAAAAAAAAABgUHAQMEAgj/xABDEAACAQIDBQUFBQYDCAMAAAABAgMAEQQFIQYSMUFRE2FxgZEHIjKhsSNCUnLBFGKCotHhc5LwFTNDY7LC0vFEU1T/xAAbAQEAAgMBAQAAAAAAAAAAAAAAAQIDBAUGB//EADQRAAEEAAMFBwQBAwUAAAAAAAEAAgMRBCExBRJBUWETcZGxwdHwIjKBoeEGFPEkM0JSkv/aAAwDAQACEQMRAD8AvGiiiiIooooiKKKKIiiiiiIooooiKKKKIiiiiiIooooiKKKKIiiiiiIooooiKKKKIiiiiiIorXJKACTyF/SufLszjniSWFg0bqGVhzB+h7qjeF1xU1xXZRWAazUqEUUUURFY3q1ySWpGz7aCSbGw4WIskRkPayKbFzEFd41I4AArfvaqudSkC0+g1mtEUt63CrKFmiiiiIooooiKKKKIsE0XrVLJalDLs/eHGSYeUloy/wBk513TICwQnodbeFVc6iFIFp1vRWqOS9basoRRRRREUVgmuXMczjgieWZgkcalnY8gKIuuitGFxSyIrp8LqGXlowBGh4aGt9EXHiZLVVWzeaPleIxEUrE4P9pIN/8A4xmO/DJ/guG3Sfush61aWNXSq323g7JxiSoaMr2GKUi4aJz7rkc9xz6O1YZG5g/PnoSrtPBWdh8QCNK6AaqHZPa/9ikXDYhycMxth5mNzETwgkb8P4W8jVrYfEAirtdeR1VSF01g0A1h6uoUZmuM3EZvwqT6C9IG/wBn/s2Y9ZBIf3sUN8sfFqctoFLRuo5ow9QRVew4lZsIkbG32agHmrILA+IIqhFn585KboK08FJcVIA0j7GbR9qvZym00ejj8Q5OOoNMWPz+GBbyuq9AeJ8FGp8qteSUpbeovSBm230hRjh03FA+OX4j+WPl/F6U0bP4l2w8RlYs5RSxPMkXP1paUpisXrzvVxZjiCI33DZt07p77aUcaBKAWaXfegmkrLtuG3VOITQj449QPzLxHlTHhM5jlXejdWHcfqOVVDwcvnzuSl7xslhSPjPtI8fIOKmPsz+9hxvXHmbVM7UZ72a7qayPog+rHuFLGKxQiwjoDf3GufxM3E+ZNMnHoE0Cf8oxm+it+JQfUA1LA0t7OLuxRr0RR6KBTGlS37RaHVeqwTQTWmaYAVZQsYicAXJtVN7d5vJmkkMEDFcK+JWJSOOIZDeaQf8AKjUWvzZhUntXtX+2u2Gw7lcOptiJlNjJbjDGen4m8hXPsXCMRiDiVULBCn7PhFGihQftJFHQnQdwqhzVhkrTwZAAC6AAADuGgHpXYK4MEulSAq6qtM8dxS1nOBDKysAVYEMDwIIsQfKmthUdjsNcVBF5FF875/h2wchw8vvREExM2oZOG4b8WXQHyPOpvYX2pnCEQYpi+H4JIbs8P7rc2Tv4jvpu222VTFQtG2jDWN+aNyPhyI6V8+ZlhJsPK0UoKuhsR9CDzB4g1jA/4nXgfn7V+oX2Ll+ZJKivGwZWF1ZSCCDzBFdhNfJmx+32LwDfYvvRk+9E+qHw/Ce8VdOzntqwU4AnJw78w+qeTj9bVbeI+757KKvROWappVM5nKcNPJEdBvFk/K5v8jcVdMsqyKGUggi4I1BB4EGknaXZmKchpFuwFgQSD8qnkQo6JGGakMrqxR11VhobH6ityZoN7eJLMeLMd5vU1q2vyMYdgUJ3QEjseIKoANefConLsK8rBYwSTUb7A3fOSnccXbgU/Jj+0AQfeYD5045vtl2K9lAftLAFuSDh5tb0rzs77O41AbEkluO6Da3iR+nrTdh8qw0YskMY/hBPmTxrRfjAT9OQ6+3+FsCEN1Nnp7rzFtNhyB9tFew/4iX4eNQeB2uE28jWDqSB0cAnUUxPhYDoYo/8i/0qMxmzWFfURhGHBk90jv6VhfjDd5eJVxCw5Zj9pDlx3ZsyfhdgPC9x9a0f7Ss28pKt+JTY+fXzru2k2SkQmRG7Qc78dBbX040nySEGx0Nb2GnjmZu8QMwteaJ0ZvhzU</ins>bEsXdiznQseg5DoKMPOZ5UiGoLAt+VTc/QVpyDKBPFIWJsrra3HUEN5fDTds9s7HE28im5FiSSfrWawQWtHRUqqJTflKaVNg6VFYdgi3JAAFyToBbnSptB7XMHACImM78gnw+bnT0vViQFFJ2xuPSNSzsFVRcsTYAdSapvbX2knFEw4ZikHB5Bo8vVV/CvfxNJ21m3WJxzfatuxg3WJdFHj+I95pdhMkjqkd2ZjZQOdRrqncm3Bs+JdcLh/dDD32HCOP7x8TwHjVy7P5WsSJHGLKihVHcKWdhdkhhYrHWRrGR+p/CO4VYmAwthUjmh5Lsw8dhXRXlRXqpUIrXIl62UURQeY4G4NVh7QdhRi0utlmQHcbqOO43cevI+dXLNFeoPMsuvVXNtSDS+TEwLiUxPZHBI3X933h90k6C/InTv517sVJVgQwNiCLEEcQQeFXBt/sCMSpeMBZ1HutwDgfcb9DyqpJpXVjFiVIeP3bn40t90/jXp05G2hoHOuj86j2U0KTzsF7S5MHaKe8mH5c2j716juq2sLnMGKCtDIrg9Dr1sRxFfN0uEdAGOqN8LrqrdwPI/umxHSn72NYPfxckh4Rx2HjIwH0Bqr3AMLmlXjG88ArO3Ge9viTFGNEkI/M17eg4U6bE5OsCBiPfPOq7ySDtcwlJ4LLIfPtGAq1MGbAAca83trGOi3YWd5XUwcQLTIePkpz9so/a64f2WW1wDbrum3rWv9oZfiW/h/SvNPxE41W12beCkDiTXk4k1G/7T3tEFz9PE1lY5W4m3gCfnVBLO40pDAuyWe41pD2tyXi6Cx42HPrTnZl461pzHCh0PhWbDY2XDzB16KXRsc0tOhSd7OcbeSaI8DEX8CrKD/1D0p9jzeCKPtHkRVte5I+XWq92Mg7LNGTkY3I8PdP1FKO02G7HFTRckkbdHcTvL/KRX0OKQPNs0IBXCkZuNp3AkJm259o7YoGHD3SD7x4NJ49F7qRERnYKguTy+pJOgA6nQV7XDMV3z7sd7b54E/hUfePcOHO1aWxTN9lCD7xAIGryHkGPT90aDv41murDfH39vJYNdVpmQ7+4h3zew3bnePd11q1dgNiOwHaSgGZh/kH4R39TWnYbYTsbSzC8p4DiEvyHf31aOWZda1WGaaLfluBtU3Elq8Qw2rcKsoWaKKKIiiiiiLBFaZob1vrBFES7mOW3qt9uNgkxS3HuSqPde3H91uo+lXJLDeofH5bflUEWpBpfLUeIxOAlaN1AvpJFIA8Uo5XU6MOjCxHIirh9kkmElimbCo0Dl07WN230B3W3ezc+9u/Fo1yOtS2cbNxOQZI0crqpZQbeF66MhwnZ74AsDawAt15VzsWxoG8TRPXX8cfMLZwwt4r/AAlHIdjsVhp8Q88RCtMxVwQylSzEG6k2+LgbGn3Z7ChpUDc7tbuX+5HrUbh1bDYyQKXUTlZCDcrvMNw+4funcvprcnwpnwjxrJ2gA3gpUgHhvEG9uugrymLni/v2um+2xeXL0XRt0cW4OWSnjEDyrgx2Tq/Dj8/Wu6DEK4upv+njWyvaujhxMedOaVyGvfGcsku4LZ03u2mvT525mpeLK415X8f6cK66KxYfAwYcUxqySYmR+pUdmmWq0Z3VAYC4IFuHLzpR37XU+XnTzicUqD3j4DmaWsQY4/fstybAtyvroOflXk/6i7ETM3SN46gfolbmEkcGkH8JTy3Zmc5gk4jIjEcgLkhRcgBeOp4ngOVLPtImwWHxjOyHEYho0O411w6WBAZ7e9IbAe7cDTXjT9g5nmxLas1ojxP7y8BwHgOnOo7NMGHma4B0HEA8u+uvs4GWNgs1Va1efPXwTFA7pJ5+ipGXET4yYDWR20VQAFUdFUWVFHdYVZ+xewi4ezvZ5iNW5L+6v9aYcq2ZiRi0caKzfEVABNNmX5bblXeayhVUBwXNtastyy1qnoILVmGC1bwKyKqAKzRRREUUUURFFFFERRRRREVomTSt9aZ+FESL7QMY8OHLRHdbeUXsDxPQ0t+zLPJ5p8b27luzkjVAbAKLS8ANNbDXnap/2jR72Ffus3owv8qQPZ1mYjzPEwtoMQiyJ3lV3rf5Xb0rkTsBnc6swMvEfyu5EG/2cZH/AHcD/wCRV/tWLmB38dF/hj+VpCKldlLNLimIBG+iDwUN/aoXCyBscTe+5Fr3EAm381SmxTfZSNzaZvkq/qTXEwlP2k5xzoeariBTN0dPNT0mXgHeiYo3qp7iK6YMUeDizd2qnwP6HWtXa1jtK9FHEyI3F9PMcPDh+K62uebcKdmuztK558Sx0jAvzY/CP/I9wrx2tY7Ssz3FwoGvNVDKzpeYMuUHecl25k8PIVDbYRDc3hyKH57v61OdrUTtKN6B+4X9CDXC2rhomYQ9m2qc09TnWZ1OvFbERd2gJS7s7Nad/wDD/wC4VXPtF2znwuZSKm4ybqMFI1F1194WPHrfjTzluI7OXeYEIwCb/wB1WJuoY8r2IB61SntCzIYjMsQy6gP2a9/ZgJceJBPnWTZTGyRhjxYA9VsYwljQ4cVdfs/zx55GD2CiKN1GpsXVSRcnv7qsrDppVTezaDdkltwUJH/kFv0q2MIdK62B/wBpYtqxtjxG60Vk2+/dF/tdIFZoordXMRRRRREUUUURYJrG/XBmsIkjeNiQHUqSpIIvzBHA0j5PmmYxl4TLDO8R1SbejdkPwSJKtwwPDUCxFulYnSbpqlmjh7QGjmOCsjeovSQdtsSn+9wM3jGySj1U14PtKW9jhcVf8lVOIjGvkfZbA2diHfa2+4g+qd2ktUTmO0eGjO7JNGrdCyg+l6RNrttMU+HP7NFLCCbPJIN0gfungL9SarqPDwE2kMhfi2+d0ny5+prE7E2aZ+/ZbcGyyRcxroMz7KzNrs+gkjaKORHklHZqqne1fS5twAvfypayzYgLMkssib0eiOgbtLa8yd0cTqVYi/cLR2Alhh1jUA/i1J9TwqQXPe+sLm77t5+vouhHEIY+yZmLvMDX0THl4RJZ+zG6qwkDnqVW5JOpJYkknjU/sm1sOD1dz/Nb9KScpzEOMQQfuhT47yH6U37MyWw6D8x9XY1wsMN3Gyla8zSQbTB2tHa1y9pR2ldntFqdmurtaO1rl7SjtKdonZrq7Wo/OcR7hT8aSfygH9TW7tKh8xn3sQi9I5L/AMYI/SuftKT/AEz1ZsedqOyzFqryRuARImqnUEKbEEHj8QpezrYDCyzCaOyuCG1JsSDcb1vi89epPLZtBMYpEkB0U2b8snu38m3PWuds776vs1wfhmg8LXTbCHNB1vzCldj2TDyywyON7fDhj7u+GA1F<ins>4qxsHmUeg31v03hf0vVNYvHRyC0gDdL8R4HiKiMS2FXqDy3WYn5k10mSOiG6KpRiNnDFSGVziCdcr9Qvo5ZK93qndhNtcQl0nWWSEC6uRd1HIEXuwNOI9o+FHHtr9Oyf8ApWwzFRuGeS40uzcQx5a1pd1AtON6N6lAbfxtpFDipD3RMPma58z2uxKRNJ2KQKo0Mzh3YnRVSKK92J0ALCr9szh89FgODmBpza78v1qncNWaW9kFxAh3sXIXmkO+w4LHcaRqo4WHHvpiBrI128Lpa727riLtceMTSkraXLmYrJEd2aO5RuRvxRuqnp50/SpeoPNMHoaOaHCipjeY3BzVXmN2uk7Byg3JksHRtStzYkdR0NSKZZi+ySQY25ZQ26UUpY6jUAfSuXMMqhmxDRy3BEJcFdG1kVRrzFt7TwrRExw0Zj7Qug+C4sV6i/SuW4ODvq05gr1sErZY29kKddkEA2DyJB9NV7baGWM7uJUa6CRNUN+RB1Xzpf2gyiJwSgtbXdHLvTp+Xge41nMsZvghbMWtcXAIsb6A6k6cajMTiZ7G0cl+5WP0Fa4lDrDjp4rrGANbvacx/HzosZJs3I435JCsN7IVBdpT0RePj016G3djMkHCMyo/3VmXdDW5A9aacvzhcG+6tt+CKNFvY2303nPncenfStnm0pckXuSb+Bve/drWKMySRiXf10HCuF961YojK4ivz/Fevgt+zyhI5Vt7wKh2195ibtbuGi+V+dNeSSLBGGDOQ9mdSd4KTzQWuAdLilqTG/Z73DfRD5sxJ+dakzzdAW/AWrHhWjtHudx88rWp2DpiayVnQ4kMAQQQeBHA1s36q7BbVvA1095CbtGeB7wfunv9adck2ogxQtG1n5xto48vvDvF62XAjRa8uFfF9wU5v0b9ab1D5ntPFESqntJPwqdB+ZuXhxqos5BYAy9FMYjFhRcn+/cO+oOHFb07seR3R/CLfW9Rq5oSd+Q3bkOS9wFcOFxV2AJ0JJbvvx+tam0Ii+MRjUlZexcNVnaSRWYBtVYFWt0YcR3jj5UmjB4ou0aRs5X7yj3SDwa/CxGtMUaGaRIgdd4C/QdfQGmpcvheFi8rRxoCIo0O6ZLGxJbmSbmw5EE8anCB0bBFH92d3oBwPtz/AAskLnMkIP25ePcqmx8WIQhZVdSdALHXuB51M7P5CCd6U8DrzsRyHInqeXK51EviZ0VxHvM0b+77xuyE8Crcf6VAxYpoGMJuSjEDvF7g+hrca8uJa/h+11g1wduHjmOqdxn6QARwIWY6hF/6mb9TXZhI8xn1EsUPRbb58CTelDL523mLKy72775FhpyN7aeHMejTgsyfcIiKh+AJ4D97TjVmS75IvIcAq4mHs23GBfMi/wCPVeMBtPMhlXFsPsiAW0BvrdSFJBOnLrXTk6yYuZZ5wRGhvBEep/4rD8VuHSoXEbPLh3w5kftTNKwYEEANu3DAcyT1qwcowXCtzDsc77+H7XC2niYm/TCMyMzVDkaHCz/CmsApqTUVow0NhXTaugvOoNcGPXSpCuPGrpRFRftCzCSDMFeM2IhA7iCzXB7qiZdoXkGoA8zTtt7skcTKjqwXdBDki5txFh14+tIeHZIzaMcD8R1bxvy8q5zoXvcQOZXqMJtTD4aJpcLdWiyYDxkO6D14nwUan6d9deU4lO0sqk2F95zfXT7o0HneuDGSbxv3f1oy57OfCsseCjbm/Py8PdaeM29isT9LTut5DXx18KUrtwjbyYmO+5IgRyOTppY+IA9DSthg0jhVBLMbCmZM7aIMtleNvijcXU/0NbNmc2ifFxxph441ckMQSWOhsLngL20rnPglwzHANtrQSDfAZ0RzGmWq2sNtcBgafu0XNmmJADIpuIexS46jfLfPTyqKxZ+0bx+tacQCrTL0ksfJmFNGSbDT41TLGyIgsCXJGoUfoRWAAR5/NAu3DIyCnOOXPwS2pvTRkWzKsd6TTdsWI0N+KoCOHUkfrWvH7DYrDEOhjl3Tf7M3On7pGvgL10vmTHDGaL4L/apziY8T+U/650jnjLxnl68AeStjZe3YAw23j38PnNZz2d//ANE27wZe0exB7r1EyzmE7tuVweRB5itOWQPi5CWO7Eg3pX5ADl4mpWHZ7EY5g0SiOFdI96/wjmFAJN+vCrTYlrX1dc/T8qkDIoXXwrP0rr6KOTNiSB1Nq2T5puygdONS+N9m80KGYSxuI/edRvKwA1JsRSXinJlN+O9b52qrSJHWDoFkc+GZ+8w2AP2m7ZBr4kHmd4DxEf8AUmoV9pXEYjN7pdfQ/wCh5V7gx5hMci8QS/j74NvQ2rZn2z5nY4nBDfSQ7zILb0bH4gV6X1/tUNaYZN92QcAL6jge+8u5czDYqPtHMd8q1DLimZhrrcW9abM6xQW9y4tYXRiONuKk2PHuqFynI2iYS4obgXVUPxMRw0ozDFlwxPM3+dbkEDJ3knNoH76dy19q7Sc1zOydRC8mItqjb/rvDxU6+lx313Zdngj+K4+dQiNXXiMQG+MX7+Df5ufneth2Ccw2w38+clkh/qMSN7PFN/I9vbwXfi9pWxOLwyrcJHItgeJLEXJ8gBV45SmgqkNjtmzJiI5VN40ck30YFRcAjgRqNavPK00FZ4A6yT0XH2nLFI5vZaV5lSyCvVYWs1tLlIrTOlxW6sMKIlTPsGSrbvxWNvG2nzqgpkeJykgKspsQf9cK+lsfh7iq/wBrtkUxA1G64+FxxHceo7qlQqpMt6zFLY15zfKZsM1pV0+64+FvA9e41w/tNSoUhPPcVpyfG9niY3/C6n0YXrjbEVy9tqaq9oc0tPFSDRtO0+SdpmskH3ZJkb+FvfPyJFWjs5BGcRilt9msiFE+7dk3S1vFbUj5C/bS4TGLreAxy9zxMBr3kX9BTdlzbhkI+I7v8jMf+6vEyYkRkMeLoUR1GXmPJesfc0QLTwTJjinwuigHQMttPkLfOqp2hk/YMaXUb0UwIlTk3JtOtiD43606vmRc2491IftLxAvEvO7N5aCsEEwxGI3SMjfhXTkdFmwUJiO67QjNdEkEXbJgsOCsH</ins>mN9ZL6qpPQe6P/VWtgvs0CQhBugbxNwL24WHd6aVT2W4sDMQD96EKPHdB/Q1YDY9162NuGvK1WfN/bOA4ka8c7s31NfgKuJiMrGAd/wCV17STdphpg2jBGGneNRfmCKqzb3L1TGK6CyyqG8wNf0qwcRIzRte43hzpU2yw5ZsObfCTc9Buqf0t51ODxZfKAdTfl/hIm9g0nvSdnku6VX90j6f0qPTMHQXjdkOmqsVPHqKztNP7yfxH51FdvpXtmMAYGleTe4lxKmkxzMbuzMerEsfU1tae4qHjxFbP2msoAAoLGc1I9rXvDo8rhI1LMeAH+tB31tyHZyfFEFRux85CNP4R94/KrU2Z2SjgWyLqfic/E3iendS0pethtmzh47Md5mbeboDYCw7rCrDwUVhXDl+BtUvGlqhSvYrNFFERRRRRFrkjvUXjcvBqYrwyURImb5ArqVdQyniCLg1V+0ns4dLthDcf/Ux1/hY8fA+tfQGIwYNQ2Nym/KiL5cxG8jFXBVhxVhYjyNczT1fu0excOIW0yA9GGjL4Nx8uFVTtH7McRBdoLzJ04SD+Hg3l6URc+x+2cuFkEYAeKRwGQ8ixC76nkeHcbVcmCzGNxvA8Br1Fuo6188ZehE8YIIYSoLHQg740saueKIqbi6n0/tXG2hsmPFfW3J3Pn3+63cPjHxfScwveM9p2EVfsxI7cl3d31Lf3qus5zt8TKZJOegUcFHICnPO9lY8Td1Ajl/EB7rfmA+o+dIeY5ZLA27KpB5HiD3g861MJgocO4gAh3X04EfCu/h8QxwtpUjnOLZMQGU2ZVQg9CALU3ZX7UowgGIjcMOaWIPfYkEfOkbPD9r/Cn0qSyXZB5LNMCq/h5nx/CPnWSfCQzsaJB3c0MzWxjeVkJtRBLAsyEneuAmgYEGxDW4f3FK+YYh5WJb+w7hUhFlYRQAAAOA4CvQwBPAX/ANd9ZsBsqPDEv1PkuHicYZPpboq120G68f5Sf5qX1xFOu3eRzSYiGOFC7mMkhQTb3zqTwA7zapDZz2RkkNjGv/ykOngz/oPWu0uekvKsvmxDbkCM5524DvZuA86svZr2ZqtmxJ7R/wAA+Af+Xnp3U85Ps0kShI0VFHBVFh/c99MuDyoDlRFE5fkwFtNBTDhMvArrhwoFdKrRF5jjtWyiiiIooooiKKKKIiiiiiLBFa5IQa20URRmJy8HlUNjMm7qaiK0yRiiKts12EgnZXkjG+pBVx7rDdNxqOI04Gu85J3U5GAVj9nWiJHkyO3AfpUbmGz4kUq6hgeR1/8AR76saTDL0rimwi9KxyRtkFOCsx7mG2lVthNkEWTf3fe0AJ1IA0Fun1qbhyg2tramlcIvSuuLCr0qsUDI9PHirySuk+4pWhyPuruiyPupljw69K3pCKzLElpck7q7cNlAHKpsRCtioKIuSDAgV1pHavYFZoixas0UURFFFFERRRRRF//Z)</p>
<h1 id="you-xi-kai-fa" class="heading-control">游戏开发<a class="heading-anchor" href="#you-xi-kai-fa" aria-hidden="true"></a></h1>
<p>自打DHTML出来后，开发者就开始在web上弄一些好玩的东西，早在1999年，就有人开始用DHTML做网页游戏，比如：<a href="http://www.downes.ca/post/276" target="_blank" rel="noopener">Fun and Games with DHTML</a> 。可惜限于当时浏览器的性能和特性，加上CPU处理能力有限，许多还是停留在设想中，但这并不能挡住开发者前进的脚步，他们并没有 Give Up。随着浏览器性能的改进以及HTML语言本身的发展，加上硬件性能也有了长足的进步，现在如今诸多的 Javascript Game Engines 已经如雨后春笋般的冒出来了。</p>
<p>相较于HTML4，HTML5做了像素控制机制以及图形加速方面的改进，正是这些改进，让WEB游戏开发变得简单，那么，接下来，在本文的上半篇，我们首先要介绍的是两个2D HTML5游戏引擎，下篇我们会介绍一些好玩的3D HTML5游戏引擎。</p>
<h2 id="yi-gamejs-kai-yuan-2d-html5-you-xi-yin-qing" class="heading-control">一、GameJS 开源2D HTML5 游戏引擎<a class="heading-anchor" href="#yi-gamejs-kai-yuan-2d-html5-you-xi-yin-qing" aria-hidden="true"></a></h2>
<p><a href="http://gamejs.org/" target="_blank" rel="noopener">GameJS</a> 的前身是从Python界著名的开源 <a href="http://www.pygame.org/" target="_blank" rel="noopener">PyGame </a>游戏引擎移植而来。如果你熟悉PyGame的开发，那么对于 <a href="http://gamejs.org/" target="_blank" rel="noopener">GameJS</a> 应该可以很快上手。<a href="http://gamejs.org/" target="_blank" rel="noopener">GameJS</a> 可以和服务端的<a href="http://ringojs.org/" target="_blank" rel="noopener">RingoJS</a>集成使用，而<a href="http://ringojs.org/" target="_blank" rel="noopener">RingoJS</a>是用Java写的js运行环境，所以你需要Java 1.5以上版本，同时还svfd安装Ant。下载代码仓库还需要用到<a href="http://git-scm.com/download" target="_blank" rel="noopener">GIT</a>.</p>
<h3 id="kai-shi-wan-dataimagejpgbase649j4aaqskzjrgabaqaaaqabaad2wceaakgbgggbqkibwgkcqkkdryodqwmdrotfbawhxwhib8chh4jjziqiyuvjr4ekzsslzm1odg4iso9qtw2qti3odubcqokdqsngq4ogtukhiq1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu0ntu1ntu1nsk1ntutnfaabeiacaaiambigaceqedeqhxaaxaaebaqeaaaaaaaaaaaaaaaagbwud8qalraaagiabqmbbgcaaaaaaaaaaqidbaaferihbiixb0fryzkhwrmuqknxgzhxaawaqebaqaaaaaaaaaaaaaaaaadbahxaadeqacagmbaqeaaaaaaaaaaaabagaderihqfae9oadambaairaxeapwc44n9a5mavwcalkin3gvlpjuadbzyf5p4oembxqm6lnlkv4erh9uh3wls7ufeo1tultv6yzcpds2vo7tkccykxaqadzacrp8owgwe6kiljyu20qbfe5iyju13kaf1hkkafdchgommrnroyazjbtwuasli1isumy1zm9mcfvfixn46jquysmu4b8wy7pf5p7eh7ggh11b400gmj1ezwzlkvnar2tkqej2z68zcrs6oqfo0dzad3jy8doxhvov8qlkmud1gjvixjbx7maw9dqkbhujyr3fp0tftisp9xzsoox5yw1gk1jztwrgj49d3laljgqcf5pgk8emi0dzy1eng6mnvztqcpemrqz6hzujbxr5ibc0zbiokqtk7seafcjyt4w79oy84tjldztuko13sf6nazveqrmoyl9p4jcsdpg5trr7abydgc9lkkqwudmphpz" class="heading-control">开始玩![](data:image/jpg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBggGBQkIBwgKCQkKDRYODQwMDRoTFBAWHxwhIB8cHh4jJzIqIyUvJR4eKzssLzM1ODg4ISo9QTw2QTI3ODUBCQoKDQsNGQ4OGTUkHiQ1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU0NTU1NTU1NSk1NTUtNf/AABEIACAAIAMBIgACEQEDEQH/xAAXAAEBAQEAAAAAAAAAAAAAAAAGBwUD/8QALRAAAgIABQMBBgcAAAAAAAAAAQIDBAAFERIhBiIxB0FRYZKhwRMUQkNxgZH/xAAWAQEBAQAAAAAAAAAAAAAAAAADBAH/xAAdEQACAgMBAQEAAAAAAAAAAAABAgADERIhQfAE/9oADAMBAAIRAxEAPwC44N9a5maVWCAlkin3GVlPJUaDb/ZYf5p4OEmBXqM6LNlKv4eRh9UH3wlS7uFEO1tULTV6YzCpds2Vo7tkccYkXaQA/dz/ACRp8owgwe6Kiljyu20qbFe5IYju13KAF1+HKkafDCHGOMMRNrOyAzjbtwUasli1IsUMY1Zm9mCfVFiXN46jQUysMU4b8wy7pF5P7eh7GGh11B400GMj1ezWzlk+VNar2TkQEj2Z68ZcRS6oqF+O0dzAd3JY8doxhVOv8qlKMud1Gj/V+Ixjbx7mAw9dQKbhujyR3fp0tFTISp9xzsoOX5y+W1gk1JzTWRgJ49d3LaljGQCF5Pgk8eMI0dZY1eNg6MNVZTqCPeMRqz6hZUJBXr5ibc0zBIoKqtK7seAFCjyT4w79OY84TJLDZtUko13sF6NaZVEqRMoYl9p4JcsdpG5Trr7ABYDGc9lKkqwUDmPhP//Z)<a class="heading-anchor" href="#kai-shi-wan-dataimagejpgbase649j4aaqskzjrgabaqaaaqabaad2wceaakgbgggbqkibwgkcqkkdryodqwmdrotfbawhxwhib8chh4jjziqiyuvjr4ekzsslzm1odg4iso9qtw2qti3odubcqokdqsngq4ogtukhiq1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu0ntu1ntu1nsk1ntutnfaabeiacaaiambigaceqedeqhxaaxaaebaqeaaaaaaaaaaaaaaaagbwud8qalraaagiabqmbbgcaaaaaaaaaaqidbaaferihbiixb0fryzkhwrmuqknxgzhxaawaqebaqaaaaaaaaaaaaaaaaadbahxaadeqacagmbaqeaaaaaaaaaaaabagaderihqfae9oadambaairaxeapwc44n9a5mavwcalkin3gvlpjuadbzyf5p4oembxqm6lnlkv4erh9uh3wls7ufeo1tultv6yzcpds2vo7tkccykxaqadzacrp8owgwe6kiljyu20qbfe5iyju13kaf1hkkafdchgommrnroyazjbtwuasli1isumy1zm9mcfvfixn46jquysmu4b8wy7pf5p7eh7ggh11b400gmj1ezwzlkvnar2tkqej2z68zcrs6oqfo0dzad3jy8doxhvov8qlkmud1gjvixjbx7maw9dqkbhujyr3fp0tftisp9xzsoox5yw1gk1jztwrgj49d3laljgqcf5pgk8emi0dzy1eng6mnvztqcpemrqz6hzujbxr5ibc0zbiokqtk7seafcjyt4w79oy84tjldztuko13sf6nazveqrmoyl9p4jcsdpg5trr7abydgc9lkkqwudmphpz" aria-hidden="true"></a></h3>
<p>首先从版本仓库中取回GameJS, 进入gamejs目录:</p>
<pre><code class="bash">git <span class="hljs-built_in">clone</span> git://github.com/oberhamsi/gamejs.git
<span class="hljs-built_in">cd</span> gamejs
</code></pre>
<p>接着获取编译所需要的依赖项:</p>
<pre><code class="bash">git submodule init
git submodule update
</code></pre>
<p>编译 RingoJs:</p>
<pre><code class="bash">ant -f ./server/ringojs/build.xml jar
</code></pre>
<p>OK, 现在可以启动GameJS的Web Server了：</p>
<pre><code class="bash">gjs-server.sh   (如果是 windows环境用： gjs-server.cmd)
</code></pre>
<p>然后你可以在浏览器中访问 <a href="http://localhost:8080/" target="_blank" rel="noopener">http://localhost:8080/</a> 了。你应该在页面上可以看到游戏例子的链接，这些例子的源代码在GameJS的examples目录下面。  你也可以本地部署你的HTML5游戏(去掉服务端支持)：</p>
<pre><code class="bash">gjs-statify.sh &lt;app&gt; &lt;output-directory&gt;
</code></pre>
<p>例如，部署GameJS的一个例子程序：</p>
<pre><code class="bash">gjs-statify.sh example-draw /var/www/games/foo
</code></pre>
<p>供参考学习的一个很小的GameJS游戏代码，点击会变颜色的脉动的圆：  <a href="http://gamejs.org/apps/minimal/" target="_blank" rel="noopener"><img src="./pulse-circle.png" alt></a></p>
<pre><code class="js"><span class="hljs-comment">// 一个非常小的 GameJS 应用用于展示GameJS的编程概念</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// 一个脉动的彩色圆，单击改变颜色</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// Play: &lt;http://gamejs.org/apps/minimal/&gt;</span>

<span class="hljs-keyword">var</span> gamejs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gamejs'</span>);

<span class="hljs-keyword">var</span> SCREEN_WIDTH = <span class="hljs-number">400</span>;
<span class="hljs-keyword">var</span> SCREEN_HEIGHT = <span class="hljs-number">400</span>;

<span class="hljs-comment">// ball 是一个带颜色的圆.</span>
<span class="hljs-comment">// ball 的颜色可以按照一个色彩列表(Ball.COLORS)进行变化. ball.color 是色彩列表的索引号</span>
<span class="hljs-comment">// ball constantly pulsates in size.</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Ball</span>(<span class="hljs-params">center</span>) </span>{
   <span class="hljs-keyword">this</span>.center = center;
   <span class="hljs-comment">//设置圆每秒增长的半径大小</span>
   <span class="hljs-keyword">this</span>.growPerSec = Ball.GROW_PER_SEC;
   <span class="hljs-comment">//圆的半径</span>
   <span class="hljs-keyword">this</span>.radius = <span class="hljs-keyword">this</span>.growPerSec * <span class="hljs-number">2</span>;
   <span class="hljs-comment">//圆的当前颜色在色彩列表的索引号</span>
   <span class="hljs-keyword">this</span>.color = <span class="hljs-number">0</span>;
   <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};
Ball.MAX_SIZE = <span class="hljs-number">200</span>;
Ball.GROW_PER_SEC = <span class="hljs-number">50</span>;
Ball.COLORS = [<span class="hljs-string">'#ff0000'</span>, <span class="hljs-string">'#00ff00'</span>, <span class="hljs-string">'#0000cc'</span>];
Ball.prototype.nextColor = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
   <span class="hljs-keyword">this</span>.color += <span class="hljs-number">1</span>;
   <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.color &gt; Ball.COLORS.length) {
      <span class="hljs-keyword">this</span>.color = <span class="hljs-number">0</span>;
   }
};
Ball.prototype.draw = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">display</span>) </span>{
   <span class="hljs-keyword">var</span> rgbColor = Ball.COLORS[<span class="hljs-keyword">this</span>.color];
   <span class="hljs-keyword">var</span> lineWidth = <span class="hljs-number">0</span>; <span class="hljs-comment">// 线宽为零将以指定的颜色填充该圆</span>
   gamejs.draw.circle(display, rgbColor, <span class="hljs-keyword">this</span>.center, <span class="hljs-keyword">this</span>.radius, lineWidth);
};
Ball.prototype.update = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">msDuration</span>) </span>{
   <span class="hljs-keyword">this</span>.radius += <span class="hljs-keyword">this</span>.growPerSec * (msDuration / <span class="hljs-number">1000</span>);
   <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.radius &gt; Ball.MAX_SIZE || <span class="hljs-keyword">this</span>.radius &lt; <span class="hljs-built_in">Math</span>.abs(<span class="hljs-keyword">this</span>.growPerSec)) {
      <span class="hljs-keyword">this</span>.radius = <span class="hljs-keyword">this</span>.radius &gt; Ball.MAX_SIZE ? Ball.MAX_SIZE : <span class="hljs-built_in">Math</span>.abs(<span class="hljs-keyword">this</span>.growPerSec);
      <span class="hljs-keyword">this</span>.growPerSec = -<span class="hljs-keyword">this</span>.growPerSec;
   }
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main</span>(<span class="hljs-params"></span>) </span>{

   <span class="hljs-comment">// 当鼠标UP事件发生的时候，圆改变颜色</span>
   <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleEvent</span>(<span class="hljs-params">event</span>) </span>{
      <span class="hljs-keyword">switch</span>(event.type) {
         <span class="hljs-keyword">case</span> gamejs.event.MOUSE_UP:
            ball.nextColor();
            <span class="hljs-keyword">break</span>;
      };
   };

   <span class="hljs-comment">// handle events.</span>
   <span class="hljs-comment">// update models.</span>
   <span class="hljs-comment">// clear screen.</span>
   <span class="hljs-comment">// draw screen.</span>
   <span class="hljs-comment">// called ~ 30 times per second by fps.callback</span>
   <span class="hljs-comment">// msDuration = actual time in milliseconds since last call</span>
   <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">gameTick</span>(<span class="hljs-params">msDuration</span>) </span>{
      gamejs.event.get().forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
         handleEvent(event);
      });
      ball.update(msDuration);
      display.clear();
      ball.draw(display);
   };

   <span class="hljs-comment">// setup screen and ball.</span>
   <span class="hljs-comment">// ball in screen center.</span>
   <span class="hljs-comment">// start game loop.</span>
   <span class="hljs-keyword">var</span> display = gamejs.display.setMode([SCREEN_WIDTH, SCREEN_HEIGHT]);
   <span class="hljs-keyword">var</span> ballCenter = [SCREEN_WIDTH / <span class="hljs-number">2</span>, SCREEN_HEIGHT / <span class="hljs-number">2</span>];
   <span class="hljs-keyword">var</span> ball = <span class="hljs-keyword">new</span> Ball(ballCenter);
   <span class="hljs-comment">//安装FPS回调: gameTick ，帧速：30fps</span>
   gamejs.time.fpsCallback(gameTick, <span class="hljs-keyword">this</span>, <span class="hljs-number">30</span>);
};

<span class="hljs-comment">// call main after all resources have finished loading</span>
gamejs.ready(main);
</code></pre>
<p>GameJS的文档在：<a href="http://docs.gamejs.org/%EF%BC%8C" target="_blank" rel="noopener">http://docs.gamejs.org/，</a> 另外 PyGame 的<a href="http://pygame.org/wiki/tutorials" target="_blank" rel="noopener">教程</a>和<a href="http://www.pygame.org/docs/" target="_blank" rel="noopener">文档</a>你也可以参考.</p>
<h2 id="er-qing-liang-ji-duan-xiao-jing-han-de-craftyjs-2d-js-you-xi-yin-qing" class="heading-control">二、轻量级短小精悍的CraftyJS 2D JS游戏引擎<a class="heading-anchor" href="#er-qing-liang-ji-duan-xiao-jing-han-de-craftyjs-2d-js-you-xi-yin-qing" aria-hidden="true"></a></h2>
<p><a href="http://craftyjs.com/" target="_blank" rel="noopener">CraftyJS</a> 压缩处理（Minified+GZIP）后代码只有10k左右。虽然精悍但是也包含了动画，事件管理，区域重绘，冲突检测，精灵等组件。</p>
<h3 id="kai-wan-dataimagejpgbase649j4aaqskzjrgabaqaaaqabaad2wceaakgbgggbqkibwgkcqkkdryodqwmdrotfbawhxwhib8chh4jjziqiyuvjr4ekzsslzm1odg4iso9qtw2qti3odubcqokdqsngq4ogtukhiq1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu0ntu1ntu1nsk1ntutnfaabeiacaaiambigaceqedeqhxaaxaaebaqeaaaaaaaaaaaaaaaagbwud8qalraaagiabqmbbgcaaaaaaaaaaqidbaaferihbiixb0fryzkhwrmuqknxgzhxaawaqebaqaaaaaaaaaaaaaaaaadbahxaadeqacagmbaqeaaaaaaaaaaaabagaderihqfae9oadambaairaxeapwc44n9a5mavwcalkin3gvlpjuadbzyf5p4oembxqm6lnlkv4erh9uh3wls7ufeo1tultv6yzcpds2vo7tkccykxaqadzacrp8owgwe6kiljyu20qbfe5iyju13kaf1hkkafdchgommrnroyazjbtwuasli1isumy1zm9mcfvfixn46jquysmu4b8wy7pf5p7eh7ggh11b400gmj1ezwzlkvnar2tkqej2z68zcrs6oqfo0dzad3jy8doxhvov8qlkmud1gjvixjbx7maw9dqkbhujyr3fp0tftisp9xzsoox5yw1gk1jztwrgj49d3laljgqcf5pgk8emi0dzy1eng6mnvztqcpemrqz6hzujbxr5ibc0zbiokqtk7seafcjyt4w79oy84tjldztuko13sf6nazveqrmoyl9p4jcsdpg5trr7abydgc9lkkqwudmphpz" class="heading-control">开玩![](data:image/jpg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBggGBQkIBwgKCQkKDRYODQwMDRoTFBAWHxwhIB8cHh4jJzIqIyUvJR4eKzssLzM1ODg4ISo9QTw2QTI3ODUBCQoKDQsNGQ4OGTUkHiQ1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU0NTU1NTU1NSk1NTUtNf/AABEIACAAIAMBIgACEQEDEQH/xAAXAAEBAQEAAAAAAAAAAAAAAAAGBwUD/8QALRAAAgIABQMBBgcAAAAAAAAAAQIDBAAFERIhBiIxB0FRYZKhwRMUQkNxgZH/xAAWAQEBAQAAAAAAAAAAAAAAAAADBAH/xAAdEQACAgMBAQEAAAAAAAAAAAABAgADERIhQfAE/9oADAMBAAIRAxEAPwC44N9a5maVWCAlkin3GVlPJUaDb/ZYf5p4OEmBXqM6LNlKv4eRh9UH3wlS7uFEO1tULTV6YzCpds2Vo7tkccYkXaQA/dz/ACRp8owgwe6Kiljyu20qbFe5IYju13KAF1+HKkafDCHGOMMRNrOyAzjbtwUasli1IsUMY1Zm9mCfVFiXN46jQUysMU4b8wy7pF5P7eh7GGh11B400GMj1ezWzlk+VNar2TkQEj2Z68ZcRS6oqF+O0dzAd3JY8doxhVOv8qlKMud1Gj/V+Ixjbx7mAw9dQKbhujyR3fp0tFTISp9xzsoOX5y+W1gk1JzTWRgJ49d3LaljGQCF5Pgk8eMI0dZY1eNg6MNVZTqCPeMRqz6hZUJBXr5ibc0zBIoKqtK7seAFCjyT4w79OY84TJLDZtUko13sF6NaZVEqRMoYl9p4JcsdpG5Trr7ABYDGc9lKkqwUDmPhP//Z)<a class="heading-anchor" href="#kai-wan-dataimagejpgbase649j4aaqskzjrgabaqaaaqabaad2wceaakgbgggbqkibwgkcqkkdryodqwmdrotfbawhxwhib8chh4jjziqiyuvjr4ekzsslzm1odg4iso9qtw2qti3odubcqokdqsngq4ogtukhiq1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu0ntu1ntu1nsk1ntutnfaabeiacaaiambigaceqedeqhxaaxaaebaqeaaaaaaaaaaaaaaaagbwud8qalraaagiabqmbbgcaaaaaaaaaaqidbaaferihbiixb0fryzkhwrmuqknxgzhxaawaqebaqaaaaaaaaaaaaaaaaadbahxaadeqacagmbaqeaaaaaaaaaaaabagaderihqfae9oadambaairaxeapwc44n9a5mavwcalkin3gvlpjuadbzyf5p4oembxqm6lnlkv4erh9uh3wls7ufeo1tultv6yzcpds2vo7tkccykxaqadzacrp8owgwe6kiljyu20qbfe5iyju13kaf1hkkafdchgommrnroyazjbtwuasli1isumy1zm9mcfvfixn46jquysmu4b8wy7pf5p7eh7ggh11b400gmj1ezwzlkvnar2tkqej2z68zcrs6oqfo0dzad3jy8doxhvov8qlkmud1gjvixjbx7maw9dqkbhujyr3fp0tftisp9xzsoox5yw1gk1jztwrgj49d3laljgqcf5pgk8emi0dzy1eng6mnvztqcpemrqz6hzujbxr5ibc0zbiokqtk7seafcjyt4w79oy84tjldztuko13sf6nazveqrmoyl9p4jcsdpg5trr7abydgc9lkkqwudmphpz" aria-hidden="true"></a></h3>
<p>这个很简单，从<a href="http://craftyjs.com/" target="_blank" rel="noopener">CraftyJS</a> 下载 crafty.js文件。  它的游戏对象分为实体(Entity)和组件(Component):</p>
<pre><code class="js"><span class="hljs-keyword">var</span> player = Crafty.e();
player.addComponent(<span class="hljs-string">"2D, gravity"</span>);
</code></pre>
<p>上面的代码就建立一个 player 实体，并在player实体上添加了两个组件(2D 和 gravirty).  OK，这里就解释下它主页上的最小代码的例子，你可以在它的主页上运行这个例子，运行这个例子你可以看到一个铅笔掉了下来，你可以用左右光标键去控制这只笔移动，按上则是跳跃：</p>
<pre><code class="js"><span class="hljs-comment">//初始化 Crafty 游戏，指定FPS为50,宽度为580, 高度为225</span>
Crafty.init(<span class="hljs-number">50</span>, <span class="hljs-number">580</span>, <span class="hljs-number">225</span>);

<span class="hljs-comment">//创建player(铅笔)实体,这个铅笔是2D，挂在DOM上的，受重力（gravity）影响的,</span>
<span class="hljs-comment">//可以左右移动(twoway)的图像(image)</span>
<span class="hljs-comment">//设置它的x位置在Crafty.viewport.width / 2, 宽度和高度都是16</span>
<span class="hljs-comment">//重力方向是落向floor实体(该实体是在后面创建的)</span>
<span class="hljs-comment">//设置twoway参数: 有三个控制键，左键，右键，上键</span>
<span class="hljs-comment">//设置图像元素</span>
<span class="hljs-keyword">var</span> player = Crafty.e(<span class="hljs-string">"2D, DOM, gravity, controls, twoway, image"</span>)
  .attr({<span class="hljs-attr">x</span>: Crafty.viewport.width / <span class="hljs-number">2</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">h</span>: <span class="hljs-number">16</span>})
  .gravity(<span class="hljs-string">"floor"</span>)
  .twoway(<span class="hljs-number">2</span>)
  .image(<span class="hljs-string">"favicon.png"</span>, <span class="hljs-string">"no-repeat"</span>);

<span class="hljs-comment">//创建不可见的 floor 实体</span>
<span class="hljs-keyword">var</span> floor = Crafty.e(<span class="hljs-string">"2D, floor"</span>)
  .attr({<span class="hljs-attr">x</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">225</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">580</span>, <span class="hljs-attr">h</span>: <span class="hljs-number">5</span>});
</code></pre>
<p>可以去玩玩它的sample应用：<a href="https://github.com/craftyjs/demos" target="_blank" rel="noopener">Demos</a></p>
<p>或者去学习下他的教程：<a href="http://cykod.github.io/Presentations/HTML5/Crafty" target="_blank" rel="noopener">Tutorials</a>。当然你也可以去看看他的开发文档：<a href="http://craftyjs.com/api/" target="_blank" rel="noopener">API 文档</a></p>
<p>随着OpenGL/ES WebGL的标准正式确立，如今Web 3D 游戏开发的序幕也被揭开了:</p>
<ul>
<li><a href="http://www.mozilla.com/en-US/firefox/all-beta.html" target="_blank" rel="noopener">Firefox/4.0b8+</a> 以上的版本以及 <a href="http://nightly.mozilla.org/" target="_blank" rel="noopener">Firefox Nighting Building</a> 已经默认支持WebGL</li>
<li>Safari： WebGL is supported on Mac OS X 10.6 in the <a href="http://nightly.webkit.org/" target="_blank" rel="noopener">WebKit nightly builds</a>.</li>
<li>Chrome/Chromium： WebGL is available in <a href="http://www.google.com/chrome/" target="_blank" rel="noopener">the stable release of Chrome</a>.  BTW: <a href="http://blogs.sonyericsson.com/developerworld/2011/02/24/webgl-support-in-the-android-web-browser/" target="_blank" rel="noopener">Android上web 浏览器 已经支持WebGL</a>了</li>
<li>Opera： WebGL is supported on Windows in <a href="http://my.opera.com/core/blog/2011/02/28/webgl-and-hardware-acceleration-2" target="_blank" rel="noopener">the Opera 11 preview build</a></li>
</ul>
<p>接上随着WebGL（OpenGL ES2.0）标准规范在2011 GDC（游戏开发者大会）上正式发布，支持WebGL的浏览器可以不借助任何插件便可提供硬件图形加速从而提供高质量的3D体验。Web 3D 游戏开发的序幕也被揭开了，WebGL目前是唯一能在各个浏览器中充分利用GPU硬件加速的形式，这更利于HTML5的游戏开发以及各种更酷的直接呈现，不过这仍然算是较新的技术，目前不是所有的浏览器都支持，请留意你的使用的浏览器和版本：</p>
<ul>
<li><a href="http://www.mozilla.com/en-US/firefox/all-beta.html" target="_blank" rel="noopener">Firefox/4.0b8+</a> 以上的版本以及 <a href="http://nightly.mozilla.org/" target="_blank" rel="noopener">Firefox Nighting Building</a> 已经默认支持WebGL</li>
<li>Safari： WebGL is supported on Mac OS X 10.6 in the <a href="http://nightly.webkit.org/" target="_blank" rel="noopener">WebKit nightly builds</a>.</li>
<li>Chrome/Chromium： WebGL is available in <a href="http://www.google.com/chrome/" target="_blank" rel="noopener">the stable release of Chrome</a>. BTW:<a href="http://blogs.sonyericsson.com/developerworld/2011/02/24/webgl-support-in-the-android-web-browser/" target="_blank" rel="noopener">Android上web 浏览器 已经支持WebGL</a>了</li>
<li>Opera： WebGL is supported on Windows in <a href="http://my.opera.com/core/blog/2011/02/28/webgl-and-hardware-acceleration-2" target="_blank" rel="noopener">the Opera 11 preview build</a></li>
</ul>
<p>需要注意的是，虽然Chrome已经完全支持WebGL，但是如果你还在XP下使用，那么有可能你的显卡（GPU）是在黑名单中，是没有打开WebGL的，你需要手工执行命令，以忽略GPU黑名单：</p>
<pre><code class="bash">chrome.exe --ignore-gpu-blacklist
</code></pre>
<h2 id="gammajs-zui-jian-dan-de-webgl-xia-kai-fa-you-xi-de-kai-yuan-kuang-jia" class="heading-control">GammaJS 最简单的WebGL下开发游戏的开源框架<a class="heading-anchor" href="#gammajs-zui-jian-dan-de-webgl-xia-kai-fa-you-xi-de-kai-yuan-kuang-jia" aria-hidden="true"></a></h2>
<p>站点：<a href="http://gamma.delfick.com/" target="_blank" rel="noopener">http://gamma.delfick.com/</a></p>
<p>GammaJS 以极其简单的开发体验给我留下了深刻印象。他能快速的帮助我们利用WebGL搭建2.5D游戏。</p>
<p>下载：<a href="https://github.com/downloads/Royce/GammaJS/gma-min.js" target="_blank" rel="noopener">gma-min.js</a></p>
<pre><code class="bash">wget https://github.com/downloads/Royce/GammaJS/gma-min.js
</code></pre>
<p>使用:</p>
<p><strong>最基本的架子：</strong></p>
<p>Game.html</p>
<pre><code class="html"><span class="hljs-meta">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.w3.org/1999/xhtml"</span> <span class="hljs-attr">xml:lang</span>=<span class="hljs-string">"en"</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"Content-Type"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"text/html; charset=UTF-8"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>My Awesome Game<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>

    <span class="hljs-comment">&lt;!--
        Include any style sheets here
        &lt;link rel="stylesheet" type="text/css" href="gamma.css" media="all"/&gt;
    --&gt;</span>

    <span class="hljs-comment">&lt;!-- Include the Gamma Library --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"gma-min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- The element to contain the rendering canvas is called #gamma by default --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"gamma"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- This javascript file contains the game specification --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"game.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>game.js:</p>
<pre><code class="js"><span class="hljs-built_in">require</span>([<span class="hljs-string">'gma/base'</span>, <span class="hljs-string">'gma/manager'</span>],
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">gma</span>) </span>{
        <span class="hljs-comment">// The game specification is contained within this function.</span>
        <span class="hljs-keyword">var</span> manager = gma.manager();
        manager.storeLevels({});
        manager.init();
    }
);
</code></pre>
<p>在 game.js 我们需要用 require 函数来导入GammaJS 功能库的部分（gma/base, gma/manager），当需要的功能库都被加载后，匿名初始化函数function(gma)就会被执行。在初始化函数中，我们要创建一个gma.manager，它默认会维护一个canvas在id“gamma”的div标签中。</p>
<p>和以前一样，我们先来做一个最简单的“游戏”：</p>
<p>game.js:</p>
<pre><code class="js"><span class="hljs-built_in">require</span>([<span class="hljs-string">'gma/base'</span>, <span class="hljs-string">'gma/manager'</span>],
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">gma</span>) </span>{
        <span class="hljs-comment">// 设置该画布的大小是600x500,可以设置 containerID 来改变默认的div id名称.</span>
        <span class="hljs-keyword">var</span> manager = gma.manager({
           <span class="hljs-attr">width</span>: <span class="hljs-number">600</span>,
           <span class="hljs-attr">height</span>: <span class="hljs-number">500</span>
        });
        manager.storeLevels({});
        manager.init();
    }
);
</code></pre>
<p>要让游戏跑起来，我们需要初始化游戏设置，比如 level 信息，manager.storeLevels用来存放游戏的level，然后manager.init。</p>
<p>OK，我们首先配置游戏的一个 Level，首先 Level 里面要有游戏角色站立、行走、跳跃的台子(platform)：</p>
<pre><code class="js"><span class="hljs-keyword">var</span> myLevel = {
    <span class="hljs-attr">entities</span> : [
        {<span class="hljs-attr">type</span>: <span class="hljs-string">'platform'</span>, <span class="hljs-attr">top</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">30</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>},
        {<span class="hljs-attr">type</span>: <span class="hljs-string">'platform'</span>, <span class="hljs-attr">top</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">36</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">30</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>}
    ]
};
</code></pre>
<p>platform是默认实体（entities）类型，所以如果实体是台子(platform)则类型可以省略:</p>
<pre><code class="js"><span class="hljs-keyword">var</span> myLevel = {
    <span class="hljs-attr">entities</span> : [
        {<span class="hljs-attr">top</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">30</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>},
        {<span class="hljs-attr">top</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">36</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">30</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>}
    ]
};
</code></pre>
<p>好了，现在我们使用 storeLevels 将 myLevel 加进来。</p>
<pre><code class="js">manager.storeLevels(myLevel);
</code></pre>
<p>现在我们的game.js 像这样：</p>
<pre><code class="js"><span class="hljs-built_in">require</span>([<span class="hljs-string">'gma/base'</span>, <span class="hljs-string">'gma/manager'</span>],
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">gma</span>) </span>{
        <span class="hljs-keyword">var</span> manager = gma.manager({
            <span class="hljs-attr">width</span> : <span class="hljs-number">600</span>,
            <span class="hljs-attr">height</span> : <span class="hljs-number">500</span>
        });
        <span class="hljs-keyword">var</span> myLevel = {
            <span class="hljs-attr">entities</span> : [
                {<span class="hljs-attr">top</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">30</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>},
                {<span class="hljs-attr">top</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">36</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">30</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>}
            ]
        };
        manager.storeLevels(myLevel);
        manager.init();
    }
);
</code></pre>
<p>接下来就轮到我们的主角上场了，首先我们需要在require中添加 gma/entities/character 库引入对角色的支持，然后我们就可以创建角色实例（规定它的位置和大小）:</p>
<pre><code class="js">manager.character = gma.character({
    <span class="hljs-attr">left</span>     : <span class="hljs-number">0</span>,
    <span class="hljs-attr">bottom</span>   : <span class="hljs-number">0</span>,
    <span class="hljs-attr">width</span>    : <span class="hljs-number">3</span>,
    <span class="hljs-attr">height</span>   : <span class="hljs-number">6</span>,
    <span class="hljs-attr">depth</span>    : <span class="hljs-number">3</span>
});
</code></pre>
<p>接着我们要设置角色在level中的出生点位置(spawn)：</p>
<pre><code class="js"><span class="hljs-keyword">var</span> mylevel = {
    <span class="hljs-attr">spawn</span> : {
        <span class="hljs-attr">main</span> : [<span class="hljs-number">15</span>, <span class="hljs-number">24</span>]
    }
}
</code></pre>
<p>注意，如果没有指定spawn main 的位置，那么默认spawn出生点是(0,0).</p>
<p>现在我们的game.js像这样子了：</p>
<pre><code class="js"><span class="hljs-built_in">require</span>([
    <span class="hljs-string">'gma/base'</span>,
    <span class="hljs-string">'gma/manager'</span>,
    <span class="hljs-string">'gma/entities/character'</span>,
    <span class="hljs-string">'gma/events'</span>
],
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">gma</span>) </span>{
        <span class="hljs-keyword">var</span> manager = gma.manager({
            <span class="hljs-attr">width</span> : <span class="hljs-number">600</span>,
            <span class="hljs-attr">height</span> : <span class="hljs-number">500</span>
        });
        manager.character = gma.character({
            <span class="hljs-attr">left</span>     : <span class="hljs-number">0</span>,
            <span class="hljs-attr">bottom</span>   : <span class="hljs-number">0</span>,
            <span class="hljs-attr">width</span>    : <span class="hljs-number">3</span>,
            <span class="hljs-attr">height</span>   : <span class="hljs-number">6</span>,
            <span class="hljs-attr">depth</span>    : <span class="hljs-number">3</span>
        });

        <span class="hljs-keyword">var</span> myLevel = {
            <span class="hljs-attr">spawn</span> : {
                <span class="hljs-attr">main</span> : [<span class="hljs-number">15</span>, <span class="hljs-number">24</span>]
            },
            <span class="hljs-attr">entities</span> : [
                {<span class="hljs-attr">top</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">30</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>},
                {<span class="hljs-attr">top</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">36</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">30</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>}
            ]
        };
        manager.storeLevels(myLevel);
        manager.init();
    }
);
</code></pre>
<p><strong>控制角色移动：</strong></p>
<p>现在我们来学习如何来控制角色移动，我们希望按下左键角色向左移动，按下右键向右移动，按下空格键跳跃。首先，我们需要知道这些键的ASCII码值，左键：37；右键：39；空格：32。</p>
<p>使得角色移动和跳的方法是：move和jump。我们需要使得当相应建被按下后相应的方法被调用即可。勾挂键盘事件的是方法是在keyHandler.register（我们需要 gma/events 库）上：</p>
<pre><code class="js">
gma.keyHandler.register(<span class="hljs-number">37</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">keyEvent</span>) </span>{
    manager.character.move(gma.constants.LEFT, keyEvent);
});

gma.keyHandler.register(<span class="hljs-number">39</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">keyEvent</span>) </span>{
    manager.character.move(gma.constants.RIGHT, keyEvent);
});

gma.keyHandler.register(<span class="hljs-number">32</span>, manager.character.jump);

</code></pre>
<p>事实上，GammaJS提供了Curry函数来使得勾挂移动函数更为简单，下面f1是和f2等价的：</p>
<pre><code class="js">
f1 = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">keyEvent</span>) </span>{
    manager.character.move(gma.constants.LEFT, keyEvent);
};
f2 = manager.character.move.curry(gma.constants.LEFT);

</code></pre>
<p>因此上面的函数可以简单的写成：</p>
<pre><code class="js">gma.keyHandler.register(<span class="hljs-number">37</span>, manager.character.move.curry(gma.constants.LEFT));
gma.keyHandler.register(<span class="hljs-number">39</span>, manager.character.move.curry(gma.constants.RIGHT));
gma.keyHandler.register(<span class="hljs-number">32</span>, manager.character.jump);
</code></pre>
<p>现在我们game.js是这样的了:</p>
<pre><code class="js">
<span class="hljs-built_in">require</span>([
    <span class="hljs-string">'gma/base'</span>,
    <span class="hljs-string">'gma/manager'</span>,
    <span class="hljs-string">'gma/entities/character'</span>,
    <span class="hljs-string">'gma/events'</span>
],
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">gma</span>) </span>{
        <span class="hljs-keyword">var</span> manager = gma.manager({
            <span class="hljs-attr">width</span> : <span class="hljs-number">600</span>,
            <span class="hljs-attr">height</span> : <span class="hljs-number">500</span>
        });
        manager.character = gma.character({
            <span class="hljs-attr">left</span>     : <span class="hljs-number">0</span>,
            <span class="hljs-attr">bottom</span>   : <span class="hljs-number">0</span>,
            <span class="hljs-attr">width</span>    : <span class="hljs-number">3</span>,
            <span class="hljs-attr">height</span>   : <span class="hljs-number">6</span>,
            <span class="hljs-attr">depth</span>    : <span class="hljs-number">3</span>
        });

        <span class="hljs-keyword">var</span> myLevel = {
            <span class="hljs-attr">spawn</span> : {
                <span class="hljs-attr">main</span> : [<span class="hljs-number">15</span>, <span class="hljs-number">24</span>]
            },
            <span class="hljs-attr">entities</span> : [
                {<span class="hljs-attr">top</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">30</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>},
                {<span class="hljs-attr">top</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">36</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">30</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>}
            ]
        };
        manager.storeLevels(myLevel);

        gma.keyHandler.register(<span class="hljs-number">37</span>, manager.character.move.curry(gma.constants.LEFT));
        gma.keyHandler.register(<span class="hljs-number">39</span>, manager.character.move.curry(gma.constants.RIGHT));
        gma.keyHandler.register(<span class="hljs-number">32</span>, manager.character.jump);

        manager.init();
    }
);
</code></pre>
<p><strong>创建一个敌人</strong></p>
<p>有了一个主要角色，自然得有敌人，这样游戏才会具有一定的趣味性。所以，现在我们来创建一些敌人吧，GammaJS支持如下的敌人实体（每一种敌人有自己的习惯）：</p>
<ul>
<li>gma.platformEnemy: 从台子上一端移动到另端</li>
<li>gma.patrolEnemy: 在指定范围内巡视，需要制定巡视的范围：limitLeft和limitRight</li>
<li>gma.jumpingEnemy: 指定的位置上跳动的敌人</li>
</ul>
<pre><code class="js">
<span class="hljs-attr">entities</span> : [
    gma.platformEnemy({<span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">45</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">3</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">6</span>}),
    gma.patrolEnemy({<span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">6</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">3</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">6</span>, <span class="hljs-attr">limitLeft</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">limitRight</span>:<span class="hljs-number">12</span>}),
    gma.jumpingEnemy ({<span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">7</span>,  <span class="hljs-attr">width</span>:<span class="hljs-number">1</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">2</span>}),
    gma.jumpingEnemy ({<span class="hljs-attr">bottom</span>:<span class="hljs-number">3</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">8</span>,  <span class="hljs-attr">width</span>:<span class="hljs-number">1</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">2</span>}),
    gma.jumpingEnemy ({<span class="hljs-attr">bottom</span>:<span class="hljs-number">6</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">9</span>,  <span class="hljs-attr">width</span>:<span class="hljs-number">1</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">2</span>})
]
</code></pre>
<p>当许多敌人有相同的属性的时候，我们可以通过使用定制类型（addCustomDefinitions）来设置这些相同的属性，比如jumpingEnemy的宽度和高度都是1和2：</p>
<pre><code class="js">
manager.addCustomDefinitions({
    <span class="hljs-attr">types</span> : {
        <span class="hljs-attr">jumpingJack</span>: [<span class="hljs-string">'jumpingEnemy'</span>, {
            <span class="hljs-attr">width</span>    : <span class="hljs-number">1</span>,
            <span class="hljs-attr">height</span>   : <span class="hljs-number">2</span>
        }]
    }
});

</code></pre>
<p>定义自定类型后，我们就可以这样来使用：</p>
<pre><code class="js">
<span class="hljs-comment">// Now we can reference jumping jack</span>
<span class="hljs-attr">entities</span> : [
    gma.platformEnemy({<span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">45</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">3</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">6</span>}),
    gma.patrolEnemy({<span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">6</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">3</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">6</span>, <span class="hljs-attr">limitLeft</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">limitRight</span>:<span class="hljs-number">12</span>}),
    {<span class="hljs-attr">type</span>:<span class="hljs-string">'jumpingJack'</span>, <span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">21</span>},
    {<span class="hljs-attr">type</span>:<span class="hljs-string">'jumpingJack'</span>, <span class="hljs-attr">bottom</span>:<span class="hljs-number">3</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">24</span>},
    {<span class="hljs-attr">type</span>:<span class="hljs-string">'jumpingJack'</span>, <span class="hljs-attr">bottom</span>:<span class="hljs-number">6</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">27</span>}
]

</code></pre>
<p><strong>材质模板</strong></p>
<p>默认下，所有的实体会被作为蓝色的方块渲染，这个是通过实体的template属性控制的，template的默认值是cube：</p>
<pre><code class="js">manager.addCustomDefinitions({
    <span class="hljs-attr">types</span>: {
        <span class="hljs-attr">jumpingJack</span>: [<span class="hljs-string">'jumpingEnemy'</span>, {
            <span class="hljs-attr">width</span>    : <span class="hljs-number">1</span>,
            <span class="hljs-attr">height</span>   : <span class="hljs-number">2</span>
            <span class="hljs-attr">template</span> : <span class="hljs-string">'cube'</span>
        }]
    }
});

</code></pre>
<p>如果你希望定制实体的外观，你首先要在templates中创建自己的材质，下面是创建绿色的方块材质（greencube ）：</p>
<pre><code class="js">
manager.addCustomDefinitions({,
    <span class="hljs-attr">templates</span> : {
        <span class="hljs-attr">greencube</span> : [<span class="hljs-string">'meshTemplate'</span>, {
            <span class="hljs-attr">mesh</span> : gma.unitCubeInfo.mesh,
            <span class="hljs-attr">material</span> : {<span class="hljs-attr">color</span> : <span class="hljs-string">"#090"</span>}   <span class="hljs-comment">// Very Green</span>
        }]
    }
});

</code></pre>
<p>现在我们将greencube 应用到jumpingJack上：</p>
<pre><code class="js">
manager.addCustomDefinitions({
    <span class="hljs-attr">types</span> : {
        <span class="hljs-attr">jumpingJack</span>: [<span class="hljs-string">'jumpingEnemy'</span>, {
            <span class="hljs-attr">width</span>    : <span class="hljs-number">1</span>,
            <span class="hljs-attr">height</span>   : <span class="hljs-number">2</span>
            <span class="hljs-attr">template</span> : <span class="hljs-string">'greencube'</span>
        }]
    }
});

</code></pre>
<p><strong>注意</strong>：默认cube和 redcube已经在GammaJS中存在。</p>
<p>我们还可以给我们的方块加上贴图：</p>
<pre><code class="js">
manager.addCustomDefinitions({
    <span class="hljs-attr">templates</span> : {
        <span class="hljs-attr">brickscube</span> : [<span class="hljs-string">'meshTemplate'</span>, {
            <span class="hljs-attr">mesh</span> : gma.unitCubeInfo.mesh,
            <span class="hljs-attr">material</span> : {<span class="hljs-attr">texture</span> : <span class="hljs-string">'bricks.jpg'</span>}
        }]
    }
});

</code></pre>
<p><strong>注意</strong>： bricks.jpg必须在和html文件同一文件夹中.</p>
<p>如果希望贴图重复，使用repeatX,repeatY属性：</p>
<pre><code class="js">
manager.addCustomDefinitions({
    <span class="hljs-attr">templates</span> : {
        <span class="hljs-attr">brickscube</span> : [<span class="hljs-string">'meshTemplate'</span>, {
            <span class="hljs-attr">mesh</span> : gma.unitCubeInfo.mesh,
            <span class="hljs-attr">material</span> : {
                <span class="hljs-attr">texture</span> : <span class="hljs-string">'bricks.jpg'</span>,
                <span class="hljs-comment">//This will make the bricks double the size</span>
                <span class="hljs-attr">repeatX</span> : <span class="hljs-number">0.5</span>,
                <span class="hljs-attr">repeatY</span> : <span class="hljs-number">0.5</span>
            }
        }]
    }
});

</code></pre>
<p>OK，现在可以使用新的brickscube材质了：</p>
<pre><code class="js">
<span class="hljs-keyword">var</span> myLevel = {
    <span class="hljs-comment">//...,</span>
    <span class="hljs-attr">entities</span> : [
        {<span class="hljs-attr">template</span>:<span class="hljs-string">'brickscube'</span>, <span class="hljs-attr">top</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">30</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>},
        {<span class="hljs-attr">template</span>:<span class="hljs-string">'brickscube'</span>, <span class="hljs-attr">top</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">39</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">30</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>},
        <span class="hljs-comment">//...</span>
        <span class="hljs-comment">// Enemy specifications removed for clarity</span>
    ]
};

</code></pre>
<p>现在我们的game.js变成这样了：</p>
<pre><code class="js">
<span class="hljs-built_in">require</span>([
    <span class="hljs-string">'gma/base'</span>,
    <span class="hljs-string">'gma/manager'</span>,
    <span class="hljs-string">'gma/entities/character'</span>,
    <span class="hljs-string">'gma/events'</span>,
    <span class="hljs-string">'gma/entities/enemy'</span>
],
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">gma</span>) </span>{
        <span class="hljs-keyword">var</span> manager = gma.manager({
            <span class="hljs-attr">width</span> : <span class="hljs-number">600</span>,
            <span class="hljs-attr">height</span> : <span class="hljs-number">500</span>
        });
        manager.character = gma.character({
            <span class="hljs-attr">left</span>     : <span class="hljs-number">0</span>,
            <span class="hljs-attr">bottom</span>   : <span class="hljs-number">0</span>,
            <span class="hljs-attr">width</span>    : <span class="hljs-number">3</span>,
            <span class="hljs-attr">height</span>   : <span class="hljs-number">6</span>,
            <span class="hljs-attr">depth</span>    : <span class="hljs-number">3</span>
        });
        manager.addCustomDefinitions({
            <span class="hljs-attr">templates</span> : {
                <span class="hljs-attr">greencube</span> : [<span class="hljs-string">'meshTemplate'</span>, {
                    <span class="hljs-attr">mesh</span> : gma.unitCubeInfo.mesh,
                    <span class="hljs-attr">material</span> : {<span class="hljs-attr">color</span> : <span class="hljs-string">"#090"</span>}
                }],
                <span class="hljs-attr">brickscube</span> : [<span class="hljs-string">'meshTemplate'</span>, {
                    <span class="hljs-attr">mesh</span> : gma.unitCubeInfo.mesh,
                    <span class="hljs-attr">texture</span> : {
                        <span class="hljs-attr">src</span>:<span class="hljs-string">'bricks.jpg'</span>,
                        <span class="hljs-attr">repeatX</span>:<span class="hljs-number">0.5</span>,
                        <span class="hljs-attr">repeatY</span>:<span class="hljs-number">0.5</span>
                    }
                }]
            },

            <span class="hljs-attr">types</span> : {
                <span class="hljs-attr">jumpingJack</span>: [<span class="hljs-string">'jumpingEnemy'</span>, {
                    <span class="hljs-attr">width</span>    : <span class="hljs-number">1</span>,
                    <span class="hljs-attr">height</span>   : <span class="hljs-number">2</span>,
                    <span class="hljs-attr">template</span> : <span class="hljs-string">'greencube'</span>
                }]
            }
        });

        <span class="hljs-keyword">var</span> myLevel = {
            <span class="hljs-attr">spawn</span> : {
                <span class="hljs-attr">main</span> : [<span class="hljs-number">15</span>, <span class="hljs-number">24</span>]
            },
            <span class="hljs-attr">camera</span> : {
                <span class="hljs-attr">attached</span> : [<span class="hljs-string">'character'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">60</span>]
            },
            <span class="hljs-attr">light</span> : {
                <span class="hljs-attr">myLight</span> : {
                     <span class="hljs-attr">type</span> : GLGE.L_POINT,
                     <span class="hljs-attr">rotY</span> : <span class="hljs-number">1.54</span>,
                     <span class="hljs-attr">color</span>    : <span class="hljs-string">"#fff"</span>,
                     <span class="hljs-attr">attached</span> : [<span class="hljs-string">'character'</span>, <span class="hljs-number">0</span>,<span class="hljs-number">5</span>,<span class="hljs-number">20</span>]
                }
             },
            <span class="hljs-attr">entities</span> : [
                {<span class="hljs-attr">template</span>:<span class="hljs-string">'brickscube'</span>, <span class="hljs-attr">top</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">30</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>},
                {<span class="hljs-attr">template</span>:<span class="hljs-string">'brickscube'</span>, <span class="hljs-attr">top</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">39</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">30</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>},
                gma.platformEnemy({<span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">45</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">3</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">6</span>}),
                gma.patrolEnemy({<span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">6</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">3</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">6</span>, <span class="hljs-attr">limitLeft</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">limitRight</span>:<span class="hljs-number">12</span>}),
                {<span class="hljs-attr">type</span>:<span class="hljs-string">'jumpingJack'</span>, <span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">21</span>},
                {<span class="hljs-attr">type</span>:<span class="hljs-string">'jumpingJack'</span>, <span class="hljs-attr">bottom</span>:<span class="hljs-number">3</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">24</span>},
                {<span class="hljs-attr">type</span>:<span class="hljs-string">'jumpingJack'</span>, <span class="hljs-attr">bottom</span>:<span class="hljs-number">6</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">27</span>}
            ]
        };
        manager.storeLevels(myLevel);

        gma.keyHandler.register(<span class="hljs-number">37</span>, manager.character.move.curry(gma.constants.LEFT));
        gma.keyHandler.register(<span class="hljs-number">39</span>, manager.character.move.curry(gma.constants.RIGHT));
        gma.keyHandler.register(<span class="hljs-number">32</span>, manager.character.jump);

        manager.init();
    }
);

</code></pre>
<p><strong>定制摄像机</strong></p>
<p>Gamma默认的摄像机总是跟随这角色的移动离角色面前50个距离单位和z轴的50个距离单位。你可以改变某个level中的摄像机的属性：</p>
<pre><code class="js">
<span class="hljs-keyword">var</span> myLevel = {
     <span class="hljs-attr">camera</span> : {
         <span class="hljs-attr">locZ</span> : <span class="hljs-number">60</span>,
          <span class="hljs-comment">//跟随指定的角色在指定的位置 x,y[,z]</span>
         <span class="hljs-attr">attached</span> : [<span class="hljs-string">'character'</span>,<span class="hljs-number">0</span>, <span class="hljs-number">6</span>]
     }
 };

</code></pre>
<p><strong>要有灯光</strong></p>
<p>在游戏中在指定的level中添加灯光：</p>
<pre><code class="js"><span class="hljs-keyword">var</span> myLevel = {
    <span class="hljs-attr">light</span> : {
        <span class="hljs-attr">myLight</span> : {
            <span class="hljs-attr">type</span> : GLGE.L_POINT,
            <span class="hljs-attr">rotY</span> : <span class="hljs-number">1.54</span>,
            <span class="hljs-attr">color</span>    : <span class="hljs-string">"#fff"</span>,
            <span class="hljs-attr">attached</span> : [<span class="hljs-string">'character'</span>, <span class="hljs-number">0</span>,<span class="hljs-number">5</span>,<span class="hljs-number">20</span>]
        }
    }
};
</code></pre>
<p>上面我们定了一个白色(#fff)的点光源(point light)，它始终在角色的前面5个单位，上面20个单位。我们把这个点光源旋转了180度(1.54 弧度radians)以指向场景.</p>
<p>用方块作为主角似乎太丑了，怎么着也得整个猩猩模型来着，GammaJS支持Collada模型定义，<a href="https://collada.org/" target="_blank" rel="noopener">Collada</a>是开放的标准xml模型定义格式。大多数的3D模型应用支持导出成这样的格式(.dae)文件。</p>
<p>你可以下载猩猩模型：<a href="https://github.com/Royce/GammaJS/raw/master/media/collada/gorilla/gorilla.dae" target="_blank" rel="noopener">https://github.com/Royce/GammaJS/raw/master/media/collada/gorilla/gorilla.dae</a>,<br>
以及对应的贴图文件：<a href="https://github.com/Royce/GammaJS/raw/master/media/collada/gorilla/skin.jpg" target="_blank" rel="noopener">https://github.com/Royce/GammaJS/raw/master/media/collada/gorilla/skin.jpg</a></p>
<p>假定下载的文件放在和html文件同一目录下，现在可以把我们的大猩猩放在templates里了：</p>
<pre><code class="js">manager.addCustomDefinitions({
    <span class="hljs-attr">templates</span> : {
        <span class="hljs-attr">gorilla</span> : [<span class="hljs-string">'colladaTemplate'</span>,
            {
                <span class="hljs-attr">collada</span> : {
                    <span class="hljs-attr">document</span> : <span class="hljs-string">'gorilla.dae'</span>
                }
            }
        ]
    }
})
</code></pre>
<p>不过我们要调整下，大猩猩的位置不对，中心不对，因此我们把它转180度，移动0.5个unit,缩放0.7倍。</p>
<pre><code class="js">manager.addCustomDefinitions({
    <span class="hljs-attr">templates</span> : {
        <span class="hljs-attr">gorilla</span> : [<span class="hljs-string">'colladaTemplate'</span>,
            {
                <span class="hljs-attr">collada</span> : {
                    <span class="hljs-attr">document</span> : <span class="hljs-string">'gorilla.dae'</span>
                },
                <span class="hljs-attr">yRot</span> : <span class="hljs-number">1.57</span>,
                <span class="hljs-attr">yOffset</span> : <span class="hljs-number">-0.5</span>,
                <span class="hljs-attr">yScale</span> : <span class="hljs-number">0.7</span>
            }
        ]
    }
})
</code></pre>
<p>ok，将大猩猩应用到角色：</p>
<pre><code class="js">manager.character = gma.character({
    <span class="hljs-attr">left</span>     : <span class="hljs-number">0</span>,
    <span class="hljs-attr">bottom</span>   : <span class="hljs-number">0</span>,
    <span class="hljs-attr">width</span>    : <span class="hljs-number">3</span>,
    <span class="hljs-attr">height</span>   : <span class="hljs-number">6</span>,
    <span class="hljs-attr">depth</span>    : <span class="hljs-number">3</span>,
    <span class="hljs-attr">template</span> : <span class="hljs-string">'gorilla'</span>
});
</code></pre>
<p>好了，如今，再看看我们的game.js：</p>
<pre><code class="js"><span class="hljs-built_in">require</span>([
    <span class="hljs-string">'gma/base'</span>,
    <span class="hljs-string">'gma/manager'</span>,
    <span class="hljs-string">'gma/entities/character'</span>,
    <span class="hljs-string">'gma/events'</span>,
    <span class="hljs-string">'gma/entities/enemy'</span>
],
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">gma</span>) </span>{
        <span class="hljs-keyword">var</span> manager = gma.manager({
            <span class="hljs-attr">width</span> : <span class="hljs-number">600</span>,
            <span class="hljs-attr">height</span> : <span class="hljs-number">500</span>
        });
        manager.character = gma.character({
            <span class="hljs-attr">left</span>     : <span class="hljs-number">0</span>,
            <span class="hljs-attr">bottom</span>   : <span class="hljs-number">0</span>,
            <span class="hljs-attr">width</span>    : <span class="hljs-number">3</span>,
            <span class="hljs-attr">height</span>   : <span class="hljs-number">6</span>,
            <span class="hljs-attr">depth</span>    : <span class="hljs-number">3</span>,
            <span class="hljs-attr">template</span> : <span class="hljs-string">'gorilla'</span>
        });
        manager.addCustomDefinitions({
            <span class="hljs-attr">templates</span> : {
                <span class="hljs-attr">greencube</span> : [<span class="hljs-string">'meshTemplate'</span>, {
                    <span class="hljs-attr">mesh</span> : gma.unitCubeInfo.mesh,
                    <span class="hljs-attr">material</span> : {<span class="hljs-attr">color</span> : <span class="hljs-string">"#090"</span>}
                }],
                <span class="hljs-attr">brickscube</span> : [<span class="hljs-string">'meshTemplate'</span>, {
                    <span class="hljs-attr">mesh</span> : gma.unitCubeInfo.mesh,
                    <span class="hljs-attr">texture</span> : {
                        <span class="hljs-attr">src</span>:<span class="hljs-string">'bricks.jpg'</span>,
                        <span class="hljs-attr">repeatX</span>:<span class="hljs-number">0.5</span>,
                        <span class="hljs-attr">repeatY</span>:<span class="hljs-number">0.5</span>
                    }
                }],
                <span class="hljs-attr">gorilla</span> : [<span class="hljs-string">'colladaTemplate'</span>,
                    {
                        <span class="hljs-attr">collada</span> : {
                            <span class="hljs-attr">document</span> : <span class="hljs-string">'gorilla.dae'</span>
                        },
                        <span class="hljs-attr">yRot</span> : <span class="hljs-number">1.57</span>,
                        <span class="hljs-attr">yOffset</span> : <span class="hljs-number">-0.5</span>,
                        <span class="hljs-attr">yScale</span> : <span class="hljs-number">0.7</span>
                    }
                ]
            },

            <span class="hljs-attr">types</span> : {
                <span class="hljs-attr">jumpingJack</span>: [<span class="hljs-string">'jumpingEnemy'</span>, {
                    <span class="hljs-attr">width</span>    : <span class="hljs-number">1</span>,
                    <span class="hljs-attr">height</span>   : <span class="hljs-number">2</span>,
                    <span class="hljs-attr">template</span> : <span class="hljs-string">'greencube'</span>
                }]
            }
        });

        <span class="hljs-keyword">var</span> myLevel = {
            <span class="hljs-attr">spawn</span> : {
                <span class="hljs-attr">main</span> : [<span class="hljs-number">15</span>, <span class="hljs-number">24</span>]
            },
            <span class="hljs-attr">camera</span> : {
                <span class="hljs-attr">attached</span> : [<span class="hljs-string">'character'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">60</span>]
            },
            <span class="hljs-attr">light</span> : {
                <span class="hljs-attr">myLight</span> : {
                     <span class="hljs-attr">type</span> : GLGE.L_POINT,
                     <span class="hljs-attr">rotY</span> : <span class="hljs-number">1.54</span>,
                     <span class="hljs-attr">color</span>    : <span class="hljs-string">"#fff"</span>,
                     <span class="hljs-attr">attached</span> : [<span class="hljs-string">'character'</span>, <span class="hljs-number">0</span>,<span class="hljs-number">5</span>,<span class="hljs-number">20</span>]
                }
             },
            <span class="hljs-attr">entities</span> : [
                {<span class="hljs-attr">template</span>:<span class="hljs-string">'brickscube'</span>, <span class="hljs-attr">top</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">30</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>},
                {<span class="hljs-attr">template</span>:<span class="hljs-string">'brickscube'</span>, <span class="hljs-attr">top</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">39</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">30</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>},
                gma.platformEnemy({<span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">45</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">3</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">6</span>}),
                gma.patrolEnemy({<span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">6</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">3</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">6</span>, <span class="hljs-attr">limitLeft</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">limitRight</span>:<span class="hljs-number">12</span>}),
                {<span class="hljs-attr">type</span>:<span class="hljs-string">'jumpingJack'</span>, <span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">21</span>},
                {<span class="hljs-attr">type</span>:<span class="hljs-string">'jumpingJack'</span>, <span class="hljs-attr">bottom</span>:<span class="hljs-number">3</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">24</span>},
                {<span class="hljs-attr">type</span>:<span class="hljs-string">'jumpingJack'</span>, <span class="hljs-attr">bottom</span>:<span class="hljs-number">6</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">27</span>}
            ]
        };
        manager.storeLevels(myLevel);

        gma.keyHandler.register(<span class="hljs-number">37</span>, manager.character.move.curry(gma.constants.LEFT));
        gma.keyHandler.register(<span class="hljs-number">39</span>, manager.character.move.curry(gma.constants.RIGHT));
        gma.keyHandler.register(<span class="hljs-number">32</span>, manager.character.jump);

        manager.init();
    }
);
</code></pre>
<p>一个游戏肯定应该是有多个level的，如何定义多个level呢？很简单：</p>
<pre><code class="js"><span class="hljs-keyword">var</span> myLevel = {
    <span class="hljs-comment">//specification</span>
};
<span class="hljs-keyword">var</span> anotherLevel = {
    <span class="hljs-comment">//specification</span>
};
</code></pre>
<p>然后在初始化函数中：</p>
<pre><code class="js">manager.storeLevels(myLevel);
manager.storeLevels(anotherLevel);
</code></pre>
<p>或者这样：</p>
<pre><code class="js">manager.storeLevels([myLevel, anotherLevel]);
</code></pre>
<p>当mananger初始化的时候，首先是第一个level会被载入。然后我们只需要从一个level进入另一个level，这被称为门（door），下面演示如何创建一个门：</p>
<pre><code class="js">entities : [
    gma.door({
        <span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">5</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">3</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>,
        <span class="hljs-attr">level</span>:<span class="hljs-number">1</span>
    })
]
</code></pre>
<p>注意：level 的索引是从0开始的。所以上面的level＝1是进入的第二个level（anotherLevel），现在我们来正式创建anotherLevel，它有一个门返回到第一个level：</p>
<pre><code class="js"><span class="hljs-keyword">var</span> otherLevel = {
    <span class="hljs-attr">spawn</span> : {
        <span class="hljs-attr">main</span> : [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>]
    },
    <span class="hljs-attr">camera</span> : {
        <span class="hljs-attr">attached</span> : [<span class="hljs-string">'character'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">60</span>]
    },
    <span class="hljs-attr">light</span> : {
        <span class="hljs-attr">myLight</span> : {
             <span class="hljs-attr">type</span> : GLGE.L_POINT,
             <span class="hljs-attr">rotY</span> : <span class="hljs-number">1.54</span>,
             <span class="hljs-attr">color</span>    : <span class="hljs-string">"#fff"</span>,
             <span class="hljs-attr">attached</span> : [<span class="hljs-string">'character'</span>, <span class="hljs-number">0</span>,<span class="hljs-number">5</span>,<span class="hljs-number">20</span>]
        }
     },
    <span class="hljs-attr">entities</span> : [
        gma.door({<span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">25</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">0.5</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">9</span>, <span class="hljs-attr">level</span>:<span class="hljs-number">0</span>}),
        {<span class="hljs-attr">template</span>:<span class="hljs-string">'brickscube'</span>, <span class="hljs-attr">top</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">30</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>}
    ]
};
</code></pre>
<p>好了，到现在为止，在我们的game.js中有两个level了：</p>
<pre><code class="js"><span class="hljs-built_in">require</span>([
    <span class="hljs-string">'gma/base'</span>,
    <span class="hljs-string">'gma/manager'</span>,
    <span class="hljs-string">'gma/entities/character'</span>,
    <span class="hljs-string">'gma/events'</span>,
    <span class="hljs-string">'gma/entities/enemy'</span>,
    <span class="hljs-string">'gma/entities/door'</span>
],
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">gma</span>) </span>{
        <span class="hljs-keyword">var</span> manager = gma.manager({
            <span class="hljs-attr">width</span> : <span class="hljs-number">600</span>,
            <span class="hljs-attr">height</span> : <span class="hljs-number">500</span>
        });
        manager.character = gma.character({
            <span class="hljs-attr">left</span>     : <span class="hljs-number">0</span>,
            <span class="hljs-attr">bottom</span>   : <span class="hljs-number">0</span>,
            <span class="hljs-attr">width</span>    : <span class="hljs-number">3</span>,
            <span class="hljs-attr">height</span>   : <span class="hljs-number">6</span>,
            <span class="hljs-attr">depth</span>    : <span class="hljs-number">3</span>,
            <span class="hljs-attr">template</span> : <span class="hljs-string">'gorilla'</span>
        });
        manager.addCustomDefinitions({
            <span class="hljs-attr">templates</span> : {
                <span class="hljs-attr">greencube</span> : [<span class="hljs-string">'meshTemplate'</span>, {
                    <span class="hljs-attr">mesh</span> : gma.unitCubeInfo.mesh,
                    <span class="hljs-attr">material</span> : {<span class="hljs-attr">color</span> : <span class="hljs-string">"#090"</span>}
                }],
                <span class="hljs-attr">gorilla</span> : [<span class="hljs-string">'colladaTemplate'</span>,
                {
                    <span class="hljs-attr">collada</span> : {
                        <span class="hljs-attr">document</span> : <span class="hljs-string">'gorilla.dae'</span>
                    },
                    <span class="hljs-attr">yRot</span> : <span class="hljs-number">1.57</span>,
                    <span class="hljs-attr">yOffset</span> : <span class="hljs-number">-0.5</span>,
                    <span class="hljs-attr">yScale</span>:<span class="hljs-number">0.7</span>
                }],
                <span class="hljs-attr">brickscube</span> : [<span class="hljs-string">'meshTemplate'</span>, {
                    <span class="hljs-attr">mesh</span> : gma.unitCubeInfo.mesh,
                    <span class="hljs-attr">texture</span> : {
                        <span class="hljs-attr">src</span>:<span class="hljs-string">'bricks.jpg'</span>,
                        <span class="hljs-attr">repeatX</span>:<span class="hljs-number">0.5</span>,
                        <span class="hljs-attr">repeatY</span>:<span class="hljs-number">0.5</span>
                    }
                }]
            },

            <span class="hljs-attr">types</span> : {
                <span class="hljs-attr">jumpingJack</span>: [<span class="hljs-string">'jumpingEnemy'</span>, {
                    <span class="hljs-attr">width</span>    : <span class="hljs-number">1</span>,
                    <span class="hljs-attr">height</span>   : <span class="hljs-number">2</span>,
                    <span class="hljs-attr">template</span> : <span class="hljs-string">'greencube'</span>
                }]
            }
        });

        <span class="hljs-keyword">var</span> myLevel = {
            <span class="hljs-attr">spawn</span> : {
                <span class="hljs-attr">main</span> : [<span class="hljs-number">15</span>, <span class="hljs-number">24</span>]
            },
            <span class="hljs-attr">camera</span> : {
                <span class="hljs-attr">attached</span> : [<span class="hljs-string">'character'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">60</span>]
            },
            <span class="hljs-attr">light</span> : {
                <span class="hljs-attr">myLight</span> : {
                     <span class="hljs-attr">type</span> : GLGE.L_POINT,
                     <span class="hljs-attr">rotY</span> : <span class="hljs-number">1.54</span>,
                     <span class="hljs-attr">color</span>    : <span class="hljs-string">"#fff"</span>,
                     <span class="hljs-attr">attached</span> : [<span class="hljs-string">'character'</span>, <span class="hljs-number">0</span>,<span class="hljs-number">5</span>,<span class="hljs-number">20</span>]
                }
             },
            <span class="hljs-attr">entities</span> : [
                gma.door({<span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">55</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">0.5</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">9</span>, <span class="hljs-attr">level</span>:<span class="hljs-number">1</span>}),
                {<span class="hljs-attr">template</span>:<span class="hljs-string">'brickscube'</span>, <span class="hljs-attr">top</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">30</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>},
                {<span class="hljs-attr">template</span>:<span class="hljs-string">'brickscube'</span>, <span class="hljs-attr">top</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">39</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">30</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>},
                gma.platformEnemy({<span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">45</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">3</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">6</span>}),
                gma.patrolEnemy({<span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">6</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">3</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">6</span>, <span class="hljs-attr">limitLeft</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">limitRight</span>:<span class="hljs-number">12</span>}),
                {<span class="hljs-attr">type</span>:<span class="hljs-string">'jumpingJack'</span>, <span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">21</span>},
                {<span class="hljs-attr">type</span>:<span class="hljs-string">'jumpingJack'</span>, <span class="hljs-attr">bottom</span>:<span class="hljs-number">3</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">24</span>},
                {<span class="hljs-attr">type</span>:<span class="hljs-string">'jumpingJack'</span>, <span class="hljs-attr">bottom</span>:<span class="hljs-number">6</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">27</span>}
            ]
        };

        <span class="hljs-keyword">var</span> otherLevel = {
            <span class="hljs-attr">spawn</span> : {
                <span class="hljs-attr">main</span> : [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>]
            },
            <span class="hljs-attr">camera</span> : {
                <span class="hljs-attr">attached</span> : [<span class="hljs-string">'character'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">60</span>]
            },
            <span class="hljs-attr">light</span> : {
                <span class="hljs-attr">myLight</span> : {
                     <span class="hljs-attr">type</span> : GLGE.L_POINT,
                     <span class="hljs-attr">rotY</span> : <span class="hljs-number">1.54</span>,
                     <span class="hljs-attr">color</span>    : <span class="hljs-string">"#fff"</span>,
                     <span class="hljs-attr">attached</span> : [<span class="hljs-string">'character'</span>, <span class="hljs-number">0</span>,<span class="hljs-number">5</span>,<span class="hljs-number">20</span>]
                }
             },
            <span class="hljs-attr">entities</span> : [
                gma.door({<span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">25</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">0.5</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">9</span>, <span class="hljs-attr">level</span>:<span class="hljs-number">0</span>}),
                {<span class="hljs-attr">template</span>:<span class="hljs-string">'brickscube'</span>, <span class="hljs-attr">top</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">30</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>}
            ]
        };

        manager.storeLevels(myLevel);
        manager.storeLevels(otherLevel);

        gma.keyHandler.register(<span class="hljs-number">37</span>, manager.character.move.curry(gma.constants.LEFT));
        gma.keyHandler.register(<span class="hljs-number">39</span>, manager.character.move.curry(gma.constants.RIGHT));
        gma.keyHandler.register(<span class="hljs-number">32</span>, manager.character.jump);
        manager.init();
    }
);
</code></pre>
<p>我们现在还需要什么？还少一个显示的HUP（Heads Up Display），让我们在右下角显示FPS：</p>
<pre><code class="js">manager.hud.setup({
    <span class="hljs-attr">bottom_right</span>: {
        <span class="hljs-attr">fps</span> : manager.getFPS
    }
});
</code></pre>
<p>HUD的显示类型可由CSS控制:</p>
<pre><code class="css"><span class="hljs-comment">/* Setup the bars */</span>

<span class="hljs-selector-id">#top_hud</span>, <span class="hljs-selector-id">#bottom_hud</span> {
    <span class="hljs-attribute">height</span>:<span class="hljs-number">2em</span>;
    <span class="hljs-attribute">position</span>:absolute;
    <span class="hljs-attribute">left</span>:<span class="hljs-number">0em</span>;
    <span class="hljs-attribute">width</span>:<span class="hljs-number">100%</span>;
    <span class="hljs-attribute">background-color</span>: black;
    <span class="hljs-attribute">color</span>: white;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgba</span>(0, 0, 0, 0.7);
}

<span class="hljs-selector-id">#top_hud</span> {
    <span class="hljs-attribute">top</span>:<span class="hljs-number">0em</span>;
}
<span class="hljs-selector-id">#bottom_hud</span> {
    <span class="hljs-attribute">bottom</span>:<span class="hljs-number">0em</span>;
}

<span class="hljs-comment">/* Setup left and right part of each bar */</span>

<span class="hljs-selector-id">#bottom_hud</span> <span class="hljs-selector-tag">dl</span>, <span class="hljs-selector-id">#top_hud</span> <span class="hljs-selector-tag">dl</span> {
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0.3em</span>;
}

<span class="hljs-selector-id">#bottom_hud</span> <span class="hljs-selector-tag">dl</span><span class="hljs-selector-class">.left</span>, <span class="hljs-selector-id">#top_hud</span> <span class="hljs-selector-tag">dl</span><span class="hljs-selector-class">.left</span> {
    <span class="hljs-attribute">float</span>: left;
}
<span class="hljs-selector-id">#bottom_hud</span> <span class="hljs-selector-tag">dl</span><span class="hljs-selector-class">.right</span>, <span class="hljs-selector-id">#top_hud</span> <span class="hljs-selector-tag">dl</span><span class="hljs-selector-class">.right</span> {
    <span class="hljs-attribute">float</span>: right;
}

<span class="hljs-comment">/* Setup labels for each item */</span>

<span class="hljs-selector-id">#bottom_hud</span> <span class="hljs-selector-tag">dt</span>, <span class="hljs-selector-id">#top_hud</span> <span class="hljs-selector-tag">dt</span>,
<span class="hljs-selector-id">#bottom_hud</span> <span class="hljs-selector-tag">dd</span>, <span class="hljs-selector-id">#top_hud</span> <span class="hljs-selector-tag">dd</span> {
    <span class="hljs-attribute">display</span>: inline-block;
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.4em</span>;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
}

<span class="hljs-selector-id">#bottom_hud</span> <span class="hljs-selector-tag">dt</span>, <span class="hljs-selector-id">#top_hud</span> <span class="hljs-selector-tag">dt</span> {
    <span class="hljs-attribute">padding-right</span>: <span class="hljs-number">0.5em</span>;
}

<span class="hljs-selector-id">#bottom_hud</span> <span class="hljs-selector-tag">dd</span>, <span class="hljs-selector-id">#top_hud</span> <span class="hljs-selector-tag">dd</span> {
    <span class="hljs-attribute">text-align</span>: right;
}
<span class="hljs-selector-tag">dl</span><span class="hljs-selector-class">.left</span> <span class="hljs-selector-tag">dd</span> {
    <span class="hljs-attribute">padding-right</span>: <span class="hljs-number">1em</span>;
}
<span class="hljs-selector-tag">dl</span><span class="hljs-selector-class">.right</span> <span class="hljs-selector-tag">dt</span> {
    <span class="hljs-attribute">padding-left</span>: <span class="hljs-number">1em</span>;
}
</code></pre>
<p>将这个CSS保存为game.css文件放在game.js所在的目录下，取消html中的注释：</p>
<pre><code class="html"><span class="hljs-comment">&lt;!--
    Include any style sheets here
    &lt;link rel="stylesheet" type="text/css" href="gamma.css" media="all"/&gt;
--&gt;</span>
</code></pre>
<p>ok，现在是这个没啥意思的游戏最后一个，当前，如果角色如果从台子上掉了下去，那么角色就会处于永远的掉之中，不会结束。怎么停止这个状态？很简单，在台子下面放一个“死亡台子”（deathPlatform），只要角色掉在这个台子上就会被杀掉：</p>
<pre><code class="js"><span class="hljs-comment">// Create a deathplatform type</span>
<span class="hljs-attr">types</span> : {
    <span class="hljs-attr">lava</span> : [<span class="hljs-string">'deathPlatform'</span>, {<span class="hljs-attr">template</span> : <span class="hljs-string">'redcube'</span>, <span class="hljs-attr">depth</span>:<span class="hljs-number">50</span>}]
}
<span class="hljs-comment">// Add this lava / death platform to the list of entities</span>
<span class="hljs-attr">entities</span> : [
    {<span class="hljs-attr">type</span>:<span class="hljs-string">'lava'</span>, <span class="hljs-attr">top</span>:<span class="hljs-number">-10</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">-50</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">1000</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">50</span>},
]
</code></pre>
<p>当角色死掉后，怎么重生呢？我们将重生的过程绑定到按键“r”上，当按下“r”就让角色重生：</p>
<pre><code class="js">gma.keyHandler.register(<span class="hljs-number">82</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
    manager.respawn(<span class="hljs-string">"main"</span>);
});
</code></pre>
<p>现在，我们终于完成了我们的游戏：</p>
<pre><code class="js"><span class="hljs-built_in">require</span>([
    <span class="hljs-string">'gma/base'</span>,
    <span class="hljs-string">'gma/manager'</span>,
    <span class="hljs-string">'gma/entities/character'</span>,
    <span class="hljs-string">'gma/events'</span>,
    <span class="hljs-string">'gma/entities/enemy'</span>,
    <span class="hljs-string">'gma/entities/door'</span>
],
    <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">gma</span>) </span>{
        <span class="hljs-keyword">var</span> manager = gma.manager({
            <span class="hljs-attr">width</span> : <span class="hljs-number">600</span>,
            <span class="hljs-attr">height</span> : <span class="hljs-number">500</span>
        });
        manager.character = gma.character({
            <span class="hljs-attr">left</span>     : <span class="hljs-number">0</span>,
            <span class="hljs-attr">bottom</span>   : <span class="hljs-number">0</span>,
            <span class="hljs-attr">width</span>    : <span class="hljs-number">3</span>,
            <span class="hljs-attr">height</span>   : <span class="hljs-number">6</span>,
            <span class="hljs-attr">depth</span>    : <span class="hljs-number">3</span>,
            <span class="hljs-attr">template</span> : <span class="hljs-string">'gorilla'</span>
        });
        manager.addCustomDefinitions({
            <span class="hljs-attr">templates</span> : {
                <span class="hljs-attr">greencube</span> : [<span class="hljs-string">'meshTemplate'</span>, {
                    <span class="hljs-attr">mesh</span> : gma.unitCubeInfo.mesh,
                    <span class="hljs-attr">material</span> : {<span class="hljs-attr">color</span> : <span class="hljs-string">"#090"</span>}
                }],
                <span class="hljs-attr">gorilla</span> : [<span class="hljs-string">'colladaTemplate'</span>,
                {
                    <span class="hljs-attr">collada</span> : {
                        <span class="hljs-attr">document</span> : <span class="hljs-string">'gorilla.dae'</span>
                    },
                    <span class="hljs-attr">yRot</span> : <span class="hljs-number">1.57</span>,
                    <span class="hljs-attr">yOffset</span> : <span class="hljs-number">-0.5</span>,
                    <span class="hljs-attr">yScale</span>:<span class="hljs-number">0.7</span>
                }],
                <span class="hljs-attr">brickscube</span> : [<span class="hljs-string">'meshTemplate'</span>, {
                    <span class="hljs-attr">mesh</span> : gma.unitCubeInfo.mesh,
                    <span class="hljs-attr">texture</span> : {
                        <span class="hljs-attr">src</span>:<span class="hljs-string">'bricks.jpg'</span>,
                        <span class="hljs-attr">repeatX</span>:<span class="hljs-number">0.5</span>,
                        <span class="hljs-attr">repeatY</span>:<span class="hljs-number">0.5</span>
                    }
                }]
            },

            <span class="hljs-attr">types</span> : {
                <span class="hljs-attr">jumpingJack</span>: [<span class="hljs-string">'jumpingEnemy'</span>, {
                    <span class="hljs-attr">width</span>    : <span class="hljs-number">1</span>,
                    <span class="hljs-attr">height</span>   : <span class="hljs-number">2</span>,
                    <span class="hljs-attr">template</span> : <span class="hljs-string">'greencube'</span>
                }],
                <span class="hljs-attr">lava</span> : [<span class="hljs-string">'deathPlatform'</span>, {<span class="hljs-attr">template</span> : <span class="hljs-string">'redcube'</span>, <span class="hljs-attr">depth</span>:<span class="hljs-number">50</span>}]
            }

        });

        manager.hud.setup({
            <span class="hljs-attr">bottom_right</span>: {
                <span class="hljs-attr">fps</span> : manager.getFPS
            }
        });

        <span class="hljs-keyword">var</span> myLevel = {
            <span class="hljs-attr">spawn</span> : {
                <span class="hljs-attr">main</span> : [<span class="hljs-number">15</span>, <span class="hljs-number">24</span>]
            },
            <span class="hljs-attr">camera</span> : {
                <span class="hljs-attr">attached</span> : [<span class="hljs-string">'character'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">60</span>]
            },
            <span class="hljs-attr">light</span> : {
                <span class="hljs-attr">myLight</span> : {
                     <span class="hljs-attr">type</span> : GLGE.L_POINT,
                     <span class="hljs-attr">rotY</span> : <span class="hljs-number">1.54</span>,
                     <span class="hljs-attr">color</span>    : <span class="hljs-string">"#fff"</span>,
                     <span class="hljs-attr">attached</span> : [<span class="hljs-string">'character'</span>, <span class="hljs-number">0</span>,<span class="hljs-number">5</span>,<span class="hljs-number">20</span>]
                }
             },
            <span class="hljs-attr">entities</span> : [
                gma.door({<span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">55</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">0.5</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">9</span>, <span class="hljs-attr">level</span>:<span class="hljs-number">1</span>}),
                {<span class="hljs-attr">template</span>:<span class="hljs-string">'brickscube'</span>, <span class="hljs-attr">top</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">30</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>},
                {<span class="hljs-attr">template</span>:<span class="hljs-string">'brickscube'</span>, <span class="hljs-attr">top</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">39</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">30</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>},
                {<span class="hljs-attr">type</span>:<span class="hljs-string">'deathPlatform'</span>, <span class="hljs-attr">top</span>:<span class="hljs-number">-10</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">-50</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">1000</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">50</span>, <span class="hljs-attr">depth</span>:<span class="hljs-number">50</span>},
                gma.platformEnemy({<span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">45</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">3</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">6</span>}),
                gma.patrolEnemy({<span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">6</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">3</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">6</span>, <span class="hljs-attr">limitLeft</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">limitRight</span>:<span class="hljs-number">12</span>}),
                {<span class="hljs-attr">type</span>:<span class="hljs-string">'jumpingJack'</span>, <span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">21</span>},
                {<span class="hljs-attr">type</span>:<span class="hljs-string">'jumpingJack'</span>, <span class="hljs-attr">bottom</span>:<span class="hljs-number">3</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">24</span>},
                {<span class="hljs-attr">type</span>:<span class="hljs-string">'jumpingJack'</span>, <span class="hljs-attr">bottom</span>:<span class="hljs-number">6</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">27</span>}
            ]
        };

        <span class="hljs-keyword">var</span> otherLevel = {
            <span class="hljs-attr">spawn</span> : {
                <span class="hljs-attr">main</span> : [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>]
            },
            <span class="hljs-attr">camera</span> : {
                <span class="hljs-attr">attached</span> : [<span class="hljs-string">'character'</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>, <span class="hljs-number">60</span>]
            },
            <span class="hljs-attr">light</span> : {
                <span class="hljs-attr">myLight</span> : {
                     <span class="hljs-attr">type</span> : GLGE.L_POINT,
                     <span class="hljs-attr">rotY</span> : <span class="hljs-number">1.54</span>,
                     <span class="hljs-attr">color</span>    : <span class="hljs-string">"#fff"</span>,
                     <span class="hljs-attr">attached</span> : [<span class="hljs-string">'character'</span>, <span class="hljs-number">0</span>,<span class="hljs-number">5</span>,<span class="hljs-number">20</span>]
                }
             },
            <span class="hljs-attr">entities</span> : [
                gma.door({<span class="hljs-attr">bottom</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">25</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">0.5</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">9</span>, <span class="hljs-attr">level</span>:<span class="hljs-number">0</span>}),
                {<span class="hljs-attr">template</span>:<span class="hljs-string">'brickscube'</span>, <span class="hljs-attr">top</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">0</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">30</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">3</span>},
                {<span class="hljs-attr">type</span>:<span class="hljs-string">'deathPlatform'</span>, <span class="hljs-attr">top</span>:<span class="hljs-number">-10</span>, <span class="hljs-attr">left</span>:<span class="hljs-number">-50</span>, <span class="hljs-attr">width</span>:<span class="hljs-number">1000</span>, <span class="hljs-attr">height</span>:<span class="hljs-number">50</span>, <span class="hljs-attr">depth</span>:<span class="hljs-number">50</span>}
            ]
        };

        manager.storeLevels(myLevel);
        manager.storeLevels(otherLevel);

        gma.keyHandler.register(<span class="hljs-number">37</span>, manager.character.move.curry(gma.constants.LEFT));
        gma.keyHandler.register(<span class="hljs-number">39</span>, manager.character.move.curry(gma.constants.RIGHT));
        gma.keyHandler.register(<span class="hljs-number">32</span>, manager.character.jump);
        gma.keyHandler.register(<span class="hljs-number">82</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{ manager.respawn(<span class="hljs-string">"main"</span>); });
        manager.init();
    }
);
</code></pre>
<p>更完整的例子在:<a href="https://github.com/Royce/GammaJS/tree/master/examples/fancy" target="_blank" rel="noopener">这里</a></p>
<p>本教程翻译自： <a href="https://github.com/Royce/GammaJS/tree/master/docs/tutorials" target="_blank" rel="noopener">这里</a></p>
<p>还有很多好玩的3D引擎，限于时间就不一一介绍了，下面就罗列下：</p>
<ul>
<li><a href="https://minko.io/engine/" target="_blank" rel="noopener">Minko Engine</a>:
<ul>
<li>Build cross-platform 3D apps for HTML5, iOS, Android, Windows, OS X and Linux using a single C/C++ code base.</li>
<li><a href="https://github.com/aerys/minko/" target="_blank" rel="noopener">Source Code</a></li>
</ul>
</li>
<li><a href="http://goocreate.com/" target="_blank" rel="noopener">Goo Engine</a>
<ul>
<li><a href="https://code.gooengine.com/" target="_blank" rel="noopener">Source Code</a></li>
</ul>
</li>
<li><a href="http://www.ambiera.com/copperlicht/" target="_blank" rel="noopener">CooperLicht</a>: Open Source WebGL 3D engine with editor</li>
<li><a href="https://www.blend4web.com/zh/" target="_blank" rel="noopener">Blend4Web</a> 做演示不错</li>
<li><a href="http://www.babylonjs.com/" target="_blank" rel="noopener">Babylon.js</a>: JavaScript 3D games engine</li>
<li><a href="http://voxeljs.com/" target="_blank" rel="noopener">Voxel.JS</a>:
<ul>
<li>a collection of projects that make it easier than ever to create 3D voxel games like Minecraft.</li>
<li><a href="https://github.com/maxogden/voxel-engine" target="_blank" rel="noopener">Source coe on Github</a></li>
</ul>
</li>
<li><a href="https://github.com/wise9/enchant.js" target="_blank" rel="noopener">Enchant.js</a>: A simple JavaScript framework for creating games and apps</li>
<li><a href="http://www.kickjs.org/" target="_blank" rel="noopener">KickJS</a>:  WebGL based game engine
<ul>
<li><a href="https://github.com/mortennobel/KickJS/" target="_blank" rel="noopener">Source code on GitHub</a></li>
</ul>
</li>
<li><a href="http://famo.us/" target="_blank" rel="noopener">Famo.us</a>: HTML5 3D development Framework
<ul>
<li><a href="http://famo.us/university/home/" target="_blank" rel="noopener">University</a></li>
<li><a href="https://github.com/Famous/famous" target="_blank" rel="noopener">Source code on GitHub</a></li>
</ul>
</li>
<li><a href="https://playcanvas.com/" target="_blank" rel="noopener">PlayCanvas.js</a></li>
<li><a href="http://threejs.org/" target="_blank" rel="noopener">Three.js</a></li>
<li><a href="http://biz.turbulenz.com/developers" target="_blank" rel="noopener">Turbulenz</a>: Open source HTML5 2D/3D game engine since 2009</li>
<li><a href="code.google.com/p/o3d/">Google O3D</a></li>
<li><a href="http://osgjs.org/" target="_blank" rel="noopener">OSG.JS</a>: a WebGL framework based on OpenSceneGraph concepts
<ul>
<li><a href="http://github.com/cedricpinson/osgjs" target="_blank" rel="noopener">Source code on GitHub</a></li>
</ul>
</li>
<li><a href="https://github.com/x3dom/x3dom" target="_blank" rel="noopener">X3DOM</a>: integrating and manipulating (X)3D scenes as HTML5 DOM elements</li>
<li><a href="http://www.scenejs.org/" target="_blank" rel="noopener">SceneJS - WebGL Scene Graph Library</a></li>
<li><a href="http://www.c3dl.org/" target="_blank" rel="noopener">C3DL</a>: a Canvas 3D JavaScript library</li>
<li><a href="http://www.senchalabs.org/philogl/" target="_blank" rel="noopener">PhiloJS</a>: a WebGL Framework for Data Visualization</li>
<li><a href="http://www.glge.org/" target="_blank" rel="noopener">GLGE</a></li>
<li><a href="http://www.jiglibjs.org/" target="_blank" rel="noopener">JigLibJS 物理引擎</a>－ 强烈推荐去看看</li>
</ul>
]]></content>
      <categories>
        <category>HTML5</category>
        <category>Game Development</category>
      </categories>
      <tags>
        <tag>html5</tag>
        <tag>h5</tag>
        <tag>2d</tag>
        <tag>3d</tag>
        <tag>webgl</tag>
        <tag>game</tag>
        <tag>engine</tag>
        <tag>development</tag>
      </tags>
  </entry>
  <entry>
    <title>Processing语言——专为开发者中的艺术家而创建</title>
    <url>/article/processing-language/</url>
    <content><![CDATA[<p>Processing 语言是专门为开发者中的艺术家而创建的，由MIT Media Lab的两个家伙所开发，一开始，他们的初衷只是想让开发变得有趣一些，正是这样一个单纯的目的，造就了Processing语言的艺术气质，令它成了一些Geek眼中的宝贝。当然，它也并不一定是Geek的专利，因为随着它越来越被广泛传播，现在玩这个被称为电子艺术和可视化设计，许多真正的艺术家也参与到了其中。　　Processing 语言的网站在： <a href="http://processing.org/" target="_blank" rel="noopener">http://processing.org/</a> 。 在它的展示厅（<a href="http://processing.org/exhibition/" target="_blank" rel="noopener">Exhibition</a>）页面上你能看到许多令人吃惊和好玩的图形和动画，难以置信的是这些东西都是通过很简单的程序代码“画”出来的，是的，有时候很难相信。比如下面这幅图片就是接合Twitter的数据用Processing画的。</p>
<p><a href="http://blog.blprnt.com/blog/blprnt/just-landed-processing-twitter-metacarta-hidden-data" target="_blank" rel="noopener"><img src="http://farm4.static.flickr.com/3365/3521509776_e7476b23ab.jpg" alt="Just Landed - Screenshot"></a></p>
<p>还有下面这个：</p>
<p><img src="http://dextro.org/hhhh/h001/k364p_col.jpg" alt="processing"></p>
<p>看到这里，您是不是有马上一试的冲动呢？那么，下面，跟我来一起开玩吧。</p>
<h1 id="yi-an-zhuang-processing-kai-fa-huan-jing" class="heading-control"><strong>一、安装Processing开发环境</strong><a class="heading-anchor" href="#yi-an-zhuang-processing-kai-fa-huan-jing" aria-hidden="true"></a></h1>
<p>Processing的开发包可以从下面这个地址下载： <a href="http://www.processing.org/download/" target="_blank" rel="noopener">http://www.processing.org/download/</a>，在这个页面上有各个平台（Mac, Windows, Linux）的版本下载。解压后，双击里面的Processing执行文件，即可开玩，</p>
<ul>
<li>Windows版本的需要执行，展开的文件夹中的processing.exe文件</li>
<li>MacOS 下的需要首先双击打开dmg文件，然后将其中的Processing 图标拖到Application目录中。</li>
<li>Linux下是.tgz压缩包，你需要在console中（或者xwindows下）执行解压并运行:
<ul>
<li>tar fxz processing-xxx.tgz</li>
<li>cd processing</li>
<li>./processing</li>
</ul>
</li>
</ul>
<h1 id="er-kai-shi-jin-hang-processing-bian-cheng-zhi-lv" class="heading-control"><strong>二、开始进行Processing编程之旅</strong><a class="heading-anchor" href="#er-kai-shi-jin-hang-processing-bian-cheng-zhi-lv" aria-hidden="true"></a></h1>
<p>运行processing后，可以看到它的IDE窗口环境：<br>
﻿<br>
<img src="https://processing.org/tutorials/gettingstarted/imgs/Fig_02_01.gif" alt="Processing IDE"></p>
<p>在文件(File)菜单下有许多例子(Examples)，你可以点击任何一个打开看看人家是怎么写的.</p>
<p>比如里面的 Effects/FireCube，就用很简单的代码画出一个着火的立方体的动画：<br>
<a href="https://github.com/processing/processing-android/blob/master/examples/Topics/Effects/FireCube/FireCube.pde" target="_blank" rel="noopener"><img src="./effects-firecube.png" alt="FireCube Example"></a></p>
<p>Processing 的程序分为两个主体函数：<code>setup</code>,  <code>draw</code>。其中<code>setup</code>是可以省略的。如果不需要动画或交互，那么<code>draw</code>函数也可以省略(在draw函数中的代码会一遍遍的重复执行直到你关闭或者停止)，直接在IDE编辑器中写代码绘制，比如，画一个圆：</p>
<pre><code class="processing">**<span class="hljs-built_in">ellipse</span>**(<span class="hljs-number">50</span>, <span class="hljs-number">50</span>, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>);
</code></pre>
<p>这个函数的意思是在坐标(50,50)的地方，绘制宽度和高度都是80的椭圆。点击<code>运行按钮</code>，就可以看到结果:</p>
<p><img src="http://www.showmuch.com/upload_files/auto_save_image/2011/03/041617Je4.gif" alt="processing"></p>
<p><code>size</code>函数用户设定绘制窗口的大小和方式，如果没有指定绘制方式，则默认为JAVA2D的模式，processing支持的方式有：JAVA2D, P2D, P3D, OPENGL以及PDF（如果是PDF方式，后面还需要一个pdf文件名的参数）。</p>
<p>下面是鼠标移动绘制圆形的交互代码，可以粘贴到编辑器执行看看。</p>
<pre><code class="processing"><span class="hljs-keyword">void</span> **<span class="hljs-title">setup</span>**() {
  <span class="hljs-built_in">size</span>(<span class="hljs-number">480</span>, <span class="hljs-number">120</span>); <span class="hljs-comment">//设置窗口大小</span>
    <span class="hljs-built_in">smooth</span>();
}

<span class="hljs-keyword">void</span> **<span class="hljs-title">draw</span>**() {
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">mousePressed</span>) {
    <span class="hljs-built_in">fill</span>(<span class="hljs-number">0</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">fill</span>(<span class="hljs-number">255</span>);
  }
  <span class="hljs-built_in">ellipse</span>(<span class="hljs-built_in">mouseX</span>, <span class="hljs-built_in">mouseY</span>, <span class="hljs-number">80</span>, <span class="hljs-number">80</span>);
}
</code></pre>
<p>停止执行按<img src="http://www.showmuch.com/upload_files/auto_save_image/2011/03/0416199lF.gif" alt="Stop">按钮。</p>
<p>特别的，使用beginRecord函数你还可以将绘制过程记录到pdf文件，当然首先要引用支持pdf的库：</p>
<pre><code class="processing"><span class="hljs-keyword">import</span> processing.pdf.*;
<span class="hljs-built_in">beginRecord</span>(PDF, <span class="hljs-string">"line.pdf"</span>);
<span class="hljs-built_in">ellipse</span>(<span class="hljs-number">200</span>, <span class="hljs-number">200</span>, <span class="hljs-number">50</span>, <span class="hljs-number">50</span>);
<span class="hljs-built_in">endRecord</span>();
</code></pre>
<p>Processing 有非常多的库，使得你绘制和交互非常的方便，你可以在这里学学习各种库的使用： <a href="http://www.processing.org/reference/libraries/" target="_blank" rel="noopener">http://www.processing.org/reference/libraries/</a> 下面的动画来自<a href="http://www.looksgood.de/libraries/Ani/" target="_blank" rel="noopener">ani库</a>中的 <code>valentine_drips_player</code>的demo.</p>
<p><img src="ani-valentine-drips.png" alt="ani demo"></p>
<p>这些扩展库文件你只需要放到 Processing Sketchbook location 下的libraries下面即可：</p>
<p><strong>To find the Processing sketchbook location on your computer, open the Preferences window from the Processing application and look for the “Sketchbook location” item at the top. Copy the contributed library’s folder into the “libraries” folder at this location. You will need to create the “libraries” folder if this is your first contributed library.</strong></p>
<p>Processing 的 <a href="https://github.com/shiffman/Box2D-for-Processing" target="_blank" rel="noopener">pbox2d</a> 物理引擎库，下面是经典的物理引擎堆箱子的例子(btw: 把size函数的显示方式改为P2D会提升性能)：</p>
<p><img src="http://www.jbox2d.org/images/Box2d-screenshot.png" alt="pbox2d box example"></p>
<p>还有更好玩的，如果你是超级懒人，觉得下载这么大一个东东（最新测试版要100多M）实在是太烦了，OK，那就玩javascript好了，最近processing的姊妹站点 <a href="http://processingjs.org/" target="_blank" rel="noopener">processingjs.org</a> 刚发布了processing.js v1.1.0，这个站点的目标是用javascript来玩processing。嗯，无需要java，无需要一大堆的文件，只要一个processing的javascript库，然后就可以玩。</p>
<p>下面是用prcessing.js做的可视化互动数据图:</p>
<ul>
<li><a href="http://www.mattryall.net/image/comments-vis.png" target="_blank" rel="noopener"><img src="http://www.mattryall.net/image/comments-vis.png" alt></a>Comments visualisation</li>
<li><a href="http://www.mattryall.net/image/contributors-vis.png" target="_blank" rel="noopener"><img src="http://www.mattryall.net/image/contributors-vis.png" alt></a>Contributors visualisation</li>
<li><a href="http://www.mattryall.net/image/activity-vis.png" target="_blank" rel="noopener"><img src="http://www.mattryall.net/image/activity-vis.png" alt></a>Activity visualisation</li>
</ul>
<p>值得一提的是，除了在本地玩之外，Processing也提供了一个WebIDE：<a href="http://processingjs.org/learning/ide" target="_blank" rel="noopener">processingjs</a>，通过这个在线的IDE，您只需要往页面的TextArea编写程序，即可运行一个在线的实例，相当方便快捷。</p>
<p></p>
<h3 id="geng-duo-yan-shi-zai-zhe-li-ni-xu-yao-zhi-chi-html5-de-liu-lan-qi" class="heading-control">更多演示在这里，你需要支持html5的浏览器：<a class="heading-anchor" href="#geng-duo-yan-shi-zai-zhe-li-ni-xu-yao-zhi-chi-html5-de-liu-lan-qi" aria-hidden="true"></a></h3>
<ul>
<li><a href="http://www.mattryall.net/demo/atlassian-vis/contributors/" target="_blank" rel="noopener"><strong>Contributors</strong></a> — a tree graph visualisation linking commenters and blog post authors.</li>
<li><a href="http://www.mattryall.net/demo/atlassian-vis/activity/" target="_blank" rel="noopener"><strong>Activity</strong></a> — a rippling visualisation of comment activity on the wiki. Based loosely on the Apple Arabesque screensaver.</li>
<li><a href="http://www.mattryall.net/demo/atlassian-vis/comments/" target="_blank" rel="noopener"><strong>Comments</strong></a> — a falling bar-graph visualisation of comments by blogpost. Based very much on <a href="http://labs.digg.com/stack/" target="_blank" rel="noopener">a Flash visualisation</a>by Digg, but reimplemented in JS.</li>
</ul>
]]></content>
      <categories>
        <category>Learning</category>
        <category>Programming</category>
      </categories>
      <tags>
        <tag>programming</tag>
        <tag>computer language</tag>
      </tags>
  </entry>
  <entry>
    <title>Phonegap：快速开发跨平台HTML5应用的胶水层</title>
    <url>/article/phonegap/</url>
    <content><![CDATA[<p>在开发移动应用的过程当中，如果你的应用只定位在一种平台上，这可不是一个好主意，但是为许多不同的平台Building应用又是一件非常麻烦和非常不爽的事情，因为你会发现每一种手机平台都有自己的SDK，它们需要使用不同语言来进行开发，你可能不得不需要5、6个代码仓库来管理不同设备上的代码，而且需要不同设备的开发人员来开发维护这些仓库，你还不得不装上各个设备的sdk，设置好路径和各种配置信息，来编译不同设备上的应用包。那么移动网站模式是不是一个可以接受的替代方案呢？幸运的是移动应用和移动网站并不是对立的两端，通过Phonegap我们可以采用html5的网站形式来开发移动应用。也许开源Phonegap 会成为 WebApp 上设备端开发的事实上标准，ShowMuch本期就为你推荐移动开发利器：PhoneGap。我们先来看看PhoneGap的特性：</p>
<ul>
<li>支持6种移动设备平台：iOS, Android, BlackBerry, WebOS, Symbian WRT, Windows Mobile(内部测试)，以及桌面环境（内部测试）</li>
<li>HTML5 + CSS3 + JavaScript  利用标准的Web技术开发应用</li>
<li><a href="https://build.phonegap.com/" target="_blank" rel="noopener">Phonegap Build</a>: write once, compile on cloud, run anywhere. 提供在线Builder平台：只写一次，云端编译，运行在任何地方</li>
<li>目前已经有上千基于<a href="http://www.phonegap.com/apps" target="_blank" rel="noopener">Phonegap的应用</a>在AppStore上</li>
</ul>
<h2 id="kai-shi-wan-dataimagejpgbase649j4aaqskzjrgabaqaaaqabaad2wceaakgbgggbqkibwgkcqkkdryodqwmdrotfbawhxwhib8chh4jjziqiyuvjr4ekzsslzm1odg4iso9qtw2qti3odubcqokdqsngq4ogtukhiq1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu0ntu1ntu1nsk1ntutnfaabeiacaaiambigaceqedeqhxaaxaaebaqeaaaaaaaaaaaaaaaagbwud8qalraaagiabqmbbgcaaaaaaaaaaqidbaaferihbiixb0fryzkhwrmuqknxgzhxaawaqebaqaaaaaaaaaaaaaaaaadbahxaadeqacagmbaqeaaaaaaaaaaaabagaderihqfae9oadambaairaxeapwc44n9a5mavwcalkin3gvlpjuadbzyf5p4oembxqm6lnlkv4erh9uh3wls7ufeo1tultv6yzcpds2vo7tkccykxaqadzacrp8owgwe6kiljyu20qbfe5iyju13kaf1hkkafdchgommrnroyazjbtwuasli1isumy1zm9mcfvfixn46jquysmu4b8wy7pf5p7eh7ggh11b400gmj1ezwzlkvnar2tkqej2z68zcrs6oqfo0dzad3jy8doxhvov8qlkmud1gjvixjbx7maw9dqkbhujyr3fp0tftisp9xzsoox5yw1gk1jztwrgj49d3laljgqcf5pgk8emi0dzy1eng6mnvztqcpemrqz6hzujbxr5ibc0zbiokqtk7seafcjyt4w79oy84tjldztuko13sf6nazveqrmoyl9p4jcsdpg5trr7abydgc9lkkqwudmphpz" class="heading-control">开始玩![](data:image/jpg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBggGBQkIBwgKCQkKDRYODQwMDRoTFBAWHxwhIB8cHh4jJzIqIyUvJR4eKzssLzM1ODg4ISo9QTw2QTI3ODUBCQoKDQsNGQ4OGTUkHiQ1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU1NTU0NTU1NTU1NSk1NTUtNf/AABEIACAAIAMBIgACEQEDEQH/xAAXAAEBAQEAAAAAAAAAAAAAAAAGBwUD/8QALRAAAgIABQMBBgcAAAAAAAAAAQIDBAAFERIhBiIxB0FRYZKhwRMUQkNxgZH/xAAWAQEBAQAAAAAAAAAAAAAAAAADBAH/xAAdEQACAgMBAQEAAAAAAAAAAAABAgADERIhQfAE/9oADAMBAAIRAxEAPwC44N9a5maVWCAlkin3GVlPJUaDb/ZYf5p4OEmBXqM6LNlKv4eRh9UH3wlS7uFEO1tULTV6YzCpds2Vo7tkccYkXaQA/dz/ACRp8owgwe6Kiljyu20qbFe5IYju13KAF1+HKkafDCHGOMMRNrOyAzjbtwUasli1IsUMY1Zm9mCfVFiXN46jQUysMU4b8wy7pF5P7eh7GGh11B400GMj1ezWzlk+VNar2TkQEj2Z68ZcRS6oqF+O0dzAd3JY8doxhVOv8qlKMud1Gj/V+Ixjbx7mAw9dQKbhujyR3fp0tFTISp9xzsoOX5y+W1gk1JzTWRgJ49d3LaljGQCF5Pgk8eMI0dZY1eNg6MNVZTqCPeMRqz6hZUJBXr5ibc0zBIoKqtK7seAFCjyT4w79OY84TJLDZtUko13sF6NaZVEqRMoYl9p4JcsdpG5Trr7ABYDGc9lKkqwUDmPhP//Z)<a class="heading-anchor" href="#kai-shi-wan-dataimagejpgbase649j4aaqskzjrgabaqaaaqabaad2wceaakgbgggbqkibwgkcqkkdryodqwmdrotfbawhxwhib8chh4jjziqiyuvjr4ekzsslzm1odg4iso9qtw2qti3odubcqokdqsngq4ogtukhiq1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu1ntu0ntu1ntu1nsk1ntutnfaabeiacaaiambigaceqedeqhxaaxaaebaqeaaaaaaaaaaaaaaaagbwud8qalraaagiabqmbbgcaaaaaaaaaaqidbaaferihbiixb0fryzkhwrmuqknxgzhxaawaqebaqaaaaaaaaaaaaaaaaadbahxaadeqacagmbaqeaaaaaaaaaaaabagaderihqfae9oadambaairaxeapwc44n9a5mavwcalkin3gvlpjuadbzyf5p4oembxqm6lnlkv4erh9uh3wls7ufeo1tultv6yzcpds2vo7tkccykxaqadzacrp8owgwe6kiljyu20qbfe5iyju13kaf1hkkafdchgommrnroyazjbtwuasli1isumy1zm9mcfvfixn46jquysmu4b8wy7pf5p7eh7ggh11b400gmj1ezwzlkvnar2tkqej2z68zcrs6oqfo0dzad3jy8doxhvov8qlkmud1gjvixjbx7maw9dqkbhujyr3fp0tftisp9xzsoox5yw1gk1jztwrgj49d3laljgqcf5pgk8emi0dzy1eng6mnvztqcpemrqz6hzujbxr5ibc0zbiokqtk7seafcjyt4w79oy84tjldztuko13sf6nazveqrmoyl9p4jcsdpg5trr7abydgc9lkkqwudmphpz" aria-hidden="true"></a></h2>
<p>首先自然是需要下载 phonegap： <a href="http://www.phonegap.com/" target="_blank" rel="noopener">http://www.phonegap.com/</a></p>
<p>然后你还需要相应设备的SDK</p>
<h3 id="zhen-dui-iphone" class="heading-control"><strong>针对iPhone:</strong><a class="heading-anchor" href="#zhen-dui-iphone" aria-hidden="true"></a></h3>
<ol>
<li>从 <a href="http://developer.apple.com/" target="_blank" rel="noopener">Apple Developer Portal</a> 下载安装 XCode.</li>
<li>解开下载好的phonegap压缩包，进入iphone目录安装好phonegap</li>
<li>打开XCode，在文件菜单选择 New Project… 菜单</li>
<li>点开“User Templates”栏，选择Phonegap，然后选中右边的“<strong>PhoneGap-based Application</strong>”，点击“Choose…”按钮，命名你的项目，选择项目文件的位置.</li>
</ol>
<h3 id="zhen-dui-android" class="heading-control"><strong>针对Android:</strong><a class="heading-anchor" href="#zhen-dui-android" aria-hidden="true"></a></h3>
<ol>
<li>![](data:image/jpg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBhIPDxUTEBIWEBASFBIRFBgVFBMdGRQbHxUcFhgXFxIYJyYeIyUoGhgeHzsgIzMpMTAtFx4xNTwqNScrLCkBCQoKDQsNGQ4OGTUkHiQ1NTU1NDQ1NTU2LjU1NSw1NSw1NDUyNDU1NDY1LjQ1NSw1NDQsNTYpNDQtLDUpLC81LP/AABEIAE8ATwMBIgACEQEDEQH/xAAbAAABBQEBAAAAAAAAAAAAAAAAAQMEBQYCB//EADgQAAIBAwIDBQQJAwUAAAAAAAECAwAEEQUhEhMxBiJRYXEyQYGRFEJSobGys+HwJENyFiM0NYL/xAAZAQADAQEBAAAAAAAAAAAAAAAAAgMEAQX/xAAoEQACAgEDAQcFAAAAAAAAAAAAAQIRAxIhMRMEQWFxgbHBFFGRofD/2gAMAwEAAhEDEQA/APcKKKKACiikJoAWq++v+XJCvXmuyH0EbNn5qB8aNX1qK1jLytgdAB7THwUVQ2NyTKLu8PKyClvFuWUHqeEblj5DpU5Tp6VyXx4m1rfHua0UtM2s3GMlSmfc2M/EDp6U9VEQ4CiiigAooooAK5alJqLdanFEQJHVWPRSe83og3PwoOMyul230m/uZrjvG2bgiQ9F6kEDzAB9T5Cu+xEi3LS3Ep4rjjK4P9tMbBR7h1G3XG9XMtjiYXEPtMAsq4xzFzscH6w92eoyPCqnTNEMOpyPDtCUy/hxsc8A/N5ZHjWXQ4td56nVhkhNN1sq9OV6mtWuqhXmpJAvE/FwgEkqjNgDqTwg09Z3iTIHjYOjDKspyDWqjy7H6KKKDoUUUUAIax+v6Nb2jNdBrmOSRwrmFifaO5biDYUfGtTfX8cKF5XWNB1LEAfzyqHJePNC/wBHBRyp5byxkLk9O6cN91NFtOxJU9jNJrNoR/3EnoWhH4pmkTV7EsB9NubgkgYV5yPjyVXanDdaimA+nQTsBjiWSPfzw3zqZpl3qLSDjtILeLPe/wB3vY8RwZ+RrQ0qv5RJXx8Fld3y26BIUaSQgcuNMkt5sx9keLNXPZHR2tLVY3ILlnkfHsgseIqvkOlWk0yxqWchVAySfdjxNdxyBhkbg7j8azXtRat7OxRRRXBgoNFIaAIGr6PDdoEnQSKDxDORg+II3Bqok7Kcof081wgH1RdNgegkDipXbOZksZWRirDgwVJBHfUbEU3DrZighHJmndoY3JRcj2RklycZ8qXraHpfBX6dzgpryIZ0y7H927PpNZ/iUrltMuz1N03+V3Av6aZqZ/rOLkNNwSYjdY5FKjijJ+0M4qdqGupBysgtz2VE4QPfjBPlvTLOubQr7LNOmv5FRD2enLZIiQ/akee4cenMKrn51pLO2MaYLtIdyWcjJPwwB6Daqe97ViIvm3nZIyQziPujB3IJOSKs7DUBOgdAeBgGVtu8P2rnUU3QPDOEdTWxNFFIKWuiBSGlpDQBn+3H/Al/8fqLVOmsuZIbfni0jFrDIXIQlzwDYF9h+xq87TaTJdqsSuEhLZl2PEQOgX3fwVOk0iF1QPEjiMBV4lBwBsMVnlCTna8DdjzY4YlGSvd/BjtBtBcpfxh+bxsArnHf7pKtgbdd/CmuzM7Xk9srbizjYvn7WeFPuwfhW9itETJRQpbGcADOBtnHlXMFlHGSURULHJIAGfUilWBqt/P3Hl23Up7c8eG1P9GIn1trmK4aS6FuEMkSwgJlsDYMzZbJ6bVpOxQ/oIf8T+c1PbSYTJx8pOYfrcC5+dSbeFUXhQBVHQAYA+FPDG1LU2SzdohLH04qt0+77fkdFFAoq5jP/9k=)下载安装 JDK 1.5</li>
<li>下载安装 <a href="http://developer.android.com/sdk/index.html" target="_blank" rel="noopener">Android SDK</a></li>
<li>下载安装 <a href="http://ant.apache.org/ivy/download.cgi" target="_blank" rel="noopener">Apache ANT</a></li>
<li>下载安装 Ruby (命令行方式开发需要)</li>
<li>解压已经下载好的 PhoneGap, 进入android 目录，my god，最新的0.9.4ZIP包中没有命令行创建项目的方式，好吧，你需要从最新的仓库中把代码取出来： git clone <a href="https://github.com/phonegap/phonegap-android.git" target="_blank" rel="noopener">https://github.com/phonegap/phonegap-android.git</a></li>
<li>命令行方式(Droidgap)脚本的开发者没有修改路径以配合新的0.9.4版本，这是这次在发布中被拿掉的原因吧。需要自己改改，蛮简单的，就不多说。</li>
<li>将 android下的bin目录 加入你的搜索 path:<br>
UNIX/LINUX的机子: export PATH=$PATH:~/phonegap-android/bin<br>
在windows下将phonegap-android/bin 路径加到Path中就不用多说了。</li>
<li>ok，在命令行下输入 “droidgap gen demo”,即可创建phonegap支撑的html5应用项目。</li>
<li>cd demo;ant debug install 即可安装到设备或模拟器</li>
<li>adb logcat 在控制台查看设备的输出日志</li>
</ol>
<h3 id="shi-yong-phonegap-lai-chuang-jian-yi-dong-app-ying-yong" class="heading-control"><strong>使用PhoneGap来创建移动App应用：</strong><a class="heading-anchor" href="#shi-yong-phonegap-lai-chuang-jian-yi-dong-app-ying-yong" aria-hidden="true"></a></h3>
<p>打开项目的www目录（android是在项目的assets/www目录下），编辑index.html，在body中键入</p><h1 class="heading-control">hello world<a class="heading-anchor" href="#undefined" aria-hidden="true"></a></h1>（你也可以加上js和css文件在这个目录下面），保存，然后你就可以首先部署到模拟器上看看。<p></p>
<p>也许你会说，哈，这不就是网页嘛！是的，这就是网页，不过通过phonegap，这样的网页应用就有能力访问设备的所有功能：文件系统，GPS，相机，重力加速度计，电话簿等，当然不同的设备支持的功能会有所不同（目前phonegap还不能支持完所有的功能，具体看各个设备支持的特性列表）。另外要想呈现和移动应用一样的外观，你还需要选择一种HTML5 Mobile UI Framework库，这样的Framework库已经很多了: Sencha Touch, JQTouch, JMobile, XUI, The-M-Project,Dojo Mobile, dhtmlxTouch, wink, jo, <a href="http://webapp.net" target="_blank" rel="noopener">webapp.net</a>…</p>
<h2 id="phonegap-build" class="heading-control"><a href="https://build.phonegap.com/" target="_blank" rel="noopener">Phonegap Build</a><a class="heading-anchor" href="#phonegap-build" aria-hidden="true"></a></h2>
<p>除了在本地编译应用之外，您还可以使用Phonegap提供的云端Build工具进行应用编译。那就是：Phonegap Build，通过它，您只需要将用HTML5写好的应用上传到Phonegap的云端服务器，它即可以帮你编译不同平台平的应用。</p>
<p><img src="https://build.phonegap.com/images/marketing/build-diagram.png" alt></p>
<p><a href="https://build.phonegap.com/" target="_blank" rel="noopener">Phonegap Build</a> 当前<a href="https://build.phonegap.com/" target="_blank" rel="noopener">Phonegap Build</a>依然处于beta状态，你需要申请，等到通过方可使用。另外推荐一个Chrome的插件，<a href="http://ripple.tinyhippos.com/" target="_blank" rel="noopener">Ripple Emulator</a> 可以在Chrome浏览器上测试你的应用，支持phonegap。</p>
<p>（文章作者：李雪愚，盛大创新院高级架构师，雪愚对于使用Phonegap有着丰富的经验，曾用Phonegap开发基于Android和iOS的应用。编辑BY：Handaoliang）</p>
]]></content>
      <categories>
        <category>HTML5</category>
      </categories>
      <tags>
        <tag>HTML5</tag>
        <tag>mobile</tag>
        <tag>移动开发</tag>
        <tag>phonegap</tag>
        <tag>cordova</tag>
        <tag>hybrid</tag>
        <tag>application</tag>
      </tags>
  </entry>
  <entry>
    <title>开源硬件的三个时代</title>
    <url>/article/open-hardware-ages/</url>
    <content><![CDATA[<p><strong>编者按：作为一个介绍优秀开源项目的网站，开源硬件也将是我们重点关注的一块，在未来，我们会把更多优秀的开源硬件项目介绍给大家。在此之前，让我们先预习一下开源硬件的三个时代。：），本文作者：李雪愚，盛大创新院高级架构师。</strong></p>
<p>对于开源硬件来说，我们根据其技术特点，大概将其分为三个时代，即：焊接时代（过去）、插接时代（现在Arduino），无线时代（未来）</p>
<h2 id="yi-han-jie-shi-dai" class="heading-control">一、焊接时代<a class="heading-anchor" href="#yi-han-jie-shi-dai" aria-hidden="true"></a></h2>
<p>硬件开放初期本为DIY硬件，那个时候电路图，PCB图纸开放的也不少，但是由于还是只能是搞电子技术的小圈子才能玩转的。</p>
<img src="/article/open-hardware-ages/han-jie.jpg" class>
<p>主要面向的人群：</p>
<ul>
<li>电子技术爱好者以及相关人群</li>
<li>电子技术教育界相关人群</li>
</ul>
<p>代表论坛有：</p>
<ul>
<li><a href="http://www.avrw.com/" target="_blank" rel="noopener">http://www.avrw.com</a></li>
<li><a href="http://www.ecbbs.com/" target="_blank" rel="noopener">http://www.ecbbs.com</a></li>
</ul>
<p>主要芯片提供商有：Geekers</p>
<h2 id="er-cha-jie-shi-dai" class="heading-control">二、插接时代<a class="heading-anchor" href="#er-cha-jie-shi-dai" aria-hidden="true"></a></h2>
<p>开源硬件的插接时代又要分成两个阶段，我们称之为插接时代I代和插接时代II代：</p>
<h3 id="1-cha-jie-shi-daiidai" class="heading-control">1、插接时代I代：<a class="heading-anchor" href="#1-cha-jie-shi-daiidai" aria-hidden="true"></a></h3>
<p>Arduino的出现则打破了这一局面，依托于微控制器为核心，标准化的MCU主板为基础，简易的软件开发，组建出各种各样的智能电子积木，它的影响力的体现在：</p>
<ul>
<li>不限制商业的开源形式，使得小厂家也能轻松的低成本的生产（无研发费用）</li>
<li>同时因为开源，基于开源的改进能反馈到社区，形成共同开发</li>
<li>标准化的MCU硬件接口设计，提升不同模块的兼容性</li>
<li>简易的软件开发，快速的原型设计，缩短了产品开发周期</li>
<li>对于使用者而言：
<ul>
<li>再也无需要制作电路板、进行焊接元器件，降低进入门槛</li>
<li>可以用于实际项目，而不仅仅是玩具</li>
<li>后续的电脑geeker(互联网)的加入扩大了影响。</li>
</ul>
</li>
</ul>
<p>插接时代I代时期开源硬件主要面向的用户群（基本还是对geeker圈的扩大，即专业的长尾生态圈）：</p>
<ul>
<li>电子技术爱好者以及相关人群</li>
<li>教育界相关人群: 相关专业的老师、学生</li>
<li>软件开发者</li>
<li>各类Geeker：电子艺术家、医生…</li>
</ul>
<p>生态环境：</p>
<p>MCU 芯片提供商→MCU主板生产商（个人或小公司）→Geekers<br>
　　附属的芯片提供商→各种模块积木的生产商（个人或小公司）→Geekers</p>
<h3 id="2-cha-jie-shi-dai-ii-dai-ke-yi-yu-jian-de-wei-lai" class="heading-control">2、插接时代II代（可以预见的未来）：<a class="heading-anchor" href="#2-cha-jie-shi-dai-ii-dai-ke-yi-yu-jian-de-wei-lai" aria-hidden="true"></a></h3>
<p>作为马上到来的一个阶段，这是一个尚未被开拓的时代，纯净的蓝海，可以认为是产品2.0的时代（相对于Web2.0）。</p>
<p>插接时代II代的主要特征有：</p>
<ul>
<li>附属模块（传感器等）进一步标准化，微型化</li>
<li>模具设计者、模具生产商介入</li>
<li>利益分配机制的建立和完善</li>
<li>整个产业链伸向最终用户: 将geeker的创作变为商品卖给用户</li>
<li>需要一个类似淘宝的平台</li>
</ul>
<p>插接时代II代时期开源硬件的生态环境：</p>
<p>MCU 芯片提供商→MCU主板生产商（个人或小公司）→Geekers<br>
　　附属的芯片提供商→各种模块积木的生产商（个人或小公司）→Geekers→最终用户　　模具 模具生产商（个人或小公司）→Geekers</p>
<p>最终用户：初期为大部分是喜欢个性化产品的用户,最终希望能产生出无印良品</p>
<h2 id="san-wu-xian-shi-dai-wei-lai" class="heading-control">三、无线时代（未来）<a class="heading-anchor" href="#san-wu-xian-shi-dai-wei-lai" aria-hidden="true"></a></h2>
<p>随着技术的不断发展和不断成熟，接下来开源硬件即将进入的，将是一个全新的时期，即无线时代。在这个时期，所有的组件均可以通过无线通讯进行沟通协作。显然，这是一个非常值得期待的未来。</p>
<p>正在步入現實，以ESP8266芯片爲代表。</p>
]]></content>
      <categories>
        <category>Open Source</category>
        <category>Hardware</category>
      </categories>
      <tags>
        <tag>thinking</tag>
        <tag>iot</tag>
        <tag>open source</tag>
        <tag>hardware</tag>
        <tag>arduino</tag>
      </tags>
  </entry>
  <entry>
    <title>CSS 开发利器 ——Sass 相关工具框架介绍</title>
    <url>/article/sass-lang/</url>
    <content><![CDATA[<p><img src="http://sass-lang.com/assets/img/logos/logo-b6e1ef6e.svg" alt="sass"></p>
<p>在Web开发的过程中，使用CSS的是很普遍的，虽然CSS本身并不复杂，但在大型网站中如何去有序地组织好CSS结构却是一个相当棘手的问题。为了解决开发者的这些问题，就有了Sass的出现。Sass 的全称是 (Syntactically Awesome Stylesheets)，是一种输出CSS的meta编程语言, 可以帮助开发者写出复用性更优的CSS文件。它能将类似CSS但是更简便的书写的sass语言最终转换为CSS代码。Sass提供了基于Ruby语言开发的工具能够很容易的将sass代码转换为CSS代码.</p>
<h1 id="ta-de-yu-fa-te-xing" class="heading-control">它的语法特性<a class="heading-anchor" href="#ta-de-yu-fa-te-xing" aria-hidden="true"></a></h1>
<ol>
<li>变量: Sass中以”$”号打头的$name 都是变量。我们可以给变量赋值，然后在文件中使用它们。</li>
<li>继承:<br>
　A. 继承其它选择器的属性：.error {border: 1px}; .badError {@extend .error};<br>
　B. 在选择器中属性插入”&amp;”它就会继承父选择器：a: {color:black; &amp;:hover {color:blue}}</li>
<li>内嵌 ：这个功能将另外一个急需的特性加入CSS：将选择器嵌入到其他等级，而不是不得不取消在一些高级选择器定义中嵌套。Sass翻译器将这个简洁的特性扩展到了CSS。</li>
<li>混合类型 ：允许开发者抽象出性质的共同点，然后命名并且加入到选择器中。熟悉Ruby混合类型的开发者会了解混合类型在CSS中的应用。Sass也允许将混合类型作为参数，使得混合类型的应用更加灵活。</li>
<li>操作 ：Sass支持简单的算术操作，例如±×/，以及函数。将这个特性和变量结合起来，会使得CSS变得更加灵活。工具需要保证操作的单位（px, pt）正确性（例如字体大小等, width: 1in + 8pt，将某颜色亮度增加10%: lighten(yellow, 10%)）。</li>
</ol>
<p>Sass语言支持的函数列表在这里：<a href="http://sass-lang.com/docs/yardoc/Sass/Script/Functions.html" target="_blank" rel="noopener">http://sass-lang.com/docs/yardoc/Sass/Script/Functions.html</a></p>
<h2 id="scss" class="heading-control">SCSS<a class="heading-anchor" href="#scss" aria-hidden="true"></a></h2>
<p>2010年5月份Sass发布了支持CSS3的新语法叫做SCSS（Sassy CSS），它是CSS3的一个超集，也就是说它100%兼容CSS3，每一个有效的CSS3文件也是有效的SCSS文件。不仅如此，它还支持我们能够找到的所有扩展，甚至包括一些非标准语法，例如微软的expression()函数和filter属性。Sass修改后的语法希望能够尽量减少和CSS语法的差异，以吸引更多的用户使用。修改语法的另一个好处是可以使得CSS工具更容易支持Sass。Sass 的旧有语法将会继续存在并且能够为旧版本用户提供良好兼容性。</p>
<h1 id="sass-de-an-zhuang-he-shi-yong" class="heading-control">SASS的安装和使用<a class="heading-anchor" href="#sass-de-an-zhuang-he-shi-yong" aria-hidden="true"></a></h1>
<h2 id="yi-an-zhuang" class="heading-control"><strong>一、安装：</strong><a class="heading-anchor" href="#yi-an-zhuang" aria-hidden="true"></a></h2>
<p>因为sass的工具是基于ruby gems开发的，所以安装 ruby和gem是必须的</p>
<pre><code class="bash">　　<span class="hljs-variable">$sudo</span> gem install haml
</code></pre>
<p>在命令行使用sass：</p>
<p>$sass input.scss output.css</p>
<p>直接输出压缩后的css文件：</p>
<pre><code class="bash">　　<span class="hljs-variable">$sass</span> input.scss output.css --style compressed
</code></pre>
<p>compass是基于sass的样式创作的rails框架工具，它使得你的样式表项目更容易维护. 它内部支持的css框架库是bluepoint和compass，如果在创建项目的时候不指明框架库，则是用Compass库。</p>
<pre><code class="bash">　　<span class="hljs-variable">$sudo</span> gem install compass
</code></pre>
<p>创建css项目：</p>
<pre><code class="bash">　　<span class="hljs-variable">$compass</span> <span class="hljs-built_in">help</span> create
</code></pre>
<h2 id="er-sass-de-shi-yong" class="heading-control"><strong>二、Sass的使用：</strong><a class="heading-anchor" href="#er-sass-de-shi-yong" aria-hidden="true"></a></h2>
<p>创新一个新的CSS项目：</p>
<pre><code class="bash">　　<span class="hljs-variable">$compass</span> create newProject
</code></pre>
<p>如果不喜欢它自动创建的css等目录的名称你也可以在创建的时候自己指定：</p>
<pre><code class="bash">　　<span class="hljs-variable">$compass</span> create newProject --using blueprint/project --sass-dir sass --css-dir css --images-dir images --javascripts-dir js --output-style compressed
</code></pre>
<p>以上使用blueprint/project CSS框架来创建项目，并设置sass目录为sass，输出css目录为css,图片目录为images，javascript目录为js, 输出的css的方式为压缩.</p>
<p>为已有项目添加CSS模板框架</p>
<pre><code class="bash">　　<span class="hljs-variable">$compass</span> <span class="hljs-built_in">help</span> install
</code></pre>
<p>在已有项目中添加一个 blueprint的按钮css框架:</p>
<pre><code class="bash">　　<span class="hljs-variable">$cd</span> newProject
　　<span class="hljs-variable">$compass</span> install blueprint/buttons
</code></pre>
<p><strong>本文作者：李雪愚。雪愚是盛大创新院高级架构师，Geeker，热爱开源事业。</strong></p>
]]></content>
      <categories>
        <category>Learning</category>
        <category>Programming</category>
      </categories>
      <tags>
        <tag>programming</tag>
        <tag>computer language</tag>
        <tag>css</tag>
        <tag>sass</tag>
        <tag>compass</tag>
        <tag>html</tag>
      </tags>
  </entry>
  <entry>
    <title></title>
    <url>/404.html</url>
    <content><![CDATA[<html>
  <head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><script type="text/javascript">
    function resizeIframe(aIframe){
      aIframe.style.height = aIframe.contentWindow.document.body.scrollHeight + 'px';
    }
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  <link rel="alternate" href="/atom.xml" title="Riceball LEE" type="application/atom+xml">
</head>
<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><iframe scrolling='no' frameborder='0' onload="resizeIframe(this)" src='no-layout/helpchild404.html' width="100%" height="800" style='display:block;'></iframe><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>
]]></content>
  </entry>
  <entry>
    <title>categories</title>
    <url>/categories/index.html</url>
    <content><![CDATA[<p>Collect all categories here.</p>
]]></content>
  </entry>
  <entry>
    <title>Going to St.ives</title>
    <url>/imarkdown/stives.html</url>
    <content><![CDATA[<p>An old riddle.</p>
<blockquote>
<p>As <span class="AMElement" data-embed="false" data-config="travelers: we or I">I</span> <span class="AMElement" data-embed="false" data-config="verb">was</span> going to <em>St Ives</em><br>
I met a man with <span class="AMElement" data-embed="false" data-config="wives: 1..10">7 wives</span><br>
Every wife had <span class="AMElement" data-embed="false" data-config="sacks: 1..10">7 sacks</span><br>
Every sack had <span class="AMElement" data-embed="false" data-config="cats: 1..10">7 cats</span><br>
Every cat had <span class="AMElement" data-embed="false" data-config="kits: 1..10">7 kits</span><br>
Kits, cats, sacks, wives<br>
How many were going to St Ives?</p>
</blockquote>
<pre><code>total_sacks = @wives * @sacks
total_cats  = total_sacks * @cats
total_kits  = total_cats * @kits
man         = 1

if @travelers
    narrator = 2
    @verb = 'were'
else
    narrator = 1
    @verb = 'was'
</code></pre>
<p>The first guess is often <span class="AMElement" data-embed="false" data-config="first_guess">2753</span>…</p>
<pre><code>@first_guess = man + @wives + total_cats + total_kits + narrator
</code></pre>
<p>…but the correct answer is <strong><span class="AMElement" data-embed="false" data-config="answer">1</span></strong>.</p>
<pre><code>@answer = narrator
</code></pre>
]]></content>
  </entry>
  <entry>
    <title>Interactive Markdown</title>
    <url>/imarkdown/index.html</url>
    <content><![CDATA[<h1 id="jie-shao" class="heading-control">介绍<a class="heading-anchor" href="#jie-shao" aria-hidden="true"></a></h1>
<p><a href="http://riceball.me/imarkdown">Interactive Markdown</a>是使用纯文本的Markdown格式来制作响应式交互文档的工具。响应式Markdown增加了特有的交互组件和变量的标记符号。</p>
<p>具体请参阅💁🏻‍♂️ <a href="http://riceball.me/imarkdown/reference.html">交互式Markdown文档参考手册</a> .</p>
<p>Status: Alpha Test</p>
<a id="more"></a>
<h2 id="yi-ge-jian-dan-jiao-hu-wen-dang-li-zi" class="heading-control">一个简单交互文档例子<a class="heading-anchor" href="#yi-ge-jian-dan-jiao-hu-wen-dang-li-zi" aria-hidden="true"></a></h2>
<p>一首童谣</p>
<blockquote>
<p><span class="AMElement" data-embed="false" data-config="travelers: 我们 或 我">我</span> 要去 <em>圣伊芙</em>我碰到一个有 <span class="AMElement" data-embed="false" data-config="wives: 1..10">7 个老婆</span>  的男人每个老婆有 <span class="AMElement" data-embed="false" data-config="sacks: 1..10">7 个口袋</span>每个口袋有 <span class="AMElement" data-embed="false" data-config="cats: 1..10">7 只🐈️猫咪</span>每只🐈️猫有 <span class="AMElement" data-embed="false" data-config="kits: 1..10">7 套🛠️工具</span><br>
🛠️工具, 🐈️猫咪, 口袋, 老婆问：有多少要去<em>圣伊芙</em>？</p>
</blockquote>
<pre><code>total_sacks = @wives * @sacks
total_cats  = total_sacks * @cats
total_kits  = total_cats * @kits
man         = 1

if @travelers
    narrator = 2
else
    narrator = 1
</code></pre>
<p>这常常会首先猜测是 <span class="AMElement" data-embed="false" data-config="first_guess">2753</span>…</p>
<pre><code>@first_guess = man + @wives + total_cats + total_kits + narrator
</code></pre>
<p>…但实际正确答案是 <strong><span class="AMElement" data-embed="false" data-config="answer">1</span></strong>.</p>
<pre><code>@answer = narrator
</code></pre>
<hr>
<p>上面的这个互动例子的Markdown代码如下：</p>
<pre><code class="md"><span class="hljs-quote">&gt; [我]{travelers: 我们 or 我} 要去 *圣伊芙*</span>
<span class="hljs-quote">&gt; 我碰到一个有 [7 个老婆]{wives: 1..10}  的男人</span>
<span class="hljs-quote">&gt; 每个老婆有 [7 个口袋]{sacks: 1..10}</span>
<span class="hljs-quote">&gt; 每个口袋有 [7 只🐈️猫咪]{cats: 1..10}</span>
<span class="hljs-quote">&gt; 每只🐈️猫有 [7 套🛠️工具]{kits: 1..10}</span>
<span class="hljs-quote">&gt; 🛠️工具, 🐈️猫咪, 口袋, 老婆</span>
<span class="hljs-quote">&gt; 问：有多少要去*圣伊芙*？</span>

<span class="hljs-code">    total_sacks = @wives * @sacks</span>
<span class="hljs-code">    total_cats  = total_sacks * @cats</span>
<span class="hljs-code">    total_kits  = total_cats * @kits</span>
<span class="hljs-code">    man         = 1</span>

<span class="hljs-code">    if @travelers</span>
<span class="hljs-code">        narrator = 2</span>
<span class="hljs-code">    else</span>
<span class="hljs-code">        narrator = 1</span>

这常常会首先猜测是 [2753]{first_guess}…

<span class="hljs-code">    @first_guess = man + @wives + total_cats + total_kits + narrator</span>

…但实际正确答案是 <span class="hljs-strong">**[1]{answer}**</span>

<span class="hljs-code">    @answer = narrator</span>
</code></pre>
<ul>
<li><code>[我]{travelers: 我们 or 我}</code> 是一个设置指定变量真假值的单选组件，
<ul>
<li><code>travelers</code> 是变量名称，可以在代码块中用 <code>@travelers</code> 来使用该变量。</li>
<li>第一个值为真值，第二个值为假值。</li>
</ul>
</li>
<li><code>[7 个老婆]{wives: 1..10}</code> 是一个滑块组件，值可以在指定范围内变化，这里是1-10之间，
<ul>
<li><code>wives</code>是变量名称，可以在代码块中用 <code>@wives</code> 来使用该变量。</li>
</ul>
</li>
</ul>
<h3 id="yi-ge-geng-fu-za-de-jiao-hu-wen-dang-li-zi" class="heading-control">一个更复杂的交互文档例子<a class="heading-anchor" href="#yi-ge-geng-fu-za-de-jiao-hu-wen-dang-li-zi" aria-hidden="true"></a></h3>
<p><strong>参数</strong>：<span class="AMElement" data-embed="false" data-config="rx:10..">X 坐标:10</span>，<span class="AMElement" data-embed="false" data-config="ry:10..">Y 坐标:18</span>，<span class="AMElement" data-embed="false" data-config="rw:1..">宽:100</span>，<span class="AMElement" data-embed="false" data-config="rh:1..">高:50</span></p>
<p>接下来的例子演示如何使用Raphael动画库绘制一个方形，点击下方的<code>play</code>按钮开始</p>
<pre><code class="output"># demo how to draw a rect.
paper = @canvas

|
~~~
tooltip: set the canvas size:200X100 ::: Init
type:paper.setSize(200,100)\n
tooltip: clear canvas
type:paper.clear()\n
tooltip: init x/y coor, width/height parameters coming from document
type:@rx ||=10\n
type:@ry ||=18\n
type:@rw ||=100\n
type:@rh ||=50\n
tooltip: drawing rect nowing ::: Draw rect
type:rect = paper.rect(@rx, @ry, @rw, @rh)\n
tooltip: fill red for the rect
type:rect.attr('fill', 'red')
moveTo: 8:13
tooltip: you can try it by youself now
</code></pre>
<hr>
<h2 id="biao-ji" class="heading-control">标记<a class="heading-anchor" href="#biao-ji" aria-hidden="true"></a></h2>
<p>交互元素的标记符号和<code>markdown</code>的链接和图像标记符号类似:</p>
<p><code>[text content]{variable_name: configuration}</code></p>
<p>具体请参阅💁🏻‍♂️ <a href="http://riceball.me/imarkdown/reference.html">交互式Markdown文档参考手册</a> .</p>
<h2 id="zuo-zhe" class="heading-control">作者<a class="heading-anchor" href="#zuo-zhe" aria-hidden="true"></a></h2>
<ul>
<li><a href="http://alecperkins.net" target="_blank" rel="noopener">Alec Perkins</a></li>
<li><a href="https://riceball.me">Riceball LEE</a> <a href="https://github.com/snowyu" target="_blank" rel="noopener">https://github.com/snowyu</a></li>
</ul>
<h2 id="credits" class="heading-control">Credits<a class="heading-anchor" href="#credits" aria-hidden="true"></a></h2>
<p>Thanks to <a href="https://github.com/joyrexus" target="_blank" rel="noopener">J Voight</a>, <a href="http://alexcabrera.me/" target="_blank" rel="noopener">Alex Cabrera</a>, <a href="http://johndebs.com/" target="_blank" rel="noopener">John Debs</a>, and <a href="http://supriyosinha.com" target="_blank" rel="noopener">Supriyo Sinha</a> for help with the notation.</p>
<p>The concept and controls are heavily influenced by <a href="http://worrydream.com" target="_blank" rel="noopener">Bret Victor’s</a> <a href="http://worrydream.com/Tangle" target="_blank" rel="noopener">Tangle</a> library for creating reactive documents.</p>
<h2 id="license" class="heading-control">License<a class="heading-anchor" href="#license" aria-hidden="true"></a></h2>
<p>MIT</p>
]]></content>
  </entry>
  <entry>
    <title>tags</title>
    <url>/tags/index.html</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>Interactive Markdown Reference Manual</title>
    <url>/imarkdown/reference.html</url>
    <content><![CDATA[<h2 id="kuo-zhan-biao-ji" class="heading-control">扩展标记<a class="heading-anchor" href="#kuo-zhan-biao-ji" aria-hidden="true"></a></h2>
<p>用于指定元素控件的符号类似于常规的Markdown语法，对于链接和图像，通常遵循以下格式：</p>
<p><code>[文本内容]{variable_name: 可选的配置}</code></p>
<p><code>文本内容</code>是该元素的文本表现，例如链接文本或图像替代文本，位于方括号“[]”之间。方括号后面是花括号“{}”，花括号中包含了<code>变量名</code>和<code>配置</code>(可选)，如果存在<code>配置</code>，则变量名后必须带有一个冒号“:”。 配置是决定元素类型并指定其行为的因素。 例如， 一个范围元素(<em>RangeElement</em>)可以被限制为最小值和最大值，而开关元素(<em>SwitchElement</em>)可以为<code>true</code>和<code>false</code>设置不同的标签。</p>
<h3 id="zi-fu-chuan-yuan-su-stringelement-kong-jian" class="heading-control">字符串元素(StringElement)控件<a class="heading-anchor" href="#zi-fu-chuan-yuan-su-stringelement-kong-jian" aria-hidden="true"></a></h3>
<p><code>[&lt;text&gt;]{&lt;var_name&gt;}</code></p>
<p>显示变量<code>&lt;var_name&gt;</code>的当前值（只读）。<code>&lt;text&gt;</code>是该变量的默认值。</p>
<h4 id="zi-fu-chuan-yuan-su-li-zi" class="heading-control">字符串元素例子<a class="heading-anchor" href="#zi-fu-chuan-yuan-su-li-zi" aria-hidden="true"></a></h4>
<h5 id="string-basic" class="heading-control">String, basic<a class="heading-anchor" href="#string-basic" aria-hidden="true"></a></h5>
<p><span class="AMElement" data-embed="false" data-config="egg_count">many eggs</span> - <code>[many eggs]{egg_count}</code></p>
<table>
<thead>
<tr>
<th>属性</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td><code>egg_count</code></td>
</tr>
<tr>
<td>value</td>
<td><span class="AMElement" data-embed="false" data-config="egg_count">many eggs</span></td>
</tr>
</tbody>
</table>
<h3 id="fan-wei-yuan-su-rangeelement-kong-jian" class="heading-control">范围元素(RangeElement)控件<a class="heading-anchor" href="#fan-wei-yuan-su-rangeelement-kong-jian" aria-hidden="true"></a></h3>
<p><code>[&lt;before&gt; &lt;number&gt;.&lt;decimal&gt; &lt;after&gt;]{&lt;var_name&gt;: &lt;low_bound&gt;..&lt;exclusive&gt;&lt;high_bound&gt; by &lt;step&gt;}</code></p>
<p>范围元素是可以通过拖动调整的数字，类似滑块。该数字可以指定显示精度。该元素可以被限制为最小值和/或最大值，并且可能具有步进值。在<code>文本内容</code>中的第一个数字<code>&lt;number&gt;.&lt;decimal&gt;</code>将作为<code>默认数字值</code>，其它会原样输出，从而允许在控件中包含单位和其他描述性文本。</p>
<p>在<code>配置</code>中必须指定范围，但在两个方向上都可以是无限的(不写值即可)。 范围的间隔是使用’…‘或’…’，其中“…”包含所有内容，而“…” 不包括结尾。 即，“1…4”覆盖区间“<math><mn>1</mn><mo>≤</mo><mi>n</mi><mo>≤</mo><mn>4</mn></math>”，而“1 … 4”覆盖区间“<math><mn>1</mn><mo>≤</mo><mi>n</mi><mo>&lt;</mo><mn>4</mn></math>”。范围必须是递增的（以保持UI的一致性 ———— 向左拖动表示负数，向右拖动表示正数）。 使用关键字“<code>by</code>”和一个数字用以指定<code>步长</code>，该关键字可以省略（默认为1），但如果指定则必须为正。</p>
<p>可以使用<code>文本内容</code>中的<code>默认数字值</code>来指定显示精度。 “<code>200.</code>” 将格式化为 “<code>0</code>” 小数位。 而&quot;<code>200.000</code>“将格式化为”<code>3</code>&quot;小数。 如果未指定，则该值是未格式化的。</p>
<p>数字还可以使用在<a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/Math" target="_blank" rel="noopener"><code>Math</code></a>规范约定的常量，并可以将它们与系数组合，例如“<code>2pi</code>”或“<code>0.5pi</code>”，这将被视为“<code>n * Math.PI</code>”。 这可以写在最小、最大范围或步骤值上。常量必须是<code>e</code>，<code>pi</code>，<code>ln2</code>，<code>ln10</code>，<code>log2e</code>，<code>log10e</code>，<code>sqrt1_2</code>，<code>sqrt2</code>中的一个（大写或小写）。</p>
<h4 id="fan-wei-yuan-su-li-zi" class="heading-control">范围元素例子<a class="heading-anchor" href="#fan-wei-yuan-su-li-zi" aria-hidden="true"></a></h4>
<h5 id="zhi-ding-bu-chang" class="heading-control">指定步长<a class="heading-anchor" href="#zhi-ding-bu-chang" aria-hidden="true"></a></h5>
<p><span class="AMElement" data-embed="false" data-config="calories: 10..100 by 10">20. calories</span> - <code>[20. calories]{calories: 10..100 by 10}</code></p>
<table>
<thead>
<tr>
<th>属性</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr>
<td>变量名称</td>
<td><code>calories</code></td>
</tr>
<tr>
<td>值</td>
<td><span class="AMElement" data-embed="false" data-config="calories"></span></td>
</tr>
<tr>
<td>范围</td>
<td><code>[10,100]</code></td>
</tr>
<tr>
<td>步长</td>
<td><code>10</code></td>
</tr>
<tr>
<td>默认值</td>
<td><code>20</code></td>
</tr>
<tr>
<td>显示精度</td>
<td><code>1</code></td>
</tr>
<tr>
<td>显示格式</td>
<td><code>&quot;#{value.toFixed(0)} calories&quot;</code></td>
</tr>
</tbody>
</table>
<h5 id="xiao-shu-bu-chang-jing-du" class="heading-control">小数步长，精度<a class="heading-anchor" href="#xiao-shu-bu-chang-jing-du" aria-hidden="true"></a></h5>
<p><span class="AMElement" data-embed="false" data-config="calories_2: 10..100 by 0.1">20.0 calories</span> - <code>[20.0 calories]{calories_2: 10..100 by 0.1}</code></p>
<table>
<thead>
<tr>
<th>property</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>变量名称</td>
<td><code>calories_2</code></td>
</tr>
<tr>
<td>值</td>
<td><span class="AMElement" data-embed="false" data-config="calories_2"></span></td>
</tr>
<tr>
<td>范围</td>
<td><code>[10,100]</code></td>
</tr>
<tr>
<td>步长</td>
<td><code>0.1</code></td>
</tr>
<tr>
<td>默认值</td>
<td><code>20.0</code></td>
</tr>
<tr>
<td>显示精度</td>
<td><code>0.1</code></td>
</tr>
<tr>
<td>显示格式</td>
<td><code>&quot;#{value.toFixed(1)} calories&quot;</code></td>
</tr>
</tbody>
</table>
<h5 id="dai-chang-liang" class="heading-control">带常量<a class="heading-anchor" href="#dai-chang-liang" aria-hidden="true"></a></h5>
<p><span class="AMElement" data-embed="false" data-config="period: 0..2pi by 0.25pi">period 0.00</span> - <code>[period 0.00]{period: 0..2pi by 0.25pi}</code></p>
<table>
<thead>
<tr>
<th>property</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>变量名称</td>
<td><code>period</code></td>
</tr>
<tr>
<td>值</td>
<td><span class="AMElement" data-embed="false" data-config="period"></span></td>
</tr>
<tr>
<td>范围</td>
<td><code>[0,2pi]</code></td>
</tr>
<tr>
<td>步长</td>
<td><code>0.25pi</code></td>
</tr>
<tr>
<td>默认值</td>
<td><code>0</code></td>
</tr>
<tr>
<td>显示精度</td>
<td><code>0.01</code></td>
</tr>
<tr>
<td>显示格式</td>
<td><code>&quot;#{value.toFixed(2)} period&quot;</code></td>
</tr>
</tbody>
</table>
<h5 id="mei-you-fan-wei" class="heading-control">没有范围<a class="heading-anchor" href="#mei-you-fan-wei" aria-hidden="true"></a></h5>
<p><span class="AMElement" data-embed="false" data-config="calories_3: ..">20 calories</span> - <code>[20 calories]{calories_3: ..}</code></p>
<table>
<thead>
<tr>
<th>property</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>变量名称</td>
<td><code>calories_3</code></td>
</tr>
<tr>
<td>值</td>
<td><span class="AMElement" data-embed="false" data-config="calories_3"></span></td>
</tr>
<tr>
<td>范围</td>
<td><code>(−∞,∞)</code></td>
</tr>
<tr>
<td>步长</td>
<td><code>1</code></td>
</tr>
<tr>
<td>默认值</td>
<td><code>20</code></td>
</tr>
<tr>
<td>显示精度</td>
<td><code>undefined</code></td>
</tr>
<tr>
<td>显示格式</td>
<td><code>&quot;#{value} calories&quot;</code></td>
</tr>
</tbody>
</table>
<h5 id="mei-you-zui-da-fan-wei" class="heading-control">没有最大范围<a class="heading-anchor" href="#mei-you-zui-da-fan-wei" aria-hidden="true"></a></h5>
<p><span class="AMElement" data-embed="false" data-config="calories_4: 1..">over 200 calories</span> - <code>[over 200 calories]{calories_4: 1.. by 2}</code></p>
<table>
<thead>
<tr>
<th>property</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>变量名称</td>
<td><code>calories_4</code></td>
</tr>
<tr>
<td>值</td>
<td><span class="AMElement" data-embed="false" data-config="calories_4"></span></td>
</tr>
<tr>
<td>范围</td>
<td><code>[1,∞)</code></td>
</tr>
<tr>
<td>步长</td>
<td><code>2</code></td>
</tr>
<tr>
<td>默认值</td>
<td><code>200</code></td>
</tr>
<tr>
<td>显示精度</td>
<td><code>undefined</code></td>
</tr>
<tr>
<td>显示格式</td>
<td><code>&quot;over #{value} calories&quot;</code></td>
</tr>
</tbody>
</table>
<h3 id="kai-guan-yuan-su-switchelement-kong-jian" class="heading-control">开关元素(SwitchElement)控件<a class="heading-anchor" href="#kai-guan-yuan-su-switchelement-kong-jian" aria-hidden="true"></a></h3>
<p><code>[&lt;before&gt; &lt;true_label or false_label or *&gt; &lt;after&gt;]{&lt;var_name&gt;: &lt;true_label&gt; or &lt;false_label&gt;}</code></p>
<p>一个布尔值，其值为<code>true</code>，<code>false</code>或<code>undefined</code>。 真值和假值均可在<code>配置</code>中设定标签。 如果<code>文字内容</code>中有标签，则该值将成为默认值。 否则值为 “<code>undefined</code>”。</p>
<h4 id="kai-guan-yuan-su-li-zi" class="heading-control">开关元素例子<a class="heading-anchor" href="#kai-guan-yuan-su-li-zi" aria-hidden="true"></a></h4>
<h5 id="switch-basic" class="heading-control">Switch, basic<a class="heading-anchor" href="#switch-basic" aria-hidden="true"></a></h5>
<p><span class="AMElement" data-embed="false" data-config="some_flag_1: true or false">pick one</span> - <code>[pick one]{some_flag_1: true or false}</code></p>
<table>
<thead>
<tr>
<th>property</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>变量名称</td>
<td><code>some_flag_1</code></td>
</tr>
<tr>
<td>值</td>
<td><span class="AMElement" data-embed="false" data-config="some_flag_1"></span></td>
</tr>
<tr>
<td>默认值</td>
<td><code>undefined</code></td>
</tr>
<tr>
<td>真值标签</td>
<td><code>true</code></td>
</tr>
<tr>
<td>假值标签</td>
<td><code>false</code></td>
</tr>
<tr>
<td>显示格式</td>
<td><code>&quot;#{label}&quot;</code></td>
</tr>
</tbody>
</table>
<h5 id="switch-with-default" class="heading-control">Switch, with default<a class="heading-anchor" href="#switch-with-default" aria-hidden="true"></a></h5>
<p><span class="AMElement" data-embed="false" data-config="some_flag_2: true or false">true</span> - <code>[true]{some_flag_3: true or false}</code></p>
<table>
<thead>
<tr>
<th>property</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>变量名称</td>
<td><code>some_flag_2</code></td>
</tr>
<tr>
<td>值</td>
<td><span class="AMElement" data-embed="false" data-config="some_flag_2"></span></td>
</tr>
<tr>
<td>默认值</td>
<td><code>true</code></td>
</tr>
<tr>
<td>真值标签</td>
<td><code>true</code></td>
</tr>
<tr>
<td>假值标签</td>
<td><code>false</code></td>
</tr>
<tr>
<td>显示格式</td>
<td><code>&quot;#{label}&quot;</code></td>
</tr>
</tbody>
</table>
<h5 id="switch-default-labeled-before-after-text" class="heading-control">Switch, default, labeled, before/after text<a class="heading-anchor" href="#switch-default-labeled-before-after-text" aria-hidden="true"></a></h5>
<p><span class="AMElement" data-embed="false" data-config="some_flag_3: on or off">on deck</span> - <code>[on deck]{some_flag_3: on or off}</code></p>
<table>
<thead>
<tr>
<th>property</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>变量名称</td>
<td><code>some_flag_3</code></td>
</tr>
<tr>
<td>值</td>
<td><span class="AMElement" data-embed="false" data-config="some_flag_3"></span></td>
</tr>
<tr>
<td>默认值</td>
<td><code>true</code></td>
</tr>
<tr>
<td>真值标签</td>
<td><code>on</code></td>
</tr>
<tr>
<td>假值标签</td>
<td><code>off</code></td>
</tr>
<tr>
<td>显示格式</td>
<td><code>&quot;#{label} deck&quot;</code></td>
</tr>
</tbody>
</table>
<h3 id="tu-biao-yuan-su-chartelement-kong-jian" class="heading-control">图表元素(ChartElement)控件<a class="heading-anchor" href="#tu-biao-yuan-su-chartelement-kong-jian" aria-hidden="true"></a></h3>
<p><code>![&lt;x_label&gt; &lt;delimiter&gt; &lt;y_label&gt;]{&lt;type&gt;=&lt;fn_name&gt;: &lt;bound&gt;..&lt;exclusive&gt;&lt;bound&gt; by &lt;step&gt;}</code></p>
<p>散点图，折线图或条形图的嵌入式图表。 该图表由指定函数(<code>fn_name</code>)在指定范围内驱动。 <em>ChartElement</em> 表示法与<em>RangeElement</em>类似，但是增加了<code>type</code>和前导<code>!</code>。 同样，图表间隔必须是有限的。 图表必须具有在 <em>代码块</em> 中定义的函数<code>fn_name</code>。</p>
<h4 id="tu-biao-yuan-su-li-zi" class="heading-control">图表元素例子<a class="heading-anchor" href="#tu-biao-yuan-su-li-zi" aria-hidden="true"></a></h4>
<h5 id="san-dian-tu-basic" class="heading-control">散点图, basic<a class="heading-anchor" href="#san-dian-tu-basic" aria-hidden="true"></a></h5>
<p><code>![y vs x]{scatter=scatterFn: -10..10}</code></p>
<p><span class="AMElement" data-embed="false" data-config="scatter_offset: 0..100">Offset: 0.</span></p>
<pre><code>@scatterFn = (x) =&gt; x + Math.random() * @scatter_offset
</code></pre>
<p><span class="AMElement" data-embed="true" data-config="scatter=scatterFn: -10..10">y vs x</span></p>
<table>
<thead>
<tr>
<th>property</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>变量名称</td>
<td><code>scatterFn</code></td>
</tr>
<tr>
<td>类型</td>
<td><code>scatter</code></td>
</tr>
<tr>
<td>x 标签</td>
<td><code>&quot;x&quot;</code></td>
</tr>
<tr>
<td>y 标签</td>
<td><code>&quot;y&quot;</code></td>
</tr>
<tr>
<td>x的范围</td>
<td><code>[-10,10]</code></td>
</tr>
<tr>
<td>步长</td>
<td><code>1</code></td>
</tr>
</tbody>
</table>
<h5 id="zhe-xian-tu-basic" class="heading-control">折线图, basic<a class="heading-anchor" href="#zhe-xian-tu-basic" aria-hidden="true"></a></h5>
<p><code>![sin(x)]{line=lineFn: 0..2pi by 0.001}</code></p>
<p><span class="AMElement" data-embed="false" data-config="period: 0.25..4 by 0.25">Period 1.00</span></p>
<pre><code>b = 2 * Math.PI / @period
@lineFn = (x) =&gt; Math.sin(b * x)
</code></pre>
<p><span class="AMElement" data-embed="true" data-config="line=lineFn: 0..2pi by 0.001">sin(x)</span></p>
<table>
<thead>
<tr>
<th>property</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>变量名称</td>
<td><code>lineFn</code></td>
</tr>
<tr>
<td>类型</td>
<td><code>line</code></td>
</tr>
<tr>
<td>x 标签</td>
<td><code>null</code></td>
</tr>
<tr>
<td>y 标签</td>
<td><code>null</code></td>
</tr>
<tr>
<td>x的范围</td>
<td><code>[0,2pi]</code></td>
</tr>
<tr>
<td>步长</td>
<td><code>0.001</code></td>
</tr>
</tbody>
</table>
<h5 id="tiao-xing-tu-basic" class="heading-control">条形图, basic<a class="heading-anchor" href="#tiao-xing-tu-basic" aria-hidden="true"></a></h5>
<p><code>![money by year]{bar=barFn: 1983..2013}</code></p>
<p><span class="AMElement" data-embed="false" data-config="threshold: 1..20">Threshold: 5.</span></p>
<pre><code>@barFn = (x) =&gt; x % @threshold
</code></pre>
<p><span class="AMElement" data-embed="true" data-config="bar=barFn: 1983..2013">money by year</span></p>
<table>
<thead>
<tr>
<th>property</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>变量名称</td>
<td><code>barFn</code></td>
</tr>
<tr>
<td>类型</td>
<td><code>bar</code></td>
</tr>
<tr>
<td>x 标签</td>
<td><code>&quot;year&quot;</code></td>
</tr>
<tr>
<td>y 标签</td>
<td><code>&quot;money&quot;</code></td>
</tr>
<tr>
<td>x的范围</td>
<td><code>[1983,2013]</code></td>
</tr>
<tr>
<td>步长</td>
<td><code>1</code></td>
</tr>
</tbody>
</table>
<h2 id="jiao-hu-dai-ma-kuai-codeblockelement-yuan-su-kong-jian" class="heading-control">交互代码块(CodeBlockElement)元素控件<a class="heading-anchor" href="#jiao-hu-dai-ma-kuai-codeblockelement-yuan-su-kong-jian" aria-hidden="true"></a></h2>
<p>交互的代码块同样遵循Markdown规范，可以是缩进4格或者三个&quot;```&quot;个符号（无语言指示）围绕的内容,例如：代码的语法是使用的<a href="https://coffeescript.org/v1/" target="_blank" rel="noopener">CoffeeScript@v1</a>的语法。</p>
<pre><code class="markdown">
<span class="hljs-section"># 缩进4格</span>

<span class="hljs-code">    # 设置交互变量初值， ||表示当存在初始值的时候不设置。</span>
<span class="hljs-code">    @my_var ||= 123</span>
<span class="hljs-code">    # 设置函数</span>
<span class="hljs-code">    # @my_func = (x) =&gt; sin(x + @my_var)</span>


<span class="hljs-section"># 使用普通没有language的代码块</span>


<span class="hljs-code">```
# 设置交互变量初值， ||表示当存在初始值的时候不设置。
@my_var ||= 123
# 设置函数
@my_func = (x) =&gt; sin(x + @my_var)
```</span>
</code></pre>
<p>如果希望只是显示代码块内容而不是执行，请使用加了语言的代码块，如:</p>
<pre><code class="markdown">

<span class="hljs-code">```coffee
# 该代码块不会执行，不是交互代码块，只会显示
@my_var ||= 123
# 设置函数
@my_func = (x) =&gt; sin(x + @my_var)
```</span>
</code></pre>
<p>未来可能将支持指定交互语言，使用语言加后缀&quot;/playable&quot;的语法,例如如果希望使用js:</p>
<pre><code class="md"><span class="hljs-code">```</span>js/playable
// js交互代码块
<span class="hljs-code">```
</span></code></pre>
<p>如果该代码块带输出，则在语言上使用<code>output</code>，表示默认语言带输出的代码块，如果要指定语言则应该加在playable前面，并用“:”号分隔, 如，<code>output:playable</code>。</p>
<pre><code class="md"><span class="hljs-code">```output
# 默认语言带输出的代码块
@sayln 'hi world'
```</span>

<span class="hljs-code">```</span>coffee/output:playable
<span class="hljs-section"># 指定语言带输出的代码块，暂未实现，指定语言没有，全部都是coffee.</span>
@sayln 'hi world'
<span class="hljs-code">```
</span></code></pre>
<p>带输出的代码块有<code>@output</code>变量(为该块绑定的<code>div</code>元素)，<code>@say()</code>和<code>@sayln()</code>文本输出。</p>
<h3 id="play-movie-for-codeblock" class="heading-control">Play Movie for CodeBlock<a class="heading-anchor" href="#play-movie-for-codeblock" aria-hidden="true"></a></h3>
<p><strong>警告：该标记因为尚未完全确定，未来可能会有改变</strong></p>
<p>可以象电影一样播放代码块的输入。在代码块中单行启用三个<code>~~~</code>或三个以上的波浪符号<code>~</code>分隔即可。波浪分隔符号<code>~~~</code>以上的为代码，代码上方的“|”表示演示完毕后的光标位置，下方为控制输入的电影代码.</p>
<pre><code class="md">
<span class="hljs-code">```</span>output:playable

<span class="hljs-section"># 演示绘制矩形的过程</span>
paper = @canvas

|
~~~
tooltip: 设置画布大小为200X100 ::: 初始化工作
type:paper.setSize(200,100)\n
tooltip: 清空画布
type:paper.clear()\n
tooltip: 初始化来自文档的x,y座标，宽度和高度参数变量
type:@rx ||=10\n
type:@ry ||=18\n
type:@rw ||=100\n
type:@rh ||=50\n
tooltip: 开始绘制矩形 ::: 绘制矩形
type:rect = paper.rect(@rx, @ry, @rw, @rh)\n
tooltip: 为矩形填充红色
type:rect.attr('fill', 'red')
moveTo: 8:13
tooltip: 现在你可以自己试一试了
<span class="hljs-code">```
</span></code></pre>
<ul>
<li><code>tooltip</code> : 显示一个冒泡提示
<ul>
<li><code>:::</code> 分隔后的为分类信息</li>
</ul>
</li>
<li><code>type</code>: 模拟键盘输入内容</li>
<li><code>moveTo</code>: 移动光标位置</li>
</ul>
<h3 id="codeblock-examples" class="heading-control">CodeBlock Examples<a class="heading-anchor" href="#codeblock-examples" aria-hidden="true"></a></h3>
<h4 id="example-interactive-code-block-without-output" class="heading-control">Example: interactive code block without output<a class="heading-anchor" href="#example-interactive-code-block-without-output" aria-hidden="true"></a></h4>
<pre><code># this is an interactive code block without output
a = 12 + 3
</code></pre>
<h4 id="example-interactive-code-block-with-output" class="heading-control">Example: interactive code block with output<a class="heading-anchor" href="#example-interactive-code-block-with-output" aria-hidden="true"></a></h4>
<pre><code class="output"># this is an interactive code block with output
@sayln 'hi world'
</code></pre>
<h4 id="example-play-movie-for-codeblock" class="heading-control">Example: Play Movie for CodeBlock<a class="heading-anchor" href="#example-play-movie-for-codeblock" aria-hidden="true"></a></h4>
<pre><code class="output:playable">
# 演示绘制矩形的过程
paper = @canvas

|
~~~
tooltip: 设置画布大小为200X100 ::: 初始化工作
type:paper.setSize(200,100)\n
tooltip: 清空画布
type:paper.clear()\n
tooltip: 初始化来自文档的x,y座标，宽度和高度参数变量
type:@rx ||=10\n
type:@ry ||=18\n
type:@rw ||=100\n
type:@rh ||=50\n
tooltip: 开始绘制矩形 ::: 绘制矩形
type:rect = paper.rect(@rx, @ry, @rw, @rh)\n
tooltip: 为矩形填充红色
type:rect.attr('fill', 'red')
moveTo: 8:13
tooltip: 现在你可以自己试一试了
</code></pre>
]]></content>
  </entry>
  <entry>
    <title>Interactive Markdown</title>
    <url>/imarkdown/en/index.html</url>
    <content><![CDATA[<h2 id="introduction" class="heading-control">Introduction<a class="heading-anchor" href="#introduction" aria-hidden="true"></a></h2>
<p><a href="http://riceball.me/imarkdown/en">Interactive Markdown</a> is a tool for making reactive/interactive documents — using a plain text markdown source, with a special notation for adding interactive controls and variables. The logic is determined by the content of the code blocks, which is actually executed on-the-fly to update the variables.</p>
<p>More detail see 💁🏻‍♂️ <a href="http://riceball.me/imarkdown/en/reference.html">Interactive Markdown Reference Manual</a> for a complete reference of the elements and their configuration.</p>
<p>Status: Alpha Test</p>
<a id="more"></a>
<p>An Example Interactive document looks like this:</p>
<h3 id="st-ives-example" class="heading-control">St.Ives Example<a class="heading-anchor" href="#st-ives-example" aria-hidden="true"></a></h3>
<p>An old riddle.</p>
<blockquote>
<p>As <span class="AMElement" data-embed="false" data-config="travelers: we or I">I</span> <span class="AMElement" data-embed="false" data-config="verb">was</span> going to <em>St Ives</em><br>
I met a man with <span class="AMElement" data-embed="false" data-config="wives: 1..10">7 wives</span><br>
Every wife had <span class="AMElement" data-embed="false" data-config="sacks: 1..10">7 sacks</span><br>
Every sack had <span class="AMElement" data-embed="false" data-config="cats: 1..10">7 cats</span><br>
Every cat had <span class="AMElement" data-embed="false" data-config="kits: 1..10">7 kits</span><br>
Kits, cats, sacks, wives<br>
How many were going to St Ives?</p>
</blockquote>
<pre><code>total_sacks = @wives * @sacks
total_cats  = total_sacks * @cats
total_kits  = total_cats * @kits
man         = 1

if @travelers
    narrator = 2
    @verb = 'were'
else
    narrator = 1
    @verb = 'was'
</code></pre>
<p>The first guess is often <span class="AMElement" data-embed="false" data-config="first_guess">2753</span>…</p>
<pre><code>@first_guess = man + @wives + total_cats + total_kits + narrator
</code></pre>
<p>…but the correct answer is <strong><span class="AMElement" data-embed="false" data-config="answer">1</span></strong>.</p>
<pre><code>@answer = narrator
</code></pre>
<hr>
<p>The sample raw Interactive Markdown file is:</p>
<pre><code class="md">An old riddle.

<span class="hljs-quote">&gt; As [I]{travelers: we or I} [was]{verb} going to *St Ives*</span>
<span class="hljs-quote">&gt; I met a man with [7 wives]{wives: 1..10}</span>
<span class="hljs-quote">&gt; Every wife had [7 sacks]{sacks: 1..10}</span>
<span class="hljs-quote">&gt; Every sack had [7 cats]{cats: 1..10}</span>
<span class="hljs-quote">&gt; Every cat had [7 kits]{kits: 1..10}</span>
<span class="hljs-quote">&gt; Kits, cats, sacks, wives</span>
<span class="hljs-quote">&gt; How many were going to St Ives?</span>

<span class="hljs-code">    total_sacks = @wives * @sacks</span>
<span class="hljs-code">    total_cats  = total_sacks * @cats</span>
<span class="hljs-code">    total_kits  = total_cats * @kits</span>
<span class="hljs-code">    man         = 1</span>

<span class="hljs-code">    if @travelers</span>
<span class="hljs-code">        narrator = 2</span>
<span class="hljs-code">        @verb = 'were'</span>
<span class="hljs-code">    else</span>
<span class="hljs-code">        narrator = 1</span>
<span class="hljs-code">        @verb = 'was'</span>

The first guess is often [2753]{first_guess}…

<span class="hljs-code">    @first_guess = man + @wives + total_cats + total_kits + narrator</span>

…but the correct answer is <span class="hljs-strong">**[1]{answer}**</span>.

<span class="hljs-code">    @answer = narrator</span>
</code></pre>
<ul>
<li><code>[I]{travelers: We or I}</code> is a toggle switch between <code>We</code> or <code>I</code>
<ul>
<li><code>travelers</code> is a variable name, It can be referenced <code>@travelers</code> in the code block.</li>
<li>the first value is <code>true</code>, the second is <code>false</code>.</li>
</ul>
</li>
<li><code>[7]{wives: 1..10}</code> is a slider from <code>1</code> to <code>10</code>, defaults to <code>7</code>
<ul>
<li><code>wives</code> is a variable name, It can be referenced <code>@wives</code> in the code block.</li>
</ul>
</li>
</ul>
<h3 id="a-more-complex-example" class="heading-control">A More Complex Example<a class="heading-anchor" href="#a-more-complex-example" aria-hidden="true"></a></h3>
<p><strong>Parameters</strong>：<span class="AMElement" data-embed="false" data-config="rx:10..">X Coor:10</span>，<span class="AMElement" data-embed="false" data-config="ry:10..">Y Coor:18</span>，<span class="AMElement" data-embed="false" data-config="rw:1..">Width:100</span>，<span class="AMElement" data-embed="false" data-config="rh:1..">Height:50</span></p>
<p>Following will show howto draw a rect with Raphael animation library, Click the <code>play</code> button to begin:</p>
<pre><code class="output"># demo how to draw a rect.
paper = @canvas

|
~~~
tooltip: set the canvas size:200X100 ::: Init
type:paper.setSize(200,100)\n
tooltip: clear canvas
type:paper.clear()\n
tooltip: init x/y coor, width/height parameters coming from document
type:@rx ||=10\n
type:@ry ||=18\n
type:@rw ||=100\n
type:@rh ||=50\n
tooltip: drawing rect nowing ::: Draw rect
type:rect = paper.rect(@rx, @ry, @rw, @rh)\n
tooltip: fill red for the rect
type:rect.attr('fill', 'red')
moveTo: 8:13
tooltip: you can try it by youself now
</code></pre>
<hr>
<h2 id="notation" class="heading-control">Notation<a class="heading-anchor" href="#notation" aria-hidden="true"></a></h2>
<p>The notation for specifying elements is similar to the regular Markdown syntax<br>
for links and images, generally following this format:</p>
<p><code>[text content]{variable_name: configuration}</code></p>
<p>More detail see 💁🏻‍♂️ <a href="http://riceball.me/imarkdown/en/reference.html">Interactive Markdown Reference Manual</a> for a<br>
complete reference of the elements and their configuration.</p>
<h2 id="authors" class="heading-control">Authors<a class="heading-anchor" href="#authors" aria-hidden="true"></a></h2>
<ul>
<li><a href="http://alecperkins.net" target="_blank" rel="noopener">Alec Perkins</a></li>
<li><a href="https://riceball.me">Riceball LEE</a> <a href="https://github.com/snowyu" target="_blank" rel="noopener">https://github.com/snowyu</a></li>
</ul>
<h2 id="credits" class="heading-control">Credits<a class="heading-anchor" href="#credits" aria-hidden="true"></a></h2>
<p>Thanks to <a href="https://github.com/joyrexus" target="_blank" rel="noopener">J Voight</a>, <a href="http://alexcabrera.me/" target="_blank" rel="noopener">Alex Cabrera</a>, <a href="http://johndebs.com/" target="_blank" rel="noopener">John Debs</a>, and <a href="http://supriyosinha.com" target="_blank" rel="noopener">Supriyo Sinha</a> for help with the notation.</p>
<p>The concept and controls are heavily influenced by <a href="http://worrydream.com" target="_blank" rel="noopener">Bret Victor’s</a> <a href="http://worrydream.com/Tangle" target="_blank" rel="noopener">Tangle</a> library for creating reactive documents.</p>
<h2 id="license" class="heading-control">License<a class="heading-anchor" href="#license" aria-hidden="true"></a></h2>
<p>MIT</p>
]]></content>
  </entry>
  <entry>
    <title>Interactive Markdown Reference Manual</title>
    <url>/imarkdown/en/reference.html</url>
    <content><![CDATA[<h2 id="notation" class="heading-control">Notation<a class="heading-anchor" href="#notation" aria-hidden="true"></a></h2>
<p>The notation for specifying elements is similar to the regular Markdown syntax<br>
for links and images, generally following this format:</p>
<p><code>[text content]{variable_name: configuration}</code></p>
<p>The text representation of the element, like the link text or image alt text,<br>
goes between the brackets, <code>[]</code>. The brackets are followed by braces, <code>{}</code>,<br>
which contain the variable name, and any configuration. The variable name MUST<br>
be followed by a colon, <code>:</code>, if there is any configuration present. The<br>
configuration is what determines the kind of element, and specifies its<br>
behavior. For example, a <em>RangeElement</em> can be constrained to a minimum and<br>
maximum, and a <em>SwitchElement</em> can be given different labels for <code>true</code> and<br>
<code>false</code>.</p>
<h3 id="stringelement" class="heading-control">StringElement<a class="heading-anchor" href="#stringelement" aria-hidden="true"></a></h3>
<p>A read-only output of the current value of the specified variable <code>&lt;var_name&gt;</code>.<br>
The text is the default value, and used whenever the value of the variable is<br>
<code>undefined</code>.</p>
<p><code>[&lt;text&gt;]{&lt;var_name&gt;}</code></p>
<h4 id="stringelement-examples" class="heading-control">StringElement Examples<a class="heading-anchor" href="#stringelement-examples" aria-hidden="true"></a></h4>
<h5 id="string-basic" class="heading-control">String, basic<a class="heading-anchor" href="#string-basic" aria-hidden="true"></a></h5>
<p><span class="AMElement" data-embed="false" data-config="egg_count">many eggs</span> - <code>[many eggs]{egg_count}</code></p>
<p>| property              | value                             |<br>
|=<mark><mark><mark><mark><mark><mark><mark><mark><mark><mark><mark>|</mark></mark></mark></mark></mark></mark></mark></mark></mark></mark></mark>=============|<br>
| name                  | <code>egg_count</code>                       |<br>
| value                 | <span class="AMElement" data-embed="false" data-config="egg_count">many eggs</span>            |</p>
<h3 id="rangeelement" class="heading-control">RangeElement<a class="heading-anchor" href="#rangeelement" aria-hidden="true"></a></h3>
<p>A number adjustable by dragging. The number MAY have a display precision<br>
specified. The slider MAY be constrained to a minimum and/or maximum, and MAY<br>
have a step value. The text is parsed, and the first number in the text becomes<br>
the output value. The remaining text is added to the template, allowing for<br>
units and other descriptive text to be included in the control.</p>
<p>A range MUST be specified, but MAY be infinite in both directions. The range’s<br>
interval is specified using the <a href="http://coffeescript.org/#loops" target="_blank" rel="noopener">CoffeeScript-style range<br>
dots</a>, where <code>..</code> is inclusive and <code>...</code><br>
excludes the end. ie, <code>1..4</code> covers the interval <code>1 &lt;= n &lt;= 4</code>, while <code>1...4</code><br>
covers <code>1 &lt;= n &lt; 4</code>. The range MUST be ascending (to preserve consistency in<br>
the UI — drag left for negative, drag right for positive). The range’s step is<br>
specified using the <code>by</code> keyword and a number. The step MAY be omitted<br>
(defaulting to <code>1</code>), but if specified MUST be positive.</p>
<p>The text content MAY include a number to use as the default value. Any<br>
surrounding text will be used as a template, allowing units or qualifiers to<br>
be included in the element’s presentation.</p>
<p>Specifying a display precision MAY be done using the default number value in<br>
the text. <code>200.</code> formats to <code>0</code> decimal places. <code>200.000</code> formats to <code>3</code><br>
decimals. If not specified, the value is unformatted.</p>
<p>Numbers MAY use the constants in <a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/Math" target="_blank" rel="noopener"><code>Math</code></a><br>
and combine them with a coefficient, eg <code>2pi</code> or <code>0.5pi</code>, which is treated as<br>
<code>n * Math.PI</code>. This can be done in the range min or max, or in the step. The<br>
constants MUST be one of <code>e</code>, <code>pi</code>, <code>ln2</code>, <code>ln10</code>, <code>log2e</code>, <code>log10e</code>, <code>sqrt1_2</code>,<br>
<code>sqrt2</code>, (uppercase or lowercase).</p>
<p><code>[&lt;before&gt; &lt;number&gt;.&lt;decimal&gt; &lt;after&gt;]{&lt;var_name&gt;: &lt;bound&gt;..&lt;exclusive&gt;&lt;bound&gt; by &lt;step&gt;}</code></p>
<h4 id="rangeelement-examples" class="heading-control">RangeElement Examples<a class="heading-anchor" href="#rangeelement-examples" aria-hidden="true"></a></h4>
<h5 id="specifying-step" class="heading-control">Specifying step<a class="heading-anchor" href="#specifying-step" aria-hidden="true"></a></h5>
<p><span class="AMElement" data-embed="false" data-config="calories: 10..100 by 10">20. calories</span> - <code>[20. calories]{calories: 10..100 by 10}</code></p>
<p>| property              | value                             |<br>
|=<mark><mark><mark><mark><mark><mark><mark><mark><mark><mark><mark>|</mark></mark></mark></mark></mark></mark></mark></mark></mark></mark></mark>=============|<br>
| name                  | <code>calories</code>                        |<br>
| value                 | <span class="AMElement" data-embed="false" data-config="calories"></span>                      |<br>
| interval              | <code>[10,100]</code>                        |<br>
| step                  | <code>10</code>                              |<br>
| default               | <code>20</code>                              |<br>
| display precision     | <code>1</code>                               |<br>
| display format        | <code>&quot;#{value.toFixed(0)} calories&quot;</code>  |</p>
<h5 id="fractional-step-precision" class="heading-control">Fractional step, precision<a class="heading-anchor" href="#fractional-step-precision" aria-hidden="true"></a></h5>
<p><span class="AMElement" data-embed="false" data-config="calories_2: 10..100 by 0.1">20.0 calories</span> - <code>[20.0 calories]{calories_2: 10..100 by 0.1}</code></p>
<p>| property              | value                             |<br>
|=<mark><mark><mark><mark><mark><mark><mark><mark><mark><mark><mark>|</mark></mark></mark></mark></mark></mark></mark></mark></mark></mark></mark>=============|<br>
| name                  | <code>calories_2</code>                      |<br>
| value                 | <span class="AMElement" data-embed="false" data-config="calories_2"></span>                    |<br>
| interval              | <code>[10,100]</code>                        |<br>
| step                  | <code>0.1</code>                             |<br>
| default               | <code>20.0</code>                            |<br>
| display precision     | <code>0.1</code>                             |<br>
| display format        | <code>&quot;#{value.toFixed(1)} calories&quot;</code>  |</p>
<h5 id="with-constants" class="heading-control">With constants<a class="heading-anchor" href="#with-constants" aria-hidden="true"></a></h5>
<p><span class="AMElement" data-embed="false" data-config="period: 0..2pi by 0.25pi">period 0.00</span> - <code>[period 0.00]{period: 0..2pi by 0.25pi}</code></p>
<p>| property              | value                             |<br>
|=<mark><mark><mark><mark><mark><mark><mark><mark><mark><mark><mark>|</mark></mark></mark></mark></mark></mark></mark></mark></mark></mark></mark>=============|<br>
| name                  | <code>period</code>                          |<br>
| value                 | <span class="AMElement" data-embed="false" data-config="period"></span>                        |<br>
| interval              | <code>[0,2pi]</code>                         |<br>
| step                  | <code>0.25pi</code>                          |<br>
| default               | <code>0</code>                               |<br>
| display precision     | <code>0.01</code>                            |<br>
| display format        | <code>&quot;#{value.toFixed(2)} period&quot;</code>    |</p>
<h5 id="unbounded" class="heading-control">Unbounded<a class="heading-anchor" href="#unbounded" aria-hidden="true"></a></h5>
<p><span class="AMElement" data-embed="false" data-config="calories_3: ..">20 calories</span> - <code>[20 calories]{calories_3: ..}</code></p>
<p>| property              | value                             |<br>
|=<mark><mark><mark><mark><mark><mark><mark><mark><mark><mark><mark>|</mark></mark></mark></mark></mark></mark></mark></mark></mark></mark></mark>=============|<br>
| name                  | <code>calories_3</code>                      |<br>
| value                 | <span class="AMElement" data-embed="false" data-config="calories_3"></span>                    |<br>
| interval              | <code>(−∞,∞)</code>                          |<br>
| step                  | <code>1</code>                               |<br>
| default               | <code>20</code>                              |<br>
| display precision     | <code>undefined</code>                       |<br>
| display format        | <code>&quot;#{value} calories&quot;</code>             |</p>
<h5 id="unbounded-right-before-text" class="heading-control">Unbounded right, before text<a class="heading-anchor" href="#unbounded-right-before-text" aria-hidden="true"></a></h5>
<p><span class="AMElement" data-embed="false" data-config="calories_4: 1..">over 200 calories</span> - <code>[over 200 calories]{calories_4: 1.. by 2}</code></p>
<p>| property              | value                             |<br>
|=<mark><mark><mark><mark><mark><mark><mark><mark><mark><mark><mark>|</mark></mark></mark></mark></mark></mark></mark></mark></mark></mark></mark>=============|<br>
| name                  | <code>calories_4</code>                      |<br>
| value                 | <span class="AMElement" data-embed="false" data-config="calories_4"></span>                    |<br>
| interval              | <code>[1,∞)</code>                           |<br>
| step                  | <code>2</code>                               |<br>
| default               | <code>200</code>                             |<br>
| display precision     | <code>undefined</code>                       |<br>
| display format        | <code>&quot;over #{value} calories&quot;</code>        |</p>
<h3 id="switchelement" class="heading-control">SwitchElement<a class="heading-anchor" href="#switchelement" aria-hidden="true"></a></h3>
<p>A boolean flag that has a value of <code>true</code>, <code>false</code>, or <code>undefined</code>. The true<br>
and false values can be labeled. If the label is present in the text, that value<br>
becomes the default value. Otherwise, the value is <code>undefined</code>.</p>
<p><code>[&lt;before&gt; &lt;true_label or false_label or *&gt; &lt;after&gt;]{&lt;var_name&gt;: &lt;true_label&gt; or &lt;false_label&gt;}</code></p>
<h4 id="switchelement-examples" class="heading-control">SwitchElement Examples<a class="heading-anchor" href="#switchelement-examples" aria-hidden="true"></a></h4>
<h5 id="switch-basic" class="heading-control">Switch, basic<a class="heading-anchor" href="#switch-basic" aria-hidden="true"></a></h5>
<p><span class="AMElement" data-embed="false" data-config="some_flag_1: true or false">pick one</span> - <code>[pick one]{some_flag_1: true or false}</code></p>
<p>| property              | value                             |<br>
|=<mark><mark><mark><mark><mark><mark><mark><mark><mark><mark><mark>|</mark></mark></mark></mark></mark></mark></mark></mark></mark></mark></mark>=============|<br>
| name                  | <code>some_flag_1</code>                     |<br>
| value                 | <span class="AMElement" data-embed="false" data-config="some_flag_1"></span>                   |<br>
| default               | <code>undefined</code>                       |<br>
| true label            | <code>true</code>                            |<br>
| false label           | <code>false</code>                           |<br>
| display format        | <code>&quot;#{label}&quot;</code>                      |</p>
<h5 id="switch-with-default" class="heading-control">Switch, with default<a class="heading-anchor" href="#switch-with-default" aria-hidden="true"></a></h5>
<p><span class="AMElement" data-embed="false" data-config="some_flag_2: true or false">true</span> - <code>[true]{some_flag_3: true or false}</code></p>
<p>| property              | value                             |<br>
|=<mark><mark><mark><mark><mark><mark><mark><mark><mark><mark><mark>|</mark></mark></mark></mark></mark></mark></mark></mark></mark></mark></mark>=============|<br>
| name                  | <code>some_flag_2</code>                     |<br>
| value                 | <span class="AMElement" data-embed="false" data-config="some_flag_2"></span>                   |<br>
| default               | <code>true</code>                            |<br>
| true label            | <code>true</code>                            |<br>
| false label           | <code>false</code>                           |<br>
| display format        | <code>&quot;#{label}&quot;</code>                      |</p>
<h5 id="switch-default-labeled-before-after-text" class="heading-control">Switch, default, labeled, before/after text<a class="heading-anchor" href="#switch-default-labeled-before-after-text" aria-hidden="true"></a></h5>
<p><span class="AMElement" data-embed="false" data-config="some_flag_3: on or off">on deck</span> - <code>[on deck]{some_flag_3: on or off}</code></p>
<p>| property              | value                             |<br>
|=<mark><mark><mark><mark><mark><mark><mark><mark><mark><mark><mark>|</mark></mark></mark></mark></mark></mark></mark></mark></mark></mark></mark>=============|<br>
| name                  | <code>some_flag_3</code>                     |<br>
| value                 | <span class="AMElement" data-embed="false" data-config="some_flag_3"></span>                   |<br>
| default               | <code>true</code>                            |<br>
| true label            | <code>on</code>                              |<br>
| false label           | <code>off</code>                             |<br>
| display format        | <code>&quot;#{label} deck&quot;</code>                 |</p>
<h3 id="chartelement" class="heading-control">ChartElement<a class="heading-anchor" href="#chartelement" aria-hidden="true"></a></h3>
<p>An embedded chart, of type scatter, line, or bar. The chart is driven by the<br>
specified function over the specified range. The <em>ChartElement</em> notation is<br>
similar to the <em>RangeElement</em>, but with the addition of the <code>type</code>, and the<br>
leading <code>!</code>. Also, the chart interval MUST be finite. Charts MUST have a<br>
function defined in an <em>ActiveCodeBlock</em>.</p>
<p><code>![&lt;x_label&gt; &lt;delimiter&gt; &lt;y_label&gt;]{&lt;type&gt;=&lt;fn_name&gt;: &lt;bound&gt;..&lt;exclusive&gt;&lt;bound&gt; by &lt;step&gt;}</code></p>
<h4 id="chartelement-examples" class="heading-control">ChartElement Examples<a class="heading-anchor" href="#chartelement-examples" aria-hidden="true"></a></h4>
<h5 id="scatter-basic" class="heading-control">Scatter, basic<a class="heading-anchor" href="#scatter-basic" aria-hidden="true"></a></h5>
<p><code>![y vs x]{scatter=scatterFn: -10..10}</code></p>
<p><span class="AMElement" data-embed="false" data-config="scatter_offset: 0..100">Offset: 0.</span></p>
<pre><code>@scatterFn = (x) =&gt;
    return x + Math.random() * @scatter_offset
</code></pre>
<p><span class="AMElement" data-embed="true" data-config="scatter=scatterFn: -10..10">y vs x</span></p>
<p>| property              | value                             |<br>
|=<mark><mark><mark><mark><mark><mark><mark><mark><mark><mark><mark>|</mark></mark></mark></mark></mark></mark></mark></mark></mark></mark></mark>=============|<br>
| name                  | <code>scatterFn</code>                       |<br>
| type                  | <code>scatter</code>                         |<br>
| x label               | <code>&quot;x&quot;</code>                             |<br>
| y label               | <code>&quot;y&quot;</code>                             |<br>
| interval              | <code>[-10,10]</code>                        |<br>
| step                  | <code>1</code>                               |</p>
<h5 id="line-basic" class="heading-control">Line, basic<a class="heading-anchor" href="#line-basic" aria-hidden="true"></a></h5>
<p><code>![sin(x)]{line=lineFn: 0..2pi by 0.001}</code></p>
<p><span class="AMElement" data-embed="false" data-config="period: 0.25..4 by 0.25">Period 1.00</span></p>
<pre><code>b = 2 * Math.PI / @period
@lineFn = (x) =&gt;
    return Math.sin(b * x)
</code></pre>
<p><span class="AMElement" data-embed="true" data-config="line=lineFn: 0..2pi by 0.001">sin(x)</span></p>
<p>| property              | value                             |<br>
|=<mark><mark><mark><mark><mark><mark><mark><mark><mark><mark><mark>|</mark></mark></mark></mark></mark></mark></mark></mark></mark></mark></mark>=============|<br>
| name                  | <code>lineFn</code>                          |<br>
| type                  | <code>line</code>                            |<br>
| x label               | <code>null</code>                            |<br>
| y label               | <code>null</code>                            |<br>
| interval              | <code>[0,2pi]</code>                         |<br>
| step                  | <code>0.001</code>                           |</p>
<h5 id="bar-basic" class="heading-control">Bar, basic<a class="heading-anchor" href="#bar-basic" aria-hidden="true"></a></h5>
<p><code>![money by year]{bar=barFn: 1983..2013}</code></p>
<p><span class="AMElement" data-embed="false" data-config="threshold: 1..20">Threshold: 5.</span></p>
<pre><code>@barFn = (x) =&gt;
    return x % @threshold
</code></pre>
<p><span class="AMElement" data-embed="true" data-config="bar=barFn: 1983..2013">money by year</span></p>
<p>| property              | value                             |<br>
|=<mark><mark><mark><mark><mark><mark><mark><mark><mark><mark><mark>|</mark></mark></mark></mark></mark></mark></mark></mark></mark></mark></mark>=============|<br>
| name                  | <code>barFn</code>                           |<br>
| type                  | <code>bar</code>                             |<br>
| x label               | <code>&quot;year&quot;</code>                          |<br>
| y label               | <code>&quot;money&quot;</code>                         |<br>
| interval              | <code>[1983,2013]</code>                     |<br>
| step                  | <code>1</code>                               |</p>
<h2 id="codeblockelement" class="heading-control">CodeBlockElement<a class="heading-anchor" href="#codeblockelement" aria-hidden="true"></a></h2>
<p>The interactive code block also follows the Markdown specification. It can be indented by 4 spaces or three “`” symbols (without language instructions) around it. The code language is <a href="https://coffeescript.org/v1/" target="_blank" rel="noopener">CoffeeScript@v1</a></p>
<pre><code class="markdown">
<span class="hljs-section"># Indented by 4 spaces</span>

<span class="hljs-code">    # initilizate the my_var variable， || means only init when no default value.</span>
<span class="hljs-code">    @my_var ||= 123</span>
<span class="hljs-code">    # set my_func function.</span>
<span class="hljs-code">    @my_func = (x) =&gt; sin(x + @my_var)</span>

<span class="hljs-section"># Three "`" symbols (without language instructions) around it</span>

<span class="hljs-code">```
# initilizate the my_var variable， || means only init when no default value.
@my_var ||= 123
# set my_func function.
@my_func = (x) =&gt; sin(x + @my_var)
```</span>
</code></pre>
<p>Three “`” symbols (with language instructions) around it will dispay the code block only.</p>
<pre><code class="markdown"><span class="hljs-code">```coffee
## This code will not be executed, just display it.
@my_var ||= 123
@my_func = (x) =&gt; sin(x + @my_var)
```</span>
</code></pre>
<p>The Simple Code Block has not any output. You can do some logical work in it.</p>
<p>You should use the <code>output</code> as the language if you wanna with output on it. If you want to specify a language, you should put it in front of <code>playable</code> and separate it with a “:” sign, for example, <code>output:playable</code>.</p>
<pre><code class="md"><span class="hljs-code">```output
# the code block with output
@sayln 'hi world'
```</span>

<span class="hljs-code">```</span>coffee/output:playable
<span class="hljs-section"># the code block with output and specified language(NOT IMPL YET, All are coffeescript)</span>
@sayln 'hi world'
<span class="hljs-code">```
</span></code></pre>
<p>The CodeBlock with output has a <code>@output</code> variable(it’s the binding <code>div</code> element for this block),  a <code>@say()</code> and <code>@sayln()</code> method to print text.</p>
<h3 id="play-movie-for-codeblock" class="heading-control">Play Movie for CodeBlock<a class="heading-anchor" href="#play-movie-for-codeblock" aria-hidden="true"></a></h3>
<p><strong>WARNING：UNSTABLE IT WILL BE CHANGED</strong></p>
<p>The input of the code block can be played like a movie. You can enable it through three(<code>~~~</code>) or more than three tilde symbols <code>~</code> in a single line on the code block. Above the line is the common source code. The “|” above the code indicates the cursor position after the presentation is completed, and the lower part is the control input movie code.</p>
<pre><code class="md">
<span class="hljs-code">```</span>output:playable

<span class="hljs-section"># demo how to draw a rect.</span>
paper = @canvas

|
~~~
tooltip: set the canvas size:200X100 ::: Init
type:paper.setSize(200,100)\n
tooltip: clear canvas
type:paper.clear()\n
tooltip: init x/y coor, width/height parameters coming from document
type:@rx ||=10\n
type:@ry ||=18\n
type:@rw ||=100\n
type:@rh ||=50\n
tooltip: drawing rect nowing ::: Draw rect
type:rect = paper.rect(@rx, @ry, @rw, @rh)\n
tooltip: fill red for the rect
type:rect.attr('fill', 'red')
moveTo: 8:13
tooltip: you can try it by youself now
<span class="hljs-code">```
</span></code></pre>
<ul>
<li><code>tooltip</code> : show a tooltip
<ul>
<li><code>:::</code> Classified information after separation</li>
</ul>
</li>
<li><code>type</code>: simulate keyboard input</li>
<li><code>moveTo</code>: move the cursor to x:y</li>
</ul>
<h3 id="codeblock-examples" class="heading-control">CodeBlock Examples<a class="heading-anchor" href="#codeblock-examples" aria-hidden="true"></a></h3>
<h4 id="examples-interactive-code-block-without-output" class="heading-control">Examples: interactive code block without output<a class="heading-anchor" href="#examples-interactive-code-block-without-output" aria-hidden="true"></a></h4>
<pre><code># this is an interactive code block without output
a = 12 + 3
</code></pre>
<h4 id="examples-interactive-code-block-with-output" class="heading-control">Examples: interactive code block with output<a class="heading-anchor" href="#examples-interactive-code-block-with-output" aria-hidden="true"></a></h4>
<pre><code># this is an interactive code block with output
@sayln 'hi world'
</code></pre>
<h4 id="examples-play-movie-for-codeblock" class="heading-control">Examples: Play Movie for CodeBlock<a class="heading-anchor" href="#examples-play-movie-for-codeblock" aria-hidden="true"></a></h4>
<pre><code class="output:playable">
# demo how to draw a rect.
paper = @canvas

|
~~~
tooltip: set the canvas size:200X100 ::: Init
type:paper.setSize(200,100)\n
tooltip: clear canvas
type:paper.clear()\n
tooltip: init x/y coor, width/height parameters coming from document
type:@rx ||=10\n
type:@ry ||=18\n
type:@rw ||=100\n
type:@rh ||=50\n
tooltip: drawing rect nowing ::: Draw rect
type:rect = paper.rect(@rx, @ry, @rw, @rh)\n
tooltip: fill red for the rect
type:rect.attr('fill', 'red')
moveTo: 8:13
tooltip: you can try it by youself now
</code></pre>
]]></content>
  </entry>
</search>
